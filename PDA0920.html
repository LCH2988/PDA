<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>個人資料管理系統</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
      body {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      
      .container {
          padding: 20px;
          max-width: 800px;
      }
      
      .card {
          border: none;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.1);
          margin-bottom: 20px;
          backdrop-filter: blur(10px);
          background: rgba(255, 255, 255, 0.95);
      }
      
      .card-header {
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
          color: white;
          border-radius: 15px 15px 0 0 !important;
          padding: 20px;
          border: none;
      }
      
      .user-avatar {
          width: 80px;
          height: 80px;
          border-radius: 50%;
          border: 4px solid white;
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
          background: #f8f9fa;
      }
      
      .user-name {
          font-size: 1.5rem;
          font-weight: bold;
          margin: 0;
      }
      
      .user-id {
          opacity: 0.9;
          font-size: 0.9rem;
      }
      
      .info-item {
          padding: 12px 0;
          border-bottom: 1px solid #f0f0f0;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      
      .info-item:last-child {
          border-bottom: none;
      }
      
      .info-label {
          font-weight: 600;
          color: #555;
          min-width: 120px;
      }
      
      .info-value {
          color: #333;
          text-align: right;
          flex: 1;
      }
      
      .info-value.empty {
          color: #999;
          font-style: italic;
      }
      
      .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border: none;
          border-radius: 25px;
          padding: 10px 25px;
          font-weight: 600;
          transition: all 0.3s ease;
      }
      
      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }
      
      .btn-secondary {
          border-radius: 25px;
          padding: 10px 25px;
          font-weight: 600;
      }
      
      .form-control, .form-select {
          border-radius: 10px;
          border: 2px solid #e9ecef;
          padding: 12px 15px;
          transition: all 0.3s ease;
      }
      
      .form-control:focus, .form-select:focus {
          border-color: #667eea;
          box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }
      
      .form-label {
          font-weight: 600;
          color: #555;
          margin-bottom: 8px;
      }
      
      .activity-item {
          display: flex;
          align-items: center;
          padding: 15px 0;
          border-bottom: 1px solid #f0f0f0;
      }
      
      .activity-item:last-child {
          border-bottom: none;
      }
      
      .activity-icon {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-right: 15px;
          color: white;
      }
      
      .activity-icon.bg-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      
      .activity-icon.bg-success {
          background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
      }
      
      .activity-icon.bg-info {
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }
      
      .activity-content {
          flex: 1;
      }
      
      .activity-title {
          font-weight: 600;
          color: #333;
          margin-bottom: 4px;
      }
      
      .activity-time {
          font-size: 0.85rem;
          color: #666;
      }
      
      .loading-spinner {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid #667eea;
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }
      
      .alert {
          border-radius: 10px;
          border: none;
      }
      
      .alert-success {
          background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
          color: white;
      }
      
      .alert-danger {
          background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
          color: white;
      }
      
      .loading-screen {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          color: white;
      }
      
      .loading-content {
          text-align: center;
      }
      
      .loading-content .spinner-border {
          width: 3rem;
          height: 3rem;
          margin-bottom: 1rem;
      }
      
      .liff-status {
          background: rgba(255, 255, 255, 0.1);
          border-radius: 10px;
          padding: 10px;
          margin-bottom: 15px;
          font-size: 0.9rem;
      }
      
      .status-indicator {
          display: inline-block;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          margin-right: 8px;
      }
      
      .status-online {
          background-color: #28a745;
      }
      
      .status-offline {
          background-color: #dc3545;
      }
      
      @media (max-width: 768px) {
          .container {
              padding: 10px;
          }
          
          .info-item {
              flex-direction: column;
              align-items: flex-start;
          }
          
          .info-label {
              margin-bottom: 5px;
          }
          
          .info-value {
              text-align: left;
          }
      }
  </style>
</head>
<body>
  <!-- 載入畫面 -->
  <div id="loadingScreen" class="loading-screen">
      <div class="loading-content">
          <div class="spinner-border" role="status"></div>
          <h4>載入中...</h4>
          <p id="loadingStatus">正在初始化系統...</p>
          <div class="liff-status">
              <span id="liffStatusIndicator" class="status-indicator status-offline"></span>
              <span id="liffStatusText">LIFF 狀態：初始化中</span>
          </div>
      </div>
  </div>

  <div class="container">
      <!-- 個人資料卡片 -->
      <div id="profileCard" class="card" style="display: none;">
          <div class="card-header">
              <div class="d-flex align-items-center">
                  <img id="userAvatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNmOGY5ZmEiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjNmM3NTdkIj4KPHA+aD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPgo8L3N2Zz4KPC9zdmc+" alt="用戶頭像" class="user-avatar me-3">
                  <div>
                      <h2 id="userName" class="user-name">載入中...</h2>
                      <p id="userIdDisplay" class="user-id">ID: 載入中...</p>
                  </div>
              </div>
          </div>
          <div class="card-body">
              <!-- 顯示模式 -->
              <div id="displayMode">
                  <div id="userInfoDisplay">
                      <!-- 用戶資料將在這裡動態載入 -->
                  </div>
                  <div class="text-center mt-4">
                      <button type="button" class="btn btn-primary" onclick="showEditForm()">
                          <i class="bi bi-pencil-square me-2"></i>編輯資料
                      </button>
                  </div>
              </div>

              <!-- 編輯模式 -->
              <div id="editMode" style="display: none;">
                  <form id="profileForm">
                      <div class="row">
                          <div class="col-md-6 mb-3">
                              <label for="realName" class="form-label">真實姓名</label>
                              <input type="text" class="form-control" id="realName" placeholder="請輸入真實姓名">
                          </div>
                          <div class="col-md-6 mb-3">
                              <label for="phone" class="form-label">電話</label>
                              <input type="tel" class="form-control" id="phone" placeholder="請輸入電話號碼">
                          </div>
                      </div>
                      
                      <div class="row">
                          <div class="col-md-6 mb-3">
                              <label for="email" class="form-label">電子郵件</label>
                              <input type="email" class="form-control" id="email" placeholder="請輸入電子郵件">
                          </div>
                          <div class="col-md-6 mb-3">
                              <label for="birthday" class="form-label">生日</label>
                              <input type="date" class="form-control" id="birthday">
                          </div>
                      </div>
                      
                      <div class="mb-3">
                          <label for="address" class="form-label">地址</label>
                          <input type="text" class="form-control" id="address" placeholder="請輸入地址">
                      </div>
                      
                      <div class="row">
                          <div class="col-md-6 mb-3">
                              <label for="idNumber" class="form-label">身分證字號</label>
                              <input type="text" class="form-control" id="idNumber" placeholder="請輸入身分證字號">
                          </div>
                          <div class="col-md-6 mb-3">
                              <label for="isPatient" class="form-label">是否為患者</label>
                              <select class="form-select" id="isPatient">
                                  <option value="">請選擇</option>
                                  <option value="是">是</option>
                                  <option value="否">否</option>
                              </select>
                          </div>
                      </div>
                      
                      <div class="row">
                          <div class="col-md-6 mb-3">
                              <label for="relationship" class="form-label">與患者關係</label>
                              <select class="form-select" id="relationship">
                                  <option value="">請選擇</option>
                                  <option value="本人">本人</option>
                                  <option value="配偶">配偶</option>
                                  <option value="子女">子女</option>
                                  <option value="父母">父母</option>
                                  <option value="兄弟姊妹">兄弟姊妹</option>
                                  <option value="其他親屬">其他親屬</option>
                                  <option value="朋友">朋友</option>
                                  <option value="其他">其他</option>
                              </select>
                          </div>
                          <div class="col-md-6 mb-3">
                              <label for="diagnosisDate" class="form-label">確診時間</label>
                              <input type="date" class="form-control" id="diagnosisDate">
                          </div>
                      </div>
                      
                      <div class="row">
                          <div class="col-md-6 mb-3">
                              <label for="emergencyContact" class="form-label">緊急聯絡人</label>
                              <input type="text" class="form-control" id="emergencyContact" placeholder="請輸入緊急聯絡人姓名">
                          </div>
                          <div class="col-md-6 mb-3">
                              <label for="emergencyPhone" class="form-label">緊急聯絡電話</label>
                              <input type="tel" class="form-control" id="emergencyPhone" placeholder="請輸入緊急聯絡電話">
                          </div>
                      </div>
                      
                      <div class="text-center mt-4">
                          <button type="submit" class="btn btn-primary me-2">
                              <i class="bi bi-check-lg me-2"></i>儲存
                          </button>
                          <button type="button" class="btn btn-secondary" onclick="hideEditForm()">
                              <i class="bi bi-x-lg me-2"></i>取消
                          </button>
                      </div>
                  </form>
              </div>
          </div>
      </div>

      <!-- 最近活動卡片 -->
      <div id="activityCard" class="card" style="display: none;">
          <div class="card-header">
              <h5 class="mb-0">
                  <i class="bi bi-clock-history me-2"></i>最近活動
              </h5>
          </div>
          <div class="card-body">
              <div id="recentActivity">
                  <div class="text-center p-4">
                      <div class="loading-spinner"></div>
                      <div class="mt-2">載入中...</div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- 成功訊息 Modal -->
  <div class="modal fade" id="successModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-body text-center p-4">
                  <div class="text-success mb-3">
                      <i class="bi bi-check-circle-fill" style="font-size: 3rem;"></i>
                  </div>
                  <h5>資料更新成功！</h5>
                  <p class="text-muted">您的個人資料已成功儲存。</p>
              </div>
              <div class="modal-footer justify-content-center">
                  <button type="button" class="btn btn-primary" data-bs-dismiss="modal">確定</button>
              </div>
          </div>
      </div>
  </div>

  <!-- 錯誤訊息 Modal -->
  <div class="modal fade" id="errorModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-body text-center p-4">
                  <div class="text-danger mb-3">
                      <i class="bi bi-exclamation-triangle-fill" style="font-size: 3rem;"></i>
                  </div>
                  <h5>發生錯誤</h5>
                  <p id="errorMessage" class="text-muted"></p>
              </div>
              <div class="modal-footer justify-content-center">
                  <button type="button" class="btn btn-primary" data-bs-dismiss="modal">確定</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
      // 設定變數
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbx1kuumHXl_HzzBuaAErRzy7l6zN6R3zrG-rZSlgGYU1S3YUZeKYeod-a3jC_B13k4i/exec';
      
      let userProfile = {};
      let userId = '';
      let userInfo = {};
      let isLiffAvailable = false;

      // 更新載入狀態
      function updateLoadingStatus(message) {
          const statusElement = document.getElementById('loadingStatus');
          if (statusElement) {
              statusElement.textContent = message;
          }
          console.log('載入狀態:', message);
      }

      // 更新 LIFF 狀態指示器
      function updateLiffStatus(isOnline, message) {
          const indicator = document.getElementById('liffStatusIndicator');
          const text = document.getElementById('liffStatusText');
          
          if (indicator && text) {
              indicator.className = `status-indicator ${isOnline ? 'status-online' : 'status-offline'}`;
              text.textContent = `LIFF 狀態：${message}`;
          }
      }

      // JSONP 請求函數
      function makeJSONPRequest(url, callback) {
          return new Promise((resolve, reject) => {
              const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
              
              const script = document.createElement('script');
              
              window[callbackName] = function(data) {
                  delete window[callbackName];
                  document.head.removeChild(script);
                  resolve(data);
              };
              
              script.onerror = function() {
                  delete window[callbackName];
                  document.head.removeChild(script);
                  reject(new Error('JSONP request failed'));
              };
              
              script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
              document.head.appendChild(script);
              
              setTimeout(() => {
                  if (window[callbackName]) {
                      delete window[callbackName];
                      if (document.head.contains(script)) {
                          document.head.removeChild(script);
                      }
                      reject(new Error('JSONP request timeout'));
                  }
              }, 15000);
          });
      }

      // 使用 JSONP 發送 POST 資料
      function makeJSONPPostRequest(url, data) {
          // 將 POST 資料轉換為 GET 參數
          const params = new URLSearchParams();
          Object.keys(data).forEach(key => {
              params.append(key, data[key]);
          });
          
          const fullUrl = url + '?' + params.toString();
          return makeJSONPRequest(fullUrl);
      }

      // 檢查 LIFF 可用性
      function checkLiffAvailability() {
          return new Promise((resolve) => {
              // 檢查是否在 LINE 環境中
              const isInLineApp = /Line/i.test(navigator.userAgent);
              
              // 檢查 LIFF SDK 是否載入
              const isLiffLoaded = typeof window.liff !== 'undefined';
              
              console.log('LINE 環境檢查:', isInLineApp);
              console.log('LIFF SDK 載入:', isLiffLoaded);
              
              resolve(isLiffLoaded);
          });
      }

      // 初始化 LIFF
      async function initializeLiff() {
          try {
              updateLoadingStatus('檢查 LIFF 環境...');
              updateLiffStatus(false, '檢查中');
              
              // 檢查 LIFF 可用性
              isLiffAvailable = await checkLiffAvailability();
              
              if (!isLiffAvailable) {
                  console.log('LIFF 不可用，使用測試模式');
                  updateLiffStatus(false, '不可用（測試模式）');
                  await initializeTestMode();
                  return;
              }
              
              updateLoadingStatus('初始化 LIFF...');
              console.log('開始初始化 LIFF...');
              
              // 使用您的實際 LIFF ID
              await liff.init({ liffId: '1656516134-VaGgmaPm' });
              
              if (!liff.isLoggedIn()) {
                  console.log('用戶未登入，導向登入頁面');
                  updateLiffStatus(false, '未登入');
                  liff.login();
                  return;
              }
              
              console.log('LIFF 初始化成功');
              updateLiffStatus(true, '已連線');
              
              userProfile = await liff.getProfile();
              userId = userProfile.userId;
              
              console.log('用戶資料:', userProfile);
              console.log('用戶ID:', userId);
              
              await loadUserData();
              
          } catch (error) {
              console.error('LIFF 初始化失敗:', error);
              updateLiffStatus(false, '初始化失敗');
              
              // 降級到測試模式
              await initializeTestMode();
          }
      }

      // 初始化測試模式
      async function initializeTestMode() {
          updateLoadingStatus('使用測試模式...');
          console.log('使用測試資料');
          
          userProfile = {
              userId: 'test-user-' + Date.now(),
              displayName: '測試用戶',
              pictureUrl: null
          };
          userId = userProfile.userId;
          
          await loadUserData();
      }

      // 載入用戶資料
      async function loadUserData() {
          try {
              updateLoadingStatus('載入用戶資料...');
              
              // 設定用戶頭像
              const avatarElement = document.getElementById('userAvatar');
              if (userProfile.pictureUrl) {
                  avatarElement.src = userProfile.pictureUrl;
                  avatarElement.onerror = function() {
                      this.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNmOGY5ZmEiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjNmM3NTdkIj4KPHA+aD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPgo8L3N2Zz4KPC9zdmc+";
                  };
              }
              
              document.getElementById('userName').textContent = userProfile.displayName;
              document.getElementById('userIdDisplay').textContent = 'ID: ' + userId;

              console.log('開始載入用戶資料...');
              
              const url = `${GAS_URL}?action=getUserInfo&userId=${encodeURIComponent(userId)}&_t=${Date.now()}`;
              console.log('請求 URL:', url);
              
              const data = await makeJSONPRequest(url);
              console.log('收到資料:', data);
              
              if (data.success && data.data && data.data.userInfo) {
                  userInfo = data.data.userInfo;
              } else {
                  userInfo = data.data?.userInfo || createDefaultUserInfo();
              }
              
              displayUserInfo();
              loadRecentActivity();
              
              updateLoadingStatus('載入完成');
              
              setTimeout(() => {
                  document.getElementById('loadingScreen').style.display = 'none';
                  document.getElementById('profileCard').style.display = 'block';
                  document.getElementById('activityCard').style.display = 'block';
              }, 1000);
              
          } catch (error) {
              console.error('載入用戶資料失敗:', error);
              updateLoadingStatus('載入失敗');
              
              showError('載入資料失敗：' + error.message + '。請檢查網路連線或重新整理頁面。');
              
              userInfo = createDefaultUserInfo();
              displayUserInfo();
              
              setTimeout(() => {
                  document.getElementById('loadingScreen').style.display = 'none';
                  document.getElementById('profileCard').style.display = 'block';
              }, 2000);
          }
      }

      // 建立預設用戶資料
      function createDefaultUserInfo() {
          return {
              'LINE顯示名稱': userProfile.displayName,
              '用戶ID': userId,
              '真實姓名': '',
              '電話': '',
              '電子郵件': '',
              '地址': '',
              '生日': '',
              '身分證字號': '',
              '是否患者': '',
              '與患者關係': '',
              '確診時間': '',
              '緊急聯絡人': '',
              '緊急聯絡電話': '',
              '加入日期': new Date().toISOString().split('T')[0],
              '最後更新時間': '',
              '會員等級': '一般用戶',
              '累計捐款次數': 0,
              '累計捐款金額': 0,
              '最後捐款日期': ''
          };
      }

      // 顯示用戶資料
      function displayUserInfo() {
          const displayElement = document.getElementById('userInfoDisplay');
            const displayFields = [
                { key: 'LINE顯示名稱', label: 'LINE 顯示名稱', icon: 'bi-person-badge' },
                { key: '真實姓名', label: '真實姓名', icon: 'bi-person' },
                { key: '電話', label: '電話', icon: 'bi-telephone' },
                { key: '電子郵件', label: '電子郵件', icon: 'bi-envelope' },
                { key: '地址', label: '地址', icon: 'bi-geo-alt' },
                { key: '生日', label: '生日', icon: 'bi-calendar' },
                { key: '身分證字號', label: '身分證字號', icon: 'bi-card-text' },
                { key: '是否患者', label: '是否患者', icon: 'bi-heart-pulse' },
                { key: '與患者關係', label: '與患者關係', icon: 'bi-people' },
                { key: '確診時間', label: '確診時間', icon: 'bi-calendar-event' },
                { key: '緊急聯絡人', label: '緊急聯絡人', icon: 'bi-person-exclamation' },
                { key: '緊急聯絡電話', label: '緊急聯絡電話', icon: 'bi-telephone-plus' },
                { key: '會員等級', label: '會員等級', icon: 'bi-star' },
                { key: '加入日期', label: '加入日期', icon: 'bi-calendar-plus' },
                { key: '最後更新時間', label: '最後更新時間', icon: 'bi-clock' }
            ];

            let html = '';
            displayFields.forEach(field => {
                const value = userInfo[field.key] || '';
                const displayValue = value || '未填寫';
                const valueClass = value ? '' : 'empty';
                
                html += `
                    <div class="info-item">
                        <div class="info-label">
                            <i class="${field.icon} me-2"></i>${field.label}
                        </div>
                        <div class="info-value ${valueClass}">${displayValue}</div>
                    </div>
                `;
            });

            displayElement.innerHTML = html;
        }

        // 顯示編輯表單
        function showEditForm() {
            // 填入現有資料到表單
            document.getElementById('realName').value = userInfo['真實姓名'] || '';
            document.getElementById('phone').value = userInfo['電話'] || '';
            document.getElementById('email').value = userInfo['電子郵件'] || '';
            document.getElementById('address').value = userInfo['地址'] || '';
            document.getElementById('birthday').value = userInfo['生日'] || '';
            document.getElementById('idNumber').value = userInfo['身分證字號'] || '';
            document.getElementById('isPatient').value = userInfo['是否患者'] || '';
            document.getElementById('relationship').value = userInfo['與患者關係'] || '';
            document.getElementById('diagnosisDate').value = userInfo['確診時間'] || '';
            document.getElementById('emergencyContact').value = userInfo['緊急聯絡人'] || '';
            document.getElementById('emergencyPhone').value = userInfo['緊急聯絡電話'] || '';

            // 載入草稿
            loadDraft();

            // 切換顯示模式
            document.getElementById('displayMode').style.display = 'none';
            document.getElementById('editMode').style.display = 'block';
        }

        // 隱藏編輯表單
        function hideEditForm() {
            document.getElementById('editMode').style.display = 'none';
            document.getElementById('displayMode').style.display = 'block';
        }

        // 處理表單提交 - 使用 JSONP 方式
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 防止重複提交
            if (isSubmitting) {
                return;
            }
            isSubmitting = true;

            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<div class="loading-spinner me-2"></div>儲存中...';
            submitButton.disabled = true;

            try {
                // 收集表單資料
                const formData = {
                    action: 'updateUserProfile',
                    userId: userId,
                    'LINE顯示名稱': userProfile.displayName,
                    '真實姓名': document.getElementById('realName').value,
                    '電話': document.getElementById('phone').value,
                    '電子郵件': document.getElementById('email').value,
                    '地址': document.getElementById('address').value,
                    '生日': document.getElementById('birthday').value,
                    '身分證字號': document.getElementById('idNumber').value,
                    '是否患者': document.getElementById('isPatient').value,
                    '與患者關係': document.getElementById('relationship').value,
                    '確診時間': document.getElementById('diagnosisDate').value,
                    '緊急聯絡人': document.getElementById('emergencyContact').value,
                    '緊急聯絡電話': document.getElementById('emergencyPhone').value,
                    '會員等級': userInfo['會員等級'] || '一般用戶',
                    '加入日期': userInfo['加入日期'] || new Date().toISOString().split('T')[0]
                };

                // 表單驗證
                const validationErrors = validateForm();
                if (validationErrors.length > 0) {
                    throw new Error(validationErrors.join('\n'));
                }

                // 清理資料
                const sanitizedData = sanitizeData(formData);

                console.log('提交資料:', sanitizedData);

                // 使用 JSONP 發送資料
                const result = await makeJSONPPostRequest(GAS_URL, sanitizedData);
                console.log('更新結果:', result);

                if (result.success) {
                    // 更新本地資料
                    Object.assign(userInfo, sanitizedData);
                    
                    // 重新顯示資料
                    displayUserInfo();
                    hideEditForm();
                    
                    // 清除草稿
                    clearDraft();
                    
                    // 顯示成功訊息
                    showSuccess();
                    
                    // 重新載入活動記錄
                    loadRecentActivity();
                    
                } else {
                    throw new Error(result.message || '更新失敗');
                }

            } catch (error) {
                console.error('更新資料失敗:', error);
                showError('更新失敗：' + error.message);
            } finally {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
                isSubmitting = false;
            }
        });

        // 載入最近活動
        async function loadRecentActivity() {
            try {
                console.log('載入活動記錄...');
                
                const url = `${GAS_URL}?action=getUserActivity&userId=${encodeURIComponent(userId)}&_t=${Date.now()}`;
                const result = await makeJSONPRequest(url);
                
                if (result.success && result.data) {
                    displayRecentActivity(result.data);
                } else {
                    throw new Error(result.message || '載入活動記錄失敗');
                }
                
            } catch (error) {
                console.error('載入活動記錄失敗:', error);
                document.getElementById('recentActivity').innerHTML = `
                    <div class="text-center p-4 text-muted">
                        <i class="bi bi-wifi-off" style="font-size: 2rem;"></i>
                        <div class="mt-2">載入失敗</div>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // 顯示最近活動
        function displayRecentActivity(activities) {
            const activityElement = document.getElementById('recentActivity');
            
            if (!activities || activities.length === 0) {
                activityElement.innerHTML = `
                    <div class="text-center p-4 text-muted">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <div class="mt-2">暫無活動記錄</div>
                    </div>
                `;
                return;
            }

            activityElement.innerHTML = activities.map(activity => {
                const iconClass = getActivityIcon(activity.類型);
                const iconBg = getActivityIconBg(activity.類型);
                
                return `
                    <div class="activity-item">
                        <div class="activity-icon ${iconBg}">
                            <i class="bi ${iconClass}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.標題}</div>
                            <div class="activity-time">${formatDateTime(activity.時間)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 取得活動圖示
        function getActivityIcon(type) {
            const iconMap = {
                '資料更新': 'bi-pencil-square',
                '登入': 'bi-box-arrow-in-right',
                '捐款': 'bi-heart-fill',
                '查詢': 'bi-search',
                '預約': 'bi-calendar-check',
                '其他': 'bi-gear'
            };
            return iconMap[type] || 'bi-circle';
        }

        // 取得活動圖示背景色
        function getActivityIconBg(type) {
            const bgMap = {
                '資料更新': 'bg-primary',
                '登入': 'bg-success',
                '捐款': 'bg-danger',
                '查詢': 'bg-info',
                '預約': 'bg-warning',
                '其他': 'bg-secondary'
            };
            return bgMap[type] || 'bg-secondary';
        }

        // 格式化日期時間
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '';
            
            try {
                const date = new Date(dateTimeString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) {
                    return '剛剛';
                } else if (diffMins < 60) {
                    return `${diffMins} 分鐘前`;
                } else if (diffHours < 24) {
                    return `${diffHours} 小時前`;
                } else if (diffDays < 7) {
                    return `${diffDays} 天前`;
                } else {
                    return date.toLocaleDateString('zh-TW', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
            } catch (error) {
                return dateTimeString;
            }
        }

        // 顯示成功訊息
        function showSuccess() {
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
        }

        // 顯示錯誤訊息
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('errorModal'));
            modal.show();
        }

        // 連線測試函數
        async function testConnection() {
            try {
                const url = `${GAS_URL}?action=test&_t=${Date.now()}`;
                const result = await makeJSONPRequest(url);
                console.log('連線測試結果:', result);
                return result.success;
            } catch (error) {
                console.error('連線測試失敗:', error);
                return false;
            }
        }

        // 防止表單重複提交
        let isSubmitting = false;

        // 自動儲存草稿功能
        const formFields = ['realName', 'phone', 'email', 'address', 'birthday', 'idNumber', 'isPatient', 'relationship', 'diagnosisDate', 'emergencyContact', 'emergencyPhone'];
        
        formFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', function() {
                    // 延遲儲存，避免頻繁操作
                    clearTimeout(this.saveTimeout);
                    this.saveTimeout = setTimeout(() => {
                        saveDraft();
                    }, 1000);
                });
            }
        });

        // 儲存草稿到 localStorage
        function saveDraft() {
            try {
                const draft = {};
                formFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        draft[fieldId] = field.value;
                    }
                });
                localStorage.setItem(`userDraft_${userId}`, JSON.stringify(draft));
                console.log('草稿已儲存');
            } catch (error) {
                console.error('儲存草稿失敗:', error);
            }
        }

        // 載入草稿
        function loadDraft() {
            try {
                const draftData = localStorage.getItem(`userDraft_${userId}`);
                if (draftData) {
                    const draft = JSON.parse(draftData);
                    formFields.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field && draft[fieldId] && !field.value) {
                            field.value = draft[fieldId];
                        }
                    });
                    console.log('草稿已載入');
                }
            } catch (error) {
                console.error('載入草稿失敗:', error);
            }
        }

        // 清除草稿
        function clearDraft() {
            try {
                localStorage.removeItem(`userDraft_${userId}`);
                console.log('草稿已清除');
            } catch (error) {
                console.error('清除草稿失敗:', error);
            }
        }

        // 表單驗證
        function validateForm() {
            const errors = [];
            
            // 驗證電話格式
            const phone = document.getElementById('phone').value;
            if (phone && !/^[\d\-\+\(\)\s]+$/.test(phone)) {
                errors.push('電話格式不正確');
            }
            
            // 驗證電子郵件格式
            const email = document.getElementById('email').value;
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                errors.push('電子郵件格式不正確');
            }
            
            // 驗證身分證字號格式（台灣）
            const idNumber = document.getElementById('idNumber').value;
            if (idNumber && !/^[A-Z][12]\d{8}$/.test(idNumber)) {
                errors.push('身分證字號格式不正確');
            }
            
            return errors;
        }

        // 清理和格式化資料
        function sanitizeData(data) {
            const sanitized = {};
            
            Object.keys(data).forEach(key => {
                let value = data[key];
                
                // 移除前後空白
                if (typeof value === 'string') {
                    value = value.trim();
                }
                
                // 特殊處理
                switch (key) {
                    case '電話':
                    case '緊急聯絡電話':
                        // 標準化電話號碼格式
                        value = value.replace(/\s+/g, '');
                        break;
                    case '電子郵件':
                        // 轉為小寫
                        value = value.toLowerCase();
                        break;
                    case '身分證字號':
                        // 轉為大寫
                        value = value.toUpperCase();
                        break;
                }
                
                sanitized[key] = value;
            });
            
            return sanitized;
        }

        // 添加鍵盤快捷鍵支援
        document.addEventListener('keydown', function(e) {
            // Ctrl+S 或 Cmd+S 快速儲存
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const editMode = document.getElementById('editMode');
                if (editMode.style.display !== 'none') {
                    document.getElementById('profileForm').dispatchEvent(new Event('submit'));
                }
            }
            
            // Esc 取消編輯
            if (e.key === 'Escape') {
                const editMode = document.getElementById('editMode');
                if (editMode.style.display !== 'none') {
                    hideEditForm();
                }
            }
        });

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM 載入完成，開始初始化...');
            
            // 載入 LIFF SDK
            const script = document.createElement('script');
            script.src = 'https://static.line-scdn.net/liff/edge/2/sdk.js';
            script.onload = () => {
                setTimeout(initializeLiff, 500);
            };
            script.onerror = () => {
                console.log('LIFF SDK 載入失敗，使用測試模式');
                setTimeout(initializeTestMode, 500);
            };
            document.head.appendChild(script);
        });

        // 在頁面載入時測試連線
        window.addEventListener('load', async () => {
            console.log('測試與後端的連線...');
            const isConnected = await testConnection();
            if (isConnected) {
                console.log('✅ 後端連線正常');
            } else {
                console.log('❌ 後端連線失敗');
                showError('無法連接到後端服務，部分功能可能無法正常使用。');
            }
        });

        // 處理頁面可見性變化
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && userId) {
                console.log('頁面重新可見，重新載入活動記錄');
                loadRecentActivity();
            }
        });

        // 處理網路狀態變化
        window.addEventListener('online', function() {
            console.log('網路已連線');
            if (userId) {
                loadRecentActivity();
            }
        });

        window.addEventListener('offline', function() {
            console.log('網路已斷線');
            showError('網路連線已中斷，某些功能可能無法正常使用。');
        });

        // 工具提示初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化所有工具提示
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // 錯誤處理和日誌記錄
        window.addEventListener('error', function(e) {
            console.error('JavaScript 錯誤:', e.error);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('未處理的 Promise 拒絕:', e.reason);
        });

        console.log('前端程式載入完成');
    </script>
</body>
</html>
