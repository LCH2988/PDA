<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>管理員專區</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
body {
    font-family: 'Noto Sans TC', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}
.admin-nav {
    background: white;
    border-radius: 15px;
    margin: 20px;
    padding: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.nav-pills .nav-link {
    border-radius: 10px;
    margin: 0 5px;
    font-weight: 600;
}
.nav-pills .nav-link.active {
    background: linear-gradient(135deg, #2c5aa0, #4a90e2);
}
.content-card {
    background: white;
    border-radius: 20px;
    margin: 20px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}
.stat-card {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
}
.stat-card h3 {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 10px;
}
.table-container {
    max-height: 400px;
    overflow-y: auto;
    border-radius: 10px;
    border: 1px solid #dee2e6;
}
.form-floating {
    margin-bottom: 15px;
}
.form-floating .form-control, .form-floating .form-select {
    border-radius: 10px;
}
.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
}
.alert {
    border-radius: 15px;
    margin-bottom: 20px;
}
.proposal-card, .expense-card, .motion-card {
    border: 1px solid #dee2e6;
    border-radius: 15px;
    margin-bottom: 20px;
    overflow: hidden;
    transition: all 0.3s ease;
}
.proposal-card:hover, .expense-card:hover, .motion-card:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}
.proposal-card .card-header {
    background: linear-gradient(135deg, #6c757d, #495057);
    color: white;
    font-weight: 600;
}
.expense-card .card-header {
    background: linear-gradient(135deg, #fd7e14, #e8590c);
    color: white;
    font-weight: 600;
}
.motion-card .card-header {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
    font-weight: 600;
}
.vote-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}
.vote-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
}
.expense-receipt {
    border: 1px solid #dee2e6;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    background: #fff;
}
.receipt-image {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin-top: 10px;
    cursor: pointer;
}
.approval-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-top: 15px;
}
.review-dashboard {
    background: linear-gradient(135deg, #6f42c1, #5a32a3);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
}
.review-stats {
    display: flex;
    justify-content: space-around;
    text-align: center;
}
.review-stat-item h4 {
    font-size: 2rem;
    margin-bottom: 5px;
}
.urgency-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
}
.deadline-warning {
    background: linear-gradient(45deg, #ff6b6b, #ffa500);
    color: white;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    margin-bottom: 10px;
    display: inline-block;
}
.voted-indicator {
    background: #28a745;
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8rem;
    margin-left: 10px;
}
.comment-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}
.filter-tabs {
    margin-bottom: 20px;
}
.filter-tabs .nav-link {
    border-radius: 20px;
    margin: 0 5px;
    font-size: 0.9rem;
}
</style>
</head>
<body>
<!-- 錯誤/成功訊息 -->
<div id="errorAlert" class="alert alert-danger mx-3" style="display: none;">
<i class="bi bi-exclamation-triangle me-2"></i>
<span id="errorMessage"></span>
</div>

<div id="successAlert" class="alert alert-success mx-3" style="display: none;">
<i class="bi bi-check-circle me-2"></i>
<span id="successMessage"></span>
</div>

<!-- 導航選單 -->
<div class="admin-nav">
<ul class="nav nav-pills justify-content-center" id="adminTabs">
    <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="pill" href="#dashboard">
            <i class="bi bi-speedometer2 me-1"></i>儀表板
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#review">
            <i class="bi bi-clipboard-check me-1"></i>審查總覽
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#proposals">
            <i class="bi bi-file-text me-1"></i>提案審查
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#expenses">
            <i class="bi bi-receipt me-1"></i>支出審核
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#motions">
            <i class="bi bi-lightning me-1"></i>臨時動議
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#finance">
            <i class="bi bi-cash-coin me-1"></i>財務管理
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#members">
            <i class="bi bi-people me-1"></i>會員管理
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#activities">
            <i class="bi bi-calendar-event me-1"></i>活動管理
        </a>
    </li>
</ul>
</div>

<!-- 內容區域 -->
<div class="tab-content">
<!-- 儀表板 -->
<div class="tab-pane fade show active" id="dashboard">
    <div class="content-card">
        <h4 class="mb-4"><i class="bi bi-speedometer2 me-2"></i>系統概覽</h4>
        <div class="row" id="dashboardStats">
            <div class="col-12 text-center">
                <div class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 審查總覽 -->
<div class="tab-pane fade" id="review">
    <div class="content-card">
        <h4 class="mb-4"><i class="bi bi-clipboard-check me-2"></i>審查總覽</h4>
        
        <!-- 審查儀表板 -->
        <div class="review-dashboard">
            <h5 class="mb-3"><i class="bi bi-person-badge me-2"></i>我的審查權限</h5>
            <div class="review-stats" id="reviewStats">
                <div class="text-center">
                    <div class="spinner-border text-light" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 待審查項目快速檢視 -->
        <div class="row">
            <div class="col-md-4">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-file-text me-1"></i>待審提案</h6>
                    </div>
                    <div class="card-body" id="pendingProposalsPreview">
                        <div class="text-center">載入中...</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="bi bi-receipt me-1"></i>待審憑證</h6>
                    </div>
                    <div class="card-body" id="pendingExpensesPreview">
                        <div class="text-center">載入中...</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0"><i class="bi bi-lightning me-1"></i>待審動議</h6>
                    </div>
                    <div class="card-body" id="pendingMotionsPreview">
                        <div class="text-center">載入中...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 提案審查 -->
<div class="tab-pane fade" id="proposals">
    <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4><i class="bi bi-file-text me-2"></i>提案審查</h4>
            <div>
                <button class="btn btn-success btn-sm me-2" onclick="showProposalForm()">
                    <i class="bi bi-plus-circle me-1"></i>新增提案
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshProposals()">
                    <i class="bi bi-arrow-clockwise me-1"></i>重新整理
                </button>
            </div>
        </div>

        <!-- 篩選標籤 -->
        <div class="filter-tabs">
            <ul class="nav nav-pills" id="proposalFilterTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-filter="all" href="#" onclick="filterProposals('all')">全部</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-filter="pending" href="#" onclick="filterProposals('pending')">待審查</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-filter="reviewing" href="#" onclick="filterProposals('reviewing')">審查中</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-filter="approved" href="#" onclick="filterProposals('approved')">已通過</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-filter="rejected" href="#" onclick="filterProposals('rejected')">已駁回</a>
                </li>
            </ul>
        </div>

        <!-- 提案表單 -->
        <div id="proposalForm" style="display: none;">
            <div class="card border-success mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">新增提案</h6>
                </div>
                <div class="card-body">
                    <form id="newProposalForm">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="proposalTitle" required>
                                    <label>提案標題</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select class="form-select" id="proposalType" required>
                                        <option value="">請選擇</option>
                                        <option value="預算提案">預算提案</option>
                                        <option value="活動提案">活動提案</option>
                                        <option value="制度提案">制度提案</option>
                                        <option value="人事提案">人事提案</option>
                                        <option value="其他提案">其他提案</option>
                                    </select>
                                    <label>提案類型</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="proposalContent" style="height: 120px;" required></textarea>
                                    <label>提案內容</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="proposalBudget" min="0">
                                    <label>預算金額（如適用）</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="proposalDeadline">
                                    <label>執行期限（如適用）</label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-success me-2">
                                <i class="bi bi-check-circle me-1"></i>提交提案
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="hideProposalForm()">
                                <i class="bi bi-x-circle me-1"></i>取消
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 提案列表 -->
        <div id="proposalList">
            <div class="text-center">載入中...</div>
        </div>
    </div>
</div>

<!-- 支出審核 -->
<div class="tab-pane fade" id="expenses">
    <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4><i class="bi bi-receipt me-2"></i>支出憑證審核</h4>
            <div>
                <button class="btn btn-success btn-sm me-2" onclick="showExpenseForm()">
                    <i class="bi bi-plus-circle me-1"></i>提交憑證
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshExpenses()">
                    <i class="bi bi-arrow-clockwise me-1"></i>重新整理
                </button>
            </div>
        </div>

        <!-- 篩選標籤 -->
        <div class="filter-tabs">
            <ul class="nav nav-pills" id="expenseFilterTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-filter="all" href="#" onclick="filterExpenses('all')">全部</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-filter="pending" href="#" onclick="filterExpenses('pending')">待審核</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-filter="approved" href="#" onclick="filterExpenses('approved')">已核准</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-filter="rejected" href="#" onclick="filterExpenses('rejected')">已駁回</a>
                </li>
            </ul>
        </div>

        <!-- 支出憑證表單 -->
        <div id="expenseForm" style="display: none;">
            <div class="card border-warning mb-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">提交支出憑證</h6>
                </div>
                <div class="card-body">
                    <form id="newExpenseForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="expenseDate" required>
                                    <label>支出日期</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="expenseAmount" required min="1">
                                    <label>支出金額</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="expenseCategory" required>
                                        <option value="">請選擇</option>
                                        <option value="活動費用">活動費用</option>
                                        <option value="辦公費用">辦公費用</option>
                                        <option value="交通費">交通費</option>
                                        <option value="餐費">餐費</option>
                                        <option value="場地費">場地費</option>
                                        <option value="其他支出">其他支出</option>
                                    </select>
                                    <label>支出類別</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="expenseVendor" required>
                                    <label>廠商/店家</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="expenseDescription" style="height: 80px;" required></textarea>
                                    <label>支出說明</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">上傳憑證圖片</label>
                                <input type="file" class="form-control" id="expenseReceipt" accept="image/*" required>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-warning me-2">
                                <i class="bi bi-check-circle me-1"></i>提交審核
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="hideExpenseForm()">
                                <i class="bi bi-x-circle me-1"></i>取消
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 支出憑證列表 -->
        <div id="expenseList">
            <div class="text-center">載入中...</div>
        </div>
    </div>
</div>

<!-- 臨時動議 -->
<div class="tab-pane fade" id="motions">
    <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4><i class="bi bi-lightning me-2"></i>臨時動議</h4>
            <div>
                <button class="btn btn-danger btn-sm me-2" onclick="showMotionForm()">
                    <i class="bi bi-plus-circle me-1"></i>提出動議
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshMotions()">
                    <i class="bi bi-arrow-clockwise me-1"></i>重新整理
                </button>
            </div>
        </div>

        <!-- 篩選標籤 -->
        <div class="filter-tabs">
            <ul class="nav nav-pills" id="motionFilterTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-filter="all" href="#" onclick="filterMotions('all')">全部</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-filter="urgent" href="#" onclick="filterMotions('urgent')">緊急</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-filter="pending" href="#" onclick="filterMotions('pending')">待審查</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-filter="approved" href="#" onclick="filterMotions('approved')">已通過</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-filter="rejected" href="#" onclick="filterMotions('rejected')">已駁回</a>
                </li>
            </ul>
        </div>

        <!-- 臨時動議表單 -->
        <div id="motionForm" style="display: none;">
            <div class="card border-danger mb-4">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">提出臨時動議</h6>
                </div>
                <div class="card-body">
                    <form id="newMotionForm">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="motionTitle" required>
                                    <label>動議標題</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="motionUrgency" required>
                                        <option value="">請選擇</option>
                                        <option value="緊急">緊急</option>
                                        <option value="重要">重要</option>
                                        <option value="一般">一般</option>
                                    </select>
                                    <label>緊急程度</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="motionDeadline">
                                    <label>希望決議期限</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="motionContent" style="height: 120px;" required></textarea>
                                    <label>動議內容</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="motionReason" style="height: 80px;" required></textarea>
                                    <label>提出理由</label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-danger me-2">
                                <i class="bi bi-check-circle me-1"></i>提出動議
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="hideMotionForm()">
                                <i class="bi bi-x-circle me-1"></i>取消
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 臨時動議列表 -->
        <div id="motionList">
            <div class="text-center">載入中...</div>
        </div>
    </div>
</div>

<!-- 財務管理 -->
<div class="tab-pane fade" id="finance">
    <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4><i class="bi bi-cash-coin me-2"></i>財務管理</h4>
            <button class="btn btn-success btn-sm" onclick="showTransactionForm()">
                <i class="bi bi-plus-circle me-1"></i>新增交易
            </button>
        </div>
        
        <!-- 交易表單 -->
        <div id="transactionForm" style="display: none;">
            <div class="card border-primary mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">新增交易</h6>
                </div>
                <div class="card-body">
                    <form id="newTransactionForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="transactionDate" required>
                                    <label>日期</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="transactionType" required>
                                        <option value="">請選擇</option>
                                        <option value="收入">收入</option>
                                        <option value="支出">支出</option>
                                    </select>
                                    <label>類型</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="transactionCategory" required>
                                        <option value="">請選擇類別</option>
                                    </select>
                                    <label>類別</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="transactionAmount" required min="1">
                                    <label>金額</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="transactionTarget">
                                    <label>對象</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="transactionAccount" required>
                                        <option value="現金">現金</option>
                                        <option value="銀行">銀行</option>
                                    </select>
                                    <label>帳戶</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="transactionDescription" style="height: 80px;"></textarea>
                                    <label>說明</label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="bi bi-check-circle me-1"></i>儲存
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="hideTransactionForm()">
                                <i class="bi bi-x-circle me-1"></i>取消
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 交易列表 -->
        <div class="table-container mt-4">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>日期</th>
                        <th>類型</th>
                        <th>類別</th>
                        <th>金額</th>
                        <th>對象</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="transactionList">
                    <tr><td colspan="6" class="text-center">載入中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 會員管理 -->
<div class="tab-pane fade" id="members">
    <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4><i class="bi bi-people me-2"></i>會員管理</h4>
            <button class="btn btn-primary btn-sm" onclick="exportMembers()">
                <i class="bi bi-download me-1"></i>匯出會員
            </button>
        </div>
        
        <div class="table-container">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>姓名</th>
                        <th>電話</th>
                        <th>會員狀態</th>
                        <th>加入日期</th>
                        <th>最後捐款</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="memberList">
                    <tr><td colspan="6" class="text-center">載入中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 活動管理 -->
<div class="tab-pane fade" id="activities">
    <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4><i class="bi bi-calendar-event me-2"></i>活動管理</h4>
            <button class="btn btn-success btn-sm" onclick="showActivityForm()">
                <i class="bi bi-plus-circle me-1"></i>新增活動
            </button>
        </div>
        
        <!-- 活動表單 -->
        <div id="activityForm" style="display: none;">
            <div class="card border-success mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">新增活動</h6>
                </div>
                <div class="card-body">
                    <form id="newActivityForm">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="activityName" required>
                                    <label>活動名稱</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select class="form-select" id="activityType" required>
                                        <option value="">請選擇</option>
                                        <option value="講座">講座</option>
                                        <option value="聚會">聚會</option>
                                        <option value="旅遊">旅遊</option>
                                        <option value="運動">運動</option>
                                        <option value="志工服務">志工服務</option>
                                        <option value="其他">其他</option>
                                    </select>
                                    <label>活動類型</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="activityDate" required>
                                    <label>活動日期</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="time" class="form-control" id="activityTime">
                                    <label>活動時間</label>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="activityLocation">
                                    <label>活動地點</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="activityMaxPeople" min="1" value="50">
                                    <label>人數上限</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="activityDescription" style="height: 100px;"></textarea>
                                    <label>活動描述</label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-success me-2">
                                <i class="bi bi-check-circle me-1"></i>建立活動
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="hideActivityForm()">
                                <i class="bi bi-x-circle me-1"></i>取消
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 活動列表 -->
        <div class="row" id="activityList">
            <div class="col-12 text-center">載入中...</div>
        </div>
    </div>
</div>
</div>

<!-- 審查投票模態框 -->
<div class="modal fade" id="voteModal" tabindex="-1">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title">審查投票</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
              <div id="voteItemDetails"></div>
              <div class="form-floating mt-3">
                  <textarea class="form-control" id="voteComment" style="height: 100px;" placeholder="請輸入審查意見（選填）"></textarea>
                  <label>審查意見</label>
              </div>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-success" id="approveBtn">
                  <i class="bi bi-check-circle me-1"></i>贊成/核准
              </button>
              <button type="button" class="btn btn-danger" id="rejectBtn">
                  <i class="bi bi-x-circle me-1"></i>反對/駁回
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          </div>
      </div>
  </div>
</div>

<!-- 圖片預覽模態框 -->
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title">憑證圖片</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
              <img id="modalImage" src="" class="img-fluid" alt="憑證圖片">
          </div>
      </div>
  </div>
</div>

<script>
let userId = null;
let isAdmin = false;
let userRole = null;
let userRoles = [];
let currentVoteItem = null;
let currentVoteType = null;
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwlAtmA28EbyxD18yyZcs6YXebfWdpFJbZmG0wvhdu18ztq_dbqPpY9JJd4e30EesYmuw/exec';

// 初始化 LIFF
liff.init({ liffId: '1656516134-VaGgmaPm' }).then(() => {
    if (!liff.isLoggedIn()) {
        liff.login();
        return;
    }
    
    liff.getProfile().then(profile => {
        userId = profile.userId;
        checkAdminPermission();
    }).catch(err => {
        console.error('取得用戶資料失敗:', err);
        showError('無法取得用戶資料，請重新開啟頁面');
    });
}).catch(err => {
      console.error('LIFF初始化失敗:', err);
      showError('系統初始化失敗，請重新開啟頁面');
  });
  
  // 檢查管理員權限
  async function checkAdminPermission() {
      try {
          const response = await fetch(`${GAS_URL}?action=getUserInfo&userId=${encodeURIComponent(userId)}`);
          
          if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const result = await response.json();
          
          if (!result.success) {
              throw new Error(result.message || '權限驗證失敗');
          }
          
          // 支援多重角色
          try {
              userRoles = JSON.parse(result.data.userInfo.用戶角色) || ['member'];
          } catch (e) {
              userRoles = [result.data.userInfo.用戶角色 || 'member'];
          }
          
          userRole = getHighestRole(userRoles);
          
          if (!hasAnyRole(['admin', 'chairman', 'director', 'supervisor'])) {
              showError('您沒有管理員權限');
              setTimeout(() => {
                  if (liff.isInClient()) {
                      liff.closeWindow();
                  }
              }, 2000);
              return;
          }
          
          isAdmin = true;
          loadDashboard();
          loadReviewDashboard();
      } catch (error) {
          console.error('權限驗證失敗:', error);
          showError(`權限驗證失敗：${error.message}`);
      }
  }
  
  // 權限檢查輔助函數
  function hasRole(role) {
      return userRoles.includes(role);
  }
  
  function hasAnyRole(roles) {
      return roles.some(role => userRoles.includes(role));
  }
  
  function getHighestRole(roles) {
      const hierarchy = { 'admin': 4, 'chairman': 3, 'director': 2, 'supervisor': 2, 'member': 1 };
      let highest = 'member';
      let highestLevel = 0;
      
      roles.forEach(role => {
          const level = hierarchy[role] || 0;
          if (level > highestLevel) {
              highestLevel = level;
              highest = role;
          }
      });
      
      return highest;
  }
  
  // 載入審查總覽
  async function loadReviewDashboard() {
      try {
          const response = await fetch(`${GAS_URL}?action=getReviewDashboard&userId=${encodeURIComponent(userId)}`);
          
          if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const result = await response.json();
          
          if (result.success) {
              const data = result.data;
              
              // 更新審查統計
              document.getElementById('reviewStats').innerHTML = `
                  <div class="review-stat-item">
                      <h4>${data.待審查統計.待審提案數}</h4>
                      <p>待審提案</p>
                  </div>
                  <div class="review-stat-item">
                      <h4>${data.待審查統計.待審憑證數}</h4>
                      <p>待審憑證</p>
                  </div>
                  <div class="review-stat-item">
                      <h4>${data.待審查統計.待審動議數}</h4>
                      <p>待審動議</p>
                  </div>
                  <div class="review-stat-item">
                      <h4>${data.我的審查記錄.本月審查數}</h4>
                      <p>本月審查</p>
                  </div>
              `;
              
              // 載入預覽列表
              loadReviewPreviews();
          }
      } catch (error) {
          console.error('載入審查總覽失敗:', error);
          document.getElementById('reviewStats').innerHTML = 
              '<div class="text-center text-danger">載入審查總覽失敗</div>';
      }
  }
  
  // 載入審查預覽
  async function loadReviewPreviews() {
      // 載入待審提案預覽
      if (hasAnyRole(['director', 'supervisor'])) {
          loadProposalPreview();
      } else {
          document.getElementById('pendingProposalsPreview').innerHTML = 
              '<div class="text-muted small">您沒有提案審查權限</div>';
      }
      
      // 載入待審憑證預覽
      if (hasRole('chairman')) {
          loadExpensePreview();
      } else {
          document.getElementById('pendingExpensesPreview').innerHTML = 
              '<div class="text-muted small">只有理事長可審核憑證</div>';
      }
      
      // 載入待審動議預覽
      if (hasAnyRole(['director', 'supervisor'])) {
          loadMotionPreview();
      } else {
          document.getElementById('pendingMotionsPreview').innerHTML = 
              '<div class="text-muted small">您沒有動議審查權限</div>';
      }
  }
  
  // 載入提案預覽
  async function loadProposalPreview() {
      try {
          const response = await fetch(`${GAS_URL}?action=getPendingProposals&reviewerId=${encodeURIComponent(userId)}`);
          const result = await response.json();
          
          if (result.success && result.data.length > 0) {
              const unvotedProposals = result.data.filter(p => !p.已投票);
              document.getElementById('pendingProposalsPreview').innerHTML = unvotedProposals.slice(0, 3).map(p => `
                  <div class="border-bottom pb-2 mb-2">
                      <h6 class="mb-1">${p.提案標題}</h6>
                      <small class="text-muted">${p.提案類型} | ${formatDate(p.提案時間)}</small>
                      ${p.剩餘天數 <= 1 ? '<div class="deadline-warning mt-1">即將到期</div>' : ''}
                  </div>
              `).join('') + (unvotedProposals.length > 3 ? `<small class="text-muted">還有 ${unvotedProposals.length - 3} 個待審...</small>` : '');
          } else {
              document.getElementById('pendingProposalsPreview').innerHTML = 
                  '<div class="text-muted">暫無待審提案</div>';
          }
      } catch (error) {
          document.getElementById('pendingProposalsPreview').innerHTML = 
              '<div class="text-danger small">載入失敗</div>';
      }
  }
  
  // 載入憑證預覽
  async function loadExpensePreview() {
      try {
          const response = await fetch(`${GAS_URL}?action=getPendingExpenses&reviewerId=${encodeURIComponent(userId)}`);
          const result = await response.json();
          
          if (result.success && result.data.length > 0) {
              document.getElementById('pendingExpensesPreview').innerHTML = result.data.slice(0, 3).map(e => `
                  <div class="border-bottom pb-2 mb-2">
                      <h6 class="mb-1">${e.廠商店家} - $${e.支出金額.toLocaleString()}</h6>
                      <small class="text-muted">${e.支出類別} | ${e.待審天數}天前提交</small>
                      ${e.待審天數 > 7 ? '<div class="deadline-warning mt-1">超過一週</div>' : ''}
                  </div>
              `).join('') + (result.data.length > 3 ? `<small class="text-muted">還有 ${result.data.length - 3} 個待審...</small>` : '');
          } else {
              document.getElementById('pendingExpensesPreview').innerHTML = 
                  '<div class="text-muted">暫無待審憑證</div>';
          }
      } catch (error) {
          document.getElementById('pendingExpensesPreview').innerHTML = 
              '<div class="text-danger small">載入失敗</div>';
      }
  }
  
  // 載入動議預覽
  async function loadMotionPreview() {
      try {
          const response = await fetch(`${GAS_URL}?action=getPendingMotions&reviewerId=${encodeURIComponent(userId)}`);
          const result = await response.json();
          
          if (result.success && result.data.length > 0) {
              const unvotedMotions = result.data.filter(m => !m.已投票);
              document.getElementById('pendingMotionsPreview').innerHTML = unvotedMotions.slice(0, 3).map(m => `
                  <div class="border-bottom pb-2 mb-2">
                      <h6 class="mb-1">${m.動議標題}</h6>
                      <small class="text-muted">${m.緊急程度} | ${formatDate(m.提出時間)}</small>
                      ${m.是否緊急 ? '<div class="deadline-warning mt-1">緊急動議</div>' : ''}
                      ${m.是否逾期 ? '<div class="deadline-warning mt-1">已逾期</div>' : ''}
                  </div>
              `).join('') + (unvotedMotions.length > 3 ? `<small class="text-muted">還有 ${unvotedMotions.length - 3} 個待審...</small>` : '');
          } else {
              document.getElementById('pendingMotionsPreview').innerHTML = 
                  '<div class="text-muted">暫無待審動議</div>';
          }
      } catch (error) {
          document.getElementById('pendingMotionsPreview').innerHTML = 
              '<div class="text-danger small">載入失敗</div>';
      }
  }
  
  // === 提案審查功能增強 ===
  
  // 載入提案列表（增強版）
  async function loadProposalList() {
      try {
          const response = await fetch(`${GAS_URL}?action=getProposalList&reviewerId=${encodeURIComponent(userId)}`);
          
          if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const result = await response.json();
          
          if (result.success && result.data.length > 0) {
              window.allProposals = result.data; // 儲存所有提案用於篩選
              renderProposalList(result.data);
          } else {
              document.getElementById('proposalList').innerHTML = 
                  '<div class="text-center text-muted">暫無提案資料</div>';
          }
      } catch (error) {
          console.error('載入提案列表失敗:', error);
          document.getElementById('proposalList').innerHTML = 
              '<div class="text-center text-danger">載入提案列表失敗</div>';
      }
  }
  
  // 渲染提案列表
  function renderProposalList(proposals) {
      document.getElementById('proposalList').innerHTML = proposals.map(p => `
          <div class="proposal-card" data-status="${p.審查狀態}">
              ${p.剩餘天數 <= 1 && (p.審查狀態 === '待審查' || p.審查狀態 === '審查中') ? 
                '<span class="urgency-badge badge bg-warning">即將到期</span>' : ''}
              <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                      <h6 class="mb-0">${p.提案標題}</h6>
                      <small class="text-light">${p.提案類型} | 提案人：${p.提案人姓名 || '未知'}</small>
                  </div>
                  <div class="d-flex align-items-center">
                      ${p.已投票 ? '<span class="voted-indicator">已投票</span>' : ''}
                      <span class="badge ${getProposalStatusBadge(p.審查狀態)} ms-2">${p.審查狀態}</span>
                  </div>
              </div>
              <div class="card-body">
                  <div class="row">
                      <div class="col-md-8">
                          <p class="mb-2"><strong>提案內容：</strong>${p.提案內容}</p>
                          ${p.預算金額 > 0 ? `<p class="mb-2"><strong>預算：</strong>$${p.預算金額.toLocaleString()}</p>` : ''}
                          ${p.執行期限 ? `<p class="mb-2"><strong>期限：</strong>${formatDate(p.執行期限)}</p>` : ''}
                          <p class="mb-0 text-muted small">
                              提案時間：${formatDateTime(p.提案時間)}
                              ${p.剩餘天數 !== undefined ? ` | 剩餘：${p.剩餘天數}天` : ''}
                          </p>
                      </div>
                      <div class="col-md-4">
                          ${renderProposalVoting(p)}
                      </div>
                  </div>
              </div>
          </div>
      `).join('');
  }
  
  // 提案篩選
  function filterProposals(filter) {
      // 更新篩選標籤狀態
      document.querySelectorAll('#proposalFilterTabs .nav-link').forEach(link => {
          link.classList.remove('active');
      });
      document.querySelector(`#proposalFilterTabs .nav-link[data-filter="${filter}"]`).classList.add('active');
      
      if (!window.allProposals) return;
      
      let filteredProposals = window.allProposals;
      
      switch (filter) {
          case 'pending':
              filteredProposals = window.allProposals.filter(p => p.審查狀態 === '待審查');
              break;
          case 'reviewing':
              filteredProposals = window.allProposals.filter(p => p.審查狀態 === '審查中');
              break;
          case 'approved':
              filteredProposals = window.allProposals.filter(p => p.審查狀態 === '已通過');
              break;
          case 'rejected':
              filteredProposals = window.allProposals.filter(p => p.審查狀態 === '已駁回');
              break;
      }
      
      renderProposalList(filteredProposals);
  }
  
  // 提案投票（使用模態框）
  function voteProposal(proposalId, vote) {
      const proposal = window.allProposals.find(p => p.提案ID === proposalId);
      if (!proposal) return;
      
      currentVoteItem = proposalId;
      currentVoteType = 'proposal';
      
      document.getElementById('voteItemDetails').innerHTML = `
          <h6>${proposal.提案標題}</h6>
          <p><strong>類型：</strong>${proposal.提案類型}</p>
          <p><strong>內容：</strong>${proposal.提案內容}</p>
          ${proposal.預算金額 > 0 ? `<p><strong>預算：</strong>$${proposal.預算金額.toLocaleString()}</p>` : ''}
      `;
      
      // 設定按鈕事件
      document.getElementById('approveBtn').onclick = () => submitVote('approve');
      document.getElementById('rejectBtn').onclick = () => submitVote('reject');
      
      // 根據投票類型調整按鈕文字
      document.getElementById('approveBtn').innerHTML = '<i class="bi bi-check-circle me-1"></i>贊成';
      document.getElementById('rejectBtn').innerHTML = '<i class="bi bi-x-circle me-1"></i>反對';
      
      new bootstrap.Modal(document.getElementById('voteModal')).show();
  }
  
  // 提交投票
  async function submitVote(decision) {
      const comment = document.getElementById('voteComment').value.trim();
      
      try {
          const response = await fetch(GAS_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain' },
              body: JSON.stringify({
                  action: currentVoteType === 'proposal' ? 'reviewProposal' : 
                         currentVoteType === 'motion' ? 'reviewMotion' : 'reviewExpense',
                  [currentVoteType === 'proposal' ? 'proposalId' : 
                   currentVoteType === 'motion' ? 'motionId' : 'expenseId']: currentVoteItem,
                  reviewerId: userId,
                  decision: decision,
                  comment: comment
              })
          });
          
          if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const result = await response.json();
          
          if (result.success) {
              showSuccess('審查完成');
              bootstrap.Modal.getInstance(document.getElementById('voteModal')).hide();
              document.getElementById('voteComment').value = '';
              
              // 重新載入相關列表
              if (currentVoteType === 'proposal') {
                  loadProposalList();
              } else if (currentVoteType === 'motion') {
                  loadMotionList();
              } else if (currentVoteType === 'expense') {
                  loadExpenseList();
              }
              
              loadReviewDashboard();
          } else {
                throw new Error(result.message || '審查失敗');
            }
        } catch (error) {
            console.error('審查失敗:', error);
            showError(`審查失敗：${error.message}`);
        }
    }
    
    // === 支出憑證審核功能增強 ===
    
    // 載入支出憑證列表（增強版）
    async function loadExpenseList() {
        try {
            const response = await fetch(`${GAS_URL}?action=getExpenseList&reviewerId=${encodeURIComponent(userId)}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                window.allExpenses = result.data;
                renderExpenseList(result.data);
            } else {
                document.getElementById('expenseList').innerHTML = 
                    '<div class="text-center text-muted">暫無支出憑證</div>';
            }
        } catch (error) {
            console.error('載入支出憑證列表失敗:', error);
            document.getElementById('expenseList').innerHTML = 
                '<div class="text-center text-danger">載入支出憑證列表失敗</div>';
        }
    }
    
    // 渲染支出憑證列表
    function renderExpenseList(expenses) {
        document.getElementById('expenseList').innerHTML = expenses.map(e => `
            <div class="expense-card" data-status="${e.審核狀態}">
                ${e.待審天數 > 7 && e.審核狀態 === '待審核' ? 
                  '<span class="urgency-badge badge bg-warning">超過一週</span>' : ''}
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">${e.廠商店家} - $${e.支出金額.toLocaleString()}</h6>
                        <small class="text-light">${e.支出類別} | ${formatDate(e.支出日期)} | 提交人：${e.提交人姓名 || '未知'}</small>
                    </div>
                    <span class="badge ${getExpenseStatusBadge(e.審核狀態)}">${e.審核狀態}</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <p class="mb-2"><strong>支出說明：</strong>${e.支出說明}</p>
                            <p class="mb-2 text-muted small">
                                提交時間：${formatDateTime(e.提交時間)}
                                ${e.待審天數 !== undefined ? ` | 待審：${e.待審天數}天` : ''}
                            </p>
                            ${e.憑證圖片 ? `
                                <div class="mt-2">
                                    <img src="${e.憑證圖片}" class="receipt-image" alt="憑證圖片" 
                                         onclick="showImageModal('${e.憑證圖片}')" style="max-height: 150px;">
                                </div>
                            ` : ''}
                        </div>
                        <div class="col-md-4">
                            ${renderExpenseApproval(e)}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // 支出憑證篩選
    function filterExpenses(filter) {
        document.querySelectorAll('#expenseFilterTabs .nav-link').forEach(link => {
            link.classList.remove('active');
        });
        document.querySelector(`#expenseFilterTabs .nav-link[data-filter="${filter}"]`).classList.add('active');
        
        if (!window.allExpenses) return;
        
        let filteredExpenses = window.allExpenses;
        
        switch (filter) {
            case 'pending':
                filteredExpenses = window.allExpenses.filter(e => e.審核狀態 === '待審核');
                break;
            case 'approved':
                filteredExpenses = window.allExpenses.filter(e => e.審核狀態 === '已核准');
                break;
            case 'rejected':
                filteredExpenses = window.allExpenses.filter(e => e.審核狀態 === '已駁回');
                break;
        }
        
        renderExpenseList(filteredExpenses);
    }
    
    // 審核支出憑證（使用模態框）
    function approveExpense(expenseId, decision) {
        const expense = window.allExpenses.find(e => e.憑證ID === expenseId);
        if (!expense) return;
        
        currentVoteItem = expenseId;
        currentVoteType = 'expense';
        
        document.getElementById('voteItemDetails').innerHTML = `
            <h6>${expense.廠商店家} - $${expense.支出金額.toLocaleString()}</h6>
            <p><strong>類別：</strong>${expense.支出類別}</p>
            <p><strong>日期：</strong>${formatDate(expense.支出日期)}</p>
            <p><strong>說明：</strong>${expense.支出說明}</p>
            ${expense.憑證圖片 ? `<img src="${expense.憑證圖片}" class="img-fluid mt-2" style="max-height: 200px;">` : ''}
        `;
        
        document.getElementById('approveBtn').onclick = () => submitVote('approved');
        document.getElementById('rejectBtn').onclick = () => submitVote('rejected');
        
        document.getElementById('approveBtn').innerHTML = '<i class="bi bi-check-circle me-1"></i>核准';
        document.getElementById('rejectBtn').innerHTML = '<i class="bi bi-x-circle me-1"></i>駁回';
        
        new bootstrap.Modal(document.getElementById('voteModal')).show();
    }
    
    // === 臨時動議功能增強 ===
    
    // 載入臨時動議列表（增強版）
    async function loadMotionList() {
        try {
            const response = await fetch(`${GAS_URL}?action=getMotionList&reviewerId=${encodeURIComponent(userId)}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                window.allMotions = result.data;
                renderMotionList(result.data);
            } else {
                document.getElementById('motionList').innerHTML = 
                    '<div class="text-center text-muted">暫無臨時動議</div>';
            }
        } catch (error) {
            console.error('載入臨時動議列表失敗:', error);
            document.getElementById('motionList').innerHTML = 
                '<div class="text-center text-danger">載入臨時動議列表失敗</div>';
        }
    }
    
    // 渲染臨時動議列表
    function renderMotionList(motions) {
        document.getElementById('motionList').innerHTML = motions.map(m => `
            <div class="motion-card" data-status="${m.審查狀態}" data-urgency="${m.緊急程度}">
                ${m.是否緊急 ? '<span class="urgency-badge badge bg-danger">緊急</span>' : ''}
                ${m.是否逾期 ? '<span class="urgency-badge badge bg-warning" style="top: 40px;">逾期</span>' : ''}
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">${m.動議標題}</h6>
                        <small class="text-light">
                            ${m.緊急程度} | ${m.決議期限 ? `期限：${formatDate(m.決議期限)}` : '無期限'} | 提案人：${m.提案人姓名 || '未知'}
                        </small>
                    </div>
                    <div class="d-flex align-items-center">
                        ${m.已投票 ? '<span class="voted-indicator">已投票</span>' : ''}
                        <span class="badge ${getMotionStatusBadge(m.審查狀態)} ms-2">${m.審查狀態}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <p class="mb-2"><strong>動議內容：</strong>${m.動議內容}</p>
                            <p class="mb-2"><strong>提出理由：</strong>${m.提出理由}</p>
                            <p class="mb-0 text-muted small">
                                提出時間：${formatDateTime(m.提出時間)}
                                ${m.剩餘時間 ? ` | 剩餘：${m.剩餘時間}` : ''}
                            </p>
                        </div>
                        <div class="col-md-4">
                            ${renderMotionVoting(m)}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // 臨時動議篩選
    function filterMotions(filter) {
        document.querySelectorAll('#motionFilterTabs .nav-link').forEach(link => {
            link.classList.remove('active');
        });
        document.querySelector(`#motionFilterTabs .nav-link[data-filter="${filter}"]`).classList.add('active');
        
        if (!window.allMotions) return;
        
        let filteredMotions = window.allMotions;
        
        switch (filter) {
            case 'urgent':
                filteredMotions = window.allMotions.filter(m => m.緊急程度 === '緊急');
                break;
            case 'pending':
                filteredMotions = window.allMotions.filter(m => m.審查狀態 === '待審查');
                break;
            case 'approved':
                filteredMotions = window.allMotions.filter(m => m.審查狀態 === '已通過');
                break;
            case 'rejected':
                filteredMotions = window.allMotions.filter(m => m.審查狀態 === '已駁回');
                break;
        }
        
        renderMotionList(filteredMotions);
    }
    
    // 臨時動議投票（使用模態框）
    function voteMotion(motionId, vote) {
        const motion = window.allMotions.find(m => m.動議ID === motionId);
        if (!motion) return;
        
        currentVoteItem = motionId;
        currentVoteType = 'motion';
        
        document.getElementById('voteItemDetails').innerHTML = `
            <h6>${motion.動議標題}</h6>
            <p><strong>緊急程度：</strong><span class="badge ${motion.緊急程度 === '緊急' ? 'bg-danger' : motion.緊急程度 === '重要' ? 'bg-warning' : 'bg-secondary'}">${motion.緊急程度}</span></p>
            <p><strong>動議內容：</strong>${motion.動議內容}</p>
            <p><strong>提出理由：</strong>${motion.提出理由}</p>
            ${motion.決議期限 ? `<p><strong>期限：</strong>${formatDate(motion.決議期限)}</p>` : ''}
        `;
        
        document.getElementById('approveBtn').onclick = () => submitVote('approve');
        document.getElementById('rejectBtn').onclick = () => submitVote('reject');
        
        document.getElementById('approveBtn').innerHTML = '<i class="bi bi-check-circle me-1"></i>贊成';
        document.getElementById('rejectBtn').innerHTML = '<i class="bi bi-x-circle me-1"></i>反對';
        
        new bootstrap.Modal(document.getElementById('voteModal')).show();
    }
    
    // === 輔助函數增強 ===
    
    function renderProposalVoting(proposal) {
        if (proposal.審查狀態 === '待審查' || proposal.審查狀態 === '審查中') {
            if (hasAnyRole(['director', 'supervisor']) && !proposal.已投票) {
                return `
                    <div class="vote-buttons">
                        <button class="btn btn-success btn-sm" onclick="voteProposal('${proposal.提案ID}', 'approve')">
                            <i class="bi bi-check-circle me-1"></i>贊成
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="voteProposal('${proposal.提案ID}', 'reject')">
                            <i class="bi bi-x-circle me-1"></i>反對
                        </button>
                    </div>
                    <div class="vote-status">
                        <span class="text-success">贊成：${proposal.贊成票數 || 0}</span>
                        <span class="text-danger">反對：${proposal.反對票數 || 0}</span>
                    </div>
                `;
            }
        }
        
        return `
            <div class="vote-status">
                <span class="text-success">贊成：${proposal.贊成票數 || 0}</span>
                <span class="text-danger">反對：${proposal.反對票數 || 0}</span>
            </div>
            ${proposal.審核時間 ? `<small class="text-muted">審核時間：${formatDateTime(proposal.審核時間)}</small>` : ''}
        `;
    }
    
    function renderExpenseApproval(expense) {
        if (expense.審核狀態 === '待審核' && hasRole('chairman')) {
            return `
                <div class="approval-section">
                    <h6>理事長審核</h6>
                    <div class="d-flex gap-2 mb-2">
                        <button class="btn btn-success btn-sm" onclick="approveExpense('${expense.憑證ID}', 'approved')">
                            <i class="bi bi-check-circle me-1"></i>核准
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="approveExpense('${expense.憑證ID}', 'rejected')">
                            <i class="bi bi-x-circle me-1"></i>駁回
                        </button>
                    </div>
                </div>
            `;
        }
        
        if (expense.審核狀態 !== '待審核') {
            return `
                <div class="approval-section">
                    <p class="mb-1"><strong>審核結果：</strong>${expense.審核狀態}</p>
                    ${expense.審核意見 ? `<p class="mb-1"><strong>審核意見：</strong>${expense.審核意見}</p>` : ''}
                    <p class="text-muted small mb-0">審核時間：${formatDateTime(expense.審核時間)}</p>
                </div>
            `;
        }
        
        return '<div class="text-muted">等待理事長審核</div>';
    }
    
    function renderMotionVoting(motion) {
        if (motion.審查狀態 === '待審查' || motion.審查狀態 === '審查中') {
            if (hasAnyRole(['director', 'supervisor']) && !motion.已投票) {
                return `
                    <div class="vote-buttons">
                        <button class="btn btn-success btn-sm" onclick="voteMotion('${motion.動議ID}', 'approve')">
                            <i class="bi bi-check-circle me-1"></i>贊成
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="voteMotion('${motion.動議ID}', 'reject')">
                            <i class="bi bi-x-circle me-1"></i>反對
                        </button>
                    </div>
                    <div class="vote-status">
                        <span class="text-success">贊成：${motion.贊成票數 || 0}</span>
                        <span class="text-danger">反對：${motion.反對票數 || 0}</span>
                    </div>
                `;
            }
        }
        
        return `
            <div class="vote-status">
                <span class="text-success">贊成：${motion.贊成票數 || 0}</span>
                <span class="text-danger">反對：${motion.反對票數 || 0}</span>
            </div>
            ${motion.審核時間 ? `<small class="text-muted">審核時間：${formatDateTime(motion.審核時間)}</small>` : ''}
        `;
    }
    
    // 顯示圖片模態框
    function showImageModal(imageSrc) {
        document.getElementById('modalImage').src = imageSrc;
        new bootstrap.Modal(document.getElementById('imageModal')).show();
    }
    
    // 重新整理函數
    function refreshProposals() {
        loadProposalList();
        loadReviewDashboard();
    }
    
    function refreshExpenses() {
        loadExpenseList();
        loadReviewDashboard();
    }
    
    function refreshMotions() {
        loadMotionList();
        loadReviewDashboard();
    }
    
    // 原有的所有其他函數保持不變...
    // (包括 loadDashboard, showProposalForm, hideProposalForm, 提交表單等等)
    
    // 載入儀表板
    async function loadDashboard() {
        try {
            const response = await fetch(`${GAS_URL}?action=getDashboardData`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                const stats = result.data;
                document.getElementById('dashboardStats').innerHTML = `
                    <div class="col-md-3">
                        <div class="stat-card">
                            <h3>${stats.總會員數 || 0}</h3>
                            <p><i class="bi bi-people-fill me-1"></i>總會員數</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                            <h3>$${(stats.本月捐款總額 || 0).toLocaleString()}</h3>
                            <p><i class="bi bi-arrow-up-circle me-1"></i>本月捐款</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                            <h3>${stats.本月捐款次數 || 0}</h3>
                            <p><i class="bi bi-heart-fill me-1"></i>捐款次數</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: linear-gradient(135deg, #ffc107, #e0a800);">
                            <h3>${stats.進行中活動 || 0}</h3>
                            <p><i class="bi bi-calendar-check me-1"></i>進行中活動</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card" style="background: linear-gradient(135deg, #6f42c1, #5a32a3);">
                            <h3>${stats.待審提案 || 0}</h3>
                            <p><i class="bi bi-file-text me-1"></i>待審提案</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card" style="background: linear-gradient(135deg, #fd7e14, #e8590c);">
                            <h3>${stats.待審憑證 || 0}</h3>
                            <p><i class="bi bi-receipt me-1"></i>待審憑證</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card" style="background: linear-gradient(135deg, #e83e8c, #d91a72);">
                            <h3>${stats.待審動議 || 0}</h3>
                            <p><i class="bi bi-lightning me-1"></i>待審動議</p>
                        </div>
                    </div>
                `;
            } else {
                throw new Error(result.message || '載入儀表板資料失敗');
            }
        } catch (error) {
            console.error('載入儀表板失敗:', error);
            document.getElementById('dashboardStats').innerHTML = `
                <div class="col-12 text-center text-danger">
                    <i class="bi bi-exclamation-triangle" style="font-size: 48px;"></i>
                    <p class="mt-2">載入儀表板資料失敗</p>
                </div>
            `;
        }
    }
    
    // 標籤頁切換事件
    document.querySelectorAll('#adminTabs a[data-bs-toggle="pill"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', (e) => {
            const target = e.target.getAttribute('href');
            
            switch (target) {
                case '#dashboard':
                    loadDashboard();
                    break;
                case '#review':
                    loadReviewDashboard();
                    break;
                case '#finance':
                    loadTransactionList();
                    break;
                case '#members':
                    loadMemberList();
                    break;
                case '#activities':
                    loadActivityList();
                    break;
                case '#proposals':
                    loadProposalList();
                    break;
                case '#expenses':
                    loadExpenseList();
                    break;
                case '#motions':
                    loadMotionList();
                    break;
            }
        });
    });
    
    // 其他原有函數...
    // (showProposalForm, hideProposalForm, showExpenseForm, hideExpenseForm, 
    //  showMotionForm, hideMotionForm, 所有表單提交函數等等)
    
    function showProposalForm() {
        document.getElementById('proposalForm').style.display = 'block';
    }
    
    function hideProposalForm() {
        document.getElementById('proposalForm').style.display = 'none';
        document.getElementById('newProposalForm').reset();
    }
    
    function showExpenseForm() {
        document.getElementById('expenseForm').style.display = 'block';
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    }
    
    function hideExpenseForm() {
        document.getElementById('expenseForm').style.display = 'none';
        document.getElementById('newExpenseForm').reset();
    }
    
    function showMotionForm() {
        document.getElementById('motionForm').style.display = 'block';
    }
    
    function hideMotionForm() {
        document.getElementById('motionForm').style.display = 'none';
        document.getElementById('newMotionForm').reset();
    }
    
    function getProposalStatusBadge(status) {
        switch (status) {
            case '待審查': return 'bg-warning';
            case '審查中': return 'bg-info';
            case '已通過': return 'bg-success';
            case '已駁回': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }
    
    function getExpenseStatusBadge(status) {
        switch (status) {
            case '待審核': return 'bg-warning';
            case '已核准': return 'bg-success';
            case '已駁回': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }
    
    function getMotionStatusBadge(status) {
        switch (status) {
            case '待審查': return 'bg-warning';
            case '審查中': return 'bg-info';
            case '已通過': return 'bg-success';
            case '已駁回': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }
    
    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW');
    }
    
    function formatDateTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleString('zh-TW');
    }
    
    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorAlert').style.display = 'block';
        document.getElementById('successAlert').style.display = 'none';
        
        setTimeout(() => {
            document.getElementById('errorAlert').style.display = 'none';
        }, 5000);
    }
    
    function showSuccess(message) {
        document.getElementById('successMessage').textContent = message;
        document.getElementById('successAlert').style.display = 'block';
        document.getElementById('errorAlert').style.display = 'none';
        
        setTimeout(() => {
            document.getElementById('successAlert').style.display = 'none';
        }, 3000);
    }
</script>
</body>
</html>
