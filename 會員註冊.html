<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æœƒå“¡è¨»å†Š - å¸•é‡‘æ£®ç—…å‹æœƒ</title>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
  }

  .container {
    max-width: 600px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  }

  .header {
    text-align: center;
    margin-bottom: 30px;
  }

  .header h1 {
    font-size: 28px;
    color: #333;
    margin-bottom: 10px;
  }

  .header p {
    font-size: 18px;
    color: #666;
  }

  .icon {
    font-size: 60px;
    margin-bottom: 15px;
  }

  .form-group {
    margin-bottom: 25px;
  }

  .form-label {
    display: block;
    font-size: 20px;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
  }

  .required {
    color: #e74c3c;
    font-size: 20px;
  }

  .form-input {
    width: 100%;
    padding: 18px;
    font-size: 20px;
    border: 2px solid #ddd;
    border-radius: 12px;
    transition: all 0.3s;
  }

  .form-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .hint {
    font-size: 16px;
    color: #999;
    margin-top: 8px;
    display: block;
  }

  .checkbox-group {
    margin-bottom: 25px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 12px;
  }

  .checkbox-label {
    display: flex;
    align-items: flex-start;
    font-size: 18px;
    color: #333;
    cursor: pointer;
    line-height: 1.6;
  }

  .checkbox-input {
    width: 24px;
    height: 24px;
    margin-right: 12px;
    margin-top: 2px;
    cursor: pointer;
    flex-shrink: 0;
  }

  .submit-btn {
    width: 100%;
    padding: 20px;
    font-size: 22px;
    font-weight: bold;
    color: white;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
  }

  .submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
  }

  .submit-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .loading {
    display: none;
    text-align: center;
    padding: 20px;
  }

  .loading.show {
    display: block;
  }

  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .error-message {
    background: #fee;
    color: #c33;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 18px;
    display: none;
  }

  .error-message.show {
    display: block;
  }

  .success-message {
    background: #efe;
    color: #3c3;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 18px;
    display: none;
  }

  .success-message.show {
    display: block;
  }

  .step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
  }

  .step {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    color: #666;
    margin: 0 10px;
  }

  .step.active {
    background: #667eea;
    color: white;
  }

  .step.completed {
    background: #3c3;
    color: white;
  }

  .debug-info {
    background: #f0f0f0;
    padding: 10px;
    margin-top: 20px;
    border-radius: 8px;
    font-size: 12px;
    color: #666;
    display: none;
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="icon">ğŸ¥</div>
    <h1>æœƒå“¡è¨»å†Š</h1>
    <p>å°ç£å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ</p>
  </div>

  <div class="step-indicator">
    <div class="step active">1</div>
    <div class="step">2</div>
    <div class="step">3</div>
  </div>

  <div id="errorMessage" class="error-message"></div>
  <div id="successMessage" class="success-message"></div>

  <form id="registerForm">
    <!-- æ­¥é©Ÿ 1: åŸºæœ¬è³‡æ–™ -->
    <div id="step1" class="step-content">
      <div class="form-group">
        <label class="form-label">
          å§“å <span class="required">*</span>
        </label>
        <input 
          type="text" 
          id="name" 
          name="name" 
          class="form-input" 
          placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å"
          required
        >
        <span class="hint">è«‹è¼¸å…¥çœŸå¯¦å§“åï¼Œä»¥ä¾¿æˆ‘å€‘ç‚ºæ‚¨æä¾›æœå‹™</span>
      </div>

      <div class="form-group">
        <label class="form-label">
          æ‰‹æ©Ÿè™Ÿç¢¼ <span class="required">*</span>
        </label>
        <input 
          type="tel" 
          id="phone" 
          name="phone" 
          class="form-input" 
          placeholder="ä¾‹å¦‚ï¼š0912345678"
          pattern="09[0-9]{8}"
          required
        >
        <span class="hint">è«‹è¼¸å…¥10ä½æ•¸æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œç”¨æ–¼æ¥æ”¶æ´»å‹•é€šçŸ¥</span>
      </div>

      <div class="form-group">
        <label class="form-label">
          é›»å­ä¿¡ç®±
        </label>
        <input 
          type="email" 
          id="email" 
          name="email" 
          class="form-input" 
          placeholder="ä¾‹å¦‚ï¼šexample@email.com"
        >
        <span class="hint">é¸å¡«ï¼Œç”¨æ–¼æ¥æ”¶é›»å­å ±</span>
      </div>

      <button type="button" class="submit-btn" onclick="goToStep2()">
        ä¸‹ä¸€æ­¥ â†’
      </button>
    </div>

    <!-- æ­¥é©Ÿ 2: èº«ä»½èˆ‡é†«ç™‚è³‡æ–™ -->
    <div id="step2" class="step-content" style="display: none;">
      <div class="form-group">
        <label class="form-label">
          èº«ä»½åˆ¥ <span class="required">*</span>
        </label>
        <select id="identity" name="identity" class="form-input" required>
          <option value="">è«‹é¸æ“‡</option>
          <option value="ç—…å‹">ç—…å‹</option>
          <option value="å®¶å±¬">å®¶å±¬</option>
          <option value="å¿—å·¥">å¿—å·¥</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
      </div>

      <div id="patientFields" style="display: none;">
        <div class="form-group">
          <label class="form-label">ç¢ºè¨ºå¹´ä»½</label>
          <input 
            type="number" 
            id="diagnosisYear" 
            name="diagnosisYear" 
            class="form-input" 
            placeholder="ä¾‹å¦‚ï¼š2020"
            min="1950"
            max="2026"
          >
        </div>

        <div class="form-group">
          <label class="form-label">ä¸»æ²»é†«å¸«å§“å</label>
          <input 
            type="text" 
            id="doctorName" 
            name="doctorName" 
            class="form-input" 
            placeholder="è«‹è¼¸å…¥é†«å¸«å§“å"
          >
        </div>

        <div class="form-group">
          <label class="form-label">å°±é†«é†«é™¢</label>
          <input 
            type="text" 
            id="hospital" 
            name="hospital" 
            class="form-input" 
            placeholder="ä¾‹å¦‚ï¼šå°å¤§é†«é™¢"
          >
        </div>

        <div class="form-group">
          <label class="form-label">æœ‰ç„¡æ‰‹è¡“</label>
          <select id="hasSurgery" name="hasSurgery" class="form-input">
            <option value="">è«‹é¸æ“‡</option>
            <option value="æ˜¯">æ˜¯</option>
            <option value="å¦">å¦</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">è¡Œå‹•èƒ½åŠ›</label>
        <select id="mobility" name="mobility" class="form-input">
          <option value="">è«‹é¸æ“‡</option>
          <option value="è‡ªç†">è‡ªç†</option>
          <option value="éœ€è¼”å…·">éœ€è¼”å…·</option>
          <option value="éœ€å”åŠ©">éœ€å”åŠ©</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">é£²é£Ÿç¿’æ…£</label>
        <select id="diet" name="diet" class="form-input">
          <option value="">è«‹é¸æ“‡</option>
          <option value="è‘·é£Ÿ">è‘·é£Ÿ</option>
          <option value="ç´ é£Ÿ">ç´ é£Ÿ</option>
          <option value="è›‹å¥¶ç´ ">è›‹å¥¶ç´ </option>
          <option value="äº”è¾›ç´ ">äº”è¾›ç´ </option>
        </select>
      </div>

      <div style="display: flex; gap: 10px;">
        <button type="button" class="submit-btn" onclick="goToStep1()" style="flex: 1; background: #999;">
          â† ä¸Šä¸€æ­¥
        </button>
        <button type="button" class="submit-btn" onclick="goToStep3()" style="flex: 2;">
          ä¸‹ä¸€æ­¥ â†’
        </button>
      </div>
    </div>

    <!-- æ­¥é©Ÿ 3: ç·Šæ€¥è¯çµ¡äººèˆ‡åŒæ„æ›¸ -->
    <div id="step3" class="step-content" style="display: none;">
      <div class="form-group">
        <label class="form-label">ç·Šæ€¥è¯çµ¡äººå§“å</label>
        <input 
          type="text" 
          id="emergencyName" 
          name="emergencyName" 
          class="form-input" 
          placeholder="è«‹è¼¸å…¥ç·Šæ€¥è¯çµ¡äººå§“å"
        >
      </div>

      <div class="form-group">
        <label class="form-label">ç·Šæ€¥è¯çµ¡äººé—œä¿‚</label>
        <select id="emergencyRelation" name="emergencyRelation" class="form-input">
          <option value="">è«‹é¸æ“‡</option>
          <option value="é…å¶">é…å¶</option>
          <option value="å­å¥³">å­å¥³</option>
          <option value="çˆ¶æ¯">çˆ¶æ¯</option>
          <option value="å…„å¼Ÿå§Šå¦¹">å…„å¼Ÿå§Šå¦¹</option>
          <option value="è¦ªå‹">è¦ªå‹</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">ç·Šæ€¥è¯çµ¡äººé›»è©±</label>
        <input 
          type="tel" 
          id="emergencyPhone" 
          name="emergencyPhone" 
          class="form-input" 
          placeholder="ä¾‹å¦‚ï¼š0912345678"
          pattern="09[0-9]{8}"
        >
      </div>

      <div class="checkbox-group">
        <label class="checkbox-label">
          <input 
            type="checkbox" 
            id="agreePrivacy" 
            name="agreePrivacy" 
            class="checkbox-input"
            required
          >
          <span>
            æˆ‘å·²é–±è®€ä¸¦åŒæ„<strong>å€‹äººè³‡æ–™ä¿è­·è²æ˜</strong>ï¼ŒåŒæ„æœ¬æœƒè’é›†ã€è™•ç†åŠåˆ©ç”¨å€‹äººè³‡æ–™ï¼Œä»¥æä¾›ç›¸é—œæœå‹™ã€‚<span class="required">*</span>
          </span>
        </label>
      </div>

      <div class="checkbox-group">
        <label class="checkbox-label">
          <input 
            type="checkbox" 
            id="agreePhoto" 
            name="agreePhoto" 
            class="checkbox-input"
          >
          <span>
            æˆ‘åŒæ„æœ¬æœƒåœ¨æ´»å‹•ä¸­æ‹æ”ç…§ç‰‡ï¼Œä¸¦åŒæ„å°‡ç…§ç‰‡ç”¨æ–¼æœ¬æœƒå®£å‚³ã€ç¶²ç«™åŠç¤¾ç¾¤åª’é«”ä½¿ç”¨ã€‚
          </span>
        </label>
      </div>

      <div style="display: flex; gap: 10px;">
        <button type="button" class="submit-btn" onclick="goToStep2()" style="flex: 1; background: #999;">
          â† ä¸Šä¸€æ­¥
        </button>
        <button type="submit" class="submit-btn" style="flex: 2;">
          âœ“ å®Œæˆè¨»å†Š
        </button>
      </div>
    </div>
  </form>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p style="font-size: 18px; color: #666;">è¨»å†Šä¸­ï¼Œè«‹ç¨å€™...</p>
  </div>

  <div id="debugInfo" class="debug-info"></div>
</div>

<script>
  // ==================== è¨­å®šå€ ====================
  const CONFIG = {
    LIFF_ID: '2007905012-NXJEXmda', // è«‹æ›¿æ›ç‚ºæ‚¨çš„æ­£ç¢º LIFF ID
    GAS_API_URL: 'https://script.google.com/macros/s/AKfycbyTqsjrrxz1WJw-B7FzaD57l8Ee220VF6XkL3EZnyn6kuLNcAKL90bXz801RjHQEBQ/exec',
    DEBUG_MODE: true // é–‹ç™¼æ™‚è¨­ç‚º trueï¼Œæ­£å¼ç’°å¢ƒè¨­ç‚º false
  };

  let lineUserId = null;

  // ==================== LIFF åˆå§‹åŒ– ====================
  window.onload = function() {
    initializeLiff();
  };

  async function initializeLiff() {
    try {
      debugLog('é–‹å§‹åˆå§‹åŒ– LIFF...');
      
      await liff.init({ liffId: CONFIG.LIFF_ID });
      debugLog('LIFF åˆå§‹åŒ–æˆåŠŸ');
      
      if (!liff.isLoggedIn()) {
        debugLog('ä½¿ç”¨è€…æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
        liff.login();
        return;
      }

      // å–å¾—ä½¿ç”¨è€…è³‡æ–™
      const profile = await liff.getProfile();
      lineUserId = profile.userId;
      debugLog('å–å¾—ä½¿ç”¨è€… ID: ' + lineUserId);

      // æª¢æŸ¥æ˜¯å¦å·²è¨»å†Š
      await checkExistingMember(lineUserId);

    } catch (error) {
      console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
      debugLog('LIFF åˆå§‹åŒ–å¤±æ•—: ' + error.message);
      showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
    }
  }

  // ==================== æª¢æŸ¥æœƒå“¡ ====================
  async function checkExistingMember(userId) {
    try {
      debugLog('æª¢æŸ¥æœƒå“¡æ˜¯å¦å·²å­˜åœ¨...');
      
      const url = `${"https://script.google.com/macros/s/AKfycbwcWCb5aMuWWz1KWNQCuAY0vnFSrk_xd91qAO7gxHwq2dl6H-6KtUtXKiCFibLmHeww/exec"}?action=getMember&lineUserId=${encodeURIComponent(userId)}`;
      debugLog('API URL: ' + url);
      
      const response = await fetch(url);
      const member = await response.json();
      
      debugLog('API å›æ‡‰: ' + JSON.stringify(member));

      if (member && member.æœƒå“¡ç·¨è™Ÿ) {
        showError('æ‚¨å·²ç¶“æ˜¯æœƒå“¡äº†ï¼å³å°‡é—œé–‰æ­¤é é¢...');
        setTimeout(() => {
          liff.closeWindow();
        }, 2000);
      } else {
        debugLog('æœƒå“¡ä¸å­˜åœ¨ï¼Œå¯ä»¥ç¹¼çºŒè¨»å†Š');
      }
    } catch (error) {
      console.error('æª¢æŸ¥æœƒå“¡å¤±æ•—:', error);
      debugLog('æª¢æŸ¥æœƒå“¡å¤±æ•—: ' + error.message);
    }
  }

  // ==================== èº«ä»½åˆ¥è®Šæ›´è™•ç† ====================
  document.getElementById('identity').addEventListener('change', function() {
    const patientFields = document.getElementById('patientFields');
    if (this.value === 'ç—…å‹') {
      patientFields.style.display = 'block';
    } else {
      patientFields.style.display = 'none';
    }
  });

  // ==================== æ­¥é©Ÿåˆ‡æ› ====================
  function goToStep1() {
    document.getElementById('step1').style.display = 'block';
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step3').style.display = 'none';
    updateStepIndicator(1);
    window.scrollTo(0, 0);
  }

  function goToStep2() {
    // é©—è­‰æ­¥é©Ÿ1
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();

    if (!name) {
      showError('è«‹è¼¸å…¥å§“å');
      return;
    }

    if (!phone || !phone.match(/^09[0-9]{8}$/)) {
      showError('è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼ï¼ˆ10ä½æ•¸ï¼Œ09é–‹é ­ï¼‰');
      return;
    }

    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    document.getElementById('step3').style.display = 'none';
    updateStepIndicator(2);
    hideError();
    window.scrollTo(0, 0);
  }

  function goToStep3() {
    // é©—è­‰æ­¥é©Ÿ2
    const identity = document.getElementById('identity').value;

    if (!identity) {
      showError('è«‹é¸æ“‡èº«ä»½åˆ¥');
      return;
    }

    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step3').style.display = 'block';
    updateStepIndicator(3);
    hideError();
    window.scrollTo(0, 0);
  }

  function updateStepIndicator(currentStep) {
    const steps = document.querySelectorAll('.step');
    steps.forEach((step, index) => {
      const stepNumber = index + 1;
      step.classList.remove('active', 'completed');
      
      if (stepNumber < currentStep) {
        step.classList.add('completed');
      } else if (stepNumber === currentStep) {
        step.classList.add('active');
      }
    });
  }

  // ==================== è¡¨å–®æäº¤ ====================
  document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // é©—è­‰å€‹è³‡åŒæ„
    if (!document.getElementById('agreePrivacy').checked) {
      showError('è«‹é–±è®€ä¸¦åŒæ„å€‹äººè³‡æ–™ä¿è­·è²æ˜');
      return;
    }

    // é¡¯ç¤ºè¼‰å…¥ä¸­
    document.getElementById('loading').classList.add('show');
    const submitBtn = document.querySelector('#step3 button[type="submit"]');
    submitBtn.disabled = true;

    // æ”¶é›†è¡¨å–®è³‡æ–™
    const formData = {
      lineUserId: lineUserId,
      name: document.getElementById('name').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      email: document.getElementById('email').value.trim(),
      identity: document.getElementById('identity').value,
      diagnosisYear: document.getElementById('diagnosisYear').value,
      doctorName: document.getElementById('doctorName').value.trim(),
      hospital: document.getElementById('hospital').value.trim(),
      hasSurgery: document.getElementById('hasSurgery').value,
      mobility: document.getElementById('mobility').value,
      diet: document.getElementById('diet').value,
      emergencyName: document.getElementById('emergencyName').value.trim(),
      emergencyRelation: document.getElementById('emergencyRelation').value,
      emergencyPhone: document.getElementById('emergencyPhone').value.trim(),
      agreePrivacy: document.getElementById('agreePrivacy').checked,
      agreePhoto: document.getElementById('agreePhoto').checked
    };

    debugLog('æº–å‚™æäº¤è³‡æ–™: ' + JSON.stringify(formData, null, 2));

    try {
      // å‘¼å« GAS API
      debugLog('é–‹å§‹å‘¼å« API...');
      
      const response = await fetch("https://script.google.com/macros/s/AKfycbwcWCb5aMuWWz1KWNQCuAY0vnFSrk_xd91qAO7gxHwq2dl6H-6KtUtXKiCFibLmHeww/exec", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          action: 'registerMember',
          data: JSON.stringify(formData)
        }),
        redirect: 'follow'
      });

      debugLog('API å›æ‡‰ç‹€æ…‹: ' + response.status);
      
      const resultText = await response.text();
      debugLog('API å›æ‡‰å…§å®¹: ' + resultText);
      
      const result = JSON.parse(resultText);
      debugLog('è§£æå¾Œçš„çµæœ: ' + JSON.stringify(result));

      if (result.success) {
        showSuccess(`è¨»å†ŠæˆåŠŸï¼æ­¡è¿åŠ å…¥å¸•é‡‘æ£®ç—…å‹æœƒ ğŸ‰\næ‚¨çš„æœƒå“¡ç·¨è™Ÿï¼š${result.memberId}`);
        setTimeout(() => {
          liff.closeWindow();
        }, 3000);
      } else {
        showError(result.message || 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }

    } catch (error) {
      console.error('è¨»å†ŠéŒ¯èª¤:', error);
      debugLog('è¨»å†ŠéŒ¯èª¤: ' + error.message);
      showError('ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼š' + error.message);
    } finally {
      document.getElementById('loading').classList.remove('show');
      submitBtn.disabled = false;
    }
  });

  // ==================== è¨Šæ¯é¡¯ç¤ºå‡½å¼ ====================
  function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = 'âŒ ' + message;
    errorDiv.classList.add('show');
    window.scrollTo(0, 0);
    setTimeout(() => {
      errorDiv.classList.remove('show');
    }, 5000);
  }

  function hideError() {
    document.getElementById('errorMessage').classList.remove('show');
  }

  function showSuccess(message) {
    const successDiv = document.getElementById('successMessage');
    successDiv.textContent = 'âœ… ' + message;
    successDiv.classList.add('show');
    window.scrollTo(0, 0);
  }

  function debugLog(message) {
    if (CONFIG.DEBUG_MODE) {
      console.log('[DEBUG] ' + message);
      const debugDiv = document.getElementById('debugInfo');
      debugDiv.style.display = 'block';
      debugDiv.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }
  }
</script>
</body>
</html>
