<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>取得 LINE ID 工具</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    .profile-card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    .avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 15px;
      display: block;
    }
    .line-id {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      border-radius: 10px;
      padding: 15px;
      font-family: monospace;
      font-size: 16px;
      word-break: break-all;
      margin: 15px 0;
    }
    .btn {
      background: #2196f3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    .btn:hover {
      background: #1976d2;
    }
    .btn-success {
      background: #4caf50;
    }
    .btn-success:hover {
      background: #45a049;
    }
    .instructions {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }
    .code-block {
      background: #f1f3f4;
      border-radius: 8px;
      padding: 15px;
      font-family: monospace;
      font-size: 14px;
      overflow-x: auto;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="text-align: center; color: #333;">🔍 LINE ID 取得工具</h1>
    
    <div class="instructions">
      <h3>📋 使用說明</h3>
      <ol>
        <li>請在 LINE 中開啟此頁面</li>
        <li>點擊「取得我的 LINE ID」按鈕</li>
        <li>複製顯示的 LINE ID</li>
        <li>將 LINE ID 加入到 GAS 後端的管理員清單中</li>
      </ol>
    </div>

    <div style="text-align: center;">
      <button class="btn" onclick="getLineId()">🔍 取得我的 LINE ID</button>
    </div>

    <div id="profileInfo" style="display: none;">
      <div class="profile-card">
        <img id="userAvatar" class="avatar" src="" alt="頭像">
        <h3 id="userName"></h3>
        <p id="userStatus"></p>
        
        <div class="line-id">
          <strong>您的 LINE ID：</strong><br>
          <span id="lineId"></span>
        </div>
        
        <button class="btn btn-success" onclick="copyLineId()">📋 複製 LINE ID</button>
        <button class="btn" onclick="downloadConfig()">⬇️ 下載設定檔</button>
      </div>
    </div>

    <div class="instructions">
      <h3>⚙️ 設定步驟</h3>
      <p><strong>1. 複製 LINE ID 後，請在 GAS 後端程式中找到以下程式碼：</strong></p>
      <div class="code-block">
ADMIN_USERS: ['管理員的LINE_ID'], // 請替換為實際的管理員LINE ID
      </div>
      
      <p><strong>2. 將其替換為：</strong></p>
      <div class="code-block" id="configExample">
ADMIN_USERS: ['您的LINE_ID'], // 請替換為實際的管理員LINE ID
      </div>
      
      <p><strong>3. 如果有多個管理員，可以這樣設定：</strong></p>
      <div class="code-block">
ADMIN_USERS: [
'LINE_ID_1',
'LINE_ID_2', 
'LINE_ID_3'
],
      </div>
    </div>

    <div class="instructions">
      <h3>🔧 LIFF 設定資訊</h3>
      <p>請確保此頁面使用的 LIFF ID 與主系統相同：</p>
      <div class="code-block" id="liffInfo">
        LIFF ID: <span id="currentLiffId">載入中...</span>
      </div>
    </div>
  </div>

  <script>
    // 請替換為您的實際 LIFF ID
    const LIFF_ID = '1656516134-VaGgmaPm';
    
    let userProfile = null;

    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        document.getElementById('currentLiffId').textContent = LIFF_ID;
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        
        console.log('LIFF 初始化成功');
      } catch (error) {
        console.error('LIFF 初始化失敗:', error);
        alert('LIFF 初始化失敗，請確認 LIFF ID 是否正確');
      }
    }

    async function getLineId() {
      try {
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        userProfile = await liff.getProfile();
        
        document.getElementById('userAvatar').src = userProfile.pictureUrl || 'https://via.placeholder.com/80';
        document.getElementById('userName').textContent = userProfile.displayName;
        document.getElementById('userStatus').textContent = userProfile.statusMessage || '無狀態訊息';
        document.getElementById('lineId').textContent = userProfile.userId;
        
        // 更新設定範例
        document.getElementById('configExample').innerHTML = 
          `ADMIN_USERS: ['${userProfile.userId}'], // 您的 LINE ID`;
        
        document.getElementById('profileInfo').style.display = 'block';
        
        console.log('LINE ID:', userProfile.userId);
      } catch (error) {
        console.error('取得 LINE ID 失敗:', error);
        alert('取得 LINE ID 失敗: ' + error.message);
      }
    }

    function copyLineId() {
      if (!userProfile) return;
      
      const lineId = userProfile.userId;
      
      // 嘗試使用新的 Clipboard API
      if (navigator.clipboard) {
        navigator.clipboard.writeText(lineId).then(() => {
          alert('LINE ID 已複製到剪貼簿！');
        }).catch(err => {
          fallbackCopyTextToClipboard(lineId);
        });
      } else {
        fallbackCopyTextToClipboard(lineId);
      }
    }

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.position = "fixed";
      
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          alert('LINE ID 已複製到剪貼簿！');
        } else {
          alert('複製失敗，請手動複製 LINE ID');
        }
      } catch (err) {
        alert('複製失敗，請手動複製 LINE ID');
      }
      
      document.body.removeChild(textArea);
    }

    function downloadConfig() {
      if (!userProfile) return;
      
      const configText = `// 帕金森病友會管理系統 - 管理員設定
// 請將以下設定複製到您的 GAS 後端程式中

const CONFIG = {
// ... 其他設定 ...
ADMIN_USERS: ['${userProfile.userId}'], // ${userProfile.displayName} 的 LINE ID
// ... 其他設定 ...
};

// 設定日期: ${new Date().toLocaleString('zh-TW')}
// 管理員: ${userProfile.displayName}
// LINE ID: ${userProfile.userId}
`;
      
      const blob = new Blob([configText], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = 'admin-config.js';
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }

    // 頁面載入時初始化 LIFF
    window.addEventListener('load', initLiff);
  </script>
</body>
</html>
