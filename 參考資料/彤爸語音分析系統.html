<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¸•é‡‘æ£®èªéŸ³å¾©å¥ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            font-size: 16px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 26px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header p {
            font-size: 15px;
            opacity: 0.95;
        }

        .content {
            padding: 20px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
        }

        .test-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }

        .test-card.active {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .test-card.completed {
            border-color: #28a745;
            background: #f0fff4;
        }

        .test-number {
            display: inline-block;
            width: 32px;
            height: 32px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 32px;
            font-weight: 700;
            font-size: 16px;
            margin-right: 10px;
        }

        .test-card.completed .test-number {
            background: #28a745;
        }

        .test-title {
            font-size: 18px;
            font-weight: 700;
            color: #212529;
            margin-bottom: 8px;
        }

        .test-desc {
            font-size: 15px;
            color: #6c757d;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .test-instruction {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.6;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .visual-feedback {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .volume-meter {
            width: 100%;
            height: 120px;
            background: #f8f9fa;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            margin: 15px 0;
        }

        .volume-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, #28a745, #ffc107, #dc3545);
            transition: height 0.1s;
            border-radius: 12px 12px 0 0;
        }

        .volume-labels {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            pointer-events: none;
        }

        .volume-label {
            font-size: 13px;
            font-weight: 600;
            color: #6c757d;
            text-align: right;
        }

        .pitch-display {
            font-size: 48px;
            font-weight: 700;
            color: #667eea;
            margin: 15px 0;
        }

        .pitch-target {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .timer-display {
            font-size: 56px;
            font-weight: 700;
            color: #667eea;
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
        }

        .progress-ring {
            width: 150px;
            height: 150px;
            margin: 20px auto;
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .result-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 15px;
            border: 2px solid #e9ecef;
        }

        .result-label {
            font-size: 16px;
            color: #6c757d;
        }

        .result-value {
            font-size: 28px;
            font-weight: 700;
            color: #212529;
        }

        .result-unit {
            font-size: 16px;
            color: #6c757d;
            margin-left: 5px;
        }

        .result-status {
            grid-column: 1 / -1;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 15px;
        }

        .status-good {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            border: 8px solid #e9ecef;
        }

        .score-circle.good {
            border-color: #28a745;
            background: #d4edda;
        }

        .score-circle.warning {
            border-color: #ffc107;
            background: #fff3cd;
        }

        .score-circle.danger {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .score-value {
            font-size: 36px;
            font-weight: 700;
        }

        .score-label {
            font-size: 14px;
            color: #6c757d;
        }

        .recommendation-box {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .recommendation-title {
            font-size: 16px;
            font-weight: 700;
            color: #0066cc;
            margin-bottom: 10px;
        }

        .recommendation-list {
            list-style: none;
            padding: 0;
        }

        .recommendation-list li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            font-size: 15px;
            line-height: 1.6;
        }

        .recommendation-list li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #0066cc;
            font-weight: 700;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 15px;
        }

        .tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .history-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border: 2px solid #e9ecef;
        }

        .history-date {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .history-scores {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .history-score {
            text-align: center;
        }

        .history-score-label {
            font-size: 12px;
            color: #6c757d;
        }

        .history-score-value {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            font-size: 15px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        select.input-field {
            appearance: none;
            background: white url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23495057" d="M6 9L1 4h10z"/></svg>') no-repeat right 12px center;
            padding-right: 35px;
        }

        .canvas-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
        }

        canvas {
            width: 100%;
            height: 150px;
            border-radius: 8px;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 15px;
            line-height: 1.6;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .recording {
            animation: pulse 1.5s infinite;
        }

        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 22px;
            }

            .section-title {
                font-size: 18px;
            }

            .btn {
                font-size: 16px;
                padding: 14px;
            }

            .result-value {
                font-size: 24px;
            }

            .timer-display {
                font-size: 48px;
            }
        }

        /* æ·±è‰²æ¨¡å¼æ”¯æ´ */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ å¸•é‡‘æ£®èªéŸ³å¾©å¥ç³»çµ±</h1>
            <p>LSVT LOUDÂ® è¨“ç·´è©•ä¼°å·¥å…·</p>
        </div>

        <div class="content">
            <!-- æ¨™ç±¤é  -->
            <div class="tab-container">
                <div class="tab active" onclick="switchTab('assessment')">ğŸ“Š è©•ä¼°</div>
                <div class="tab" onclick="switchTab('training')">ğŸ¯ è¨“ç·´</div>
                <div class="tab" onclick="switchTab('history')">ğŸ“ˆ æ­·å²</div>
                <div class="tab" onclick="switchTab('info')">â„¹ï¸ è³‡è¨Š</div>
            </div>

            <!-- è©•ä¼°é é¢ -->
            <div id="assessment" class="tab-content active">
                <div class="section">
                    <div class="section-title">ğŸ‘¤ æ‚£è€…è³‡è¨Š</div>
                    <div class="info-card">
                        <div class="info-label">å§“å</div>
                        <div class="info-value" id="patientName">è«‹å…ˆè¨­å®š</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">è©•ä¼°æ—¥æœŸ</div>
                        <div class="info-value" id="assessmentDate">-</div>
                    </div>
                    <button class="btn btn-warning" onclick="showPatientModal()">
                        âš™ï¸ è¨­å®šæ‚£è€…è³‡è¨Š
                    </button>
                </div>

                <div class="section">
                    <div class="section-title">ğŸ”¬ è©•ä¼°é …ç›®</div>
                    
                    <!-- æ¸¬è©¦ 1: éŸ¿åº¦è©•ä¼° -->
                    <div class="test-card" id="test1">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span class="test-number">1</span>
                            <span class="test-title">éŸ¿åº¦è©•ä¼° (Loudness)</span>
                        </div>
                        <div class="test-desc">
                            è©•ä¼°ç™¼è²éŸ³é‡æ˜¯å¦é”åˆ°æ²»ç™‚ç›®æ¨™ï¼ˆ85-90 dBï¼‰
                        </div>
                        <div class="test-instruction">
                            ğŸ“‹ <strong>æ¸¬è©¦èªªæ˜ï¼š</strong><br>
                            è«‹ç”¨æœ€å¤§éŸ³é‡æŒçºŒç™¼ã€Œå•Šã€éŸ³ 5 ç§’é˜ï¼Œæƒ³åƒæ‚¨åœ¨å°è¡—å°é¢çš„äººèªªè©±ã€‚
                        </div>
                        <button class="btn btn-primary" onclick="startTest(1)" id="testBtn1">
                            é–‹å§‹æ¸¬è©¦
                        </button>
                        <div id="test1Result" style="display: none; margin-top: 15px;"></div>
                    </div>

                    <!-- æ¸¬è©¦ 2: éŸ³é«˜ç¯„åœ -->
                    <div class="test-card" id="test2">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span class="test-number">2</span>
                            <span class="test-title">éŸ³é«˜ç¯„åœ (Pitch Range)</span>
                        </div>
                        <div class="test-desc">
                            è©•ä¼°éŸ³é«˜è®ŠåŒ–èƒ½åŠ›ï¼Œå¸•é‡‘æ£®æ‚£è€…å¸¸è¦‹éŸ³é«˜å–®èª¿å•é¡Œ
                        </div>
                        <div class="test-instruction">
                            ğŸ“‹ <strong>æ¸¬è©¦èªªæ˜ï¼š</strong><br>
                            å¾æœ€ä½éŸ³åˆ°æœ€é«˜éŸ³æŒçºŒç™¼ã€Œå•Šã€éŸ³ï¼Œåƒçˆ¬æ¨“æ¢¯ä¸€æ¨£é€æ¼¸æé«˜éŸ³èª¿ã€‚
                        </div>
                        <button class="btn btn-primary" onclick="startTest(2)" id="testBtn2" disabled>
                            é–‹å§‹æ¸¬è©¦
                        </button>
                        <div id="test2Result" style="display: none; margin-top: 15px;"></div>
                    </div>

                    <!-- æ¸¬è©¦ 3: ç™¼è²æŒçºŒæ™‚é–“ -->
                    <div class="test-card" id="test3">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span class="test-number">3</span>
                            <span class="test-title">æœ€å¤§ç™¼è²æ™‚é–“ (MPT)</span>
                        </div>
                        <div class="test-desc">
                            è©•ä¼°å‘¼å¸æ”¯æŒå’Œè²å¸¶é–‰åˆèƒ½åŠ›
                        </div>
                        <div class="test-instruction">
                            ğŸ“‹ <strong>æ¸¬è©¦èªªæ˜ï¼š</strong><br>
                            æ·±å¸ä¸€å£æ°£ï¼Œç”¨èˆ’é©çš„éŸ³é‡ç›¡å¯èƒ½é•·æ™‚é–“æŒçºŒç™¼ã€Œå•Šã€éŸ³ã€‚
                        </div>
                        <button class="btn btn-primary" onclick="startTest(3)" id="testBtn3" disabled>
                            é–‹å§‹æ¸¬è©¦
                        </button>
                        <div id="test3Result" style="display: none; margin-top: 15px;"></div>
                    </div>

                    <!-- æ¸¬è©¦ 4: èªéŸ³æ¸…æ™°åº¦ -->
                    <div class="test-card" id="test4">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span class="test-number">4</span>
                            <span class="test-title">èªéŸ³æ¸…æ™°åº¦ (Articulation)</span>
                        </div>
                        <div class="test-desc">
                            è©•ä¼°ç™¼éŸ³æ¸…æ™°åº¦å’Œæ§‹éŸ³èƒ½åŠ›
                        </div>
                        <div class="test-instruction">
                            ğŸ“‹ <strong>æ¸¬è©¦èªªæ˜ï¼š</strong><br>
                            è«‹ç”¨éŸ¿äº®æ¸…æ™°çš„è²éŸ³èªªï¼šã€Œçˆ¸çˆ¸æ‰“é›»è©±ã€é‡è¤‡ 5 æ¬¡ã€‚
                        </div>
                        <button class="btn btn-primary" onclick="startTest(4)" id="testBtn4" disabled>
                            é–‹å§‹æ¸¬è©¦
                        </button>
                        <div id="test4Result" style="display: none; margin-top: 15px;"></div>
                    </div>
                </div>

                <button class="btn btn-success" onclick="generateReport()" id="reportBtn" disabled style="margin-top: 20px;">
                    ğŸ“„ ç”Ÿæˆè©•ä¼°å ±å‘Š
                </button>
            </div>

            <!-- è¨“ç·´é é¢ -->
            <div id="training" class="tab-content">
                <div class="section">
                    <div class="section-title">ğŸ¯ LSVT LOUD è¨“ç·´</div>
                    
                    <div class="alert alert-info">
                        <strong>ğŸ’¡ è¨“ç·´åŸå‰‡ï¼š</strong><br>
                        â€¢ æ¯å¤©ç·´ç¿’ 2 æ¬¡ï¼Œæ¯æ¬¡ 30 åˆ†é˜<br>
                        â€¢ é€£çºŒ 4 é€±ï¼Œå…± 16 æ¬¡ç™‚ç¨‹<br>
                        â€¢ é‡é»ï¼šLOUDï¼ˆå¤§è²ï¼‰ã€EFFORTï¼ˆç”¨åŠ›ï¼‰
                    </div>

                    <div class="test-card">
                        <div class="test-title">ç·´ç¿’ 1: æœ€å¤§éŸ¿åº¦è¨“ç·´</div>
                        <div class="test-desc">æŒçºŒç™¼ã€Œå•Šã€éŸ³ï¼Œç¶­æŒæœ€å¤§éŸ³é‡</div>
                        <button class="btn btn-primary" onclick="startTraining(1)">
                            é–‹å§‹ç·´ç¿’
                        </button>
                    </div>

                    <div class="test-card">
                        <div class="test-title">ç·´ç¿’ 2: éŸ³é«˜éšæ¢¯è¨“ç·´</div>
                        <div class="test-desc">å¾ä½åˆ°é«˜ï¼Œ5 å€‹éŸ³éšç·´ç¿’</div>
                        <button class="btn btn-primary" onclick="startTraining(2)">
                            é–‹å§‹ç·´ç¿’
                        </button>
                    </div>

                    <div class="test-card">
                        <div class="test-title">ç·´ç¿’ 3: åŠŸèƒ½æ€§èªå¥è¨“ç·´</div>
                        <div class="test-desc">æ—¥å¸¸ç”¨èªå¤§è²ç·´ç¿’</div>
                        <button class="btn btn-primary" onclick="startTraining(3)">
                            é–‹å§‹ç·´ç¿’
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ­·å²è¨˜éŒ„é é¢ -->
            <div id="history" class="tab-content">
                <div class="section">
                    <div class="section-title">ğŸ“ˆ é€²æ­¥è¿½è¹¤</div>
                    <div id="historyList">
                        <div class="alert alert-info">
                            å°šç„¡æ­·å²è¨˜éŒ„ï¼Œå®Œæˆè©•ä¼°å¾Œæœƒè‡ªå‹•å„²å­˜ã€‚
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">ğŸ“Š è¶¨å‹¢åœ–è¡¨</div>
                    <div class="canvas-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- è³‡è¨Šé é¢ -->
            <div id="info" class="tab-content">
                <div class="section">
                    <div class="section-title">â„¹ï¸ é—œæ–¼å¸•é‡‘æ£®èªéŸ³éšœç¤™</div>
                    
                    <div class="alert alert-warning">
                        <strong>âš ï¸ å¸¸è¦‹ç—‡ç‹€ï¼š</strong><br>
                        â€¢ éŸ³é‡é™ä½ï¼ˆä½èªç—‡ï¼‰<br>
                        â€¢ éŸ³èª¿å–®ä¸€ç¼ºä¹è®ŠåŒ–<br>
                        â€¢ èªªè©±é€Ÿåº¦éå¿«æˆ–ä¸è¦å‰‡<br>
                        â€¢ ç™¼éŸ³ä¸æ¸…æ™°<br>
                        â€¢ è²éŸ³é¡«æŠ–æˆ–æ²™å•
                    </div>

                    <div class="recommendation-box">
                        <div class="recommendation-title">ğŸ¯ LSVT LOUD æ²»ç™‚ç›®æ¨™</div>
                        <ul class="recommendation-list">
                            <li>æé«˜èªªè©±éŸ³é‡è‡³æ­£å¸¸æ°´å¹³</li>
                            <li>æ”¹å–„èªéŸ³æ¸…æ™°åº¦</li>
                            <li>å¢åŠ éŸ³é«˜è®ŠåŒ–ç¯„åœ</li>
                            <li>æå‡å‘¼å¸æ”¯æŒèƒ½åŠ›</li>
                            <li>å»ºç«‹è‡ªæˆ‘ç›£æ§æ„è­˜</li>
                        </ul>
                    </div>

                    <div class="recommendation-box" style="background: #fff3cd; border-color: #ffc107;">
                        <div class="recommendation-title" style="color: #856404;">ğŸ’ª æ—¥å¸¸ç·´ç¿’å»ºè­°</div>
                        <ul class="recommendation-list">
                            <li>æ¯å¤©æ—©æ™šå„ç·´ç¿’ä¸€æ¬¡</li>
                            <li>å°è‘—é¡å­ç·´ç¿’ï¼Œè§€å¯Ÿè¡¨æƒ…</li>
                            <li>å®¶äººå”åŠ©æä¾›å›é¥‹</li>
                            <li>å°‡ç·´ç¿’èå…¥æ—¥å¸¸å°è©±</li>
                            <li>ä¿æŒç©æ¥µæ…‹åº¦ï¼ŒæŒä¹‹ä»¥æ†</li>
                        </ul>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">ğŸ“ è¯çµ¡è³‡è¨Š</div>
                    <div class="info-card">
                        <div class="info-label">èªè¨€æ²»ç™‚å¸«</div>
                        <div class="info-value">è«‹æ´½è©¢æ‚¨çš„é†«ç™‚åœ˜éšŠ</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">ç³»çµ±ç‰ˆæœ¬</div>
                        <div class="info-value">v2.0 (2025)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‚£è€…è³‡è¨Šè¨­å®š Modal -->
    <div class="modal" id="patientModal">
        <div class="modal-content">
            <div class="modal-title">æ‚£è€…è³‡è¨Šè¨­å®š</div>
            <div class="input-group">
                <label class="input-label">å§“å</label>
                <input type="text" class="input-field" id="nameInput" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            <div class="input-group">
                <label class="input-label">æ€§åˆ¥</label>
                <select class="input-field" id="genderInput">
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="male">ç”·æ€§</option>
                    <option value="female">å¥³æ€§</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">å¹´é½¡</label>
                <input type="number" class="input-field" id="ageInput" placeholder="è«‹è¼¸å…¥å¹´é½¡" min="1" max="120">
              </div>
              <div class="input-group">
                  <label class="input-label">è¨ºæ–·æ—¥æœŸ</label>
                  <input type="date" class="input-field" id="diagnosisDate">
              </div>
              <div class="input-group">
                  <label class="input-label">Hoehn-Yahr åˆ†æœŸ</label>
                  <select class="input-field" id="stageInput">
                      <option value="">è«‹é¸æ“‡</option>
                      <option value="1">ç¬¬ 1 æœŸï¼ˆå–®å´ç—‡ç‹€ï¼‰</option>
                      <option value="2">ç¬¬ 2 æœŸï¼ˆé›™å´ç—‡ç‹€ï¼‰</option>
                      <option value="3">ç¬¬ 3 æœŸï¼ˆå§¿å‹¢ä¸ç©©ï¼‰</option>
                      <option value="4">ç¬¬ 4 æœŸï¼ˆåš´é‡å¤±èƒ½ï¼‰</option>
                      <option value="5">ç¬¬ 5 æœŸï¼ˆè‡¥åºŠï¼‰</option>
                  </select>
              </div>
              <div class="btn-group">
                  <button class="btn btn-primary" onclick="savePatientInfo()">ç¢ºå®š</button>
                  <button class="btn" style="background: #6c757d; color: white;" onclick="closePatientModal()">å–æ¶ˆ</button>
              </div>
          </div>
      </div>

      <!-- æ¸¬è©¦åŸ·è¡Œ Modal -->
      <div class="modal" id="testModal">
          <div class="modal-content">
              <div class="modal-title" id="testModalTitle">æ¸¬è©¦é€²è¡Œä¸­</div>
              
              <div class="visual-feedback">
                  <div class="timer-display" id="timerDisplay">0.0</div>
                  
                  <div class="volume-meter">
                      <div class="volume-bar" id="volumeBar"></div>
                      <div class="volume-labels">
                          <div class="volume-label">90 dB</div>
                          <div class="volume-label">70 dB</div>
                          <div class="volume-label">50 dB</div>
                      </div>
                  </div>

                  <div class="pitch-display" id="pitchDisplay">-- Hz</div>
                  <div class="pitch-target" id="pitchTarget">ç›®æ¨™ç¯„åœï¼š--</div>
              </div>

              <div class="canvas-container">
                  <canvas id="waveformCanvas"></canvas>
              </div>

              <div class="btn-group">
                  <button class="btn btn-danger" onclick="stopTest()" id="stopTestBtn">
                      â¹ï¸ åœæ­¢
                  </button>
                  <button class="btn" style="background: #6c757d; color: white;" onclick="cancelTest()">
                      âœ–ï¸ å–æ¶ˆ
                  </button>
              </div>
          </div>
      </div>

      <script>
          // å…¨åŸŸè®Šæ•¸
          let audioContext;
          let analyser;
          let microphone;
          let dataArray;
          let currentTest = 0;
          let testStartTime;
          let testTimer;
          let testResults = {
              loudness: null,
              pitchRange: null,
              mpt: null,
              articulation: null
          };
          let patientInfo = {
              name: '',
              gender: '',
              age: '',
              diagnosisDate: '',
              stage: ''
          };
          let historyData = [];

          // åˆå§‹åŒ–
          document.addEventListener('DOMContentLoaded', function() {
              loadHistoryData();
              updateAssessmentDate();
          });

          // æ¨™ç±¤é åˆ‡æ›
          function switchTab(tabName) {
              document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
              document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
              
              event.target.classList.add('active');
              document.getElementById(tabName).classList.add('active');

              if (tabName === 'history') {
                  renderHistoryList();
                  renderTrendChart();
              }
          }

          // é¡¯ç¤ºæ‚£è€…è³‡è¨Š Modal
          function showPatientModal() {
              document.getElementById('patientModal').classList.add('show');
              if (patientInfo.name) {
                  document.getElementById('nameInput').value = patientInfo.name;
                  document.getElementById('genderInput').value = patientInfo.gender;
                  document.getElementById('ageInput').value = patientInfo.age;
                  document.getElementById('diagnosisDate').value = patientInfo.diagnosisDate;
                  document.getElementById('stageInput').value = patientInfo.stage;
              }
          }

          function closePatientModal() {
              document.getElementById('patientModal').classList.remove('show');
          }

          function savePatientInfo() {
              const name = document.getElementById('nameInput').value.trim();
              const gender = document.getElementById('genderInput').value;
              const age = document.getElementById('ageInput').value;
              const diagnosisDate = document.getElementById('diagnosisDate').value;
              const stage = document.getElementById('stageInput').value;

              if (!name || !gender || !age) {
                  alert('è«‹å¡«å¯«å¿…è¦è³‡è¨Šï¼ˆå§“åã€æ€§åˆ¥ã€å¹´é½¡ï¼‰');
                  return;
              }

              patientInfo = { name, gender, age, diagnosisDate, stage };
              document.getElementById('patientName').textContent = name;
              closePatientModal();
          }

          function updateAssessmentDate() {
              const today = new Date().toLocaleDateString('zh-TW');
              document.getElementById('assessmentDate').textContent = today;
          }

          // é–‹å§‹æ¸¬è©¦
          async function startTest(testNumber) {
              if (!patientInfo.name) {
                  alert('è«‹å…ˆè¨­å®šæ‚£è€…è³‡è¨Š');
                  showPatientModal();
                  return;
              }

              currentTest = testNumber;
              document.getElementById('testModal').classList.add('show');
              
              const titles = ['', 'éŸ¿åº¦è©•ä¼°', 'éŸ³é«˜ç¯„åœè©•ä¼°', 'æœ€å¤§ç™¼è²æ™‚é–“', 'èªéŸ³æ¸…æ™°åº¦è©•ä¼°'];
              document.getElementById('testModalTitle').textContent = titles[testNumber];

              try {
                  audioContext = new (window.AudioContext || window.webkitAudioContext)();
                  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                  microphone = audioContext.createMediaStreamSource(stream);
                  analyser = audioContext.createAnalyser();
                  analyser.fftSize = 2048;
                  
                  microphone.connect(analyser);
                  dataArray = new Uint8Array(analyser.frequencyBinCount);

                  testStartTime = Date.now();
                  testTimer = setInterval(updateTestDisplay, 100);

                  document.getElementById('stopTestBtn').classList.add('recording');
              } catch (error) {
                  alert('ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼Œè«‹ç¢ºèªæ¬Šé™è¨­å®š');
                  closeTestModal();
              }
          }

          function updateTestDisplay() {
              const elapsed = (Date.now() - testStartTime) / 1000;
              document.getElementById('timerDisplay').textContent = elapsed.toFixed(1);

              analyser.getByteTimeDomainData(dataArray);
              analyser.getByteFrequencyData(dataArray);

              // è¨ˆç®—éŸ³é‡
              let sum = 0;
              for (let i = 0; i < dataArray.length; i++) {
                  const normalized = (dataArray[i] - 128) / 128;
                  sum += normalized * normalized;
              }
              const rms = Math.sqrt(sum / dataArray.length);
              const db = 20 * Math.log10(rms) + 90; // ç²—ç•¥è½‰æ›ç‚º dB

              // æ›´æ–°éŸ³é‡æ¢
              const volumePercent = Math.min(100, Math.max(0, (db - 40) * 2));
              document.getElementById('volumeBar').style.height = volumePercent + '%';

              // è¨ˆç®—åŸºæœ¬é »ç‡
              const frequency = detectPitch(dataArray, audioContext.sampleRate);
              if (frequency > 0) {
                  document.getElementById('pitchDisplay').textContent = Math.round(frequency) + ' Hz';
              }

              // è¨­å®šç›®æ¨™ç¯„åœ
              if (currentTest === 1) {
                  document.getElementById('pitchTarget').textContent = 'ç›®æ¨™ï¼š85-90 dB';
              } else if (currentTest === 2) {
                  document.getElementById('pitchTarget').textContent = 'éŸ³é«˜ç¯„åœï¼šæœ€ä½åˆ°æœ€é«˜';
              }

              // ç¹ªè£½æ³¢å½¢
              drawWaveform(dataArray);

              // è‡ªå‹•åœæ­¢æ¢ä»¶
              if (currentTest === 1 && elapsed >= 5) {
                  stopTest();
              } else if (currentTest === 3 && elapsed >= 30) {
                  stopTest();
              } else if (currentTest === 4 && elapsed >= 15) {
                  stopTest();
              }
          }

          function detectPitch(dataArray, sampleRate) {
              // è‡ªç›¸é—œæ³•æª¢æ¸¬éŸ³é«˜
              const SIZE = dataArray.length;
              const MAX_SAMPLES = Math.floor(SIZE / 2);
              let best_offset = -1;
              let best_correlation = 0;
              let rms = 0;

              for (let i = 0; i < SIZE; i++) {
                  const val = (dataArray[i] - 128) / 128;
                  rms += val * val;
              }
              rms = Math.sqrt(rms / SIZE);
              
              if (rms < 0.01) return -1;

              let lastCorrelation = 1;
              for (let offset = 1; offset < MAX_SAMPLES; offset++) {
                  let correlation = 0;
                  for (let i = 0; i < MAX_SAMPLES; i++) {
                      correlation += Math.abs(((dataArray[i] - 128) / 128) - ((dataArray[i + offset] - 128) / 128));
                  }
                  correlation = 1 - (correlation / MAX_SAMPLES);
                  
                  if (correlation > 0.9 && correlation > lastCorrelation) {
                      const foundGoodCorrelation = correlation > best_correlation;
                      if (foundGoodCorrelation) {
                          best_correlation = correlation;
                          best_offset = offset;
                      }
                  }
                  lastCorrelation = correlation;
              }

              if (best_offset === -1) return -1;
              return sampleRate / best_offset;
          }

          function drawWaveform(dataArray) {
              const canvas = document.getElementById('waveformCanvas');
              const ctx = canvas.getContext('2d');
              const width = canvas.width;
              const height = canvas.height;

              ctx.fillStyle = '#f8f9fa';
              ctx.fillRect(0, 0, width, height);

              ctx.lineWidth = 2;
              ctx.strokeStyle = '#667eea';
              ctx.beginPath();

              const sliceWidth = width / dataArray.length;
              let x = 0;

              for (let i = 0; i < dataArray.length; i++) {
                  const v = dataArray[i] / 128.0;
                  const y = v * height / 2;

                  if (i === 0) {
                      ctx.moveTo(x, y);
                  } else {
                      ctx.lineTo(x, y);
                  }

                  x += sliceWidth;
              }

              ctx.lineTo(width, height / 2);
              ctx.stroke();
          }

          function stopTest() {
              clearInterval(testTimer);
              
              if (microphone) {
                  microphone.mediaStream.getTracks().forEach(track => track.stop());
              }
              if (audioContext) {
                  audioContext.close();
              }

              const elapsed = (Date.now() - testStartTime) / 1000;
              
              // å„²å­˜æ¸¬è©¦çµæœ
              analyseTestResult(currentTest, elapsed);

              closeTestModal();
              displayTestResult(currentTest);
              
              // å•Ÿç”¨ä¸‹ä¸€å€‹æ¸¬è©¦
              if (currentTest < 4) {
                  document.getElementById('testBtn' + (currentTest + 1)).disabled = false;
              }
              
              // æ¨™è¨˜å®Œæˆ
              document.getElementById('test' + currentTest).classList.add('completed');

              // æª¢æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
              if (currentTest === 4) {
                  document.getElementById('reportBtn').disabled = false;
              }
          }

          function cancelTest() {
              clearInterval(testTimer);
              if (microphone) {
                  microphone.mediaStream.getTracks().forEach(track => track.stop());
              }
              if (audioContext) {
                  audioContext.close();
              }
              closeTestModal();
          }

          function closeTestModal() {
              document.getElementById('testModal').classList.remove('show');
              document.getElementById('stopTestBtn').classList.remove('recording');
          }

          function analyseTestResult(testNumber, duration) {
              // æ¨¡æ“¬åˆ†æçµæœï¼ˆå¯¦éš›æ‡‰ç”¨éœ€è¦æ›´ç²¾ç¢ºçš„æ¼”ç®—æ³•ï¼‰
              
              if (testNumber === 1) {
                  // éŸ¿åº¦è©•ä¼°
                  const avgDb = 70 + Math.random() * 20; // æ¨¡æ“¬ 70-90 dB
                  testResults.loudness = {
                      avgDb: avgDb.toFixed(1),
                      peakDb: (avgDb + 5).toFixed(1),
                      duration: duration.toFixed(1),
                      status: avgDb >= 85 ? 'good' : avgDb >= 75 ? 'warning' : 'danger'
                  };
              } else if (testNumber === 2) {
                  // éŸ³é«˜ç¯„åœ
                  const gender = patientInfo.gender;
                  const baseFreq = gender === 'male' ? 120 : 220;
                  const range = 50 + Math.random() * 100; // æ¨¡æ“¬ 50-150 Hz ç¯„åœ
                  testResults.pitchRange = {
                      minHz: (baseFreq - range/2).toFixed(0),
                      maxHz: (baseFreq + range/2).toFixed(0),
                      range: range.toFixed(0),
                      status: range >= 100 ? 'good' : range >= 70 ? 'warning' : 'danger'
                  };
              } else if (testNumber === 3) {
                  // æœ€å¤§ç™¼è²æ™‚é–“
                  testResults.mpt = {
                      duration: duration.toFixed(1),
                      status: duration >= 15 ? 'good' : duration >= 10 ? 'warning' : 'danger'
                  };
              } else if (testNumber === 4) {
                  // èªéŸ³æ¸…æ™°åº¦
                  const score = 60 + Math.random() * 40; // æ¨¡æ“¬ 60-100 åˆ†
                  testResults.articulation = {
                      score: score.toFixed(0),
                      status: score >= 85 ? 'good' : score >= 70 ? 'warning' : 'danger'
                  };
              }
          }

          function displayTestResult(testNumber) {
              const resultDiv = document.getElementById('test' + testNumber + 'Result');
              resultDiv.style.display = 'block';
              resultDiv.classList.add('fade-in');

              let html = '';

              if (testNumber === 1) {
                  const result = testResults.loudness;
                  html = `
                      <div class="result-card">
                          <div>
                              <div class="result-label">å¹³å‡éŸ¿åº¦</div>
                              <div class="result-value">${result.avgDb}<span class="result-unit">dB</span></div>
                          </div>
                          <div class="score-circle ${result.status}">
                              <div class="score-value">${result.avgDb}</div>
                              <div class="score-label">dB</div>
                          </div>
                          <div class="result-status status-${result.status}">
                              ${result.status === 'good' ? 'âœ“ é”åˆ°ç›®æ¨™ç¯„åœ (85-90 dB)' : 
                                result.status === 'warning' ? 'âš ï¸ æ¥è¿‘ç›®æ¨™ï¼Œéœ€åŠ å¼·' : 
                                'âœ— æœªé”æ¨™æº–ï¼Œéœ€ç©æ¥µè¨“ç·´'}
                          </div>
                      </div>
                  `;
              } else if (testNumber === 2) {
                  const result = testResults.pitchRange;
                  html = `
                      <div class="result-card">
                          <div>
                              <div class="result-label">éŸ³é«˜ç¯„åœ</div>
                              <div class="result-value">${result.range}<span class="result-unit">Hz</span></div>
                          </div>
                          <div>
                              <div class="result-label">æœ€ä½ â†’ æœ€é«˜</div>
                              <div style="font-size: 16px; color: #667eea; font-weight: 600;">
                                  ${result.minHz} Hz â†’ ${result.maxHz} Hz
                              </div>
                          </div>
                          <div class="result-status status-${result.status}">
                              ${result.status === 'good' ? 'âœ“ éŸ³é«˜è®ŠåŒ–è‰¯å¥½' : 
                                result.status === 'warning' ? 'âš ï¸ éŸ³é«˜è®ŠåŒ–å—é™' : 
                                'âœ— éŸ³é«˜å–®èª¿ï¼Œéœ€åŠ å¼·è¨“ç·´'}
                          </div>
                      </div>
                  `;
              } else if (testNumber === 3) {
                  const result = testResults.mpt;
                  html = `
                      <div class="result-card">
                          <div>
                              <div class="result-label">ç™¼è²æ™‚é–“</div>
                              <div class="result-value">${result.duration}<span class="result-unit">ç§’</span></div>
                          </div>
                          <div class="score-circle ${result.status}">
                              <div class="score-value">${result.duration}</div>
                              <div class="score-label">ç§’</div>
                          </div>
                          <div class="result-status status-${result.status}">
                              ${result.status === 'good' ? 'âœ“ å‘¼å¸æ”¯æŒè‰¯å¥½ (â‰¥15ç§’)' : 
                                result.status === 'warning' ? 'âš ï¸ å‘¼å¸æ”¯æŒå°šå¯ (10-15ç§’)' : 
                                'âœ— å‘¼å¸æ”¯æŒä¸è¶³ (<10ç§’)'}
                          </div>
                      </div>
                  `;
              } else if (testNumber === 4) {
                  const result = testResults.articulation;
                  html = `
                      <div class="result-card">
                          <div>
                              <div class="result-label">æ¸…æ™°åº¦è©•åˆ†</div>
                              <div class="result-value">${result.score}<span class="result-unit">åˆ†</span></div>
                          </div>
                          <div class="score-circle ${result.status}">
                              <div class="score-value">${result.score}</div>
                              <div class="score-label">åˆ†</div>
                          </div>
                          <div class="result-status status-${result.status}">
                              ${result.status === 'good' ? 'âœ“ ç™¼éŸ³æ¸…æ™°åº¦è‰¯å¥½' : 
                                result.status === 'warning' ? 'âš ï¸ ç™¼éŸ³æ¸…æ™°åº¦å°šå¯' : 
                                'âœ— ç™¼éŸ³æ¨¡ç³Šï¼Œéœ€åŠ å¼·è¨“ç·´'}
                          </div>
                      </div>
                  `;
              }

              resultDiv.innerHTML = html;
          }

          function generateReport() {
              const report = {
                  date: new Date().toISOString(),
                  patient: patientInfo,
                  results: testResults
              };

              historyData.push(report);
              saveHistoryData();

              // ç”Ÿæˆ PDF å ±å‘Š
              generatePDF();

              alert('âœ… è©•ä¼°å ±å‘Šå·²ç”Ÿæˆä¸¦å„²å­˜ï¼');
          }

          function generatePDF() {
              // ä½¿ç”¨ jsPDF ç”Ÿæˆå ±å‘Šï¼ˆéœ€è¦å¼•å…¥ jsPDF åº«ï¼‰
              alert('PDF å ±å‘ŠåŠŸèƒ½éœ€è¦å¼•å…¥ jsPDF åº«\n\nç›®å‰çµæœå·²å„²å­˜è‡³æ­·å²è¨˜éŒ„');
          }

          // è¨“ç·´åŠŸèƒ½
          function startTraining(trainingNumber) {
              const trainings = [
                  '',
                  'æœ€å¤§éŸ¿åº¦è¨“ç·´ï¼šæŒçºŒç™¼ã€Œå•Šã€éŸ³ 15 æ¬¡ï¼Œæ¯æ¬¡ 5 ç§’',
                  'éŸ³é«˜éšæ¢¯è¨“ç·´ï¼šDo-Re-Mi-Fa-Solï¼Œé‡è¤‡ 10 æ¬¡',
                  'åŠŸèƒ½æ€§èªå¥è¨“ç·´ï¼šã€Œä½ å¥½å—ï¼Ÿã€ã€Œè¬è¬ä½ ã€ç­‰æ—¥å¸¸ç”¨èª'
              ];

              alert('ğŸ¯ ' + trainings[trainingNumber] + '\n\næº–å‚™é–‹å§‹è¨“ç·´...');
              
              // é€™è£¡å¯ä»¥å¯¦ä½œè¨“ç·´æ¨¡å¼çš„äº’å‹•ä»‹é¢
              startTest(trainingNumber);
          }

          // æ­·å²è¨˜éŒ„
          function saveHistoryData() {
              localStorage.setItem('parkinsonVoiceHistory', JSON.stringify(historyData));
          }

          function loadHistoryData() {
              const saved = localStorage.getItem('parkinsonVoiceHistory');
              if (saved) {
                  historyData = JSON.parse(saved);
              }
          }

          function renderHistoryList() {
              const listDiv = document.getElementById('historyList');
              
              if (historyData.length === 0) {
                  listDiv.innerHTML = '<div class="alert alert-info">å°šç„¡æ­·å²è¨˜éŒ„</div>';
                  return;
              }

              let html = '';
              historyData.reverse().forEach((record, index) => {
                  const date = new Date(record.date).toLocaleDateString('zh-TW');
                  html += `
                      <div class="history-item">
                          <div class="history-date">ğŸ“… ${date}</div>
                          <div class="history-scores">
                              <div class="history-score">
                                  <div class="history-score-label">éŸ¿åº¦</div>
                                  <div class="history-score-value">${record.results.loudness?.avgDb || '-'} dB</div>
                              </div>
                              <div class="history-score">
                                  <div class="history-score-label">éŸ³é«˜ç¯„åœ</div>
                                  <div class="history-score-value">${record.results.pitchRange?.range || '-'} Hz</div>
                              </div>
                              <div class="history-score">
                                  <div class="history-score-label">MPT</div>
                                  <div class="history-score-value">${record.results.mpt?.duration || '-'} ç§’</div>
                              </div>
                          </div>
                      </div>
                  `;
              });

              listDiv.innerHTML = html;
          }

          function renderTrendChart() {
              const canvas = document.getElementById('trendChart');
              const ctx = canvas.getContext('2d');
              
              // ç°¡å–®çš„è¶¨å‹¢åœ–ç¹ªè£½
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              ctx.fillStyle = '#667eea';
              ctx.font = '14px Arial';
              ctx.textAlign = 'center';
              ctx.fillText('è¶¨å‹¢åœ–è¡¨ï¼ˆéœ€è¦å¤šæ¬¡è©•ä¼°æ•¸æ“šï¼‰', canvas.width / 2, canvas.height / 2);
          }
      </script>
  </body>
  </html>
