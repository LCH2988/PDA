<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>帕金森語音復健系統</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            font-size: 16px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 26px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header p {
            font-size: 15px;
            opacity: 0.95;
        }

        .content {
            padding: 20px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
        }

        .test-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }

        .test-card.active {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .test-card.completed {
            border-color: #28a745;
            background: #f0fff4;
        }

        .test-number {
            display: inline-block;
            width: 32px;
            height: 32px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 32px;
            font-weight: 700;
            font-size: 16px;
            margin-right: 10px;
        }

        .test-card.completed .test-number {
            background: #28a745;
        }

        .test-title {
            font-size: 18px;
            font-weight: 700;
            color: #212529;
            margin-bottom: 8px;
        }

        .test-desc {
            font-size: 15px;
            color: #6c757d;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .test-instruction {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.6;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .visual-feedback {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .volume-meter {
            width: 100%;
            height: 120px;
            background: #f8f9fa;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            margin: 15px 0;
        }

        .volume-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, #28a745, #ffc107, #dc3545);
            transition: height 0.1s;
            border-radius: 12px 12px 0 0;
        }

        .volume-labels {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            pointer-events: none;
        }

        .volume-label {
            font-size: 13px;
            font-weight: 600;
            color: #6c757d;
            text-align: right;
        }

        .pitch-display {
            font-size: 48px;
            font-weight: 700;
            color: #667eea;
            margin: 15px 0;
        }

        .pitch-target {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .timer-display {
            font-size: 56px;
            font-weight: 700;
            color: #667eea;
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
        }

        .progress-ring {
            width: 150px;
            height: 150px;
            margin: 20px auto;
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .result-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 15px;
            border: 2px solid #e9ecef;
        }

        .result-label {
            font-size: 16px;
            color: #6c757d;
        }

        .result-value {
            font-size: 28px;
            font-weight: 700;
            color: #212529;
        }

        .result-unit {
            font-size: 16px;
            color: #6c757d;
            margin-left: 5px;
        }

        .result-status {
            grid-column: 1 / -1;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 15px;
        }

        .status-good {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            border: 8px solid #e9ecef;
        }

        .score-circle.good {
            border-color: #28a745;
            background: #d4edda;
        }

        .score-circle.warning {
            border-color: #ffc107;
            background: #fff3cd;
        }

        .score-circle.danger {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .score-value {
            font-size: 36px;
            font-weight: 700;
        }

        .score-label {
            font-size: 14px;
            color: #6c757d;
        }

        .recommendation-box {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .recommendation-title {
            font-size: 16px;
            font-weight: 700;
            color: #0066cc;
            margin-bottom: 10px;
        }

        .recommendation-list {
            list-style: none;
            padding: 0;
        }

        .recommendation-list li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            font-size: 15px;
            line-height: 1.6;
        }

        .recommendation-list li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #0066cc;
            font-weight: 700;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 15px;
        }

        .tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .history-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border: 2px solid #e9ecef;
        }

        .history-date {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .history-scores {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .history-score {
            text-align: center;
        }

        .history-score-label {
            font-size: 12px;
            color: #6c757d;
        }

        .history-score-value {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            font-size: 15px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        select.input-field {
            appearance: none;
            background: white url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23495057" d="M6 9L1 4h10z"/></svg>') no-repeat right 12px center;
            padding-right: 35px;
        }

        .canvas-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
        }

        canvas {
            width: 100%;
            height: 150px;
            border-radius: 8px;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 15px;
            line-height: 1.6;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .recording {
            animation: pulse 1.5s infinite;
        }

        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 響應式設計 */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 22px;
            }

            .section-title {
                font-size: 18px;
            }

            .btn {
                font-size: 16px;
                padding: 14px;
            }

            .result-value {
                font-size: 24px;
            }

            .timer-display {
                font-size: 48px;
            }
        }

        /* 深色模式支援 */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎤 帕金森語音復健系統</h1>
            <p>LSVT LOUD® 訓練評估工具</p>
        </div>

        <div class="content">
            <!-- 標籤頁 -->
            <div class="tab-container">
                <div class="tab active" onclick="switchTab('assessment')">📊 評估</div>
                <div class="tab" onclick="switchTab('training')">🎯 訓練</div>
                <div class="tab" onclick="switchTab('history')">📈 歷史</div>
                <div class="tab" onclick="switchTab('info')">ℹ️ 資訊</div>
            </div>

            <!-- 評估頁面 -->
            <div id="assessment" class="tab-content active">
                <div class="section">
                    <div class="section-title">👤 患者資訊</div>
                    <div class="info-card">
                        <div class="info-label">姓名</div>
                        <div class="info-value" id="patientName">請先設定</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">評估日期</div>
                        <div class="info-value" id="assessmentDate">-</div>
                    </div>
                    <button class="btn btn-warning" onclick="showPatientModal()">
                        ⚙️ 設定患者資訊
                    </button>
                </div>

                <div class="section">
                    <div class="section-title">🔬 評估項目</div>
                    
                    <!-- 測試 1: 響度評估 -->
                    <div class="test-card" id="test1">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span class="test-number">1</span>
                            <span class="test-title">響度評估 (Loudness)</span>
                        </div>
                        <div class="test-desc">
                            評估發聲音量是否達到治療目標（85-90 dB）
                        </div>
                        <div class="test-instruction">
                            📋 <strong>測試說明：</strong><br>
                            請用最大音量持續發「啊」音 5 秒鐘，想像您在對街對面的人說話。
                        </div>
                        <button class="btn btn-primary" onclick="startTest(1)" id="testBtn1">
                            開始測試
                        </button>
                        <div id="test1Result" style="display: none; margin-top: 15px;"></div>
                    </div>

                    <!-- 測試 2: 音高範圍 -->
                    <div class="test-card" id="test2">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span class="test-number">2</span>
                            <span class="test-title">音高範圍 (Pitch Range)</span>
                        </div>
                        <div class="test-desc">
                            評估音高變化能力，帕金森患者常見音高單調問題
                        </div>
                        <div class="test-instruction">
                            📋 <strong>測試說明：</strong><br>
                            從最低音到最高音持續發「啊」音，像爬樓梯一樣逐漸提高音調。
                        </div>
                        <button class="btn btn-primary" onclick="startTest(2)" id="testBtn2" disabled>
                            開始測試
                        </button>
                        <div id="test2Result" style="display: none; margin-top: 15px;"></div>
                    </div>

                    <!-- 測試 3: 發聲持續時間 -->
                    <div class="test-card" id="test3">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span class="test-number">3</span>
                            <span class="test-title">最大發聲時間 (MPT)</span>
                        </div>
                        <div class="test-desc">
                            評估呼吸支持和聲帶閉合能力
                        </div>
                        <div class="test-instruction">
                            📋 <strong>測試說明：</strong><br>
                            深吸一口氣，用舒適的音量盡可能長時間持續發「啊」音。
                        </div>
                        <button class="btn btn-primary" onclick="startTest(3)" id="testBtn3" disabled>
                            開始測試
                        </button>
                        <div id="test3Result" style="display: none; margin-top: 15px;"></div>
                    </div>

                    <!-- 測試 4: 語音清晰度 -->
                    <div class="test-card" id="test4">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span class="test-number">4</span>
                            <span class="test-title">語音清晰度 (Articulation)</span>
                        </div>
                        <div class="test-desc">
                            評估發音清晰度和構音能力
                        </div>
                        <div class="test-instruction">
                            📋 <strong>測試說明：</strong><br>
                            請用響亮清晰的聲音說：「爸爸打電話」重複 5 次。
                        </div>
                        <button class="btn btn-primary" onclick="startTest(4)" id="testBtn4" disabled>
                            開始測試
                        </button>
                        <div id="test4Result" style="display: none; margin-top: 15px;"></div>
                    </div>
                </div>

                <button class="btn btn-success" onclick="generateReport()" id="reportBtn" disabled style="margin-top: 20px;">
                    📄 生成評估報告
                </button>
            </div>

            <!-- 訓練頁面 -->
            <div id="training" class="tab-content">
                <div class="section">
                    <div class="section-title">🎯 LSVT LOUD 訓練</div>
                    
                    <div class="alert alert-info">
                        <strong>💡 訓練原則：</strong><br>
                        • 每天練習 2 次，每次 30 分鐘<br>
                        • 連續 4 週，共 16 次療程<br>
                        • 重點：LOUD（大聲）、EFFORT（用力）
                    </div>

                    <div class="test-card">
                        <div class="test-title">練習 1: 最大響度訓練</div>
                        <div class="test-desc">持續發「啊」音，維持最大音量</div>
                        <button class="btn btn-primary" onclick="startTraining(1)">
                            開始練習
                        </button>
                    </div>

                    <div class="test-card">
                        <div class="test-title">練習 2: 音高階梯訓練</div>
                        <div class="test-desc">從低到高，5 個音階練習</div>
                        <button class="btn btn-primary" onclick="startTraining(2)">
                            開始練習
                        </button>
                    </div>

                    <div class="test-card">
                        <div class="test-title">練習 3: 功能性語句訓練</div>
                        <div class="test-desc">日常用語大聲練習</div>
                        <button class="btn btn-primary" onclick="startTraining(3)">
                            開始練習
                        </button>
                    </div>
                </div>
            </div>

            <!-- 歷史記錄頁面 -->
            <div id="history" class="tab-content">
                <div class="section">
                    <div class="section-title">📈 進步追蹤</div>
                    <div id="historyList">
                        <div class="alert alert-info">
                            尚無歷史記錄，完成評估後會自動儲存。
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">📊 趨勢圖表</div>
                    <div class="canvas-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 資訊頁面 -->
            <div id="info" class="tab-content">
                <div class="section">
                    <div class="section-title">ℹ️ 關於帕金森語音障礙</div>
                    
                    <div class="alert alert-warning">
                        <strong>⚠️ 常見症狀：</strong><br>
                        • 音量降低（低語症）<br>
                        • 音調單一缺乏變化<br>
                        • 說話速度過快或不規則<br>
                        • 發音不清晰<br>
                        • 聲音顫抖或沙啞
                    </div>

                    <div class="recommendation-box">
                        <div class="recommendation-title">🎯 LSVT LOUD 治療目標</div>
                        <ul class="recommendation-list">
                            <li>提高說話音量至正常水平</li>
                            <li>改善語音清晰度</li>
                            <li>增加音高變化範圍</li>
                            <li>提升呼吸支持能力</li>
                            <li>建立自我監控意識</li>
                        </ul>
                    </div>

                    <div class="recommendation-box" style="background: #fff3cd; border-color: #ffc107;">
                        <div class="recommendation-title" style="color: #856404;">💪 日常練習建議</div>
                        <ul class="recommendation-list">
                            <li>每天早晚各練習一次</li>
                            <li>對著鏡子練習，觀察表情</li>
                            <li>家人協助提供回饋</li>
                            <li>將練習融入日常對話</li>
                            <li>保持積極態度，持之以恆</li>
                        </ul>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">📞 聯絡資訊</div>
                    <div class="info-card">
                        <div class="info-label">語言治療師</div>
                        <div class="info-value">請洽詢您的醫療團隊</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">系統版本</div>
                        <div class="info-value">v2.0 (2025)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 患者資訊設定 Modal -->
    <div class="modal" id="patientModal">
        <div class="modal-content">
            <div class="modal-title">患者資訊設定</div>
            <div class="input-group">
                <label class="input-label">姓名</label>
                <input type="text" class="input-field" id="nameInput" placeholder="請輸入姓名">
            </div>
            <div class="input-group">
                <label class="input-label">性別</label>
                <select class="input-field" id="genderInput">
                    <option value="">請選擇</option>
                    <option value="male">男性</option>
                    <option value="female">女性</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">年齡</label>
                <input type="number" class="input-field" id="ageInput" placeholder="請輸入年齡" min="1" max="120">
              </div>
              <div class="input-group">
                  <label class="input-label">診斷日期</label>
                  <input type="date" class="input-field" id="diagnosisDate">
              </div>
              <div class="input-group">
                  <label class="input-label">Hoehn-Yahr 分期</label>
                  <select class="input-field" id="stageInput">
                      <option value="">請選擇</option>
                      <option value="1">第 1 期（單側症狀）</option>
                      <option value="2">第 2 期（雙側症狀）</option>
                      <option value="3">第 3 期（姿勢不穩）</option>
                      <option value="4">第 4 期（嚴重失能）</option>
                      <option value="5">第 5 期（臥床）</option>
                  </select>
              </div>
              <div class="btn-group">
                  <button class="btn btn-primary" onclick="savePatientInfo()">確定</button>
                  <button class="btn" style="background: #6c757d; color: white;" onclick="closePatientModal()">取消</button>
              </div>
          </div>
      </div>

      <!-- 測試執行 Modal -->
      <div class="modal" id="testModal">
          <div class="modal-content">
              <div class="modal-title" id="testModalTitle">測試進行中</div>
              
              <div class="visual-feedback">
                  <div class="timer-display" id="timerDisplay">0.0</div>
                  
                  <div class="volume-meter">
                      <div class="volume-bar" id="volumeBar"></div>
                      <div class="volume-labels">
                          <div class="volume-label">90 dB</div>
                          <div class="volume-label">70 dB</div>
                          <div class="volume-label">50 dB</div>
                      </div>
                  </div>

                  <div class="pitch-display" id="pitchDisplay">-- Hz</div>
                  <div class="pitch-target" id="pitchTarget">目標範圍：--</div>
              </div>

              <div class="canvas-container">
                  <canvas id="waveformCanvas"></canvas>
              </div>

              <div class="btn-group">
                  <button class="btn btn-danger" onclick="stopTest()" id="stopTestBtn">
                      ⏹️ 停止
                  </button>
                  <button class="btn" style="background: #6c757d; color: white;" onclick="cancelTest()">
                      ✖️ 取消
                  </button>
              </div>
          </div>
      </div>

      <script>
          // 全域變數
          let audioContext;
          let analyser;
          let microphone;
          let dataArray;
          let currentTest = 0;
          let testStartTime;
          let testTimer;
          let testResults = {
              loudness: null,
              pitchRange: null,
              mpt: null,
              articulation: null
          };
          let patientInfo = {
              name: '',
              gender: '',
              age: '',
              diagnosisDate: '',
              stage: ''
          };
          let historyData = [];

          // 初始化
          document.addEventListener('DOMContentLoaded', function() {
              loadHistoryData();
              updateAssessmentDate();
          });

          // 標籤頁切換
          function switchTab(tabName) {
              document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
              document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
              
              event.target.classList.add('active');
              document.getElementById(tabName).classList.add('active');

              if (tabName === 'history') {
                  renderHistoryList();
                  renderTrendChart();
              }
          }

          // 顯示患者資訊 Modal
          function showPatientModal() {
              document.getElementById('patientModal').classList.add('show');
              if (patientInfo.name) {
                  document.getElementById('nameInput').value = patientInfo.name;
                  document.getElementById('genderInput').value = patientInfo.gender;
                  document.getElementById('ageInput').value = patientInfo.age;
                  document.getElementById('diagnosisDate').value = patientInfo.diagnosisDate;
                  document.getElementById('stageInput').value = patientInfo.stage;
              }
          }

          function closePatientModal() {
              document.getElementById('patientModal').classList.remove('show');
          }

          function savePatientInfo() {
              const name = document.getElementById('nameInput').value.trim();
              const gender = document.getElementById('genderInput').value;
              const age = document.getElementById('ageInput').value;
              const diagnosisDate = document.getElementById('diagnosisDate').value;
              const stage = document.getElementById('stageInput').value;

              if (!name || !gender || !age) {
                  alert('請填寫必要資訊（姓名、性別、年齡）');
                  return;
              }

              patientInfo = { name, gender, age, diagnosisDate, stage };
              document.getElementById('patientName').textContent = name;
              closePatientModal();
          }

          function updateAssessmentDate() {
              const today = new Date().toLocaleDateString('zh-TW');
              document.getElementById('assessmentDate').textContent = today;
          }

          // 開始測試
          async function startTest(testNumber) {
              if (!patientInfo.name) {
                  alert('請先設定患者資訊');
                  showPatientModal();
                  return;
              }

              currentTest = testNumber;
              document.getElementById('testModal').classList.add('show');
              
              const titles = ['', '響度評估', '音高範圍評估', '最大發聲時間', '語音清晰度評估'];
              document.getElementById('testModalTitle').textContent = titles[testNumber];

              try {
                  audioContext = new (window.AudioContext || window.webkitAudioContext)();
                  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                  microphone = audioContext.createMediaStreamSource(stream);
                  analyser = audioContext.createAnalyser();
                  analyser.fftSize = 2048;
                  
                  microphone.connect(analyser);
                  dataArray = new Uint8Array(analyser.frequencyBinCount);

                  testStartTime = Date.now();
                  testTimer = setInterval(updateTestDisplay, 100);

                  document.getElementById('stopTestBtn').classList.add('recording');
              } catch (error) {
                  alert('無法存取麥克風，請確認權限設定');
                  closeTestModal();
              }
          }

          function updateTestDisplay() {
              const elapsed = (Date.now() - testStartTime) / 1000;
              document.getElementById('timerDisplay').textContent = elapsed.toFixed(1);

              analyser.getByteTimeDomainData(dataArray);
              analyser.getByteFrequencyData(dataArray);

              // 計算音量
              let sum = 0;
              for (let i = 0; i < dataArray.length; i++) {
                  const normalized = (dataArray[i] - 128) / 128;
                  sum += normalized * normalized;
              }
              const rms = Math.sqrt(sum / dataArray.length);
              const db = 20 * Math.log10(rms) + 90; // 粗略轉換為 dB

              // 更新音量條
              const volumePercent = Math.min(100, Math.max(0, (db - 40) * 2));
              document.getElementById('volumeBar').style.height = volumePercent + '%';

              // 計算基本頻率
              const frequency = detectPitch(dataArray, audioContext.sampleRate);
              if (frequency > 0) {
                  document.getElementById('pitchDisplay').textContent = Math.round(frequency) + ' Hz';
              }

              // 設定目標範圍
              if (currentTest === 1) {
                  document.getElementById('pitchTarget').textContent = '目標：85-90 dB';
              } else if (currentTest === 2) {
                  document.getElementById('pitchTarget').textContent = '音高範圍：最低到最高';
              }

              // 繪製波形
              drawWaveform(dataArray);

              // 自動停止條件
              if (currentTest === 1 && elapsed >= 5) {
                  stopTest();
              } else if (currentTest === 3 && elapsed >= 30) {
                  stopTest();
              } else if (currentTest === 4 && elapsed >= 15) {
                  stopTest();
              }
          }

          function detectPitch(dataArray, sampleRate) {
              // 自相關法檢測音高
              const SIZE = dataArray.length;
              const MAX_SAMPLES = Math.floor(SIZE / 2);
              let best_offset = -1;
              let best_correlation = 0;
              let rms = 0;

              for (let i = 0; i < SIZE; i++) {
                  const val = (dataArray[i] - 128) / 128;
                  rms += val * val;
              }
              rms = Math.sqrt(rms / SIZE);
              
              if (rms < 0.01) return -1;

              let lastCorrelation = 1;
              for (let offset = 1; offset < MAX_SAMPLES; offset++) {
                  let correlation = 0;
                  for (let i = 0; i < MAX_SAMPLES; i++) {
                      correlation += Math.abs(((dataArray[i] - 128) / 128) - ((dataArray[i + offset] - 128) / 128));
                  }
                  correlation = 1 - (correlation / MAX_SAMPLES);
                  
                  if (correlation > 0.9 && correlation > lastCorrelation) {
                      const foundGoodCorrelation = correlation > best_correlation;
                      if (foundGoodCorrelation) {
                          best_correlation = correlation;
                          best_offset = offset;
                      }
                  }
                  lastCorrelation = correlation;
              }

              if (best_offset === -1) return -1;
              return sampleRate / best_offset;
          }

          function drawWaveform(dataArray) {
              const canvas = document.getElementById('waveformCanvas');
              const ctx = canvas.getContext('2d');
              const width = canvas.width;
              const height = canvas.height;

              ctx.fillStyle = '#f8f9fa';
              ctx.fillRect(0, 0, width, height);

              ctx.lineWidth = 2;
              ctx.strokeStyle = '#667eea';
              ctx.beginPath();

              const sliceWidth = width / dataArray.length;
              let x = 0;

              for (let i = 0; i < dataArray.length; i++) {
                  const v = dataArray[i] / 128.0;
                  const y = v * height / 2;

                  if (i === 0) {
                      ctx.moveTo(x, y);
                  } else {
                      ctx.lineTo(x, y);
                  }

                  x += sliceWidth;
              }

              ctx.lineTo(width, height / 2);
              ctx.stroke();
          }

          function stopTest() {
              clearInterval(testTimer);
              
              if (microphone) {
                  microphone.mediaStream.getTracks().forEach(track => track.stop());
              }
              if (audioContext) {
                  audioContext.close();
              }

              const elapsed = (Date.now() - testStartTime) / 1000;
              
              // 儲存測試結果
              analyseTestResult(currentTest, elapsed);

              closeTestModal();
              displayTestResult(currentTest);
              
              // 啟用下一個測試
              if (currentTest < 4) {
                  document.getElementById('testBtn' + (currentTest + 1)).disabled = false;
              }
              
              // 標記完成
              document.getElementById('test' + currentTest).classList.add('completed');

              // 檢查是否全部完成
              if (currentTest === 4) {
                  document.getElementById('reportBtn').disabled = false;
              }
          }

          function cancelTest() {
              clearInterval(testTimer);
              if (microphone) {
                  microphone.mediaStream.getTracks().forEach(track => track.stop());
              }
              if (audioContext) {
                  audioContext.close();
              }
              closeTestModal();
          }

          function closeTestModal() {
              document.getElementById('testModal').classList.remove('show');
              document.getElementById('stopTestBtn').classList.remove('recording');
          }

          function analyseTestResult(testNumber, duration) {
              // 模擬分析結果（實際應用需要更精確的演算法）
              
              if (testNumber === 1) {
                  // 響度評估
                  const avgDb = 70 + Math.random() * 20; // 模擬 70-90 dB
                  testResults.loudness = {
                      avgDb: avgDb.toFixed(1),
                      peakDb: (avgDb + 5).toFixed(1),
                      duration: duration.toFixed(1),
                      status: avgDb >= 85 ? 'good' : avgDb >= 75 ? 'warning' : 'danger'
                  };
              } else if (testNumber === 2) {
                  // 音高範圍
                  const gender = patientInfo.gender;
                  const baseFreq = gender === 'male' ? 120 : 220;
                  const range = 50 + Math.random() * 100; // 模擬 50-150 Hz 範圍
                  testResults.pitchRange = {
                      minHz: (baseFreq - range/2).toFixed(0),
                      maxHz: (baseFreq + range/2).toFixed(0),
                      range: range.toFixed(0),
                      status: range >= 100 ? 'good' : range >= 70 ? 'warning' : 'danger'
                  };
              } else if (testNumber === 3) {
                  // 最大發聲時間
                  testResults.mpt = {
                      duration: duration.toFixed(1),
                      status: duration >= 15 ? 'good' : duration >= 10 ? 'warning' : 'danger'
                  };
              } else if (testNumber === 4) {
                  // 語音清晰度
                  const score = 60 + Math.random() * 40; // 模擬 60-100 分
                  testResults.articulation = {
                      score: score.toFixed(0),
                      status: score >= 85 ? 'good' : score >= 70 ? 'warning' : 'danger'
                  };
              }
          }

          function displayTestResult(testNumber) {
              const resultDiv = document.getElementById('test' + testNumber + 'Result');
              resultDiv.style.display = 'block';
              resultDiv.classList.add('fade-in');

              let html = '';

              if (testNumber === 1) {
                  const result = testResults.loudness;
                  html = `
                      <div class="result-card">
                          <div>
                              <div class="result-label">平均響度</div>
                              <div class="result-value">${result.avgDb}<span class="result-unit">dB</span></div>
                          </div>
                          <div class="score-circle ${result.status}">
                              <div class="score-value">${result.avgDb}</div>
                              <div class="score-label">dB</div>
                          </div>
                          <div class="result-status status-${result.status}">
                              ${result.status === 'good' ? '✓ 達到目標範圍 (85-90 dB)' : 
                                result.status === 'warning' ? '⚠️ 接近目標，需加強' : 
                                '✗ 未達標準，需積極訓練'}
                          </div>
                      </div>
                  `;
              } else if (testNumber === 2) {
                  const result = testResults.pitchRange;
                  html = `
                      <div class="result-card">
                          <div>
                              <div class="result-label">音高範圍</div>
                              <div class="result-value">${result.range}<span class="result-unit">Hz</span></div>
                          </div>
                          <div>
                              <div class="result-label">最低 → 最高</div>
                              <div style="font-size: 16px; color: #667eea; font-weight: 600;">
                                  ${result.minHz} Hz → ${result.maxHz} Hz
                              </div>
                          </div>
                          <div class="result-status status-${result.status}">
                              ${result.status === 'good' ? '✓ 音高變化良好' : 
                                result.status === 'warning' ? '⚠️ 音高變化受限' : 
                                '✗ 音高單調，需加強訓練'}
                          </div>
                      </div>
                  `;
              } else if (testNumber === 3) {
                  const result = testResults.mpt;
                  html = `
                      <div class="result-card">
                          <div>
                              <div class="result-label">發聲時間</div>
                              <div class="result-value">${result.duration}<span class="result-unit">秒</span></div>
                          </div>
                          <div class="score-circle ${result.status}">
                              <div class="score-value">${result.duration}</div>
                              <div class="score-label">秒</div>
                          </div>
                          <div class="result-status status-${result.status}">
                              ${result.status === 'good' ? '✓ 呼吸支持良好 (≥15秒)' : 
                                result.status === 'warning' ? '⚠️ 呼吸支持尚可 (10-15秒)' : 
                                '✗ 呼吸支持不足 (<10秒)'}
                          </div>
                      </div>
                  `;
              } else if (testNumber === 4) {
                  const result = testResults.articulation;
                  html = `
                      <div class="result-card">
                          <div>
                              <div class="result-label">清晰度評分</div>
                              <div class="result-value">${result.score}<span class="result-unit">分</span></div>
                          </div>
                          <div class="score-circle ${result.status}">
                              <div class="score-value">${result.score}</div>
                              <div class="score-label">分</div>
                          </div>
                          <div class="result-status status-${result.status}">
                              ${result.status === 'good' ? '✓ 發音清晰度良好' : 
                                result.status === 'warning' ? '⚠️ 發音清晰度尚可' : 
                                '✗ 發音模糊，需加強訓練'}
                          </div>
                      </div>
                  `;
              }

              resultDiv.innerHTML = html;
          }

          function generateReport() {
              const report = {
                  date: new Date().toISOString(),
                  patient: patientInfo,
                  results: testResults
              };

              historyData.push(report);
              saveHistoryData();

              // 生成 PDF 報告
              generatePDF();

              alert('✅ 評估報告已生成並儲存！');
          }

          function generatePDF() {
              // 使用 jsPDF 生成報告（需要引入 jsPDF 庫）
              alert('PDF 報告功能需要引入 jsPDF 庫\n\n目前結果已儲存至歷史記錄');
          }

          // 訓練功能
          function startTraining(trainingNumber) {
              const trainings = [
                  '',
                  '最大響度訓練：持續發「啊」音 15 次，每次 5 秒',
                  '音高階梯訓練：Do-Re-Mi-Fa-Sol，重複 10 次',
                  '功能性語句訓練：「你好嗎？」「謝謝你」等日常用語'
              ];

              alert('🎯 ' + trainings[trainingNumber] + '\n\n準備開始訓練...');
              
              // 這裡可以實作訓練模式的互動介面
              startTest(trainingNumber);
          }

          // 歷史記錄
          function saveHistoryData() {
              localStorage.setItem('parkinsonVoiceHistory', JSON.stringify(historyData));
          }

          function loadHistoryData() {
              const saved = localStorage.getItem('parkinsonVoiceHistory');
              if (saved) {
                  historyData = JSON.parse(saved);
              }
          }

          function renderHistoryList() {
              const listDiv = document.getElementById('historyList');
              
              if (historyData.length === 0) {
                  listDiv.innerHTML = '<div class="alert alert-info">尚無歷史記錄</div>';
                  return;
              }

              let html = '';
              historyData.reverse().forEach((record, index) => {
                  const date = new Date(record.date).toLocaleDateString('zh-TW');
                  html += `
                      <div class="history-item">
                          <div class="history-date">📅 ${date}</div>
                          <div class="history-scores">
                              <div class="history-score">
                                  <div class="history-score-label">響度</div>
                                  <div class="history-score-value">${record.results.loudness?.avgDb || '-'} dB</div>
                              </div>
                              <div class="history-score">
                                  <div class="history-score-label">音高範圍</div>
                                  <div class="history-score-value">${record.results.pitchRange?.range || '-'} Hz</div>
                              </div>
                              <div class="history-score">
                                  <div class="history-score-label">MPT</div>
                                  <div class="history-score-value">${record.results.mpt?.duration || '-'} 秒</div>
                              </div>
                          </div>
                      </div>
                  `;
              });

              listDiv.innerHTML = html;
          }

          function renderTrendChart() {
              const canvas = document.getElementById('trendChart');
              const ctx = canvas.getContext('2d');
              
              // 簡單的趨勢圖繪製
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              ctx.fillStyle = '#667eea';
              ctx.font = '14px Arial';
              ctx.textAlign = 'center';
              ctx.fillText('趨勢圖表（需要多次評估數據）', canvas.width / 2, canvas.height / 2);
          }
      </script>
  </body>
  </html>
