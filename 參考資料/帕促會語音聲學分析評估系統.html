<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>帕金森病語音聲學分析評估系統</title>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
        font-size: 16px;
        line-height: 1.6;
        color: #2d3748;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .header {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        text-align: center;
    }
    
    .header h1 {
        color: #4a5568;
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 700;
    }
    
    .header .subtitle {
        color: #718096;
        font-size: 1.2em;
        font-weight: 500;
    }
    
    .section-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .section-title {
        color: #667eea;
        font-size: 2em;
        margin-bottom: 20px;
        font-weight: 700;
        border-left: 5px solid #667eea;
        padding-left: 15px;
    }
    
    /* 錄音控制區 */
    .recording-section {
        background: linear-gradient(135deg, #fef5e7 0%, #fdebd0 100%);
        border: 3px solid #f39c12;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
    }
    
    .recording-controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
    }
    
    .record-btn-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .record-btn {
        padding: 20px 40px;
        font-size: 1.3em;
        font-weight: 700;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .record-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    
    .record-btn:active {
        transform: translateY(-1px);
    }
    
    .record-btn.start {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
    }
    
    .record-btn.stop {
        background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        color: white;
        display: none;
    }
    
    .record-btn.analyze {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        color: white;
        display: none;
    }
    
    .record-btn.upload {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
    }
    
    .recording-status {
        text-align: center;
        font-size: 1.3em;
        font-weight: 600;
        color: #2c3e50;
        min-height: 30px;
    }
    
    .recording-timer {
        font-size: 2.5em;
        font-weight: 700;
        color: #e74c3c;
        display: none;
    }
    
    .waveform-container {
        width: 100%;
        height: 150px;
        background: white;
        border-radius: 10px;
        margin-top: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #f39c12;
        overflow: hidden;
    }
    
    .waveform-canvas {
        width: 100%;
        height: 100%;
    }
    
    .audio-player {
        width: 100%;
        margin-top: 20px;
        display: none;
    }
    
    .file-upload-area {
        border: 3px dashed #3498db;
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
    }
    
    .file-upload-area:hover {
        background: #ebf5fb;
        border-color: #2980b9;
    }
    
    .file-upload-area.dragover {
        background: #d6eaf8;
        border-color: #2980b9;
    }
    
    /* 分析結果區 */
    .analysis-results {
        display: none;
        animation: fadeIn 0.5s ease;
    }
    
    .analysis-results.show {
        display: block;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .result-card {
        background: linear-gradient(135deg, #e8f4f8 0%, #d4e9f2 100%);
        border: 2px solid #3498db;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(52, 152, 219, 0.2);
    }
    
    .result-card-title {
        font-size: 1.1em;
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .result-card-value {
        font-size: 2.5em;
        font-weight: 700;
        color: #3498db;
        margin: 10px 0;
    }
    
    .result-card-status {
        font-size: 1em;
        font-weight: 600;
        padding: 5px 15px;
        border-radius: 20px;
        display: inline-block;
    }
    
    .status-excellent { 
        background: #d5f4e6;
        color: #27ae60;
    }
    
    .status-good { 
        background: #d6eaf8;
        color: #2980b9;
    }
    
    .status-fair { 
        background: #fef5e7;
        color: #f39c12;
    }
    
    .status-poor { 
        background: #fadbd8;
        color: #e74c3c;
    }
    
    /* 報告區域 */
    .report-section {
        background: white;
        border-radius: 20px;
        padding: 40px;
        margin-top: 30px;
        display: none;
    }
    
    .report-section.show {
        display: block;
    }
    
    .report-header {
        text-align: center;
        border-bottom: 3px solid #667eea;
        padding-bottom: 20px;
        margin-bottom: 30px;
    }
    
    .report-title {
        font-size: 2.5em;
        color: #2c3e50;
        font-weight: 700;
        margin-bottom: 10px;
    }
    
    .report-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
    }
    
    .report-meta-item {
        display: flex;
        flex-direction: column;
    }
    
    .report-meta-label {
        font-size: 0.9em;
        color: #7f8c8d;
        margin-bottom: 5px;
    }
    
    .report-meta-value {
        font-size: 1.1em;
        color: #2c3e50;
        font-weight: 600;
    }
    
    .report-score-summary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        margin: 30px 0;
    }
    
    .report-total-score {
        font-size: 5em;
        font-weight: 700;
        margin: 20px 0;
    }
    
    .report-score-label {
        font-size: 1.8em;
        font-weight: 600;
    }
    
    .report-details-table {
        width: 100%;
        border-collapse: collapse;
        margin: 30px 0;
    }
    
    .report-details-table th {
        background: #34495e;
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
    }
    
    .report-details-table td {
        padding: 15px;
        border-bottom: 1px solid #ecf0f1;
    }
    
    .report-details-table tr:hover {
        background: #f8f9fa;
    }
    
    .report-chart {
        margin: 30px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
    }
    
    .report-recommendations {
        background: #fff3cd;
        border-left: 5px solid #ffc107;
        padding: 20px;
        margin: 30px 0;
        border-radius: 5px;
    }
    
    .report-recommendations h3 {
        color: #856404;
        margin-bottom: 15px;
    }
    
    .report-recommendations ul {
        list-style: none;
        padding-left: 0;
    }
    
    .report-recommendations li {
        padding: 10px 0;
        color: #856404;
        line-height: 1.8;
    }
    
    .report-recommendations li:before {
        content: "✓ ";
        font-weight: 700;
        margin-right: 10px;
    }
    
    .report-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
        flex-wrap: wrap;
    }
    
    .action-btn {
        padding: 15px 30px;
        font-size: 1.2em;
        font-weight: 600;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .action-btn.print {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
    }
    
    .action-btn.download {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        color: white;
    }
    
    .action-btn.email {
        background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
        color: white;
    }
    
    .action-btn.new {
        background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        color: white;
    }
    
    /* 列印樣式 */
    @media print {
        body {
            background: white;
            padding: 0;
        }
        
        .container {
            max-width: 100%;
        }
        
        .section-card:not(.report-section) {
            display: none !important;
        }
        
        .report-actions {
            display: none !important;
        }
        
        .report-section {
            box-shadow: none;
            page-break-after: always;
        }
        
        .report-score-summary {
            break-inside: avoid;
        }
        
        .report-details-table {
            break-inside: avoid;
        }
    }
    
    /* 圖表容器 */
    .chart-container {
        width: 100%;
        height: 400px;
        margin: 20px 0;
    }
    
    .progress-bar {
        width: 100%;
        height: 30px;
        background: #ecf0f1;
        border-radius: 15px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }
    
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .hidden {
        display: none !important;
    }
    
    @media (max-width: 768px) {
        .header h1 {
            font-size: 1.8em;
        }
        
        .section-title {
            font-size: 1.5em;
        }
        
        .record-btn {
            padding: 15px 25px;
            font-size: 1.1em;
        }
        
        .result-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>🎤 帕金森病語音聲學分析評估系統</h1>
        <div class="subtitle">即時錄音分析 · 智能評估 · 專業報告</div>
    </div>
    
    <!-- 即時錄音分析區 -->
    <div class="section-card">
        <h2 class="section-title">🎙️ 即時錄音與音檔分析</h2>
        
        <div class="recording-section">
            <div class="recording-controls">
                <div class="recording-status" id="recordingStatus">請選擇錄音或上傳音檔進行分析</div>
                <div class="recording-timer" id="recordingTimer">00:00</div>
                
                <div class="record-btn-group">
                    <button class="record-btn start" id="startRecordBtn" onclick="startRecording()">
                        <span>🔴</span> 開始錄音
                    </button>
                    <button class="record-btn stop" id="stopRecordBtn" onclick="stopRecording()">
                        <span>⏹️</span> 停止錄音
                    </button>
                    <button class="record-btn analyze" id="analyzeBtn" onclick="analyzeAudio()">
                        <span>🔬</span> 開始分析
                    </button>
                </div>
                
                <div class="waveform-container">
                    <canvas class="waveform-canvas" id="waveformCanvas"></canvas>
                </div>
                
                <audio class="audio-player" id="audioPlayer" controls></audio>
                
                <div style="width: 100%; max-width: 600px;">
                    <h3 style="text-align: center; color: #2c3e50; margin: 20px 0;">或上傳音檔</h3>
                    <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 3em; margin-bottom: 10px;">📁</div>
                        <div style="font-size: 1.2em; font-weight: 600; color: #2c3e50;">點擊選擇音檔或拖曳至此</div>
                        <div style="color: #7f8c8d; margin-top: 10px;">支援格式：WAV, MP3, M4A</div>
                        <input type="file" id="fileInput" accept="audio/*" style="display: none;" onchange="handleFileUpload(event)">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="loading-spinner" id="loadingSpinner"></div>
    </div>
    
    <!-- 分析結果區 -->
    <div class="section-card analysis-results" id="analysisResults">
        <h2 class="section-title">📊 聲學分析結果</h2>
        
        <div class="result-grid" id="resultGrid">
            <!-- 結果卡片將由 JavaScript 動態生成 -->
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
            <button class="action-btn print" onclick="generateReport()">
                <span>📄</span> 生成完整報告
            </button>
        </div>
    </div>
    
    <!-- 完整評估報告 -->
    <div class="section-card report-section" id="reportSection">
        <div class="report-header">
            <div class="report-title">🏥 帕金森病語音評估報告</div>
            <div style="color: #7f8c8d; font-size: 1.1em; margin-top: 10px;">Parkinson's Disease Speech Assessment Report</div>
        </div>
        
        <div class="report-meta" id="reportMeta">
            <div class="report-meta-item">
                <div class="report-meta-label">報告編號</div>
                <div class="report-meta-value" id="reportId">-</div>
            </div>
            <div class="report-meta-item">
                <div class="report-meta-label">評估日期</div>
                <div class="report-meta-value" id="reportDate">-</div>
            </div>
            <div class="report-meta-item">
                <div class="report-meta-label">評估時間</div>
                <div class="report-meta-value" id="reportTime">-</div>
            </div>
            <div class="report-meta-item">
                <div class="report-meta-label">錄音時長</div>
                <div class="report-meta-value" id="reportDuration">-</div>
            </div>
        </div>
        
        <div class="report-score-summary">
            <div class="report-score-label">總體評分</div>
            <div class="report-total-score" id="reportTotalScore">0</div>
            <div class="report-score-label" id="reportScoreLevel">-</div>
            <div style="margin-top: 20px; font-size: 1.2em;" id="reportScoreDescription">-</div>
        </div>
        
        <h3 style="color: #2c3e50; font-size: 1.8em; margin: 30px 0 20px 0; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;">
            📈 詳細評估數據
        </h3>
        
        <table class="report-details-table">
            <thead>
                <tr>
                    <th style="width: 5%;">序號</th>
                    <th style="width: 25%;">評估項目</th>
                    <th style="width: 20%;">測量值</th>
                    <th style="width: 15%;">正常範圍</th>
                    <th style="width: 15%;">得分</th>
                    <th style="width: 20%;">評估</th>
                </tr>
            </thead>
            <tbody id="reportDetailsTable">
                <!-- 由 JavaScript 動態生成 -->
            </tbody>
        </table>
        
        <h3 style="color: #2c3e50; font-size: 1.8em; margin: 30px 0 20px 0; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;">
            📊 評分視覺化
        </h3>
        
        <div class="report-chart">
            <canvas id="reportChart" width="800" height="400"></canvas>
        </div>
        
        <div class="report-recommendations" id="reportRecommendations">
            <h3>💡 專業建議與訓練方向</h3>
            <ul id="reportRecommendationsList">
                <!-- 由 JavaScript 動態生成 -->
            </ul>
        </div>
        
        <div style="margin-top: 30px; padding: 20px; background: #e8f8f5; border-radius: 10px; border-left: 5px solid #27ae60;">
            <h4 style="color: #27ae60; margin-bottom: 10px;">📝 評估說明</h4>
            <p style="color: #2c3e50; line-height: 1.8;">
                本報告採用多維度聲學分析技術，評估語音的基頻、音量、音質、穩定性、構音清晰度等指標。
                評分系統基於國際臨床研究標準，總分100分，分為優秀（90-100）、良好（75-89）、尚可（60-74）、需加強（<60）四個等級。
                建議定期（每2-4週）進行評估，追蹤訓練效果。
            </p>
        </div>
        
        <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 10px; border-left: 5px solid #ffc107;">
            <h4 style="color: #856404; margin-bottom: 10px;">⚠️ 重要提示</h4>
            <p style="color: #856404; line-height: 1.8;">
                本評估系統僅供參考，不能替代專業醫療診斷。如有疑問或分數持續下降，請諮詢語言治療師或神經科醫師。
                錄音時請保持環境安靜，使用相同設備以確保數據可比性。建議在藥物效果最佳時段（ON狀態）進行評估。
            </p>
        </div>
        
        <div class="report-actions">
            <button class="action-btn print" onclick="printReport()">
                <span>🖨️</span> 列印報告
            </button>
            <button class="action-btn download" onclick="downloadReport()">
                <span>💾</span> 下載PDF
            </button>
            <button class="action-btn email" onclick="emailReport()">
                <span>📧</span> 郵件發送
            </button>
            <button class="action-btn new" onclick="newAssessment()">
                <span>🔄</span> 新評估
            </button>
        </div>
    </div>
</div>

<script>
// 全局變量
let mediaRecorder;
let audioChunks = [];
let audioBlob;
let audioContext;
let analyser;
let dataArray;
let animationId;
let recordingStartTime;
let timerInterval;
let currentAnalysisData = {};

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    setupFileUpload();
    initWaveform();
});

// 設置文件上傳
function setupFileUpload() {
    const uploadArea = document.getElementById('fileUploadArea');
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });
}

// 初始化波形顯示
function initWaveform() {
    const canvas = document.getElementById('waveformCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    
    ctx.fillStyle = '#ecf0f1';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#7f8c8d';
    ctx.font = '16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('等待錄音或上傳音檔...', canvas.width / 2, canvas.height / 2);
}

// 開始錄音
async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = audioUrl;
            audioPlayer.style.display = 'block';
            
            document.getElementById('analyzeBtn').style.display = 'flex';
        };
        
        mediaRecorder.start();
        
        // 設置音頻可視化
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        source.connect(analyser);
        
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        
        // 更新UI
        document.getElementById('startRecordBtn').style.display = 'none';
        document.getElementById('stopRecordBtn').style.display = 'flex';
        document.getElementById('recordingStatus').textContent = '🔴 錄音中...';
        document.getElementById('recordingTimer').style.display = 'block';
        
        // 開始計時
        recordingStartTime = Date.now();
        timerInterval = setInterval(updateTimer, 100);
        
        // 開始繪製波形
        drawWaveform();
        
    } catch (error) {
        alert('無法訪問麥克風，請確認已授予權限。');
        console.error('錄音錯誤:', error);
    }
}

// 停止錄音
function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
          mediaRecorder.stream.getTracks().forEach(track => track.stop());
          
          clearInterval(timerInterval);
          cancelAnimationFrame(animationId);
          
          document.getElementById('startRecordBtn').style.display = 'flex';
          document.getElementById('stopRecordBtn').style.display = 'none';
          document.getElementById('recordingStatus').textContent = '✅ 錄音完成，可以開始分析';
          document.getElementById('recordingTimer').style.display = 'none';
      }
  }
  
  // 更新計時器
  function updateTimer() {
      const elapsed = Date.now() - recordingStartTime;
      const seconds = Math.floor(elapsed / 1000);
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      
      document.getElementById('recordingTimer').textContent = 
          `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
  }
  
  // 繪製波形
  function drawWaveform() {
      const canvas = document.getElementById('waveformCanvas');
      const ctx = canvas.getContext('2d');
      
      animationId = requestAnimationFrame(drawWaveform);
      
      analyser.getByteTimeDomainData(dataArray);
      
      ctx.fillStyle = 'rgb(255, 255, 255)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'rgb(231, 76, 60)';
      ctx.beginPath();
      
      const sliceWidth = canvas.width / dataArray.length;
      let x = 0;
      
      for (let i = 0; i < dataArray.length; i++) {
          const v = dataArray[i] / 128.0;
          const y = v * canvas.height / 2;
          
          if (i === 0) {
              ctx.moveTo(x, y);
          } else {
              ctx.lineTo(x, y);
          }
          
          x += sliceWidth;
      }
      
      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.stroke();
  }
  
  // 處理文件上傳
  function handleFileUpload(event) {
      const file = event.target.files[0];
      handleFile(file);
  }
  
  function handleFile(file) {
      if (!file) return;
      
      if (!file.type.startsWith('audio/')) {
          alert('請上傳音頻文件！');
          return;
      }
      
      audioBlob = file;
      const audioUrl = URL.createObjectURL(file);
      const audioPlayer = document.getElementById('audioPlayer');
      audioPlayer.src = audioUrl;
      audioPlayer.style.display = 'block';
      
      document.getElementById('recordingStatus').textContent = `✅ 已上傳：${file.name}`;
      document.getElementById('analyzeBtn').style.display = 'flex';
      
      // 繪製靜態波形提示
      const canvas = document.getElementById('waveformCanvas');
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#d5f4e6';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#27ae60';
      ctx.font = '16px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('✓ 音檔已載入，點擊「開始分析」', canvas.width / 2, canvas.height / 2);
  }
  
  // 分析音頻
  async function analyzeAudio() {
      if (!audioBlob) {
          alert('請先錄音或上傳音檔！');
          return;
      }
      
      document.getElementById('loadingSpinner').style.display = 'block';
      document.getElementById('recordingStatus').textContent = '🔬 正在分析音頻...';
      
      // 模擬音頻分析過程（實際應用中需要調用真實的音頻分析API）
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // 生成模擬分析數據（實際應用中應該是真實分析結果）
      currentAnalysisData = generateMockAnalysisData();
      
      document.getElementById('loadingSpinner').style.display = 'none';
      document.getElementById('recordingStatus').textContent = '✅ 分析完成！';
      
      displayAnalysisResults(currentAnalysisData);
  }
  
  // 生成模擬分析數據
  function generateMockAnalysisData() {
      return {
          f0: {
              value: (Math.random() * 100 + 100).toFixed(2),
              unit: 'Hz',
              normalRange: '85-255 Hz',
              score: 0
          },
          intensity: {
              value: (Math.random() * 15 + 60).toFixed(2),
              unit: 'dB',
              normalRange: '55-75 dB',
              score: 0
          },
          hnr: {
              value: (Math.random() * 15 + 10).toFixed(2),
              unit: 'dB',
              normalRange: '≥15 dB',
              score: 0
          },
          jitter: {
              value: (Math.random() * 2 + 0.3).toFixed(3),
              unit: '%',
              normalRange: '≤1.04%',
              score: 0
          },
          shimmer: {
              value: (Math.random() * 4 + 1.5).toFixed(3),
              unit: '%',
              normalRange: '≤3.81%',
              score: 0
          },
          f1: {
              value: (Math.random() * 300 + 600).toFixed(0),
              unit: 'Hz',
              normalRange: '600-900 Hz',
              score: 0
          },
          f2: {
              value: (Math.random() * 400 + 1000).toFixed(0),
              unit: 'Hz',
              normalRange: '1000-1400 Hz',
              score: 0
          },
          speechRate: {
              value: (Math.random() * 100 + 150).toFixed(0),
              unit: '音節/分',
              normalRange: '180-220',
              score: 0
          },
          pause: {
              value: (Math.random() * 3 + 2).toFixed(0),
              unit: '分',
              normalRange: '3-5分',
              score: 0
          }
      };
  }
  
  // 顯示分析結果
  function displayAnalysisResults(data) {
      // 計算各項分數
      data.f0.score = calculateF0Score(parseFloat(data.f0.value));
      data.intensity.score = calculateIntensityScore(parseFloat(data.intensity.value));
      data.hnr.score = calculateHNRScore(parseFloat(data.hnr.value));
      data.jitter.score = calculateJitterScore(parseFloat(data.jitter.value));
      data.shimmer.score = calculateShimmerScore(parseFloat(data.shimmer.value));
      data.f1.score = calculateF1Score(parseFloat(data.f1.value));
      data.f2.score = calculateF2Score(parseFloat(data.f2.value));
      data.speechRate.score = calculateSpeechRateScore(parseFloat(data.speechRate.value));
      data.pause.score = parseFloat(data.pause.value);
      
      const resultGrid = document.getElementById('resultGrid');
      resultGrid.innerHTML = '';
      
      const parameters = [
          { key: 'f0', name: '基頻 F0', max: 10 },
          { key: 'intensity', name: '音量強度', max: 10 },
          { key: 'hnr', name: 'HNR 諧噪比', max: 15 },
          { key: 'jitter', name: 'Jitter', max: 15 },
          { key: 'shimmer', name: 'Shimmer', max: 15 },
          { key: 'f1', name: '共振峰 F1', max: 10 },
          { key: 'f2', name: '共振峰 F2', max: 10 },
          { key: 'speechRate', name: '語速', max: 10 },
          { key: 'pause', name: '停頓模式', max: 5 }
      ];
      
      parameters.forEach(param => {
          const item = data[param.key];
          const percentage = (item.score / param.max) * 100;
          const status = getStatusClass(percentage);
          const statusText = getStatusText(percentage);
          
          const card = document.createElement('div');
          card.className = 'result-card';
          card.innerHTML = `
              <div class="result-card-title">${param.name}</div>
              <div class="result-card-value">${item.value} ${item.unit}</div>
              <div style="margin: 10px 0;">
                  <div class="progress-bar">
                      <div class="progress-fill" style="width: ${percentage}%">
                          ${item.score.toFixed(1)}/${param.max}
                      </div>
                  </div>
              </div>
              <div class="result-card-status ${status}">${statusText}</div>
              <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 10px;">
                  正常範圍: ${item.normalRange}
              </div>
          `;
          resultGrid.appendChild(card);
      });
      
      document.getElementById('analysisResults').classList.add('show');
      document.getElementById('analysisResults').scrollIntoView({ behavior: 'smooth' });
  }
  
  // 評分函數
  function calculateF0Score(f0) {
      if ((f0 >= 100 && f0 <= 150) || (f0 >= 180 && f0 <= 220)) return 10;
      if ((f0 >= 85 && f0 < 100) || (f0 > 150 && f0 <= 180) || (f0 > 220 && f0 <= 255)) return 7;
      if ((f0 >= 70 && f0 < 85) || (f0 > 255 && f0 <= 280)) return 4;
      return 2;
  }
  
  function calculateIntensityScore(intensity) {
      if (intensity >= 65 && intensity <= 75) return 10;
      if (intensity >= 60 && intensity < 65) return 7;
      if (intensity >= 55 && intensity < 60) return 5;
      return 2;
  }
  
  function calculateHNRScore(hnr) {
      if (hnr >= 20) return 15;
      if (hnr >= 15) return 12;
      if (hnr >= 10) return 8;
      return 4;
  }
  
  function calculateJitterScore(jitter) {
      if (jitter <= 0.5) return 15;
      if (jitter <= 1.04) return 12;
      if (jitter <= 2.0) return 8;
      return 4;
  }
  
  function calculateShimmerScore(shimmer) {
      if (shimmer <= 2.0) return 15;
      if (shimmer <= 3.81) return 12;
      if (shimmer <= 6.0) return 8;
      return 4;
  }
  
  function calculateF1Score(f1) {
      if (f1 >= 600 && f1 <= 900) return 10;
      if ((f1 >= 480 && f1 < 600) || (f1 > 900 && f1 <= 1080)) return 7;
      if ((f1 >= 420 && f1 < 480) || (f1 > 1080 && f1 <= 1170)) return 4;
      return 2;
  }
  
  function calculateF2Score(f2) {
      if (f2 >= 1000 && f2 <= 1400) return 10;
      if ((f2 >= 800 && f2 < 1000) || (f2 > 1400 && f2 <= 1680)) return 7;
      if ((f2 >= 700 && f2 < 800) || (f2 > 1680 && f2 <= 1820)) return 4;
      return 2;
  }
  
  function calculateSpeechRateScore(rate) {
      if (rate >= 180 && rate <= 220) return 10;
      if ((rate >= 150 && rate < 180) || (rate > 220 && rate <= 250)) return 7;
      if ((rate >= 120 && rate < 150) || (rate > 250 && rate <= 280)) return 4;
      return 2;
  }
  
  function getStatusClass(percentage) {
      if (percentage >= 85) return 'status-excellent';
      if (percentage >= 70) return 'status-good';
      if (percentage >= 50) return 'status-fair';
      return 'status-poor';
  }
  
  function getStatusText(percentage) {
      if (percentage >= 85) return '優秀';
      if (percentage >= 70) return '良好';
      if (percentage >= 50) return '尚可';
      return '需加強';
  }
  
  // 生成完整報告
  function generateReport() {
      if (!currentAnalysisData || Object.keys(currentAnalysisData).length === 0) {
          alert('請先進行音頻分析！');
          return;
      }
      
      const now = new Date();
      const reportId = 'PD-' + now.getFullYear() + (now.getMonth() + 1).toString().padStart(2, '0') + 
                       now.getDate().toString().padStart(2, '0') + '-' + 
                       Math.floor(Math.random() * 10000).toString().padStart(4, '0');
      
      document.getElementById('reportId').textContent = reportId;
      document.getElementById('reportDate').textContent = now.toLocaleDateString('zh-TW');
      document.getElementById('reportTime').textContent = now.toLocaleTimeString('zh-TW');
      
      const audioPlayer = document.getElementById('audioPlayer');
      const duration = audioPlayer.duration || 0;
      document.getElementById('reportDuration').textContent = 
          `${Math.floor(duration / 60)}分${Math.floor(duration % 60)}秒`;
      
      // 計算總分
      const totalScore = Object.values(currentAnalysisData).reduce((sum, item) => sum + item.score, 0);
      document.getElementById('reportTotalScore').textContent = totalScore.toFixed(1);
      
      let scoreLevel = '';
      let scoreDescription = '';
      if (totalScore >= 90) {
          scoreLevel = '優秀';
          scoreDescription = '語音功能正常或接近正常，請繼續保持良好的語音習慣';
      } else if (totalScore >= 75) {
          scoreLevel = '良好';
          scoreDescription = '輕度語音障礙，日常溝通無礙，建議持續進行語音訓練';
      } else if (totalScore >= 60) {
          scoreLevel = '尚可';
          scoreDescription = '中度語音障礙，需持續訓練並定期追蹤評估';
      } else {
          scoreLevel = '需加強';
          scoreDescription = '重度語音障礙，建議尋求專業語言治療師協助';
      }
      
      document.getElementById('reportScoreLevel').textContent = scoreLevel;
      document.getElementById('reportScoreDescription').textContent = scoreDescription;
      
      // 生成詳細表格
      generateReportTable();
      
      // 生成圖表
      generateReportChart();
      
      // 生成建議
      generateReportRecommendations(totalScore);
      
      document.getElementById('reportSection').classList.add('show');
      document.getElementById('reportSection').scrollIntoView({ behavior: 'smooth' });
  }
  
  // 生成報告表格
  function generateReportTable() {
      const tbody = document.getElementById('reportDetailsTable');
      tbody.innerHTML = '';
      
      const parameters = [
          { key: 'f0', name: '基頻 F0', max: 10 },
          { key: 'intensity', name: '音量強度', max: 10 },
          { key: 'hnr', name: 'HNR 諧噪比', max: 15 },
          { key: 'jitter', name: 'Jitter 頻率微擾', max: 15 },
          { key: 'shimmer', name: 'Shimmer 振幅微擾', max: 15 },
          { key: 'f1', name: '第一共振峰 F1', max: 10 },
          { key: 'f2', name: '第二共振峰 F2', max: 10 },
          { key: 'speechRate', name: '語速', max: 10 },
          { key: 'pause', name: '停頓模式', max: 5 }
      ];
      
      parameters.forEach((param, index) => {
          const item = currentAnalysisData[param.key];
          const percentage = (item.score / param.max) * 100;
          const status = getStatusClass(percentage);
          const statusText = getStatusText(percentage);
          
          const row = document.createElement('tr');
          row.innerHTML = `
              <td>${index + 1}</td>
              <td><strong>${param.name}</strong></td>
              <td>${item.value} ${item.unit}</td>
              <td>${item.normalRange}</td>
              <td><strong>${item.score.toFixed(1)} / ${param.max}</strong></td>
              <td><span class="result-card-status ${status}">${statusText}</span></td>
          `;
          tbody.appendChild(row);
      });
      
      // 添加總分行
      const totalScore = Object.values(currentAnalysisData).reduce((sum, item) => sum + item.score, 0);
      const totalRow = document.createElement('tr');
      totalRow.style.background = '#f8f9fa';
      totalRow.style.fontWeight = '700';
      totalRow.innerHTML = `
          <td colspan="4" style="text-align: right;"><strong>總分</strong></td>
          <td colspan="2"><strong>${totalScore.toFixed(1)} / 100</strong></td>
      `;
      tbody.appendChild(totalRow);
  }
  
  // 生成報告圖表
  function generateReportChart() {
      const canvas = document.getElementById('reportChart');
      const ctx = canvas.getContext('2d');
      
      const parameters = ['F0', '音量', 'HNR', 'Jitter', 'Shimmer', 'F1', 'F2', '語速', '停頓'];
      const scores = [
          currentAnalysisData.f0.score / 10 * 100,
          currentAnalysisData.intensity.score / 10 * 100,
          currentAnalysisData.hnr.score / 15 * 100,
          currentAnalysisData.jitter.score / 15 * 100,
          currentAnalysisData.shimmer.score / 15 * 100,
          currentAnalysisData.f1.score / 10 * 100,
          currentAnalysisData.f2.score / 10 * 100,
          currentAnalysisData.speechRate.score / 10 * 100,
          currentAnalysisData.pause.score / 5 * 100
      ];
      
      const barWidth = 70;
      const barSpacing = 20;
      const startX = 50;
      const startY = 350;
      const maxHeight = 300;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // 繪製背景網格
      ctx.strokeStyle = '#ecf0f1';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 10; i++) {
          const y = startY - (maxHeight / 10) * i;
          ctx.beginPath();
          ctx.moveTo(startX, y);
          ctx.lineTo(canvas.width - 20, y);
          ctx.stroke();
          
          ctx.fillStyle = '#7f8c8d';
          ctx.font = '12px Arial';
          ctx.textAlign = 'right';
          ctx.fillText((i * 10) + '%', startX - 10, y + 4);
      }
      
      // 繪製柱狀圖
      parameters.forEach((param, index) => {
          const x = startX + index * (barWidth + barSpacing);
          const height = (scores[index] / 100) * maxHeight;
          const y = startY - height;
          
          // 繪製柱子
          const gradient = ctx.createLinearGradient(x, y, x, startY);
          if (scores[index] >= 85) {
              gradient.addColorStop(0, '#27ae60');
              gradient.addColorStop(1, '#2ecc71');
          } else if (scores[index] >= 70) {
              gradient.addColorStop(0, '#2980b9');
              gradient.addColorStop(1, '#3498db');
          } else if (scores[index] >= 50) {
              gradient.addColorStop(0, '#f39c12');
              gradient.addColorStop(1, '#f1c40f');
          } else {
              gradient.addColorStop(0, '#c0392b');
              gradient.addColorStop(1, '#e74c3c');
          }
          
          ctx.fillStyle = gradient;
          ctx.fillRect(x, y, barWidth, height);
          
          // 繪製邊框
          ctx.strokeStyle = '#2c3e50';
          ctx.lineWidth = 2;
          ctx.strokeRect(x, y, barWidth, height);
          
          // 繪製數值
          ctx.fillStyle = '#2c3e50';
          ctx.font = 'bold 14px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(scores[index].toFixed(0) + '%', x + barWidth / 2, y - 10);
          
          // 繪製標籤
          ctx.save();
          ctx.translate(x + barWidth / 2, startY + 15);
          ctx.rotate(-Math.PI / 6);
          ctx.fillStyle = '#2c3e50';
          ctx.font = '13px Arial';
          ctx.textAlign = 'right';
          ctx.fillText(param, 0, 0);
          ctx.restore();
      });
      
      // 繪製標題
      ctx.fillStyle = '#2c3e50';
      ctx.font = 'bold 18px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('各項參數評分百分比', canvas.width / 2, 30);
  }
  
  // 生成建議
  function generateReportRecommendations(totalScore) {
      const list = document.getElementById('reportRecommendationsList');
      list.innerHTML = '';
      
      const recommendations = [];
      
      if (currentAnalysisData.intensity.score < 7) {
          recommendations.push('音量訓練：建議進行LSVT LOUD療法，每天練習大聲發音，增強聲帶力量');
      }
      
      if (currentAnalysisData.hnr.score < 12) {
          recommendations.push('音質改善：練習腹式呼吸，放鬆喉部肌肉，減少氣息聲和嘶啞');
      }
      
      if (currentAnalysisData.jitter.score < 12 || currentAnalysisData.shimmer.score < 12) {
          recommendations.push('穩定性訓練：持續發 /a/ 音5-10秒，每天練習3-5次，提升聲音穩定性');
      }
      
      if (currentAnalysisData.f1.score < 7 || currentAnalysisData.f2.score < 7) {
          recommendations.push('構音訓練：練習誇張的口腔動作，清晰發出每個元音和輔音');
      }
      
      if (currentAnalysisData.speechRate.score < 7) {
          recommendations.push('語速調整：使用節拍器輔助，練習穩定節奏的說話速度');
      }
      
      if (currentAnalysisData.pause.score < 4) {
          recommendations.push('韻律訓練：練習在適當位置停頓，使用標點符號作為停頓指引');
      }
      
      if (totalScore >= 90) {
          recommendations.push('維持訓練：繼續保持每天15-20分鐘的語音練習，鞏固成果');
      } else if (totalScore >= 75) {
          recommendations.push('持續進步：建議每天訓練30分鐘，每2週進行一次評估');
      } else if (totalScore >= 60) {
          recommendations.push('加強訓練：建議每天訓練2次，每次30分鐘，每週評估一次');
      } else {
          recommendations.push('專業協助：建議儘快諮詢語言治療師，制定個人化密集治療計畫');
      }
      
      recommendations.push('定期評估：建議每2-4週進行一次完整評估，追蹤進步情況');
      recommendations.push('記錄追蹤：保存每次評估報告，觀察長期趨勢變化');
      
      recommendations.forEach(rec => {
          const li = document.createElement('li');
          li.textContent = rec;
          list.appendChild(li);
      });
  }
  
  // 列印報告
  function printReport() {
      window.print();
  }
  
  // 下載PDF
  function downloadReport() {
      alert('PDF下載功能需要整合 jsPDF 或類似庫。\n\n在實際應用中，此功能會將報告轉換為PDF格式並下載。');
      
      // 實際實現範例（需要引入 jsPDF 和 html2canvas）:
      // const element = document.getElementById('reportSection');
      // html2canvas(element).then(canvas => {
      //     const imgData = canvas.toDataURL('image/png');
      //     const pdf = new jsPDF('p', 'mm', 'a4');
      //     const imgWidth = 210;
      //     const imgHeight = canvas.height * imgWidth / canvas.width;
      //     pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
      //     pdf.save('語音評估報告.pdf');
      // });
  }
  
  // 郵件發送
  function emailReport() {
      const reportId = document.getElementById('reportId').textContent;
      const totalScore = document.getElementById('reportTotalScore').textContent;
      const date = document.getElementById('reportDate').textContent;
      
      const subject = encodeURIComponent(`帕金森病語音評估報告 - ${reportId}`);
      const body = encodeURIComponent(
          `語音評估報告\n\n` +
          `報告編號：${reportId}\n` +
          `評估日期：${date}\n` +
          `總體評分：${totalScore} 分\n\n` +
          `詳細報告請見附件。`
      );
      
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
  }
  
  // 新評估
  function newAssessment() {
      if (confirm('確定要開始新的評估嗎？當前數據將被清除。')) {
          location.reload();
      }
  }
  </script>
  </body>
  </html>
