<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¸•é‡‘æ£®ç—…èªéŸ³è²å­¸åˆ†æè©•ä¼°ç³»çµ±</title>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
        font-size: 16px;
        line-height: 1.6;
        color: #2d3748;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .header {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        text-align: center;
    }
    
    .header h1 {
        color: #4a5568;
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 700;
    }
    
    .header .subtitle {
        color: #718096;
        font-size: 1.2em;
        font-weight: 500;
    }
    
    .section-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .section-title {
        color: #667eea;
        font-size: 2em;
        margin-bottom: 20px;
        font-weight: 700;
        border-left: 5px solid #667eea;
        padding-left: 15px;
    }
    
    /* éŒ„éŸ³æ§åˆ¶å€ */
    .recording-section {
        background: linear-gradient(135deg, #fef5e7 0%, #fdebd0 100%);
        border: 3px solid #f39c12;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
    }
    
    .recording-controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
    }
    
    .record-btn-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .record-btn {
        padding: 20px 40px;
        font-size: 1.3em;
        font-weight: 700;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .record-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    
    .record-btn:active {
        transform: translateY(-1px);
    }
    
    .record-btn.start {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
    }
    
    .record-btn.stop {
        background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        color: white;
        display: none;
    }
    
    .record-btn.analyze {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        color: white;
        display: none;
    }
    
    .record-btn.upload {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
    }
    
    .recording-status {
        text-align: center;
        font-size: 1.3em;
        font-weight: 600;
        color: #2c3e50;
        min-height: 30px;
    }
    
    .recording-timer {
        font-size: 2.5em;
        font-weight: 700;
        color: #e74c3c;
        display: none;
    }
    
    .waveform-container {
        width: 100%;
        height: 150px;
        background: white;
        border-radius: 10px;
        margin-top: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #f39c12;
        overflow: hidden;
    }
    
    .waveform-canvas {
        width: 100%;
        height: 100%;
    }
    
    .audio-player {
        width: 100%;
        margin-top: 20px;
        display: none;
    }
    
    .file-upload-area {
        border: 3px dashed #3498db;
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
    }
    
    .file-upload-area:hover {
        background: #ebf5fb;
        border-color: #2980b9;
    }
    
    .file-upload-area.dragover {
        background: #d6eaf8;
        border-color: #2980b9;
    }
    
    /* åˆ†æçµæœå€ */
    .analysis-results {
        display: none;
        animation: fadeIn 0.5s ease;
    }
    
    .analysis-results.show {
        display: block;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .result-card {
        background: linear-gradient(135deg, #e8f4f8 0%, #d4e9f2 100%);
        border: 2px solid #3498db;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(52, 152, 219, 0.2);
    }
    
    .result-card-title {
        font-size: 1.1em;
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .result-card-value {
        font-size: 2.5em;
        font-weight: 700;
        color: #3498db;
        margin: 10px 0;
    }
    
    .result-card-status {
        font-size: 1em;
        font-weight: 600;
        padding: 5px 15px;
        border-radius: 20px;
        display: inline-block;
    }
    
    .status-excellent { 
        background: #d5f4e6;
        color: #27ae60;
    }
    
    .status-good { 
        background: #d6eaf8;
        color: #2980b9;
    }
    
    .status-fair { 
        background: #fef5e7;
        color: #f39c12;
    }
    
    .status-poor { 
        background: #fadbd8;
        color: #e74c3c;
    }
    
    /* å ±å‘Šå€åŸŸ */
    .report-section {
        background: white;
        border-radius: 20px;
        padding: 40px;
        margin-top: 30px;
        display: none;
    }
    
    .report-section.show {
        display: block;
    }
    
    .report-header {
        text-align: center;
        border-bottom: 3px solid #667eea;
        padding-bottom: 20px;
        margin-bottom: 30px;
    }
    
    .report-title {
        font-size: 2.5em;
        color: #2c3e50;
        font-weight: 700;
        margin-bottom: 10px;
    }
    
    .report-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
    }
    
    .report-meta-item {
        display: flex;
        flex-direction: column;
    }
    
    .report-meta-label {
        font-size: 0.9em;
        color: #7f8c8d;
        margin-bottom: 5px;
    }
    
    .report-meta-value {
        font-size: 1.1em;
        color: #2c3e50;
        font-weight: 600;
    }
    
    .report-score-summary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        margin: 30px 0;
    }
    
    .report-total-score {
        font-size: 5em;
        font-weight: 700;
        margin: 20px 0;
    }
    
    .report-score-label {
        font-size: 1.8em;
        font-weight: 600;
    }
    
    .report-details-table {
        width: 100%;
        border-collapse: collapse;
        margin: 30px 0;
    }
    
    .report-details-table th {
        background: #34495e;
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
    }
    
    .report-details-table td {
        padding: 15px;
        border-bottom: 1px solid #ecf0f1;
    }
    
    .report-details-table tr:hover {
        background: #f8f9fa;
    }
    
    .report-chart {
        margin: 30px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
    }
    
    .report-recommendations {
        background: #fff3cd;
        border-left: 5px solid #ffc107;
        padding: 20px;
        margin: 30px 0;
        border-radius: 5px;
    }
    
    .report-recommendations h3 {
        color: #856404;
        margin-bottom: 15px;
    }
    
    .report-recommendations ul {
        list-style: none;
        padding-left: 0;
    }
    
    .report-recommendations li {
        padding: 10px 0;
        color: #856404;
        line-height: 1.8;
    }
    
    .report-recommendations li:before {
        content: "âœ“ ";
        font-weight: 700;
        margin-right: 10px;
    }
    
    .report-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
        flex-wrap: wrap;
    }
    
    .action-btn {
        padding: 15px 30px;
        font-size: 1.2em;
        font-weight: 600;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .action-btn.print {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
    }
    
    .action-btn.download {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        color: white;
    }
    
    .action-btn.email {
        background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
        color: white;
    }
    
    .action-btn.new {
        background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        color: white;
    }
    
    /* åˆ—å°æ¨£å¼ */
    @media print {
        body {
            background: white;
            padding: 0;
        }
        
        .container {
            max-width: 100%;
        }
        
        .section-card:not(.report-section) {
            display: none !important;
        }
        
        .report-actions {
            display: none !important;
        }
        
        .report-section {
            box-shadow: none;
            page-break-after: always;
        }
        
        .report-score-summary {
            break-inside: avoid;
        }
        
        .report-details-table {
            break-inside: avoid;
        }
    }
    
    /* åœ–è¡¨å®¹å™¨ */
    .chart-container {
        width: 100%;
        height: 400px;
        margin: 20px 0;
    }
    
    .progress-bar {
        width: 100%;
        height: 30px;
        background: #ecf0f1;
        border-radius: 15px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }
    
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .hidden {
        display: none !important;
    }
    
    @media (max-width: 768px) {
        .header h1 {
            font-size: 1.8em;
        }
        
        .section-title {
            font-size: 1.5em;
        }
        
        .record-btn {
            padding: 15px 25px;
            font-size: 1.1em;
        }
        
        .result-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ¤ å¸•é‡‘æ£®ç—…èªéŸ³è²å­¸åˆ†æè©•ä¼°ç³»çµ±</h1>
        <div class="subtitle">å³æ™‚éŒ„éŸ³åˆ†æ Â· æ™ºèƒ½è©•ä¼° Â· å°ˆæ¥­å ±å‘Š</div>
    </div>
    
    <!-- å³æ™‚éŒ„éŸ³åˆ†æå€ -->
    <div class="section-card">
        <h2 class="section-title">ğŸ™ï¸ å³æ™‚éŒ„éŸ³èˆ‡éŸ³æª”åˆ†æ</h2>
        
        <div class="recording-section">
            <div class="recording-controls">
                <div class="recording-status" id="recordingStatus">è«‹é¸æ“‡éŒ„éŸ³æˆ–ä¸Šå‚³éŸ³æª”é€²è¡Œåˆ†æ</div>
                <div class="recording-timer" id="recordingTimer">00:00</div>
                
                <div class="record-btn-group">
                    <button class="record-btn start" id="startRecordBtn" onclick="startRecording()">
                        <span>ğŸ”´</span> é–‹å§‹éŒ„éŸ³
                    </button>
                    <button class="record-btn stop" id="stopRecordBtn" onclick="stopRecording()">
                        <span>â¹ï¸</span> åœæ­¢éŒ„éŸ³
                    </button>
                    <button class="record-btn analyze" id="analyzeBtn" onclick="analyzeAudio()">
                        <span>ğŸ”¬</span> é–‹å§‹åˆ†æ
                    </button>
                </div>
                
                <div class="waveform-container">
                    <canvas class="waveform-canvas" id="waveformCanvas"></canvas>
                </div>
                
                <audio class="audio-player" id="audioPlayer" controls></audio>
                
                <div style="width: 100%; max-width: 600px;">
                    <h3 style="text-align: center; color: #2c3e50; margin: 20px 0;">æˆ–ä¸Šå‚³éŸ³æª”</h3>
                    <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“</div>
                        <div style="font-size: 1.2em; font-weight: 600; color: #2c3e50;">é»æ“Šé¸æ“‡éŸ³æª”æˆ–æ‹–æ›³è‡³æ­¤</div>
                        <div style="color: #7f8c8d; margin-top: 10px;">æ”¯æ´æ ¼å¼ï¼šWAV, MP3, M4A</div>
                        <input type="file" id="fileInput" accept="audio/*" style="display: none;" onchange="handleFileUpload(event)">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="loading-spinner" id="loadingSpinner"></div>
    </div>
    
    <!-- åˆ†æçµæœå€ -->
    <div class="section-card analysis-results" id="analysisResults">
        <h2 class="section-title">ğŸ“Š è²å­¸åˆ†æçµæœ</h2>
        
        <div class="result-grid" id="resultGrid">
            <!-- çµæœå¡ç‰‡å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
            <button class="action-btn print" onclick="generateReport()">
                <span>ğŸ“„</span> ç”Ÿæˆå®Œæ•´å ±å‘Š
            </button>
        </div>
    </div>
    
    <!-- å®Œæ•´è©•ä¼°å ±å‘Š -->
    <div class="section-card report-section" id="reportSection">
        <div class="report-header">
            <div class="report-title">ğŸ¥ å¸•é‡‘æ£®ç—…èªéŸ³è©•ä¼°å ±å‘Š</div>
            <div style="color: #7f8c8d; font-size: 1.1em; margin-top: 10px;">Parkinson's Disease Speech Assessment Report</div>
        </div>
        
        <div class="report-meta" id="reportMeta">
            <div class="report-meta-item">
                <div class="report-meta-label">å ±å‘Šç·¨è™Ÿ</div>
                <div class="report-meta-value" id="reportId">-</div>
            </div>
            <div class="report-meta-item">
                <div class="report-meta-label">è©•ä¼°æ—¥æœŸ</div>
                <div class="report-meta-value" id="reportDate">-</div>
            </div>
            <div class="report-meta-item">
                <div class="report-meta-label">è©•ä¼°æ™‚é–“</div>
                <div class="report-meta-value" id="reportTime">-</div>
            </div>
            <div class="report-meta-item">
                <div class="report-meta-label">éŒ„éŸ³æ™‚é•·</div>
                <div class="report-meta-value" id="reportDuration">-</div>
            </div>
        </div>
        
        <div class="report-score-summary">
            <div class="report-score-label">ç¸½é«”è©•åˆ†</div>
            <div class="report-total-score" id="reportTotalScore">0</div>
            <div class="report-score-label" id="reportScoreLevel">-</div>
            <div style="margin-top: 20px; font-size: 1.2em;" id="reportScoreDescription">-</div>
        </div>
        
        <h3 style="color: #2c3e50; font-size: 1.8em; margin: 30px 0 20px 0; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;">
            ğŸ“ˆ è©³ç´°è©•ä¼°æ•¸æ“š
        </h3>
        
        <table class="report-details-table">
            <thead>
                <tr>
                    <th style="width: 5%;">åºè™Ÿ</th>
                    <th style="width: 25%;">è©•ä¼°é …ç›®</th>
                    <th style="width: 20%;">æ¸¬é‡å€¼</th>
                    <th style="width: 15%;">æ­£å¸¸ç¯„åœ</th>
                    <th style="width: 15%;">å¾—åˆ†</th>
                    <th style="width: 20%;">è©•ä¼°</th>
                </tr>
            </thead>
            <tbody id="reportDetailsTable">
                <!-- ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </tbody>
        </table>
        
        <h3 style="color: #2c3e50; font-size: 1.8em; margin: 30px 0 20px 0; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;">
            ğŸ“Š è©•åˆ†è¦–è¦ºåŒ–
        </h3>
        
        <div class="report-chart">
            <canvas id="reportChart" width="800" height="400"></canvas>
        </div>
        
        <div class="report-recommendations" id="reportRecommendations">
            <h3>ğŸ’¡ å°ˆæ¥­å»ºè­°èˆ‡è¨“ç·´æ–¹å‘</h3>
            <ul id="reportRecommendationsList">
                <!-- ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </ul>
        </div>
        
        <div style="margin-top: 30px; padding: 20px; background: #e8f8f5; border-radius: 10px; border-left: 5px solid #27ae60;">
            <h4 style="color: #27ae60; margin-bottom: 10px;">ğŸ“ è©•ä¼°èªªæ˜</h4>
            <p style="color: #2c3e50; line-height: 1.8;">
                æœ¬å ±å‘Šæ¡ç”¨å¤šç¶­åº¦è²å­¸åˆ†ææŠ€è¡“ï¼Œè©•ä¼°èªéŸ³çš„åŸºé »ã€éŸ³é‡ã€éŸ³è³ªã€ç©©å®šæ€§ã€æ§‹éŸ³æ¸…æ™°åº¦ç­‰æŒ‡æ¨™ã€‚
                è©•åˆ†ç³»çµ±åŸºæ–¼åœ‹éš›è‡¨åºŠç ”ç©¶æ¨™æº–ï¼Œç¸½åˆ†100åˆ†ï¼Œåˆ†ç‚ºå„ªç§€ï¼ˆ90-100ï¼‰ã€è‰¯å¥½ï¼ˆ75-89ï¼‰ã€å°šå¯ï¼ˆ60-74ï¼‰ã€éœ€åŠ å¼·ï¼ˆ<60ï¼‰å››å€‹ç­‰ç´šã€‚
                å»ºè­°å®šæœŸï¼ˆæ¯2-4é€±ï¼‰é€²è¡Œè©•ä¼°ï¼Œè¿½è¹¤è¨“ç·´æ•ˆæœã€‚
            </p>
        </div>
        
        <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 10px; border-left: 5px solid #ffc107;">
            <h4 style="color: #856404; margin-bottom: 10px;">âš ï¸ é‡è¦æç¤º</h4>
            <p style="color: #856404; line-height: 1.8;">
                æœ¬è©•ä¼°ç³»çµ±åƒ…ä¾›åƒè€ƒï¼Œä¸èƒ½æ›¿ä»£å°ˆæ¥­é†«ç™‚è¨ºæ–·ã€‚å¦‚æœ‰ç–‘å•æˆ–åˆ†æ•¸æŒçºŒä¸‹é™ï¼Œè«‹è«®è©¢èªè¨€æ²»ç™‚å¸«æˆ–ç¥ç¶“ç§‘é†«å¸«ã€‚
                éŒ„éŸ³æ™‚è«‹ä¿æŒç’°å¢ƒå®‰éœï¼Œä½¿ç”¨ç›¸åŒè¨­å‚™ä»¥ç¢ºä¿æ•¸æ“šå¯æ¯”æ€§ã€‚å»ºè­°åœ¨è—¥ç‰©æ•ˆæœæœ€ä½³æ™‚æ®µï¼ˆONç‹€æ…‹ï¼‰é€²è¡Œè©•ä¼°ã€‚
            </p>
        </div>
        
        <div class="report-actions">
            <button class="action-btn print" onclick="printReport()">
                <span>ğŸ–¨ï¸</span> åˆ—å°å ±å‘Š
            </button>
            <button class="action-btn download" onclick="downloadReport()">
                <span>ğŸ’¾</span> ä¸‹è¼‰PDF
            </button>
            <button class="action-btn email" onclick="emailReport()">
                <span>ğŸ“§</span> éƒµä»¶ç™¼é€
            </button>
            <button class="action-btn new" onclick="newAssessment()">
                <span>ğŸ”„</span> æ–°è©•ä¼°
            </button>
        </div>
    </div>
</div>

<script>
// å…¨å±€è®Šé‡
let mediaRecorder;
let audioChunks = [];
let audioBlob;
let audioContext;
let analyser;
let dataArray;
let animationId;
let recordingStartTime;
let timerInterval;
let currentAnalysisData = {};

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    setupFileUpload();
    initWaveform();
});

// è¨­ç½®æ–‡ä»¶ä¸Šå‚³
function setupFileUpload() {
    const uploadArea = document.getElementById('fileUploadArea');
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });
}

// åˆå§‹åŒ–æ³¢å½¢é¡¯ç¤º
function initWaveform() {
    const canvas = document.getElementById('waveformCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    
    ctx.fillStyle = '#ecf0f1';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#7f8c8d';
    ctx.font = '16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('ç­‰å¾…éŒ„éŸ³æˆ–ä¸Šå‚³éŸ³æª”...', canvas.width / 2, canvas.height / 2);
}

// é–‹å§‹éŒ„éŸ³
async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = audioUrl;
            audioPlayer.style.display = 'block';
            
            document.getElementById('analyzeBtn').style.display = 'flex';
        };
        
        mediaRecorder.start();
        
        // è¨­ç½®éŸ³é »å¯è¦–åŒ–
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        source.connect(analyser);
        
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        
        // æ›´æ–°UI
        document.getElementById('startRecordBtn').style.display = 'none';
        document.getElementById('stopRecordBtn').style.display = 'flex';
        document.getElementById('recordingStatus').textContent = 'ğŸ”´ éŒ„éŸ³ä¸­...';
        document.getElementById('recordingTimer').style.display = 'block';
        
        // é–‹å§‹è¨ˆæ™‚
        recordingStartTime = Date.now();
        timerInterval = setInterval(updateTimer, 100);
        
        // é–‹å§‹ç¹ªè£½æ³¢å½¢
        drawWaveform();
        
    } catch (error) {
        alert('ç„¡æ³•è¨ªå•éº¥å…‹é¢¨ï¼Œè«‹ç¢ºèªå·²æˆäºˆæ¬Šé™ã€‚');
        console.error('éŒ„éŸ³éŒ¯èª¤:', error);
    }
}

// åœæ­¢éŒ„éŸ³
function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
          mediaRecorder.stream.getTracks().forEach(track => track.stop());
          
          clearInterval(timerInterval);
          cancelAnimationFrame(animationId);
          
          document.getElementById('startRecordBtn').style.display = 'flex';
          document.getElementById('stopRecordBtn').style.display = 'none';
          document.getElementById('recordingStatus').textContent = 'âœ… éŒ„éŸ³å®Œæˆï¼Œå¯ä»¥é–‹å§‹åˆ†æ';
          document.getElementById('recordingTimer').style.display = 'none';
      }
  }
  
  // æ›´æ–°è¨ˆæ™‚å™¨
  function updateTimer() {
      const elapsed = Date.now() - recordingStartTime;
      const seconds = Math.floor(elapsed / 1000);
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      
      document.getElementById('recordingTimer').textContent = 
          `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
  }
  
  // ç¹ªè£½æ³¢å½¢
  function drawWaveform() {
      const canvas = document.getElementById('waveformCanvas');
      const ctx = canvas.getContext('2d');
      
      animationId = requestAnimationFrame(drawWaveform);
      
      analyser.getByteTimeDomainData(dataArray);
      
      ctx.fillStyle = 'rgb(255, 255, 255)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'rgb(231, 76, 60)';
      ctx.beginPath();
      
      const sliceWidth = canvas.width / dataArray.length;
      let x = 0;
      
      for (let i = 0; i < dataArray.length; i++) {
          const v = dataArray[i] / 128.0;
          const y = v * canvas.height / 2;
          
          if (i === 0) {
              ctx.moveTo(x, y);
          } else {
              ctx.lineTo(x, y);
          }
          
          x += sliceWidth;
      }
      
      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.stroke();
  }
  
  // è™•ç†æ–‡ä»¶ä¸Šå‚³
  function handleFileUpload(event) {
      const file = event.target.files[0];
      handleFile(file);
  }
  
  function handleFile(file) {
      if (!file) return;
      
      if (!file.type.startsWith('audio/')) {
          alert('è«‹ä¸Šå‚³éŸ³é »æ–‡ä»¶ï¼');
          return;
      }
      
      audioBlob = file;
      const audioUrl = URL.createObjectURL(file);
      const audioPlayer = document.getElementById('audioPlayer');
      audioPlayer.src = audioUrl;
      audioPlayer.style.display = 'block';
      
      document.getElementById('recordingStatus').textContent = `âœ… å·²ä¸Šå‚³ï¼š${file.name}`;
      document.getElementById('analyzeBtn').style.display = 'flex';
      
      // ç¹ªè£½éœæ…‹æ³¢å½¢æç¤º
      const canvas = document.getElementById('waveformCanvas');
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#d5f4e6';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#27ae60';
      ctx.font = '16px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('âœ“ éŸ³æª”å·²è¼‰å…¥ï¼Œé»æ“Šã€Œé–‹å§‹åˆ†æã€', canvas.width / 2, canvas.height / 2);
  }
  
  // åˆ†æéŸ³é »
  async function analyzeAudio() {
      if (!audioBlob) {
          alert('è«‹å…ˆéŒ„éŸ³æˆ–ä¸Šå‚³éŸ³æª”ï¼');
          return;
      }
      
      document.getElementById('loadingSpinner').style.display = 'block';
      document.getElementById('recordingStatus').textContent = 'ğŸ”¬ æ­£åœ¨åˆ†æéŸ³é »...';
      
      // æ¨¡æ“¬éŸ³é »åˆ†æéç¨‹ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­éœ€è¦èª¿ç”¨çœŸå¯¦çš„éŸ³é »åˆ†æAPIï¼‰
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // ç”Ÿæˆæ¨¡æ“¬åˆ†ææ•¸æ“šï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­æ‡‰è©²æ˜¯çœŸå¯¦åˆ†æçµæœï¼‰
      currentAnalysisData = generateMockAnalysisData();
      
      document.getElementById('loadingSpinner').style.display = 'none';
      document.getElementById('recordingStatus').textContent = 'âœ… åˆ†æå®Œæˆï¼';
      
      displayAnalysisResults(currentAnalysisData);
  }
  
  // ç”Ÿæˆæ¨¡æ“¬åˆ†ææ•¸æ“š
  function generateMockAnalysisData() {
      return {
          f0: {
              value: (Math.random() * 100 + 100).toFixed(2),
              unit: 'Hz',
              normalRange: '85-255 Hz',
              score: 0
          },
          intensity: {
              value: (Math.random() * 15 + 60).toFixed(2),
              unit: 'dB',
              normalRange: '55-75 dB',
              score: 0
          },
          hnr: {
              value: (Math.random() * 15 + 10).toFixed(2),
              unit: 'dB',
              normalRange: 'â‰¥15 dB',
              score: 0
          },
          jitter: {
              value: (Math.random() * 2 + 0.3).toFixed(3),
              unit: '%',
              normalRange: 'â‰¤1.04%',
              score: 0
          },
          shimmer: {
              value: (Math.random() * 4 + 1.5).toFixed(3),
              unit: '%',
              normalRange: 'â‰¤3.81%',
              score: 0
          },
          f1: {
              value: (Math.random() * 300 + 600).toFixed(0),
              unit: 'Hz',
              normalRange: '600-900 Hz',
              score: 0
          },
          f2: {
              value: (Math.random() * 400 + 1000).toFixed(0),
              unit: 'Hz',
              normalRange: '1000-1400 Hz',
              score: 0
          },
          speechRate: {
              value: (Math.random() * 100 + 150).toFixed(0),
              unit: 'éŸ³ç¯€/åˆ†',
              normalRange: '180-220',
              score: 0
          },
          pause: {
              value: (Math.random() * 3 + 2).toFixed(0),
              unit: 'åˆ†',
              normalRange: '3-5åˆ†',
              score: 0
          }
      };
  }
  
  // é¡¯ç¤ºåˆ†æçµæœ
  function displayAnalysisResults(data) {
      // è¨ˆç®—å„é …åˆ†æ•¸
      data.f0.score = calculateF0Score(parseFloat(data.f0.value));
      data.intensity.score = calculateIntensityScore(parseFloat(data.intensity.value));
      data.hnr.score = calculateHNRScore(parseFloat(data.hnr.value));
      data.jitter.score = calculateJitterScore(parseFloat(data.jitter.value));
      data.shimmer.score = calculateShimmerScore(parseFloat(data.shimmer.value));
      data.f1.score = calculateF1Score(parseFloat(data.f1.value));
      data.f2.score = calculateF2Score(parseFloat(data.f2.value));
      data.speechRate.score = calculateSpeechRateScore(parseFloat(data.speechRate.value));
      data.pause.score = parseFloat(data.pause.value);
      
      const resultGrid = document.getElementById('resultGrid');
      resultGrid.innerHTML = '';
      
      const parameters = [
          { key: 'f0', name: 'åŸºé » F0', max: 10 },
          { key: 'intensity', name: 'éŸ³é‡å¼·åº¦', max: 10 },
          { key: 'hnr', name: 'HNR è«§å™ªæ¯”', max: 15 },
          { key: 'jitter', name: 'Jitter', max: 15 },
          { key: 'shimmer', name: 'Shimmer', max: 15 },
          { key: 'f1', name: 'å…±æŒ¯å³° F1', max: 10 },
          { key: 'f2', name: 'å…±æŒ¯å³° F2', max: 10 },
          { key: 'speechRate', name: 'èªé€Ÿ', max: 10 },
          { key: 'pause', name: 'åœé “æ¨¡å¼', max: 5 }
      ];
      
      parameters.forEach(param => {
          const item = data[param.key];
          const percentage = (item.score / param.max) * 100;
          const status = getStatusClass(percentage);
          const statusText = getStatusText(percentage);
          
          const card = document.createElement('div');
          card.className = 'result-card';
          card.innerHTML = `
              <div class="result-card-title">${param.name}</div>
              <div class="result-card-value">${item.value} ${item.unit}</div>
              <div style="margin: 10px 0;">
                  <div class="progress-bar">
                      <div class="progress-fill" style="width: ${percentage}%">
                          ${item.score.toFixed(1)}/${param.max}
                      </div>
                  </div>
              </div>
              <div class="result-card-status ${status}">${statusText}</div>
              <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 10px;">
                  æ­£å¸¸ç¯„åœ: ${item.normalRange}
              </div>
          `;
          resultGrid.appendChild(card);
      });
      
      document.getElementById('analysisResults').classList.add('show');
      document.getElementById('analysisResults').scrollIntoView({ behavior: 'smooth' });
  }
  
  // è©•åˆ†å‡½æ•¸
  function calculateF0Score(f0) {
      if ((f0 >= 100 && f0 <= 150) || (f0 >= 180 && f0 <= 220)) return 10;
      if ((f0 >= 85 && f0 < 100) || (f0 > 150 && f0 <= 180) || (f0 > 220 && f0 <= 255)) return 7;
      if ((f0 >= 70 && f0 < 85) || (f0 > 255 && f0 <= 280)) return 4;
      return 2;
  }
  
  function calculateIntensityScore(intensity) {
      if (intensity >= 65 && intensity <= 75) return 10;
      if (intensity >= 60 && intensity < 65) return 7;
      if (intensity >= 55 && intensity < 60) return 5;
      return 2;
  }
  
  function calculateHNRScore(hnr) {
      if (hnr >= 20) return 15;
      if (hnr >= 15) return 12;
      if (hnr >= 10) return 8;
      return 4;
  }
  
  function calculateJitterScore(jitter) {
      if (jitter <= 0.5) return 15;
      if (jitter <= 1.04) return 12;
      if (jitter <= 2.0) return 8;
      return 4;
  }
  
  function calculateShimmerScore(shimmer) {
      if (shimmer <= 2.0) return 15;
      if (shimmer <= 3.81) return 12;
      if (shimmer <= 6.0) return 8;
      return 4;
  }
  
  function calculateF1Score(f1) {
      if (f1 >= 600 && f1 <= 900) return 10;
      if ((f1 >= 480 && f1 < 600) || (f1 > 900 && f1 <= 1080)) return 7;
      if ((f1 >= 420 && f1 < 480) || (f1 > 1080 && f1 <= 1170)) return 4;
      return 2;
  }
  
  function calculateF2Score(f2) {
      if (f2 >= 1000 && f2 <= 1400) return 10;
      if ((f2 >= 800 && f2 < 1000) || (f2 > 1400 && f2 <= 1680)) return 7;
      if ((f2 >= 700 && f2 < 800) || (f2 > 1680 && f2 <= 1820)) return 4;
      return 2;
  }
  
  function calculateSpeechRateScore(rate) {
      if (rate >= 180 && rate <= 220) return 10;
      if ((rate >= 150 && rate < 180) || (rate > 220 && rate <= 250)) return 7;
      if ((rate >= 120 && rate < 150) || (rate > 250 && rate <= 280)) return 4;
      return 2;
  }
  
  function getStatusClass(percentage) {
      if (percentage >= 85) return 'status-excellent';
      if (percentage >= 70) return 'status-good';
      if (percentage >= 50) return 'status-fair';
      return 'status-poor';
  }
  
  function getStatusText(percentage) {
      if (percentage >= 85) return 'å„ªç§€';
      if (percentage >= 70) return 'è‰¯å¥½';
      if (percentage >= 50) return 'å°šå¯';
      return 'éœ€åŠ å¼·';
  }
  
  // ç”Ÿæˆå®Œæ•´å ±å‘Š
  function generateReport() {
      if (!currentAnalysisData || Object.keys(currentAnalysisData).length === 0) {
          alert('è«‹å…ˆé€²è¡ŒéŸ³é »åˆ†æï¼');
          return;
      }
      
      const now = new Date();
      const reportId = 'PD-' + now.getFullYear() + (now.getMonth() + 1).toString().padStart(2, '0') + 
                       now.getDate().toString().padStart(2, '0') + '-' + 
                       Math.floor(Math.random() * 10000).toString().padStart(4, '0');
      
      document.getElementById('reportId').textContent = reportId;
      document.getElementById('reportDate').textContent = now.toLocaleDateString('zh-TW');
      document.getElementById('reportTime').textContent = now.toLocaleTimeString('zh-TW');
      
      const audioPlayer = document.getElementById('audioPlayer');
      const duration = audioPlayer.duration || 0;
      document.getElementById('reportDuration').textContent = 
          `${Math.floor(duration / 60)}åˆ†${Math.floor(duration % 60)}ç§’`;
      
      // è¨ˆç®—ç¸½åˆ†
      const totalScore = Object.values(currentAnalysisData).reduce((sum, item) => sum + item.score, 0);
      document.getElementById('reportTotalScore').textContent = totalScore.toFixed(1);
      
      let scoreLevel = '';
      let scoreDescription = '';
      if (totalScore >= 90) {
          scoreLevel = 'å„ªç§€';
          scoreDescription = 'èªéŸ³åŠŸèƒ½æ­£å¸¸æˆ–æ¥è¿‘æ­£å¸¸ï¼Œè«‹ç¹¼çºŒä¿æŒè‰¯å¥½çš„èªéŸ³ç¿’æ…£';
      } else if (totalScore >= 75) {
          scoreLevel = 'è‰¯å¥½';
          scoreDescription = 'è¼•åº¦èªéŸ³éšœç¤™ï¼Œæ—¥å¸¸æºé€šç„¡ç¤™ï¼Œå»ºè­°æŒçºŒé€²è¡ŒèªéŸ³è¨“ç·´';
      } else if (totalScore >= 60) {
          scoreLevel = 'å°šå¯';
          scoreDescription = 'ä¸­åº¦èªéŸ³éšœç¤™ï¼Œéœ€æŒçºŒè¨“ç·´ä¸¦å®šæœŸè¿½è¹¤è©•ä¼°';
      } else {
          scoreLevel = 'éœ€åŠ å¼·';
          scoreDescription = 'é‡åº¦èªéŸ³éšœç¤™ï¼Œå»ºè­°å°‹æ±‚å°ˆæ¥­èªè¨€æ²»ç™‚å¸«å”åŠ©';
      }
      
      document.getElementById('reportScoreLevel').textContent = scoreLevel;
      document.getElementById('reportScoreDescription').textContent = scoreDescription;
      
      // ç”Ÿæˆè©³ç´°è¡¨æ ¼
      generateReportTable();
      
      // ç”Ÿæˆåœ–è¡¨
      generateReportChart();
      
      // ç”Ÿæˆå»ºè­°
      generateReportRecommendations(totalScore);
      
      document.getElementById('reportSection').classList.add('show');
      document.getElementById('reportSection').scrollIntoView({ behavior: 'smooth' });
  }
  
  // ç”Ÿæˆå ±å‘Šè¡¨æ ¼
  function generateReportTable() {
      const tbody = document.getElementById('reportDetailsTable');
      tbody.innerHTML = '';
      
      const parameters = [
          { key: 'f0', name: 'åŸºé » F0', max: 10 },
          { key: 'intensity', name: 'éŸ³é‡å¼·åº¦', max: 10 },
          { key: 'hnr', name: 'HNR è«§å™ªæ¯”', max: 15 },
          { key: 'jitter', name: 'Jitter é »ç‡å¾®æ“¾', max: 15 },
          { key: 'shimmer', name: 'Shimmer æŒ¯å¹…å¾®æ“¾', max: 15 },
          { key: 'f1', name: 'ç¬¬ä¸€å…±æŒ¯å³° F1', max: 10 },
          { key: 'f2', name: 'ç¬¬äºŒå…±æŒ¯å³° F2', max: 10 },
          { key: 'speechRate', name: 'èªé€Ÿ', max: 10 },
          { key: 'pause', name: 'åœé “æ¨¡å¼', max: 5 }
      ];
      
      parameters.forEach((param, index) => {
          const item = currentAnalysisData[param.key];
          const percentage = (item.score / param.max) * 100;
          const status = getStatusClass(percentage);
          const statusText = getStatusText(percentage);
          
          const row = document.createElement('tr');
          row.innerHTML = `
              <td>${index + 1}</td>
              <td><strong>${param.name}</strong></td>
              <td>${item.value} ${item.unit}</td>
              <td>${item.normalRange}</td>
              <td><strong>${item.score.toFixed(1)} / ${param.max}</strong></td>
              <td><span class="result-card-status ${status}">${statusText}</span></td>
          `;
          tbody.appendChild(row);
      });
      
      // æ·»åŠ ç¸½åˆ†è¡Œ
      const totalScore = Object.values(currentAnalysisData).reduce((sum, item) => sum + item.score, 0);
      const totalRow = document.createElement('tr');
      totalRow.style.background = '#f8f9fa';
      totalRow.style.fontWeight = '700';
      totalRow.innerHTML = `
          <td colspan="4" style="text-align: right;"><strong>ç¸½åˆ†</strong></td>
          <td colspan="2"><strong>${totalScore.toFixed(1)} / 100</strong></td>
      `;
      tbody.appendChild(totalRow);
  }
  
  // ç”Ÿæˆå ±å‘Šåœ–è¡¨
  function generateReportChart() {
      const canvas = document.getElementById('reportChart');
      const ctx = canvas.getContext('2d');
      
      const parameters = ['F0', 'éŸ³é‡', 'HNR', 'Jitter', 'Shimmer', 'F1', 'F2', 'èªé€Ÿ', 'åœé “'];
      const scores = [
          currentAnalysisData.f0.score / 10 * 100,
          currentAnalysisData.intensity.score / 10 * 100,
          currentAnalysisData.hnr.score / 15 * 100,
          currentAnalysisData.jitter.score / 15 * 100,
          currentAnalysisData.shimmer.score / 15 * 100,
          currentAnalysisData.f1.score / 10 * 100,
          currentAnalysisData.f2.score / 10 * 100,
          currentAnalysisData.speechRate.score / 10 * 100,
          currentAnalysisData.pause.score / 5 * 100
      ];
      
      const barWidth = 70;
      const barSpacing = 20;
      const startX = 50;
      const startY = 350;
      const maxHeight = 300;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // ç¹ªè£½èƒŒæ™¯ç¶²æ ¼
      ctx.strokeStyle = '#ecf0f1';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 10; i++) {
          const y = startY - (maxHeight / 10) * i;
          ctx.beginPath();
          ctx.moveTo(startX, y);
          ctx.lineTo(canvas.width - 20, y);
          ctx.stroke();
          
          ctx.fillStyle = '#7f8c8d';
          ctx.font = '12px Arial';
          ctx.textAlign = 'right';
          ctx.fillText((i * 10) + '%', startX - 10, y + 4);
      }
      
      // ç¹ªè£½æŸ±ç‹€åœ–
      parameters.forEach((param, index) => {
          const x = startX + index * (barWidth + barSpacing);
          const height = (scores[index] / 100) * maxHeight;
          const y = startY - height;
          
          // ç¹ªè£½æŸ±å­
          const gradient = ctx.createLinearGradient(x, y, x, startY);
          if (scores[index] >= 85) {
              gradient.addColorStop(0, '#27ae60');
              gradient.addColorStop(1, '#2ecc71');
          } else if (scores[index] >= 70) {
              gradient.addColorStop(0, '#2980b9');
              gradient.addColorStop(1, '#3498db');
          } else if (scores[index] >= 50) {
              gradient.addColorStop(0, '#f39c12');
              gradient.addColorStop(1, '#f1c40f');
          } else {
              gradient.addColorStop(0, '#c0392b');
              gradient.addColorStop(1, '#e74c3c');
          }
          
          ctx.fillStyle = gradient;
          ctx.fillRect(x, y, barWidth, height);
          
          // ç¹ªè£½é‚Šæ¡†
          ctx.strokeStyle = '#2c3e50';
          ctx.lineWidth = 2;
          ctx.strokeRect(x, y, barWidth, height);
          
          // ç¹ªè£½æ•¸å€¼
          ctx.fillStyle = '#2c3e50';
          ctx.font = 'bold 14px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(scores[index].toFixed(0) + '%', x + barWidth / 2, y - 10);
          
          // ç¹ªè£½æ¨™ç±¤
          ctx.save();
          ctx.translate(x + barWidth / 2, startY + 15);
          ctx.rotate(-Math.PI / 6);
          ctx.fillStyle = '#2c3e50';
          ctx.font = '13px Arial';
          ctx.textAlign = 'right';
          ctx.fillText(param, 0, 0);
          ctx.restore();
      });
      
      // ç¹ªè£½æ¨™é¡Œ
      ctx.fillStyle = '#2c3e50';
      ctx.font = 'bold 18px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('å„é …åƒæ•¸è©•åˆ†ç™¾åˆ†æ¯”', canvas.width / 2, 30);
  }
  
  // ç”Ÿæˆå»ºè­°
  function generateReportRecommendations(totalScore) {
      const list = document.getElementById('reportRecommendationsList');
      list.innerHTML = '';
      
      const recommendations = [];
      
      if (currentAnalysisData.intensity.score < 7) {
          recommendations.push('éŸ³é‡è¨“ç·´ï¼šå»ºè­°é€²è¡ŒLSVT LOUDç™‚æ³•ï¼Œæ¯å¤©ç·´ç¿’å¤§è²ç™¼éŸ³ï¼Œå¢å¼·è²å¸¶åŠ›é‡');
      }
      
      if (currentAnalysisData.hnr.score < 12) {
          recommendations.push('éŸ³è³ªæ”¹å–„ï¼šç·´ç¿’è…¹å¼å‘¼å¸ï¼Œæ”¾é¬†å–‰éƒ¨è‚Œè‚‰ï¼Œæ¸›å°‘æ°£æ¯è²å’Œå˜¶å•');
      }
      
      if (currentAnalysisData.jitter.score < 12 || currentAnalysisData.shimmer.score < 12) {
          recommendations.push('ç©©å®šæ€§è¨“ç·´ï¼šæŒçºŒç™¼ /a/ éŸ³5-10ç§’ï¼Œæ¯å¤©ç·´ç¿’3-5æ¬¡ï¼Œæå‡è²éŸ³ç©©å®šæ€§');
      }
      
      if (currentAnalysisData.f1.score < 7 || currentAnalysisData.f2.score < 7) {
          recommendations.push('æ§‹éŸ³è¨“ç·´ï¼šç·´ç¿’èª‡å¼µçš„å£è…”å‹•ä½œï¼Œæ¸…æ™°ç™¼å‡ºæ¯å€‹å…ƒéŸ³å’Œè¼”éŸ³');
      }
      
      if (currentAnalysisData.speechRate.score < 7) {
          recommendations.push('èªé€Ÿèª¿æ•´ï¼šä½¿ç”¨ç¯€æ‹å™¨è¼”åŠ©ï¼Œç·´ç¿’ç©©å®šç¯€å¥çš„èªªè©±é€Ÿåº¦');
      }
      
      if (currentAnalysisData.pause.score < 4) {
          recommendations.push('éŸ»å¾‹è¨“ç·´ï¼šç·´ç¿’åœ¨é©ç•¶ä½ç½®åœé “ï¼Œä½¿ç”¨æ¨™é»ç¬¦è™Ÿä½œç‚ºåœé “æŒ‡å¼•');
      }
      
      if (totalScore >= 90) {
          recommendations.push('ç¶­æŒè¨“ç·´ï¼šç¹¼çºŒä¿æŒæ¯å¤©15-20åˆ†é˜çš„èªéŸ³ç·´ç¿’ï¼Œéå›ºæˆæœ');
      } else if (totalScore >= 75) {
          recommendations.push('æŒçºŒé€²æ­¥ï¼šå»ºè­°æ¯å¤©è¨“ç·´30åˆ†é˜ï¼Œæ¯2é€±é€²è¡Œä¸€æ¬¡è©•ä¼°');
      } else if (totalScore >= 60) {
          recommendations.push('åŠ å¼·è¨“ç·´ï¼šå»ºè­°æ¯å¤©è¨“ç·´2æ¬¡ï¼Œæ¯æ¬¡30åˆ†é˜ï¼Œæ¯é€±è©•ä¼°ä¸€æ¬¡');
      } else {
          recommendations.push('å°ˆæ¥­å”åŠ©ï¼šå»ºè­°å„˜å¿«è«®è©¢èªè¨€æ²»ç™‚å¸«ï¼Œåˆ¶å®šå€‹äººåŒ–å¯†é›†æ²»ç™‚è¨ˆç•«');
      }
      
      recommendations.push('å®šæœŸè©•ä¼°ï¼šå»ºè­°æ¯2-4é€±é€²è¡Œä¸€æ¬¡å®Œæ•´è©•ä¼°ï¼Œè¿½è¹¤é€²æ­¥æƒ…æ³');
      recommendations.push('è¨˜éŒ„è¿½è¹¤ï¼šä¿å­˜æ¯æ¬¡è©•ä¼°å ±å‘Šï¼Œè§€å¯Ÿé•·æœŸè¶¨å‹¢è®ŠåŒ–');
      
      recommendations.forEach(rec => {
          const li = document.createElement('li');
          li.textContent = rec;
          list.appendChild(li);
      });
  }
  
  // åˆ—å°å ±å‘Š
  function printReport() {
      window.print();
  }
  
  // ä¸‹è¼‰PDF
  function downloadReport() {
      alert('PDFä¸‹è¼‰åŠŸèƒ½éœ€è¦æ•´åˆ jsPDF æˆ–é¡ä¼¼åº«ã€‚\n\nåœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæ­¤åŠŸèƒ½æœƒå°‡å ±å‘Šè½‰æ›ç‚ºPDFæ ¼å¼ä¸¦ä¸‹è¼‰ã€‚');
      
      // å¯¦éš›å¯¦ç¾ç¯„ä¾‹ï¼ˆéœ€è¦å¼•å…¥ jsPDF å’Œ html2canvasï¼‰:
      // const element = document.getElementById('reportSection');
      // html2canvas(element).then(canvas => {
      //     const imgData = canvas.toDataURL('image/png');
      //     const pdf = new jsPDF('p', 'mm', 'a4');
      //     const imgWidth = 210;
      //     const imgHeight = canvas.height * imgWidth / canvas.width;
      //     pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
      //     pdf.save('èªéŸ³è©•ä¼°å ±å‘Š.pdf');
      // });
  }
  
  // éƒµä»¶ç™¼é€
  function emailReport() {
      const reportId = document.getElementById('reportId').textContent;
      const totalScore = document.getElementById('reportTotalScore').textContent;
      const date = document.getElementById('reportDate').textContent;
      
      const subject = encodeURIComponent(`å¸•é‡‘æ£®ç—…èªéŸ³è©•ä¼°å ±å‘Š - ${reportId}`);
      const body = encodeURIComponent(
          `èªéŸ³è©•ä¼°å ±å‘Š\n\n` +
          `å ±å‘Šç·¨è™Ÿï¼š${reportId}\n` +
          `è©•ä¼°æ—¥æœŸï¼š${date}\n` +
          `ç¸½é«”è©•åˆ†ï¼š${totalScore} åˆ†\n\n` +
          `è©³ç´°å ±å‘Šè«‹è¦‹é™„ä»¶ã€‚`
      );
      
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
  }
  
  // æ–°è©•ä¼°
  function newAssessment() {
      if (confirm('ç¢ºå®šè¦é–‹å§‹æ–°çš„è©•ä¼°å—ï¼Ÿç•¶å‰æ•¸æ“šå°‡è¢«æ¸…é™¤ã€‚')) {
          location.reload();
      }
  }
  </script>
  </body>
  </html>
