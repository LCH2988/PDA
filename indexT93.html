<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå° - æè¡€æ´»å‹•ç®¡ç†ç³»çµ±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 20px;
            font-size: 16px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        /* ç™»å…¥ç•«é¢ */
        .login-section {
            padding: 60px 40px;
            text-align: center;
        }
        .login-box {
            max-width: 400px;
            margin: 0 auto;
        }
        .login-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        .login-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #666;
        }
        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102,126,234,0.3);
        }
        .login-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            margin-top: 10px;
        }
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102,126,234,0.4);
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        
        /* ç®¡ç†ä»‹é¢ */
        .admin-section {
            display: none;
        }
        .admin-section.show {
            display: block;
        }
        .admin-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-user {
            font-weight: bold;
            color: #667eea;
        }
        .logout-btn {
            background: #dc3545;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .tab-navigation {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #ddd;
        }
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stat-card.green {
            background: linear-gradient(135deg, #11998e, #38ef7d);
        }
        .stat-card.orange {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }
        .stat-card.blue {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }
        
        /* åˆ†äº«æ–¹å¼é¸æ“‡å™¨ */
        .share-method-selector {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .share-method-selector h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        .share-method-options {
            display: flex;
            gap: 10px;
        }
        .share-method-option {
            flex: 1;
        }
        .share-method-option input[type="radio"] {
            display: none;
        }
        .share-method-option label {
            display: block;
            padding: 12px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .share-method-option input[type="radio"]:checked + label {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* åˆ†äº«é è¦½ */
        .share-preview {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        .share-preview.show {
            display: block;
        }
        .share-preview-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        .share-preview-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }
        .share-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .action-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .action-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .action-btn.success {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
        }
        .action-btn.warning {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }
        .action-btn.secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .data-table thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .data-table tbody tr:hover {
            background: #f8f9fa;
        }
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .badge.success { background: #d4edda; color: #155724; }
        .badge.warning { background: #fff3cd; color: #856404; }
        .badge.danger { background: #f8d7da; color: #721c24; }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .modal-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        .modal-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #333;
        }
        .modal-message {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin: 0 5px;
        }
        .modal-btn.primary {
            background: #667eea;
            color: white;
        }
        .modal-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        @media (max-width: 768px) {
            body { padding: 10px; font-size: 14px; }
            .header h1 { font-size: 1.5em; }
            .login-section { padding: 40px 20px; }
            .tab-content { padding: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .action-buttons { grid-template-columns: 1fr; }
            .data-table { font-size: 0.9em; }
            .data-table th,
            .data-table td { padding: 8px; }
            .share-method-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” ç®¡ç†å¾Œå°</h1>
            <p>æè¡€æ´»å‹•ç®¡ç†ç³»çµ±</p>
        </div>

        <!-- ç™»å…¥ç•«é¢ -->
        <div class="login-section" id="loginSection">
            <div class="login-box">
                <div class="login-icon">ğŸ”’</div>
                <h2 class="login-title">ç®¡ç†å“¡ç™»å…¥</h2>
                <form id="loginForm">
                    <div class="input-group">
                        <label for="username">å¸³è™Ÿ</label>
                        <input type="text" id="username" placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡å¸³è™Ÿ" required>
                    </div>
                    <div class="input-group">
                        <label for="password">å¯†ç¢¼</label>
                        <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
                    </div>
                    <button type="submit" class="login-btn">ç™»å…¥</button>
                    <div class="error-message" id="errorMessage"></div>
                </form>
            </div>
        </div>

        <!-- ç®¡ç†ä»‹é¢ -->
        <div class="admin-section" id="adminSection">
            <div class="admin-header">
                <div class="admin-user">
                    ğŸ‘¤ ç®¡ç†å“¡ï¼š<span id="adminName">Admin</span>
                </div>
                <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
            </div>

            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchAdminTab('dashboard')">ğŸ“Š å„€è¡¨æ¿</button>
                <button class="tab-btn" onclick="switchAdminTab('volunteers')">ğŸ™‹ å¿—å·¥ç®¡ç†</button>
                <button class="tab-btn" onclick="switchAdminTab('sponsors')">ğŸ’° è´ŠåŠ©ç®¡ç†</button>
                <button class="tab-btn" onclick="switchAdminTab('reports')">ğŸ“ˆ å ±è¡¨åŒ¯å‡º</button>
            </div>

            <!-- å„€è¡¨æ¿ -->
            <div class="tab-content active" id="dashboardTab">
                <h2 style="margin-bottom: 20px;">ğŸ“Š çµ±è¨ˆæ¦‚è¦½</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ç¸½å¿—å·¥äººæ•¸</div>
                        <div class="stat-value" id="totalVolunteers">0</div>
                        <div class="stat-label">äºº</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-label">å…¨å¤©ç­</div>
                        <div class="stat-value" id="allDayVolunteers">0</div>
                        <div class="stat-label">äºº</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">ä¸Šåˆç­</div>
                        <div class="stat-value" id="morningVolunteers">0</div>
                        <div class="stat-label">äºº</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-label">ä¸‹åˆç­</div>
                        <div class="stat-value" id="afternoonVolunteers">0</div>
                        <div class="stat-label">äºº</div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                        <div class="stat-label">è´ŠåŠ©äººæ•¸</div>
                        <div class="stat-value" id="totalSponsors">0</div>
                        <div class="stat-label">äºº</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #fa709a, #fee140);">
                        <div class="stat-label">ç¸½è´ŠåŠ©é‡‘é¡</div>
                        <div class="stat-value" id="totalAmount">$0</div>
                        <div class="stat-label">å…ƒ</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 15px;">å¿«é€Ÿæ“ä½œ</h3>
                
                <!-- åˆ†äº«æ–¹å¼é¸æ“‡å™¨ -->
                <div class="share-method-selector">
                    <h4>ğŸ“¤ é¸æ“‡åˆ†äº«æ–¹å¼</h4>
                    <div class="share-method-options">
                        <div class="share-method-option">
                            <input type="radio" id="shareMethodPersonal" name="shareMethod" value="personal" checked>
                            <label for="shareMethodPersonal">
                                ğŸ‘¤ ä»¥å€‹äººèº«åˆ†åˆ†äº«<br>
                                <small style="opacity: 0.8;">ä½¿ç”¨æ‚¨çš„ LINE å¸³è™Ÿ</small>
                            </label>
                        </div>
                        <div class="share-method-option">
                            <input type="radio" id="shareMethodBot" name="shareMethod" value="bot">
                            <label for="shareMethodBot">
                                ğŸ¤– ä»¥ Bot èº«åˆ†åˆ†äº«<br>
                                <small style="opacity: 0.8;">ä½¿ç”¨ç³»çµ± Bot</small>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="action-btn primary" onclick="prepareVolunteerShare()">
                        ğŸ“¤ åˆ†äº«å¿—å·¥ç‹€æ…‹
                    </button>
                    <button class="action-btn success" onclick="prepareSponsorShare()">
                        ğŸ“¤ åˆ†äº«è´ŠåŠ©ç‹€æ…‹
                    </button>
                    <button class="action-btn warning" onclick="refreshDashboard()">
                        ğŸ”„ é‡æ–°æ•´ç†
                    </button>
                </div>

                <!-- åˆ†äº«é è¦½å€å¡Š -->
                <div class="share-preview" id="sharePreview">
                    <div class="share-preview-title">ğŸ“ åˆ†äº«é è¦½</div>
                    <div class="share-preview-content" id="sharePreviewContent"></div>
                    <div class="share-buttons">
                        <button class="action-btn primary" onclick="confirmShare()">
                            âœ… ç¢ºèªåˆ†äº«
                        </button>
                        <button class="action-btn secondary" onclick="cancelShare()">
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- å¿—å·¥ç®¡ç† -->
            <div class="tab-content" id="volunteersTab">
                <h2 style="margin-bottom: 20px;">ğŸ™‹ å¿—å·¥ç®¡ç†</h2>
                
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="loadVolunteers()">
                        ğŸ”„ é‡æ–°è¼‰å…¥
                    </button>
                    <button class="action-btn success" onclick="exportVolunteers()">
                        ğŸ“¥ åŒ¯å‡º Excel
                    </button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="data-table" id="volunteersTable">
                        <thead>
                            <tr>
                                <th>åºè™Ÿ</th>
                                <th>å§“å</th>
                                <th>é›»è©±</th>
                                <th>ç­æ¬¡</th>
                                <th>åˆé¤</th>
                                <th>å ±åæ™‚é–“</th>
                                <th>ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="volunteersTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    è¼‰å…¥ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- è´ŠåŠ©ç®¡ç† -->
            <div class="tab-content" id="sponsorsTab">
                <h2 style="margin-bottom: 20px;">ğŸ’° è´ŠåŠ©ç®¡ç†</h2>
                
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="loadSponsors()">
                        ğŸ”„ é‡æ–°è¼‰å…¥
                    </button>
                    <button class="action-btn success" onclick="exportSponsors()">
                        ğŸ“¥ åŒ¯å‡º Excel
                    </button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="data-table" id="sponsorsTable">
                        <thead>
                            <tr>
                                <th>åºè™Ÿ</th>
                                <th>å§“å</th>
                                <th>é›»è©±</th>
                                <th>é‡‘é¡</th>
                                <th>è´ŠåŠ©æ™‚é–“</th>
                                <th>ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="sponsorsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px;">
                                    è¼‰å…¥ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å ±è¡¨åŒ¯å‡º -->
            <div class="tab-content" id="reportsTab">
                <h2 style="margin-bottom: 20px;">ğŸ“ˆ å ±è¡¨åŒ¯å‡º</h2>
                
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="exportFullReport()">
                        ğŸ“Š å®Œæ•´å ±è¡¨
                    </button>
                    <button class="action-btn success" onclick="exportVolunteerReport()">
                        ğŸ™‹ å¿—å·¥å ±è¡¨
                    </button>
                    <button class="action-btn warning" onclick="exportSponsorReport()">
                        ğŸ’° è´ŠåŠ©å ±è¡¨
                    </button>
                    <button class="action-btn" style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white;" onclick="exportStatisticsReport()">
                        ğŸ“ˆ çµ±è¨ˆå ±è¡¨
                    </button>
                </div>

                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“‹ å ±è¡¨èªªæ˜</h3>
                    <ul style="line-height: 2; color: #666;">
                        <li><strong>å®Œæ•´å ±è¡¨ï¼š</strong>åŒ…å«æ‰€æœ‰å¿—å·¥å’Œè´ŠåŠ©è³‡æ–™</li>
                        <li><strong>å¿—å·¥å ±è¡¨ï¼š</strong>å¿—å·¥å ±åæ˜ç´°ã€ç­æ¬¡çµ±è¨ˆã€åˆé¤çµ±è¨ˆ</li>
                        <li><strong>è´ŠåŠ©å ±è¡¨ï¼š</strong>è´ŠåŠ©æ˜ç´°ã€é‡‘é¡çµ±è¨ˆã€èŠ³åéŒ„</li>
                        <li><strong>çµ±è¨ˆå ±è¡¨ï¼š</strong>å„é …æ•¸æ“šçµ±è¨ˆåœ–è¡¨</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨Šæ¯å½ˆçª— -->
    <div class="modal" id="messageModal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">âœ…</div>
            <h3 class="modal-title" id="modalTitle">æ“ä½œæˆåŠŸ</h3>
            <p class="modal-message" id="modalMessage">æ“ä½œå·²å®Œæˆ</p>
            <button class="modal-btn primary" onclick="closeModal()">ç¢ºå®š</button>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // âš ï¸ è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš›å€¼
        const liffId = "2007905012-dQfXClGM";
        const gasUrl = "https://script.google.com/macros/s/AKfycbzwxq4asZGZQjhSlCAvjfEYMHIVfNX1V726A7dVlpO_qol5qme7-3FgDWZ7M8qLpGSE1w/exec";
        
        const ADMIN_PASSWORD = "admin123";
        let isLoggedIn = false;
        let userProfile = null;
        let volunteersData = [];
        let sponsorsData = [];
        let pendingShareMessage = '';
        let pendingShareType = '';

        // LIFF åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('åˆå§‹åŒ–ç®¡ç†å¾Œå°...');
            
            liff.init({ liffId: liffId })
                .then(() => {
                    console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');
                    if (liff.isLoggedIn()) {
                        return liff.getProfile();
                    } else {
                        liff.login();
                        return null;
                    }
                })
                .then((profile) => {
                    if (profile) {
                        userProfile = profile;
                        console.log('ç”¨æˆ¶è³‡æ–™:', profile);
                    }
                })
                .catch((err) => {
                    console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', err);
                });

            // ç™»å…¥è¡¨å–®
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
        });

        // ç™»å…¥è™•ç†
        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMessage');

            if (username === 'admin' && password === ADMIN_PASSWORD) {
                isLoggedIn = true;
                document.getElementById('adminName').textContent = username;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminSection').classList.add('show');
                
                // è¼‰å…¥å„€è¡¨æ¿è³‡æ–™
                loadDashboard();
            } else {
                errorMsg.textContent = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
                errorMsg.classList.add('show');
                setTimeout(() => {
                    errorMsg.classList.remove('show');
                }, 3000);
            }
        }

        // ç™»å‡º
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                isLoggedIn = false;
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('adminSection').classList.remove('show');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }
        }

        // åˆ‡æ›åˆ†é 
        function switchAdminTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // è¼‰å…¥å°æ‡‰è³‡æ–™
            if (tabName === 'volunteers') {
                loadVolunteers();
            } else if (tabName === 'sponsors') {
                loadSponsors();
            }
        }

        // è¼‰å…¥å„€è¡¨æ¿
        async function loadDashboard() {
            try {
                const [volunteersResult, sponsorsResult] = await Promise.all([
                    callAPI({ action: 'getVolunteerList' }),
                    callAPI({ action: 'getSponsorList' })
                ]);

                if (volunteersResult.success) {
                    volunteersData = volunteersResult.volunteers || [];
                    updateVolunteerStats();
                }

                if (sponsorsResult.success) {
                    sponsorsData = sponsorsResult.sponsors || [];
                    updateSponsorStats();
                }
            } catch (error) {
                console.error('è¼‰å…¥å„€è¡¨æ¿éŒ¯èª¤:', error);
            }
        }

        // æ›´æ–°å¿—å·¥çµ±è¨ˆ
        function updateVolunteerStats() {
            const total = volunteersData.length;
            const allDay = volunteersData.filter(v => v.workShift.includes('å…¨å¤©ç­')).length;
            const morning = volunteersData.filter(v => v.workShift.includes('ä¸Šåˆç­')).length;
            const afternoon = volunteersData.filter(v => v.workShift.includes('ä¸‹åˆç­')).length;

            document.getElementById('totalVolunteers').textContent = total;
            document.getElementById('allDayVolunteers').textContent = allDay;
            document.getElementById('morningVolunteers').textContent = morning;
            document.getElementById('afternoonVolunteers').textContent = afternoon;
        }

        // æ›´æ–°è´ŠåŠ©çµ±è¨ˆ
        function updateSponsorStats() {
            const total = sponsorsData.length;
            const totalAmount = sponsorsData.reduce((sum, s) => sum + (parseInt(s.amount) || 0), 0);

            document.getElementById('totalSponsors').textContent = total;
            document.getElementById('totalAmount').textContent = '$' + totalAmount.toLocaleString();
        }

        // é‡æ–°æ•´ç†å„€è¡¨æ¿
        async function refreshDashboard() {
            showLoading('é‡æ–°æ•´ç†ä¸­...');
            await loadDashboard();
            showMessage('success', 'é‡æ–°æ•´ç†å®Œæˆ', 'è³‡æ–™å·²æ›´æ–°');
        }

        // ==================== æ–°å¢ï¼šåˆ†äº«åŠŸèƒ½ ====================

        // æº–å‚™åˆ†äº«å¿—å·¥ç‹€æ…‹
        async function prepareVolunteerShare() {
            try {
                showLoading('æº–å‚™è³‡æ–™ä¸­...');
                
                const result = await callAPI({ action: 'getVolunteerList' });
                
                if (!result.success) {
                    showMessage('error', 'å–å¾—è³‡æ–™å¤±æ•—', result.message);
                    return;
                }
                
                volunteersData = result.volunteers || [];
                const shiftLimits = await getShiftLimits();
                
                const message = generateVolunteerShareMessage(volunteersData, shiftLimits);
                
                pendingShareMessage = message;
                pendingShareType = 'volunteer';
                
                showSharePreview(message);
                
            } catch (error) {
                console.error('æº–å‚™åˆ†äº«éŒ¯èª¤:', error);
                showMessage('error', 'æº–å‚™å¤±æ•—', error.message);
            }
        }

        // æº–å‚™åˆ†äº«è´ŠåŠ©ç‹€æ…‹
        async function prepareSponsorShare() {
            try {
                showLoading('æº–å‚™è³‡æ–™ä¸­...');
                
                const result = await callAPI({ action: 'getSponsorList' });
                
                if (!result.success) {
                    showMessage('error', 'å–å¾—è³‡æ–™å¤±æ•—', result.message);
                    return;
                }
                
                sponsorsData = result.sponsors || [];
                const message = generateSponsorShareMessage(sponsorsData);
                
                pendingShareMessage = message;
                pendingShareType = 'sponsor';
                
                showSharePreview(message);
                
            } catch (error) {
                console.error('æº–å‚™åˆ†äº«éŒ¯èª¤:', error);
                showMessage('error', 'æº–å‚™å¤±æ•—', error.message);
            }
        }

        // ç”Ÿæˆå¿—å·¥åˆ†äº«è¨Šæ¯
        function generateVolunteerShareMessage(volunteers, shiftLimits) {
            const shiftCounts = {};
            volunteers.forEach(v => {
                shiftCounts[v.workShift] = (shiftCounts[v.workShift] || 0) + 1;
            });
            
            let message = `ğŸ“Š æè¡€æ´»å‹•å¿—å·¥æ’ç­ç‹€æ…‹

ğŸ“… æ´»å‹•æ—¥æœŸï¼š2026/3/21 (å…­)
â° æ´»å‹•æ™‚é–“ï¼š09:00ï½17:00

ğŸ‘¥ ç¸½å¿—å·¥äººæ•¸ï¼š${volunteers.length} äºº

å„ç­æ¬¡äººæ•¸çµ±è¨ˆï¼š\n`;

            message += '\nğŸŒŸ å…¨å¤©ç­ (08:30ï½17:00)\n';
            ['å…¨å¤©ç­-å ±åˆ°çµ„', 'å…¨å¤©ç­-é ˜è´ˆå“çµ„', 'å…¨å¤©ç­-æŠ½è™Ÿå«è™Ÿå¼•å°çµ„', 'å…¨å¤©ç­-ç¾©è³£çµ„'].forEach(shift => {
                const count = shiftCounts[shift] || 0;
                const max = shiftLimits[shift] || 5;
                const percentage = Math.round(count / max * 100);
                const status = count >= max ? 'âœ…' : count > 0 ? 'âš ï¸' : 'âŒ';
                message += `${status} ${shift.replace('å…¨å¤©ç­-', '')}ï¼š${count}/${max} (${percentage}%)\n`;
            });
            
            message += '\nâ˜€ï¸ ä¸Šåˆç­ (08:30ï½13:00)\n';
            ['ä¸Šåˆç­-å ±åˆ°çµ„', 'ä¸Šåˆç­-é ˜è´ˆå“çµ„', 'ä¸Šåˆç­-æŠ½è™Ÿå«è™Ÿå¼•å°çµ„', 'ä¸Šåˆç­-ä½ˆç½®çµ„', 'ä¸Šåˆç­-ç¾©è³£çµ„'].forEach(shift => {
                const count = shiftCounts[shift] || 0;
                const max = shiftLimits[shift] || 5;
                const percentage = Math.round(count / max * 100);
                const status = count >= max ? 'âœ…' : count > 0 ? 'âš ï¸' : 'âŒ';
                message += `${status} ${shift.replace('ä¸Šåˆç­-', '')}ï¼š${count}/${max} (${percentage}%)\n`;
            });
            
            message += '\nğŸŒ™ ä¸‹åˆç­ (13:00ï½17:00)\n';
            ['ä¸‹åˆç­-å ±åˆ°çµ„', 'ä¸‹åˆç­-é ˜è´ˆå“çµ„', 'ä¸‹åˆç­-æŠ½è™Ÿå«è™Ÿå¼•å°çµ„', 'ä¸‹åˆç­-æ”¶æ‹¾çµ„', 'ä¸‹åˆç­-ç¾©è³£çµ„'].forEach(shift => {
                const count = shiftCounts[shift] || 0;
                const max = shiftLimits[shift] || 5;
                const percentage = Math.round(count / max * 100);
                const status = count >= max ? 'âœ…' : count > 0 ? 'âš ï¸' : 'âŒ';
                message += `${status} ${shift.replace('ä¸‹åˆç­-', '')}ï¼š${count}/${max} (${percentage}%)\n`;
            });
            
            message += `\nğŸ“ æ›´æ–°æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`;
            message += '\n\nè¼¸å…¥ã€Œå¿—å·¥å ±åã€ç«‹å³åŠ å…¥æˆ‘å€‘ï¼';
            
            return message;
        }

        // ç”Ÿæˆè´ŠåŠ©åˆ†äº«è¨Šæ¯
        function generateSponsorShareMessage(sponsors) {
            const totalAmount = sponsors.reduce((sum, s) => sum + (parseInt(s.amount) || 0), 0);
            const avgAmount = sponsors.length > 0 ? Math.round(totalAmount / sponsors.length) : 0;
            
            let message = `ğŸ’° æè¡€æ´»å‹•è´ŠåŠ©çµ±è¨ˆ

ğŸ“… æ´»å‹•æ—¥æœŸï¼š2026/3/21 (å…­)

ğŸ“Š è´ŠåŠ©çµ±è¨ˆï¼š
ğŸ‘¥ è´ŠåŠ©äººæ•¸ï¼š${sponsors.length} äºº
ğŸ’µ ç¸½è´ŠåŠ©é‡‘é¡ï¼šNT$ ${totalAmount.toLocaleString()}
ğŸ“ˆ å¹³å‡è´ŠåŠ©ï¼šNT$ ${avgAmount.toLocaleString()}

ğŸ† æ„Ÿè¬èŠ³åéŒ„ï¼ˆä¾è´ŠåŠ©æ™‚é–“ï¼‰ï¼š\n`;

            sponsors.slice(0, 10).forEach((s, index) => {
                message += `${index + 1}. ${s.name} - NT$ ${parseInt(s.amount).toLocaleString()}\n`;
            });
            
            if (sponsors.length > 10) {
                message += `... åŠå…¶ä»– ${sponsors.length - 10} ä½å–„å¿ƒäººå£«\n`;
            }
            
            message += `\nğŸ“ æ›´æ–°æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`;
            message += '\n\næ„Ÿè¬æ‰€æœ‰è´ŠåŠ©è€…çš„æ”¯æŒï¼ğŸ™';
            message += '\nè¼¸å…¥ã€Œæ´»å‹•è´ŠåŠ©ã€ä¸€èµ·æ”¯æŒå…¬ç›Šï¼';
            
            return message;
        }

        // é¡¯ç¤ºåˆ†äº«é è¦½
        function showSharePreview(message) {
            document.getElementById('sharePreviewContent').textContent = message;
            document.getElementById('sharePreview').classList.add('show');
            closeModal();
        }

        // å–æ¶ˆåˆ†äº«
        function cancelShare() {
            document.getElementById('sharePreview').classList.remove('show');
            pendingShareMessage = '';
            pendingShareType = '';
        }

        // ç¢ºèªåˆ†äº«
        async function confirmShare() {
            const shareMethod = document.querySelector('input[name="shareMethod"]:checked').value;
                    
            if (shareMethod === 'personal') {
                // ä½¿ç”¨å€‹äºº LIFF èº«åˆ†åˆ†äº«
                await shareAsPersonal();
            } else {
                // ä½¿ç”¨ Bot èº«åˆ†åˆ†äº«
                await shareAsBot();
            }
        }

        // ä»¥å€‹äººèº«åˆ†åˆ†äº«
        async function shareAsPersonal() {
            try {
                if (!liff.isInClient()) {
                    showMessage('warning', 'ç„¡æ³•åˆ†äº«', 'è«‹åœ¨ LINE æ‡‰ç”¨ç¨‹å¼ä¸­é–‹å•Ÿæ­¤é é¢');
                    return;
                }

                // æª¢æŸ¥æ˜¯å¦æ”¯æ´ shareTargetPicker
                if (!liff.isApiAvailable('shareTargetPicker')) {
                    showMessage('warning', 'ä¸æ”¯æ´', 'æ‚¨çš„ LINE ç‰ˆæœ¬ä¸æ”¯æ´æ­¤åŠŸèƒ½ï¼Œè«‹æ›´æ–° LINE æ‡‰ç”¨ç¨‹å¼');
                    return;
                }

                showLoading('æº–å‚™åˆ†äº«...');

                // ä½¿ç”¨ LIFF shareTargetPicker
                const result = await liff.shareTargetPicker([
                    {
                        type: 'text',
                        text: pendingShareMessage
                    }
                ]);

                if (result) {
                    showMessage('success', 'åˆ†äº«æˆåŠŸ', 'è¨Šæ¯å·²æˆåŠŸåˆ†äº«');
                    cancelShare();
                } else {
                    showMessage('info', 'å·²å–æ¶ˆ', 'æ‚¨å–æ¶ˆäº†åˆ†äº«');
                }

            } catch (error) {
                console.error('å€‹äººåˆ†äº«éŒ¯èª¤:', error);
                
                if (error.code === 'INVALID_ARGUMENT') {
                    showMessage('error', 'åˆ†äº«å¤±æ•—', 'è¨Šæ¯æ ¼å¼éŒ¯èª¤');
                } else if (error.code === 'FORBIDDEN') {
                    showMessage('error', 'åˆ†äº«å¤±æ•—', 'æ²’æœ‰åˆ†äº«æ¬Šé™');
                } else {
                    showMessage('error', 'åˆ†äº«å¤±æ•—', error.message || 'æœªçŸ¥éŒ¯èª¤');
                }
            }
        }

        // ä»¥ Bot èº«åˆ†åˆ†äº«
        async function shareAsBot() {
            try {
                showLoading('ç™¼é€ä¸­...');
                
                const action = pendingShareType === 'volunteer' 
                    ? 'shareVolunteerStatus' 
                    : 'shareSponsorStatus';
                
                const result = await callAPI({ 
                    action: action,
                    adminId: userProfile?.userId
                });
                
                if (result.success) {
                    showMessage('success', 'åˆ†äº«æˆåŠŸ', 'è¨Šæ¯å·²ç™¼é€åˆ°ç¾¤çµ„');
                    cancelShare();
                } else {
                    showMessage('error', 'åˆ†äº«å¤±æ•—', result.message);
                }
                
            } catch (error) {
                console.error('Bot åˆ†äº«éŒ¯èª¤:', error);
                showMessage('error', 'åˆ†äº«å¤±æ•—', error.message);
            }
        }

        // å–å¾—ç­æ¬¡è¨­å®š
        async function getShiftLimits() {
            try {
                const result = await callAPI({ action: 'getShiftSettings' });
                return result.success ? result.limits : getDefaultShiftLimits();
            } catch (error) {
                console.error('å–å¾—ç­æ¬¡è¨­å®šéŒ¯èª¤:', error);
                return getDefaultShiftLimits();
            }
        }

        function getDefaultShiftLimits() {
            return {
                "å…¨å¤©ç­-å ±åˆ°çµ„": 2,
                "å…¨å¤©ç­-é ˜è´ˆå“çµ„": 2,
                "å…¨å¤©ç­-æŠ½è™Ÿå«è™Ÿå¼•å°çµ„": 3,
                "å…¨å¤©ç­-ç¾©è³£çµ„": 2,
                "ä¸Šåˆç­-å ±åˆ°çµ„": 2,
                "ä¸Šåˆç­-é ˜è´ˆå“çµ„": 2,
                "ä¸Šåˆç­-æŠ½è™Ÿå«è™Ÿå¼•å°çµ„": 3,
                "ä¸Šåˆç­-ä½ˆç½®çµ„": 2,
                "ä¸Šåˆç­-ç¾©è³£çµ„": 2,
                "ä¸‹åˆç­-å ±åˆ°çµ„": 2,
                "ä¸‹åˆç­-é ˜è´ˆå“çµ„": 2,
                "ä¸‹åˆç­-æŠ½è™Ÿå«è™Ÿå¼•å°çµ„": 3,
                "ä¸‹åˆç­-æ”¶æ‹¾çµ„": 2,
                "ä¸‹åˆç­-ç¾©è³£çµ„": 2
            };
        }

        // ==================== å¿—å·¥ç®¡ç† ====================

        // è¼‰å…¥å¿—å·¥åå–®
        async function loadVolunteers() {
            try {
                showLoading('è¼‰å…¥ä¸­...');
                
                const result = await callAPI({ action: 'getVolunteerList' });
                
                if (result.success) {
                    volunteersData = result.volunteers || [];
                    renderVolunteersTable();
                    closeModal();
                } else {
                    showMessage('error', 'è¼‰å…¥å¤±æ•—', result.message);
                }
            } catch (error) {
                console.error('è¼‰å…¥å¿—å·¥åå–®éŒ¯èª¤:', error);
                showMessage('error', 'è¼‰å…¥å¤±æ•—', error.message);
            }
        }

        // æ¸²æŸ“å¿—å·¥è¡¨æ ¼
        function renderVolunteersTable() {
            const tbody = document.getElementById('volunteersTableBody');
            
            if (volunteersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">å°šç„¡å¿—å·¥å ±å</td></tr>';
                return;
            }

            let html = '';
            volunteersData.forEach((v, index) => {
                html += `
                    <tr>
                        <td>#V${v.registrationId}</td>
                        <td>${v.name}</td>
                        <td>${v.phone}</td>
                        <td>${v.workShift}</td>
                        <td>${v.lunch || 'ç„¡'}</td>
                        <td>${v.registrationTime}</td>
                        <td><span class="badge success">å·²å ±å</span></td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // åŒ¯å‡ºå¿—å·¥åå–®
        function exportVolunteers() {
            if (volunteersData.length === 0) {
                alert('ç›®å‰æ²’æœ‰å¿—å·¥è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            const data = volunteersData.map((v, index) => ({
                'åºè™Ÿ': '#V' + v.registrationId,
                'å§“å': v.name,
                'é›»è©±': v.phone,
                'å·¥ä½œç­æ¬¡': v.workShift,
                'åˆé¤éœ€æ±‚': v.lunch || 'ç„¡',
                'å‚™è¨»': v.remarks || '',
                'å ±åæ™‚é–“': v.registrationTime
            }));

            exportToExcel(data, 'å¿—å·¥å ±ååå–®_' + getDateString());
        }

        // ==================== è´ŠåŠ©ç®¡ç† ====================

        // è¼‰å…¥è´ŠåŠ©åå–®
        async function loadSponsors() {
            try {
                showLoading('è¼‰å…¥ä¸­...');
                
                const result = await callAPI({ action: 'getSponsorList' });
                
                if (result.success) {
                    sponsorsData = result.sponsors || [];
                    renderSponsorsTable();
                    closeModal();
                } else {
                    showMessage('error', 'è¼‰å…¥å¤±æ•—', result.message);
                }
            } catch (error) {
                console.error('è¼‰å…¥è´ŠåŠ©åå–®éŒ¯èª¤:', error);
                showMessage('error', 'è¼‰å…¥å¤±æ•—', error.message);
            }
        }

        // æ¸²æŸ“è´ŠåŠ©è¡¨æ ¼
        function renderSponsorsTable() {
            const tbody = document.getElementById('sponsorsTableBody');
            
            if (sponsorsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">å°šç„¡è´ŠåŠ©è¨˜éŒ„</td></tr>';
                return;
            }

            let html = '';
            sponsorsData.forEach((s, index) => {
                html += `
                    <tr>
                        <td>#S${s.sponsorId}</td>
                        <td>${s.name}</td>
                        <td>${s.phone}</td>
                        <td style="font-weight: bold; color: #FF8C00;">NT$ ${parseInt(s.amount).toLocaleString()}</td>
                        <td>${s.sponsorTime}</td>
                        <td><span class="badge success">å·²ç™»è¨˜</span></td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // åŒ¯å‡ºè´ŠåŠ©åå–®
        function exportSponsors() {
            if (sponsorsData.length === 0) {
                alert('ç›®å‰æ²’æœ‰è´ŠåŠ©è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            const data = sponsorsData.map((s, index) => ({
                'åºè™Ÿ': '#S' + s.sponsorId,
                'å§“å': s.name,
                'é›»è©±': s.phone,
                'è´ŠåŠ©é‡‘é¡': parseInt(s.amount),
                'å‚™è¨»': s.remarks || '',
                'è´ŠåŠ©æ™‚é–“': s.sponsorTime
            }));

            exportToExcel(data, 'æ´»å‹•è´ŠåŠ©åå–®_' + getDateString());
        }

        // ==================== å ±è¡¨åŒ¯å‡º ====================

        // åŒ¯å‡ºå®Œæ•´å ±è¡¨
        function exportFullReport() {
            if (volunteersData.length === 0 && sponsorsData.length === 0) {
                alert('ç›®å‰æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            const wb = XLSX.utils.book_new();

            // å¿—å·¥è³‡æ–™
            if (volunteersData.length > 0) {
                const volunteerData = volunteersData.map(v => ({
                    'åºè™Ÿ': '#V' + v.registrationId,
                    'å§“å': v.name,
                    'é›»è©±': v.phone,
                    'å·¥ä½œç­æ¬¡': v.workShift,
                    'åˆé¤éœ€æ±‚': v.lunch || 'ç„¡',
                    'å‚™è¨»': v.remarks || '',
                    'å ±åæ™‚é–“': v.registrationTime
                }));
                const ws1 = XLSX.utils.json_to_sheet(volunteerData);
                XLSX.utils.book_append_sheet(wb, ws1, 'å¿—å·¥åå–®');
            }

            // è´ŠåŠ©è³‡æ–™
            if (sponsorsData.length > 0) {
                const sponsorData = sponsorsData.map(s => ({
                    'åºè™Ÿ': '#S' + s.sponsorId,
                    'å§“å': s.name,
                    'é›»è©±': s.phone,
                    'è´ŠåŠ©é‡‘é¡': parseInt(s.amount),
                    'å‚™è¨»': s.remarks || '',
                    'è´ŠåŠ©æ™‚é–“': s.sponsorTime
                }));
                const ws2 = XLSX.utils.json_to_sheet(sponsorData);
                XLSX.utils.book_append_sheet(wb, ws2, 'è´ŠåŠ©åå–®');
            }

            // çµ±è¨ˆè³‡æ–™
            const stats = [
                { 'é …ç›®': 'ç¸½å¿—å·¥äººæ•¸', 'æ•¸å€¼': volunteersData.length + ' äºº' },
                { 'é …ç›®': 'å…¨å¤©ç­', 'æ•¸å€¼': volunteersData.filter(v => v.workShift.includes('å…¨å¤©ç­')).length + ' äºº' },
                { 'é …ç›®': 'ä¸Šåˆç­', 'æ•¸å€¼': volunteersData.filter(v => v.workShift.includes('ä¸Šåˆç­')).length + ' äºº' },
                { 'é …ç›®': 'ä¸‹åˆç­', 'æ•¸å€¼': volunteersData.filter(v => v.workShift.includes('ä¸‹åˆç­')).length + ' äºº' },
                { 'é …ç›®': '', 'æ•¸å€¼': '' },
                { 'é …ç›®': 'è´ŠåŠ©äººæ•¸', 'æ•¸å€¼': sponsorsData.length + ' äºº' },
                { 'é …ç›®': 'ç¸½è´ŠåŠ©é‡‘é¡', 'æ•¸å€¼': 'NT$ ' + sponsorsData.reduce((sum, s) => sum + parseInt(s.amount), 0).toLocaleString() }
            ];
            const ws3 = XLSX.utils.json_to_sheet(stats);
            XLSX.utils.book_append_sheet(wb, ws3, 'çµ±è¨ˆè³‡æ–™');

            XLSX.writeFile(wb, 'æè¡€æ´»å‹•å®Œæ•´å ±è¡¨_' + getDateString() + '.xlsx');
            showMessage('success', 'åŒ¯å‡ºæˆåŠŸ', 'å ±è¡¨å·²ä¸‹è¼‰');
        }

        // åŒ¯å‡ºå¿—å·¥å ±è¡¨
        function exportVolunteerReport() {
            if (volunteersData.length === 0) {
                alert('ç›®å‰æ²’æœ‰å¿—å·¥è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            const wb = XLSX.utils.book_new();

            // å¿—å·¥æ˜ç´°
            const volunteerData = volunteersData.map(v => ({
                'åºè™Ÿ': '#V' + v.registrationId,
                'å§“å': v.name,
                'é›»è©±': v.phone,
                'å·¥ä½œç­æ¬¡': v.workShift,
                'åˆé¤éœ€æ±‚': v.lunch || 'ç„¡',
                'å‚™è¨»': v.remarks || '',
                'å ±åæ™‚é–“': v.registrationTime
            }));
            const ws1 = XLSX.utils.json_to_sheet(volunteerData);
            XLSX.utils.book_append_sheet(wb, ws1, 'å¿—å·¥æ˜ç´°');

            // ç­æ¬¡çµ±è¨ˆ
            const shiftStats = {};
            volunteersData.forEach(v => {
                shiftStats[v.workShift] = (shiftStats[v.workShift] || 0) + 1;
            });
            const shiftData = Object.keys(shiftStats).map(shift => ({
                'ç­æ¬¡': shift,
                'äººæ•¸': shiftStats[shift]
            }));
            const ws2 = XLSX.utils.json_to_sheet(shiftData);
            XLSX.utils.book_append_sheet(wb, ws2, 'ç­æ¬¡çµ±è¨ˆ');

            // åˆé¤çµ±è¨ˆ
            const lunchStats = {};
            volunteersData.forEach(v => {
                const lunch = v.lunch || 'ç„¡';
                lunchStats[lunch] = (lunchStats[lunch] || 0) + 1;
            });
            const lunchData = Object.keys(lunchStats).map(lunch => ({
                'åˆé¤é¡å‹': lunch,
                'äººæ•¸': lunchStats[lunch]
            }));
            const ws3 = XLSX.utils.json_to_sheet(lunchData);
            XLSX.utils.book_append_sheet(wb, ws3, 'åˆé¤çµ±è¨ˆ');

            XLSX.writeFile(wb, 'å¿—å·¥å ±è¡¨_' + getDateString() + '.xlsx');
            showMessage('success', 'åŒ¯å‡ºæˆåŠŸ', 'å¿—å·¥å ±è¡¨å·²ä¸‹è¼‰');
        }

        // åŒ¯å‡ºè´ŠåŠ©å ±è¡¨
        function exportSponsorReport() {
            if (sponsorsData.length === 0) {
                alert('ç›®å‰æ²’æœ‰è´ŠåŠ©è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            const wb = XLSX.utils.book_new();

            // è´ŠåŠ©æ˜ç´°
            const sponsorData = sponsorsData.map(s => ({
                'åºè™Ÿ': '#S' + s.sponsorId,
                'å§“å': s.name,
                'é›»è©±': s.phone,
                'è´ŠåŠ©é‡‘é¡': parseInt(s.amount),
                'å‚™è¨»': s.remarks || '',
                'è´ŠåŠ©æ™‚é–“': s.sponsorTime
            }));
            const ws1 = XLSX.utils.json_to_sheet(sponsorData);
            XLSX.utils.book_append_sheet(wb, ws1, 'è´ŠåŠ©æ˜ç´°');

            // é‡‘é¡çµ±è¨ˆ
            const totalAmount = sponsorsData.reduce((sum, s) => sum + parseInt(s.amount), 0);
            const avgAmount = Math.round(totalAmount / sponsorsData.length);
            const maxAmount = Math.max(...sponsorsData.map(s => parseInt(s.amount)));
            const minAmount = Math.min(...sponsorsData.map(s => parseInt(s.amount)));

            const stats = [
                { 'é …ç›®': 'è´ŠåŠ©äººæ•¸', 'æ•¸å€¼': sponsorsData.length + ' äºº' },
                { 'é …ç›®': 'ç¸½è´ŠåŠ©é‡‘é¡', 'æ•¸å€¼': 'NT$ ' + totalAmount.toLocaleString() },
                { 'é …ç›®': 'å¹³å‡è´ŠåŠ©', 'æ•¸å€¼': 'NT$ ' + avgAmount.toLocaleString() },
                { 'é …ç›®': 'æœ€é«˜è´ŠåŠ©', 'æ•¸å€¼': 'NT$ ' + maxAmount.toLocaleString() },
                { 'é …ç›®': 'æœ€ä½è´ŠåŠ©', 'æ•¸å€¼': 'NT$ ' + minAmount.toLocaleString() }
            ];
            const ws2 = XLSX.utils.json_to_sheet(stats);
            XLSX.utils.book_append_sheet(wb, ws2, 'é‡‘é¡çµ±è¨ˆ');

            // èŠ³åéŒ„
            const honorData = sponsorsData.map((s, index) => ({
                'æ’åº': index + 1,
                'å§“å': s.name,
                'è´ŠåŠ©é‡‘é¡': 'NT$ ' + parseInt(s.amount).toLocaleString()
            }));
            const ws3 = XLSX.utils.json_to_sheet(honorData);
            XLSX.utils.book_append_sheet(wb, ws3, 'èŠ³åéŒ„');

            XLSX.writeFile(wb, 'è´ŠåŠ©å ±è¡¨_' + getDateString() + '.xlsx');
            showMessage('success', 'åŒ¯å‡ºæˆåŠŸ', 'è´ŠåŠ©å ±è¡¨å·²ä¸‹è¼‰');
        }

        // åŒ¯å‡ºçµ±è¨ˆå ±è¡¨
        function exportStatisticsReport() {
            const wb = XLSX.utils.book_new();

            // æ•´é«”çµ±è¨ˆ
            const overallStats = [
                { 'é¡åˆ¥': 'å¿—å·¥', 'é …ç›®': 'ç¸½äººæ•¸', 'æ•¸å€¼': volunteersData.length },
                { 'é¡åˆ¥': 'å¿—å·¥', 'é …ç›®': 'å…¨å¤©ç­', 'æ•¸å€¼': volunteersData.filter(v => v.workShift.includes('å…¨å¤©ç­')).length },
                { 'é¡åˆ¥': 'å¿—å·¥', 'é …ç›®': 'ä¸Šåˆç­', 'æ•¸å€¼': volunteersData.filter(v => v.workShift.includes('ä¸Šåˆç­')).length },
                { 'é¡åˆ¥': 'å¿—å·¥', 'é …ç›®': 'ä¸‹åˆç­', 'æ•¸å€¼': volunteersData.filter(v => v.workShift.includes('ä¸‹åˆç­')).length },
                { 'é¡åˆ¥': '', 'é …ç›®': '', 'æ•¸å€¼': '' },
                { 'é¡åˆ¥': 'è´ŠåŠ©', 'é …ç›®': 'è´ŠåŠ©äººæ•¸', 'æ•¸å€¼': sponsorsData.length },
                { 'é¡åˆ¥': 'è´ŠåŠ©', 'é …ç›®': 'ç¸½é‡‘é¡', 'æ•¸å€¼': sponsorsData.reduce((sum, s) => sum + parseInt(s.amount), 0) },
                { 'é¡åˆ¥': 'è´ŠåŠ©', 'é …ç›®': 'å¹³å‡é‡‘é¡', 'æ•¸å€¼': sponsorsData.length > 0 ? Math.round(sponsorsData.reduce((sum, s) => sum + parseInt(s.amount), 0) / sponsorsData.length) : 0 }
            ];
            const ws1 = XLSX.utils.json_to_sheet(overallStats);
            XLSX.utils.book_append_sheet(wb, ws1, 'æ•´é«”çµ±è¨ˆ');

            // è©³ç´°ç­æ¬¡çµ±è¨ˆ
            const shiftDetails = [];
            const shiftLimits = getDefaultShiftLimits();
            Object.keys(shiftLimits).forEach(shift => {
                const count = volunteersData.filter(v => v.workShift === shift).length;
                const max = shiftLimits[shift];
                const percentage = Math.round(count / max * 100);
                shiftDetails.push({
                    'ç­æ¬¡': shift,
                    'ç›®å‰äººæ•¸': count,
                    'äººæ•¸ä¸Šé™': max,
                    'å®Œæˆåº¦': percentage + '%'
                });
            });
            const ws2 = XLSX.utils.json_to_sheet(shiftDetails);
            XLSX.utils.book_append_sheet(wb, ws2, 'ç­æ¬¡è©³ç´°çµ±è¨ˆ');

            XLSX.writeFile(wb, 'çµ±è¨ˆå ±è¡¨_' + getDateString() + '.xlsx');
            showMessage('success', 'åŒ¯å‡ºæˆåŠŸ', 'çµ±è¨ˆå ±è¡¨å·²ä¸‹è¼‰');
        }

        // ==================== è¼”åŠ©å‡½æ•¸ ====================

        // åŒ¯å‡ºåˆ° Excel
        function exportToExcel(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
            XLSX.writeFile(wb, filename + '.xlsx');
            showMessage('success', 'åŒ¯å‡ºæˆåŠŸ', 'æª”æ¡ˆå·²ä¸‹è¼‰');
        }

        // å–å¾—æ—¥æœŸå­—ä¸²
        function getDateString() {
            const now = new Date();
            return now.getFullYear() + 
                   String(now.getMonth() + 1).padStart(2, '0') + 
                   String(now.getDate()).padStart(2, '0');
        }

        // API å‘¼å«
        function callAPI(params) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonpCallback_' + Date.now();
                
                window[callbackName] = function(result) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(result);
                };

                const script = document.createElement('script');
                const urlParams = new URLSearchParams({
                    callback: callbackName,
                    ...params
                });
                script.src = `${gasUrl}?${urlParams.toString()}`;
                
                script.onerror = function() {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('ç¶²è·¯é€£ç·šå¤±æ•—'));
                };
                
                document.body.appendChild(script);
            });
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(type, title, message) {
            const modal = document.getElementById('messageModal');
            const icon = document.getElementById('modalIcon');
            const titleEl = document.getElementById('modalTitle');
            const messageEl = document.getElementById('modalMessage');

            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };

            icon.textContent = icons[type] || 'âœ…';
            titleEl.textContent = title;
            messageEl.textContent = message;
            modal.classList.add('show');
        }

        function showLoading(message) {
            showMessage('info', 'è™•ç†ä¸­', message);
        }

        function closeModal() {
            document.getElementById('messageModal').classList.remove('show');
        }
    </script>
</body>
</html>

