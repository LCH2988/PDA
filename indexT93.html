<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå° - æè¡€æ´»å‹•ç®¡ç†ç³»çµ±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 20px;
            font-size: 16px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        /* ç™»å…¥ç•«é¢ */
        .login-section {
            padding: 60px 40px;
            text-align: center;
        }
        .login-box {
            max-width: 400px;
            margin: 0 auto;
        }
        .login-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        .login-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #666;
        }
        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102,126,234,0.3);
        }
        .login-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            margin-top: 10px;
        }
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102,126,234,0.4);
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        
        /* ç®¡ç†ä»‹é¢ */
        .admin-section {
            display: none;
        }
        .admin-section.show {
            display: block;
        }
        .admin-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-user {
            font-weight: bold;
            color: #667eea;
        }
        .logout-btn {
            background: #dc3545;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .tab-navigation {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #ddd;
        }
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stat-card.green {
            background: linear-gradient(135deg, #11998e, #38ef7d);
        }
        .stat-card.orange {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }
        .stat-card.blue {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .action-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .action-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .action-btn.success {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
        }
        .action-btn.warning {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .data-table thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .data-table tbody tr:hover {
            background: #f8f9fa;
        }
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .badge.success { background: #d4edda; color: #155724; }
        .badge.warning { background: #fff3cd; color: #856404; }
        .badge.danger { background: #f8d7da; color: #721c24; }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .modal-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        .modal-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #333;
        }
        .modal-message {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin: 0 5px;
        }
        .modal-btn.primary {
            background: #667eea;
            color: white;
        }
        .modal-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        @media (max-width: 768px) {
            body { padding: 10px; font-size: 14px; }
            .header h1 { font-size: 1.5em; }
            .login-section { padding: 40px 20px; }
            .tab-content { padding: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .action-buttons { grid-template-columns: 1fr; }
            .data-table { font-size: 0.9em; }
            .data-table th,
            .data-table td { padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” ç®¡ç†å¾Œå°</h1>
            <p>æè¡€æ´»å‹•ç®¡ç†ç³»çµ±</p>
        </div>

        <!-- ç™»å…¥ç•«é¢ -->
        <div class="login-section" id="loginSection">
            <div class="login-box">
                <div class="login-icon">ğŸ”’</div>
                <h2 class="login-title">ç®¡ç†å“¡ç™»å…¥</h2>
                <form id="loginForm">
                    <div class="input-group">
                        <label for="username">å¸³è™Ÿ</label>
                        <input type="text" id="username" placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡å¸³è™Ÿ" required>
                    </div>
                    <div class="input-group">
                        <label for="password">å¯†ç¢¼</label>
                        <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
                    </div>
                    <button type="submit" class="login-btn">ç™»å…¥</button>
                    <div class="error-message" id="errorMessage"></div>
                </form>
            </div>
        </div>

        <!-- ç®¡ç†ä»‹é¢ -->
        <div class="admin-section" id="adminSection">
            <div class="admin-header">
                <div class="admin-user">
                    ğŸ‘¤ ç®¡ç†å“¡ï¼š<span id="adminName">Admin</span>
                </div>
                <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
            </div>

            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchAdminTab('dashboard')">ğŸ“Š å„€è¡¨æ¿</button>
                <button class="tab-btn" onclick="switchAdminTab('volunteers')">ğŸ™‹ å¿—å·¥ç®¡ç†</button>
                <button class="tab-btn" onclick="switchAdminTab('sponsors')">ğŸ’° è´ŠåŠ©ç®¡ç†</button>
                <button class="tab-btn" onclick="switchAdminTab('reports')">ğŸ“ˆ å ±è¡¨åŒ¯å‡º</button>
            </div>

            <!-- å„€è¡¨æ¿ -->
            <div class="tab-content active" id="dashboardTab">
                <h2 style="margin-bottom: 20px;">ğŸ“Š çµ±è¨ˆæ¦‚è¦½</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ç¸½å¿—å·¥äººæ•¸</div>
                        <div class="stat-value" id="totalVolunteers">0</div>
                        <div class="stat-label">äºº</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-label">å…¨å¤©ç­</div>
                        <div class="stat-value" id="allDayVolunteers">0</div>
                        <div class="stat-label">äºº</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">ä¸Šåˆç­</div>
                        <div class="stat-value" id="morningVolunteers">0</div>
                        <div class="stat-label">äºº</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-label">ä¸‹åˆç­</div>
                        <div class="stat-value" id="afternoonVolunteers">0</div>
                        <div class="stat-label">äºº</div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                        <div class="stat-label">è´ŠåŠ©äººæ•¸</div>
                        <div class="stat-value" id="totalSponsors">0</div>
                        <div class="stat-label">äºº</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #fa709a, #fee140);">
                        <div class="stat-label">ç¸½è´ŠåŠ©é‡‘é¡</div>
                        <div class="stat-value" id="totalAmount">$0</div>
                        <div class="stat-label">å…ƒ</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 15px;">å¿«é€Ÿæ“ä½œ</h3>
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="shareVolunteerStatus()">
                        ğŸ“¤ åˆ†äº«å¿—å·¥ç‹€æ…‹
                    </button>
                    <button class="action-btn success" onclick="shareSponsorStatus()">
                        ğŸ“¤ åˆ†äº«è´ŠåŠ©ç‹€æ…‹
                    </button>
                    <button class="action-btn warning" onclick="refreshDashboard()">
                        ğŸ”„ é‡æ–°æ•´ç†
                    </button>
                </div>
            </div>

            <!-- å¿—å·¥ç®¡ç† -->
            <div class="tab-content" id="volunteersTab">
                <h2 style="margin-bottom: 20px;">ğŸ™‹ å¿—å·¥ç®¡ç†</h2>
                
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="loadVolunteers()">
                        ğŸ”„ é‡æ–°è¼‰å…¥
                    </button>
                    <button class="action-btn success" onclick="exportVolunteers()">
                        ğŸ“¥ åŒ¯å‡º Excel
                    </button>
                    <button class="action-btn warning" onclick="shareVolunteerList()">
                        ğŸ“¤ åˆ†äº«åˆ°ç¾¤çµ„
                    </button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="data-table" id="volunteersTable">
                        <thead>
                            <tr>
                                <th>åºè™Ÿ</th>
                                <th>å§“å</th>
                                <th>é›»è©±</th>
                                <th>ç­æ¬¡</th>
                                <th>åˆé¤</th>
                                <th>å ±åæ™‚é–“</th>
                                <th>ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="volunteersTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    è¼‰å…¥ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- è´ŠåŠ©ç®¡ç† -->
            <div class="tab-content" id="sponsorsTab">
                <h2 style="margin-bottom: 20px;">ğŸ’° è´ŠåŠ©ç®¡ç†</h2>
                
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="loadSponsors()">
                        ğŸ”„ é‡æ–°è¼‰å…¥
                    </button>
                    <button class="action-btn success" onclick="exportSponsors()">
                        ğŸ“¥ åŒ¯å‡º Excel
                    </button>
                    <button class="action-btn warning" onclick="shareSponsorList()">
                        ğŸ“¤ åˆ†äº«åˆ°ç¾¤çµ„
                    </button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="data-table" id="sponsorsTable">
                        <thead>
                            <tr>
                                <th>åºè™Ÿ</th>
                                <th>å§“å</th>
                                <th>é›»è©±</th>
                                <th>é‡‘é¡</th>
                                <th>è´ŠåŠ©æ™‚é–“</th>
                                <th>ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="sponsorsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px;">
                                    è¼‰å…¥ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å ±è¡¨åŒ¯å‡º -->
            <div class="tab-content" id="reportsTab">
                <h2 style="margin-bottom: 20px;">ğŸ“ˆ å ±è¡¨åŒ¯å‡º</h2>
                
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="exportFullReport()">
                        ğŸ“Š å®Œæ•´å ±è¡¨
                    </button>
                    <button class="action-btn success" onclick="exportVolunteerReport()">
                        ğŸ™‹ å¿—å·¥å ±è¡¨
                    </button>
                    <button class="action-btn warning" onclick="exportSponsorReport()">
                        ğŸ’° è´ŠåŠ©å ±è¡¨
                    </button>
                    <button class="action-btn" style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white;" onclick="exportStatisticsReport()">
                        ğŸ“ˆ çµ±è¨ˆå ±è¡¨
                    </button>
                </div>

                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“‹ å ±è¡¨èªªæ˜</h3>
                    <ul style="line-height: 2; color: #666;">
                        <li><strong>å®Œæ•´å ±è¡¨ï¼š</strong>åŒ…å«æ‰€æœ‰å¿—å·¥å’Œè´ŠåŠ©è³‡æ–™</li>
                        <li><strong>å¿—å·¥å ±è¡¨ï¼š</strong>å¿—å·¥å ±åæ˜ç´°ã€ç­æ¬¡çµ±è¨ˆã€åˆé¤çµ±è¨ˆ</li>
                        <li><strong>è´ŠåŠ©å ±è¡¨ï¼š</strong>è´ŠåŠ©æ˜ç´°ã€é‡‘é¡çµ±è¨ˆã€èŠ³åéŒ„</li>
                        <li><strong>çµ±è¨ˆå ±è¡¨ï¼š</strong>å„é …æ•¸æ“šçµ±è¨ˆåœ–è¡¨</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨Šæ¯å½ˆçª— -->
    <div class="modal" id="messageModal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">âœ…</div>
            <h3 class="modal-title" id="modalTitle">æ“ä½œæˆåŠŸ</h3>
            <p class="modal-message" id="modalMessage">æ“ä½œå·²å®Œæˆ</p>
            <button class="modal-btn primary" onclick="closeModal()">ç¢ºå®š</button>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // âš ï¸ è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš›å€¼
        const liffId = "2007905012-dQfXClGM"; // ç®¡ç†å¾Œå° LIFF ID
        const gasUrl = "https://script.google.com/macros/s/AKfycbxP6bmK1vwWmMfEeuTLxXyLNNLxuVw5p5k3ENdF2Sw69flrEZNWlz8CwJwN8hHmvYE06A/exec";
        
        const ADMIN_PASSWORD = "admin123";
        let isLoggedIn = false;
        let userProfile = null;
        let volunteersData = [];
        let sponsorsData = [];

        // LIFF åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('åˆå§‹åŒ–ç®¡ç†å¾Œå°...');
            
            liff.init({ liffId: liffId })
                .then(() => {
                    console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');
                    if (liff.isLoggedIn()) {
                        return liff.getProfile();
                    } else {
                        liff.login();
                        return null;
                    }
                })
                .then((profile) => {
                    if (profile) {
                        userProfile = profile;
                        console.log('ç”¨æˆ¶è³‡æ–™:', profile);
                    }
                })
                .catch((err) => {
                    console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', err);
                });

            // ç™»å…¥è¡¨å–®
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
        });

        // ç™»å…¥è™•ç†
        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMessage');

            if (username === 'admin' && password === ADMIN_PASSWORD) {
                isLoggedIn = true;
                document.getElementById('adminName').textContent = username;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminSection').classList.add('show');
                
                // è¼‰å…¥å„€è¡¨æ¿è³‡æ–™
                loadDashboard();
            } else {
                errorMsg.textContent = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
                errorMsg.classList.add('show');
                setTimeout(() => {
                    errorMsg.classList.remove('show');
                }, 3000);
            }
        }

        // ç™»å‡º
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                isLoggedIn = false;
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('adminSection').classList.remove('show');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }
        }

        // åˆ‡æ›åˆ†é 
        function switchAdminTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // è¼‰å…¥å°æ‡‰è³‡æ–™
            if (tabName === 'volunteers') {
                loadVolunteers();
            } else if (tabName === 'sponsors') {
                loadSponsors();
            }
        }

        // è¼‰å…¥å„€è¡¨æ¿
        async function loadDashboard() {
            try {
                const [volunteersResult, sponsorsResult] = await Promise.all([
                    callAPI({ action: 'getVolunteerList' }),
                    callAPI({ action: 'getSponsorList' })
                ]);

                if (volunteersResult.success) {
                    volunteersData = volunteersResult.volunteers || [];
                    updateVolunteerStats();
                }

                if (sponsorsResult.success) {
                    sponsorsData = sponsorsResult.sponsors || [];
                    updateSponsorStats();
                }
            } catch (error) {
                console.error('è¼‰å…¥å„€è¡¨æ¿éŒ¯èª¤:', error);
            }
        }

        // æ›´æ–°å¿—å·¥çµ±è¨ˆ
        function updateVolunteerStats() {
            const total = volunteersData.length;
            const allDay = volunteersData.filter(v => v.workShift.includes('å…¨å¤©ç­')).length;
            const morning = volunteersData.filter(v => v.workShift.includes('ä¸Šåˆç­')).length;
            const afternoon = volunteersData.filter(v => v.workShift.includes('ä¸‹åˆç­')).length;

            document.getElementById('totalVolunteers').textContent = total;
            document.getElementById('allDayVolunteers').textContent = allDay;
            document.getElementById('morningVolunteers').textContent = morning;
            document.getElementById('afternoonVolunteers').textContent = afternoon;
        }

        // æ›´æ–°è´ŠåŠ©çµ±è¨ˆ
        function updateSponsorStats() {
            const total = sponsorsData.length;
            const totalAmount = sponsorsData.reduce((sum, s) => sum + (parseInt(s.amount) || 0), 0);

            document.getElementById('totalSponsors').textContent = total;
            document.getElementById('totalAmount').textContent = '$' + totalAmount.toLocaleString();
        }

        // é‡æ–°æ•´ç†å„€è¡¨æ¿
        async function refreshDashboard() {
            showLoading('é‡æ–°æ•´ç†ä¸­...');
            await loadDashboard();
            showMessage('success', 'é‡æ–°æ•´ç†å®Œæˆ', 'è³‡æ–™å·²æ›´æ–°');
        }

        // è¼‰å…¥å¿—å·¥åˆ—è¡¨
        async function loadVolunteers() {
            try {
                const tbody = document.getElementById('volunteersTableBody');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">è¼‰å…¥ä¸­...</td></tr>';

                const result = await callAPI({ action: 'getVolunteerList' });
                
                if (result.success) {
                    volunteersData = result.volunteers || [];
                    
                    if (volunteersData.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">ç›®å‰å°šç„¡å¿—å·¥å ±å</td></tr>';
                        return;
                    }

                    let html = '';
                    volunteersData.forEach((v, index) => {
                        html += `
                            <tr>
                                <td>#V${v.registrationId}</td>
                                <td>${v.name}</td>
                                <td>${v.phone}</td>
                                <td>${v.workShift}</td>
                                <td>${v.lunch || 'ç„¡'}</td>
                                <td>${v.registrationTime}</td>
                                <td><span class="badge success">å·²å ±å</span></td>
                            </tr>
                        `;
                    });
                    tbody.innerHTML = html;
                }
            } catch (error) {
                console.error('è¼‰å…¥å¿—å·¥åˆ—è¡¨éŒ¯èª¤:', error);
                showMessage('error', 'è¼‰å…¥å¤±æ•—', error.message);
            }
        }

        // è¼‰å…¥è´ŠåŠ©åˆ—è¡¨
        async function loadSponsors() {
            try {
                const tbody = document.getElementById('sponsorsTableBody');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">è¼‰å…¥ä¸­...</td></tr>';

                const result = await callAPI({ action: 'getSponsorList' });
                
                if (result.success) {
                    sponsorsData = result.sponsors || [];
                    
                    if (sponsorsData.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">ç›®å‰å°šç„¡è´ŠåŠ©è¨˜éŒ„</td></tr>';
                        return;
                    }

                    let html = '';
                    sponsorsData.forEach((s, index) => {
                        html += `
                            <tr>
                                <td>#S${s.sponsorId}</td>
                                <td>${s.name}</td>
                                <td>${s.phone}</td>
                                <td style="color: #FF8C00; font-weight: bold;">NT$ ${parseInt(s.amount).toLocaleString()}</td>
                                <td>${s.sponsorTime}</td>
                                <td><span class="badge warning">å·²ç™»è¨˜</span></td>
                            </tr>
                        `;
                    });
                    tbody.innerHTML = html;
                }
            } catch (error) {
                console.error('è¼‰å…¥è´ŠåŠ©åˆ—è¡¨éŒ¯èª¤:', error);
                showMessage('error', 'è¼‰å…¥å¤±æ•—', error.message);
            }
        }

        // åˆ†äº«å¿—å·¥ç‹€æ…‹
        async function shareVolunteerStatus() {
            try {
                showLoading('æº–å‚™åˆ†äº«...');
                const result = await callAPI({ 
                    action: 'shareVolunteerStatus',
                    adminId: userProfile?.userId
                });
                
                if (result.success) {
                    showMessage('success', 'åˆ†äº«æˆåŠŸ', 'å¿—å·¥ç‹€æ…‹å·²ç™¼é€åˆ°ç¾¤çµ„');
                } else {
                    showMessage('error', 'åˆ†äº«å¤±æ•—', result.message);
                }
            } catch (error) {
                showMessage('error', 'åˆ†äº«å¤±æ•—', error.message);
            }
        }

        // åˆ†äº«è´ŠåŠ©ç‹€æ…‹
        async function shareSponsorStatus() {
            try {
                showLoading('æº–å‚™åˆ†äº«...');
                const result = await callAPI({ 
                    action: 'shareSponsorStatus',
                    adminId: userProfile?.userId
                });
                
                if (result.success) {
                    showMessage('success', 'åˆ†äº«æˆåŠŸ', 'è´ŠåŠ©ç‹€æ…‹å·²ç™¼é€åˆ°ç¾¤çµ„');
                } else {
                    showMessage('error', 'åˆ†äº«å¤±æ•—', result.message);
                }
            } catch (error) {
                showMessage('error', 'åˆ†äº«å¤±æ•—', error.message);
            }
        }

        // åŒ¯å‡ºå¿—å·¥ Excel
        function exportVolunteers() {
            if (volunteersData.length === 0) {
                showMessage('warning', 'ç„¡è³‡æ–™', 'ç›®å‰æ²’æœ‰å¿—å·¥è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            const data = volunteersData.map((v, index) => ({
                'åºè™Ÿ': '#V' + v.registrationId,
                'å§“å': v.name,
                'é›»è©±': v.phone,
                'å·¥ä½œç­æ¬¡': v.workShift,
                'åˆé¤éœ€æ±‚': v.lunch || 'ç„¡',
                'å‚™è¨»': v.remarks || '',
                'å ±åæ™‚é–“': v.registrationTime,
                'ç‹€æ…‹': 'å·²å ±å'
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "å¿—å·¥åå–®");
            
            const fileName = `å¿—å·¥åå–®_${new Date().toLocaleDateString('zh-TW')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showMessage('success', 'åŒ¯å‡ºæˆåŠŸ', `å·²åŒ¯å‡º ${volunteersData.length} ç­†è³‡æ–™`);
        }

        // åŒ¯å‡ºè´ŠåŠ© Excel
        function exportSponsors() {
            if (sponsorsData.length === 0) {
                showMessage('warning', 'ç„¡è³‡æ–™', 'ç›®å‰æ²’æœ‰è´ŠåŠ©è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            const data = sponsorsData.map((s, index) => ({
                'åºè™Ÿ': '#S' + s.sponsorId,
                'å§“å': s.name,
                'é›»è©±': s.phone,
                'è´ŠåŠ©é‡‘é¡': parseInt(s.amount),
                'å‚™è¨»': s.remarks || '',
                'è´ŠåŠ©æ™‚é–“': s.sponsorTime,
                'ç‹€æ…‹': 'å·²ç™»è¨˜'
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "è´ŠåŠ©åå–®");
            
            const fileName = `è´ŠåŠ©åå–®_${new Date().toLocaleDateString('zh-TW')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showMessage('success', 'åŒ¯å‡ºæˆåŠŸ', `å·²åŒ¯å‡º ${sponsorsData.length} ç­†è³‡æ–™`);
        }

        // åŒ¯å‡ºå®Œæ•´å ±è¡¨
        function exportFullReport() {
            if (volunteersData.length === 0 && sponsorsData.length === 0) {
                showMessage('warning', 'ç„¡è³‡æ–™', 'ç›®å‰æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            const wb = XLSX.utils.book_new();

            // å¿—å·¥è³‡æ–™
            if (volunteersData.length > 0) {
                const volunteerData = volunteersData.map(v => ({
                    'åºè™Ÿ': '#V' + v.registrationId,
                    'å§“å': v.name,
                    'é›»è©±': v.phone,
                    'å·¥ä½œç­æ¬¡': v.workShift,
                    'åˆé¤éœ€æ±‚': v.lunch || 'ç„¡',
                    'å ±åæ™‚é–“': v.registrationTime
                }));
                const ws1 = XLSX.utils.json_to_sheet(volunteerData);
                XLSX.utils.book_append_sheet(wb, ws1, "å¿—å·¥åå–®");
            }

            // è´ŠåŠ©è³‡æ–™
            if (sponsorsData.length > 0) {
                const sponsorData = sponsorsData.map(s => ({
                    'åºè™Ÿ': '#S' + s.sponsorId,
                    'å§“å': s.name,
                    'é›»è©±': s.phone,
                    'è´ŠåŠ©é‡‘é¡': parseInt(s.amount),
                    'è´ŠåŠ©æ™‚é–“': s.sponsorTime
                }));
                const ws2 = XLSX.utils.json_to_sheet(sponsorData);
                XLSX.utils.book_append_sheet(wb, ws2, "è´ŠåŠ©åå–®");
            }

            const fileName = `æè¡€æ´»å‹•å®Œæ•´å ±è¡¨_${new Date().toLocaleDateString('zh-TW')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showMessage('success', 'åŒ¯å‡ºæˆåŠŸ', 'å®Œæ•´å ±è¡¨å·²åŒ¯å‡º');
        }

        // åŒ¯å‡ºå¿—å·¥å ±è¡¨
        function exportVolunteerReport() {
            exportVolunteers();
        }

        // åŒ¯å‡ºè´ŠåŠ©å ±è¡¨
        function exportSponsorReport() {
            exportSponsors();
        }

        // åŒ¯å‡ºçµ±è¨ˆå ±è¡¨
        function exportStatisticsReport() {
            const wb = XLSX.utils.book_new();

            // å¿—å·¥çµ±è¨ˆ
            const volunteerStats = [
                ['çµ±è¨ˆé …ç›®', 'äººæ•¸'],
                ['ç¸½å¿—å·¥äººæ•¸', volunteersData.length],
                ['å…¨å¤©ç­', volunteersData.filter(v => v.workShift.includes('å…¨å¤©ç­')).length],
                ['ä¸Šåˆç­', volunteersData.filter(v => v.workShift.includes('ä¸Šåˆç­')).length],
                ['ä¸‹åˆç­', volunteersData.filter(v => v.workShift.includes('ä¸‹åˆç­')).length]
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(volunteerStats);
            XLSX.utils.book_append_sheet(wb, ws1, "å¿—å·¥çµ±è¨ˆ");

            // è´ŠåŠ©çµ±è¨ˆ
            const totalAmount = sponsorsData.reduce((sum, s) => sum + (parseInt(s.amount) || 0), 0);
            const avgAmount = sponsorsData.length > 0 ? Math.round(totalAmount / sponsorsData.length) : 0;
            
            const sponsorStats = [
                ['çµ±è¨ˆé …ç›®', 'æ•¸å€¼'],
                ['è´ŠåŠ©äººæ•¸', sponsorsData.length],
                ['ç¸½è´ŠåŠ©é‡‘é¡', totalAmount],
                ['å¹³å‡è´ŠåŠ©é‡‘é¡', avgAmount]
            ];
            const ws2 = XLSX.utils.aoa_to_sheet(sponsorStats);
            XLSX.utils.book_append_sheet(wb, ws2, "è´ŠåŠ©çµ±è¨ˆ");

            const fileName = `çµ±è¨ˆå ±è¡¨_${new Date().toLocaleDateString('zh-TW')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showMessage('success', 'åŒ¯å‡ºæˆåŠŸ', 'çµ±è¨ˆå ±è¡¨å·²åŒ¯å‡º');
        }

        // API å‘¼å«
        function callAPI(params) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonpCallback_' + Date.now();
                
                window[callbackName] = function(result) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(result);
                };

                const script = document.createElement('script');
                const urlParams = new URLSearchParams({
                    callback: callbackName,
                    ...params
                });
                script.src = `${gasUrl}?${urlParams.toString()}`;
                
                script.onerror = function() {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('ç¶²è·¯é€£ç·šå¤±æ•—'));
                };
                
                document.body.appendChild(script);
            });
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(type, title, message) {
            const modal = document.getElementById('messageModal');
            const icon = document.getElementById('modalIcon');
            const titleEl = document.getElementById('modalTitle');
            const messageEl = document.getElementById('modalMessage');

            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };

            icon.textContent = icons[type] || 'âœ…';
            titleEl.textContent = title;
            messageEl.textContent = message;
            modal.classList.add('show');
        }

        function showLoading(message) {
            showMessage('info', 'è™•ç†ä¸­', message);
        }

        function closeModal() {
            document.getElementById('messageModal').classList.remove('show');
        }
    </script>
</body>
</html>
