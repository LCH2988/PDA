<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†å¾Œå° - æ–°å¹´ç†±è¡€ä¸æ–·é›»</title>
  <style>
      * { 
          margin: 0; 
          padding: 0; 
          box-sizing: border-box; 
      }
      
      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px;
          font-size: 16px;
      }
      
      .container {
          max-width: 1400px;
          margin: 0 auto;
          background: white;
          border-radius: 20px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          overflow: hidden;
      }
      
      /* ==================== Header ==================== */
      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 30px;
          text-align: center;
          position: relative;
      }
      
      .header h1 {
          font-size: 2.5em;
          margin-bottom: 10px;
          text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      }
      
      .header p {
          font-size: 1.2em;
          opacity: 0.95;
      }
      
      .admin-badge {
          position: absolute;
          top: 20px;
          right: 30px;
          background: rgba(255,255,255,0.2);
          padding: 8px 16px;
          border-radius: 20px;
          font-size: 0.9em;
          backdrop-filter: blur(10px);
      }
      
      /* ==================== Status Info ==================== */
      .status-info {
          background: #f0f8ff;
          padding: 15px;
          margin: 20px;
          border-radius: 10px;
          border-left: 5px solid #667eea;
      }
      
      .status-success { 
          border-left-color: #28a745; 
          background: #d4edda; 
      }
      
      .status-error { 
          border-left-color: #dc3545; 
          background: #f8d7da; 
      }
      
      .status-warning { 
          border-left-color: #ffc107; 
          background: #fff3cd; 
      }
      
      /* ==================== Navigation Tabs ==================== */
      .nav-tabs {
          display: flex;
          background: #f8f9fa;
          border-bottom: 3px solid #dee2e6;
          overflow-x: auto;
      }
      
      .nav-tab {
          flex: 1;
          min-width: 150px;
          padding: 20px;
          background: transparent;
          border: none;
          cursor: pointer;
          font-size: 1.1em;
          font-weight: bold;
          color: #666;
          transition: all 0.3s;
          position: relative;
      }
      
      .nav-tab:hover {
          background: rgba(102, 126, 234, 0.1);
          color: #667eea;
      }
      
      .nav-tab.active {
          background: white;
          color: #667eea;
      }
      
      .nav-tab.active::after {
          content: '';
          position: absolute;
          bottom: -3px;
          left: 0;
          right: 0;
          height: 3px;
          background: #667eea;
      }
      
      .tab-icon {
          font-size: 1.3em;
          margin-right: 8px;
      }
      
      /* ==================== Tab Content ==================== */
      .tab-content {
          display: none;
          padding: 30px;
          animation: fadeIn 0.3s ease;
      }
      
      .tab-content.active {
          display: block;
      }
      
      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
      }
      
      /* ==================== Statistics Cards ==================== */
      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
      }
      
      .stat-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 25px;
          border-radius: 15px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
          transition: all 0.3s;
      }
      
      .stat-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      }
      
      .stat-card.volunteer {
          background: linear-gradient(135deg, #DC143C, #FF6347);
      }
      
      .stat-card.sponsor {
          background: linear-gradient(135deg, #FF8C00, #FFA500);
      }
      
      .stat-card.total {
          background: linear-gradient(135deg, #28a745, #20c997);
      }
      
      .stat-card h3 {
          font-size: 1em;
          margin-bottom: 15px;
          opacity: 0.9;
      }
      
      .stat-card .number {
          font-size: 3em;
          font-weight: bold;
          margin-bottom: 10px;
      }
      
      .stat-card .label {
          font-size: 0.9em;
          opacity: 0.8;
      }
      
      /* ==================== Action Buttons ==================== */
      .action-buttons {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
          margin-bottom: 30px;
      }
      
      .action-btn {
          padding: 15px 25px;
          border: none;
          border-radius: 10px;
          font-size: 1em;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
      }
      
      .action-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }
      
      .btn-refresh {
          background: linear-gradient(135deg, #4169E1, #1E90FF);
          color: white;
      }
      
      .btn-export {
          background: linear-gradient(135deg, #28a745, #20c997);
          color: white;
      }
      
      .btn-share {
          background: linear-gradient(135deg, #FF8C00, #FFA500);
          color: white;
      }
      
      .btn-notify {
          background: linear-gradient(135deg, #DC143C, #FF6347);
          color: white;
      }
      
      /* ==================== Data Table ==================== */
      .table-container {
          background: white;
          border-radius: 15px;
          overflow: hidden;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          margin-bottom: 30px;
      }
      
      .table-header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      
      .table-header h3 {
          font-size: 1.3em;
      }
      
      .table-search {
          padding: 8px 15px;
          border: 2px solid rgba(255,255,255,0.3);
          border-radius: 20px;
          background: rgba(255,255,255,0.1);
          color: white;
          font-size: 0.9em;
          width: 250px;
      }
      
      .table-search::placeholder {
          color: rgba(255,255,255,0.7);
      }
      
      .data-table {
          width: 100%;
          border-collapse: collapse;
      }
      
      .data-table thead {
          background: #f8f9fa;
      }
      
      .data-table th {
          padding: 15px;
          text-align: left;
          font-weight: bold;
          color: #333;
          border-bottom: 2px solid #dee2e6;
      }
      
      .data-table td {
          padding: 15px;
          border-bottom: 1px solid #dee2e6;
          color: #666;
      }
      
      .data-table tbody tr {
          transition: all 0.3s;
      }
      
      .data-table tbody tr:hover {
          background: #f8f9fa;
      }
      
      .badge {
          padding: 5px 12px;
          border-radius: 20px;
          font-size: 0.85em;
          font-weight: bold;
      }
      
      .badge-active {
          background: #d4edda;
          color: #28a745;
      }
      
      .badge-cancelled {
          background: #f8d7da;
          color: #dc3545;
      }
      
      .badge-all-day {
          background: #fff8dc;
          color: #FF8C00;
      }
      
      .badge-morning {
          background: #ffe4e4;
          color: #DC143C;
      }
      
      .badge-afternoon {
          background: #e6f2ff;
          color: #4169E1;
      }
      
      .badge-meat {
          background: #ffe4e4;
          color: #dc3545;
      }
      
      .badge-veg {
          background: #d4edda;
          color: #28a745;
      }
      
      /* ==================== Empty State ==================== */
      .empty-state {
          text-align: center;
          padding: 60px 20px;
          color: #999;
      }
      
      .empty-state-icon {
          font-size: 4em;
          margin-bottom: 20px;
          opacity: 0.5;
      }
      
      .empty-state h3 {
          font-size: 1.5em;
          margin-bottom: 10px;
      }
      
      .empty-state p {
          font-size: 1em;
      }
      
      /* ==================== Shift Summary ==================== */
      .shift-summary {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
      }
      
      .shift-card {
          background: white;
          border-radius: 15px;
          padding: 20px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          border-left: 5px solid #667eea;
      }
      
      .shift-card.all-day {
          border-left-color: #FFD700;
      }
      
      .shift-card.morning {
          border-left-color: #DC143C;
      }
      
      .shift-card.afternoon {
          border-left-color: #4169E1;
      }
      
      .shift-card-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
      }
      
      .shift-card-title {
          font-size: 1.2em;
          font-weight: bold;
          color: #333;
      }
      
      .shift-card-count {
          font-size: 2em;
          font-weight: bold;
          color: #667eea;
      }
      
      .shift-card.all-day .shift-card-count {
          color: #FFD700;
      }
      
      .shift-card.morning .shift-card-count {
          color: #DC143C;
      }
      
      .shift-card.afternoon .shift-card-count {
          color: #4169E1;
      }
      
      .shift-card-unlimited {
          color: #28a745;
          font-size: 0.9em;
          font-weight: bold;
      }
      
      /* ==================== Loading ==================== */
      .loading {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid rgba(255, 255, 255, .3);
          border-radius: 50%;
          border-top-color: #fff;
          animation: spin 1s ease-in-out infinite;
      }
      
      @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
      }
      
      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.5);
          display: none;
          align-items: center;
          justify-content: center;
          z-index: 9999;
      }
      
      .loading-overlay.show {
          display: flex;
      }
      
      .loading-content {
          background: white;
          padding: 30px;
          border-radius: 15px;
          text-align: center;
      }
      
      .loading-spinner {
          width: 50px;
          height: 50px;
          border: 5px solid #f3f3f3;
          border-top: 5px solid #667eea;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin: 0 auto 20px;
      }
      
      /* ==================== Modal ==================== */
      .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.6);
          z-index: 1000;
          align-items: center;
          justify-content: center;
      }
      
      .modal.show {
          display: flex;
      }
      
      .modal-content {
          background: white;
          padding: 40px;
          border-radius: 20px;
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          animation: slideIn 0.3s ease;
      }
      
      @keyframes slideIn {
          from {
              transform: translateY(-50px);
              opacity: 0;
          }
          to {
              transform: translateY(0);
              opacity: 1;
          }
      }
      
      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
          padding-bottom: 15px;
          border-bottom: 2px solid #dee2e6;
      }
      
      .modal-header h3 {
          font-size: 1.5em;
          color: #333;
      }
      
      .modal-close {
          background: none;
          border: none;
          font-size: 2em;
          color: #999;
          cursor: pointer;
          line-height: 1;
      }
      
      .modal-close:hover {
          color: #333;
      }
      
      .modal-body {
          margin-bottom: 20px;
      }
      
      .detail-row {
          display: flex;
          padding: 12px 0;
          border-bottom: 1px solid #f0f0f0;
      }
      
      .detail-label {
          font-weight: bold;
          color: #666;
          width: 120px;
          flex-shrink: 0;
      }
      
      .detail-value {
          color: #333;
          flex: 1;
      }
      
      /* ==================== Utility ==================== */
      .hidden {
          display: none !important;
      }
      
      .text-center {
          text-align: center;
      }
      
      .mt-20 {
          margin-top: 20px;
      }
      
      .mb-20 {
          margin-bottom: 20px;
      }
      
      /* ==================== Responsive ==================== */
      @media (max-width: 768px) {
          body {
              font-size: 14px;
              padding: 10px;
          }
          
          .header h1 {
              font-size: 1.8em;
          }
          
          .admin-badge {
              position: static;
              display: inline-block;
              margin-top: 10px;
          }
          
          .nav-tabs {
              flex-direction: column;
          }
          
          .nav-tab {
              min-width: auto;
          }
          
          .tab-content {
              padding: 20px;
          }
          
          .stats-grid {
              grid-template-columns: 1fr;
          }
          
          .action-buttons {
              grid-template-columns: 1fr;
          }
          
          .table-header {
              flex-direction: column;
              gap: 15px;
          }
          
          .table-search {
              width: 100%;
          }
          
          .data-table {
              font-size: 0.85em;
          }
          
          .data-table th,
          .data-table td {
              padding: 10px 5px;
          }
          
          .shift-summary {
              grid-template-columns: 1fr;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <!-- Header -->
      <div class="header">
          <div class="admin-badge">ğŸ” ç®¡ç†å“¡</div>
          <h1>ğŸ“Š ç®¡ç†å¾Œå°</h1>
          <p>æ–°å¹´ç†±è¡€ä¸æ–·é›» æè¡€å…¬ç›Šæ´»å‹•</p>
      </div>

      <!-- LIFF Status -->
      <div id="liffStatus" class="status-info">
          <div>ğŸ”„ æ­£åœ¨åˆå§‹åŒ–...</div>
      </div>

      <!-- Navigation Tabs -->
      <div class="nav-tabs">
          <button class="nav-tab active" onclick="switchMainTab('overview')">
              <span class="tab-icon">ğŸ“Š</span>
              <span>ç¸½è¦½</span>
          </button>
          <button class="nav-tab" onclick="switchMainTab('volunteers')">
              <span class="tab-icon">ğŸ™‹</span>
              <span>å¿—å·¥ç®¡ç†</span>
          </button>
          <button class="nav-tab" onclick="switchMainTab('sponsors')">
              <span class="tab-icon">ğŸ’°</span>
              <span>è´ŠåŠ©ç®¡ç†</span>
          </button>
          <button class="nav-tab" onclick="switchMainTab('checkin')">
              <span class="tab-icon">âœ…</span>
              <span>ç°½åˆ°ç³»çµ±</span>
          </button>
      </div>

      <!-- Overview Tab -->
      <div id="overviewTab" class="tab-content active">
          <!-- Statistics -->
          <div class="stats-grid">
              <div class="stat-card volunteer">
                  <h3>ğŸ™‹ å¿—å·¥ç¸½æ•¸</h3>
                  <div class="number" id="totalVolunteers">0</div>
                  <div class="label">äºº</div>
              </div>
              <div class="stat-card sponsor">
                  <h3>ğŸ’° è´ŠåŠ©ç¸½é¡</h3>
                  <div class="number" id="totalAmount">$0</div>
                  <div class="label">å…ƒ</div>
              </div>
              <div class="stat-card total">
                  <h3>ğŸ‘¥ è´ŠåŠ©äººæ•¸</h3>
                  <div class="number" id="totalSponsors">0</div>
                  <div class="label">äºº</div>
              </div>
          </div>

          <!-- Shift Summary -->
          <h2 class="mb-20">ğŸ“‹ ç­æ¬¡çµ±è¨ˆ</h2>
          <div class="shift-summary">
              <div class="shift-card all-day">
                  <div class="shift-card-header">
                      <div class="shift-card-title">ğŸŒŸ å…¨å¤©ç­</div>
                      <div class="shift-card-count" id="allDayCount">0</div>
                  </div>
                  <div class="shift-card-unlimited">ä¸é™äººæ•¸</div>
                  <div style="margin-top: 10px; color: #666;">08:30ï½17:00</div>
              </div>
              
              <div class="shift-card morning">
                  <div class="shift-card-header">
                      <div class="shift-card-title">â˜€ï¸ ä¸Šåˆç­</div>
                      <div class="shift-card-count" id="morningCount">0</div>
                  </div>
                  <div class="shift-card-unlimited">ä¸é™äººæ•¸</div>
                  <div style="margin-top: 10px; color: #666;">08:30ï½13:00</div>
              </div>
              
              <div class="shift-card afternoon">
                  <div class="shift-card-header">
                      <div class="shift-card-title">ğŸŒ™ ä¸‹åˆç­</div>
                      <div class="shift-card-count" id="afternoonCount">0</div>
                  </div>
                  <div class="shift-card-unlimited">ä¸é™äººæ•¸</div>
                  <div style="margin-top: 10px; color: #666;">13:00ï½17:00</div>
              </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
              <button class="action-btn btn-refresh" onclick="refreshAllData()">
                  <span>ğŸ”„</span>
                  <span>é‡æ–°æ•´ç†</span>
              </button>
              <button class="action-btn btn-export" onclick="exportVolunteerData()">
                  <span>ğŸ“¥</span>
                  <span>åŒ¯å‡ºå¿—å·¥åå–®</span>
              </button>
              <button class="action-btn btn-share" onclick="shareVolunteerStatus()">
                  <span>ğŸ“¤</span>
                  <span>åˆ†äº«å¿—å·¥ç‹€æ…‹</span>
              </button>
              <button class="action-btn btn-notify" onclick="sendReminder()">
                  <span>ğŸ“¢</span>
                  <span>ç™¼é€æé†’</span>
              </button>
          </div>
      </div>

      <!-- Volunteers Tab -->
      <div id="volunteersTab" class="tab-content">
          <div class="table-container">
              <div class="table-header">
                  <h3>ğŸ™‹ å¿—å·¥åå–®</h3>
                  <input type="text" class="table-search" id="volunteerSearch" placeholder="æœå°‹å§“åæˆ–é›»è©±..." onkeyup="filterVolunteers()">
              </div>
              <div style="overflow-x: auto;">
                  <table class="data-table" id="volunteerTable">
                      <thead>
                          <tr>
                              <th>åºè™Ÿ</th>
                              <th>å ±åæ™‚é–“</th>
                              <th>å§“å</th>
                              <th>é›»è©±</th>
                              <th>ç­æ¬¡</th>
                              <th>åˆé¤</th>
                              <th>å‚™è¨»</th>
                              <th>ç‹€æ…‹</th>
                              <th>æ“ä½œ</th>
                          </tr>
                      </thead>
                      <tbody id="volunteerTableBody">
                          <tr>
                              <td colspan="9" class="text-center">è¼‰å…¥ä¸­...</td>
                          </tr>
                      </tbody>
                  </table>
              </div>
          </div>
      </div>

      <!-- Sponsors Tab -->
      <div id="sponsorsTab" class="tab-content">
          <div class="table-container">
              <div class="table-header">
                  <h3>ğŸ’° è´ŠåŠ©åå–®</h3>
                  <input type="text" class="table-search" id="sponsorSearch" placeholder="æœå°‹å§“åæˆ–é›»è©±..." onkeyup="filterSponsors()">
              </div>
              <div style="overflow-x: auto;">
                  <table class="data-table" id="sponsorTable">
                      <thead>
                          <tr>
                              <th>åºè™Ÿ</th>
                              <th>è´ŠåŠ©æ™‚é–“</th>
                              <th>å§“å</th>
                              <th>é›»è©±</th>
                              <th>é‡‘é¡</th>
                              <th>å‚™è¨»</th>
                              <th>ç‹€æ…‹</th>
                              <th>æ“ä½œ</th>
                          </tr>
                      </thead>
                      <tbody id="sponsorTableBody">
                          <tr>
                              <td colspan="8" class="text-center">è¼‰å…¥ä¸­...</td>
                          </tr>
                      </tbody>
                  </table>
              </div>
          </div>
      </div>

      <!-- Check-in Tab -->
      <div id="checkinTab" class="tab-content">
          <div class="action-buttons">
              <button class="action-btn btn-refresh" onclick="loadVolunteerList()">
                  <span>ğŸ”„</span>
                  <span>é‡æ–°æ•´ç†</span>
              </button>
          </div>
          
          <div class="table-container">
              <div class="table-header">
                  <h3>âœ… ç°½åˆ°ç®¡ç†</h3>
                  <input type="text" class="table-search" id="checkinSearch" placeholder="æœå°‹å§“åæˆ–é›»è©±..." onkeyup="filterCheckin()">
              </div>
              <div style="overflow-x: auto;">
                  <table class="data-table" id="checkinTable">
                      <thead>
                          <tr>
                              <th>åºè™Ÿ</th>
                              <th>å§“å</th>
                              <th>é›»è©±</th>
                              <th>ç­æ¬¡</th>
                              <th>ç°½åˆ°æ™‚é–“</th>
                              <th>æ“ä½œ</th>
                          </tr>
                      </thead>
                      <tbody id="checkinTableBody">
                          <tr>
                              <td colspan="6" class="text-center">è¼‰å…¥ä¸­...</td>
                          </tr>
                      </tbody>
                  </table>
              </div>
          </div>
      </div>
  </div>

  <!-- Detail Modal -->
  <div id="detailModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="modalTitle">è©³ç´°è³‡æ–™</h3>
              <button class="modal-close" onclick="closeModal()">&times;</button>
          </div>
          <div class="modal-body" id="modalBody">
              <!-- Dynamic content -->
          </div>
      </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-content">
          <div class="loading-spinner"></div>
          <div>è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>
      </div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
      // ==================== Global Variables ====================
      let liffReady = false;
      let userProfile = null;
      let allVolunteers = [];
      let allSponsors = [];
      let currentTab = 'overview';

      // âš ï¸ Configuration
      const liffId = "2007905012-dQfXClGM";
      const gasUrl = "https://script.google.com/macros/s/AKfycbymRV0psTd8G4p_1NUaFDldduJE2TBzgZ8Pnvb08W0NdAWPvtmX7VvI2v5CPcSAWvcSJg/exec";

      // ==================== Tab Management ====================
      
      function switchMainTab(tab) {
          currentTab = tab;
          
          // Update tab buttons
          document.querySelectorAll('.nav-tab').forEach(t => {
              t.classList.remove('active');
          });
          event.target.closest('.nav-tab').classList.add('active');
          
          // Update tab content
          document.querySelectorAll('.tab-content').forEach(c => {
              c.classList.remove('active');
          });
          document.getElementById(`${tab}Tab`).classList.add('active');
          
          // Load data for the tab
          if (tab === 'volunteers') {
              loadVolunteerList();
          } else if (tab === 'sponsors') {
              loadSponsorList();
          } else if (tab === 'checkin') {
              loadVolunteerList();
          }
      }

      // ==================== Status Update ====================
      
      function updateStatus(message, type = 'info') {
          const statusDiv = document.getElementById('liffStatus');
          statusDiv.className = `status-info status-${type}`;
          statusDiv.innerHTML = `<div>${message}</div>`;
      }

      function showLoading() {
          document.getElementById('loadingOverlay').classList.add('show');
      }

      function hideLoading() {
          document.getElementById('loadingOverlay').classList.remove('show');
      }

      // ==================== Data Loading ====================
      
      async function refreshAllData() {
          showLoading();
          try {
              await Promise.all([
                  loadOverviewData(),
                  loadVolunteerList(),
                  loadSponsorList()
              ]);
              updateStatus('âœ… è³‡æ–™å·²æ›´æ–°', 'success');
          } catch (error) {
              console.error('æ›´æ–°è³‡æ–™éŒ¯èª¤:', error);
              updateStatus('âŒ æ›´æ–°å¤±æ•—: ' + error.message, 'error');
          } finally {
              hideLoading();
          }
      }

      async function loadOverviewData() {
          try {
              const [volunteerResult, sponsorResult] = await Promise.all([
                  callAPI({ action: 'getVolunteerList' }),
                  callAPI({ action: 'getSponsorList' })
              ]);

              if (volunteerResult.success) {
                  allVolunteers = volunteerResult.volunteers || [];
                  
                  // Update statistics
                  document.getElementById('totalVolunteers').textContent = allVolunteers.length;
                  
                  // Count by shift
                  let allDayCount = 0;
                  let morningCount = 0;
                  let afternoonCount = 0;
                  
                  allVolunteers.forEach(v => {
                      if (v.workShift === 'å…¨å¤©ç­') allDayCount++;
                      else if (v.workShift === 'ä¸Šåˆç­') morningCount++;
                      else if (v.workShift === 'ä¸‹åˆç­') afternoonCount++;
                  });
                  
                  document.getElementById('allDayCount').textContent = allDayCount;
                  document.getElementById('morningCount').textContent = morningCount;
                  document.getElementById('afternoonCount').textContent = afternoonCount;
              }

              if (sponsorResult.success) {
                  allSponsors = sponsorResult.sponsors || [];
                  
                  const totalAmount = allSponsors.reduce((sum, s) => {
                      return sum + (parseInt(s.amount) || 0);
                  }, 0);
                  
                  document.getElementById('totalSponsors').textContent = allSponsors.length;
                  document.getElementById('totalAmount').textContent = '$' + totalAmount.toLocaleString();
              }
          } catch (error) {
              console.error('è¼‰å…¥ç¸½è¦½è³‡æ–™éŒ¯èª¤:', error);
              throw error;
          }
      }

      async function loadVolunteerList() {
          try {
              const result = await callAPI({ action: 'getVolunteerList' });
              
              if (result.success) {
                  allVolunteers = result.volunteers || [];
                  renderVolunteerTable(allVolunteers);
                  renderCheckinTable(allVolunteers);
              }
          } catch (error) {
              console.error('è¼‰å…¥å¿—å·¥åå–®éŒ¯èª¤:', error);
              document.getElementById('volunteerTableBody').innerHTML = 
                  '<tr><td colspan="9" class="text-center" style="color: #dc3545;">è¼‰å…¥å¤±æ•—</td></tr>';
          }
      }

      async function loadSponsorList() {
          try {
              const result = await callAPI({ action: 'getSponsorList' });
              
              if (result.success) {
                  allSponsors = result.sponsors || [];
                  renderSponsorTable(allSponsors);
              }
          } catch (error) {
              console.error('è¼‰å…¥è´ŠåŠ©åå–®éŒ¯èª¤:', error);
              document.getElementById('sponsorTableBody').innerHTML = 
                  '<tr><td colspan="8" class="text-center" style="color: #dc3545;">è¼‰å…¥å¤±æ•—</td></tr>';
          }
      }

      // ==================== Table Rendering ====================
      
      function renderVolunteerTable(volunteers) {
          const tbody = document.getElementById('volunteerTableBody');
          
          if (volunteers.length === 0) {
              tbody.innerHTML = `
                  <tr>
                      <td colspan="9">
                          <div class="empty-state">
                              <div class="empty-state-icon">ğŸ™‹</div>
                              <h3>å°šç„¡å¿—å·¥å ±å</h3>
                              <p>ç›®å‰é‚„æ²’æœ‰å¿—å·¥å ±åè¨˜éŒ„</p>
                          </div>
                      </td>
                  </tr>
              `;
              return;
          }
          
          let html = '';
          volunteers.forEach((v, index) => {
              const shiftBadge = getShiftBadge(v.workShift);
              const lunchBadge = v.lunch && v.lunch !== 'ç„¡' ? 
                  `<span class="badge badge-${v.lunch === 'è‘·é£Ÿ' ? 'meat' : 'veg'}">${v.lunch}</span>` : '-';
              
              html += `
                  <tr>
                      <td>#V${v.registrationId}</td>
                      <td>${v.registrationTime}</td>
                      <td><strong>${v.name}</strong></td>
                      <td>${v.phone}</td>
                      <td>${shiftBadge}</td>
                      <td>${lunchBadge}</td>
                      <td>${v.remarks || '-'}</td>
                      <td><span class="badge badge-active">å·²å ±å</span></td>
                      <td>
                          <button class="action-btn" style="padding: 5px 10px; font-size: 0.85em;" 
                                  onclick="showVolunteerDetail(${index})">
                              æŸ¥çœ‹
                          </button>
                      </td>
                  </tr>
              `;
          });
          
          tbody.innerHTML = html;
      }

      function renderSponsorTable(sponsors) {
          const tbody = document.getElementById('sponsorTableBody');
          
          if (sponsors.length === 0) {
              tbody.innerHTML = `
                  <tr>
                      <td colspan="8">
                          <div class="empty-state">
                              <div class="empty-state-icon">ğŸ’°</div>
                              <h3>å°šç„¡è´ŠåŠ©è¨˜éŒ„</h3>
                              <p>ç›®å‰é‚„æ²’æœ‰è´ŠåŠ©è¨˜éŒ„</p>
                          </div>
                      </td>
                  </tr>
              `;
              return;
          }
          
          let html = '';
          sponsors.forEach((s, index) => {
              html += `
                  <tr>
                      <td>#S${s.sponsorId}</td>
                      <td>${s.sponsorTime}</td>
                      <td><strong>${s.name}</strong></td>
                      <td>${s.phone}</td>
                      <td style="color: #28a745; font-weight: bold;">$${parseInt(s.amount).toLocaleString()}</td>
                      <td>${s.remarks || '-'}</td>
                      <td><span class="badge badge-active">å·²ç™»è¨˜</span></td>
                      <td>
                          <button class="action-btn" style="padding: 5px 10px; font-size: 0.85em;" 
                                  onclick="showSponsorDetail(${index})">
                              æŸ¥çœ‹
                          </button>
                      </td>
                  </tr>
              `;
          });
          
          tbody.innerHTML = html;
      }

      function renderCheckinTable(volunteers) {
          const tbody = document.getElementById('checkinTableBody');
          
          if (volunteers.length === 0) {
              tbody.innerHTML = `
                  <tr>
                      <td colspan="6">
                          <div class="empty-state">
                              <div class="empty-state-icon">âœ…</div>
                              <h3>å°šç„¡å¿—å·¥è¨˜éŒ„</h3>
                              <p>ç›®å‰é‚„æ²’æœ‰å¿—å·¥å ±åè¨˜éŒ„</p>
                          </div>
                      </td>
                  </tr>
              `;
              return;
          }
          
          let html = '';
          volunteers.forEach((v, index) => {
              const shiftBadge = getShiftBadge(v.workShift);
              const checkinTime = v.checkinTime || '-';
              const isCheckedIn = v.checkinTime && v.checkinTime !== '';
              
              html += `
                  <tr>
                      <td>#V${v.registrationId}</td>
                      <td><strong>${v.name}</strong></td>
                      <td>${v.phone}</td>
                      <td>${shiftBadge}</td>
                      <td>${checkinTime}</td>
                      <td>
                          ${isCheckedIn ? 
                              '<span class="badge badge-active">å·²ç°½åˆ°</span>' :
                              `<button class="action-btn btn-notify" style="padding: 5px 15px; font-size: 0.85em;" 
                                      onclick="checkInVolunteer(${index})">
                                  ç°½åˆ°
                              </button>`
                          }
                      </td>
                  </tr>
              `;
          });
          
          tbody.innerHTML = html;
      }

      function getShiftBadge(shift) {
          if (shift === 'å…¨å¤©ç­') {
              return '<span class="badge badge-all-day">ğŸŒŸ å…¨å¤©ç­</span>';
          } else if (shift === 'ä¸Šåˆç­') {
              return '<span class="badge badge-morning">â˜€ï¸ ä¸Šåˆç­</span>';
          } else if (shift === 'ä¸‹åˆç­') {
              return '<span class="badge badge-afternoon">ğŸŒ™ ä¸‹åˆç­</span>';
          }
          return shift;
      }

      // ==================== Search/Filter ====================
      
      function filterVolunteers() {
          const searchText = document.getElementById('volunteerSearch').value.toLowerCase();
          const filtered = allVolunteers.filter(v => 
              v.name.toLowerCase().includes(searchText) || 
              v.phone.includes(searchText)
          );
          renderVolunteerTable(filtered);
      }

      function filterSponsors() {
          const searchText = document.getElementById('sponsorSearch').value.toLowerCase();
          const filtered = allSponsors.filter(s => 
              s.name.toLowerCase().includes(searchText) || 
              s.phone.includes(searchText)
          );
          renderSponsorTable(filtered);
      }

      function filterCheckin() {
          const searchText = document.getElementById('checkinSearch').value.toLowerCase();
          const filtered = allVolunteers.filter(v => 
              v.name.toLowerCase().includes(searchText) || 
              v.phone.includes(searchText)
          );
          renderCheckinTable(filtered);
      }

      // ==================== Detail Modal ====================
      
      function showVolunteerDetail(index) {
          const v = allVolunteers[index];
          document.getElementById('modalTitle').textContent = 'å¿—å·¥è©³ç´°è³‡æ–™';
          document.getElementById('modalBody').innerHTML = `
              <div class="detail-row">
                  <div class="detail-label">å ±ååºè™Ÿï¼š</div>
                  <div class="detail-value">#V${v.registrationId}</div>
              </div>
              <div class="detail-row">
                  <div class="detail-label">å ±åæ™‚é–“ï¼š</div>
                  <div class="detail-value">${v.registrationTime}</div>
              </div>
              <div class="detail-row">
                  <div class="detail-label">å§“åï¼š</div>
                  <div class="detail-value"><strong>${v.name}</strong></div>
              </div>
              <div class="detail-row">
                  <div class="detail-label">é›»è©±ï¼š</div>
                  <div class="detail-value">${v.phone}</div>
              </div>
              <div class="detail-row">
                  <div class="detail-label">å·¥ä½œç­æ¬¡ï¼š</div>
                  <div class="detail-value">${getShiftBadge(v.workShift)}</div>
              </div>
              <div class="detail-row">
                  <div class="detail-label">åˆé¤éœ€æ±‚ï¼š</div>
                  <div class="detail-value">${v.lunch || 'ç„¡'}</div>
              </div>
              <div class="detail-row">
                  <div class="detail-label">å‚™è¨»ï¼š</div>
                  <div class="detail-value">${v.remarks || 'ç„¡'}</div>
              </div>
              <div class="detail-row">
                  <div class="detail-label">ç°½åˆ°æ™‚é–“ï¼š</div>
                  <div class="detail-value">${v.checkinTime || 'å°šæœªç°½åˆ°'}</div>
              </div>
          `;
          document.getElementById('detailModal').classList.add('show');
      }

      function showSponsorDetail(index) {
          const s = allSponsors[index];
          document.getElementById('modalTitle').textContent = 'è´ŠåŠ©è©³ç´°è³‡æ–™';
          document.getElementById('modalBody').innerHTML = `
              <div class="detail-row">
                  <div class="detail-label">è´ŠåŠ©åºè™Ÿï¼š</div>
                  <div class="detail-value">#S${s.sponsorId}</div>
              </div>
              <div class="detail-row">
                  <div class="detail-label">è´ŠåŠ©æ™‚é–“ï¼š</div>
                  <div class="detail-value">${s.sponsorTime}</div>
              </div>
              <div class="detail-row">
                  <div class="detail-label">å§“åï¼š</div>
                  <div class="detail-value"><strong>${s.name}</strong></div>
              </div>
              <div class="detail-row">
                  <div class="detail-label">é›»è©±ï¼š</div>
                  <div class="detail-value">${s.phone}</div>
              </div>
              <div class="detail-row">
                  <div class="detail-label">è´ŠåŠ©é‡‘é¡ï¼š</div>
                  <div class="detail-value" style="color: #28a745; font-weight: bold; font-size: 1.2em;">
                      $${parseInt(s.amount).toLocaleString()}
                  </div>
              </div>
              <div class="detail-row">
                  <div class="detail-label">å‚™è¨»ï¼š</div>
                  <div class="detail-value">${s.remarks || 'ç„¡'}</div>
              </div>
          `;
          document.getElementById('detailModal').classList.add('show');
      }

      function closeModal() {
          document.getElementById('detailModal').classList.remove('show');
      }

      // ==================== Actions ====================
      
      function exportVolunteerData() {
          if (allVolunteers.length === 0) {
              alert('ç›®å‰æ²’æœ‰å¿—å·¥è³‡æ–™å¯åŒ¯å‡º');
              return;
          }
          
          let csv = 'å ±ååºè™Ÿ,å ±åæ™‚é–“,å§“å,é›»è©±,å·¥ä½œç­æ¬¡,åˆé¤éœ€æ±‚,å‚™è¨»,ç°½åˆ°æ™‚é–“\n';
          
          allVolunteers.forEach(v => {
              csv += `#V${v.registrationId},${v.registrationTime},${v.name},${v.phone},${v.workShift},${v.lunch || 'ç„¡'},${v.remarks || ''},${v.checkinTime || ''}\n`;
          });
          
          const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `å¿—å·¥åå–®_${new Date().toLocaleDateString('zh-TW')}.csv`;
          link.click();
          
          updateStatus('âœ… å¿—å·¥åå–®å·²åŒ¯å‡º', 'success');
      }

      async function shareVolunteerStatus() {
          try {
              showLoading();
              const result = await callAPI({ 
                  action: 'shareVolunteerStatus',
                  adminId: userProfile.userId
              });
              
              if (result.success) {
                  updateStatus('âœ… å¿—å·¥ç‹€æ…‹å·²åˆ†äº«åˆ°ç¾¤çµ„', 'success');
              } else {
                  updateStatus('âŒ åˆ†äº«å¤±æ•—: ' + result.message, 'error');
              }
          } catch (error) {
              console.error('åˆ†äº«å¿—å·¥ç‹€æ…‹éŒ¯èª¤:', error);
              updateStatus('âŒ åˆ†äº«å¤±æ•—', 'error');
          } finally {
              hideLoading();
          }
      }

      function sendReminder() {
          alert('æé†’åŠŸèƒ½é–‹ç™¼ä¸­\n\nå°‡åœ¨æ´»å‹•å‰ä¸€å¤©è‡ªå‹•ç™¼é€æé†’è¨Šæ¯çµ¦æ‰€æœ‰å¿—å·¥');
      }

      async function checkInVolunteer(index) {
          if (!confirm('ç¢ºå®šè¦ç‚ºæ­¤å¿—å·¥ç°½åˆ°å—ï¼Ÿ')) {
              return;
          }
          
          try {
              showLoading();
              const v = allVolunteers[index];
              
              // TODO: Implement check-in API call
              alert('ç°½åˆ°åŠŸèƒ½é–‹ç™¼ä¸­\n\nå¿—å·¥ï¼š' + v.name + '\nç­æ¬¡ï¼š' + v.workShift);
              
              updateStatus('âœ… ç°½åˆ°æˆåŠŸ', 'success');
          } catch (error) {
              console.error('ç°½åˆ°éŒ¯èª¤:', error);
              updateStatus('âŒ ç°½åˆ°å¤±æ•—', 'error');
          } finally {
              hideLoading();
          }
      }

      // ==================== API Functions ====================
      
      function callAPI(params) {
          return new Promise((resolve, reject) => {
              const callbackName = 'jsonpCallback_' + Date.now();
              
              window[callbackName] = function(result) {
                  delete window[callbackName];
                  document.body.removeChild(script);
                  resolve(result);
              };

              const script = document.createElement('script');
              const urlParams = new URLSearchParams({
                  callback: callbackName,
                  ...params
              });
              script.src = `${gasUrl}?${urlParams.toString()}`;
              
              script.onerror = function() {
                  delete window[callbackName];
                  document.body.removeChild(script);
                  reject(new Error('ç¶²è·¯é€£ç·šå¤±æ•—'));
              };
              
              document.body.appendChild(script);
          });
      }

      // ==================== LIFF Initialization ====================
      
      document.addEventListener('DOMContentLoaded', function() {
          console.log('é–‹å§‹åˆå§‹åŒ–ç®¡ç†å¾Œå°...');
          
          liff.init({ liffId: liffId })
              .then(() => {
                  liffReady = true;
                  console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');
                  updateStatus('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ', 'success');

                  if (liff.isLoggedIn()) {
                      return liff.getProfile();
                  } else {
                      liff.login();
                      return null;
                  }
              })
              .then(async (profile) => {
                  if (profile) {
                      userProfile = profile;
                      console.log('ç”¨æˆ¶è³‡æ–™:', profile);
                      
                      // TODO: Check admin permission
                      updateStatus(`âœ… ç®¡ç†å“¡ï¼š${profile.displayName}`, 'success');
                      
                      // Load initial data
                      await refreshAllData();
                  }
              })
              .catch((err) => {
                  console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', err);
                  updateStatus('âŒ LIFF åˆå§‹åŒ–å¤±æ•—: ' + err.message, 'error');
              });
      });
  </script>
</body>
</html>
