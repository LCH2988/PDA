<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>協會管理前台</title>
    <script>
      // 設定你的 Apps Script Web App URL（doPost/doGet 入口）
      // 例如：https://script.google.com/macros/s/AKfycbxxxx/exec
      const API_BASE = 'https://script.google.com/macros/s/AKfycbwgbD_p1Onvd5UOgWGPaSHe4OIvm9sw85FoR8y7gyxc3WVb7LdebbYPOtNEpH1ojMH5/exec';
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <div class="max-w-6xl mx-auto p-4">
      <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <h1 class="text-2xl font-bold">協會管理系統</h1>
        <div class="flex items-center gap-2">
          <input id="lineIdInput" class="border rounded px-3 py-2 w-64" placeholder="輸入您的 lineId">
          <button id="saveLineIdBtn" class="bg-blue-600 text-white px-4 py-2 rounded">使用此身分</button>
        </div>
      </header>

      <nav class="mb-4">
        <ul class="flex flex-wrap gap-2">
          <li><button data-tab="dashboard" class="tab-btn bg-white border px-3 py-2 rounded">儀表板</button></li>
          <li><button data-tab="activities" class="tab-btn bg-white border px-3 py-2 rounded">活動</button></li>
          <li><button data-tab="volunteer" class="tab-btn bg-white border px-3 py-2 rounded">志工</button></li>
          <li><button data-tab="finance" class="tab-btn bg-white border px-3 py-2 rounded">財務</button></li>
          <li><button data-tab="feedback" class="tab-btn bg-white border px-3 py-2 rounded">回饋</button></li>
          <li><button data-tab="admin" class="tab-btn bg-white border px-3 py-2 rounded">管理</button></li>
        </ul>
      </nav>

      <section id="notice" class="hidden mb-4 p-3 rounded text-sm"></section>

      <!-- 儀表板 -->
      <section id="tab-dashboard" class="tab hidden">
        <div class="bg-white border rounded p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-xl font-semibold">儀表板</h2>
            <button id="refreshDashboardBtn" class="bg-gray-700 text-white px-3 py-2 rounded">重新整理</button>
          </div>
          <div id="dashboardStats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          <div id="dashboardAlerts" class="mt-4"></div>
        </div>
      </section>

      <!-- 活動 -->
      <section id="tab-activities" class="tab hidden">
        <div class="bg-white border rounded p-4 mb-4">
          <h2 class="text-lg font-semibold mb-2">活動列表</h2>
          <div class="flex items-center gap-2 mb-3">
            <button id="loadActivitiesBtn" class="bg-gray-700 text-white px-3 py-2 rounded">載入</button>
          </div>
          <div id="activityList" class="overflow-x-auto"></div>
        </div>

        <div class="bg-white border rounded p-4">
          <h3 class="font-semibold mb-2">建立活動（管理員）</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <input id="actTitle" class="border rounded px-3 py-2" placeholder="標題">
            <input id="actDate" type="date" class="border rounded px-3 py-2">
            <input id="actTime" class="border rounded px-3 py-2" placeholder="時間（可留空）">
            <input id="actLocation" class="border rounded px-3 py-2" placeholder="地點">
            <input id="actMax" type="number" class="border rounded px-3 py-2" placeholder="最大人數">
            <input id="actFee" type="number" class="border rounded px-3 py-2" placeholder="報名費（可 0）">
          </div>
          <div class="mt-3">
            <button id="createActivityBtn" class="bg-blue-600 text-white px-3 py-2 rounded">建立</button>
          </div>
        </div>
      </section>

      <!-- 志工 -->
      <section id="tab-volunteer" class="tab hidden">
        <div class="bg-white border rounded p-4 mb-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold">志工資訊</h2>
            <button id="loadVolunteerBtn" class="bg-gray-700 text-white px-3 py-2 rounded">載入</button>
          </div>
          <div id="volStats" class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3"></div>
          <div>
            <h3 class="font-semibold mb-2">開放志工需求</h3>
            <div id="volNeeds" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
          </div>
        </div>

        <div class="bg-white border rounded p-4">
          <h3 class="font-semibold mb-2">建立志工需求（管理員）</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <input id="volTitle" class="border rounded px-3 py-2" placeholder="標題">
            <input id="volDate" type="date" class="border rounded px-3 py-2">
            <input id="volTime" class="border rounded px-3 py-2" placeholder="時間（可留空）">
            <input id="volNeedCount" type="number" class="border rounded px-3 py-2" placeholder="需求人數">
            <input id="volHours" type="number" class="border rounded px-3 py-2" placeholder="時數">
            <input id="volDesc" class="border rounded px-3 py-2" placeholder="描述（可留空）">
          </div>
          <div class="mt-3">
            <button id="createVolunteerNeedBtn" class="bg-blue-600 text-white px-3 py-2 rounded">建立</button>
          </div>
        </div>
      </section>

      <!-- 財務 -->
      <section id="tab-finance" class="tab hidden">
        <div class="bg-white border rounded p-4 mb-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">我的財務紀錄</h2>
            <button id="loadFinanceBtn" class="bg-gray-700 text-white px-3 py-2 rounded">載入</button>
          </div>
          <div id="myFinanceStats" class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3"></div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div>
              <h3 class="font-semibold mb-2">我的捐款</h3>
              <div id="myDonations" class="overflow-x-auto"></div>
            </div>
            <div>
              <h3 class="font-semibold mb-2">我的支出申請</h3>
              <div id="myExpenses" class="overflow-x-auto"></div>
            </div>
          </div>
        </div>

        <div class="bg-white border rounded p-4 mb-4">
          <h3 class="font-semibold mb-2">新增捐款</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <input id="donAmount" type="number" class="border rounded px-3 py-2" placeholder="金額">
            <input id="donCategory" class="border rounded px-3 py-2" placeholder="類別（如 一般捐款）">
            <input id="donDesc" class="border rounded px-3 py-2" placeholder="描述（可留空）">
            <label class="inline-flex items-center gap-2">
              <input id="donNeedReceipt" type="checkbox"> 需要收據
            </label>
          </div>
          <div class="mt-3">
            <button id="createDonationBtn" class="bg-green-600 text-white px-3 py-2 rounded">送出捐款</button>
          </div>
        </div>

        <div class="bg-white border rounded p-4">
          <h3 class="font-semibold mb-2">新增支出申請</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <input id="expCategory" class="border rounded px-3 py-2" placeholder="類別（如 活動費用）">
            <input id="expAmount" type="number" class="border rounded px-3 py-2" placeholder="金額">
            <input id="expDesc" class="border rounded px-3 py-2" placeholder="描述（可留空）">
            <input id="expReceiptUrl" class="border rounded px-3 py-2" placeholder="憑證圖片連結（送出後也可更新）">
          </div>
          <div class="mt-3 flex items-center gap-2">
            <button id="createExpenseBtn" class="bg-green-600 text-white px-3 py-2 rounded">送出支出</button>
            <button id="updateExpenseReceiptBtn" class="bg-amber-600 text-white px-3 py-2 rounded" title="以 expenseId + 新連結更新">更新憑證</button>
            <input id="updExpenseId" class="border rounded px-2 py-2 w-56" placeholder="expenseId（更新時必填）">
          </div>
        </div>
      </section>

      <!-- 回饋 -->
      <section id="tab-feedback" class="tab hidden">
        <div class="bg-white border rounded p-4 mb-4">
          <h2 class="text-lg font-semibold mb-2">我的回饋</h2>
          <div class="flex items-center gap-2 mb-3">
            <button id="loadMyFeedbackBtn" class="bg-gray-700 text-white px-3 py-2 rounded">載入</button>
          </div>
          <div id="myFeedbackList" class="overflow-x-auto"></div>
        </div>

        <div class="bg-white border rounded p-4">
          <h3 class="font-semibold mb-2">提交回饋</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <input id="fbActivityId" class="border rounded px-3 py-2" placeholder="活動 ID">
            <input id="fbRating" type="number" min="1" max="5" class="border rounded px-3 py-2" placeholder="評分 1~5">
            <input id="fbComment" class="border rounded px-3 py-2" placeholder="意見（可留空）">
          </div>
          <div class="mt-3">
            <button id="createFeedbackBtn" class="bg-blue-600 text-white px-3 py-2 rounded">送出回饋</button>
          </div>
        </div>
      </section>

      <!-- 管理 -->
      <section id="tab-admin" class="tab hidden">
        <div class="bg-white border rounded p-4 mb-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">管理工具</h2>
            <button id="checkAdminBtn" class="bg-gray-700 text-white px-3 py-2 rounded">檢查權限</button>
          </div>
          <div id="adminCheckResult" class="mt-2 text-sm text-gray-700"></div>
        </div>

        <div class="bg-white border rounded p-4 mb-4">
          <h3 class="font-semibold mb-2">查詢全部捐款/支出/收據（管理員）</h3>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div>
              <div class="flex items-center gap-2 mb-2">
                <button id="loadAllDonationsBtn" class="bg-indigo-600 text-white px-3 py-2 rounded">載入捐款</button>
              </div>
              <div id="allDonations" class="overflow-x-auto"></div>
            </div>
            <div>
              <div class="flex items-center gap-2 mb-2">
                <button id="loadAllExpensesBtn" class="bg-indigo-600 text-white px-3 py-2 rounded">載入支出</button>
              </div>
              <div id="allExpenses" class="overflow-x-auto"></div>
            </div>
            <div>
              <div class="flex items-center gap-2 mb-2">
                <button id="loadAllReceiptsBtn" class="bg-indigo-600 text-white px-3 py-2 rounded">載入收據</button>
              </div>
              <div id="allReceipts" class="overflow-x-auto"></div>
            </div>
          </div>
        </div>

        <div class="bg-white border rounded p-4">
          <h3 class="font-semibold mb-2">審核支出（管理員）</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <input id="apvExpenseId" class="border rounded px-3 py-2" placeholder="expenseId">
            <select id="apvDecision" class="border rounded px-3 py-2">
              <option value="approve">核准</option>
              <option value="reject">拒絕</option>
            </select>
            <input id="apvPaymentDate" type="date" class="border rounded px-3 py-2" placeholder="付款日期（核准時可填）">
            <input id="apvPaymentMethod" class="border rounded px-3 py-2" placeholder="付款方式（例：轉帳）">
            <input id="apvPaymentAccount" class="border rounded px-3 py-2" placeholder="付款帳戶">
            <input id="apvBankTransferDate" type="date" class="border rounded px-3 py-2" placeholder="入帳日期">
            <input id="apvRejectReason" class="border rounded px-3 py-2" placeholder="拒絕原因（拒絕時可填）">
          </div>
          <div class="mt-3">
            <button id="approveExpenseBtn" class="bg-rose-600 text-white px-3 py-2 rounded">送出審核</button>
          </div>
        </div>
      </section>
    </div>

    <script>
      // 工具：通知
      function showNotice(msg, type='info') {
        const el = document.getElementById('notice');
        el.classList.remove('hidden');
        el.textContent = msg;
        el.className = 'mb-4 p-3 rounded text-sm';
        if (type === 'error') {
          el.classList.add('bg-red-100','text-red-800','border','border-red-300');
        } else if (type === 'success') {
          el.classList.add('bg-green-100','text-green-800','border','border-green-300');
        } else {
          el.classList.add('bg-blue-100','text-blue-800','border','border-blue-300');
        }
        setTimeout(()=> { el.classList.add('hidden'); }, 4000);
      }

      // 工具：簡易表格渲染
      function renderTable(containerId, rows) {
        const container = document.getElementById(containerId);
        if (!rows || rows.length === 0) {
          container.innerHTML = '<div class="text-gray-500 text-sm">無資料</div>';
          return;
        }
        const headers = Object.keys(rows[0]);
        let thead = '<thead><tr>' + headers.map(h=>'<th class="px-2 py-2 border-b text-left whitespace-nowrap text-sm">'+h+'</th>').join('') + '</tr></thead>';
        let tbody = '<tbody>' + rows.map(r=>{
          return '<tr>' + headers.map(h=>'<td class="px-2 py-2 border-b text-sm whitespace-nowrap">'+formatCell(r[h])+'</td>').join('') + '</tr>';
        }).join('') + '</tbody>';
        container.innerHTML = '<table class="min-w-full">'+ thead + tbody + '</table>';
      }

      function formatCell(v){
        if (v === null || v === undefined) return '';
        if (typeof v === 'object') {
          if (v instanceof Date) return v.toLocaleString();
          // Apps Script 回傳 JSON 的日期多為字串
          return JSON.stringify(v);
        }
        return String(v);
      }

      // API 呼叫
      async function api(action, data) {
        const payload = { action, data };
        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const txt = await res.text();
        // 你的後端 route 中，有些 action 回傳 resp()（包 success,message,data）
        // 也有少數使用 ContentService 直接回傳 { success, ... }
        // 這裡做容錯解析：
        let obj;
        try { obj = JSON.parse(txt); } catch (e) { throw new Error('Invalid JSON'); }
        return obj;
      }

      // 狀態：lineId
      function getLineId(){
        return localStorage.getItem('lineId') || '';
      }
      function setLineId(v){
        localStorage.setItem('lineId', v || '');
        document.getElementById('lineIdInput').value = v || '';
      }

      // 初始化 Tab
      function initTabs(){
        const btns = document.querySelectorAll('.tab-btn');
        btns.forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const t = btn.getAttribute('data-tab');
            document.querySelectorAll('.tab').forEach(el=> el.classList.add('hidden'));
            document.getElementById('tab-' + t).classList.remove('hidden');
          });
        });
        // 預設顯示儀表板
        document.querySelector('.tab-btn[data-tab="dashboard"]').click();
      }

      // 綁定事件
      function bindEvents(){
        document.getElementById('saveLineIdBtn').addEventListener('click', ()=>{
          const v = document.getElementById('lineIdInput').value.trim();
          if(!v){ showNotice('請輸入 lineId','error'); return; }
          setLineId(v);
          showNotice('已設定身分','success');
        });

        // 儀表板
        document.getElementById('refreshDashboardBtn').addEventListener('click', loadDashboard);

        // 活動
        document.getElementById('loadActivitiesBtn').addEventListener('click', loadActivities);
        document.getElementById('createActivityBtn').addEventListener('click', createActivity);

        // 志工
        document.getElementById('loadVolunteerBtn').addEventListener('click', loadVolunteer);
        document.getElementById('createVolunteerNeedBtn').addEventListener('click', createVolunteerNeed);

        // 財務
        document.getElementById('loadFinanceBtn').addEventListener('click', loadFinance);
        document.getElementById('createDonationBtn').addEventListener('click', createDonation);
        document.getElementById('createExpenseBtn').addEventListener('click', createExpense);
        document.getElementById('updateExpenseReceiptBtn').addEventListener('click', updateExpenseReceipt);

        // 回饋
        document.getElementById('loadMyFeedbackBtn').addEventListener('click', loadMyFeedback);
        document.getElementById('createFeedbackBtn').addEventListener('click', createFeedback);

        // 管理
        document.getElementById('checkAdminBtn').addEventListener('click', checkAdmin);
        document.getElementById('loadAllDonationsBtn').addEventListener('click', loadAllDonations);
        document.getElementById('loadAllExpensesBtn').addEventListener('click', loadAllExpenses);
        document.getElementById('loadAllReceiptsBtn').addEventListener('click', loadAllReceipts);
        document.getElementById('approveExpenseBtn').addEventListener('click', approveExpense);
      }

      // 載入儀表板
      async function loadDashboard(){
        const lineId = getLineId();
        if(!lineId){ showNotice('請先設定 lineId','error'); return; }
        try{
          const r = await api('getAdminDashboard', { lineId });
          if(!r.success){ showNotice(r.message || '非管理員或查詢失敗','error'); return; }
          const d = r.data || r; // 容錯
          const stats = d.data || d; // route 兼容
          const s = stats;
          const cards = [
            { label:'會員總數', value: s.totalMembers },
            { label:'活躍會員', value: s.activeMembers },
            { label:'活動總數', value: s.totalActivities },
            { label:'開放活動', value: s.activeActivities },
            { label:'本月捐款', value: s.monthlyDonations },
            { label:'本月支出', value: s.monthlyExpenses },
            { label:'待審核支出', value: s.pendingExpenseApprovals },
            { label:'帳戶餘額', value: s.accountBalance },
          ];
          const box = cards.map(c=>`
            <div class="border rounded p-3">
              <div class="text-sm text-gray-600">${c.label}</div>
              <div class="text-xl font-semibold">${c.value ?? 0}</div>
            </div>
          `).join('');
          document.getElementById('dashboardStats').innerHTML = box;

          const alerts = (s.alerts || []).map(a=>`
            <div class="p-3 rounded border ${a.type==='warning'?'bg-yellow-50 border-yellow-200':'bg-blue-50 border-blue-200'} mb-2">
              <div class="font-semibold">${a.title}</div>
              <div class="text-sm">${a.message}</div>
            </div>
          `).join('');
          document.getElementById('dashboardAlerts').innerHTML = alerts || '<div class="text-sm text-gray-500">無提醒</div>';
          showNotice('儀表板已更新','success');
        }catch(e){ showNotice(e.message,'error'); }
      }

      // 活動 - 載入
      async function loadActivities(){
        try{
          const r = await api('getActivities', {});
          const list = (r.data || r) || [];
          renderTable('activityList', list);
          showNotice('活動載入完成','success');
        }catch(e){ showNotice(e.message,'error'); }
      }

      // 活動 - 建立（管理員）
      async function createActivity(){
        const lineId = getLineId();
        const title = document.getElementById('actTitle').value.trim();
        const date = document.getElementById('actDate').value;
        const time = document.getElementById('actTime').value.trim();
        const location = document.getElementById('actLocation').value.trim();
        const max = document.getElementById('actMax').value;
        const fee = document.getElementById('actFee').value || 0;
        if(!lineId || !title || !date || !max){ showNotice('欄位不足','error'); return; }
        try{
          const r = await api('createActivity', { lineId, title, date, time, location, maxParticipants: Number(max), fee: Number(fee) });
          if(!r.success) { showNotice(r.message || '建立失敗','error'); return; }
          showNotice('活動已建立','success');
          loadActivities();
        }catch(e){ showNotice(e.message,'error'); }
      }

      // 志工 - 載入
      async function loadVolunteer(){
        const lineId = getLineId();
        if(!lineId){ showNotice('請先設定 lineId','error'); return; }
        try{
          const r = await api('getVolunteerData', { lineId });
          if(!r.success){ showNotice(r.message || '載入失敗','error'); return; }
          const d = r.data || {};
          const st = d.stats || {};
          document.getElementById('volStats').innerHTML = `
            <div class="border rounded p-3"><div class="text-sm text-gray-600">總時數</div><div class="text-xl font-semibold">${st.totalHours||0}</div></div>
            <div class="border rounded p-3"><div class="text-sm text-gray-600">參與次數</div><div class="text-xl font-semibold">${st.totalActivities||0}</div></div>
            <div class="border rounded p-3"><div class="text-sm text-gray-600">可報名需求</div><div class="text-xl font-semibold">${st.availableNeeds||0}</div></div>
          `;
          const needs = d.needs || [];
          document.getElementById('volNeeds').innerHTML = needs.map(n=>`
            <div class="border rounded p-3">
              <div class="font-semibold">${n.title}</div>
              <div class="text-sm text-gray-600">${n.date||''} ${n.time||''}</div>
              <div class="text-sm">需求：${n.currentCount}/${n.needCount} 人，時數 ${n.hours}</div>
              <div class="mt-2">
                <button class="bg-emerald-600 text-white px-3 py-1 rounded" onclick="applyVolunteer('${n.id}')">報名</button>
              </div>
            </div>
          `).join('') || '<div class="text-sm text-gray-500">目前無開放需求</div>';
          showNotice('志工資料已載入','success');
        }catch(e){ showNotice(e.message,'error'); }
      }

      async function applyVolunteer(needId){
        const lineId = getLineId();
        if(!lineId){ showNotice('請先設定 lineId','error'); return; }
        try{
          const r = await api('applyVolunteer', { lineId, needId });
          if(!r.success){ showNotice(r.message || '報名失敗','error'); return; }
          showNotice('志工報名成功','success');
          loadVolunteer();
        }catch(e){ showNotice(e.message,'error'); }
      }

      // 財務 - 載入我的資料
      async function loadFinance(){
        const lineId = getLineId();
        if(!lineId){ showNotice('請先設定 lineId','error'); return; }
        try{
          const r = await api('getFinanceData', { lineId });
          if(!r.success){ showNotice(r.message || '載入失敗','error'); return; }
          const d = r.data || r;
          const stats = d.stats || {};
          document.getElementById('myFinanceStats').innerHTML = `
            <div class="border rounded p-3"><div class="text-sm text-gray-600">我的捐款金額</div><div class="text-xl font-semibold">${stats.totalDonation||0}</div></div>
            <div class="border rounded p-3"><div class="text-sm text-gray-600">我的支出金額</div><div class="text-xl font-semibold">${stats.totalExpense||0}</div></div>
            <div class="border rounded p-3"><div class="text-sm text-gray-600">待審核支出</div><div class="text-xl font-semibold">${stats.pendingExpenseCount||stats.pendingExpenses||0}</div></div>
          `;
          renderTable('myDonations', d.donations || []);
          // 額外載入我的支出，因 getFinanceData 已提供 myExp 匯總，但也示範 getMyExpenses
          const me = await api('getMyExpenses', { lineId });
          renderTable('myExpenses', (me.data || me) || []);
          showNotice('財務資料已載入','success');
        }catch(e){ showNotice(e.message,'error'); }
      }

      // 財務 - 新增捐款
      async function createDonation(){
        const lineId = getLineId();
        const amount = Number(document.getElementById('donAmount').value || 0);
        const category = document.getElementById('donCategory').value.trim();
        const description = document.getElementById('donDesc').value.trim();
        const needReceipt = document.getElementById('donNeedReceipt').checked;
        if(!lineId || !amount || !category){ showNotice('欄位不足','error'); return; }
        try{
          const r = await api('createDonation', { lineId, amount, category, description, needReceipt });
          if(!r.success){ showNotice(r.message || '捐款失敗','error'); return; }
          showNotice('捐款成功','success');
          loadFinance();
        }catch(e){ showNotice(e.message,'error'); }
      }

      // 財務 - 新增支出
      async function createExpense(){
        const lineId = getLineId();
        const category = document.getElementById('expCategory').value.trim();
        const amount = Number(document.getElementById('expAmount').value || 0);
        const description = document.getElementById('expDesc').value.trim();
        const receiptImage = document.getElementById('expReceiptUrl').value.trim();
        if(!lineId || !category || !amount){ showNotice('欄位不足','error'); return; }
        try{
          const r = await api('createExpense', { lineId, category, amount, description });
          if(!r.success){ showNotice(r.message || '建立失敗','error'); return; }
          const expenseId = (r.data && r.data.id) ? r.data.id : null;
          if (expenseId && receiptImage) {
            // 立即更新憑證
            await api('updateExpenseReceiptImage', { lineId, expenseId, receiptImage });
          }
          showNotice('支出申請已送出','success');
          loadFinance();
        }catch(e){ showNotice(e.message,'error'); }
      }

      // 財務 - 更新憑證
      async function updateExpenseReceipt(){
        const lineId = getLineId();
        const expenseId = document.getElementById('updExpenseId').value.trim();
        const receiptImage = document.getElementById('expReceiptUrl').value.trim();
        if(!lineId || !expenseId || !receiptImage){ showNotice('請填齊 expenseId 與 憑證連結','error'); return; }
        try{
          const r = await api('updateExpenseReceiptImage', { lineId, expenseId, receiptImage });
          if(!r.success){ showNotice(r.message || '更新失敗','error'); return; }
          showNotice('憑證已更新','success');
          loadFinance();
        }catch(e){ showNotice(e.message,'error'); }
      }

      // 回饋 - 載入我的回饋
      async function loadMyFeedback(){
        const lineId = getLineId();
        if(!lineId){ showNotice('請先設定 lineId','error'); return; }
        try{
          const r = await api('getMyFeedback', { lineId });
          if(!r.success){ showNotice(r.message || '載入失敗','error'); return; }
          renderTable('myFeedbackList', (r.data || r) || []);
          showNotice('我的回饋已載入','success');
        }catch(e){ showNotice(e.message,'error'); }
      }

      // 回饋 - 新增
      async function createFeedback(){
        const lineId = getLineId();
        const activityId = document.getElementById('fbActivityId').value.trim();
        const rating = Number(document.getElementById('fbRating').value || 0);
        const comment = document.getElementById('fbComment').value.trim();
        if(!lineId || !activityId || !rating){ showNotice('欄位不足','error'); return; }
        try{
          const r = await api('createFeedback', { lineId, activityId, rating, comment });
          if(!r.success){ showNotice(r.message || '送出失敗','error'); return; }
          showNotice('回饋已送出','success');
          loadMyFeedback();
        }catch(e){ showNotice(e.message,'error'); }
      }

      // 管理 - 檢查權限
      async function checkAdmin(){
        const lineId = getLineId();
        if(!lineId){ showNotice('請先設定 lineId','error'); return; }
        try{
          const r = await api('checkAdminPermission', { lineId });
          const el = document.getElementById('adminCheckResult');
          if(r.success){
            el.textContent = '您是管理員：' + (r.data?.displayName || r.data?.lineId || '');
            showNotice('您具有管理員權限','success');
          }else{
            el.textContent = '您不是管理員';
            showNotice('您不是管理員','error');
          }
        }catch(e){ showNotice(e.message,'error'); }
      }

      // 管理 - 載入全部捐款
      async function loadAllDonations(){
        const lineId = getLineId();
        if(!lineId){ showNotice('請先設定 lineId','error'); return; }
        try{
          const r = await api('getAllDonations', { lineId });
          if(!r.success){ showNotice(r.message || '讀取失敗','error'); return; }
          renderTable('allDonations', (r.data || r) || []);
          showNotice('捐款列表已載入','success');
        }catch(e){ showNotice(e.message,'error'); }
      }

      // 管理 - 載入全部支出
      async function loadAllExpenses(){
        const lineId = getLineId();
        if(!lineId){ showNotice('請先設定 lineId','error'); return; }
        try{
          const r = await api('getAllExpenses', { lineId });
          if(!r.success){ showNotice(r.message || '讀取失敗','error'); return; }
          renderTable('allExpenses', (r.data || r) || []);
          showNotice('支出列表已載入','success');
        }catch(e){ showNotice(e.message,'error'); }
      }

      // 管理 - 載入全部收據
      async function loadAllReceipts(){
        const lineId = getLineId();
        if(!lineId){ showNotice('請先設定 lineId','error'); return; }
        try{
          const r = await api('getAllReceipts', { lineId });
          if(!r.success){ showNotice(r.message || '讀取失敗','error'); return; }
          renderTable('allReceipts', (r.data || r) || []);
          showNotice('收據列表已載入','success');
        }catch(e){ showNotice(e.message,'error'); }
      }

      // 管理 - 支出審核
      async function approveExpense(){
        const lineId = getLineId();
        const expenseId = document.getElementById('apvExpenseId').value.trim();
        const decision = document.getElementById('apvDecision').value;
        const paymentDate = document.getElementById('apvPaymentDate').value || '';
        const paymentMethod = document.getElementById('apvPaymentMethod').value.trim();
        const paymentAccount = document.getElementById('apvPaymentAccount').value.trim();
        const bankTransferDate = document.getElementById('apvBankTransferDate').value || '';
        const reason = document.getElementById('apvRejectReason').value.trim();

        if(!lineId || !expenseId || !decision){ showNotice('請填齊欄位','error'); return; }
        try{
          const payload = { lineId, expenseId, decision };
          if(decision === 'approve'){
            payload.paymentInfo = { paymentDate, paymentMethod, paymentAccount, bankTransferDate };
          }else{
            payload.reason = reason || '不符合規範';
          }
          const r = await api('approveExpenseWithPayment', payload);
          if(!r.success){ showNotice(r.message || '審核失敗','error'); return; }
          showNotice('已完成審核','success');
          loadAllExpenses();
        }catch(e){ showNotice(e.message,'error'); }
      }

      // 初始
      (function init(){
        setLineId(getLineId());
        initTabs();
        bindEvents();
      })();
    </script>
  </body>
</html>
