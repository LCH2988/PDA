
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ - æœƒå“¡ç®¡ç†ç³»çµ±</title>
    
    <style>
        /* ==================== åŸºç¤æ¨£å¼ ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* ==================== æ¨™é¡Œå€ ==================== */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 30px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-left: 15px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }
        
        /* ==================== å°èˆªé¸å–® ==================== */
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .nav-tabs::-webkit-scrollbar {
            height: 4px;
        }
        
        .nav-tabs::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 2px;
        }
        
        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 18px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #666;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
        }
        
        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }
        
        .nav-tab.active {
            color: #667eea;
            font-weight: 600;
        }
        
        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }
        
        /* ==================== å…§å®¹å€ ==================== */
        .content {
            padding: 30px;
            min-height: 500px;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ==================== ç™»å…¥/è¨»å†Šè¡¨å–® ==================== */
        .auth-container {
            max-width: 450px;
            margin: 50px auto;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .auth-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #666;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
        }
        
        .auth-tab.active {
            color: #667eea;
            font-weight: 600;
        }
        
        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* ==================== æŒ‰éˆ•æ¨£å¼ ==================== */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }
        
        .btn-block {
            width: 100%;
            display: block;
        }
        
        .btn-sm {
            padding: 8px 20px;
            font-size: 13px;
        }
        
        .btn-lg {
            padding: 15px 40px;
            font-size: 16px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* ==================== å¡ç‰‡æ¨£å¼ ==================== */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }
        
        .card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        
        .card-header {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-body {
            color: #666;
            line-height: 1.6;
        }
        
        /* ==================== çµ±è¨ˆå¡ç‰‡ ==================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .stat-card .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .stat-card .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* ==================== è¡¨æ ¼æ¨£å¼ ==================== */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* ==================== ç‹€æ…‹æ¨™ç±¤ ==================== */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .badge-primary {
            background: #cfe2ff;
            color: #084298;
        }
        
        /* ==================== è¨Šæ¯æç¤º ==================== */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        /* ==================== è¼‰å…¥å‹•ç•« ==================== */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ==================== ç©ºç‹€æ…‹ ==================== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .empty-state-subtext {
            font-size: 14px;
            color: #bbb;
        }
        
        /* ==================== éŸ¿æ‡‰å¼è¨­è¨ˆ ==================== */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            
            .container {
                border-radius: 0;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .user-info {
                position: static;
                margin-top: 15px;
                display: inline-block;
            }
            
            .content {
                padding: 20px;
            }
            
            .nav-tab {
                min-width: 100px;
                padding: 15px 10px;
                font-size: 13px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .table-container {
                font-size: 12px;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
        
        /* ==================== å·¥å…·é¡ ==================== */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }
        
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-30 { margin-bottom: 30px; }
        
        .hidden { display: none !important; }
        
        .flex { display: flex; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-10 { gap: 10px; }
        .gap-20 { gap: 20px; }
    </style>
</head>
<body>

 <!-- ==================== ç™»å…¥/è¨»å†Šå®¹å™¨ ==================== -->
    <div id="authContainer" class="auth-container">
        <h2 style="text-align: center; color: #667eea; margin-bottom: 30px;">
            ğŸ¥ å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ
        </h2>
        
        <!-- ç™»å…¥/è¨»å†Šåˆ‡æ› -->
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchAuthTab('login')">æœƒå“¡ç™»å…¥</button>
            <button class="auth-tab" onclick="switchAuthTab('register')">æ–°æœƒå“¡è¨»å†Š</button>
        </div>
        
        <!-- ç™»å…¥è¡¨å–® -->
        <div id="loginForm" class="auth-form">
            <div class="form-group">
                <label>æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆå¸³è™Ÿï¼‰</label>
                <input type="tel" id="loginAccount" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼" maxlength="15">
            </div>
            
            <div class="form-group">
                <label>å¯†ç¢¼</label>
                <input type="password" id="loginPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            </div>
            
            <button class="btn btn-primary btn-block btn-lg" onclick="login()">
                ç™»å…¥
            </button>
            
            <div style="text-align: center; margin-top: 20px; color: #999; font-size: 14px;">
                <p>æˆ–ä½¿ç”¨ QR Code å¿«é€Ÿç™»å…¥</p>
                <button class="btn btn-secondary mt-10" onclick="showQRCodeLogin()">
                    ğŸ“± QR Code ç™»å…¥
                </button>
            </div>
        </div>
        
        <!-- è¨»å†Šè¡¨å–® -->
        <div id="registerForm" class="auth-form hidden">
            <div class="form-group">
                <label>å§“å <span style="color: red;">*</span></label>
                <input type="text" id="regName" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>æ€§åˆ¥</label>
                    <select id="regGender">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>å‡ºç”Ÿæ—¥æœŸ</label>
                    <input type="date" id="regBirthDate">
                </div>
            </div>
            
            <div class="form-group">
                <label>æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆå°‡ä½œç‚ºå¸³è™Ÿï¼‰<span style="color: red;">*</span></label>
                <input type="tel" id="regPhone" placeholder="ä¾‹ï¼š0912345678" maxlength="15" required>
            </div>
            
            <div class="form-group">
                <label>é›»å­éƒµä»¶</label>
                <input type="email" id="regEmail" placeholder="example@email.com">
            </div>
            
            <div class="form-group">
                <label>èº«åˆ†è­‰å­—è™Ÿ</label>
                <input type="text" id="regIdNumber" placeholder="è«‹è¼¸å…¥èº«åˆ†è­‰å­—è™Ÿ" maxlength="10">
            </div>
            
            <div class="form-group">
                <label>å¯†ç¢¼ <span style="color: red;">*</span></label>
                <input type="password" id="regPassword" placeholder="è‡³å°‘6å€‹å­—å…ƒ" required>
            </div>
            
            <div class="form-group">
                <label>ç¢ºèªå¯†ç¢¼ <span style="color: red;">*</span></label>
                <input type="password" id="regPasswordConfirm" placeholder="è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼" required>
            </div>
            
            <button class="btn btn-primary btn-block btn-lg" onclick="register()">
                è¨»å†Š
            </button>
            
            <div style="text-align: center; margin-top: 15px; color: #999; font-size: 13px;">
                è¨»å†Šå³è¡¨ç¤ºæ‚¨åŒæ„æœ¬æœƒçš„æœå‹™æ¢æ¬¾èˆ‡éš±ç§æ”¿ç­–
            </div>
        </div>
    </div>
    
    <!-- ==================== ä¸»ç³»çµ±å®¹å™¨ ==================== -->
    <div id="mainContainer" class="container hidden">
        <!-- æ¨™é¡Œå€ -->
        <div class="header">
            <h1>ğŸ¥ å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ</h1>
            <p>Parkinson's Disease Association - æœƒå“¡ç®¡ç†ç³»çµ±</p>
            
            <div class="user-info">
                <span id="userName">è¼‰å…¥ä¸­...</span>
                <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>
        
        <!-- å°èˆªé¸å–® -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">ğŸ“Š é¦–é </button>
            <button class="nav-tab" onclick="switchTab('profile')">ğŸ‘¤ å€‹äººè³‡æ–™</button>
            <button class="nav-tab" onclick="switchTab('activities')">ğŸ“… æ´»å‹•ç®¡ç†</button>
            <button class="nav-tab" onclick="switchTab('forum')">ğŸ’¬ è«–å£‡</button>
            <button class="nav-tab" onclick="switchTab('resources')">ğŸ“š è³‡æºä¸­å¿ƒ</button>
            <button class="nav-tab" onclick="switchTab('finance')">ğŸ’° è²¡å‹™ç®¡ç†</button>
            <button class="nav-tab" id="adminTab" class="hidden" onclick="switchTab('admin')">âš™ï¸ ç®¡ç†å¾Œå°</button>
        </div>
        
        <!-- å…§å®¹å€ -->
        <div class="content">
            <!-- é¦–é  -->
            <div id="dashboardTab" class="tab-content active">
                <h2 class="mb-20">æ­¡è¿å›ä¾†ï¼</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statActivities">0</div>
                        <div class="stat-label">æˆ‘çš„æ´»å‹•å ±å</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statPosts">0</div>
                        <div class="stat-label">æˆ‘çš„è«–å£‡è²¼æ–‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statFees">0</div>
                        <div class="stat-label">å·²ç¹³æœƒè²»å¹´åº¦</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ“¢ æœ€æ–°å…¬å‘Š</div>
                    <div class="card-body">
                        <p>æ­¡è¿ä½¿ç”¨å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒæœƒå“¡ç®¡ç†ç³»çµ±ï¼</p>
                        <p class="mt-10">æ‚¨å¯ä»¥åœ¨é€™è£¡ï¼š</p>
                        <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                            <li>æŸ¥çœ‹å’Œå ±åæœ€æ–°æ´»å‹•</li>
                            <li>åœ¨è«–å£‡èˆ‡å…¶ä»–ç—…å‹äº¤æµ</li>
                            <li>ç€è¦½è±å¯Œçš„è¡›æ•™è³‡æº</li>
                            <li>ç®¡ç†æ‚¨çš„æœƒè²»å’Œææ¬¾</li>
                        </ul>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ¯ å¿«é€Ÿæ“ä½œ</div>
                    <div class="card-body flex flex-wrap gap-10">
                        <button class="btn btn-primary" onclick="switchTab('activities')">å ±åæ´»å‹•</button>
                        <button class="btn btn-success" onclick="switchTab('finance')">ç¹³äº¤æœƒè²»</button>
                        <button class="btn btn-info" onclick="switchTab('forum')">ç™¼è¡¨è²¼æ–‡</button>
                        <button class="btn btn-warning" onclick="switchTab('resources')">ç€è¦½è³‡æº</button>
                    </div>
                </div>
            </div>
            
            <!-- å€‹äººè³‡æ–™ -->
            <div id="profileTab" class="tab-content">
                <h2 class="mb-20">å€‹äººè³‡æ–™</h2>
                
                <div class="card">
                    <div class="card-header">åŸºæœ¬è³‡æ–™</div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>å§“å</label>
                                <input type="text" id="profileName" placeholder="è«‹è¼¸å…¥å§“å">
                            </div>
                            <div class="form-group">
                                <label>æ€§åˆ¥</label>
                                <select id="profileGender">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <option value="ç”·">ç”·</option>
                                    <option value="å¥³">å¥³</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>å‡ºç”Ÿæ—¥æœŸ</label>
                                <input type="date" id="profileBirthDate">
                            </div>
                            <div class="form-group">
                                <label>é›»è©±</label>
                                <input type="tel" id="profilePhone" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>é›»å­éƒµä»¶</label>
                            <input type="email" id="profileEmail" placeholder="Email">
                        </div>
                        
                        <div class="form-group">
                            <label>åœ°å€</label>
                            <input type="text" id="profileAddress" placeholder="è¯çµ¡åœ°å€">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>ç·Šæ€¥è¯çµ¡äºº</label>
                                <input type="text" id="profileEmergencyContact" placeholder="ç·Šæ€¥è¯çµ¡äººå§“å">
                            </div>
                            <div class="form-group">
                                <label>ç·Šæ€¥è¯çµ¡é›»è©±</label>
                                <input type="tel" id="profileEmergencyPhone" placeholder="ç·Šæ€¥è¯çµ¡é›»è©±">
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="updateProfile()">å„²å­˜è®Šæ›´</button>
                    </div>
                </div>
                
                <div class="card mt-20">
                    <div class="card-header">é†«ç™‚è³‡è¨Š</div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>è¨ºæ–·æ—¥æœŸ</label>
                            <input type="date" id="profileDiagnosisDate">
                        </div>
                        
                        <div class="form-group">
                            <label>ä¸»æ²»é†«å¸«</label>
                            <input type="text" id="profileDoctor" placeholder="ä¸»æ²»é†«å¸«å§“å">
                        </div>
                        
                        <div class="form-group">
                            <label>ç”¨è—¥è¨˜éŒ„</label>
                            <textarea id="profileMedication" placeholder="è«‹è¼¸å…¥ç›®å‰ä½¿ç”¨çš„è—¥ç‰©"></textarea>
                        </div>
                        
                        <button class="btn btn-primary" onclick="updateProfile()">å„²å­˜è®Šæ›´</button>
                    </div>
                </div>
                
                <div class="card mt-20">
                    <div class="card-header">è®Šæ›´å¯†ç¢¼</div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>èˆŠå¯†ç¢¼</label>
                            <input type="password" id="oldPassword" placeholder="è«‹è¼¸å…¥èˆŠå¯†ç¢¼">
                        </div>
                        
                        <div class="form-group">
                            <label>æ–°å¯†ç¢¼</label>
                            <input type="password" id="newPassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼">
                        </div>
                        
                        <div class="form-group">
                            <label>ç¢ºèªæ–°å¯†ç¢¼</label>
                            <input type="password" id="newPasswordConfirm" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
                        </div>
                        
                        <button class="btn btn-warning" onclick="changePassword()">è®Šæ›´å¯†ç¢¼</button>
                    </div>
                </div>
            </div>

<!-- æ´»å‹•ç®¡ç† -->
            <div id="activitiesTab" class="tab-content">
                <h2 class="mb-20">æ´»å‹•ç®¡ç†</h2>
                
                <!-- æ´»å‹•ç¯©é¸ -->
                <div class="card mb-20">
                    <div class="card-body">
                        <div class="flex flex-wrap gap-10">
                            <button class="btn btn-primary" onclick="loadActivities('all')">å…¨éƒ¨æ´»å‹•</button>
                            <button class="btn btn-success" onclick="loadActivities('open')">é–‹æ”¾å ±å</button>
                            <button class="btn btn-secondary" onclick="loadActivities('closed')">å·²çµæŸ</button>
                            <button class="btn btn-info" onclick="loadMyRegistrations()">æˆ‘çš„å ±å</button>
                            <button class="btn btn-warning admin-only hidden" onclick="showCreateActivityModal()">â• å»ºç«‹æ´»å‹•</button>
                        </div>
                    </div>
                </div>
                
                <!-- æ´»å‹•åˆ—è¡¨ -->
                <div id="activitiesList">
                    <div class="loading">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
            
            <!-- è«–å£‡ -->
            <div id="forumTab" class="tab-content">
                <h2 class="mb-20">è«–å£‡è¨è«–</h2>
                
                <!-- è«–å£‡æ“ä½œåˆ— -->
                <div class="card mb-20">
                    <div class="card-body">
                        <div class="flex flex-wrap gap-10">
                            <button class="btn btn-primary" onclick="showCreatePostModal()">âœï¸ ç™¼è¡¨è²¼æ–‡</button>
                            <button class="btn btn-info" onclick="loadForumPosts('all')">å…¨éƒ¨è²¼æ–‡</button>
                            <button class="btn btn-success" onclick="loadMyPosts()">æˆ‘çš„è²¼æ–‡</button>
                            
                            <div style="flex: 1; min-width: 200px;">
                                <input type="text" id="forumSearchInput" placeholder="æœå°‹è²¼æ–‡..." 
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <button class="btn btn-secondary" onclick="searchForumPosts()">ğŸ” æœå°‹</button>
                        </div>
                        
                        <div class="flex flex-wrap gap-10 mt-10">
                            <label style="margin-right: 10px;">åˆ†é¡ç¯©é¸ï¼š</label>
                            <button class="btn btn-sm btn-outline" onclick="loadForumPosts('all')">å…¨éƒ¨</button>
                            <button class="btn btn-sm btn-outline" onclick="loadForumPosts('ç–¾ç—…çŸ¥è­˜')">ç–¾ç—…çŸ¥è­˜</button>
                            <button class="btn btn-sm btn-outline" onclick="loadForumPosts('ç”Ÿæ´»åˆ†äº«')">ç”Ÿæ´»åˆ†äº«</button>
                            <button class="btn btn-sm btn-outline" onclick="loadForumPosts('æ²»ç™‚ç¶“é©—')">æ²»ç™‚ç¶“é©—</button>
                            <button class="btn btn-sm btn-outline" onclick="loadForumPosts('å¿ƒæƒ…æŠ’ç™¼')">å¿ƒæƒ…æŠ’ç™¼</button>
                            <button class="btn btn-sm btn-outline" onclick="loadForumPosts('å…¶ä»–')">å…¶ä»–</button>
                        </div>
                    </div>
                </div>
                
                <!-- è«–å£‡è²¼æ–‡åˆ—è¡¨ -->
                <div id="forumPostsList">
                    <div class="loading">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
            
            <!-- è³‡æºä¸­å¿ƒ -->
            <div id="resourcesTab" class="tab-content">
                <h2 class="mb-20">è³‡æºä¸­å¿ƒ</h2>
                
                <!-- è³‡æºç¯©é¸ -->
                <div class="card mb-20">
                    <div class="card-body">
                        <div class="flex flex-wrap gap-10">
                            <button class="btn btn-primary" onclick="loadResources('all')">å…¨éƒ¨è³‡æº</button>
                            <button class="btn btn-info" onclick="loadResources('è¡›æ•™æ–‡ç« ')">è¡›æ•™æ–‡ç« </button>
                            <button class="btn btn-success" onclick="loadResources('å½±ç‰‡')">å½±ç‰‡</button>
                            <button class="btn btn-warning" onclick="loadResources('æ‰‹å†Š')">æ‰‹å†Š</button>
                            <button class="btn btn-secondary" onclick="loadResources('é€£çµ')">ç›¸é—œé€£çµ</button>
                            <button class="btn btn-danger admin-only hidden" onclick="showCreateResourceModal()">â• æ–°å¢è³‡æº</button>
                        </div>
                        
                        <div class="flex gap-10 mt-10">
                            <input type="text" id="resourceSearchInput" placeholder="æœå°‹è³‡æº..." 
                                   style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            <button class="btn btn-secondary" onclick="searchResources()">ğŸ” æœå°‹</button>
                        </div>
                    </div>
                </div>
                
                <!-- è³‡æºåˆ—è¡¨ -->
                <div id="resourcesList">
                    <div class="loading">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
            
            <!-- è²¡å‹™ç®¡ç† -->
            <div id="financeTab" class="tab-content">
                <h2 class="mb-20">è²¡å‹™ç®¡ç†</h2>
                
                <!-- è²¡å‹™é¸å–® -->
                <div class="card mb-20">
                    <div class="card-body">
                        <div class="flex flex-wrap gap-10">
                            <button class="btn btn-primary" onclick="showFinanceSection('memberFee')">ç¹³äº¤æœƒè²»</button>
                            <button class="btn btn-success" onclick="showFinanceSection('donation')">æ„›å¿ƒææ¬¾</button>
                            <button class="btn btn-info" onclick="showFinanceSection('history')">ç¹³è²»è¨˜éŒ„</button>
                            <button class="btn btn-warning admin-only hidden" onclick="showFinanceSection('management')">è²¡å‹™ç®¡ç†</button>
                            <button class="btn btn-secondary admin-only hidden" onclick="showFinanceSection('reports')">è²¡å‹™å ±è¡¨</button>
                        </div>
                    </div>
                </div>
                
                <!-- æœƒè²»ç¹³äº¤ -->
                <div id="memberFeeSection" class="finance-section">
                    <div class="card">
                        <div class="card-header">ç¹³äº¤æœƒè²»</div>
                        <div class="card-body">
                            <div class="alert alert-info mb-20">
                                <strong>ğŸ’¡ æœƒè²»èªªæ˜ï¼š</strong><br>
                                å¹´åº¦æœƒè²»ç‚º NT$ 1,000 å…ƒï¼Œç”¨æ–¼æ”¯æŒå”æœƒé‹ä½œåŠå„é …æ´»å‹•ã€‚
                            </div>
                            
                            <div class="form-group">
                                <label>ç¹³è²»å¹´åº¦ <span style="color: red;">*</span></label>
                                <select id="feeYear">
                                    <option value="">è«‹é¸æ“‡å¹´åº¦</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>ç¹³è²»é‡‘é¡ <span style="color: red;">*</span></label>
                                <input type="number" id="feeAmount" value="1000" min="1000" placeholder="1000">
                            </div>
                            
                            <div class="form-group">
                                <label>ç¹³è²»æ–¹å¼ <span style="color: red;">*</span></label>
                                <select id="feePaymentMethod">
                                    <option value="éŠ€è¡Œè½‰å¸³">éŠ€è¡Œè½‰å¸³</option>
                                    <option value="ATMè½‰å¸³">ATMè½‰å¸³</option>
                                    <option value="ç¾é‡‘">ç¾é‡‘</option>
                                    <option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>è½‰å¸³å¾Œäº”ç¢¼ <span style="color: red;">*</span></label>
                                <input type="text" id="feeLastFive" maxlength="5" placeholder="è«‹è¼¸å…¥è½‰å¸³å¸³è™Ÿå¾Œäº”ç¢¼">
                                <small style="color: #999;">ç”¨æ–¼æ ¸å°è½‰å¸³è¨˜éŒ„</small>
                            </div>
                            
                            <div class="form-group">
                                <label>å‚™è¨»</label>
                                <textarea id="feeNote" placeholder="å…¶ä»–èªªæ˜ï¼ˆé¸å¡«ï¼‰"></textarea>
                            </div>
                            
                            <div class="alert alert-warning">
                                <strong>âš ï¸ åŒ¯æ¬¾è³‡è¨Šï¼š</strong><br>
                                éŠ€è¡Œï¼šä¸­åœ‹ä¿¡è¨—éŠ€è¡Œ<br>
                                æˆ¶åï¼šå¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ<br>
                                å¸³è™Ÿï¼š1234-5678-9012-3456
                            </div>
                            
                            <button class="btn btn-primary btn-lg" onclick="submitMemberFee()">æäº¤æœƒè²»ç”³è«‹</button>
                        </div>
                    </div>
                </div>
                
                <!-- ææ¬¾ -->
                <div id="donationSection" class="finance-section hidden">
                    <div class="card">
                        <div class="card-header">æ„›å¿ƒææ¬¾</div>
                        <div class="card-body">
                            <div class="alert alert-success mb-20">
                                <strong>â¤ï¸ æ„Ÿè¬æ‚¨çš„æ„›å¿ƒï¼š</strong><br>
                                æ‚¨çš„ææ¬¾å°‡ç”¨æ–¼å”æœƒé‹ä½œã€ç—…å‹æœå‹™åŠç›¸é—œå…¬ç›Šæ´»å‹•ã€‚
                            </div>
                            
                            <div class="form-group">
                                <label>ææ¬¾äººå§“å <span style="color: red;">*</span></label>
                                <input type="text" id="donorName" placeholder="è«‹è¼¸å…¥ææ¬¾äººå§“å">
                            </div>
                            
                            <div class="form-group">
                                <label>è¯çµ¡é›»è©±</label>
                                <input type="tel" id="donorPhone" placeholder="è«‹è¼¸å…¥è¯çµ¡é›»è©±">
                            </div>
                            
                            <div class="form-group">
                                <label>ææ¬¾é‡‘é¡ <span style="color: red;">*</span></label>
                                <input type="number" id="donationAmount" min="100" placeholder="è«‹è¼¸å…¥ææ¬¾é‡‘é¡">
                            </div>
                            
                            <div class="form-group">
                                <label>ææ¬¾ç”¨é€”</label>
                                <select id="donationPurpose">
                                    <option value="ä¸€èˆ¬ææ¬¾">ä¸€èˆ¬ææ¬¾</option>
                                    <option value="æ´»å‹•è´ŠåŠ©">æ´»å‹•è´ŠåŠ©</option>
                                    <option value="ç—…å‹è£œåŠ©">ç—…å‹è£œåŠ©</option>
                                    <option value="è¨­å‚™è³¼ç½®">è¨­å‚™è³¼ç½®</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>ç¹³è²»æ–¹å¼ <span style="color: red;">*</span></label>
                                <select id="donationPaymentMethod">
                                    <option value="éŠ€è¡Œè½‰å¸³">éŠ€è¡Œè½‰å¸³</option>
                                    <option value="ATMè½‰å¸³">ATMè½‰å¸³</option>
                                    <option value="ç¾é‡‘">ç¾é‡‘</option>
                                    <option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>è½‰å¸³å¾Œäº”ç¢¼ <span style="color: red;">*</span></label>
                                <input type="text" id="donationLastFive" maxlength="5" placeholder="è«‹è¼¸å…¥è½‰å¸³å¸³è™Ÿå¾Œäº”ç¢¼">
                            </div>
                            
                            <div class="form-group">
                                <label>å‚™è¨»</label>
                                <textarea id="donationNote" placeholder="å…¶ä»–èªªæ˜ï¼ˆé¸å¡«ï¼‰"></textarea>
                            </div>
                            
                            <div class="alert alert-warning">
                                <strong>âš ï¸ åŒ¯æ¬¾è³‡è¨Šï¼š</strong><br>
                                éŠ€è¡Œï¼šä¸­åœ‹ä¿¡è¨—éŠ€è¡Œ<br>
                                æˆ¶åï¼šå¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ<br>
                                å¸³è™Ÿï¼š1234-5678-9012-3456
                            </div>
                            
                            <button class="btn btn-success btn-lg" onclick="submitDonation()">æäº¤ææ¬¾ç”³è«‹</button>
                        </div>
                    </div>
                </div>
                
                <!-- ç¹³è²»è¨˜éŒ„ -->
                <div id="historySection" class="finance-section hidden">
                    <div class="card">
                        <div class="card-header">ç¹³è²»è¨˜éŒ„</div>
                        <div class="card-body">
                            <h3>æœƒè²»è¨˜éŒ„</h3>
                            <div id="feeHistoryList">
                                <div class="loading">è¼‰å…¥ä¸­...</div>
                            </div>
                            
                            <h3 class="mt-30">ææ¬¾è¨˜éŒ„</h3>
                            <div id="donationHistoryList">
                                <div class="loading">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è²¡å‹™ç®¡ç†ï¼ˆç®¡ç†å“¡ï¼‰ -->
                <div id="managementSection" class="finance-section hidden admin-only">
                    <div class="card">
                        <div class="card-header">è²¡å‹™ç®¡ç†</div>
                        <div class="card-body">
                            <div class="flex flex-wrap gap-10 mb-20">
                                <button class="btn btn-primary" onclick="loadPendingFees()">å¾…ç¢ºèªæœƒè²»</button>
                                <button class="btn btn-success" onclick="loadPendingDonations()">å¾…ç¢ºèªææ¬¾</button>
                                <button class="btn btn-info" onclick="loadAllFees()">å…¨éƒ¨æœƒè²»</button>
                                <button class="btn btn-warning" onclick="loadAllDonations()">å…¨éƒ¨ææ¬¾</button>
                            </div>
                            
                            <div id="financeManagementList">
                                <div class="loading">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è²¡å‹™å ±è¡¨ï¼ˆç®¡ç†å“¡ï¼‰ -->
                <div id="reportsSection" class="finance-section hidden admin-only">
                    <div class="card">
                        <div class="card-header">è²¡å‹™å ±è¡¨</div>
                        <div class="card-body">
                            <div class="form-row mb-20">
                                <div class="form-group">
                                    <label>é–‹å§‹æ—¥æœŸ</label>
                                    <input type="date" id="reportStartDate">
                                </div>
                                <div class="form-group">
                                    <label>çµæŸæ—¥æœŸ</label>
                                    <input type="date" id="reportEndDate">
                                </div>
                                <div class="form-group">
                                    <label>å ±è¡¨é¡å‹</label>
                                    <select id="reportType">
                                        <option value="summary">è²¡å‹™ç¸½è¦½</option>
                                        <option value="incomeExpense">æ”¶æ”¯å ±è¡¨</option>
                                        <option value="cashFlow">ç¾é‡‘æµé‡</option>
                                        <option value="balanceSheet">è³‡ç”¢è² å‚µè¡¨</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex gap-10 mb-20">
                                <button class="btn btn-primary" onclick="generateFinancialReport()">ç”¢ç”Ÿå ±è¡¨</button>
                                <button class="btn btn-success" onclick="exportFinancialReport()">åŒ¯å‡º CSV</button>
                            </div>
                            
                            <div id="financialReportDisplay">
                                <div class="alert alert-info">è«‹é¸æ“‡æ—¥æœŸç¯„åœå’Œå ±è¡¨é¡å‹ï¼Œç„¶å¾Œé»æ“Šã€Œç”¢ç”Ÿå ±è¡¨ã€</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

<!-- ç®¡ç†å“¡å¾Œå° -->
            <div id="adminTab" class="tab-content admin-only">
                <h2 class="mb-20">ç®¡ç†å“¡å¾Œå°</h2>
                
                <!-- ç³»çµ±çµ±è¨ˆ -->
                <div class="card mb-20">
                    <div class="card-header">ç³»çµ±çµ±è¨ˆ</div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="adminStatMembers">0</div>
                                <div class="stat-label">ç¸½æœƒå“¡æ•¸</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="adminStatActivities">0</div>
                                <div class="stat-label">ç¸½æ´»å‹•æ•¸</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="adminStatPosts">0</div>
                                <div class="stat-label">è«–å£‡è²¼æ–‡</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="adminStatIncome">0</div>
                                <div class="stat-label">æœ¬å¹´æ”¶å…¥</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç®¡ç†åŠŸèƒ½ -->
                <div class="card mb-20">
                    <div class="card-header">ç®¡ç†åŠŸèƒ½</div>
                    <div class="card-body">
                        <div class="flex flex-wrap gap-10">
                            <button class="btn btn-primary" onclick="showAdminSection('members')">æœƒå“¡ç®¡ç†</button>
                            <button class="btn btn-success" onclick="showAdminSection('activities')">æ´»å‹•ç®¡ç†</button>
                            <button class="btn btn-info" onclick="showAdminSection('forum')">è«–å£‡ç®¡ç†</button>
                            <button class="btn btn-warning" onclick="showAdminSection('resources')">è³‡æºç®¡ç†</button>
                            <button class="btn btn-danger" onclick="showAdminSection('finance')">è²¡å‹™å¯©æ ¸</button>
                            <button class="btn btn-secondary" onclick="showAdminSection('logs')">ç³»çµ±æ—¥èªŒ</button>
                            <button class="btn btn-dark" onclick="showAdminSection('system')">ç³»çµ±ç¶­è­·</button>
                        </div>
                    </div>
                </div>
                
                <!-- æœƒå“¡ç®¡ç† -->
                <div id="adminMembersSection" class="admin-section">
                    <div class="card">
                        <div class="card-header">æœƒå“¡ç®¡ç†</div>
                        <div class="card-body">
                            <div class="flex gap-10 mb-20">
                                <input type="text" id="memberSearchInput" placeholder="æœå°‹æœƒå“¡..." 
                                       style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <button class="btn btn-primary" onclick="searchMembers()">ğŸ” æœå°‹</button>
                                <button class="btn btn-success" onclick="loadAllMembers()">é‡æ–°è¼‰å…¥</button>
                            </div>
                            
                            <div id="adminMembersList">
                                <div class="loading">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ´»å‹•ç®¡ç† -->
                <div id="adminActivitiesSection" class="admin-section hidden">
                    <div class="card">
                        <div class="card-header">æ´»å‹•ç®¡ç†</div>
                        <div class="card-body">
                            <button class="btn btn-primary mb-20" onclick="showCreateActivityModal()">â• å»ºç«‹æ–°æ´»å‹•</button>
                            
                            <div id="adminActivitiesList">
                                <div class="loading">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è«–å£‡ç®¡ç† -->
                <div id="adminForumSection" class="admin-section hidden">
                    <div class="card">
                        <div class="card-header">è«–å£‡ç®¡ç†</div>
                        <div class="card-body">
                            <div class="flex gap-10 mb-20">
                                <button class="btn btn-primary" onclick="loadAllForumPosts()">å…¨éƒ¨è²¼æ–‡</button>
                                <button class="btn btn-warning" onclick="loadReportedPosts()">æª¢èˆ‰è²¼æ–‡</button>
                            </div>
                            
                            <div id="adminForumList">
                                <div class="loading">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è³‡æºç®¡ç† -->
                <div id="adminResourcesSection" class="admin-section hidden">
                    <div class="card">
                        <div class="card-header">è³‡æºç®¡ç†</div>
                        <div class="card-body">
                            <button class="btn btn-primary mb-20" onclick="showCreateResourceModal()">â• æ–°å¢è³‡æº</button>
                            
                            <div id="adminResourcesList">
                                <div class="loading">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è²¡å‹™å¯©æ ¸ -->
                <div id="adminFinanceSection" class="admin-section hidden">
                    <div class="card">
                        <div class="card-header">è²¡å‹™å¯©æ ¸</div>
                        <div class="card-body">
                            <div class="flex gap-10 mb-20">
                                <button class="btn btn-primary" onclick="loadPendingFees()">å¾…å¯©æ ¸æœƒè²»</button>
                                <button class="btn btn-success" onclick="loadPendingDonations()">å¾…å¯©æ ¸ææ¬¾</button>
                            </div>
                            
                            <div id="adminFinanceList">
                                <div class="loading">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç³»çµ±æ—¥èªŒ -->
                <div id="adminLogsSection" class="admin-section hidden">
                    <div class="card">
                        <div class="card-header">ç³»çµ±æ—¥èªŒ</div>
                        <div class="card-body">
                            <div class="form-row mb-20">
                                <div class="form-group">
                                    <label>ç¯©é¸å¸³è™Ÿ</label>
                                    <input type="text" id="logFilterAccount" placeholder="è¼¸å…¥æœƒå“¡å¸³è™Ÿ">
                                </div>
                                <div class="form-group">
                                    <label>ç¯©é¸å‹•ä½œ</label>
                                    <input type="text" id="logFilterAction" placeholder="è¼¸å…¥å‹•ä½œé¡å‹">
                                </div>
                                <div class="form-group">
                                    <label>é¡¯ç¤ºç­†æ•¸</label>
                                    <input type="number" id="logLimit" value="100" min="10" max="1000">
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" onclick="loadSystemLogs()">è¼‰å…¥æ—¥èªŒ</button>
                            
                            <div id="systemLogsList" class="mt-20">
                                <div class="alert alert-info">è«‹é»æ“Šã€Œè¼‰å…¥æ—¥èªŒã€æŸ¥çœ‹ç³»çµ±æ—¥èªŒ</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç³»çµ±ç¶­è­· -->
                <div id="adminSystemSection" class="admin-section hidden">
                    <div class="card">
                        <div class="card-header">ç³»çµ±ç¶­è­·</div>
                        <div class="card-body">
                            <div class="alert alert-warning mb-20">
                                <strong>âš ï¸ æ³¨æ„ï¼š</strong> ä»¥ä¸‹æ“ä½œå¯èƒ½å½±éŸ¿ç³»çµ±é‹ä½œï¼Œè«‹è¬¹æ…ä½¿ç”¨ã€‚
                            </div>
                            
                            <div class="flex flex-wrap gap-10">
                                <button class="btn btn-primary" onclick="backupDatabase()">ğŸ’¾ å‚™ä»½è³‡æ–™åº«</button>
                                <button class="btn btn-success" onclick="updateActivityStatus()">ğŸ”„ æ›´æ–°æ´»å‹•ç‹€æ…‹</button>
                                <button class="btn btn-warning" onclick="cleanOldLogs()">ğŸ§¹ æ¸…ç†èˆŠæ—¥èªŒ</button>
                                <button class="btn btn-info" onclick="exportAllData()">ğŸ“¤ åŒ¯å‡ºå…¨éƒ¨è³‡æ–™</button>
                            </div>
                            
                            <div id="systemMaintenanceResult" class="mt-20"></div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- ==================== å½ˆå‡ºè¦–çª— ==================== -->
    
    <!-- å»ºç«‹æ´»å‹•å½ˆå‡ºè¦–çª— -->
    <div id="createActivityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å»ºç«‹æ–°æ´»å‹•</h3>
                <span class="close" onclick="closeModal('createActivityModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ´»å‹•åç¨± <span style="color: red;">*</span></label>
                    <input type="text" id="activityName" placeholder="è«‹è¼¸å…¥æ´»å‹•åç¨±">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>æ´»å‹•é¡å‹</label>
                        <select id="activityType">
                            <option value="åº§è«‡æœƒ">åº§è«‡æœƒ</option>
                            <option value="å¾©å¥èª²ç¨‹">å¾©å¥èª²ç¨‹</option>
                            <option value="è¡›æ•™è¬›åº§">è¡›æ•™è¬›åº§</option>
                            <option value="è¯èª¼æ´»å‹•">è¯èª¼æ´»å‹•</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ´»å‹•æ—¥æœŸ <span style="color: red;">*</span></label>
                        <input type="date" id="activityDate">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>æ´»å‹•æ™‚é–“</label>
                        <input type="text" id="activityTime" placeholder="ä¾‹ï¼š14:00-16:00">
                    </div>
                    <div class="form-group">
                        <label>åé¡ <span style="color: red;">*</span></label>
                        <input type="number" id="activityCapacity" min="1" placeholder="è«‹è¼¸å…¥åé¡">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>æ´»å‹•åœ°é»</label>
                    <input type="text" id="activityLocation" placeholder="è«‹è¼¸å…¥æ´»å‹•åœ°é»">
                </div>
                
                <div class="form-group">
                    <label>è¬›å¸«</label>
                    <input type="text" id="activityInstructor" placeholder="è«‹è¼¸å…¥è¬›å¸«å§“å">
                </div>
                
                <div class="form-group">
                    <label>æ´»å‹•èªªæ˜</label>
                    <textarea id="activityDescription" placeholder="è«‹è¼¸å…¥æ´»å‹•è©³ç´°èªªæ˜"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createActivityModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createActivity()">å»ºç«‹æ´»å‹•</button>
            </div>
        </div>
    </div>
    
    <!-- æ´»å‹•è©³æƒ…å½ˆå‡ºè¦–çª— -->
    <div id="activityDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="activityDetailTitle">æ´»å‹•è©³æƒ…</h3>
                <span class="close" onclick="closeModal('activityDetailModal')">&times;</span>
            </div>
            <div class="modal-body" id="activityDetailBody">
                <!-- å‹•æ…‹è¼‰å…¥æ´»å‹•è©³æƒ… -->
            </div>
            <div class="modal-footer" id="activityDetailFooter">
                <!-- å‹•æ…‹è¼‰å…¥æŒ‰éˆ• -->
            </div>
        </div>
    </div>
    
    <!-- ç™¼è¡¨è²¼æ–‡å½ˆå‡ºè¦–çª— -->
    <div id="createPostModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç™¼è¡¨è²¼æ–‡</h3>
                <span class="close" onclick="closeModal('createPostModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>åˆ†é¡ <span style="color: red;">*</span></label>
                    <select id="postCategory">
                        <option value="ç–¾ç—…çŸ¥è­˜">ç–¾ç—…çŸ¥è­˜</option>
                        <option value="ç”Ÿæ´»åˆ†äº«">ç”Ÿæ´»åˆ†äº«</option>
                        <option value="æ²»ç™‚ç¶“é©—">æ²»ç™‚ç¶“é©—</option>
                        <option value="å¿ƒæƒ…æŠ’ç™¼">å¿ƒæƒ…æŠ’ç™¼</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>æ¨™é¡Œ <span style="color: red;">*</span></label>
                    <input type="text" id="postTitle" placeholder="è«‹è¼¸å…¥è²¼æ–‡æ¨™é¡Œ" maxlength="100">
                </div>
                
                <div class="form-group">
                    <label>å…§å®¹ <span style="color: red;">*</span></label>
                    <textarea id="postContent" placeholder="è«‹è¼¸å…¥è²¼æ–‡å…§å®¹" rows="8" maxlength="5000"></textarea>
                    <small style="color: #999;">æœ€å¤š 5000 å­—</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createPostModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createPost()">ç™¼è¡¨è²¼æ–‡</button>
            </div>
        </div>
    </div>
    
    <!-- è²¼æ–‡è©³æƒ…å½ˆå‡ºè¦–çª— -->
    <div id="postDetailModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="postDetailTitle">è²¼æ–‡è©³æƒ…</h3>
                <span class="close" onclick="closeModal('postDetailModal')">&times;</span>
            </div>
            <div class="modal-body" id="postDetailBody">
                <!-- å‹•æ…‹è¼‰å…¥è²¼æ–‡è©³æƒ… -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('postDetailModal')">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- æ–°å¢è³‡æºå½ˆå‡ºè¦–çª— -->
    <div id="createResourceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–°å¢è³‡æº</h3>
                <span class="close" onclick="closeModal('createResourceModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>è³‡æºåç¨± <span style="color: red;">*</span></label>
                    <input type="text" id="resourceName" placeholder="è«‹è¼¸å…¥è³‡æºåç¨±">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>è³‡æºé¡å‹ <span style="color: red;">*</span></label>
                        <select id="resourceType">
                            <option value="è¡›æ•™æ–‡ç« ">è¡›æ•™æ–‡ç« </option>
                            <option value="å½±ç‰‡">å½±ç‰‡</option>
                            <option value="æ‰‹å†Š">æ‰‹å†Š</option>
                            <option value="é€£çµ">ç›¸é—œé€£çµ</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>åˆ†é¡</label>
                        <select id="resourceCategory">
                            <option value="ç–¾ç—…çŸ¥è­˜">ç–¾ç—…çŸ¥è­˜</option>
                            <option value="æ²»ç™‚æ–¹å¼">æ²»ç™‚æ–¹å¼</option>
                            <option value="å¾©å¥é‹å‹•">å¾©å¥é‹å‹•</option>
                            <option value="é£²é£Ÿç‡Ÿé¤Š">é£²é£Ÿç‡Ÿé¤Š</option>
                            <option value="å¿ƒç†æ”¯æŒ">å¿ƒç†æ”¯æŒ</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>å…§å®¹æ‘˜è¦</label>
                    <textarea id="resourceSummary" placeholder="è«‹è¼¸å…¥è³‡æºæ‘˜è¦" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label>è©³ç´°å…§å®¹</label>
                    <textarea id="resourceContent" placeholder="è«‹è¼¸å…¥è©³ç´°å…§å®¹" rows="6"></textarea>
                </div>
                
                <div class="form-group">
                    <label>ç›¸é—œé€£çµ</label>
                    <input type="url" id="resourceLink" placeholder="https://...">
                </div>
                
                <div class="form-group">
                    <label>æ’åº</label>
                    <input type="number" id="resourceOrder" value="999" min="1">
                    <small style="color: #999;">æ•¸å­—è¶Šå°è¶Šé å‰</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createResourceModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createResource()">æ–°å¢è³‡æº</button>
            </div>
        </div>
    </div>
    
    <!-- è³‡æºè©³æƒ…å½ˆå‡ºè¦–çª— -->
    <div id="resourceDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="resourceDetailTitle">è³‡æºè©³æƒ…</h3>
                <span class="close" onclick="closeModal('resourceDetailModal')">&times;</span>
            </div>
            <div class="modal-body" id="resourceDetailBody">
                <!-- å‹•æ…‹è¼‰å…¥è³‡æºè©³æƒ… -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('resourceDetailModal')">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- Loading é®ç½© -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div style="margin-top: 20px; color: white; font-size: 16px;">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>
    </div>

<script>
    // ==================== å…¨åŸŸè®Šæ•¸ ====================
    
    // âš ï¸ é‡è¦ï¼šè«‹å°‡æ­¤ URL æ›¿æ›ç‚ºæ‚¨çš„ Google Apps Script Web App URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbzHjS8CEV1v9ZJ_ys-r-yogNTHjIedwAmzLHXTks-rBOepaNABexUzsRA-zj6Y7R6pl/exec';
    
    // ç•¶å‰ç™»å…¥çš„æœƒå“¡è³‡æ–™
    let currentUser = null;
    
    // ==================== åˆå§‹åŒ– ====================
    
    window.onload = function() {
        // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
                showMainContainer();
                loadDashboard();
            } catch (e) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—', e);
                showAuthContainer();
            }
        } else {
            showAuthContainer();
        }
        
        // åˆå§‹åŒ–å¹´åº¦é¸é …
        initializeYearOptions();
    };
    
    // ==================== é¡¯ç¤º/éš±è—å®¹å™¨ ====================
    
    function showAuthContainer() {
        document.getElementById('authContainer').classList.remove('hidden');
        document.getElementById('mainContainer').classList.add('hidden');
    }
    
    function showMainContainer() {
        document.getElementById('authContainer').classList.add('hidden');
        document.getElementById('mainContainer').classList.remove('hidden');
        
        // æ›´æ–°ä½¿ç”¨è€…è³‡è¨Š
        if (currentUser) {
            document.getElementById('userName').textContent = currentUser.name || currentUser.account;
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
            if (currentUser.status === 'ç®¡ç†å“¡') {
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.classList.remove('hidden');
                });
            }
        }
    }
    
    // ==================== ç™»å…¥/è¨»å†Šåˆ‡æ› ====================
    
    function switchAuthTab(tab) {
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const tabs = document.querySelectorAll('.auth-tab');
        
        tabs.forEach(t => t.classList.remove('active'));
        
        if (tab === 'login') {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            tabs[0].classList.add('active');
        } else {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            tabs[1].classList.add('active');
        }
    }
    
    // ==================== ç™»å…¥åŠŸèƒ½ ====================
    
    async function login() {
        const account = document.getElementById('loginAccount').value.trim();
        const password = document.getElementById('loginPassword').value;
        
        if (!account || !password) {
            alert('è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼');
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('loginMember', { account, password });
            
            if (result.success) {
                currentUser = result.member;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                alert('ç™»å…¥æˆåŠŸï¼');
                showMainContainer();
                loadDashboard();
            } else {
                alert('ç™»å…¥å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('ç™»å…¥éŒ¯èª¤', error);
            alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    // ==================== è¨»å†ŠåŠŸèƒ½ ====================
    
    async function register() {
        const name = document.getElementById('regName').value.trim();
        const gender = document.getElementById('regGender').value;
        const birthDate = document.getElementById('regBirthDate').value;
        const phone = document.getElementById('regPhone').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const idNumber = document.getElementById('regIdNumber').value.trim();
        const password = document.getElementById('regPassword').value;
        const passwordConfirm = document.getElementById('regPasswordConfirm').value;
        
        // é©—è­‰å¿…å¡«æ¬„ä½
        if (!name || !phone || !password) {
            alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
            return;
        }
        
        // é©—è­‰å¯†ç¢¼
        if (password.length < 6) {
            alert('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ');
            return;
        }
        
        if (password !== passwordConfirm) {
            alert('å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´');
            return;
        }
        
        // é©—è­‰æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼
        if (!/^[0-9]{10,15}$/.test(phone.replace(/[\\s-]/g, ''))) {
            alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ‰‹æ©Ÿè™Ÿç¢¼');
            return;
        }
        
        showLoading();
        
        try {
            const memberData = {
                account: phone,
                name,
                gender,
                birthDate,
                phone,
                email,
                idNumber,
                password
            };
            
            const result = await callAPI('registerMember', { memberData });
            
            if (result.success) {
                alert('è¨»å†ŠæˆåŠŸï¼è«‹ä½¿ç”¨æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼ç™»å…¥ã€‚');
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('regName').value = '';
                document.getElementById('regGender').value = '';
                document.getElementById('regBirthDate').value = '';
                document.getElementById('regPhone').value = '';
                document.getElementById('regEmail').value = '';
                document.getElementById('regIdNumber').value = '';
                document.getElementById('regPassword').value = '';
                document.getElementById('regPasswordConfirm').value = '';
                
                // åˆ‡æ›åˆ°ç™»å…¥é é¢
                switchAuthTab('login');
                
                // è‡ªå‹•å¡«å…¥å¸³è™Ÿ
                document.getElementById('loginAccount').value = phone;
            } else {
                alert('è¨»å†Šå¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('è¨»å†ŠéŒ¯èª¤', error);
            alert('è¨»å†Šå¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    // ==================== ç™»å‡ºåŠŸèƒ½ ====================
    
    function logout() {
        if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showAuthContainer();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('loginAccount').value = '';
            document.getElementById('loginPassword').value = '';
        }
    }
    
    // ==================== é ç±¤åˆ‡æ› ====================
    
    function switchTab(tabName) {
        // éš±è—æ‰€æœ‰é ç±¤å…§å®¹
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // ç§»é™¤æ‰€æœ‰å°èˆªæŒ‰éˆ•çš„ active ç‹€æ…‹
        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // é¡¯ç¤ºé¸ä¸­çš„é ç±¤
        const targetTab = document.getElementById(tabName + 'Tab');
        if (targetTab) {
            targetTab.classList.add('active');
        }
        
        // è¨­å®šå°æ‡‰æŒ‰éˆ•ç‚º active
        event.target.classList.add('active');
        
        // è¼‰å…¥å°æ‡‰è³‡æ–™
        switch(tabName) {
            case 'dashboard':
                loadDashboard();
                break;
            case 'profile':
                loadProfile();
                break;
            case 'activities':
                loadActivities('all');
                break;
            case 'forum':
                loadForumPosts('all');
                break;
            case 'resources':
                loadResources('all');
                break;
            case 'finance':
                showFinanceSection('memberFee');
                break;
            case 'admin':
                loadAdminDashboard();
                break;
        }
    }
    
    // ==================== é¦–é è¼‰å…¥ ====================
    
    async function loadDashboard() {
        try {
            // è¼‰å…¥æˆ‘çš„æ´»å‹•å ±åæ•¸
            const registrations = await callAPI('getMemberRegistrations', { 
                account: currentUser.account 
            });
            if (registrations.success) {
                document.getElementById('statActivities').textContent = 
                    registrations.registrations.filter(r => r.registrationStatus === 'å·²å ±å').length;
            }
            
            // è¼‰å…¥æˆ‘çš„è«–å£‡è²¼æ–‡æ•¸
            const posts = await callAPI('getMemberForumPosts', { 
                account: currentUser.account 
            });
            if (posts.success) {
                document.getElementById('statPosts').textContent = posts.posts.length;
            }
            
            // è¼‰å…¥å·²ç¹³æœƒè²»å¹´åº¦æ•¸
            const payments = await callAPI('getMemberPaymentHistory', { 
                account: currentUser.account 
            });
            if (payments.success) {
                document.getElementById('statFees').textContent = 
                    payments.fees.filter(f => f.status === 'å·²ç¢ºèª').length;
            }
        } catch (error) {
            console.error('è¼‰å…¥é¦–é è³‡æ–™å¤±æ•—', error);
        }
    }
    
    // ==================== å€‹äººè³‡æ–™è¼‰å…¥èˆ‡æ›´æ–° ====================
    
    async function loadProfile() {
        showLoading();
        
        try {
            const result = await callAPI('getMemberInfo', { 
                account: currentUser.account 
            });
            
            if (result.success) {
                const member = result.member;
                
                // å¡«å…¥åŸºæœ¬è³‡æ–™
                document.getElementById('profileName').value = member.name || '';
                document.getElementById('profileGender').value = member.gender || '';
                document.getElementById('profileBirthDate').value = member.birthDate || '';
                document.getElementById('profilePhone').value = member.phone || '';
                document.getElementById('profileEmail').value = member.email || '';
                document.getElementById('profileAddress').value = member.address || '';
                document.getElementById('profileEmergencyContact').value = member.emergencyContact || '';
                document.getElementById('profileEmergencyPhone').value = member.emergencyPhone || '';
                
                // å¡«å…¥é†«ç™‚è³‡è¨Š
                document.getElementById('profileDiagnosisDate').value = member.diagnosisDate || '';
                document.getElementById('profileDoctor').value = member.doctor || '';
                document.getElementById('profileMedication').value = member.medication || '';
            } else {
                alert('è¼‰å…¥å€‹äººè³‡æ–™å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥å€‹äººè³‡æ–™éŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function updateProfile() {
        const updateData = {
            name: document.getElementById('profileName').value.trim(),
            gender: document.getElementById('profileGender').value,
            birthDate: document.getElementById('profileBirthDate').value,
            phone: document.getElementById('profilePhone').value.trim(),
            email: document.getElementById('profileEmail').value.trim(),
            address: document.getElementById('profileAddress').value.trim(),
            emergencyContact: document.getElementById('profileEmergencyContact').value.trim(),
            emergencyPhone: document.getElementById('profileEmergencyPhone').value.trim(),
            diagnosisDate: document.getElementById('profileDiagnosisDate').value,
            doctor: document.getElementById('profileDoctor').value.trim(),
            medication: document.getElementById('profileMedication').value.trim()
        };
        
        showLoading();
        
        try {
            const result = await callAPI('updateMemberInfo', { 
                account: currentUser.account,
                updateData 
            });
            
            if (result.success) {
                alert('å€‹äººè³‡æ–™æ›´æ–°æˆåŠŸï¼');
                
                // æ›´æ–° currentUser
                if (updateData.name) {
                    currentUser.name = updateData.name;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('userName').textContent = currentUser.name;
                }
            } else {
                alert('æ›´æ–°å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('æ›´æ–°å€‹äººè³‡æ–™éŒ¯èª¤', error);
            alert('æ›´æ–°å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    // ==================== è®Šæ›´å¯†ç¢¼ ====================
    
    async function changePassword() {
        const oldPassword = document.getElementById('oldPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const newPasswordConfirm = document.getElementById('newPasswordConfirm').value;
        
        if (!oldPassword || !newPassword || !newPasswordConfirm) {
            alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
            return;
        }
        
        if (newPassword.length < 6) {
            alert('æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ');
            return;
        }
        
        if (newPassword !== newPasswordConfirm) {
            alert('å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ä¸€è‡´');
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('changePassword', { 
                account: currentUser.account,
                oldPassword,
                newPassword
            });
            
            if (result.success) {
                alert('å¯†ç¢¼è®Šæ›´æˆåŠŸï¼');
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('oldPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('newPasswordConfirm').value = '';
            } else {
                alert('è®Šæ›´å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('è®Šæ›´å¯†ç¢¼éŒ¯èª¤', error);
            alert('è®Šæ›´å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }

// ==================== æ´»å‹•ç®¡ç†åŠŸèƒ½ ====================
    
    async function loadActivities(filter = 'all') {
        showLoading();
        
        try {
            const result = await callAPI('getAllActivities');
            
            if (result.success) {
                const activities = result.activities;
                const container = document.getElementById('activitiesList');
                
                if (activities.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç›®å‰æ²’æœ‰æ´»å‹•</p>';
                    return;
                }
                
                // ç¯©é¸æ´»å‹•
                let filteredActivities = activities;
                if (filter === 'open') {
                    filteredActivities = activities.filter(a => a.status === 'é–‹æ”¾å ±å');
                } else if (filter === 'closed') {
                    filteredActivities = activities.filter(a => a.status === 'å·²çµæŸ');
                }
                
                // é¡¯ç¤ºæ´»å‹•åˆ—è¡¨
                container.innerHTML = filteredActivities.map(activity => `
                    <div class="card mb-20">
                        <div class="card-header flex justify-between align-center">
                            <div>
                                <span class="badge ${activity.status === 'é–‹æ”¾å ±å' ? 'badge-success' : 'badge-secondary'}">
                                    ${activity.status}
                                </span>
                                <strong style="margin-left: 10px;">${activity.name}</strong>
                            </div>
                            <span style="color: #999; font-size: 14px;">${activity.type}</span>
                        </div>
                        <div class="card-body">
                            <div class="flex flex-wrap gap-20 mb-15">
                                <div>
                                    <strong>ğŸ“… æ—¥æœŸï¼š</strong>${activity.date}
                                </div>
                                <div>
                                    <strong>ğŸ• æ™‚é–“ï¼š</strong>${activity.time || 'æœªè¨­å®š'}
                                </div>
                                <div>
                                    <strong>ğŸ“ åœ°é»ï¼š</strong>${activity.location || 'æœªè¨­å®š'}
                                </div>
                            </div>
                            
                            <div class="flex flex-wrap gap-20 mb-15">
                                <div>
                                    <strong>ğŸ‘¨â€ğŸ« è¬›å¸«ï¼š</strong>${activity.instructor || 'æœªè¨­å®š'}
                                </div>
                                <div>
                                    <strong>ğŸ‘¥ åé¡ï¼š</strong>
                                    <span class="${activity.registered >= activity.capacity ? 'text-danger' : 'text-success'}">
                                        ${activity.registered} / ${activity.capacity}
                                    </span>
                                </div>
                            </div>
                            
                            ${activity.description ? `
                                <div class="mb-15">
                                    <strong>ğŸ“ æ´»å‹•èªªæ˜ï¼š</strong>
                                    <p style="margin-top: 5px; color: #666;">${activity.description}</p>
                                </div>
                            ` : ''}
                            
                            <div class="flex gap-10">
                                ${activity.status === 'é–‹æ”¾å ±å' ? `
                                    <button class="btn btn-primary" onclick="registerForActivity('${activity.activityId}', '${activity.name}')">
                                        å ±ååƒåŠ 
                                    </button>
                                ` : ''}
                                <button class="btn btn-info" onclick="viewActivityDetail('${activity.activityId}')">
                                    æŸ¥çœ‹è©³æƒ…
                                </button>
                                ${currentUser.status === 'ç®¡ç†å“¡' ? `
                                    <button class="btn btn-warning" onclick="editActivity('${activity.activityId}')">
                                        ç·¨è¼¯
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteActivity('${activity.activityId}')">
                                        åˆªé™¤
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                alert('è¼‰å…¥æ´»å‹•å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥æ´»å‹•éŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function loadMyRegistrations() {
        showLoading();
        
        try {
            const result = await callAPI('getMemberRegistrations', { 
                account: currentUser.account 
            });
            
            if (result.success) {
                const registrations = result.registrations;
                const container = document.getElementById('myRegistrationsList');
                
                if (registrations.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æ‚¨é‚„æ²’æœ‰å ±åä»»ä½•æ´»å‹•</p>';
                    return;
                }
                
                container.innerHTML = registrations.map(reg => `
                    <div class="card mb-20">
                        <div class="card-header flex justify-between align-center">
                            <div>
                                <span class="badge ${
                                    reg.registrationStatus === 'å·²å ±å' ? 'badge-success' : 
                                    reg.registrationStatus === 'å·²å–æ¶ˆ' ? 'badge-danger' : 'badge-secondary'
                                }">
                                    ${reg.registrationStatus}
                                </span>
                                <strong style="margin-left: 10px;">${reg.activityName}</strong>
                            </div>
                            <span class="badge ${reg.checkInStatus === 'å·²ç°½åˆ°' ? 'badge-primary' : 'badge-secondary'}">
                                ${reg.checkInStatus}
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="mb-10">
                                <strong>å ±åæ—¥æœŸï¼š</strong>${reg.registrationDate}
                            </div>
                            ${reg.checkInTime ? `
                                <div class="mb-10">
                                    <strong>ç°½åˆ°æ™‚é–“ï¼š</strong>${reg.checkInTime}
                                </div>
                            ` : ''}
                            ${reg.note ? `
                                <div class="mb-10">
                                    <strong>å‚™è¨»ï¼š</strong>${reg.note}
                                </div>
                            ` : ''}
                            
                            <div class="flex gap-10 mt-15">
                                ${reg.registrationStatus === 'å·²å ±å' && reg.checkInStatus === 'æœªç°½åˆ°' ? `
                                    <button class="btn btn-danger" onclick="cancelRegistration('${reg.registrationId}')">
                                        å–æ¶ˆå ±å
                                    </button>
                                ` : ''}
                                <button class="btn btn-info" onclick="viewActivityDetail('${reg.activityId}')">
                                    æŸ¥çœ‹æ´»å‹•
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                alert('è¼‰å…¥å ±åè¨˜éŒ„å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥å ±åè¨˜éŒ„éŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function registerForActivity(activityId, activityName) {
        if (!confirm(`ç¢ºå®šè¦å ±åã€Œ${activityName}ã€å—ï¼Ÿ`)) {
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('registerActivity', { 
                activityId,
                account: currentUser.account,
                memberName: currentUser.name
            });
            
            if (result.success) {
                alert('å ±åæˆåŠŸï¼');
                loadActivities('all');
            } else {
                alert('å ±åå¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('å ±åæ´»å‹•éŒ¯èª¤', error);
            alert('å ±åå¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function cancelRegistration(registrationId) {
        if (!confirm('ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ')) {
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('cancelRegistration', { 
                registrationId,
                account: currentUser.account
            });
            
            if (result.success) {
                alert('å·²å–æ¶ˆå ±å');
                loadMyRegistrations();
            } else {
                alert('å–æ¶ˆå¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('å–æ¶ˆå ±åéŒ¯èª¤', error);
            alert('å–æ¶ˆå¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function viewActivityDetail(activityId) {
        showLoading();
        
        try {
            // å–å¾—æ´»å‹•è©³æƒ…
            const activitiesResult = await callAPI('getAllActivities');
            if (!activitiesResult.success) {
                alert('è¼‰å…¥æ´»å‹•è©³æƒ…å¤±æ•—');
                return;
            }
            
            const activity = activitiesResult.activities.find(a => a.activityId === activityId);
            if (!activity) {
                alert('æ‰¾ä¸åˆ°æ´»å‹•');
                return;
            }
            
            // å–å¾—å ±ååå–®ï¼ˆç®¡ç†å“¡ï¼‰
            let registrationsList = '';
            if (currentUser.status === 'ç®¡ç†å“¡') {
                const regResult = await callAPI('getActivityRegistrations', { activityId });
                if (regResult.success) {
                    registrationsList = `
                        <div class="mt-20">
                            <h4>å ±ååå–® (${regResult.registrations.length} äºº)</h4>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 10px; border: 1px solid #ddd;">å§“å</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">å¸³è™Ÿ</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">å ±åæ—¥æœŸ</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">ç‹€æ…‹</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">ç°½åˆ°</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${regResult.registrations.map(reg => `
                                        <tr>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${reg.memberName}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${reg.account}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${reg.registrationDate}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">
                                                <span class="badge ${reg.registrationStatus === 'å·²å ±å' ? 'badge-success' : 'badge-danger'}">
                                                    ${reg.registrationStatus}
                                                </span>
                                            </td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">
                                                ${reg.checkInStatus === 'å·²ç°½åˆ°' ? 
                                                    `<span class="badge badge-primary">å·²ç°½åˆ°</span>` : 
                                                    `<button class="btn btn-sm btn-primary" onclick="checkInMember('${reg.registrationId}')">ç°½åˆ°</button>`
                                                }
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            }
            
            showModal('æ´»å‹•è©³æƒ…', `
                <div style="line-height: 1.8;">
                    <h3 style="margin-bottom: 20px;">${activity.name}</h3>
                    
                    <div class="mb-10">
                        <strong>æ´»å‹•é¡å‹ï¼š</strong>${activity.type}
                    </div>
                    <div class="mb-10">
                        <strong>æ´»å‹•æ—¥æœŸï¼š</strong>${activity.date}
                    </div>
                    <div class="mb-10">
                        <strong>æ´»å‹•æ™‚é–“ï¼š</strong>${activity.time || 'æœªè¨­å®š'}
                    </div>
                    <div class="mb-10">
                        <strong>æ´»å‹•åœ°é»ï¼š</strong>${activity.location || 'æœªè¨­å®š'}
                    </div>
                    <div class="mb-10">
                        <strong>è¬›å¸«ï¼š</strong>${activity.instructor || 'æœªè¨­å®š'}
                    </div>
                    <div class="mb-10">
                        <strong>åé¡ï¼š</strong>${activity.registered} / ${activity.capacity}
                    </div>
                    <div class="mb-10">
                        <strong>ç‹€æ…‹ï¼š</strong>
                        <span class="badge ${activity.status === 'é–‹æ”¾å ±å' ? 'badge-success' : 'badge-secondary'}">
                            ${activity.status}
                        </span>
                    </div>
                    
                    ${activity.description ? `
                        <div class="mt-20">
                            <strong>æ´»å‹•èªªæ˜ï¼š</strong>
                            <p style="margin-top: 10px; padding: 15px; background: #f9f9f9; border-radius: 8px; white-space: pre-wrap;">
                                ${activity.description}
                            </p>
                        </div>
                    ` : ''}
                    
                    ${registrationsList}
                </div>
            `);
        } catch (error) {
            console.error('æŸ¥çœ‹æ´»å‹•è©³æƒ…éŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function checkInMember(registrationId) {
        if (!confirm('ç¢ºå®šè¦ç‚ºæ­¤æœƒå“¡ç°½åˆ°å—ï¼Ÿ')) {
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('checkInActivity', { 
                registrationId,
                operator: currentUser.account
            });
            
            if (result.success) {
                alert('ç°½åˆ°æˆåŠŸï¼');
                closeModal();
            } else {
                alert('ç°½åˆ°å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('ç°½åˆ°éŒ¯èª¤', error);
            alert('ç°½åˆ°å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    // ç®¡ç†å“¡ï¼šå»ºç«‹æ´»å‹•
    function showCreateActivityModal() {
        showModal('å»ºç«‹æ–°æ´»å‹•', `
            <div class="form-group">
                <label>æ´»å‹•åç¨± <span style="color: red;">*</span></label>
                <input type="text" id="newActivityName" placeholder="è«‹è¼¸å…¥æ´»å‹•åç¨±">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>æ´»å‹•é¡å‹</label>
                    <select id="newActivityType">
                        <option value="åº§è«‡æœƒ">åº§è«‡æœƒ</option>
                        <option value="å¾©å¥èª²ç¨‹">å¾©å¥èª²ç¨‹</option>
                        <option value="è¡›æ•™è¬›åº§">è¡›æ•™è¬›åº§</option>
                        <option value="è¯èª¼æ´»å‹•">è¯èª¼æ´»å‹•</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>æ´»å‹•æ—¥æœŸ <span style="color: red;">*</span></label>
                    <input type="date" id="newActivityDate">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>æ´»å‹•æ™‚é–“</label>
                    <input type="text" id="newActivityTime" placeholder="ä¾‹ï¼š14:00-16:00">
                </div>
                
                <div class="form-group">
                    <label>åé¡ <span style="color: red;">*</span></label>
                    <input type="number" id="newActivityCapacity" placeholder="äººæ•¸" min="1">
                </div>
            </div>
            
            <div class="form-group">
                <label>æ´»å‹•åœ°é»</label>
                <input type="text" id="newActivityLocation" placeholder="è«‹è¼¸å…¥åœ°é»">
            </div>
            
            <div class="form-group">
                <label>è¬›å¸«</label>
                <input type="text" id="newActivityInstructor" placeholder="è¬›å¸«å§“å">
            </div>
            
            <div class="form-group">
                <label>æ´»å‹•èªªæ˜</label>
                <textarea id="newActivityDescription" rows="4" placeholder="è«‹è¼¸å…¥æ´»å‹•èªªæ˜"></textarea>
            </div>
            
            <div class="flex gap-10 mt-20">
                <button class="btn btn-primary" onclick="createActivity()">å»ºç«‹æ´»å‹•</button>
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        `);
    }
    
    async function createActivity() {
        const activityData = {
            name: document.getElementById('newActivityName').value.trim(),
            type: document.getElementById('newActivityType').value,
            date: document.getElementById('newActivityDate').value,
            time: document.getElementById('newActivityTime').value.trim(),
            capacity: parseInt(document.getElementById('newActivityCapacity').value),
            location: document.getElementById('newActivityLocation').value.trim(),
            instructor: document.getElementById('newActivityInstructor').value.trim(),
            description: document.getElementById('newActivityDescription').value.trim()
        };
        
        if (!activityData.name || !activityData.date || !activityData.capacity) {
            alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('createActivity', { 
                activityData,
                creator: currentUser.account
            });
            
            if (result.success) {
                alert('æ´»å‹•å»ºç«‹æˆåŠŸï¼');
                closeModal();
                loadActivities('all');
            } else {
                alert('å»ºç«‹å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('å»ºç«‹æ´»å‹•éŒ¯èª¤', error);
            alert('å»ºç«‹å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }

// ==================== è«–å£‡ç³»çµ±åŠŸèƒ½ ====================
    
    async function loadForumPosts(category = 'all') {
        showLoading();
        
        try {
            const result = await callAPI('getAllForumPosts', { 
                category: category === 'all' ? null : category 
            });
            
            if (result.success) {
                const posts = result.posts;
                const container = document.getElementById('forumPostsList');
                
                if (posts.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç›®å‰æ²’æœ‰è²¼æ–‡</p>';
                    return;
                }
                
                container.innerHTML = posts.map(post => `
                    <div class="card mb-20 ${post.isPinned === 'æ˜¯' ? 'pinned-post' : ''}">
                        <div class="card-header flex justify-between align-center">
                            <div class="flex align-center gap-10">
                                ${post.isPinned === 'æ˜¯' ? '<span class="badge badge-warning">ğŸ“Œ ç½®é ‚</span>' : ''}
                                <span class="badge badge-info">${post.category}</span>
                                <strong>${post.title}</strong>
                            </div>
                            <span style="color: #999; font-size: 14px;">${post.memberName}</span>
                        </div>
                        <div class="card-body">
                            <p style="color: #666; margin-bottom: 15px; white-space: pre-wrap; max-height: 100px; overflow: hidden;">
                                ${post.content.substring(0, 200)}${post.content.length > 200 ? '...' : ''}
                            </p>
                            
                            <div class="flex justify-between align-center">
                                <div class="flex gap-20" style="color: #999; font-size: 14px;">
                                    <span>ğŸ‘ ${post.likes} è®š</span>
                                    <span>ğŸ’¬ ${post.replies} å›è¦†</span>
                                    <span>ğŸ• ${post.publishDate}</span>
                                </div>
                                
                                <div class="flex gap-10">
                                    <button class="btn btn-sm btn-primary" onclick="viewForumPost('${post.postId}')">
                                        æŸ¥çœ‹è©³æƒ…
                                    </button>
                                    ${currentUser.account === post.account || currentUser.status === 'ç®¡ç†å“¡' ? `
                                        <button class="btn btn-sm btn-danger" onclick="deleteForumPost('${post.postId}')">
                                            åˆªé™¤
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                alert('è¼‰å…¥è²¼æ–‡å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥è²¼æ–‡éŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function loadMyPosts() {
        showLoading();
        
        try {
            const result = await callAPI('getMemberForumPosts', { 
                account: currentUser.account 
            });
            
            if (result.success) {
                const posts = result.posts;
                const container = document.getElementById('myPostsList');
                
                if (posts.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æ‚¨é‚„æ²’æœ‰ç™¼è¡¨ä»»ä½•è²¼æ–‡</p>';
                    return;
                }
                
                container.innerHTML = posts.map(post => `
                    <div class="card mb-20">
                        <div class="card-header flex justify-between align-center">
                            <div class="flex align-center gap-10">
                                <span class="badge badge-info">${post.category}</span>
                                <strong>${post.title}</strong>
                            </div>
                            <span style="color: #999; font-size: 14px;">${post.publishDate}</span>
                        </div>
                        <div class="card-body">
                            <p style="color: #666; margin-bottom: 15px; white-space: pre-wrap;">
                                ${post.content}
                            </p>
                            
                            <div class="flex justify-between align-center">
                                <div class="flex gap-20" style="color: #999; font-size: 14px;">
                                    <span>ğŸ‘ ${post.likes} è®š</span>
                                    <span>ğŸ’¬ ${post.replies} å›è¦†</span>
                                </div>
                                
                                <div class="flex gap-10">
                                    <button class="btn btn-sm btn-primary" onclick="viewForumPost('${post.postId}')">
                                        æŸ¥çœ‹
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteForumPost('${post.postId}')">
                                        åˆªé™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                alert('è¼‰å…¥æˆ‘çš„è²¼æ–‡å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥æˆ‘çš„è²¼æ–‡éŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    function showCreatePostModal() {
        showModal('ç™¼è¡¨æ–°è²¼æ–‡', `
            <div class="form-group">
                <label>åˆ†é¡ <span style="color: red;">*</span></label>
                <select id="newPostCategory">
                    <option value="ä¸€èˆ¬è¨è«–">ä¸€èˆ¬è¨è«–</option>
                    <option value="ç—…æƒ…äº¤æµ">ç—…æƒ…äº¤æµ</option>
                    <option value="ç”¨è—¥ç¶“é©—">ç”¨è—¥ç¶“é©—</option>
                    <option value="ç”Ÿæ´»åˆ†äº«">ç”Ÿæ´»åˆ†äº«</option>
                    <option value="å•é¡Œæ±‚åŠ©">å•é¡Œæ±‚åŠ©</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>æ¨™é¡Œ <span style="color: red;">*</span></label>
                <input type="text" id="newPostTitle" placeholder="è«‹è¼¸å…¥æ¨™é¡Œï¼ˆæœ€å¤š100å­—ï¼‰" maxlength="100">
            </div>
            
            <div class="form-group">
                <label>å…§å®¹ <span style="color: red;">*</span></label>
                <textarea id="newPostContent" rows="8" placeholder="è«‹è¼¸å…¥å…§å®¹ï¼ˆæœ€å¤š5000å­—ï¼‰" maxlength="5000"></textarea>
            </div>
            
            <div class="flex gap-10 mt-20">
                <button class="btn btn-primary" onclick="createForumPost()">ç™¼è¡¨è²¼æ–‡</button>
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        `);
    }
    
    async function createForumPost() {
        const postData = {
            category: document.getElementById('newPostCategory').value,
            title: document.getElementById('newPostTitle').value.trim(),
            content: document.getElementById('newPostContent').value.trim()
        };
        
        if (!postData.title || !postData.content) {
            alert('è«‹å¡«å¯«æ¨™é¡Œå’Œå…§å®¹');
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('createForumPost', { 
                postData,
                account: currentUser.account,
                memberName: currentUser.name
            });
            
            if (result.success) {
                alert('è²¼æ–‡ç™¼è¡¨æˆåŠŸï¼');
                closeModal();
                loadForumPosts('all');
            } else {
                alert('ç™¼è¡¨å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('ç™¼è¡¨è²¼æ–‡éŒ¯èª¤', error);
            alert('ç™¼è¡¨å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function viewForumPost(postId) {
        showLoading();
        
        try {
            const result = await callAPI('getForumPostDetail', { postId });
            
            if (result.success) {
                const post = result.post;
                const replies = result.replies;
                
                const repliesHtml = replies.length > 0 ? `
                    <div class="mt-30" style="border-top: 2px solid #eee; padding-top: 20px;">
                        <h4 style="margin-bottom: 20px;">ğŸ’¬ å›è¦† (${replies.length})</h4>
                        ${replies.map(reply => `
                            <div class="card mb-15" style="background: #f9f9f9;">
                                <div class="card-body">
                                    <div class="flex justify-between align-center mb-10">
                                        <strong>${reply.memberName}</strong>
                                        <span style="color: #999; font-size: 14px;">${reply.replyDate}</span>
                                    </div>
                                    <p style="white-space: pre-wrap; color: #666;">${reply.content}</p>
                                    ${currentUser.account === reply.account || currentUser.status === 'ç®¡ç†å“¡' ? `
                                        <button class="btn btn-sm btn-danger mt-10" onclick="deleteForumReply('${reply.replyId}', '${postId}')">
                                            åˆªé™¤å›è¦†
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : '<p style="text-align: center; color: #999; margin-top: 30px; padding: 20px; border-top: 2px solid #eee;">ç›®å‰æ²’æœ‰å›è¦†</p>';
                
                showModal(post.title, `
                    <div style="line-height: 1.8;">
                        <div class="flex justify-between align-center mb-20">
                            <div class="flex align-center gap-10">
                                <span class="badge badge-info">${post.category}</span>
                                ${post.isPinned === 'æ˜¯' ? '<span class="badge badge-warning">ğŸ“Œ ç½®é ‚</span>' : ''}
                            </div>
                            <div style="color: #999; font-size: 14px;">
                                ${post.memberName} â€¢ ${post.publishDate}
                            </div>
                        </div>
                        
                        <div style="padding: 20px; background: #f9f9f9; border-radius: 8px; margin-bottom: 20px;">
                            <p style="white-space: pre-wrap; color: #333;">${post.content}</p>
                        </div>
                        
                        <div class="flex gap-20 mb-20" style="color: #999; font-size: 14px;">
                            <span>ğŸ‘ ${post.likes} è®š</span>
                            <span>ğŸ’¬ ${post.replies} å›è¦†</span>
                        </div>
                        
                        <div class="flex gap-10 mb-20">
                            <button class="btn btn-primary" onclick="likeForumPost('${post.postId}')">
                                ğŸ‘ æŒ‰è®š
                            </button>
                            ${currentUser.account === post.account || currentUser.status === 'ç®¡ç†å“¡' ? `
                                <button class="btn btn-danger" onclick="deleteForumPost('${post.postId}')">
                                    åˆªé™¤è²¼æ–‡
                                </button>
                            ` : ''}
                        </div>
                        
                        <div class="form-group">
                            <label>ç™¼è¡¨å›è¦†</label>
                            <textarea id="replyContent" rows="4" placeholder="è«‹è¼¸å…¥å›è¦†å…§å®¹ï¼ˆæœ€å¤š2000å­—ï¼‰" maxlength="2000"></textarea>
                        </div>
                        <button class="btn btn-success" onclick="replyForumPost('${post.postId}')">
                            é€å‡ºå›è¦†
                        </button>
                        
                        ${repliesHtml}
                    </div>
                `, 'modal-lg');
            } else {
                alert('è¼‰å…¥è²¼æ–‡å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('æŸ¥çœ‹è²¼æ–‡éŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function likeForumPost(postId) {
        showLoading();
        
        try {
            const result = await callAPI('likeForumPost', { 
                postId,
                account: currentUser.account
            });
            
            if (result.success) {
                alert('å·²æŒ‰è®šï¼');
                viewForumPost(postId);
            } else {
                alert('æŒ‰è®šå¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('æŒ‰è®šéŒ¯èª¤', error);
            alert('æŒ‰è®šå¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function replyForumPost(postId) {
        const content = document.getElementById('replyContent').value.trim();
        
        if (!content) {
            alert('è«‹è¼¸å…¥å›è¦†å…§å®¹');
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('replyForumPost', { 
                postId,
                content,
                account: currentUser.account,
                memberName: currentUser.name
            });
            
            if (result.success) {
                alert('å›è¦†æˆåŠŸï¼');
                viewForumPost(postId);
            } else {
                alert('å›è¦†å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('å›è¦†éŒ¯èª¤', error);
            alert('å›è¦†å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function deleteForumPost(postId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡è²¼æ–‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('deleteForumPost', { 
                postId,
                account: currentUser.account,
                isAdmin: currentUser.status === 'ç®¡ç†å“¡'
            });
            
            if (result.success) {
                alert('è²¼æ–‡å·²åˆªé™¤');
                closeModal();
                loadForumPosts('all');
            } else {
                alert('åˆªé™¤å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('åˆªé™¤è²¼æ–‡éŒ¯èª¤', error);
            alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function deleteForumReply(replyId, postId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡å›è¦†å—ï¼Ÿ')) {
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('deleteForumReply', { 
                replyId,
                account: currentUser.account,
                isAdmin: currentUser.status === 'ç®¡ç†å“¡'
            });
            
            if (result.success) {
                alert('å›è¦†å·²åˆªé™¤');
                viewForumPost(postId);
            } else {
                alert('åˆªé™¤å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('åˆªé™¤å›è¦†éŒ¯èª¤', error);
            alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }

// ==================== è³‡æºä¸­å¿ƒåŠŸèƒ½ ====================
    
    async function loadResources(category = 'all') {
        showLoading();
        
        try {
            const result = await callAPI('getAllResources', { 
                category: category === 'all' ? null : category 
            });
            
            if (result.success) {
                const resources = result.resources;
                const container = document.getElementById('resourcesList');
                
                if (resources.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç›®å‰æ²’æœ‰è³‡æº</p>';
                    return;
                }
                
                container.innerHTML = resources.map(resource => `
                    <div class="card mb-20">
                        <div class="card-header flex justify-between align-center">
                            <div class="flex align-center gap-10">
                                <span class="badge badge-info">${resource.category}</span>
                                <strong>${resource.title}</strong>
                            </div>
                            <span style="color: #999; font-size: 14px;">${resource.uploadDate}</span>
                        </div>
                        <div class="card-body">
                            ${resource.description ? `
                                <p style="color: #666; margin-bottom: 15px;">${resource.description}</p>
                            ` : ''}
                            
                            <div class="flex justify-between align-center">
                                <div style="color: #999; font-size: 14px;">
                                    ä¸Šå‚³è€…ï¼š${resource.uploader}
                                </div>
                                
                                <div class="flex gap-10">
                                    ${resource.fileUrl ? `
                                        <a href="${resource.fileUrl}" target="_blank" class="btn btn-sm btn-primary">
                                            ğŸ“¥ ä¸‹è¼‰æª”æ¡ˆ
                                        </a>
                                    ` : ''}
                                    ${resource.linkUrl ? `
                                        <a href="${resource.linkUrl}" target="_blank" class="btn btn-sm btn-info">
                                            ğŸ”— é–‹å•Ÿé€£çµ
                                        </a>
                                    ` : ''}
                                    ${currentUser.status === 'ç®¡ç†å“¡' ? `
                                        <button class="btn btn-sm btn-danger" onclick="deleteResource('${resource.resourceId}')">
                                            åˆªé™¤
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                alert('è¼‰å…¥è³‡æºå¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥è³‡æºéŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    function showUploadResourceModal() {
        showModal('ä¸Šå‚³æ–°è³‡æº', `
            <div class="form-group">
                <label>åˆ†é¡ <span style="color: red;">*</span></label>
                <select id="newResourceCategory">
                    <option value="è¡›æ•™æ–‡ç« ">è¡›æ•™æ–‡ç« </option>
                    <option value="å¾©å¥å½±ç‰‡">å¾©å¥å½±ç‰‡</option>
                    <option value="ç”¨è—¥æŒ‡å—">ç”¨è—¥æŒ‡å—</option>
                    <option value="æ”¿åºœè³‡æº">æ”¿åºœè³‡æº</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>æ¨™é¡Œ <span style="color: red;">*</span></label>
                <input type="text" id="newResourceTitle" placeholder="è«‹è¼¸å…¥æ¨™é¡Œ">
            </div>
            
            <div class="form-group">
                <label>èªªæ˜</label>
                <textarea id="newResourceDescription" rows="4" placeholder="è«‹è¼¸å…¥èªªæ˜"></textarea>
            </div>
            
            <div class="form-group">
                <label>æª”æ¡ˆé€£çµï¼ˆGoogle Drive ç­‰ï¼‰</label>
                <input type="url" id="newResourceFileUrl" placeholder="https://...">
            </div>
            
            <div class="form-group">
                <label>å¤–éƒ¨é€£çµ</label>
                <input type="url" id="newResourceLinkUrl" placeholder="https://...">
            </div>
            
            <div class="flex gap-10 mt-20">
                <button class="btn btn-primary" onclick="uploadResource()">ä¸Šå‚³è³‡æº</button>
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        `);
    }
    
    async function uploadResource() {
        const resourceData = {
            category: document.getElementById('newResourceCategory').value,
            title: document.getElementById('newResourceTitle').value.trim(),
            description: document.getElementById('newResourceDescription').value.trim(),
            fileUrl: document.getElementById('newResourceFileUrl').value.trim(),
            linkUrl: document.getElementById('newResourceLinkUrl').value.trim()
        };
        
        if (!resourceData.title) {
            alert('è«‹å¡«å¯«æ¨™é¡Œ');
            return;
        }
        
        if (!resourceData.fileUrl && !resourceData.linkUrl) {
            alert('è«‹è‡³å°‘æä¾›æª”æ¡ˆé€£çµæˆ–å¤–éƒ¨é€£çµ');
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('uploadResource', { 
                resourceData,
                uploader: currentUser.name
            });
            
            if (result.success) {
                alert('è³‡æºä¸Šå‚³æˆåŠŸï¼');
                closeModal();
                loadResources('all');
            } else {
                alert('ä¸Šå‚³å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('ä¸Šå‚³è³‡æºéŒ¯èª¤', error);
            alert('ä¸Šå‚³å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function deleteResource(resourceId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è³‡æºå—ï¼Ÿ')) {
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('deleteResource', { resourceId });
            
            if (result.success) {
                alert('è³‡æºå·²åˆªé™¤');
                loadResources('all');
            } else {
                alert('åˆªé™¤å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('åˆªé™¤è³‡æºéŒ¯èª¤', error);
            alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    // ==================== è²¡å‹™ç®¡ç†åŠŸèƒ½ ====================
    
    function showFinanceSection(section) {
        document.querySelectorAll('.finance-section').forEach(s => {
            s.classList.add('hidden');
        });
        
        document.getElementById(section + 'Section').classList.remove('hidden');
        
        if (section === 'memberFee') {
            loadMemberFeeHistory();
        } else if (section === 'donation') {
            loadDonationHistory();
        }
    }
    
    async function loadMemberFeeHistory() {
        showLoading();
        
        try {
            const result = await callAPI('getMemberPaymentHistory', { 
                account: currentUser.account 
            });
            
            if (result.success) {
                const fees = result.fees;
                const container = document.getElementById('memberFeeList');
                
                if (fees.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç›®å‰æ²’æœ‰ç¹³è²»è¨˜éŒ„</p>';
                    return;
                }
                
                container.innerHTML = fees.map(fee => `
                    <div class="card mb-15">
                        <div class="card-body">
                            <div class="flex justify-between align-center">
                                <div>
                                    <strong>${fee.year} å¹´åº¦æœƒè²»</strong>
                                    <span class="badge ${
                                        fee.status === 'å·²ç¢ºèª' ? 'badge-success' : 
                                        fee.status === 'å¾…ç¢ºèª' ? 'badge-warning' : 'badge-secondary'
                                    }" style="margin-left: 10px;">
                                        ${fee.status}
                                    </span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 18px; font-weight: bold; color: #667eea;">
                                        NT$ ${fee.amount}
                                    </div>
                                    <div style="color: #999; font-size: 14px; margin-top: 5px;">
                                        ${fee.paymentDate}
                                    </div>
                                </div>
                            </div>
                            
                            ${fee.paymentMethod ? `
                                <div style="margin-top: 10px; color: #666;">
                                    ä»˜æ¬¾æ–¹å¼ï¼š${fee.paymentMethod}
                                </div>
                            ` : ''}
                            
                            ${fee.note ? `
                                <div style="margin-top: 5px; color: #666;">
                                    å‚™è¨»ï¼š${fee.note}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                alert('è¼‰å…¥ç¹³è²»è¨˜éŒ„å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥ç¹³è²»è¨˜éŒ„éŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function submitMemberFee() {
        const year = document.getElementById('feeYear').value;
        const amount = document.getElementById('feeAmount').value;
        const paymentMethod = document.getElementById('feePaymentMethod').value;
        const note = document.getElementById('feeNote').value.trim();
        
        if (!year || !amount || !paymentMethod) {
            alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
            return;
        }
        
        if (amount < 0) {
            alert('é‡‘é¡ä¸èƒ½ç‚ºè² æ•¸');
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('submitMemberFee', { 
                account: currentUser.account,
                memberName: currentUser.name,
                year,
                amount: parseFloat(amount),
                paymentMethod,
                note
            });
            
            if (result.success) {
                alert('æœƒè²»ç¹³äº¤è¨˜éŒ„å·²æäº¤ï¼Œè«‹ç­‰å¾…ç®¡ç†å“¡ç¢ºèª');
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('feeAmount').value = '';
                document.getElementById('feeNote').value = '';
                
                loadMemberFeeHistory();
            } else {
                alert('æäº¤å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('æäº¤æœƒè²»éŒ¯èª¤', error);
            alert('æäº¤å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function loadDonationHistory() {
        showLoading();
        
        try {
            const result = await callAPI('getMemberDonationHistory', { 
                account: currentUser.account 
            });
            
            if (result.success) {
                const donations = result.donations;
                const container = document.getElementById('donationList');
                
                if (donations.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç›®å‰æ²’æœ‰ææ¬¾è¨˜éŒ„</p>';
                    return;
                }
                
                const total = donations
                    .filter(d => d.status === 'å·²ç¢ºèª')
                    .reduce((sum, d) => sum + parseFloat(d.amount), 0);
                
                container.innerHTML = `
                    <div class="card mb-20" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div class="card-body text-center">
                            <div style="font-size: 14px; opacity: 0.9;">ç´¯è¨ˆææ¬¾é‡‘é¡</div>
                            <div style="font-size: 32px; font-weight: bold; margin-top: 10px;">
                                NT$ ${total.toLocaleString()}
                            </div>
                        </div>
                    </div>
                    
                    ${donations.map(donation => `
                        <div class="card mb-15">
                            <div class="card-body">
                                <div class="flex justify-between align-center">
                                    <div>
                                        <strong>${donation.purpose || 'ä¸€èˆ¬ææ¬¾'}</strong>
                                        <span class="badge ${
                                            donation.status === 'å·²ç¢ºèª' ? 'badge-success' : 
                                            donation.status === 'å¾…ç¢ºèª' ? 'badge-warning' : 'badge-secondary'
                                        }" style="margin-left: 10px;">
                                            ${donation.status}
                                        </span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 18px; font-weight: bold; color: #667eea;">
                                            NT$ ${donation.amount}
                                        </div>
                                        <div style="color: #999; font-size: 14px; margin-top: 5px;">
                                            ${donation.donationDate}
                                        </div>
                                    </div>
                                </div>
                                
                                ${donation.paymentMethod ? `
                                    <div style="margin-top: 10px; color: #666;">
                                        ä»˜æ¬¾æ–¹å¼ï¼š${donation.paymentMethod}
                                    </div>
                                ` : ''}
                                
                                ${donation.note ? `
                                    <div style="margin-top: 5px; color: #666;">
                                        å‚™è¨»ï¼š${donation.note}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                `;
            } else {
                alert('è¼‰å…¥ææ¬¾è¨˜éŒ„å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥ææ¬¾è¨˜éŒ„éŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function submitDonation() {
        const amount = document.getElementById('donationAmount').value;
        const purpose = document.getElementById('donationPurpose').value.trim();
        const paymentMethod = document.getElementById('donationPaymentMethod').value;
        const note = document.getElementById('donationNote').value.trim();
        
        if (!amount || !paymentMethod) {
            alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
            return;
        }
        
        if (amount < 0) {
            alert('é‡‘é¡ä¸èƒ½ç‚ºè² æ•¸');
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('submitDonation', { 
                account: currentUser.account,
                memberName: currentUser.name,
                amount: parseFloat(amount),
                purpose,
                paymentMethod,
                note
            });
            
            if (result.success) {
                alert('ææ¬¾è¨˜éŒ„å·²æäº¤ï¼Œæ„Ÿè¬æ‚¨çš„æ”¯æŒï¼');
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('donationAmount').value = '';
                document.getElementById('donationPurpose').value = '';
                document.getElementById('donationNote').value = '';
                
                loadDonationHistory();
            } else {
                alert('æäº¤å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('æäº¤ææ¬¾éŒ¯èª¤', error);
            alert('æäº¤å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    function initializeYearOptions() {
        const currentYear = new Date().getFullYear();
        const select = document.getElementById('feeYear');
        
        if (select) {
            for (let i = 0; i < 5; i++) {
                const year = currentYear + i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + ' å¹´';
                if (i === 0) option.selected = true;
                select.appendChild(option);
            }
        }
    }

// ==================== ç®¡ç†å“¡åŠŸèƒ½ ====================
    
    async function loadAdminDashboard() {
        if (currentUser.status !== 'ç®¡ç†å“¡') {
            alert('æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•ç®¡ç†å¾Œå°');
            return;
        }
        
        showLoading();
        
        try {
            // è¼‰å…¥çµ±è¨ˆè³‡æ–™
            const statsResult = await callAPI('getAdminStats', {});
            
            if (statsResult.success) {
                const stats = statsResult.stats;
                
                document.getElementById('adminStatMembers').textContent = stats.totalMembers || 0;
                document.getElementById('adminStatActivities').textContent = stats.totalActivities || 0;
                document.getElementById('adminStatPosts').textContent = stats.totalPosts || 0;
                document.getElementById('adminStatRevenue').textContent = 
                    'NT$ ' + (stats.totalRevenue || 0).toLocaleString();
            }
        } catch (error) {
            console.error('è¼‰å…¥ç®¡ç†å¾Œå°çµ±è¨ˆéŒ¯èª¤', error);
        } finally {
            hideLoading();
        }
    }
    
    function showAdminSection(section) {
        document.querySelectorAll('.admin-section').forEach(s => {
            s.classList.add('hidden');
        });
        
        document.getElementById('admin' + section.charAt(0).toUpperCase() + section.slice(1) + 'Section').classList.remove('hidden');
        
        switch(section) {
            case 'members':
                loadAdminMembers();
                break;
            case 'activities':
                loadAdminActivities();
                break;
            case 'finance':
                loadAdminFinance();
                break;
            case 'forum':
                loadAdminForum();
                break;
        }
    }
    
    // ==================== ç®¡ç†å“¡ - æœƒå“¡ç®¡ç† ====================
    
    async function loadAdminMembers() {
        showLoading();
        
        try {
            const result = await callAPI('getAllMembers', {});
            
            if (result.success) {
                const members = result.members;
                const container = document.getElementById('adminMembersList');
                
                if (members.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç›®å‰æ²’æœ‰æœƒå“¡</p>';
                    return;
                }
                
                container.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                                <th style="padding: 12px; text-align: left;">å¸³è™Ÿ</th>
                                <th style="padding: 12px; text-align: left;">å§“å</th>
                                <th style="padding: 12px; text-align: left;">æ€§åˆ¥</th>
                                <th style="padding: 12px; text-align: left;">é›»è©±</th>
                                <th style="padding: 12px; text-align: left;">Email</th>
                                <th style="padding: 12px; text-align: center;">ç‹€æ…‹</th>
                                <th style="padding: 12px; text-align: center;">è¨»å†Šæ—¥æœŸ</th>
                                <th style="padding: 12px; text-align: center;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${members.map(member => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px;">${member.account}</td>
                                    <td style="padding: 12px;">${member.name || '-'}</td>
                                    <td style="padding: 12px;">${member.gender || '-'}</td>
                                    <td style="padding: 12px;">${member.phone || '-'}</td>
                                    <td style="padding: 12px;">${member.email || '-'}</td>
                                    <td style="padding: 12px; text-align: center;">
                                        <span class="badge ${
                                            member.status === 'ç®¡ç†å“¡' ? 'badge-danger' : 
                                            member.status === 'æ­£å¼æœƒå“¡' ? 'badge-success' : 'badge-secondary'
                                        }">
                                            ${member.status}
                                        </span>
                                    </td>
                                    <td style="padding: 12px; text-align: center;">${member.joinDate || '-'}</td>
                                    <td style="padding: 12px; text-align: center;">
                                        <button class="btn btn-sm btn-info" onclick="viewMemberDetail('${member.account}')">
                                            æŸ¥çœ‹
                                        </button>
                                        <button class="btn btn-sm btn-warning" onclick="editMemberStatus('${member.account}', '${member.status}')">
                                            ç·¨è¼¯
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                alert('è¼‰å…¥æœƒå“¡åˆ—è¡¨å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥æœƒå“¡åˆ—è¡¨éŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function viewMemberDetail(account) {
        showLoading();
        
        try {
            const result = await callAPI('getMemberInfo', { account });
            
            if (result.success) {
                const member = result.member;
                
                showModal('æœƒå“¡è©³ç´°è³‡æ–™', `
                    <div style="line-height: 2;">
                        <h3 style="margin-bottom: 15px; color: #667eea;">åŸºæœ¬è³‡æ–™</h3>
                        <p><strong>å¸³è™Ÿï¼š</strong>${member.account}</p>
                        <p><strong>å§“åï¼š</strong>${member.name || '-'}</p>
                        <p><strong>æ€§åˆ¥ï¼š</strong>${member.gender || '-'}</p>
                        <p><strong>å‡ºç”Ÿæ—¥æœŸï¼š</strong>${member.birthDate || '-'}</p>
                        <p><strong>é›»è©±ï¼š</strong>${member.phone || '-'}</p>
                        <p><strong>Emailï¼š</strong>${member.email || '-'}</p>
                        <p><strong>åœ°å€ï¼š</strong>${member.address || '-'}</p>
                        <p><strong>èº«åˆ†è­‰å­—è™Ÿï¼š</strong>${member.idNumber || '-'}</p>
                        <p><strong>æœƒå“¡ç‹€æ…‹ï¼š</strong>${member.status}</p>
                        <p><strong>è¨»å†Šæ—¥æœŸï¼š</strong>${member.joinDate || '-'}</p>
                        
                        <h3 style="margin-top: 20px; margin-bottom: 15px; color: #667eea;">ç·Šæ€¥è¯çµ¡äºº</h3>
                        <p><strong>è¯çµ¡äººï¼š</strong>${member.emergencyContact || '-'}</p>
                        <p><strong>è¯çµ¡é›»è©±ï¼š</strong>${member.emergencyPhone || '-'}</p>
                        
                        <h3 style="margin-top: 20px; margin-bottom: 15px; color: #667eea;">é†«ç™‚è³‡è¨Š</h3>
                        <p><strong>è¨ºæ–·æ—¥æœŸï¼š</strong>${member.diagnosisDate || '-'}</p>
                        <p><strong>ä¸»æ²»é†«å¸«ï¼š</strong>${member.doctor || '-'}</p>
                        <p><strong>ç”¨è—¥è¨˜éŒ„ï¼š</strong>${member.medication || '-'}</p>
                    </div>
                    
                    <button class="btn btn-secondary mt-20" onclick="closeModal()">é—œé–‰</button>
                `);
            } else {
                alert('è¼‰å…¥æœƒå“¡è³‡æ–™å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥æœƒå“¡è³‡æ–™éŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    function editMemberStatus(account, currentStatus) {
        showModal('ç·¨è¼¯æœƒå“¡ç‹€æ…‹', `
            <div class="form-group">
                <label>æœƒå“¡å¸³è™Ÿ</label>
                <input type="text" value="${account}" disabled>
            </div>
            
            <div class="form-group">
                <label>æœƒå“¡ç‹€æ…‹</label>
                <select id="editMemberStatusSelect">
                    <option value="æ­£å¼æœƒå“¡" ${currentStatus === 'æ­£å¼æœƒå“¡' ? 'selected' : ''}>æ­£å¼æœƒå“¡</option>
                    <option value="æº–æœƒå“¡" ${currentStatus === 'æº–æœƒå“¡' ? 'selected' : ''}>æº–æœƒå“¡</option>
                    <option value="ç®¡ç†å“¡" ${currentStatus === 'ç®¡ç†å“¡' ? 'selected' : ''}>ç®¡ç†å“¡</option>
                    <option value="åœæ¬Š" ${currentStatus === 'åœæ¬Š' ? 'selected' : ''}>åœæ¬Š</option>
                </select>
            </div>
            
            <div class="flex gap-10 mt-20">
                <button class="btn btn-primary" onclick="updateMemberStatus('${account}')">æ›´æ–°ç‹€æ…‹</button>
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        `);
    }
    
    async function updateMemberStatus(account) {
        const newStatus = document.getElementById('editMemberStatusSelect').value;
        
        showLoading();
        
        try {
            const result = await callAPI('updateMemberStatus', { 
                account,
                status: newStatus
            });
            
            if (result.success) {
                alert('æœƒå“¡ç‹€æ…‹å·²æ›´æ–°');
                closeModal();
                loadAdminMembers();
            } else {
                alert('æ›´æ–°å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('æ›´æ–°æœƒå“¡ç‹€æ…‹éŒ¯èª¤', error);
            alert('æ›´æ–°å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    // ==================== ç®¡ç†å“¡ - æ´»å‹•ç®¡ç† ====================
    
    async function loadAdminActivities() {
        showLoading();
        
        try {
            const result = await callAPI('getAllActivities', {});
            
            if (result.success) {
                const activities = result.activities;
                const container = document.getElementById('adminActivitiesList');
                
                if (activities.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç›®å‰æ²’æœ‰æ´»å‹•</p>';
                    return;
                }
                
                container.innerHTML = activities.map(activity => `
                    <div class="card mb-20">
                        <div class="card-header flex justify-between align-center">
                            <div>
                                <strong>${activity.title}</strong>
                                <span class="badge badge-info ml-10">${activity.category}</span>
                            </div>
                            <span class="badge ${
                                activity.status === 'å ±åä¸­' ? 'badge-success' : 
                                activity.status === 'å·²çµæŸ' ? 'badge-secondary' : 'badge-warning'
                            }">
                                ${activity.status}
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="flex justify-between">
                                <div style="flex: 1;">
                                    <p><strong>æ™‚é–“ï¼š</strong>${activity.activityDate} ${activity.activityTime || ''}</p>
                                    <p><strong>åœ°é»ï¼š</strong>${activity.location}</p>
                                    <p><strong>å ±åäººæ•¸ï¼š</strong>${activity.currentParticipants || 0} / ${activity.maxParticipants}</p>
                                </div>
                                <div class="flex flex-column gap-10">
                                    <button class="btn btn-sm btn-info" onclick="viewActivityRegistrations('${activity.activityId}')">
                                        æŸ¥çœ‹å ±å
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="editActivity('${activity.activityId}')">
                                        ç·¨è¼¯æ´»å‹•
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteActivity('${activity.activityId}')">
                                        åˆªé™¤æ´»å‹•
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                alert('è¼‰å…¥æ´»å‹•åˆ—è¡¨å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥æ´»å‹•åˆ—è¡¨éŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function viewActivityRegistrations(activityId) {
        showLoading();
        
        try {
            const result = await callAPI('getActivityRegistrations', { activityId });
            
            if (result.success) {
                const registrations = result.registrations.filter(r => r.registrationStatus === 'å·²å ±å');
                
                showModal('æ´»å‹•å ±ååå–®', `
                    ${registrations.length === 0 ? 
                        '<p style="text-align: center; color: #999; padding: 40px;">ç›®å‰æ²’æœ‰å ±åè€…</p>' :
                        `<table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                                    <th style="padding: 10px; text-align: left;">å§“å</th>
                                    <th style="padding: 10px; text-align: left;">é›»è©±</th>
                                    <th style="padding: 10px; text-align: center;">å ±åæ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${registrations.map(reg => `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 10px;">${reg.memberName}</td>
                                        <td style="padding: 10px;">${reg.memberAccount}</td>
                                        <td style="padding: 10px; text-align: center;">${reg.registrationDate}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>`
                    }
                    
                    <button class="btn btn-secondary mt-20" onclick="closeModal()">é—œé–‰</button>
                `);
            } else {
                alert('è¼‰å…¥å ±ååå–®å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥å ±ååå–®éŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    // ==================== ç®¡ç†å“¡ - è²¡å‹™ç®¡ç† ====================
    
    async function loadAdminFinance() {
        showLoading();
        
        try {
            // è¼‰å…¥å¾…ç¢ºèªçš„æœƒè²»
            const feesResult = await callAPI('getPendingMemberFees', {});
            
            if (feesResult.success) {
                const fees = feesResult.fees;
                const container = document.getElementById('adminPendingFeesList');
                
                if (fees.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç›®å‰æ²’æœ‰å¾…ç¢ºèªçš„æœƒè²»</p>';
                } else {
                    container.innerHTML = fees.map(fee => `
                        <div class="card mb-15">
                            <div class="card-body">
                                <div class="flex justify-between align-center">
                                    <div>
                                        <strong>${fee.memberName}</strong>
                                        <span style="color: #999; margin-left: 10px;">${fee.year} å¹´åº¦</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 18px; font-weight: bold; color: #667eea;">
                                            NT$ ${fee.amount}
                                        </div>
                                        <div style="color: #999; font-size: 14px; margin-top: 5px;">
                                            ${fee.paymentDate}
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 10px; color: #666;">
                                    ä»˜æ¬¾æ–¹å¼ï¼š${fee.paymentMethod}
                                </div>
                                
                                ${fee.note ? `
                                    <div style="margin-top: 5px; color: #666;">
                                        å‚™è¨»ï¼š${fee.note}
                                    </div>
                                ` : ''}
                                
                                <div class="flex gap-10 mt-15">
                                    <button class="btn btn-sm btn-success" onclick="confirmPayment('memberFee', '${fee.feeId}')">
                                        ç¢ºèªæ”¶æ¬¾
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="rejectPayment('memberFee', '${fee.feeId}')">
                                        æ‹’çµ•
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }
            
            // è¼‰å…¥å¾…ç¢ºèªçš„ææ¬¾
            const donationsResult = await callAPI('getPendingDonations', {});
            
            if (donationsResult.success) {
                const donations = donationsResult.donations;
                const container = document.getElementById('adminPendingDonationsList');
                
                if (donations.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç›®å‰æ²’æœ‰å¾…ç¢ºèªçš„ææ¬¾</p>';
                } else {
                    container.innerHTML = donations.map(donation => `
                        <div class="card mb-15">
                            <div class="card-body">
                                <div class="flex justify-between align-center">
                                    <div>
                                        <strong>${donation.memberName}</strong>
                                        <span style="color: #999; margin-left: 10px;">${donation.purpose || 'ä¸€èˆ¬ææ¬¾'}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 18px; font-weight: bold; color: #667eea;">
                                            NT$ ${donation.amount}
                                        </div>
                                        <div style="color: #999; font-size: 14px; margin-top: 5px;">
                                            ${donation.donationDate}
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 10px; color: #666;">
                                    ä»˜æ¬¾æ–¹å¼ï¼š${donation.paymentMethod}
                                </div>
                                
                                ${donation.note ? `
                                    <div style="margin-top: 5px; color: #666;">
                                        å‚™è¨»ï¼š${donation.note}
                                    </div>
                                ` : ''}
                                
                                <div class="flex gap-10 mt-15">
                                    <button class="btn btn-sm btn-success" onclick="confirmPayment('donation', '${donation.donationId}')">
                                        ç¢ºèªæ”¶æ¬¾
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="rejectPayment('donation', '${donation.donationId}')">
                                        æ‹’çµ•
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }
        } catch (error) {
            console.error('è¼‰å…¥è²¡å‹™ç®¡ç†è³‡æ–™éŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function confirmPayment(type, id) {
        if (!confirm('ç¢ºå®šè¦ç¢ºèªé€™ç­†æ¬¾é …å—ï¼Ÿ')) {
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('confirmPayment', { type, id });
            
            if (result.success) {
                alert('æ¬¾é …å·²ç¢ºèª');
                loadAdminFinance();
            } else {
                alert('ç¢ºèªå¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('ç¢ºèªæ¬¾é …éŒ¯èª¤', error);
            alert('ç¢ºèªå¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function rejectPayment(type, id) {
        if (!confirm('ç¢ºå®šè¦æ‹’çµ•é€™ç­†æ¬¾é …å—ï¼Ÿ')) {
            return;
        }
        
        showLoading();
        
        try {
            const result = await callAPI('rejectPayment', { type, id });
            
            if (result.success) {
                alert('æ¬¾é …å·²æ‹’çµ•');
                loadAdminFinance();
            } else {
                alert('æ‹’çµ•å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('æ‹’çµ•æ¬¾é …éŒ¯èª¤', error);
            alert('æ‹’çµ•å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    // ==================== ç®¡ç†å“¡ - è«–å£‡ç®¡ç† ====================
    
    async function loadAdminForum() {
        showLoading();
        
        try {
            const result = await callAPI('getAllForumPosts', {});
            
            if (result.success) {
                const posts = result.posts;
                const container = document.getElementById('adminForumPostsList');
                
                if (posts.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç›®å‰æ²’æœ‰è«–å£‡è²¼æ–‡</p>';
                    return;
                }
                
                container.innerHTML = posts.map(post => `
                    <div class="card mb-20">
                        <div class="card-header flex justify-between align-center">
                            <div>
                                <span class="badge badge-info">${post.category}</span>
                                <strong style="margin-left: 10px;">${post.title}</strong>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="deleteForumPost('${post.postId}')">
                                åˆªé™¤è²¼æ–‡
                            </button>
                        </div>
                        <div class="card-body">
                            <p style="color: #666; margin-bottom: 15px;">${post.content}</p>
                            
                            <div style="color: #999; font-size: 14px;">
                                ç™¼æ–‡è€…ï¼š${post.authorName} | ç™¼æ–‡æ™‚é–“ï¼š${post.postDate}
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                alert('è¼‰å…¥è«–å£‡è²¼æ–‡å¤±æ•—ï¼š' + result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥è«–å£‡è²¼æ–‡éŒ¯èª¤', error);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }

// ==================== å½ˆå‡ºè¦–çª—åŠŸèƒ½ ====================
    
    function showModal(title, content) {
        const modal = document.getElementById('modal');
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalBody').innerHTML = content;
        modal.classList.add('active');
    }
    
    function closeModal() {
        document.getElementById('modal').classList.remove('active');
    }
    
    // é»æ“ŠèƒŒæ™¯é—œé–‰å½ˆå‡ºè¦–çª—
    document.getElementById('modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    // ==================== Loading åŠŸèƒ½ ====================
    
    function showLoading() {
        document.getElementById('loading').classList.add('active');
    }
    
    function hideLoading() {
        document.getElementById('loading').classList.remove('active');
    }
    
    // ==================== API å‘¼å«å‡½æ•¸ ====================
    
    async function callAPI(action, params = {}) {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: action,
                    ...params
                })
            });
            
            if (!response.ok) {
                throw new Error('ç¶²è·¯è«‹æ±‚å¤±æ•—');
            }
            
            const result = await response.json();
            return result;
        } catch (error) {
            console.error('API å‘¼å«éŒ¯èª¤:', error);
            throw error;
        }
    }
    
    // ==================== æ—¥æœŸæ ¼å¼åŒ–å‡½æ•¸ ====================
    
    function formatDate(date) {
        if (!date) return '';
        
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        
        return `${year}-${month}-${day}`;
    }
    
    function formatDateTime(date) {
        if (!date) return '';
        
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }
    
    // ==================== è¡¨å–®é©—è­‰å‡½æ•¸ ====================
    
    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }
    
    function validatePhone(phone) {
        const re = /^[0-9]{10,15}$/;
        return re.test(phone.replace(/[\s-]/g, ''));
    }
    
    function validateIdNumber(idNumber) {
        // å°ç£èº«åˆ†è­‰å­—è™Ÿé©—è­‰
        const re = /^[A-Z][12]\d{8}$/;
        return re.test(idNumber);
    }
    
    // ==================== æ–‡å­—è™•ç†å‡½æ•¸ ====================
    
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
    
    function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
    
    // ==================== æª”æ¡ˆè™•ç†å‡½æ•¸ ====================
    
    function getFileExtension(filename) {
        return filename.slice((filename.lastIndexOf(".") - 1 >>> 0) + 2);
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    // ==================== éŒ¯èª¤è™•ç† ====================
    
    window.addEventListener('error', function(e) {
        console.error('å…¨åŸŸéŒ¯èª¤:', e.error);
    });
    
    window.addEventListener('unhandledrejection', function(e) {
        console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', e.reason);
    });
    
    // ==================== éµç›¤å¿«æ·éµ ====================
    
    document.addEventListener('keydown', function(e) {
        // ESC éµé—œé–‰å½ˆå‡ºè¦–çª—
        if (e.key === 'Escape') {
            closeModal();
        }
        
        // Enter éµæäº¤ç™»å…¥è¡¨å–®
        if (e.key === 'Enter' && !document.getElementById('authContainer').classList.contains('hidden')) {
            if (!document.getElementById('loginForm').classList.contains('hidden')) {
                login();
            } else if (!document.getElementById('registerForm').classList.contains('hidden')) {
                register();
            }
        }
    });
    
    // ==================== éŸ¿æ‡‰å¼è™•ç† ====================
    
    function checkMobile() {
        return window.innerWidth <= 768;
    }
    
    window.addEventListener('resize', function() {
        if (checkMobile()) {
            // ç§»å‹•è£ç½®ç‰¹æ®Šè™•ç†
            console.log('åˆ‡æ›åˆ°ç§»å‹•è£ç½®æ¨¡å¼');
        } else {
            // æ¡Œé¢è£ç½®ç‰¹æ®Šè™•ç†
            console.log('åˆ‡æ›åˆ°æ¡Œé¢è£ç½®æ¨¡å¼');
        }
    });
    
    // ==================== é›¢ç·šæª¢æ¸¬ ====================
    
    window.addEventListener('online', function() {
        console.log('ç¶²è·¯é€£ç·šå·²æ¢å¾©');
    });
    
    window.addEventListener('offline', function() {
        alert('ç¶²è·¯é€£ç·šå·²ä¸­æ–·ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·š');
    });
    
    // ==================== è‡ªå‹•ç™»å‡ºï¼ˆé–’ç½®åµæ¸¬ï¼‰====================
    
    let idleTimer = null;
    const IDLE_TIMEOUT = 30 * 60 * 1000; // 30 åˆ†é˜
    
    function resetIdleTimer() {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(function() {
            if (currentUser && confirm('æ‚¨å·²é–’ç½®éä¹…ï¼Œæ˜¯å¦è¦ç¹¼çºŒä½¿ç”¨ï¼Ÿ')) {
                resetIdleTimer();
            } else if (currentUser) {
                alert('ç³»çµ±å°‡è‡ªå‹•ç™»å‡º');
                logout();
            }
        }, IDLE_TIMEOUT);
    }
    
    // ç›£è½ä½¿ç”¨è€…æ´»å‹•
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(function(event) {
        document.addEventListener(event, resetIdleTimer, true);
    });
    
    // åˆå§‹åŒ–é–’ç½®è¨ˆæ™‚å™¨
    resetIdleTimer();
    
    // ==================== é é¢å¯è¦‹æ€§è®Šæ›´ ====================
    
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            console.log('é é¢å·²éš±è—');
        } else {
            console.log('é é¢å·²é¡¯ç¤º');
            // é‡æ–°è¼‰å…¥è³‡æ–™
            if (currentUser) {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                    const tabId = activeTab.id.replace('Tab', '');
                    if (tabId === 'dashboard') {
                        loadDashboard();
                    }
                }
            }
        }
    });
    
    // ==================== åˆ—å°åŠŸèƒ½ ====================
    
    function printPage() {
        window.print();
    }
    
    // ==================== åŒ¯å‡ºåŠŸèƒ½ ====================
    
    function exportToCSV(data, filename) {
        const csv = data.map(row => row.join(',')).join('\\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
    
    // ==================== è¤‡è£½åˆ°å‰ªè²¼ç°¿ ====================
    
    function copyToClipboard(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(function() {
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
            }).catch(function(err) {
                console.error('è¤‡è£½å¤±æ•—:', err);
            });
        } else {
            // èˆŠç‰ˆç€è¦½å™¨çš„å‚™ç”¨æ–¹æ¡ˆ
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
            } catch (err) {
                console.error('è¤‡è£½å¤±æ•—:', err);
            }
            
            document.body.removeChild(textArea);
        }
    }
    
    // ==================== åˆ†äº«åŠŸèƒ½ ====================
    
    function shareContent(title, text, url) {
        if (navigator.share) {
            navigator.share({
                title: title,
                text: text,
                url: url
            }).then(function() {
                console.log('åˆ†äº«æˆåŠŸ');
            }).catch(function(err) {
                console.error('åˆ†äº«å¤±æ•—:', err);
            });
        } else {
            // å‚™ç”¨æ–¹æ¡ˆï¼šè¤‡è£½é€£çµ
            copyToClipboard(url);
        }
    }
    
    // ==================== é€šçŸ¥åŠŸèƒ½ ====================
    
    function showNotification(title, message) {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(title, {
                body: message,
                icon: '/favicon.ico'
            });
        } else if ('Notification' in window && Notification.permission !== 'denied') {
            Notification.requestPermission().then(function(permission) {
                if (permission === 'granted') {
                    new Notification(title, {
                        body: message,
                        icon: '/favicon.ico'
                    });
                }
            });
        }
    }
    
    // ==================== åˆå§‹åŒ–å®Œæˆ ====================
    
    console.log('ğŸ‰ å¸•é‡‘æ£®æ°ç—‡ç—…å‹æœƒç®¡ç†ç³»çµ±å·²è¼‰å…¥');
    console.log('ğŸ“Œ è«‹è¨˜å¾—å°‡ API_URL æ›¿æ›ç‚ºæ‚¨çš„ Google Apps Script Web App URL');
    
    </script>
</body>
</html>


            
