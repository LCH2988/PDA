<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœƒå“¡ä¸­å¿ƒ - å¸•é‡‘æ£®å”æœƒ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fa;
      padding-bottom: 70px;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: white;
      color: #667eea;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 600;
    }
    
    .user-details h2 {
      font-size: 18px;
      margin-bottom: 5px;
    }
    
    .user-details p {
      font-size: 13px;
      opacity: 0.9;
    }
    
    .content {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .list-item:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }
    
    .list-item-content {
      flex: 1;
    }
    
    .list-item-title {
      font-size: 16px;
      font-weight: 500;
      color: #333;
      margin-bottom: 5px;
    }
    
    .list-item-subtitle {
      font-size: 13px;
      color: #666;
    }
    
    .btn {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }
    
    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      padding: 5px;
      line-height: 1;
    }
    
    .symptom-levels {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .level-item {
      text-align: center;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .level-item label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 10px;
      color: #555;
    }
    
    .level-slider {
      width: 100%;
      margin-bottom: 10px;
    }
    
    .level-value {
      font-size: 18px;
      font-weight: 600;
      color: #667eea;
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      z-index: 100;
    }
    
    .nav-item {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      transition: all 0.3s;
      color: #999;
    }
    
    .nav-item.active {
      color: #667eea;
    }
    
    .nav-item .icon {
      font-size: 20px;
      margin-bottom: 5px;
      display: block;
    }
    
    .nav-item .label {
      font-size: 12px;
      font-weight: 500;
    }
    
    .chart-container {
      height: 300px;
      margin: 20px 0;
      background: #f8f9fa;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
    }
    
    .alert {
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    
    .alert.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }
    
    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    
    .loading.show {
      display: block;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .medication-reminder {
      background: linear-gradient(135deg, #ff7675 0%, #fd79a8 100%);
      color: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .reminder-info h4 {
      margin-bottom: 5px;
    }
    
    .reminder-info p {
      font-size: 13px;
      opacity: 0.9;
    }
    
    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
    <div class="user-info">
      <div class="user-avatar" id="user-avatar">?</div>
      <div class="user-details">
        <h2 id="user-name">è¼‰å…¥ä¸­...</h2>
        <p id="user-email">è«‹ç¨å€™</p>
      </div>
    </div>
  </div>
  
  <div class="content">
    <div id="alert" class="alert"></div>
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p style="margin-top: 10px; color: #666;">è¼‰å…¥ä¸­...</p>
    </div>
    
    <!-- é¦–é  -->
    <div id="home-section" class="content-section active">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ“Š ä»Šæ—¥å¥åº·ç‹€æ³</h3>
          <button class="btn btn-small" onclick="showSymptomModal()">è¨˜éŒ„ç—‡ç‹€</button>
        </div>
        <div id="today-symptoms">
          <div class="empty-state">
            <div class="icon">ğŸ“</div>
            <p>ä»Šå¤©é‚„æ²’æœ‰è¨˜éŒ„ç—‡ç‹€</p>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ’Š ç”¨è—¥æé†’</h3>
          <button class="btn btn-small" onclick="showPage('medication')">ç®¡ç†ç”¨è—¥</button>
        </div>
        <div id="medication-reminders">
          <div class="empty-state">
            <div class="icon">ğŸ’Š</div>
            <p>æš«ç„¡ç”¨è—¥æé†’</p>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ¯ è¿‘æœŸæ´»å‹•</h3>
          <button class="btn btn-small" onclick="showPage('events')">æŸ¥çœ‹æ›´å¤š</button>
        </div>
        <div id="upcoming-events">
          <div class="empty-state">
            <div class="icon">ğŸ“…</div>
            <p>æš«ç„¡è¿‘æœŸæ´»å‹•</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å¥åº·ç®¡ç† -->
    <div id="health-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ“ˆ ç—‡ç‹€è¶¨å‹¢</h3>
          <button class="btn btn-small" onclick="showSymptomModal()">æ–°å¢è¨˜éŒ„</button>
        </div>
        <div class="chart-container">
          <p>ç—‡ç‹€è¶¨å‹¢åœ–è¡¨ (éœ€è¦åœ–è¡¨åº«æ”¯æ´)</p>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ“‹ æœ€è¿‘è¨˜éŒ„</h3>
        </div>
        <div id="recent-symptoms">
          <div class="loading show">
            <div class="spinner"></div>
            <p>è¼‰å…¥è¨˜éŒ„ä¸­...</p>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸƒâ€â™‚ï¸ é‹å‹•è¨˜éŒ„</h3>
          <button class="btn btn-small" onclick="showExerciseModal()">æ–°å¢é‹å‹•</button>
        </div>
        <div id="exercise-records">
          <div class="empty-state">
            <div class="icon">ğŸƒâ€â™‚ï¸</div>
            <p>é‚„æ²’æœ‰é‹å‹•è¨˜éŒ„</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ç”¨è—¥ç®¡ç† -->
    <div id="medication-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ’Š æˆ‘çš„è—¥ç‰©</h3>
          <button class="btn btn-small" onclick="showMedicationModal()">æ–°å¢è—¥ç‰©</button>
        </div>
        <div id="my-medications">
          <div class="loading show">
            <div class="spinner"></div>
            <p>è¼‰å…¥è—¥ç‰©æ¸…å–®...</p>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ“Š æœè—¥çµ±è¨ˆ</h3>
        </div>
        <div class="chart-container">
          <p>æœè—¥çµ±è¨ˆåœ–è¡¨</p>
        </div>
      </div>
    </div>
    
    <!-- æ´»å‹•ä¸­å¿ƒ -->
    <div id="events-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ¯ å¯å ±åæ´»å‹•</h3>
        </div>
        <div id="available-events">
          <div class="loading show">
            <div class="spinner"></div>
            <p>è¼‰å…¥æ´»å‹•æ¸…å–®...</p>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ“… æˆ‘çš„æ´»å‹•</h3>
        </div>
        <div id="my-events">
          <div class="loading show">
            <div class="spinner"></div>
            <p>è¼‰å…¥æˆ‘çš„æ´»å‹•...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å€‹äººè³‡æ–™ -->
    <div id="profile-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ‘¤ åŸºæœ¬è³‡æ–™</h3>
        </div>
        <div id="member-info">
          <div class="loading show">
            <div class="spinner"></div>
            <p>è¼‰å…¥å€‹äººè³‡æ–™...</p>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ’° ææ¬¾è¨˜éŒ„</h3>
        </div>
        <div id="donation-history">
          <div class="loading show">
            <div class="spinner"></div>
            <p>è¼‰å…¥ææ¬¾è¨˜éŒ„...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ç—‡ç‹€è¨˜éŒ„å½ˆçª— -->
  <div id="symptom-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">è¨˜éŒ„ä»Šæ—¥ç—‡ç‹€</h3>
        <button class="close-btn" onclick="closeModal('symptom-modal')">&times;</button>
      </div>
      <form onsubmit="saveSymptom(event)">
        <div class="form-group">
          <label>è¨˜éŒ„æ—¥æœŸ</label>
          <input type="date" id="symptom-date" required>
        </div>
        
        <div class="symptom-levels">
          <div class="level-item">
            <label>éœ‡é¡«ç¨‹åº¦</label>
            <input type="range" class="level-slider" id="tremor-level" min="0" max="10" value="0" oninput="updateLevelValue('tremor')">
            <div class="level-value" id="tremor-value">0</div>
          </div>
          
          <div class="level-item">
            <label>åƒµç¡¬ç¨‹åº¦</label>
            <input type="range" class="level-slider" id="rigidity-level" min="0" max="10" value="0" oninput="updateLevelValue('rigidity')">
            <div class="level-value" id="rigidity-value">0</div>
          </div>
          
          <div class="level-item">
            <label>å‹•ä½œé²ç·©</label>
            <input type="range" class="level-slider" id="bradykinesia-level" min="0" max="10" value="0" oninput="updateLevelValue('bradykinesia')">
            <div class="level-value" id="bradykinesia-value">0</div>
          </div>
          
          <div class="level-item">
            <label>å¹³è¡¡å•é¡Œ</label>
            <input type="range" class="level-slider" id="balance-level" min="0" max="10" value="0" oninput="updateLevelValue('balance')">
            <div class="level-value" id="balance-value">0</div>
          </div>
        </div>
        
        <div class="form-group">
          <label>å‚™è¨»</label>
          <textarea id="symptom-notes" rows="3" placeholder="æè¿°ä»Šå¤©çš„æ„Ÿå—æˆ–ç‰¹æ®Šç‹€æ³..."></textarea>
        </div>
        
        <button type="submit" class="btn" style="width: 100%;">å„²å­˜è¨˜éŒ„</button>
      </form>
    </div>
  </div>
  
  <!-- ç”¨è—¥å½ˆçª— -->
  <div id="medication-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">æ–°å¢è—¥ç‰©</h3>
        <button class="close-btn" onclick="closeModal('medication-modal')">&times;</button>
      </div>
      <form onsubmit="saveMedication(event)">
        <div class="form-group">
          <label>è—¥ç‰©åç¨± *</label>
          <input type="text" id="medicine-name" required placeholder="ä¾‹ï¼šå·¦å¤šå·´">
        </div>
        
        <div class="form-group">
          <label>åŠ‘é‡</label>
          <input type="text" id="medicine-dosage" placeholder="ä¾‹ï¼š100mg">
        </div>
        
        <div class="form-group">
          <label>æœç”¨é »ç‡</label>
          <select id="medicine-frequency">
            <option value="æ¯æ—¥ä¸€æ¬¡">æ¯æ—¥ä¸€æ¬¡</option>
            <option value="æ¯æ—¥å…©æ¬¡">æ¯æ—¥å…©æ¬¡</option>
            <option value="æ¯æ—¥ä¸‰æ¬¡">æ¯æ—¥ä¸‰æ¬¡</option>
            <option value="æ¯æ—¥å››æ¬¡">æ¯æ—¥å››æ¬¡</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>é–‹å§‹æ—¥æœŸ</label>
          <input type="date" id="medicine-start-date">
        </div>
        
        <div class="form-group">
          <label>å‚™è¨»</label>
          <textarea id="medicine-notes" rows="2" placeholder="æœç”¨æ–¹å¼ã€æ³¨æ„äº‹é …ç­‰..."></textarea>
        </div>
        
        <button type="submit" class="btn" style="width: 100%;">æ–°å¢è—¥ç‰©</button>
      </form>
    </div>
  </div>
  
  <!-- åº•éƒ¨å°èˆª -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="showPage('home')">
      <span class="icon">ğŸ </span>
      <span class="label">é¦–é </span>
    </div>
    <div class="nav-item" onclick="showPage('health')">
      <span class="icon">ğŸ“Š</span>
      <span class="label">å¥åº·</span>
    </div>
    <div class="nav-item" onclick="showPage('medication')">
      <span class="icon">ğŸ’Š</span>
      <span class="label">ç”¨è—¥</span>
    </div>
    <div class="nav-item" onclick="showPage('events')">
      <span class="icon">ğŸ¯</span>
      <span class="label">æ´»å‹•</span>
    </div>
    <div class="nav-item" onclick="showPage('profile')">
      <span class="icon">ğŸ‘¤</span>
      <span class="label">å€‹äºº</span>
    </div>
  </div>
  
  <script>
    let API_URL = localStorage.getItem('API_URL') || '';
    let memberInfo = null;
    
    window.onload = function() {
      loadMemberInfo();
      document.getElementById('symptom-date').valueAsDate = new Date();
      document.getElementById('medicine-start-date').valueAsDate = new Date();
    };
    
    function loadMemberInfo() {
      const stored = localStorage.getItem('memberInfo');
      if (!stored) {
        alert('è«‹å…ˆç™»å…¥');
        window.location.href = 'index.html';
        return;
      }
      
      memberInfo = JSON.parse(stored);
      document.getElementById('user-name').textContent = memberInfo.name;
      document.getElementById('user-email').textContent = memberInfo.email;
      document.getElementById('user-avatar').textContent = memberInfo.name.charAt(0);
      
      loadDashboardData();
    }
    
    async function loadDashboardData() {
      try {
        await Promise.all([
          loadTodaySymptoms(),
          loadMedicationReminders(),
          loadUpcomingEvents()
        ]);
      } catch (error) {
        console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
      }
    }
    
    async function loadTodaySymptoms() {
      const today = new Date().toISOString().split('T')[0];
      try {
        const result = await callAPI({
          action: 'getDailySymptoms',
          memberId: memberInfo.memberId,
          startDate: today,
          endDate: today
        });
        
        const container = document.getElementById('today-symptoms');
        if (result.success && result.data.length > 0) {
          const symptom = result.data[0];
          container.innerHTML = `
            <div class="list-item">
              <div class="list-item-content">
                <div class="list-item-title">ä»Šæ—¥ç—‡ç‹€è¨˜éŒ„</div>
                <div class="list-item-subtitle">
                  éœ‡é¡«:${symptom.tremorLevel} åƒµç¡¬:${symptom.rigidityLevel} 
                  å‹•ä½œ:${symptom.bradykinesiaLevel} å¹³è¡¡:${symptom.balanceLevel}
                </div>
              </div>
              <span class="badge badge-success">å·²è¨˜éŒ„</span>
            </div>
          `;
        }
      } catch (error) {
        console.error('è¼‰å…¥ä»Šæ—¥ç—‡ç‹€å¤±æ•—:', error);
      }
    }
    
    async function loadMedicationReminders() {
      try {
        const result = await callAPI({
          action: 'getMedications',
          memberId: memberInfo.memberId
        });
        
        const container = document.getElementById('medication-reminders');
        if (result.success && result.data.length > 0) {
          container.innerHTML = result.data.map(med => `
            <div class="medication-reminder">
              <div class="reminder-info">
                <h4>${med.medicineName}</h4>
                <p>${med.dosage} - ${med.frequency}</p>
              </div>
              <button class="btn btn-small" onclick="logMedication('${med.medicationId}')">
                å·²æœç”¨
              </button>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('è¼‰å…¥ç”¨è—¥æé†’å¤±æ•—:', error);
      }
    }
    
    async function loadUpcomingEvents() {
      try {
        const result = await callAPI({
          action: 'getEvents',
          status: 'å ±åä¸­'
        });
        
        const container = document.getElementById('upcoming-events');
        if (result.success && result.data.length > 0) {
          const events = result.data.slice(0, 3);
          container.innerHTML = events.map(event => `
            <div class="list-item" onclick="registerEvent('${event.eventId}')">
              <div class="list-item-content">
                <div class="list-item-title">${event.eventName}</div>
                <div class="list-item-subtitle">
                  ${event.eventDate} ${event.startTime} | ${event.location}
                </div>
              </div>
              <span class="badge badge-info">${event.registrationCount}/${event.maxParticipants}</span>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', error);
      }
    }
    
    function showPage(page) {
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      document.getElementById(page + '-section').classList.add('active');
      event.currentTarget.classList.add('active');
      
      switch(page) {
        case 'health':
          loadHealthData();
          break;
        case 'medication':
          loadMedicationData();
          break;
        case 'events':
          loadEventsData();
          break;
        case 'profile':
          loadProfileData();
          break;
      }
    }
    
    async function loadHealthData() {
      const container = document.getElementById('recent-symptoms');
      container.innerHTML = '<div class="loading show"><div class="spinner"></div><p>è¼‰å…¥è¨˜éŒ„ä¸­...</p></div>';
      
      try {
        const result = await callAPI({
          action: 'getDailySymptoms',
          memberId: memberInfo.memberId
        });
        
        if (result.success && result.data.length > 0) {
          container.innerHTML = result.data.slice(0, 10).map(symptom => `
            <div class="list-item">
              <div class="list-item-content">
                <div class="list-item-title">${symptom.recordDate}</div>
                <div class="list-item-subtitle">
                  éœ‡é¡«:${symptom.tremorLevel} åƒµç¡¬:${symptom.rigidityLevel} 
                  å‹•ä½œ:${symptom.bradykinesiaLevel} å¹³è¡¡:${symptom.balanceLevel}
                </div>
              </div>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“</div><p>é‚„æ²’æœ‰ç—‡ç‹€è¨˜éŒ„</p></div>';
        }
      } catch (error) {
        container.innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><p>è¼‰å…¥å¤±æ•—</p></div>';
      }
    }
    
    async function loadMedicationData() {
      const container = document.getElementById('my-medications');
      container.innerHTML = '<div class="loading show"><div class="spinner"></div><p>è¼‰å…¥è—¥ç‰©æ¸…å–®...</p></div>';
      
      try {
        const result = await callAPI({
          action: 'getMedications',
          memberId: memberInfo.memberId
        });
        
        if (result.success && result.data.length > 0) {
          container.innerHTML = result.data.map(med => `
            <div class="list-item">
              <div class="list-item-content">
                <div class="list-item-title">${med.medicineName}</div>
                <div class="list-item-subtitle">${med.dosage} - ${med.frequency}</div>
              </div>
              <button class="btn btn-small" onclick="logMedication('${med.medicationId}')">
                è¨˜éŒ„æœç”¨
              </button>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ’Š</div><p>é‚„æ²’æœ‰æ–°å¢è—¥ç‰©</p></div>';
        }
      } catch (error) {
        container.innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><p>è¼‰å…¥å¤±æ•—</p></div>';
      }
    }
    
    async function loadEventsData() {
      const availableContainer = document.getElementById('available-events');
      const myEventsContainer = document.getElementById('my-events');
      
      try {
        const [eventsResult, myEventsResult] = await Promise.all([
          callAPI({ action: 'getEvents', status: 'å ±åä¸­' }),
          callAPI({ action: 'getMyEvents', memberId: memberInfo.memberId })
        ]);
        
        if (eventsResult.success && eventsResult.data.length > 0) {
          availableContainer.innerHTML = eventsResult.data.map(event => `
            <div class="list-item" onclick="registerEvent('${event.eventId}')">
              <div class="list-item-content">
                <div class="list-item-title">${event.eventName}</div>
                <div class="list-item-subtitle">
                  ${event.eventDate} ${event.startTime}<br>
                  ğŸ“ ${event.location}
                </div>
              </div>
              <div>
                <span class="badge badge-info">${event.registrationCount}/${event.maxParticipants}</span>
              </div>
            </div>
          `).join('');
        } else {
          availableContainer.innerHTML = '<div class="empty-state"><div class="icon">ğŸ¯</div><p>æš«ç„¡å¯å ±åæ´»å‹•</p></div>';
        }
        
        if (myEventsResult.success && myEventsResult.data.length > 0) {
          myEventsContainer.innerHTML = myEventsResult.data.map(event => `
            <div class="list-item">
              <div class="list-item-content">
                <div class="list-item-title">${event.eventName}</div>
                <div class="list-item-subtitle">
                  ${event.eventDate} ${event.startTime}<br>
                  ğŸ“ ${event.location}
                </div>
              </div>
              <span class="badge badge-success">${event.registrationStatus}</span>
            </div>
          `).join('');
        } else {
          myEventsContainer.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“…</div><p>é‚„æ²’æœ‰å ±åæ´»å‹•</p></div>';
        }
      } catch (error) {
        availableContainer.innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><p>è¼‰å…¥å¤±æ•—</p></div>';
        myEventsContainer.innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><p>è¼‰å…¥å¤±æ•—</p></div>';
      }
    }
    
    async function loadProfileData() {
      const infoContainer = document.getElementById('member-info');
      const donationContainer = document.getElementById('donation-history');
      
      try {
        infoContainer.innerHTML = `
          <div style="padding: 20px; background: #f8f9fa; border-radius: 12px;">
            <h4 style="margin-bottom: 15px; color: #333;">åŸºæœ¬è³‡æ–™</h4>
            <p><strong>å§“åï¼š</strong>${memberInfo.name}</p>
            <p><strong>æœƒå“¡ç·¨è™Ÿï¼š</strong>${memberInfo.memberNo}</p>
          <p><strong>Emailï¼š</strong>${memberInfo.email}</p>
          <p><strong>é›»è©±ï¼š</strong>${memberInfo.phone}</p>
          <p><strong>æ€§åˆ¥ï¼š</strong>${memberInfo.gender}</p>
          <p><strong>ç”Ÿæ—¥ï¼š</strong>${memberInfo.birthday}</p>
          <p><strong>è¨»å†Šæ—¥æœŸï¼š</strong>${memberInfo.registerDate}</p>
          <p><strong>æœƒå“¡ç‹€æ…‹ï¼š</strong><span class="badge badge-success">${memberInfo.status}</span></p>
        </div>
      `;
      
      // è¼‰å…¥ææ¬¾è¨˜éŒ„
      const donationResult = await callAPI({
        action: 'getDonationHistory',
        memberId: memberInfo.memberId
      });
      
      if (donationResult.success && donationResult.data.length > 0) {
        donationContainer.innerHTML = donationResult.data.map(donation => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="list-item-title">NT$ ${donation.amount.toLocaleString()}</div>
              <div class="list-item-subtitle">
                ${donation.donationDate} | ${donation.donationType}
              </div>
            </div>
            <span class="badge badge-success">å·²å®Œæˆ</span>
          </div>
        `).join('');
      } else {
        donationContainer.innerHTML = '<div class="empty-state"><div class="icon">ğŸ’°</div><p>é‚„æ²’æœ‰ææ¬¾è¨˜éŒ„</p></div>';
      }
    } catch (error) {
      infoContainer.innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><p>è¼‰å…¥å¤±æ•—</p></div>';
      donationContainer.innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><p>è¼‰å…¥å¤±æ•—</p></div>';
    }
  }
  
  // ========== å·¥å…·å‡½æ•¸ ==========
  
  async function callAPI(data) {
    if (!API_URL) {
      throw new Error('è«‹å…ˆè¨­å®š API ç¶²å€');
    }
    
    try {
      const params = new URLSearchParams();
      for (let key in data) {
        params.append(key, typeof data[key] === 'object' ? JSON.stringify(data[key]) : data[key]);
      }
      
      const response = await fetch(API_URL + '?' + params.toString(), {
        method: 'GET',
        redirect: 'follow',
        mode: 'cors'
      });
      
      if (!response.ok) {
        throw new Error('HTTP ' + response.status);
      }
      
      const text = await response.text();
      return JSON.parse(text);
      
    } catch (error) {
      console.error('API éŒ¯èª¤:', error);
      throw error;
    }
  }
  
  function showAlert(message, type = 'error') {
    const alert = document.getElementById('alert');
    alert.textContent = message;
    alert.className = 'alert ' + type + ' show';
    setTimeout(() => hideAlert(), 5000);
  }
  
  function hideAlert() {
    document.getElementById('alert').classList.remove('show');
  }
  
  function showModal(modalId) {
    document.getElementById(modalId).classList.add('show');
  }
  
  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
  }
  
  function showSymptomModal() {
    showModal('symptom-modal');
  }
  
  function showMedicationModal() {
    showModal('medication-modal');
  }
  
  function showExerciseModal() {
    // æœªå¯¦ä½œï¼Œå¯ä»¥å¾ŒçºŒæ“´å……
    showAlert('é‹å‹•è¨˜éŒ„åŠŸèƒ½é–‹ç™¼ä¸­', 'info');
  }
  
  function updateLevelValue(type) {
    const slider = document.getElementById(type + '-level');
    const valueDisplay = document.getElementById(type + '-value');
    valueDisplay.textContent = slider.value;
    
    // æ ¹æ“šæ•¸å€¼æ”¹è®Šé¡è‰²
    const value = parseInt(slider.value);
    if (value <= 3) {
      valueDisplay.style.color = '#28a745';
    } else if (value <= 6) {
      valueDisplay.style.color = '#ffc107';
    } else {
      valueDisplay.style.color = '#dc3545';
    }
  }
  
  // ========== è¡¨å–®è™•ç† ==========
  
  async function saveSymptom(event) {
    event.preventDefault();
    
    const data = {
      action: 'saveDailySymptom',
      memberId: memberInfo.memberId,
      recordDate: document.getElementById('symptom-date').value,
      tremorLevel: document.getElementById('tremor-level').value,
      rigidityLevel: document.getElementById('rigidity-level').value,
      bradykinesiaLevel: document.getElementById('bradykinesia-level').value,
      balanceLevel: document.getElementById('balance-level').value,
      notes: document.getElementById('symptom-notes').value
    };
    
    try {
      const result = await callAPI(data);
      
      if (result.success) {
        showAlert('ç—‡ç‹€è¨˜éŒ„å·²å„²å­˜', 'success');
        closeModal('symptom-modal');
        
        // é‡æ–°è¼‰å…¥ä»Šæ—¥ç—‡ç‹€
        await loadTodaySymptoms();
        
        // å¦‚æœåœ¨å¥åº·é é¢ï¼Œä¹Ÿé‡æ–°è¼‰å…¥è³‡æ–™
        if (document.getElementById('health-section').classList.contains('active')) {
          await loadHealthData();
        }
        
        // é‡ç½®è¡¨å–®
        document.querySelector('#symptom-modal form').reset();
        document.getElementById('symptom-date').valueAsDate = new Date();
        
        // é‡ç½®æ»‘æ¡¿å€¼
        ['tremor', 'rigidity', 'bradykinesia', 'balance'].forEach(type => {
          document.getElementById(type + '-level').value = 0;
          document.getElementById(type + '-value').textContent = '0';
          document.getElementById(type + '-value').style.color = '#667eea';
        });
        
      } else {
        showAlert(result.message || 'å„²å­˜å¤±æ•—', 'error');
      }
    } catch (error) {
      showAlert('ç³»çµ±éŒ¯èª¤', 'error');
      console.error('å„²å­˜ç—‡ç‹€å¤±æ•—:', error);
    }
  }
  
  async function saveMedication(event) {
    event.preventDefault();
    
    const data = {
      action: 'addMedication',
      memberId: memberInfo.memberId,
      medicineName: document.getElementById('medicine-name').value,
      dosage: document.getElementById('medicine-dosage').value,
      frequency: document.getElementById('medicine-frequency').value,
      startDate: document.getElementById('medicine-start-date').value,
      notes: document.getElementById('medicine-notes').value
    };
    
    try {
      const result = await callAPI(data);
      
      if (result.success) {
        showAlert('è—¥ç‰©å·²æ–°å¢', 'success');
        closeModal('medication-modal');
        
        // é‡æ–°è¼‰å…¥ç”¨è—¥è³‡æ–™
        await loadMedicationReminders();
        
        // å¦‚æœåœ¨ç”¨è—¥é é¢ï¼Œä¹Ÿé‡æ–°è¼‰å…¥è³‡æ–™
        if (document.getElementById('medication-section').classList.contains('active')) {
          await loadMedicationData();
        }
        
        // é‡ç½®è¡¨å–®
        document.querySelector('#medication-modal form').reset();
        document.getElementById('medicine-start-date').valueAsDate = new Date();
        
      } else {
        showAlert(result.message || 'æ–°å¢å¤±æ•—', 'error');
      }
    } catch (error) {
      showAlert('ç³»çµ±éŒ¯èª¤', 'error');
      console.error('æ–°å¢è—¥ç‰©å¤±æ•—:', error);
    }
  }
  
  async function logMedication(medicationId) {
    try {
      const result = await callAPI({
        action: 'logMedicationTaken',
        medicationId: medicationId,
        memberId: memberInfo.memberId,
        takenTime: new Date().toISOString()
      });
      
      if (result.success) {
        showAlert('å·²è¨˜éŒ„æœè—¥', 'success');
        await loadMedicationReminders();
      } else {
        showAlert(result.message || 'è¨˜éŒ„å¤±æ•—', 'error');
      }
    } catch (error) {
      showAlert('è¨˜éŒ„å¤±æ•—', 'error');
      console.error('è¨˜éŒ„æœè—¥å¤±æ•—:', error);
    }
  }
  
  async function registerEvent(eventId) {
    try {
      const result = await callAPI({
        action: 'registerEvent',
        eventId: eventId,
        memberId: memberInfo.memberId
      });
      
      if (result.success) {
        showAlert('å ±åæˆåŠŸï¼', 'success');
        
        // é‡æ–°è¼‰å…¥æ´»å‹•è³‡æ–™
        await loadUpcomingEvents();
        
        // å¦‚æœåœ¨æ´»å‹•é é¢ï¼Œä¹Ÿé‡æ–°è¼‰å…¥è³‡æ–™
        if (document.getElementById('events-section').classList.contains('active')) {
          await loadEventsData();
        }
      } else {
        showAlert(result.message || 'å ±åå¤±æ•—', 'error');
      }
    } catch (error) {
      showAlert('å ±åå¤±æ•—', 'error');
      console.error('æ´»å‹•å ±åå¤±æ•—:', error);
    }
  }
  
  function logout() {
    if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
      localStorage.removeItem('memberInfo');
      localStorage.removeItem('API_URL');
      window.location.href = 'index.html';
    }
  }
  
  // ========== é»æ“Šå¤–éƒ¨é—œé–‰å½ˆçª— ==========
  
  window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
      if (event.target === modal) {
        modal.classList.remove('show');
      }
    });
  };
  
  // ========== åˆå§‹åŒ–æ»‘æ¡¿å€¼é¡¯ç¤º ==========
  
  document.addEventListener('DOMContentLoaded', function() {
    ['tremor', 'rigidity', 'bradykinesia', 'balance'].forEach(type => {
      const slider = document.getElementById(type + '-level');
      const valueDisplay = document.getElementById(type + '-value');
      if (slider && valueDisplay) {
        valueDisplay.textContent = slider.value;
      }
    });
  });
  
  // ========== PWA æ”¯æ´ ==========
  
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/sw.js')
        .then(function(registration) {
          console.log('ServiceWorker è¨»å†ŠæˆåŠŸ');
        })
        .catch(function(error) {
          console.log('ServiceWorker è¨»å†Šå¤±æ•—');
        });
    });
  }
  
  // ========== é›¢ç·šæç¤º ==========
  
  window.addEventListener('online', function() {
    showAlert('ç¶²è·¯é€£ç·šå·²æ¢å¾©', 'success');
  });
  
  window.addEventListener('offline', function() {
    showAlert('ç¶²è·¯é€£ç·šä¸­æ–·ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨', 'warning');
  });
</script>
</body>
</html>
