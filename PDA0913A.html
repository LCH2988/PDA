
<!-- ========================= profile.html ========================= -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>個人資料</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height: 100vh;
      padding: 22px 0;
    }
    .profile-container { max-width:640px; margin:0 auto; }
    .profile-card {
      background:#fff; border-radius:22px; box-shadow:0 15px 35px rgba(0,0,0,.12);
      overflow:hidden; margin-bottom:20px;
    }
    .profile-header {
      background:linear-gradient(135deg,#4a90e2,#2c5aa0);
      color:#fff; padding:30px 25px; text-align:center;
    }
    .profile-avatar {
      width:110px; height:110px; border-radius:50%; border:4px solid #fff;
      margin:0 auto 12px; object-fit:cover;
    }
    .profile-name { font-size:1.55rem;font-weight:700;margin-bottom:4px; }
    .profile-status {
      background:rgba(255,255,255,.25); padding:5px 15px;
      display:inline-block; border-radius:20px;font-size:.85rem;
    }
    .profile-body { padding:26px 22px 30px; }
    .membership-card {
      border-radius:16px; padding:18px; text-align:center;
      background:linear-gradient(135deg,#ffc107,#e0a800); color:#212529; margin-bottom:20px;
    }
    .membership-card.premium {
      background:linear-gradient(135deg,#dc3545,#c82333); color:#fff;
    }
    .stats-row { display:flex; gap:14px; margin-bottom:20px; flex-wrap:wrap; }
    .stats-card {
      flex:1 1 calc(50% - 14px);
      background:linear-gradient(135deg,#28a745,#20c997);
      color:#fff; border-radius:15px; padding:18px; text-align:center;
    }
    .stats-card.alt { background:linear-gradient(135deg,#17a2b8,#138496); }
    .stats-number { font-size:2rem;font-weight:700;margin-bottom:5px; }
    .info-section { margin-bottom:25px; }
    .info-section h6 {
      color:#4a90e2; font-weight:700; margin-bottom:14px;
      border-bottom:2px solid #e9ecef; padding-bottom:6px;
    }
    .info-item {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 4px; border-bottom:1px solid #f1f3f5;
      font-size:.95rem;
    }
    .info-item:last-child { border-bottom:none; }
    .info-label { font-weight:600; color:#65768a; display:flex; align-items:center; }
    .info-label i { width:18px; margin-right:6px; text-align:center; }
    .info-value { color:#364b63; font-weight:500; }
    .edit-form { display:none; }
    .form-floating { margin-bottom:15px; }
    .form-floating .form-control, .form-floating .form-select {
      border-radius:12px; border:2px solid #e9ecef;
    }
    .form-floating .form-control:focus, .form-floating .form-select:focus {
      border-color:#4a90e2; box-shadow:0 0 0 .2rem rgba(74,144,226,.25);
    }
    .btn-primary {
      background:linear-gradient(135deg,#4a90e2,#2c5aa0);
      border:none; border-radius:10px; font-weight:600;
    }
    .btn-primary:hover { box-shadow:0 5px 15px rgba(74,144,226,.4); }
    .btn-outline-primary {
      border:2px solid #4a90e2; color:#4a90e2; border-radius:10px; font-weight:600;
    }
    .btn-outline-primary:hover { background:#4a90e2;color:#fff; }
    .alert { border-radius:10px; }
    .loading-spinner { padding:50px; text-align:center; }
    .fade-in { animation: fade .3s ease; }
    @keyframes fade { from {opacity:0; transform:translateY(6px);} to {opacity:1; transform:translateY(0);} }
    @media (max-width: 600px) {
      .stats-card { flex:1 1 100%; }
      .info-item { flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>
<body>
  <div class="profile-container">
    <div id="loadingScreen" class="profile-card">
      <div class="loading-spinner">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">載入中...</span></div>
      </div>
    </div>

    <div id="errorAlert" class="alert alert-danger d-none">
      <i class="bi bi-exclamation-triangle me-2"></i><span id="errorMessage"></span>
    </div>
    <div id="successAlert" class="alert alert-success d-none">
      <i class="bi bi-check-circle me-2"></i><span id="successMessage"></span>
    </div>

    <div id="profileCard" class="profile-card" style="display:none;">
      <div class="profile-header">
        <img id="userAvatar" class="profile-avatar" src="https://via.placeholder.com/100" alt="avatar">
        <div id="userName" class="profile-name">載入中...</div>
        <div id="userStatus" class="profile-status">一般用戶</div>
      </div>
      <div class="profile-body">

        <div id="membershipStatus" class="membership-card">
          <h6 class="mb-2">會員狀態</h6>
          <div id="membershipInfo">載入中...</div>
        </div>

          <div class="stats-row">
            <div class="stats-card">
              <div id="totalDonations" class="stats-number">0</div>
              <div class="small">累計捐款次數</div>
            </div>
            <div class="stats-card alt">
              <div id="totalAmount" class="stats-number">$0</div>
              <div class="small">累計捐款金額</div>
            </div>
          </div>

          <!-- 檢視模式 -->
          <div id="profileView" class="fade-in">
            <div class="info-section">
              <h6><i class="bi bi-person-circle me-2"></i>基本資料</h6>
              <div class="info-item"><div class="info-label"><i class="bi bi-person"></i>真實姓名</div><div class="info-value" id="displayRealName">未設定</div></div>
              <div class="info-item"><div class="info-label"><i class="bi bi-telephone"></i>聯絡電話</div><div class="info-value" id="displayPhone">未設定</div></div>
              <div class="info-item"><div class="info-label"><i class="bi bi-envelope"></i>Email</div><div class="info-value" id="displayEmail">未設定</div></div>
              <div class="info-item"><div class="info-label"><i class="bi bi-geo-alt"></i>聯絡地址</div><div class="info-value" id="displayAddress">未設定</div></div>
              <div class="info-item"><div class="info-label"><i class="bi bi-calendar"></i>生日</div><div class="info-value" id="displayBirthday">未設定</div></div>
            </div>

            <div class="info-section">
              <h6><i class="bi bi-heart me-2"></i>關懷資訊</h6>
              <div class="info-item"><div class="info-label"><i class="bi bi-person-check"></i>是否為患者</div><div class="info-value" id="displayIsPatient">未設定</div></div>
              <div class="info-item"><div class="info-label"><i class="bi bi-people"></i>與患者關係</div><div class="info-value" id="displayRelationship">未設定</div></div>
              <div class="info-item"><div class="info-label"><i class="bi bi-person-hearts"></i>緊急聯絡人</div><div class="info-value" id="displayEmergencyContact">未設定</div></div>
            </div>

            <div class="d-grid gap-2">
              <button class="btn btn-primary" onclick="showEditForm()"><i class="bi bi-pencil-square me-2"></i>編輯個人資料</button>
            </div>
          </div>

          <!-- 編輯模式 -->
          <div id="editForm" class="edit-form fade-in">
            <form id="profileForm">
              <div class="info-section">
                <h6><i class="bi bi-person-circle me-2"></i>基本資料</h6>
                <div class="form-floating">
                  <input type="text" id="realName" class="form-control" placeholder="真實姓名" required>
                  <label for="realName">真實姓名 *</label>
                </div>
                <div class="form-floating">
                  <input type="tel" id="phone" class="form-control" placeholder="聯絡電話" required>
                  <label for="phone">聯絡電話 *</label>
                </div>
                <div class="form-floating">
                  <input type="email" id="email" class="form-control" placeholder="Email">
                  <label for="email">Email</label>
                </div>
                <div class="form-floating">
                  <textarea id="address" class="form-control" style="height:80px;" placeholder="聯絡地址"></textarea>
                  <label for="address">聯絡地址</label>
                </div>
                <div class="form-floating">
                  <input type="date" id="birthday" class="form-control">
                  <label for="birthday">生日</label>
                </div>
              </div>

              <div class="info-section">
                <h6><i class="bi bi-heart me-2"></i>關懷資訊</h6>
                <div class="form-floating">
                  <select id="isPatient" class="form-select">
                    <option value="">請選擇</option>
                    <option value="是">是</option>
                    <option value="否">否</option>
                  </select>
                  <label for="isPatient">是否為帕金森病患者</label>
                </div>
                <div class="form-floating">
                  <select id="relationship" class="form-select">
                    <option value="">請選擇</option>
                    <option value="患者本人">患者本人</option>
                    <option value="配偶">配偶</option>
                    <option value="子女">子女</option>
                    <option value="父母">父母</option>
                    <option value="兄弟姊妹">兄弟姊妹</option>
                    <option value="朋友">朋友</option>
                    <option value="照護者">照護者</option>
                    <option value="其他">其他</option>
                  </select>
                  <label for="relationship">與患者關係</label>
                </div>
                <div class="form-floating">
                  <input type="text" id="emergencyContact" class="form-control" placeholder="緊急聯絡人">
                  <label for="emergencyContact">緊急聯絡人</label>
                </div>
                <div class="form-floating">
                  <input type="tel" id="emergencyPhone" class="form-control" placeholder="緊急聯絡電話">
        <label for="emergencyPhone">緊急聯絡電話</label>
              </div>
              <div class="form-floating">
                <textarea id="healthNotes" class="form-control" style="height:80px;" placeholder="健康狀況 / 備註"></textarea>
                <label for="healthNotes">健康狀況 / 備註</label>
              </div>
            </div>

            <div class="d-flex gap-2 mt-2">
              <button type="submit" class="btn btn-primary flex-grow-1">
                <i class="bi bi-save me-2"></i>儲存
              </button>
              <button type="button" class="btn btn-outline-primary" onclick="cancelEdit()">
                <i class="bi bi-x-circle me-2"></i>取消
              </button>
            </div>
          </form>
        </div><!-- /#editForm -->

        <div class="mt-4 text-center small text-muted">
          若資料需協助修改，請聯繫管理員。
        </div>
    </div><!-- /.profile-body -->
  </div><!-- /.profile-card -->
</div><!-- /.profile-container -->

<script>
  /**********************************************************
   * 全域設定
   **********************************************************/
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbyeEQZTAD3sfy_rUtFG-IFMONAT1ywy87_5H9LYWUuyhWo-rhAaZrlZ9d79DAqMvKutfg/exec';
  const LIFF_ID = '1656516134-X9oq92g9';

  let userId = null;
  let rawUserData = null;

  /**********************************************************
   * 初始化 LIFF
   **********************************************************/
  initLiffProfile();
  function initLiffProfile(){
    liff.init({ liffId: LIFF_ID })
      .then(()=>{
        if(!liff.isLoggedIn()){ liff.login(); return; }
        return liff.getProfile();
      })
      .then(profile=>{
        if(!profile) return;
        userId = profile.userId;
        document.getElementById('userAvatar').src = profile.pictureUrl || 'https://via.placeholder.com/100';
        document.getElementById('userName').textContent = profile.displayName || '用戶';
        loadUserInfo();
      })
      .catch(err=>{
        showError('LIFF 初始化失敗：' + err.message);
      });
  }

  /**********************************************************
   * GAS 請求
   **********************************************************/
  async function gasGet(paramsObj){
    const qs = new URLSearchParams(paramsObj).toString();
    const res = await fetch(`${GAS_URL}?${qs}`, { method:'GET' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }
  async function gasPost(bodyObj){
    const res = await fetch(GAS_URL, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain' },
      body: JSON.stringify(bodyObj)
    });
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }

  /**********************************************************
   * 載入使用者資料
   * 後端 getUserInfo 預期回傳：
   * {
   *   success:true,
   *   data:{
   *     userInfo:{ 真實姓名, 電話, Email, 地址, 生日, 是否患者, 與患者關係, 緊急聯絡人, 緊急聯絡電話, 健康備註, 是否會員, 用戶角色 ... },
   *     stats:{ donationCount, donationTotal, lastDonationDate, membershipStatus, joinDate }
   *   }
   * }
   **********************************************************/
  async function loadUserInfo(){
    toggleLoading(true);
    try {
      const result = await gasGet({ action:'getUserInfo', userId });
      if(!result.success) throw new Error(result.message || '取得資料失敗');
      rawUserData = result.data;
      fillViewMode(rawUserData);
      toggleLoading(false);
    } catch(e){
      toggleLoading(false);
      showError(e.message);
    }
  }

  /**********************************************************
   * 將資料填入檢視模式
   **********************************************************/
  function fillViewMode(data){
    const info = data.userInfo || {};
    const stats = data.stats || {};

    // 頂部狀態
    document.getElementById('userStatus').textContent = info.是否會員 ? '正式會員' : '一般用戶';

    // 會員卡
    const membershipCard = document.getElementById('membershipStatus');
    if(info.是否會員){
      membershipCard.classList.add('premium');
      document.getElementById('membershipInfo').innerHTML =
        `<div><strong>狀態：</strong>正式會員</div>
         <div><strong>加入日期：</strong>${formatDate(stats.joinDate) || '-'}</div>
         <div><strong>最後捐款：</strong>${stats.lastDonationDate ? formatDate(stats.lastDonationDate) : '-'}</div>`;
    } else {
      membershipCard.classList.remove('premium');
      document.getElementById('membershipInfo').innerHTML =
        `<div>您尚未成為正式會員</div>
         <div class="mt-1">完成資料並聯繫管理員以升級。</div>`;
    }

    // 統計
    document.getElementById('totalDonations').textContent = stats.donationCount || 0;
    document.getElementById('totalAmount').textContent = '$' + (stats.donationTotal || 0).toLocaleString();

    // 基本與關懷顯示
    setDisplay('displayRealName', info.真實姓名);
    setDisplay('displayPhone', info.電話);
    setDisplay('displayEmail', info.Email);
    setDisplay('displayAddress', info.地址);
    setDisplay('displayBirthday', formatDate(info.生日));
    setDisplay('displayIsPatient', info.是否患者);
    setDisplay('displayRelationship', info.與患者關係);
    setDisplay('displayEmergencyContact', joinIf(info.緊急聯絡人, info.緊急聯絡電話));

    // 若已進入編輯模式則同步
    if(isEditing()){
      fillEditForm(info);
    }

    document.getElementById('profileCard').style.display='block';
  }

  /**********************************************************
   * 填入編輯表單
   **********************************************************/
  function fillEditForm(info){
    document.getElementById('realName').value = info.真實姓名 || '';
    document.getElementById('phone').value = info.電話 || '';
    document.getElementById('email').value = info.Email || '';
    document.getElementById('address').value = info.地址 || '';
    document.getElementById('birthday').value = normalizeDateInput(info.生日);
    document.getElementById('isPatient').value = info.是否患者 || '';
    document.getElementById('relationship').value = info.與患者關係 || '';
    document.getElementById('emergencyContact').value = info.緊急聯絡人 || '';
    document.getElementById('emergencyPhone').value = info.緊急聯絡電話 || '';
    document.getElementById('healthNotes').value = info.健康備註 || '';
  }

  function normalizeDateInput(val){
    if(!val) return '';
    const d = new Date(val);
    if(isNaN(d.getTime())) return '';
    return d.toISOString().split('T')[0];
  }

  /**********************************************************
   * 切換顯示 / 編輯
   **********************************************************/
  function showEditForm(){
    const info = rawUserData?.userInfo || {};
    fillEditForm(info);
    document.getElementById('profileView').style.display='none';
    document.getElementById('editForm').style.display='block';
    window.scrollTo({ top:0, behavior:'smooth' });
  }
  function cancelEdit(){
    document.getElementById('editForm').style.display='none';
    document.getElementById('profileView').style.display='block';
  }
  function isEditing(){
    return document.getElementById('editForm').style.display==='block';
  }

  /**********************************************************
   * 表單送出
   **********************************************************/
  document.getElementById('profileForm').addEventListener('submit', async e=>{
    e.preventDefault();
    // 簡單驗證
    const rn = document.getElementById('realName').value.trim();
    const ph = document.getElementById('phone').value.trim();
    if(!rn){ showError('真實姓名必填'); return; }
    if(!ph){ showError('聯絡電話必填'); return; }

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const oldHtml = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>儲存中...';

    const payload = {
      action: 'updateUserProfile',
      userId,
      真實姓名: rn,
      電話: ph,
      Email: document.getElementById('email').value.trim(),
      地址: document.getElementById('address').value.trim(),
      生日: document.getElementById('birthday').value,
      是否患者: document.getElementById('isPatient').value,
      與患者關係: document.getElementById('relationship').value,
      緊急聯絡人: document.getElementById('emergencyContact').value.trim(),
      緊急聯絡電話: document.getElementById('emergencyPhone').value.trim(),
      健康備註: document.getElementById('healthNotes').value.trim()
    };

    try {
      const result = await gasPost(payload);
      if(!result.success) throw new Error(result.message || '更新失敗');
      showSuccess('資料已更新');
      cancelEdit();
      // 更新後重新載入
      loadUserInfo();
    } catch(e2){
      showError(e2.message);
    } finally {
      submitBtn.disabled=false;
      submitBtn.innerHTML = oldHtml;
    }
  });

  /**********************************************************
   * UI / 工具
   **********************************************************/
  function setDisplay(id, value){
    document.getElementById(id).textContent = value ? value : '未設定';
  }
  function joinIf(a,b){
    if(a && b) return a + '（' + b + '）';
    return a || b || '未設定';
  }
  function toggleLoading(loading){
    document.getElementById('loadingScreen').style.display = loading ? 'block':'none';
    if(loading){
      document.getElementById('profileCard').style.display='none';
    }
  }
  function formatDate(d){
    if(!d) return '';
    const dt = new Date(d);
    if(isNaN(dt.getTime())) return '';
    return dt.toLocaleDateString('zh-TW');
  }

  function showError(msg){
    const el = document.getElementById('errorAlert');
    document.getElementById('errorMessage').textContent = msg;
    el.classList.remove('d-none');
    setTimeout(()=> el.classList.add('d-none'), 6000);
  }
  function showSuccess(msg){
    const el = document.getElementById('successAlert');
    document.getElementById('successMessage').textContent = msg;
    el.classList.remove('d-none');
    setTimeout(()=> el.classList.add('d-none'), 4000);
  }

</script>
</body>
</html>
                 
