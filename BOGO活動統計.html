<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BOGOå¤šç¦æ°£ åœ˜éšŠåˆ†æç³»çµ±</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Microsoft JhengHei','Arial',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:10px;min-height:100vh}
  .container{max-width:1200px;margin:0 auto}
  .header{background:white;padding:20px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.2);margin-bottom:20px;text-align:center}
  .header h1{color:#667eea;font-size:2em;margin-bottom:10px}
  .tab-buttons{display:flex;background:white;border-radius:10px;padding:10px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,0.1);gap:8px;flex-wrap:wrap}
  .tab-btn{flex:1;min-width:100px;padding:10px 10px;background:#f3f4f6;color:#6b7280;border:none;border-radius:8px;cursor:pointer;font-size:0.85em;font-weight:600;transition:all 0.3s}
  .tab-btn:hover{background:#e5e7eb}
  .tab-btn.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,0.4)}
  .tab-content{display:none}
  .tab-content.active{display:block;animation:fadeIn 0.3s}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .btn{padding:10px 18px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.95em;font-weight:600;transition:background 0.3s;margin:4px}
  .btn:hover{background:#5568d3}
  .btn-success{background:#10b981}.btn-success:hover{background:#059669}
  .team-container{background:white;padding:20px;border-radius:15px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,0.1);page-break-inside:avoid}
  .team-header{background:linear-gradient(135deg,#8b5cf6 0%,#6d28d9 100%);color:white;padding:12px 20px;border-radius:10px;margin-bottom:15px;font-size:1.4em;font-weight:bold}
  .section-title{background:#8b5cf6;color:white;padding:8px 15px;border-radius:8px;font-size:1.1em;font-weight:bold;margin:15px 0 10px 0}
  .maintenance-table{width:100%;border-collapse:collapse;margin-top:15px}
  .maintenance-table thead{background:#8b5cf6;color:white}
  .maintenance-table th{padding:12px;text-align:left;font-weight:600}
  .maintenance-table td{padding:10px 12px;border-bottom:1px solid #e5e7eb}
  .maintenance-table tbody tr:hover{background:#faf5ff}
  .maintenance-input{width:100%;padding:8px 12px;border:2px solid #e0e0e0;border-radius:6px;font-size:0.95em}
  .maintenance-input:focus{outline:none;border-color:#8b5cf6}
  .product-status-table{width:100%;border-collapse:collapse;margin-bottom:20px;font-size:0.9em;background:white}
  .product-status-table thead{background:#10b981;color:white}
  .product-status-table th{padding:10px 8px;text-align:left;font-weight:600;color:#000!important}
  .product-status-table td{padding:8px;border-bottom:1px solid #e5e7eb;color:#000!important}
  .product-status-table tbody tr:hover{background:#f0fdf4}
  .group-summary-table{width:100%;border-collapse:collapse;margin-bottom:15px;font-size:0.95em}
  .group-summary-table thead{background:#8b5cf6;color:white}
  .group-summary-table th{padding:10px 8px;text-align:left;font-weight:600;color:#000!important}
  .group-summary-table td{padding:8px;border-bottom:1px solid #e5e7eb;color:#000!important}
  .group-summary-table tbody tr:hover{background:#faf5ff}
  .person-block{border:2px solid #8b5cf6;border-radius:10px;padding:15px;margin-bottom:15px;background:#faf5ff;page-break-inside:avoid}
  .person-name{font-size:1.2em;font-weight:bold;color:#6b21a8;margin-bottom:10px;padding-bottom:8px;border-bottom:2px solid #8b5cf6}
  .person-table{width:100%;border-collapse:collapse;background:white;font-size:0.9em}
  .person-table thead{background:#e9d5ff;color:#6b21a8}
  .person-table th{padding:8px;text-align:left;font-weight:600;font-size:0.9em;color:#000!important}
  .person-table td{padding:6px 8px;border-bottom:1px solid #f3f4f6;color:#000!important}
  .person-table .total-row{background:#fef3c7;font-weight:bold}
  .person-table .total-row td{padding:8px;border-top:2px solid #f59e0b;color:#92400e!important}
  .comparison-table{width:100%;border-collapse:collapse;margin-bottom:20px;font-size:0.85em}
  .comparison-table thead{background:#10b981;color:white}
  .comparison-table th{padding:10px 6px;text-align:center;font-weight:600;border:1px solid white;color:#000!important}
  .comparison-table td{padding:8px 6px;text-align:center;border:1px solid #e5e7eb;color:#000!important}
  .comparison-table td:first-child{text-align:left;font-weight:600;background:#f9fafb}
  .comparison-table .total-row{background:#fef3c7!important;font-weight:bold}
  .comparison-table .total-row td{color:#92400e!important;border-top:2px solid #f59e0b}
  .comparison-table .subtotal-col{background:#e0f2fe!important;font-weight:600}
  .team-color-1{background:#fef3c7!important}.team-color-2{background:#dbeafe!important}.team-color-3{background:#fce7f3!important}
  .team-color-4{background:#d1fae5!important}.team-color-5{background:#fef2f2!important}.team-color-6{background:#f3e8ff!important}
  .search-bar{background:white;padding:20px;border-radius:10px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
  .search-input{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em;margin-bottom:10px}
  .search-input:focus{outline:none;border-color:#667eea}
  .search-results{max-height:300px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px;background:#f9fafb}
  .search-result-item{padding:12px 15px;border-bottom:1px solid #e5e7eb;cursor:pointer;transition:background 0.2s}
  .search-result-item:hover{background:#e0f2fe}
  .search-result-item:last-child{border-bottom:none}
  .filter-bar{background:white;padding:15px;border-radius:10px;margin-bottom:15px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
  select{padding:10px 15px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em}
  .loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;z-index:9999;flex-direction:column}
  .loading.show{display:flex}
  .spinner{border:5px solid #f3f3f3;border-top:5px solid #667eea;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;margin-bottom:20px}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  .sync-status{display:inline-block;padding:5px 12px;border-radius:20px;font-size:0.85em;margin-left:10px}
  .sync-status.synced{background:#d1fae5;color:#065f46}
  .maintenance-warning{color:#dc2626;font-size:0.9em;font-weight:bold;margin-left:10px}
  .badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:0.85em;font-weight:600}
  .badge-warning{background:#fef3c7;color:#92400e}
  /* ===== è‡ªè¨‚å ±è¡¨ ===== */
  .custom-report-panel{background:white;border-radius:15px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,0.1);margin-bottom:20px}
  .custom-report-panel h3{color:#6d28d9;font-size:1.2em;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #e9d5ff;display:flex;align-items:center;gap:8px}
  .step-badge{background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:white;width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:0.9em;font-weight:bold;flex-shrink:0}
  .mode-selector{display:flex;gap:15px;margin-bottom:5px}
  .mode-btn{flex:1;padding:14px;border:2px solid #e0e0e0;border-radius:10px;background:#f9fafb;cursor:pointer;text-align:center;transition:all 0.2s;font-size:1em;font-weight:600;color:#6b7280;user-select:none}
  .mode-btn:hover{border-color:#8b5cf6;background:#faf5ff;color:#6d28d9}
  .mode-btn.selected{border-color:#8b5cf6;background:linear-gradient(135deg,#f3e8ff,#ede9fe);color:#6d28d9;box-shadow:0 2px 8px rgba(139,92,246,0.2)}
  .mode-btn .mode-icon{font-size:1.8em;display:block;margin-bottom:5px}
  .custom-search-wrap{position:relative}
  .custom-search-input{width:100%;padding:12px 45px 12px 15px;border:2px solid #e0e0e0;border-radius:10px;font-size:1em;transition:border-color 0.2s}
  .custom-search-input:focus{outline:none;border-color:#8b5cf6}
  .custom-search-icon{position:absolute;right:14px;top:50%;transform:translateY(-50%);font-size:1.2em;color:#9ca3af;pointer-events:none}
  .custom-candidate-list{position:absolute;top:calc(100% + 4px);left:0;right:0;background:white;border:2px solid #e9d5ff;border-radius:10px;max-height:220px;overflow-y:auto;z-index:100;box-shadow:0 8px 20px rgba(0,0,0,0.12);display:none}
  .custom-candidate-item{padding:10px 15px;cursor:pointer;display:flex;align-items:center;gap:10px;border-bottom:1px solid #f3f4f6;transition:background 0.15s}
  .custom-candidate-item:last-child{border-bottom:none}
  .custom-candidate-item:hover{background:#faf5ff}
  .ci-tag{font-size:0.75em;padding:2px 8px;border-radius:10px;background:#e9d5ff;color:#6d28d9;font-weight:600;white-space:nowrap}
  .selected-targets{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;min-height:36px;align-items:center}
  .selected-tag{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:white;padding:6px 12px;border-radius:20px;font-size:0.9em;font-weight:600}
  .remove-tag{cursor:pointer;font-size:1.1em;line-height:1;opacity:0.8;transition:opacity 0.2s}
  .remove-tag:hover{opacity:1}
  .no-selection-hint{color:#9ca3af;font-size:0.9em;padding:8px 0}
  .col-options{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
  .col-option{display:flex;align-items:center;gap:10px;padding:12px 15px;border:2px solid #e0e0e0;border-radius:10px;cursor:pointer;transition:all 0.2s;background:#f9fafb;user-select:none}
  .col-option:hover:not(.required){border-color:#8b5cf6;background:#faf5ff}
  .col-option.required{border-color:#8b5cf6;background:#faf5ff;cursor:default}
  .col-option input[type="checkbox"]{width:18px;height:18px;accent-color:#8b5cf6;cursor:pointer;flex-shrink:0;pointer-events:none}
  .col-option input[type="checkbox"]:disabled{cursor:default}
  .col-option label{cursor:pointer;font-weight:600;color:#374151;flex:1;pointer-events:none}
  .col-option.required label{color:#6d28d9}
  .required-mark{color:#ef4444;font-size:0.8em;margin-left:4px}
  .generate-btn-wrap{text-align:center;margin-top:5px}
  .generate-btn{padding:14px 40px;background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:white;border:none;border-radius:12px;font-size:1.1em;font-weight:700;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 12px rgba(139,92,246,0.3)}
  .generate-btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(139,92,246,0.4)}
  .generate-btn:active{transform:translateY(0)}
  .report-header-bar{background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:white;padding:16px 20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
  .report-header-bar h2{font-size:1.3em;margin:0}
  .report-meta{font-size:0.85em;opacity:0.85;margin-top:4px}
  .report-print-btn{padding:8px 20px;background:white;color:#6d28d9;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:0.95em;transition:all 0.2s}
  .report-print-btn:hover{background:#f3e8ff}
  .custom-report-table{width:100%;border-collapse:collapse;font-size:0.92em;background:white}
  .custom-report-table thead tr{background:#ede9fe}
  .custom-report-table th{padding:11px 10px;text-align:left;font-weight:700;color:#4c1d95;border-bottom:2px solid #8b5cf6;border-right:1px solid #e9d5ff;white-space:nowrap}
  .custom-report-table th:last-child{border-right:none}
  .custom-report-table td{padding:9px 10px;border-bottom:1px solid #f3f4f6;border-right:1px solid #f3f4f6;color:#1f2937}
  .custom-report-table td:last-child{border-right:none}
  .custom-report-table tbody tr:hover{background:#faf5ff}
  /* åœ˜éšŠæ¨™é¡Œåˆ— */
  .custom-report-table .team-header-row td{background:linear-gradient(135deg,#6d28d9,#4c1d95);color:white;font-weight:700;padding:11px 12px;font-size:1.05em}
  /* æˆå“¡æ¨™é¡Œåˆ— */
  .custom-report-table .member-header-row td{background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;font-weight:700;padding:9px 12px;font-size:0.95em}
  /* å€‹äººå°è¨ˆåˆ— */
  .custom-report-table .person-subtotal-row{background:#f3e8ff;font-weight:700}
  .custom-report-table .person-subtotal-row td{color:#6d28d9;border-top:1px solid #c4b5fd}
  /* åœ˜éšŠå°è¨ˆåˆ— */
  .custom-report-table .team-subtotal-row{background:#ddd6fe;font-weight:700}
  .custom-report-table .team-subtotal-row td{color:#4c1d95;border-top:2px solid #8b5cf6;padding:10px}
  /* ç¸½è¨ˆåˆ— */
  .custom-report-table .grand-total-row{background:#fef3c7;font-weight:700}
  .custom-report-table .grand-total-row td{color:#92400e;border-top:2px solid #f59e0b;padding:11px 10px}
  /* å€‹äººæ¨¡å¼å€æ®µæ¨™é¡Œ */
  .custom-report-table .section-header-row td{background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:white;font-weight:700;padding:10px 12px;font-size:1em}
  /* å€‹äººæ¨¡å¼å°è¨ˆ */
  .custom-report-table .subtotal-row{background:#ede9fe;font-weight:700}
  .custom-report-table .subtotal-row td{color:#4c1d95;border-top:1px solid #c4b5fd}
  .num-col{text-align:right!important}
  .center-col{text-align:center!important}
  .empty-report{text-align:center;padding:40px;color:#9ca3af;font-size:1.1em}
  @media print{
    body{background:white;padding:0}
    .header,.filter-bar,.tab-buttons,.search-bar,.custom-report-panel,.report-print-btn{display:none!important}
    .container{max-width:100%}
    .team-container{page-break-inside:avoid;box-shadow:none;border:1px solid #ddd}
    .person-block{page-break-inside:avoid}
    #customReportOutput{display:block!important}
    .report-header-bar{-webkit-print-color-adjust:exact;print-color-adjust:exact}
  }
  @media(max-width:768px){
    .tab-btn{min-width:85px;font-size:0.75em;padding:8px 6px}
    .mode-selector{flex-direction:column}
    .col-options{grid-template-columns:1fr 1fr}
  }
</style>
</head>
<body>
<div class="loading" id="loading">
  <div class="spinner"></div>
  <div style="color:white;font-size:1.2em">è¼‰å…¥ä¸­...</div>
</div>
<div class="container">
  <div class="header">
    <h1>ğŸ¯ BOGOå¤šç¦æ°£ åœ˜éšŠåˆ†æç³»çµ±</h1>
    <p>ä»¥åœ˜éšŠç‚ºä¸»è»¸çš„å®Œæ•´è¨‚è³¼èˆ‡æ¶è³¼åˆ†æ
      <span class="sync-status synced" id="syncStatus">â— å·²åŒæ­¥</span>
    </p>
  </div>
  <div class="tab-buttons">
    <button class="tab-btn active" onclick="switchTab('overview',this)">ğŸ“Š ç¸½åˆ†æç‹€æ³</button>
    <button class="tab-btn" onclick="switchTab('orderSummary',this)">ğŸ“¦ è¨‚è³¼çµ„åˆ¥çµ±è¨ˆ</button>
    <button class="tab-btn" onclick="switchTab('orderDetail',this)">ğŸ“‹ è¨‚è³¼è©³ç´°æ¸…å–®</button>
    <button class="tab-btn" onclick="switchTab('reportSummary',this)">ğŸ¯ æ¶è³¼çµ„åˆ¥çµ±è¨ˆ</button>
    <button class="tab-btn" onclick="switchTab('reportDetail',this)">ğŸ æ¶è³¼è©³ç´°æ¸…å–®</button>
    <button class="tab-btn" onclick="switchTab('customReport',this)">ğŸ“„ è‡ªè¨‚å ±è¡¨</button>
    <button class="tab-btn" onclick="switchTab('maintenance',this)">ğŸ”§ åœ˜éšŠåå–®ç¶­è­·</button>
    <button class="tab-btn" onclick="switchTab('search',this)">ğŸ” æœå°‹</button>
  </div>

  <!-- 1.ç¸½åˆ†æ -->
  <div id="overviewTab" class="tab-content active">
    <div class="filter-bar"><button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button></div>
    <div class="team-container">
      <h3 style="color:#000;font-size:1.3em;margin-bottom:15px">ğŸ“¦ ç”¢å“éŠ·å”®ç‹€æ³</h3>
      <table class="product-status-table" id="productStatusTable"></table>
    </div>
    <div class="team-container">
      <h3 style="color:#000;font-size:1.3em;margin-bottom:15px">ğŸ“Š åœ˜éšŠç”¢å“çµ„æ•¸çµ±è¨ˆ
        <span class="maintenance-warning" id="maintenanceWarning" style="display:none">âš ï¸ éœ€ç¶­è­·åœ˜éšŠåå–®</span>
      </h3>
      <div style="overflow-x:auto"><table class="comparison-table" id="comparisonTable"></table></div>
    </div>
  </div>

  <!-- 2.è¨‚è³¼çµ„åˆ¥çµ±è¨ˆ -->
  <div id="orderSummaryTab" class="tab-content">
    <div class="filter-bar">
      <label>åœ˜éšŠï¼š</label>
      <select id="orderSummaryTeamFilter" onchange="displayOrderSummary()"><option value="all">å…¨éƒ¨åœ˜éšŠ</option></select>
      <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
    </div>
    <div id="orderSummaryContent"></div>
  </div>

  <!-- 3.è¨‚è³¼è©³ç´°æ¸…å–® -->
  <div id="orderDetailTab" class="tab-content">
    <div class="filter-bar">
      <label>åœ˜éšŠï¼š</label>
      <select id="orderDetailTeamFilter" onchange="displayOrderDetail()"><option value="all">å…¨éƒ¨åœ˜éšŠ</option></select>
      <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
    </div>
    <div id="orderDetailContent"></div>
  </div>

  <!-- 4.æ¶è³¼çµ„åˆ¥çµ±è¨ˆ -->
  <div id="reportSummaryTab" class="tab-content">
    <div class="filter-bar">
      <label>åœ˜éšŠï¼š</label>
      <select id="reportSummaryTeamFilter" onchange="displayReportSummary()"><option value="all">å…¨éƒ¨åœ˜éšŠ</option></select>
      <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
    </div>
    <div id="reportSummaryContent"></div>
  </div>

  <!-- 5.æ¶è³¼è©³ç´°æ¸…å–® -->
  <div id="reportDetailTab" class="tab-content">
    <div class="filter-bar">
      <label>åœ˜éšŠï¼š</label>
      <select id="reportDetailTeamFilter" onchange="displayReportDetail()"><option value="all">å…¨éƒ¨åœ˜éšŠ</option></select>
      <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
    </div>
    <div id="reportDetailContent"></div>
  </div>

  <!-- 6.è‡ªè¨‚å ±è¡¨ -->
  <div id="customReportTab" class="tab-content">
    <div class="custom-report-panel">
      <h3><span class="step-badge">1</span> é¸æ“‡å ±è¡¨æ¨¡å¼</h3>
      <div class="mode-selector">
        <div class="mode-btn selected" id="modePersonBtn" onclick="selectMode('person')">
          <span class="mode-icon">ğŸ‘¤</span>å€‹äººå ±è¡¨
        </div>
        <div class="mode-btn" id="modeTeamBtn" onclick="selectMode('team')">
          <span class="mode-icon">ğŸ¢</span>åœ˜éšŠå ±è¡¨ï¼ˆå±•é–‹æˆå“¡ï¼‰
        </div>
      </div>
    </div>
    <div class="custom-report-panel">
      <h3><span class="step-badge">2</span> æœå°‹ä¸¦é¸æ“‡å°è±¡</h3>
      <div class="custom-search-wrap">
        <input type="text" class="custom-search-input" id="customSearchInput"
               placeholder="è¼¸å…¥é—œéµå­—æœå°‹..." oninput="onCustomSearch()" autocomplete="off">
        <span class="custom-search-icon">ğŸ”</span>
        <div class="custom-candidate-list" id="customCandidateList"></div>
      </div>
      <div class="selected-targets" id="selectedTargets">
        <span class="no-selection-hint" id="noSelHint">å°šæœªé¸æ“‡å°è±¡ï¼Œè«‹è¼¸å…¥é—œéµå­—æœå°‹</span>
      </div>
    </div>
    <div class="custom-report-panel">
      <h3><span class="step-badge">3</span> é¸æ“‡é¡¯ç¤ºæ¬„ä½</h3>
      <div class="col-options">
        <div class="col-option required">
          <input type="checkbox" id="col_code" checked disabled>
          <label>ç”¢å“ä»£è™Ÿ <span class="required-mark">â˜…å¿…é¸</span></label>
        </div>
        <div class="col-option" onclick="toggleCol(this,'col_name')">
          <input type="checkbox" id="col_name" checked>
          <label>ç”¢å“åç¨±</label>
        </div>
        <div class="col-option" onclick="toggleCol(this,'col_price')">
          <input type="checkbox" id="col_price" checked>
          <label>ç”¢å“å–®åƒ¹</label>
        </div>
        <div class="col-option" onclick="toggleCol(this,'col_pv')">
          <input type="checkbox" id="col_pv">
          <label>ç”¢å“PVæ•¸</label>
        </div>
        <div class="col-option required">
          <input type="checkbox" id="col_qty" checked disabled>
          <label>è¨‚è³¼æ•¸é‡åˆè¨ˆ <span class="required-mark">â˜…å¿…é¸</span></label>
        </div>
        <div class="col-option" onclick="toggleCol(this,'col_amount')">
          <input type="checkbox" id="col_amount" checked>
          <label>åˆè¨ˆé‡‘é¡</label>
        </div>
        <div class="col-option" onclick="toggleCol(this,'col_pvtotal')">
          <input type="checkbox" id="col_pvtotal">
          <label>åˆè¨ˆPVæ•¸</label>
        </div>
        <div class="col-option required">
          <input type="checkbox" id="col_grandtotal" checked disabled>
          <label>ç¸½è¨ˆé‡‘é¡ <span class="required-mark">â˜…å¿…é¸</span></label>
        </div>
      </div>
    </div>
    <div class="custom-report-panel">
      <h3><span class="step-badge">4</span> ç”¢ç”Ÿå ±è¡¨</h3>
      <div class="generate-btn-wrap">
        <button class="generate-btn" onclick="generateCustomReport()">âœ¨ ç”¢ç”Ÿè‡ªè¨‚å ±è¡¨</button>
      </div>
    </div>
    <div id="customReportOutput" style="display:none">
      <div class="team-container" style="padding:0;overflow:hidden">
        <div class="report-header-bar">
          <div>
            <h2 id="reportTitle">è‡ªè¨‚å ±è¡¨</h2>
            <div class="report-meta" id="reportMeta"></div>
          </div>
          <button class="report-print-btn" onclick="printCustomReport()">ğŸ–¨ï¸ åˆ—å°å ±è¡¨</button>
        </div>
        <div style="overflow-x:auto;padding:0 0 10px 0">
          <div id="customReportTableWrap"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 7.ç¶­è­· -->
  <div id="maintenanceTab" class="tab-content">
    <div class="team-container">
      <div class="team-header">ğŸ”§ åœ˜éšŠåå–®ç¶­è­·</div>
      <p style="color:#666;margin-bottom:15px">ä»¥ä¸‹æ˜¯éœ€è¦ç¶­è­·åœ˜éšŠè³‡è¨Šçš„åå–®ï¼Œè«‹ç‚ºæ¯å€‹äººå“¡æŒ‡å®šæ‰€å±¬åœ˜éšŠã€‚</p>
      <div id="maintenanceContent"><p style="text-align:center;color:#999;padding:20px">è¼‰å…¥ä¸­...</p></div>
    </div>
  </div>

  <!-- 8.æœå°‹ -->
  <div id="searchTab" class="tab-content">
    <div class="search-bar">
      <input type="text" class="search-input" id="searchInput"
             placeholder="è¼¸å…¥å§“åé—œéµå­—æœå°‹..." oninput="performSearch()">
      <div class="search-results" id="searchResults" style="display:none"></div>
    </div>
    <div id="searchDetailContent"></div>
  </div>
</div>

<script>
const WEB_APP_URL='https://script.google.com/macros/s/AKfycbwC9VRQpFQBl0D-awe9_C8FFWPp_Zy4-ngVrO_cw06TigEeL0oqhK_Nq_SwcEQp1pO0OQ/exec';
let allOrders=[],allReports=[],maintenanceData=[],maintenanceList=[];
let teamAnalysisData={},productNameMap={},productPriceMap={},productPVMap={},productSalesData={};
let needsMaintenance=false,allPeople=new Set();
let customMode='person',selectedTargets=[];
const TEAM_ORDER=['è¯è±','æ€¡æ–‡','å°é¡','å®¶å˜‰','è‹”ç'];

function sortTeams(arr){
  return [...arr].sort((a,b)=>{
    const ia=TEAM_ORDER.indexOf(a),ib=TEAM_ORDER.indexOf(b);
    if(ia!==-1&&ib!==-1)return ia-ib;
    if(ia!==-1)return -1;if(ib!==-1)return 1;
    return a.localeCompare(b);
  });
}
function sortGC(a,b){
  const o=['1A','1B','2A','2B','3A','3B','4A','4B','5A','5B'];
  const ia=o.indexOf(a),ib=o.indexOf(b);
  if(ia!==-1&&ib!==-1)return ia-ib;
  if(ia!==-1)return -1;if(ib!==-1)return 1;
  return a.localeCompare(b);
}
function showLoading(s){document.getElementById('loading').classList.toggle('show',s)}
function updateSyncStatus(){
  const n=new Date();
  document.getElementById('syncStatus').textContent=`â— å·²åŒæ­¥ ${n.getHours()}:${String(n.getMinutes()).padStart(2,'0')}`;
}
function switchTab(name,btn){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  if(btn)btn.classList.add('active');
  document.getElementById(name+'Tab').classList.add('active');
  const m={orderSummary:displayOrderSummary,orderDetail:displayOrderDetail,
           reportSummary:displayReportSummary,reportDetail:displayReportDetail,
           maintenance:loadMaintenanceList,customReport:initCustomReport};
  if(m[name])m[name]();
}

/* ===== è³‡æ–™è¼‰å…¥ ===== */
async function autoConnectAndAnalyze(silent=false){
  if(!silent)showLoading(true);
  try{
    const [oR,rR,mR]=await Promise.all([
      fetch(WEB_APP_URL+'?action=getOrders'),
      fetch(WEB_APP_URL+'?action=getReports'),
      fetch(WEB_APP_URL+'?action=getMaintenance')
    ]);
    const oJ=await oR.json(),rJ=await rR.json(),mJ=await mR.json();
    if(!oJ.success||!rJ.success)throw new Error('è¼‰å…¥è³‡æ–™å¤±æ•—');
    allOrders=oJ.data;allReports=rJ.data;
    maintenanceData=mJ.success?mJ.data:[];
    allOrders.forEach(o=>{
      const gc=o.çµ„åˆ¥ä»£è™Ÿ||o.çµ„åˆ¥;
      if(gc){
        if(!productNameMap[gc])productNameMap[gc]=o['ç”¢å“åç¨±( BOGOå°ˆç”¨ )']||gc;
        if(!productPriceMap[gc])productPriceMap[gc]=parseInt(o.å–®åƒ¹)||0;
        if(!productPVMap[gc])productPVMap[gc]=parseInt(o.PV)||0;
      }
    });
    analyzeProductSales();analyzeByTeam();updateSyncStatus();updateTeamFilters();
  }catch(e){console.error(e);if(!silent)alert('è¼‰å…¥å¤±æ•—ï¼š'+e.message);}
  finally{if(!silent)showLoading(false);}
}

/* ===== ç¶­è­· ===== */
async function loadMaintenanceList(){
  showLoading(true);
  try{
    const r=await fetch(WEB_APP_URL+'?action=getMaintenanceList');
    const j=await r.json();
    if(!j.success)throw new Error('è¼‰å…¥ç¶­è­·åå–®å¤±æ•—');
    maintenanceList=j.data;displayMaintenanceList();
  }catch(e){alert('è¼‰å…¥ç¶­è­·åå–®å¤±æ•—ï¼š'+e.message);}
  finally{showLoading(false);}
}
function displayMaintenanceList(){
  const c=document.getElementById('maintenanceContent');
  if(maintenanceList.length===0){
    c.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
      <p style="color:#10b981;font-size:1.1em;margin:0">âœ… ç›®å‰æ²’æœ‰éœ€è¦ç¶­è­·çš„åå–®</p>
      <button class="btn" onclick="openSpreadsheet()">ğŸ“„ é–‹å•ŸåŸå§‹æª”</button></div>`;return;
  }
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
    <p style="color:#dc2626;font-weight:600;margin:0">âš ï¸ å…±æœ‰ ${maintenanceList.length} ç­†åå–®éœ€è¦ç¶­è­·</p>
    <button class="btn" onclick="openSpreadsheet()">ğŸ“„ é–‹å•ŸåŸå§‹æª”</button></div>
    <table class="maintenance-table"><thead><tr>
      <th style="width:10%">ç·¨è™Ÿ</th><th style="width:25%">åå–®</th>
      <th style="width:20%">ç›®å‰ç‹€æ…‹</th><th style="width:30%">æŒ‡å®šåœ˜éšŠ</th><th style="width:15%">æ“ä½œ</th>
    </tr></thead><tbody>`;
  maintenanceList.forEach(item=>{
    h+=`<tr><td>${item.ç·¨è™Ÿ}</td><td><strong>${item.åå–®}</strong></td>
      <td><span class="badge badge-warning">è«‹ç¶­è­·--></span></td>
      <td><input type="text" class="maintenance-input" id="team_${item.rowIndex}"
        placeholder="è«‹è¼¸å…¥åœ˜éšŠåç¨±" list="teamSuggestions"></td>
      <td><button class="btn btn-success" onclick="updateMaintenance(${item.rowIndex},'${item.åå–®}')">âœ“ å„²å­˜</button></td>
    </tr>`;
  });
  h+=`</tbody></table><datalist id="teamSuggestions">
    <option value="è¯è±"><option value="æ€¡æ–‡"><option value="å°é¡"><option value="å®¶å˜‰"><option value="è‹”ç">
  </datalist>`;
  c.innerHTML=h;
}
async function openSpreadsheet(){
  try{
    const r=await fetch(WEB_APP_URL+'?action=getSpreadsheetUrl');
    const j=await r.json();
    if(!j.success)throw new Error('ç„¡æ³•å–å¾—è©¦ç®—è¡¨é€£çµ');
    window.open(j.data.url,'_blank');
  }catch(e){alert('é–‹å•Ÿè©¦ç®—è¡¨å¤±æ•—ï¼š'+e.message);}
}
async function updateMaintenance(rowIndex,personName){
  const el=document.getElementById(`team_${rowIndex}`);
  const v=el.value.trim();
  if(!v){alert('è«‹è¼¸å…¥åœ˜éšŠåç¨±');return;}
  showLoading(true);
  try{
    const fd=new URLSearchParams();
    fd.append('action','updateMaintenance');fd.append('rowIndex',rowIndex);fd.append('teamValue',v);
    const r=await fetch(WEB_APP_URL,{method:'POST',body:fd});
    const j=await r.json();
    if(!j.success)throw new Error('æ›´æ–°å¤±æ•—');
    alert(`âœ… å·²æˆåŠŸå°‡ã€Œ${personName}ã€æŒ‡å®šåˆ°ã€Œ${v}ã€åœ˜éšŠ`);
    await loadMaintenanceList();await autoConnectAndAnalyze(true);
  }catch(e){alert('æ›´æ–°å¤±æ•—ï¼š'+e.message);}
  finally{showLoading(false);}
}

/* ===== ç”¢å“éŠ·å”® ===== */
function analyzeProductSales(){
  productSalesData={};
  allOrders.forEach(o=>{
    const gc=o.çµ„åˆ¥ä»£è™Ÿ||o.çµ„åˆ¥||'æœªåˆ†çµ„';
    const pn=o['ç”¢å“åç¨±( BOGOå°ˆç”¨ )']||gc;
    const qty=parseInt(o.è¨‚è³¼æ•¸é‡)||0,amount=parseInt(o.åˆè¨ˆ)||0;
    if(!productSalesData[gc])productSalesData[gc]={productName:pn,orderQty:0,orderAmount:0,reportQty:0,reportAmount:0};
    productSalesData[gc].orderQty+=qty;productSalesData[gc].orderAmount+=amount;
  });
  allReports.forEach(r=>{
    const gc=r.çµ„åˆ¥ä»£è™Ÿ||'æœªåˆ†çµ„';
    const qty=parseInt(r.æ¶è³¼çµ„æ•¸)||0,price=parseInt(r.å–®åƒ¹)||0;
    if(!productSalesData[gc])productSalesData[gc]={productName:productNameMap[gc]||gc,orderQty:0,orderAmount:0,reportQty:0,reportAmount:0};
    productSalesData[gc].reportQty+=qty;productSalesData[gc].reportAmount+=qty*price;
  });
  displayProductStatus();
}
function displayProductStatus(){
  const t=document.getElementById('productStatusTable');
  let h='<thead><tr>';
  ['çµ„åˆ¥ä»£è™Ÿ','ç”¢å“åç¨±','è¨‚è³¼æ•¸é‡','è¨‚è³¼é‡‘é¡','æ¶è³¼æ•¸é‡','æ¶è³¼é‡‘é¡','ç¸½æ•¸é‡','ç¸½é‡‘é¡'].forEach((lbl,i)=>{
    const a=i>=2?(i%2===0?'center':'right'):'left';
    h+=`<th style="text-align:${a};color:#000">${lbl}</th>`;
  });
  h+='</tr></thead><tbody>';
  let tOQ=0,tOA=0,tRQ=0,tRA=0;
  Object.keys(productSalesData).sort(sortGC).forEach(gc=>{
    const d=productSalesData[gc];
    h+=`<tr>
      <td style="color:#000"><strong>${gc}</strong></td><td style="color:#000">${d.productName}</td>
      <td style="text-align:center;color:#000">${d.orderQty}</td>
      <td style="text-align:right;color:#000">$${d.orderAmount.toLocaleString()}</td>
      <td style="text-align:center;color:#000">${d.reportQty}</td>
      <td style="text-align:right;color:#000">$${d.reportAmount.toLocaleString()}</td>
      <td style="text-align:center;color:#000"><strong>${d.orderQty+d.reportQty}</strong></td>
      <td style="text-align:right;color:#000"><strong>$${(d.orderAmount+d.reportAmount).toLocaleString()}</strong></td>
    </tr>`;
    tOQ+=d.orderQty;tOA+=d.orderAmount;tRQ+=d.reportQty;tRA+=d.reportAmount;
  });
  h+=`<tr style="background:#fef3c7;font-weight:bold">
    <td colspan="2" style="color:#92400e">ç¸½è¨ˆ</td>
    <td style="text-align:center;color:#92400e">${tOQ}</td>
    <td style="text-align:right;color:#92400e">$${tOA.toLocaleString()}</td>
    <td style="text-align:center;color:#92400e">${tRQ}</td>
    <td style="text-align:right;color:#92400e">$${tRA.toLocaleString()}</td>
    <td style="text-align:center;color:#92400e">${tOQ+tRQ}</td>
    <td style="text-align:right;color:#92400e">$${(tOA+tRA).toLocaleString()}</td>
  </tr></tbody>`;
  t.innerHTML=h;
}

/* ===== åˆ†æ ===== */
function analyzeByTeam(){
  teamAnalysisData={};needsMaintenance=false;allPeople.clear();
  const n2t={};
  maintenanceData.forEach(item=>{
    if(item.è¨‚è³¼åå–®&&item.åœ˜éšŠ){n2t[item.è¨‚è³¼åå–®]=item.åœ˜éšŠ;if(item.åœ˜éšŠ.includes('è«‹ç¶­è­·'))needsMaintenance=true;}
  });
  allReports.forEach(r=>{if(r.æ¶è³¼è€…&&r.åœ˜éšŠ){n2t[r.æ¶è³¼è€…]=r.åœ˜éšŠ;if(r.åœ˜éšŠ.includes('è«‹ç¶­è­·'))needsMaintenance=true;}});
  document.getElementById('maintenanceWarning').style.display=needsMaintenance?'inline':'none';
  function ensureTeam(t){
    if(!teamAnalysisData[t])teamAnalysisData[t]={orders:{},reports:{},groupSummary:{},reportGroupSummary:{},totalOrderQty:0,totalOrderAmount:0,totalReportQty:0,totalReportAmount:0};
  }
  allOrders.forEach(o=>{
    const name=o.LINEåç¨±.split('(ä»£)')[0].trim();allPeople.add(name);
    let team=(o.åœ˜éšŠ||n2t[name]||n2t[o.LINEåç¨±]||'æœªåˆ†é…').replace(/è«‹ç¶­è­·\s*-*>\s*/g,'').trim();
    const gc=o.çµ„åˆ¥ä»£è™Ÿ||o.çµ„åˆ¥||'æœªåˆ†çµ„',pn=o['ç”¢å“åç¨±( BOGOå°ˆç”¨ )']||gc;
    ensureTeam(team);
    if(!teamAnalysisData[team].orders[name])teamAnalysisData[team].orders[name]={};
    if(!teamAnalysisData[team].orders[name][gc])teamAnalysisData[team].orders[name][gc]={productName:pn,qty:0,amount:0,price:0,pv:0};
    const qty=parseInt(o.è¨‚è³¼æ•¸é‡)||0,price=parseInt(o.å–®åƒ¹)||0,pv=parseInt(o.PV)||0;
    const amount=parseInt(o.åˆè¨ˆ)||(qty*price);
    teamAnalysisData[team].orders[name][gc].qty+=qty;
    teamAnalysisData[team].orders[name][gc].amount+=amount;
    teamAnalysisData[team].orders[name][gc].price=price;
    teamAnalysisData[team].orders[name][gc].pv=pv;
    if(!teamAnalysisData[team].groupSummary[gc])teamAnalysisData[team].groupSummary[gc]={qty:0,amount:0};
    teamAnalysisData[team].groupSummary[gc].qty+=qty;teamAnalysisData[team].groupSummary[gc].amount+=amount;
    teamAnalysisData[team].totalOrderQty+=qty;teamAnalysisData[team].totalOrderAmount+=amount;
  });
  allReports.forEach(r=>{
    const buyer=r.æ¶è³¼è€…;allPeople.add(buyer);
    let team=(r.åœ˜éšŠ||'æœªåˆ†é…').replace(/è«‹ç¶­è­·\s*-*>\s*/g,'').trim();
    const gc=r.çµ„åˆ¥ä»£è™Ÿ||'æœªåˆ†çµ„';
    ensureTeam(team);
    if(!teamAnalysisData[team].reports[buyer])teamAnalysisData[team].reports[buyer]={};
    if(!teamAnalysisData[team].reports[buyer][gc])teamAnalysisData[team].reports[buyer][gc]={qty:0,amount:0,price:0,buySend:r['è²·/é€']||''};
    const qty=parseInt(r.æ¶è³¼çµ„æ•¸)||0,price=parseInt(r.å–®åƒ¹)||0;
    teamAnalysisData[team].reports[buyer][gc].qty+=qty;
    teamAnalysisData[team].reports[buyer][gc].amount+=qty*price;
    teamAnalysisData[team].reports[buyer][gc].price=price;
    if(!teamAnalysisData[team].reportGroupSummary[gc])teamAnalysisData[team].reportGroupSummary[gc]={qty:0,amount:0};
    teamAnalysisData[team].reportGroupSummary[gc].qty+=qty;teamAnalysisData[team].reportGroupSummary[gc].amount+=qty*price;
    teamAnalysisData[team].totalReportQty+=qty;teamAnalysisData[team].totalReportAmount+=qty*price;
  });
  displayComparisonTable();
}
function displayComparisonTable(){
  const table=document.getElementById('comparisonTable');
  const teams=sortTeams(Object.keys(teamAnalysisData));
  const ag=new Set();
  teams.forEach(t=>{Object.keys(teamAnalysisData[t].groupSummary).forEach(g=>ag.add(g));Object.keys(teamAnalysisData[t].reportGroupSummary).forEach(g=>ag.add(g));});
  const sg=Array.from(ag).sort(sortGC);
  let h=`<thead><tr><th style="color:#000">çµ„åˆ¥</th><th style="color:#000;background:#e0f2fe">è¨‚è³¼åˆè¨ˆ</th><th style="color:#000;background:#e0f2fe">æ¶è³¼åˆè¨ˆ</th>`;
  teams.forEach((t,i)=>{h+=`<th class="team-color-${(i%6)+1}" colspan="2" style="color:#000">${t}</th>`;});
  h+=`</tr><tr><th></th><th style="background:#e0f2fe"></th><th style="background:#e0f2fe"></th>`;
  teams.forEach((t,i)=>{h+=`<th class="team-color-${(i%6)+1}" style="color:#000">è¨‚è³¼</th><th class="team-color-${(i%6)+1}" style="color:#000">æ¶è³¼</th>`;});
  h+='</tr></thead><tbody>';
  sg.forEach(g=>{
    let gO=0,gR=0;
    teams.forEach(t=>{gO+=teamAnalysisData[t].groupSummary[g]?.qty||0;gR+=teamAnalysisData[t].reportGroupSummary[g]?.qty||0;});
    h+=`<tr><td style="color:#000"><strong>${g}</strong></td><td class="subtotal-col" style="color:#000"><strong>${gO}</strong></td><td class="subtotal-col" style="color:#000"><strong>${gR}</strong></td>`;
    teams.forEach((t,i)=>{
      const oq=teamAnalysisData[t].groupSummary[g]?.qty||0,rq=teamAnalysisData[t].reportGroupSummary[g]?.qty||0;
      h+=`<td class="team-color-${(i%6)+1}" style="color:#000">${oq>0?oq:'-'}</td><td class="team-color-${(i%6)+1}" style="color:#000">${rq>0?rq:'-'}</td>`;
    });
    h+='</tr>';
  });
  let gO=0,gR=0;
  teams.forEach(t=>{gO+=teamAnalysisData[t].totalOrderQty;gR+=teamAnalysisData[t].totalReportQty;});
  h+=`<tr class="total-row"><td style="color:#92400e"><strong>åˆè¨ˆçµ„æ•¸</strong></td><td class="subtotal-col" style="color:#92400e"><strong>${gO}</strong></td><td class="subtotal-col" style="color:#92400e"><strong>${gR}</strong></td>`;
  teams.forEach((t,i)=>{h+=`<td class="team-color-${(i%6)+1}" style="color:#92400e"><strong>${teamAnalysisData[t].totalOrderQty}</strong></td><td class="team-color-${(i%6)+1}" style="color:#92400e"><strong>${teamAnalysisData[t].totalReportQty}</strong></td>`;});
  h+='</tr></tbody>';
  table.innerHTML=h;
}
function updateTeamFilters(){
  const teams=sortTeams(Object.keys(teamAnalysisData));
  ['orderSummaryTeamFilter','orderDetailTeamFilter','reportSummaryTeamFilter','reportDetailTeamFilter'].forEach(id=>{
    const f=document.getElementById(id);
    f.innerHTML='<option value="all">å…¨éƒ¨åœ˜éšŠ</option>';
    teams.forEach(t=>{f.innerHTML+=`<option value="${t}">${t}</option>`;});
  });
}

/* ===== å„åˆ†é é¡¯ç¤º ===== */
function displayOrderSummary(){
  const sel=document.getElementById('orderSummaryTeamFilter').value;
  const c=document.getElementById('orderSummaryContent');
  const teams=sel==='all'?sortTeams(Object.keys(teamAnalysisData)):[sel];
  let h='';
  teams.forEach(team=>{
    const d=teamAnalysisData[team];
    if(!d||Object.keys(d.groupSummary).length===0)return;
    h+=`<div class="team-container"><div class="team-header">ğŸ¢ ${team} - è¨‚è³¼çµ„åˆ¥çµ±è¨ˆ</div>
      <table class="group-summary-table"><thead><tr>
        <th style="color:#000">çµ„åˆ¥</th><th style="color:#000">ç”¢å“åç¨±</th>
        <th style="text-align:center;color:#000">æ•¸é‡</th><th style="text-align:right;color:#000">é‡‘é¡</th>
      </tr></thead><tbody>`;
    Object.keys(d.groupSummary).sort(sortGC).forEach(gc=>{
      const s=d.groupSummary[gc];
      h+=`<tr><td style="color:#000"><strong>${gc}</strong></td><td style="color:#000">${productNameMap[gc]||gc}</td>
        <td style="text-align:center;color:#000">${s.qty} çµ„</td><td style="text-align:right;color:#000">$${s.amount.toLocaleString()}</td></tr>`;
    });
    h+=`<tr style="background:#fef3c7;font-weight:bold"><td colspan="2" style="color:#92400e">ç¸½è¨ˆ</td>
      <td style="text-align:center;color:#92400e">${d.totalOrderQty} çµ„</td>
      <td style="text-align:right;color:#92400e">$${d.totalOrderAmount.toLocaleString()}</td></tr>
      </tbody></table></div>`;
  });
  c.innerHTML=h||'<div class="team-container"><p style="text-align:center;color:#999">æš«ç„¡è¨‚è³¼è³‡æ–™</p></div>';
}
function displayOrderDetail(){
  const sel=document.getElementById('orderDetailTeamFilter').value;
  const c=document.getElementById('orderDetailContent');
  const teams=sel==='all'?sortTeams(Object.keys(teamAnalysisData)):[sel];
  let h='';
  teams.forEach(team=>{
    const d=teamAnalysisData[team];
    if(!d||Object.keys(d.orders).length===0)return;
    h+=`<div class="team-container"><div class="team-header">ğŸ¢ ${team} - è¨‚è³¼è©³ç´°æ¸…å–®</div>`;
    for(const [person,groups] of Object.entries(d.orders)){
      h+=`<div class="person-block"><div class="person-name">ğŸ‘¤ ${person}</div>
        <table class="person-table"><thead><tr>
          <th style="color:#000">çµ„åˆ¥</th><th style="color:#000">ç”¢å“åç¨±</th>
          <th style="text-align:center;color:#000">æ•¸é‡</th>
          <th style="text-align:right;color:#000">å–®åƒ¹</th>
          <th style="text-align:right;color:#000">é‡‘é¡</th>
        </tr></thead><tbody>`;
      let pT={qty:0,amount:0};
      Object.keys(groups).sort(sortGC).forEach(gc=>{
        const g=groups[gc];
        h+=`<tr><td style="color:#000">${gc}</td><td style="color:#000">${g.productName}</td>
          <td style="text-align:center;color:#000">${g.qty}</td>
          <td style="text-align:right;color:#000">$${g.price.toLocaleString()}</td>
          <td style="text-align:right;color:#000">$${g.amount.toLocaleString()}</td></tr>`;
        pT.qty+=g.qty;pT.amount+=g.amount;
      });
      h+=`<tr class="total-row"><td colspan="2" style="color:#92400e"><strong>ç¸½è¨ˆ</strong></td>
        <td style="text-align:center;color:#92400e"><strong>${pT.qty}</strong></td><td></td>
        <td style="text-align:right;color:#92400e"><strong>$${pT.amount.toLocaleString()}</strong></td>
        </tr></tbody></table></div>`;
    }
    h+='</div>';
  });
  c.innerHTML=h||'<div class="team-container"><p style="text-align:center;color:#999">æš«ç„¡è¨‚è³¼è³‡æ–™</p></div>';
}
function displayReportSummary(){
  const sel=document.getElementById('reportSummaryTeamFilter').value;
  const c=document.getElementById('reportSummaryContent');
  const teams=sel==='all'?sortTeams(Object.keys(teamAnalysisData)):[sel];
  let h='';
  teams.forEach(team=>{
    const d=teamAnalysisData[team];
    if(!d||Object.keys(d.reportGroupSummary).length===0)return;
    h+=`<div class="team-container"><div class="team-header">ğŸ¢ ${team} - æ¶è³¼çµ„åˆ¥çµ±è¨ˆ</div>
      <table class="group-summary-table"><thead><tr>
        <th style="color:#000">çµ„åˆ¥</th><th style="color:#000">ç”¢å“åç¨±</th>
        <th style="text-align:center;color:#000">æ•¸é‡</th><th style="text-align:right;color:#000">é‡‘é¡</th>
      </tr></thead><tbody>`;
    Object.keys(d.reportGroupSummary).sort(sortGC).forEach(gc=>{
      const s=d.reportGroupSummary[gc];
      h+=`<tr><td style="color:#000"><strong>${gc}</strong></td><td style="color:#000">${productNameMap[gc]||gc}</td>
        <td style="text-align:center;color:#000">${s.qty} çµ„</td><td style="text-align:right;color:#000">$${s.amount.toLocaleString()}</td></tr>`;
    });
    h+=`<tr style="background:#fef3c7;font-weight:bold"><td colspan="2" style="color:#92400e">ç¸½è¨ˆ</td>
      <td style="text-align:center;color:#92400e">${d.totalReportQty} çµ„</td>
      <td style="text-align:right;color:#92400e">$${d.totalReportAmount.toLocaleString()}</td></tr>
      </tbody></table></div>`;
  });
  c.innerHTML=h||'<div class="team-container"><p style="text-align:center;color:#999">æš«ç„¡æ¶è³¼è³‡æ–™</p></div>';
}
function displayReportDetail(){
  const sel=document.getElementById('reportDetailTeamFilter').value;
  const c=document.getElementById('reportDetailContent');
  const teams=sel==='all'?sortTeams(Object.keys(teamAnalysisData)):[sel];
  let h='';
  teams.forEach(team=>{
    const d=teamAnalysisData[team];
    if(!d||Object.keys(d.reports).length===0)return;
    h+=`<div class="team-container"><div class="team-header">ğŸ¢ ${team} - æ¶è³¼è©³ç´°æ¸…å–®</div>`;
    for(const [buyer,groups] of Object.entries(d.reports)){
      h+=`<div class="person-block"><div class="person-name">ğŸ‘¤ ${buyer}</div>
        <table class="person-table"><thead><tr>
          <th style="color:#000">çµ„åˆ¥</th><th style="color:#000">è²·/é€</th>
          <th style="text-align:center;color:#000">æ•¸é‡</th>
          <th style="text-align:right;color:#000">å–®åƒ¹</th>
          <th style="text-align:right;color:#000">é‡‘é¡</th>
        </tr></thead><tbody>`;
      let bT={qty:0,amount:0};
      Object.keys(groups).sort(sortGC).forEach(gc=>{
        const g=groups[gc];
        h+=`<tr><td style="color:#000">${gc}</td><td style="color:#000">${g.buySend}</td>
          <td style="text-align:center;color:#000">${g.qty}</td>
          <td style="text-align:right;color:#000">$${g.price.toLocaleString()}</td>
          <td style="text-align:right;color:#000">$${g.amount.toLocaleString()}</td></tr>`;
        bT.qty+=g.qty;bT.amount+=g.amount;
      });
      h+=`<tr class="total-row"><td colspan="2" style="color:#92400e"><strong>ç¸½è¨ˆ</strong></td>
        <td style="text-align:center;color:#92400e"><strong>${bT.qty}</strong></td><td></td>
        <td style="text-align:right;color:#92400e"><strong>$${bT.amount.toLocaleString()}</strong></td>
        </tr></tbody></table></div>`;
    }
    h+='</div>';
  });
  c.innerHTML=h||'<div class="team-container"><p style="text-align:center;color:#999">æš«ç„¡æ¶è³¼è³‡æ–™</p></div>';
}

/* ===== æœå°‹ ===== */
function performSearch(){
  const kw=document.getElementById('searchInput').value.trim().toLowerCase();
  const rd=document.getElementById('searchResults');
  const dd=document.getElementById('searchDetailContent');
  if(!kw){rd.style.display='none';dd.innerHTML='';return;}
  const matched=Array.from(allPeople).filter(n=>n.toLowerCase().includes(kw));
  if(matched.length===0){
    rd.innerHTML='<div class="search-result-item">æ‰¾ä¸åˆ°ç¬¦åˆçš„äººå“¡</div>';
    rd.style.display='block';dd.innerHTML='';return;
  }
  rd.innerHTML=matched.map(p=>`<div class="search-result-item" onclick="showPersonDetail('${p}')">${p}</div>`).join('');
  rd.style.display='block';
}
function showPersonDetail(personName){
  const dd=document.getElementById('searchDetailContent');
  document.getElementById('searchResults').style.display='none';
  let h=`<div class="team-container"><div class="team-header">ğŸ‘¤ ${personName} - å€‹äººè©³ç´°æ¸…å–®</div>`;
  let foundO=false,foundR=false;
  for(const [team,data] of Object.entries(teamAnalysisData)){
    if(data.orders[personName]){
      foundO=true;
      const groups=data.orders[personName];
      h+=`<div class="section-title">ğŸ“¦ è¨‚è³¼æ¸…å–®ï¼ˆåœ˜éšŠï¼š${team}ï¼‰</div>
        <table class="person-table"><thead><tr>
          <th style="color:#000">çµ„åˆ¥</th><th style="color:#000">ç”¢å“åç¨±</th>
          <th style="text-align:center;color:#000">æ•¸é‡</th>
          <th style="text-align:right;color:#000">å–®åƒ¹</th>
          <th style="text-align:right;color:#000">é‡‘é¡</th>
        </tr></thead><tbody>`;
      let pT={qty:0,amount:0};
      Object.keys(groups).sort(sortGC).forEach(gc=>{
        const g=groups[gc];
        h+=`<tr><td style="color:#000">${gc}</td><td style="color:#000">${g.productName}</td>
          <td style="text-align:center;color:#000">${g.qty}</td>
          <td style="text-align:right;color:#000">$${g.price.toLocaleString()}</td>
          <td style="text-align:right;color:#000">$${g.amount.toLocaleString()}</td></tr>`;
        pT.qty+=g.qty;pT.amount+=g.amount;
      });
      h+=`<tr class="total-row"><td colspan="2" style="color:#92400e"><strong>è¨‚è³¼ç¸½è¨ˆ</strong></td>
        <td style="text-align:center;color:#92400e"><strong>${pT.qty}</strong></td><td></td>
        <td style="text-align:right;color:#92400e"><strong>$${pT.amount.toLocaleString()}</strong></td>
        </tr></tbody></table>`;
    }
    if(data.reports[personName]){
      foundR=true;
      const groups=data.reports[personName];
      h+=`<div class="section-title">ğŸ¯ æ¶è³¼æ¸…å–®ï¼ˆåœ˜éšŠï¼š${team}ï¼‰</div>
        <table class="person-table"><thead><tr>
          <th style="color:#000">çµ„åˆ¥</th><th style="color:#000">è²·/é€</th>
          <th style="text-align:center;color:#000">æ•¸é‡</th>
          <th style="text-align:right;color:#000">å–®åƒ¹</th>
          <th style="text-align:right;color:#000">é‡‘é¡</th>
        </tr></thead><tbody>`;
      let bT={qty:0,amount:0};
      Object.keys(groups).sort(sortGC).forEach(gc=>{
        const g=groups[gc];
        h+=`<tr><td style="color:#000">${gc}</td><td style="color:#000">${g.buySend}</td>
          <td style="text-align:center;color:#000">${g.qty}</td>
          <td style="text-align:right;color:#000">$${g.price.toLocaleString()}</td>
          <td style="text-align:right;color:#000">$${g.amount.toLocaleString()}</td></tr>`;
        bT.qty+=g.qty;bT.amount+=g.amount;
      });
      h+=`<tr class="total-row"><td colspan="2" style="color:#92400e"><strong>æ¶è³¼ç¸½è¨ˆ</strong></td>
        <td style="text-align:center;color:#92400e"><strong>${bT.qty}</strong></td><td></td>
        <td style="text-align:right;color:#92400e"><strong>$${bT.amount.toLocaleString()}</strong></td>
        </tr></tbody></table>`;
    }
  }
  if(!foundO&&!foundR)h+='<p style="text-align:center;color:#999;padding:20px">æŸ¥ç„¡æ­¤äººå“¡çš„è¨‚è³¼æˆ–æ¶è³¼è³‡æ–™</p>';
  h+='</div>';
  dd.innerHTML=h;
}

/* ===== è‡ªè¨‚å ±è¡¨ ===== */
function initCustomReport(){
  document.getElementById('customSearchInput').value='';
  document.getElementById('customCandidateList').style.display='none';
  renderSelectedTags();
}
function selectMode(mode){
  customMode=mode;
  selectedTargets=[];
  document.getElementById('modePersonBtn').classList.toggle('selected',mode==='person');
  document.getElementById('modeTeamBtn').classList.toggle('selected',mode==='team');
  document.getElementById('customSearchInput').value='';
  document.getElementById('customSearchInput').placeholder=
    mode==='person'?'è¼¸å…¥å§“åé—œéµå­—æœå°‹...':'è¼¸å…¥åœ˜éšŠåç¨±é—œéµå­—æœå°‹...';
  document.getElementById('customCandidateList').style.display='none';
  renderSelectedTags();
  document.getElementById('customReportOutput').style.display='none';
}
function toggleCol(el,id){
  if(el.classList.contains('required'))return;
  const cb=document.getElementById(id);
  cb.checked=!cb.checked;
}
function onCustomSearch(){
  const kw=document.getElementById('customSearchInput').value.trim().toLowerCase();
  const list=document.getElementById('customCandidateList');
  if(!kw){list.style.display='none';return;}
  let candidates=[];
  if(customMode==='person'){
    candidates=Array.from(allPeople)
      .filter(n=>n.toLowerCase().includes(kw)&&!selectedTargets.includes(n))
      .map(n=>{
        let team='';
        for(const [t,data] of Object.entries(teamAnalysisData)){
          if(data.orders[n]||data.reports[n]){team=t;break;}
        }
        return {label:n,tag:team||'æœªåˆ†é…'};
      });
  } else {
    candidates=sortTeams(Object.keys(teamAnalysisData))
      .filter(t=>t.toLowerCase().includes(kw)&&!selectedTargets.includes(t))
      .map(t=>{
        const memberCount=Object.keys(teamAnalysisData[t].orders).length;
        return {label:t,tag:`${memberCount}ä½æˆå“¡`};
      });
  }
  if(candidates.length===0){
    list.innerHTML='<div class="custom-candidate-item" style="color:#9ca3af">æ‰¾ä¸åˆ°ç¬¦åˆçš„å°è±¡</div>';
  } else {
    list.innerHTML=candidates.map(c=>`
      <div class="custom-candidate-item" onclick="selectTarget('${c.label}')">
        <span style="flex:1;font-weight:600">${c.label}</span>
        <span class="ci-tag">${c.tag}</span>
      </div>`).join('');
  }
  list.style.display='block';
}
function selectTarget(label){
  if(!selectedTargets.includes(label))selectedTargets.push(label);
  document.getElementById('customSearchInput').value='';
  document.getElementById('customCandidateList').style.display='none';
  renderSelectedTags();
}
function removeTarget(label){
  selectedTargets=selectedTargets.filter(t=>t!==label);
  renderSelectedTags();
}
function renderSelectedTags(){
  const wrap=document.getElementById('selectedTargets');
  if(selectedTargets.length===0){
    wrap.innerHTML=`<span class="no-selection-hint">å°šæœªé¸æ“‡å°è±¡ï¼Œè«‹è¼¸å…¥é—œéµå­—æœå°‹</span>`;
    return;
  }
  wrap.innerHTML=selectedTargets.map(t=>`
    <span class="selected-tag">
      ${customMode==='person'?'ğŸ‘¤':'ğŸ¢'} ${t}
      <span class="remove-tag" onclick="removeTarget('${t}')">âœ•</span>
    </span>`).join('');
}
document.addEventListener('click',e=>{
  if(!e.target.closest('.custom-search-wrap'))
    document.getElementById('customCandidateList').style.display='none';
});

/* ===== ç”¢ç”Ÿè‡ªè¨‚å ±è¡¨ ===== */
function generateCustomReport(){
  if(selectedTargets.length===0){alert('è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å€‹å°è±¡');return;}
  const showName   =document.getElementById('col_name').checked;
  const showPrice  =document.getElementById('col_price').checked;
  const showPV     =document.getElementById('col_pv').checked;
  const showAmount =document.getElementById('col_amount').checked;
  const showPVTotal=document.getElementById('col_pvtotal').checked;

  // æ¬„ä½å®šç¾©
  const cols=[];
  cols.push({key:'code',  label:'ç”¢å“ä»£è™Ÿ'});
  if(showName)   cols.push({key:'name',    label:'ç”¢å“åç¨±'});
  if(showPrice)  cols.push({key:'price',   label:'å–®åƒ¹',       num:true});
  if(showPV)     cols.push({key:'pv',      label:'PVæ•¸',       center:true});
  cols.push(     {key:'qty',     label:'è¨‚è³¼æ•¸é‡',   center:true});
  if(showAmount) cols.push({key:'amount',  label:'åˆè¨ˆé‡‘é¡',   num:true});
  if(showPVTotal)cols.push({key:'pvtotal', label:'åˆè¨ˆPV',     center:true});
  cols.push(     {key:'grandtotal',label:'ç¸½è¨ˆé‡‘é¡', num:true});
  const colCount=cols.length;

  const now=new Date();
  const dateStr=`${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
  const modeLabel=customMode==='person'?'å€‹äºº':'åœ˜éšŠï¼ˆå±•é–‹æˆå“¡ï¼‰';
  document.getElementById('reportTitle').textContent=`ğŸ“„ è‡ªè¨‚è¨‚è³¼å–®å ±è¡¨ï¼ˆ${modeLabel}ï¼‰`;
  document.getElementById('reportMeta').textContent=
    `å°è±¡ï¼š${selectedTargets.join('ã€')}ã€€|ã€€ç”¢ç”Ÿæ™‚é–“ï¼š${dateStr}ã€€|ã€€æ¬„ä½ï¼š${cols.map(c=>c.label).join('ã€')}`;

  let h=`<table class="custom-report-table"><thead><tr>`;
  cols.forEach(c=>{
    const align=c.num?'right':c.center?'center':'left';
    h+=`<th style="text-align:${align}">${c.label}</th>`;
  });
  h+='</tr></thead><tbody>';

  if(customMode==='person'){
    h+=buildPersonRows(selectedTargets,cols,colCount);
  } else {
    h+=buildTeamRows(selectedTargets,cols,colCount);
  }

  h+='</tbody></table>';
  document.getElementById('customReportTableWrap').innerHTML=h;
  document.getElementById('customReportOutput').style.display='block';
  document.getElementById('customReportOutput').scrollIntoView({behavior:'smooth',block:'start'});
}

/* ===== å€‹äººæ¨¡å¼ ===== */
function buildPersonRows(persons,cols,colCount){
  let h='';
  let grandQty=0,grandAmount=0,grandPV=0;
  persons.forEach(person=>{
    let personOrders={},personTeam='';
    for(const [team,data] of Object.entries(teamAnalysisData)){
      if(data.orders[person]){personOrders=data.orders[person];personTeam=team;break;}
    }
    h+=`<tr class="section-header-row"><td colspan="${colCount}">
      ğŸ‘¤ ${person}ã€€<span style="font-size:0.85em;opacity:0.85">ï¼ˆåœ˜éšŠï¼š${personTeam||'æœªåˆ†é…'}ï¼‰</span>
    </td></tr>`;
    if(Object.keys(personOrders).length===0){
      h+=`<tr><td colspan="${colCount}" style="text-align:center;color:#9ca3af;padding:12px">æ­¤äººå“¡ç„¡è¨‚è³¼è³‡æ–™</td></tr>`;
      return;
    }
    let subQty=0,subAmount=0,subPV=0;
    Object.keys(personOrders).sort(sortGC).forEach(gc=>{
      const g=personOrders[gc];
      const pvUnit=productPVMap[gc]||g.pv||0;
      const pvTotal=pvUnit*g.qty;
      h+='<tr>';
      cols.forEach(c=>{
        let val='';
        if(c.key==='code')       val=`<strong>${gc}</strong>`;
        else if(c.key==='name')  val=g.productName;
        else if(c.key==='price') val=`$${g.price.toLocaleString()}`;
        else if(c.key==='pv')    val=pvUnit;
        else if(c.key==='qty')   val=g.qty;
        else if(c.key==='amount')val=`$${g.amount.toLocaleString()}`;
        else if(c.key==='pvtotal')val=pvTotal;
        else if(c.key==='grandtotal')val='';
        const align=c.num?'right':c.center?'center':'left';
        h+=`<td style="text-align:${align}">${val}</td>`;
      });
      h+='</tr>';
      subQty+=g.qty;subAmount+=g.amount;subPV+=pvTotal;
    });
    // å€‹äººå°è¨ˆ
    h+='<tr class="subtotal-row">';
    cols.forEach(c=>{
      let val='';
      if(c.key==='code')         val='å°è¨ˆ';
      else if(c.key==='qty')     val=subQty;
      else if(c.key==='amount')  val=`$${subAmount.toLocaleString()}`;
      else if(c.key==='pvtotal') val=subPV;
      else if(c.key==='grandtotal')val=`$${subAmount.toLocaleString()}`;
      const align=c.num?'right':c.center?'center':'left';
      h+=`<td style="text-align:${align}">${val}</td>`;
    });
    h+='</tr>';
    grandQty+=subQty;grandAmount+=subAmount;grandPV+=subPV;
  });
  // å¤šäººç¸½è¨ˆ
  if(persons.length>1){
    h+='<tr class="grand-total-row">';
    cols.forEach(c=>{
      let val='';
      if(c.key==='code')         val='â˜… ç¸½è¨ˆ';
      else if(c.key==='qty')     val=grandQty;
      else if(c.key==='amount')  val=`$${grandAmount.toLocaleString()}`;
      else if(c.key==='pvtotal') val=grandPV;
      else if(c.key==='grandtotal')val=`$${grandAmount.toLocaleString()}`;
      const align=c.num?'right':c.center?'center':'left';
      h+=`<td style="text-align:${align}"><strong>${val}</strong></td>`;
    });
    h+='</tr>';
  }
  return h;
}

/* ===== åœ˜éšŠæ¨¡å¼ï¼ˆå±•é–‹æˆå“¡ï¼‰ ===== */
function buildTeamRows(teams,cols,colCount){
  let h='';
  let grandQty=0,grandAmount=0,grandPV=0;

  teams.forEach(team=>{
    const data=teamAnalysisData[team];
    if(!data)return;
    const members=Object.keys(data.orders);
    const memberCount=members.length;

    // â”€â”€ åœ˜éšŠæ¨™é¡Œåˆ— â”€â”€
    h+=`<tr class="team-header-row"><td colspan="${colCount}">
      ğŸ¢ ${team}ã€€<span style="font-size:0.85em;opacity:0.85">ï¼ˆå…± ${memberCount} ä½æˆå“¡ï¼‰</span>
    </td></tr>`;

    if(memberCount===0){
      h+=`<tr><td colspan="${colCount}" style="text-align:center;color:#9ca3af;padding:12px">æ­¤åœ˜éšŠç„¡è¨‚è³¼è³‡æ–™</td></tr>`;
      return;
    }

    let teamQty=0,teamAmount=0,teamPV=0;

    // â”€â”€ é€ä¸€å±•é–‹æ¯ä½æˆå“¡ â”€â”€
    members.forEach(person=>{
      const groups=data.orders[person];
      if(!groups||Object.keys(groups).length===0)return;

      // æˆå“¡æ¨™é¡Œåˆ—
      h+=`<tr class="member-header-row"><td colspan="${colCount}">
        ã€€ğŸ‘¤ ${person}
      </td></tr>`;

      let personQty=0,personAmount=0,personPV=0;

      Object.keys(groups).sort(sortGC).forEach(gc=>{
        const g=groups[gc];
        const pvUnit=productPVMap[gc]||g.pv||0;
        const pvTotal=pvUnit*g.qty;
        h+='<tr>';
        cols.forEach(c=>{
          let val='';
          if(c.key==='code')        val=`<strong>${gc}</strong>`;
          else if(c.key==='name')   val=g.productName;
          else if(c.key==='price')  val=`$${g.price.toLocaleString()}`;
          else if(c.key==='pv')     val=pvUnit;
          else if(c.key==='qty')    val=g.qty;
          else if(c.key==='amount') val=`$${g.amount.toLocaleString()}`;
          else if(c.key==='pvtotal')val=pvTotal;
          else if(c.key==='grandtotal')val='';
          const align=c.num?'right':c.center?'center':'left';
          // æˆå“¡è³‡æ–™åˆ—ç¸®æ’
          const indent=c.key==='code'?'padding-left:24px;':'';
          h+=`<td style="text-align:${align};${indent}">${val}</td>`;
        });
        h+='</tr>';
        personQty+=g.qty;personAmount+=g.amount;personPV+=pvTotal;
      });

      // æˆå“¡å°è¨ˆåˆ—
      h+='<tr class="person-subtotal-row">';
      cols.forEach(c=>{
        let val='';
        if(c.key==='code')          val='ã€€å°è¨ˆ';
        else if(c.key==='qty')      val=personQty;
        else if(c.key==='amount')   val=`$${personAmount.toLocaleString()}`;
        else if(c.key==='pvtotal')  val=personPV;
        else if(c.key==='grandtotal')val=`$${personAmount.toLocaleString()}`;
        const align=c.num?'right':c.center?'center':'left';
        h+=`<td style="text-align:${align}">${val}</td>`;
      });
      h+='</tr>';

      teamQty+=personQty;teamAmount+=personAmount;teamPV+=personPV;
    });

    // â”€â”€ åœ˜éšŠå°è¨ˆåˆ— â”€â”€
    h+='<tr class="team-subtotal-row">';
    cols.forEach(c=>{
      let val='';
      if(c.key==='code')          val=`ğŸ¢ ${team} å°è¨ˆ`;
      else if(c.key==='qty')      val=teamQty;
      else if(c.key==='amount')   val=`$${teamAmount.toLocaleString()}`;
      else if(c.key==='pvtotal')  val=teamPV;
      else if(c.key==='grandtotal')val=`$${teamAmount.toLocaleString()}`;
      const align=c.num?'right':c.center?'center':'left';
      h+=`<td style="text-align:${align}"><strong>${val}</strong></td>`;
    });
    h+='</tr>';

    grandQty+=teamQty;grandAmount+=teamAmount;grandPV+=teamPV;
  });

  // â”€â”€ å¤šåœ˜éšŠç¸½è¨ˆåˆ— â”€â”€
  if(teams.length>1){
    h+='<tr class="grand-total-row">';
    cols.forEach(c=>{
      let val='';
      if(c.key==='code')          val='â˜… ç¸½è¨ˆ';
      else if(c.key==='qty')      val=grandQty;
      else if(c.key==='amount')   val=`$${grandAmount.toLocaleString()}`;
      else if(c.key==='pvtotal')  val=grandPV;
      else if(c.key==='grandtotal')val=`$${grandAmount.toLocaleString()}`;
      const align=c.num?'right':c.center?'center':'left';
      h+=`<td style="text-align:${align}"><strong>${val}</strong></td>`;
    });
    h+='</tr>';
  }
  return h;
}

/* ===== åˆ—å°è‡ªè¨‚å ±è¡¨ ===== */
function printCustomReport(){
  const title=document.getElementById('reportTitle').textContent;
  const meta=document.getElementById('reportMeta').textContent;
  const tableHTML=document.getElementById('customReportTableWrap').innerHTML;
  const win=window.open('','_blank','width=960,height=700');
  win.document.write(`<!DOCTYPE html><html lang="zh-TW"><head>
    <meta charset="UTF-8"><title>${title}</title>
    <style>
      *{margin:0;padding:0;box-sizing:border-box}
      body{font-family:'Microsoft JhengHei','Arial',sans-serif;padding:20px;color:#000}
      h2{color:#4c1d95;margin-bottom:6px;font-size:1.4em}
      .meta{color:#6b7280;font-size:0.85em;margin-bottom:16px;padding-bottom:10px;border-bottom:2px solid #e9d5ff}
      table{width:100%;border-collapse:collapse;font-size:0.9em}
      thead tr{background:#ede9fe}
      th{padding:10px 8px;text-align:left;font-weight:700;color:#4c1d95;border-bottom:2px solid #8b5cf6;border-right:1px solid #e9d5ff;white-space:nowrap}
      th:last-child{border-right:none}
      td{padding:8px;border-bottom:1px solid #f3f4f6;border-right:1px solid #f3f4f6}
      td:last-child{border-right:none}
      .team-header-row td{background:#4c1d95;color:white;font-weight:700;padding:10px 12px;font-size:1.05em}
      .member-header-row td{background:#7c3aed;color:white;font-weight:700;padding:8px 12px}
      .section-header-row td{background:#7c3aed;color:white;font-weight:700;padding:9px 12px}
      .person-subtotal-row{background:#f3e8ff;font-weight:700}
      .person-subtotal-row td{color:#6d28d9;border-top:1px solid #c4b5fd}
      .subtotal-row{background:#ede9fe;font-weight:700}
      .subtotal-row td{color:#4c1d95;border-top:1px solid #c4b5fd}
      .team-subtotal-row{background:#ddd6fe;font-weight:700}
      .team-subtotal-row td{color:#4c1d95;border-top:2px solid #8b5cf6;padding:10px}
      .grand-total-row{background:#fef3c7;font-weight:700}
      .grand-total-row td{color:#92400e;border-top:2px solid #f59e0b;padding:10px 8px}
      @page{margin:1.5cm}
      @media print{
        -webkit-print-color-adjust:exact;print-color-adjust:exact;
        .team-header-row td,.member-header-row td,.section-header-row td{-webkit-print-color-adjust:exact}
      }
    </style></head><body>
    <h2>${title}</h2>
    <div class="meta">${meta}</div>
    ${tableHTML}
    <script>window.onload=function(){window.print();}<\/script>
  </body></html>`);
  win.document.close();
}

/* ===== åˆå§‹åŒ– ===== */
window.addEventListener('DOMContentLoaded',()=>{
  autoConnectAndAnalyze();
  setInterval(()=>autoConnectAndAnalyze(true),30000);
});
</script>
</body>
</html>
