
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æœƒå“¡å°ˆå€ - ä¸‰éµå”æœƒ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    body { font-family:Arial,sans-serif; margin:0; background:linear-gradient(135deg,#667eea,#764ba2); color:#333; min-height:100vh; }
    header { background:rgba(255,255,255,.95); padding:1rem 1.5rem; display:flex; justify-content:space-between; flex-wrap:wrap; align-items:center; box-shadow:0 4px 15px rgba(0,0,0,.1); }
    h1 { margin:0; font-size:1.5rem; color:#667eea; }
    .btn { padding:8px 16px; border:none; border-radius:24px; cursor:pointer; font-weight:bold; background:#667eea; color:#fff; }
    .btn-outline { background:transparent; border:2px solid #667eea; color:#667eea; }
    .btn-danger { background:#e74c3c; }
    .btn:hover { opacity:.9; }
    .container { max-width:1200px; margin:20px auto; padding:0 20px; }
    .section { background:rgba(255,255,255,.95); padding:1.7rem; border-radius:18px; box-shadow:0 6px 22px -5px rgba(0,0,0,.15); margin-bottom:2rem; }
    .section h2 { margin-top:0; font-size:1.2rem; color:#4b56d6; }
    .events-grid { display:grid; gap:18px; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); }
    .event-card { background:#f9f9ff; border:1px solid #dfe3fa; padding:1.1rem; border-radius:14px; position:relative; display:flex; flex-direction:column; }
    .event-card h3 { margin:6px 0 4px; font-size:1.05rem; color:#333; }
    .meta { font-size:.75rem; color:#666; line-height:1.4; }
    .fee { font-weight:bold; color:#e74c3c; margin-top:4px; }
    .actions { margin-top:auto; display:flex; gap:8px; flex-wrap:wrap; }
    .registration-card { border-left:4px solid #667eea; background:#eef2ff; padding:1rem 1.2rem; border-radius:12px; margin-bottom:14px; }
    .status-tag { display:inline-block; padding:4px 10px; border-radius:16px; background:#d4edda; color:#155724; font-size:.65rem; font-weight:bold; letter-spacing:.5px; }
    .empty { text-align:center; padding:1.5rem; color:#666; font-style:italic; }
    .loading { text-align:center; padding:1.5rem; font-size:.85rem; color:#555; }
    .spinner { width:34px; height:34px; border:4px solid #eee; border-top:4px solid #667eea; border-radius:50%; margin:0 auto 10px; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    @media (max-width:600px){ .events-grid { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>ğŸŠâ€â™‚ï¸ğŸš´â€â™‚ï¸ğŸƒâ€â™‚ï¸ æœƒå“¡å°ˆå€</h1>
    <div style="display:flex; gap:10px; align-items:center;">
      <span id="welcome" style="font-size:.85rem; font-weight:bold; color:#333;"></span>
      <a href="index.html" class="btn btn-outline">é¦–é </a>
      <button class="btn btn-danger" onclick="logout()">ç™»å‡º</button>
    </div>
  </header>
  <div class="container">
    <div class="section">
      <h2>ğŸ¯ å¯å ±åæ´»å‹•</h2>
      <div id="eventsLoading" class="loading" style="display:none;">
        <div class="spinner"></div>è¼‰å…¥æ´»å‹•ä¸­...
      </div>
      <div id="eventsGrid" class="events-grid"></div>
    </div>
    <div class="section">
      <h2>ğŸ“‹ æˆ‘çš„å ±å</h2>
      <div id="regsLoading" class="loading" style="display:none;">
        <div class="spinner"></div>è¼‰å…¥å ±åä¸­...
      </div>
      <div id="registrationsContainer"></div>
    </div>
  </div>
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxf3ZQ-egGXbxH8ujY6YUOj3kSY5kraOTzTy14qeXTW8Vc_bUt4Wmyd7u56EGoffdU/exec'; // <-- æ›¿æ›
    let member = null;
    let token = null;

    document.addEventListener('DOMContentLoaded', init);

    async function init() {
      const m = localStorage.getItem('memberInfo');
      token = localStorage.getItem('sessionToken');
      if (!m || !token) {
        alert('è«‹å…ˆç™»å…¥'); location.href='index.html'; return;
      }
      member = JSON.parse(m);
      document.getElementById('welcome').textContent = `æ­¡è¿ï¼Œ${member.name}`;
      const ok = await verifySession();
      if (!ok) { alert('æœƒè©±å¤±æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥'); logout(); return; }
      loadEvents();
      loadMyRegistrations();
    }
    async function verifySession() {
      try {
        const res = await fetch(API_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'checkSession', sessionToken:token})});
        const j = await res.json(); return j.success;
      } catch { return false; }
    }
    async function loadEvents() {
      const grid = document.getElementById('eventsGrid');
      const loading = document.getElementById('eventsLoading');
      grid.innerHTML=''; loading.style.display='block';
      try {
        const res = await fetch(API_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'getEvents'})});
        const j = await res.json();
        if (!j.success) { grid.innerHTML = `<div class="empty" style="color:#c00;">è¼‰å…¥å¤±æ•—</div>`; return; }
        const events = j.events.filter(e => e.status === 'é–‹æ”¾å ±å');
        if (!events.length) { grid.innerHTML = `<div class="empty">ç›®å‰ç„¡é–‹æ”¾æ´»å‹•</div>`; return; }
        events.forEach(ev => {
          const filled = Number(ev.currentParticipants)||0;
          const max = Number(ev.maxParticipants)||0;
          const isFull = filled >= max;
          const card = document.createElement('div');
          card.className='event-card';
          card.innerHTML = `
            <h3>${ev.name}</h3>
            <div class="meta">ğŸ“… ${ev.date} â° ${ev.time}</div>
            <div class="meta">ğŸ“ ${ev.location}</div>
            <div class="meta">ğŸ‘¥ ${filled}/${max}</div>
            <div class="fee">ğŸ’° NT$ ${ev.fee}</div>
            <div class="actions">
              <button class="btn" style="flex:1; ${isFull?'background:#888;cursor:not-allowed;':''}"
                ${isFull?'disabled':''}
                onclick="registerEvent('${ev.id}')">${isFull?'åé¡å·²æ»¿':'ç«‹å³å ±å'}</button>
            </div>`;
          grid.appendChild(card);
        });
      } catch(err) {
        grid.innerHTML = `<div class="empty" style="color:#c00;">éŒ¯èª¤ï¼š${err}</div>`;
      } finally {
        loading.style.display='none';
      }
    }
    async function registerEvent(eventId) {
      if (!confirm('ç¢ºå®šè¦å ±åæ­¤æ´»å‹•ï¼Ÿ')) return;
      try {
        const res = await fetch(API_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'registerEvent', memberId:member.id, eventId})});
        const j = await res.json();
        alert(j.message);
        if (j.success) { loadEvents(); loadMyRegistrations(); }
      } catch(err) {
        alert('éŒ¯èª¤ï¼š'+err);
      }
    }
    async function loadMyRegistrations() {
      const box = document.getElementById('registrationsContainer');
      const loading = document.getElementById('regsLoading');
      box.innerHTML=''; loading.style.display='block';
      try {
        const res = await fetch(API_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'getUserRegistrations', memberId:member.id})});
        const j = await res.json();
        if (!j.success) { box.innerHTML=`<div class="empty" style="color:#c00;">è¼‰å…¥å¤±æ•—</div>`; return; }
        if (!j.registrations.length) { box.innerHTML=`<div class="empty">å°šç„¡å ±å</div>`; return; }
        j.registrations.forEach(r => {
          const div = document.createElement('div');
          div.className='registration-card';
          div.innerHTML = `
            <div class="status-tag">å·²å ±å</div>
            <h3 style="margin:6px 0 4px;">${r.eventName}</h3>
            <div class="meta">ğŸ“… ${r.eventDate} â° ${r.eventTime}</div>
            <div class="meta">ğŸ“ ${r.location}</div>
            <div class="meta">ğŸ“ å ±åæ—¥æœŸï¼š${r.registrationDate.substring(0,10)}</div>
            <div class="fee">ğŸ’° NT$ ${r.fee}</div>
            <div style="margin-top:8px;">
              <button class="btn btn-danger" onclick="cancelReg('${r.registrationId}')">å–æ¶ˆå ±å</button>
            </div>
          `;
          box.appendChild(div);
        });
      } catch(err) {
        box.innerHTML=`<div class="empty" style="color:#c00;">éŒ¯èª¤ï¼š${err}</div>`;
      } finally {
        loading.style.display='none';
      }
    }
    async function cancelReg(registrationId) {
      if (!confirm('ç¢ºå®šè¦å–æ¶ˆï¼Ÿ')) return;
      try {
        const res = await fetch(API_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'cancelRegistration', registrationId})});
        const j = await res.json();
        alert(j.message);
        if (j.success) { loadEvents(); loadMyRegistrations(); }
      } catch(err) { alert('éŒ¯èª¤ï¼š'+err); }
    }
    function logout() {
      if (confirm('ç¢ºå®šç™»å‡ºï¼Ÿ')) {
        localStorage.removeItem('memberInfo');
        localStorage.removeItem('sessionToken');
        location.href='index.html';
      }
    }
  </script>
</body>
</html>
