<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="腦帕金森病友會管理系統">
  <meta name="theme-color" content="#4285f4">
  <title>腦帕金森病友會管理系統</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icon-192x192.png">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  
  <!-- QR Code Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  
  <!-- Google Apps Script Web App URL -->
  <script>
    // 請將此處改為您的 Google Apps Script Web App URL
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzaGNgd_VbbYkxDXLR1zYcnYNSLUmdfHKqZ-XCwehAYqfkf5M448zMN_PSX_fpJLGl8/exec';
    const VAPID_PUBLIC_KEY = 'YOUR_VAPID_PUBLIC_KEY_HERE'; // Base64URL 公鑰
  </script>
  
  <style>
    /* ==================== CSS Variables ==================== */
    :root {
      --primary-color: #4285f4;
      --secondary-color: #34a853;
      --danger-color: #ea4335;
      --warning-color: #fbbc04;
      --dark-color: #202124;
      --light-color: #f8f9fa;
      --border-color: #dadce0;
      --text-color: #202124;
      --text-secondary: #5f6368;
      --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.2);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --bg-body: var(--light-color);
      --bg-card: #fff;
    }
    .dark-theme {
      --bg-body: #121212;
      --bg-card: #1e1e1e;
      --text-color: #e4e4e4;
      --text-secondary: #b0b0b0;
      --border-color: #333;
      --shadow: 0 1px 3px rgba(0,0,0,0.6), 0 1px 2px rgba(0,0,0,0.8);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.7);
    }
    /* ==================== Reset & Base ==================== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-color);
      background: var(--bg-body);
      line-height: 1.6;
      overflow-x: hidden;
    }
    a { text-decoration: none; color: inherit; }
    button { border: none; background: none; cursor: pointer; font-family: inherit; }
    input, textarea, select { font-family: inherit; font-size: inherit; }
    /* ==================== Loading Overlay ==================== */
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: none; justify-content: center; align-items: center; z-index: 9999;
    }
    .dark-theme .loading-overlay { background: rgba(0,0,0,0.7); color: #fff; }
    .loading-overlay.active { display: flex; }
    .loading-spinner { text-align: center; }
    .spinner {
      width: 50px; height: 50px; border: 4px solid var(--border-color);
      border-top-color: var(--primary-color);
      border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* ==================== Navigation ==================== */
    .navbar { background: var(--bg-card); box-shadow: var(--shadow); position: sticky; top: 0; z-index: 1000; }
    .navbar-container { max-width: 1200px; margin: 0 auto; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    .navbar-brand { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem; }
    .navbar-menu { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
    .nav-link { color: var(--text-color); transition: var(--transition); padding: 0.5rem 0.75rem; border-radius: 8px; }
    .nav-link:hover { background: var(--light-color); color: var(--primary-color); }
    .dark-theme .nav-link:hover { background: #2a2a2a; }
    .nav-link.active { background: var(--primary-color); color: white; }
    .user-menu { position: relative; }
    .user-avatar {
      width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); color: white;
      display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; transition: var(--transition);
    }
    .user-avatar:hover { transform: scale(1.05); }
    .dropdown-menu {
      position: absolute; right: 0; top: 48px; background: var(--bg-card); border: 1px solid var(--border-color);
      border-radius: 8px; box-shadow: var(--shadow); min-width: 180px; overflow: hidden; display: none;
    }
    .dropdown-menu a { display: block; padding: 0.75rem 1rem; color: var(--text-color); }
    .dropdown-menu a:hover { background: var(--light-color); }
    .dark-theme .dropdown-menu a:hover { background: #2a2a2a; }
    .notification-icon { position: relative; cursor: pointer; color: var(--text-color); }
    /* ==================== Buttons ==================== */
    .btn { padding: 0.6rem 1.1rem; border-radius: 8px; font-weight: 500; transition: var(--transition); display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; border: none; }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-primary:hover { background: #3367d6; transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn-secondary { background: var(--secondary-color); color: white; }
    .btn-secondary:hover { background: #2d8e47; }
    .btn-danger { background: var(--danger-color); color: white; }
    .btn-danger:hover { background: #d33b2c; }
    .btn-sm { padding: 0.4rem 0.7rem; font-size: 0.9rem; }
    .btn-lg { padding: 0.8rem 1.3rem; font-size: 1rem; }
    .btn-block { width: 100%; justify-content: center; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    /* ==================== Forms ==================== */
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 500; color: var(--text-color); }
    .form-control { width: 100%; padding: 0.6rem 0.7rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: var(--transition); background: var(--bg-card); color: var(--text-color); }
    .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1); }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
    /* ==================== Cards ==================== */
    .card { background: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow); padding: 1.2rem; transition: var(--transition); }
    .card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }
    .card-header { border-bottom: 1px solid var(--border-color); padding-bottom: 0.8rem; margin-bottom: 1rem; }
    .card-title { font-size: 1.15rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
    /* ==================== Grid Layouts ==================== */
    .grid { display: grid; gap: 1.5rem; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    /* ==================== KPI Cards ==================== */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .kpi-card { background: var(--bg-card); border-radius: 12px; padding: 1.2rem; box-shadow: var(--shadow); display: flex; gap: 0.9rem; transition: var(--transition); }
    .kpi-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .kpi-icon { width: 52px; height: 52px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; color: white; flex-shrink: 0; }
    .kpi-content h3 { font-size: 1.6rem; font-weight: bold; margin-bottom: 0.2rem; }
    .kpi-content p { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.4rem; }
    .kpi-trend { display: flex; align-items: center; gap: 0.25rem; font-size: 0.85rem; font-weight: 500; }
    .kpi-trend.positive { color: var(--secondary-color); }
    .kpi-trend.negative { color: var(--danger-color); }
    /* ==================== Activity Cards ==================== */
    .activity-card { background: var(--bg-card); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; display: flex; flex-direction: column; }
    .activity-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .activity-image { width: 100%; height: 180px; object-fit: cover; position: relative; display:flex; align-items:center; justify-content:center; color:#fff; font-size:48px; }
    .activity-content { padding: 1rem; display:flex; flex-direction:column; gap:0.6rem; }
    .activity-category { display: inline-block; padding: 0.2rem 0.6rem; background: var(--primary-color); color: white; border-radius: 20px; font-size: 0.8rem; }
    .activity-title { font-size: 1.1rem; font-weight: 600; }
    .activity-meta { display: grid; grid-template-columns: 1fr; gap: 0.35rem; color: var(--text-secondary); font-size: 0.9rem; }
    .activity-meta span { display: flex; align-items: center; gap: 0.5rem; }
    .progress-bar { width: 100%; height: 8px; background: var(--light-color); border-radius: 4px; overflow: hidden; }
    .dark-theme .progress-bar { background: #2a2a2a; }
    .progress-fill { height: 100%; background: var(--primary-color); transition: width 0.3s ease; }
    .activity-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 0.6rem; border-top: 1px solid var(--border-color); }
    .status-badge { padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
    .status-badge.active { background: #e8f5e9; color: var(--secondary-color); }
    .status-badge.inactive { background: #ececec; color: #666; }
    .status-badge.full { background: #fff3e0; color: var(--warning-color); }
    .status-badge.closed { background: #ffebee; color: var(--danger-color); }
    .status-badge.upcoming { background: #e3f2fd; color: var(--primary-color); }
    .status-badge.ongoing { background: #e8f5e9; color: var(--secondary-color); }
    .status-badge.completed { background: #ececec; color: #666; }
    .status-badge.cancelled { background: #ffebee; color: var(--danger-color); }
    /* ==================== Modal ==================== */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 1rem; }
    .modal.active { display: flex; }
    .modal-content { background: var(--bg-card); border-radius: 12px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; animation: modalSlideIn 0.3s ease; border: 1px solid var(--border-color); }
    @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
    .close-modal { position: absolute; top: 1rem; right: 1rem; width: 32px; height: 32px; border-radius: 50%; background: var(--light-color); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); z-index: 1; }
    .close-modal:hover { background: var(--border-color); }
    .modal-header { padding: 1.4rem; border-bottom: 1px solid var(--border-color); }
    .modal-body { padding: 1.2rem 1.4rem; }
    .modal-footer { padding: 1rem 1.4rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.6rem; }
    /* ==================== Tables ==================== */
    .table-container { overflow-x: auto; background: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow); }
    table { width: 100%; border-collapse: collapse; }
    thead { background: var(--light-color); }
    .dark-theme thead { background: #2a2a2a; }
    th { padding: 0.9rem; text-align: left; font-weight: 600; color: var(--text-color); border-bottom: 2px solid var(--border-color); }
    td { padding: 0.9rem; border-bottom: 1px solid var(--border-color); }
    tr:hover { background: var(--light-color); }
    .dark-theme tr:hover { background: #1b1b1b; }
    /* ==================== Chat Widget ==================== */
    .chat-container { position: fixed; bottom: 80px; right: 20px; width: 350px; height: 500px; background: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow-lg); display: none; flex-direction: column; z-index: 1500; animation: slideUp 0.3s ease; border: 1px solid var(--border-color); }
    .chat-container.active { display: flex; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .chat-header { padding: 0.8rem 1rem; background: var(--primary-color); color: white; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 0.8rem; display: flex; flex-direction: column; gap: 0.6rem; }
    .chat-message { display: flex; gap: 0.5rem; max-width: 80%; }
    .chat-message.own { align-self: flex-end; flex-direction: row-reverse; }
    .chat-message-avatar { width: 28px; height: 28px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; flex-shrink: 0; }
    .chat-message-content { flex: 1; }
    .chat-message-header { display: flex; gap: 0.4rem; margin-bottom: 0.2rem; font-size: 0.8rem; }
    .chat-message-name { font-weight: 600; }
    .chat-message-time { color: var(--text-secondary); }
    .chat-message-text { background: var(--light-color); padding: 0.55rem 0.7rem; border-radius: 10px; word-wrap: break-word; }
    .dark-theme .chat-message-text { background: #2a2a2a; color: #eaeaea; }
    .chat-message.own .chat-message-text { background: var(--primary-color); color: white; }
    .chat-input-container { padding: 0.7rem; border-top: 1px solid var(--border-color); display: flex; gap: 0.5rem; }
    .chat-input-container textarea { flex: 1; border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; resize: none; font-family: inherit; background: var(--bg-card); color: var(--text-color); }
    .chat-toggle-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: var(--shadow-lg); cursor: pointer; transition: var(--transition); z-index: 1400; }
    .chat-toggle-btn:hover { transform: scale(1.05); }
    .chat-badge { position: absolute; top: -5px; right: -5px; min-width: 20px; height: 20px; border-radius: 10px; background: var(--danger-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; padding: 0 5px; }
    /* ==================== Notifications ==================== */
    .notification-badge { position: absolute; top: -5px; right: -5px; min-width: 20px; height: 20px; border-radius: 10px; background: var(--danger-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; padding: 0 5px; }
    .notification-dropdown { position: absolute; right: 0; top: 36px; width: 360px; max-height: 60vh; overflow-y: auto; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: var(--shadow-lg); z-index: 1600; }
    .notification-dropdown-header, .notification-dropdown-footer { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .notification-dropdown-footer { border-top: 1px solid var(--border-color); border-bottom: none; }
    .notification-dropdown-body { max-height: 50vh; overflow-y: auto; }
    .notification-item { padding: 0.8rem; border-bottom: 1px solid var(--border-color); display: flex; gap: 0.8rem; cursor: pointer; transition: var(--transition); }
    .notification-item:hover { background: var(--light-color); }
    .dark-theme .notification-item:hover { background: #1b1b1b; }
    .notification-item.unread { background: #e8f0fe; }
    .dark-theme .notification-item.unread { background: #232c3d; }
    .notification-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0; }
    /* ==================== Toast ==================== */
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-card); padding: 0.8rem 1.2rem; border-radius: 8px; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 0.7rem; z-index: 3000; transition: var(--transition); opacity: 0; border: 1px solid var(--border-color); }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast-success { border-left: 4px solid var(--secondary-color); }
    .toast-error { border-left: 4px solid var(--danger-color); }
    .toast-warning { border-left: 4px solid var(--warning-color); }
    .toast-info { border-left: 4px solid var(--primary-color); }
    /* ==================== Batch Toolbar ==================== */
    .batch-toolbar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-card); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding: 0.8rem 1.2rem; transform: translateY(100%); transition: var(--transition); z-index: 1300; border-top: 1px solid var(--border-color); }
    .batch-toolbar.active { transform: translateY(0); }
    .batch-toolbar-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .batch-actions { display: flex; gap: 0.5rem; }
    /* ==================== Charts ==================== */
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 1.2rem; margin-bottom: 1.5rem; }
    .chart-card { background: var(--bg-card); border-radius: 12px; padding: 1rem; box-shadow: var(--shadow); }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; padding-bottom: 0.6rem; border-bottom: 1px solid var(--border-color); }
    .chart-container { height: 280px; position: relative; }
    /* ==================== QR Scanner ==================== */
    .qr-scanner-container { position: relative; width: 100%; background: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow-lg); }
    .scanner-video-container { position: relative; width: 100%; height: 360px; background: black; border-radius: 8px; overflow: hidden; }
    #qrVideo { width: 100%; height: 100%; object-fit: cover; }
    .scanner-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
    .scanner-frame { width: 240px; height: 240px; border: 3px solid var(--primary-color); border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); }
    /* ==================== Responsive ==================== */
    @media (max-width: 768px) {
      .navbar-menu { gap: 0.5rem; }
      .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
      .charts-grid { grid-template-columns: 1fr; }
      .chat-container { width: 100%; height: 100%; bottom: 0; right: 0; border-radius: 0; }
      .modal-content { max-width: 100%; max-height: 100vh; border-radius: 0; }
    }
    /* ==================== Utilities ==================== */
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mt-3 { margin-top: 1.5rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }
    .mb-3 { margin-bottom: 1.5rem; }
    .p-1 { padding: 0.5rem; }
    .p-2 { padding: 1rem; }
    .p-3 { padding: 1.5rem; }
    .hidden { display: none !important; }
    .visible { display: block !important; }
    .container { max-width: 1200px; margin: 0 auto; padding: 1.2rem; }
    .empty-state { text-align: center; padding: 2rem; color: var(--text-secondary); }
    .empty-state i { font-size: 3rem; margin-bottom: 0.8rem; opacity: 0.3; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .section { margin-top: 1.2rem; }
    .section-header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 0.6rem; }
    .profile-cover { height: 120px; border-radius: 12px; display:flex; align-items:center; padding: 0.8rem; }
    .profile-info-header { display:flex; gap: 1rem; align-items: center; margin-top: -30px; }
    .profile-avatar-large { width: 80px; height: 80px; border-radius: 50%; background: var(--primary-color); color: #fff; display:flex; align-items:center; justify-content:center; font-size: 32px; position: relative; }
    .avatar-edit-btn { position:absolute; bottom:-6px; right:-6px; width:28px; height:28px; border-radius:50%; background:#fff; color:#333; display:flex; align-items:center; justify-content:center; border:1px solid var(--border-color); }
    .profile-badges .badge { display:inline-flex; align-items:center; gap:0.4rem; padding: 0.25rem 0.5rem; border-radius: 999px; background:#eef2ff; color:#333; font-size:0.8rem; margin-right: 0.4rem; }
    .badge-success { background: #e7f7ee; }
    .profile-stats { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.8rem; margin-top: 1rem; }
    .stat-card { background: var(--bg-card); border-radius: 12px; padding: 1rem; box-shadow: var(--shadow); display:flex; gap:0.8rem; align-items:center; }
    .stat-icon { width: 44px; height: 44px; border-radius: 10px; color:#fff; display:flex; align-items:center; justify-content:center; font-size: 1.1rem; }
    .profile-tabs { margin-top: 1rem; }
    .tabs-header { display:flex; gap:0.6rem; flex-wrap: wrap; }
    .tab-btn { padding: 0.5rem 0.8rem; border-radius: 8px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-color); }
    .tab-btn.active { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
    .info-section { background: var(--bg-card); border-radius: 12px; padding: 1rem; box-shadow: var(--shadow); }
    .info-section h3 { margin-bottom: 0.6rem; }
    .info-items { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.6rem; }
    .info-item label { color: var(--text-secondary); font-size: 0.85rem; }
    .info-item p { margin-top: 0.2rem; }
    .full-width { grid-column: 1 / -1; }
    .activity-record-item { background: var(--bg-card); border:1px solid var(--border-color); border-radius: 12px; padding: 0.8rem; display:flex; align-items:center; gap:0.8rem; justify-content: space-between; margin-bottom: 0.6rem; }
    .activity-record-icon { width:40px;height:40px;border-radius:8px;color:#fff; display:flex;align-items:center;justify-content:center; }
    .timeline-item { display:flex; gap: 0.8rem; margin-bottom: 0.8rem; }
    .timeline-marker { width:32px; height:32px; border-radius:50%; color:#fff; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .timeline-content { background: var(--bg-card); border:1px solid var(--border-color); border-radius: 12px; padding: 0.8rem; flex:1; }
    .timeline-header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 0.4rem; }
    .timeline-image { width:100%; border-radius: 8px; margin-top: 0.4rem; }
    .search-box-large { display:flex; gap:0.6rem; align-items:center; background: var(--bg-card); border:1px solid var(--border-color); border-radius: 12px; padding: 0.6rem 0.8rem; }
    .search-box-large input { flex:1; border:none; outline:none; background:transparent; color: var(--text-color); }
    .filter-chip { padding: 0.35rem 0.7rem; border-radius: 999px; background: var(--bg-card); border:1px solid var(--border-color); }
    .filter-chip.active { background: var(--primary-color); color:#fff; border-color: var(--primary-color); }
    .search-result-item { display:flex; align-items:center; justify-content: space-between; gap:0.8rem; padding: 0.8rem; border-bottom:1px solid var(--border-color); cursor:pointer; }
    .search-result-icon { width:40px;height:40px;border-radius:8px;color:#fff; display:flex; align-items:center; justify-content:center; }
    mark { background: #fff59d; }
    .rank-badge { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; background: var(--light-color); font-weight: 600; }
    .rank-badge.top-1 { background: #ffd700; color: #000; }
    .rank-badge.top-2 { background: #c0c0c0; color: #000; }
    .rank-badge.top-3 { background: #cd7f32; color: #fff; }
    .rating { display: flex; align-items: center; gap: 0.3rem; }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>載入中...</p>
    </div>
  </div>

  <!-- 導覽列容器 -->
  <div id="navbarMount"></div>

  <!-- Main Container -->
  <div id="app"></div>

  <!-- Chat Widget -->
  <div class="chat-container" id="chatContainer">
    <div class="chat-header">
      <h3><i class="fas fa-comments"></i> 病友交流</h3>
      <button class="btn btn-sm" onclick="toggleChat()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="chat-messages" id="chatMessages">
      <div class="empty-state">
        <i class="fas fa-comments"></i>
        <p>歡迎來到病友交流區</p>
      </div>
    </div>
    
    <div class="chat-input-container">
      <textarea id="chatInput" placeholder="輸入訊息..." rows="1" onkeydown="handleChatKeydown(event)"></textarea>
      <button class="btn btn-primary" onclick="sendChatMessage()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
  
  <button class="chat-toggle-btn" onclick="toggleChat()" id="chatToggleBtn">
    <i class="fas fa-comments"></i>
    <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
  </button>

  <!-- Scripts -->
  <script src="utils.js"></script>
// ==================== utils.js - 工具函式 ====================

function pad(n) {
  return n < 10 ? '0' + n : n;
}

function formatDate(date, withWeek = false) {
  try {
    const d = new Date(date);
    if (isNaN(d)) return '';
    const y = d.getFullYear();
    const m = pad(d.getMonth() + 1);
    const day = pad(d.getDate());
    const str = y + '/' + m + '/' + day;
    if (!withWeek) return str;
    const week = ['日', '一', '二', '三', '四', '五', '六'][d.getDay()];
    return str + '（週' + week + '）';
  } catch (e) {
    return '';
  }
}

function formatTime(date) {
  try {
    const d = new Date(date);
    if (isNaN(d)) return '';
    return pad(d.getHours()) + ':' + pad(d.getMinutes());
  } catch (e) {
    return '';
  }
}

function formatDateTime(date) {
  try {
    const d = new Date(date);
    if (isNaN(d)) return '';
    return formatDate(d) + ' ' + formatTime(d);
  } catch (e) {
    return '';
  }
}

function formatRelativeTime(date) {
  try {
    const d = new Date(date);
    const now = new Date();
    const diff = (now - d) / 1000;
    if (diff < 60) return '剛剛';
    if (diff < 3600) return Math.floor(diff / 60) + ' 分鐘前';
    if (diff < 86400) return Math.floor(diff / 3600) + ' 小時前';
    return Math.floor(diff / 86400) + ' 天前';
  } catch (e) {
    return '';
  }
}

function calculateAge(date) {
  try {
    const d = new Date(date);
    if (isNaN(d)) return '';
    const now = new Date();
    let age = now.getFullYear() - d.getFullYear();
    const m = now.getMonth() - d.getMonth();
    if (m < 0 || (m === 0 && now.getDate() < d.getDate())) age--;
    return age;
  } catch (e) {
    return '';
  }
}

function truncateText(text, len = 100) {
  if (!text) return '';
  return text.length > len ? text.slice(0, len) + '…' : text;
}

function animateNumber(id, value, suffix = '', fixed = 0) {
  const el = document.getElementById(id);
  if (!el) return;
  const start = parseFloat((el.textContent || '0').replace('%', '')) || 0;
  const end = typeof value === 'number' ? value : parseFloat(value) || 0;
  const diff = end - start;
  const duration = 500;
  const startTime = performance.now();
  
  function step(now) {
    const t = Math.min(1, (now - startTime) / duration);
    const cur = start + diff * t;
    el.textContent = (fixed ? cur.toFixed(fixed) : Math.round(cur)) + suffix;
    if (t < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

function updatePagination(pagination, containerId, onPage) {
  const container = document.getElementById(containerId);
  if (!container || !pagination) return;
  const { page, totalPages } = pagination;
  let html = '';
  const mkBtn = (p, txt, dis = false) => 
    `<button class="btn btn-sm" ${dis ? 'disabled' : ''} onclick="${dis ? '' : `${onPage.name}(${p})`}">${txt}</button>`;
  html += mkBtn(1, '«', page <= 1);
  html += mkBtn(page - 1, '‹', page <= 1);
  html += `<span style="margin:0 0.5rem;">第 ${page} / ${totalPages} 頁</span>`;
  html += mkBtn(page + 1, '›', page >= totalPages);
  html += mkBtn(totalPages, '»', page >= totalPages);
  container.innerHTML = html;
}

function generateStars(score) {
  const s = Math.max(0, Math.min(5, Math.round(score)));
  return '<span style="color:#fbbc04;">' + '★'.repeat(s) + '☆'.repeat(5 - s) + '</span>';
}

function escapeHtml(str = '') {
  return String(str).replace(/[&<>"'`=\/]/g, function(s) {
    return {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;',
      '/': '&#x2F;',
      '`': '&#x60;',
      '=': '&#x3D;'
    }[s] || s;
  });
}

function getRandomGradient() {
  const gradients = [
    '#667eea,#764ba2',
    '#f093fb,#f5576c',
    '#4facfe,#00f2fe',
    '#43e97b,#38f9d7',
    '#fa709a,#fee140'
  ];
  const [a, b] = gradients[Math.floor(Math.random() * gradients.length)].split(',');
  return `${a} 0%, ${b} 100%`;
}

function getActivityIcon(type) {
  const map = {
    '健康講座': 'stethoscope',
    '復健課程': 'dumbbell',
    '社交活動': 'users',
    '志工服務': 'hands-helping',
    '其他': 'calendar'
  };
  return map[type] || 'calendar';
}

function getActivityStatus(activity) {
  const now = new Date();
  const start = new Date(activity['開始時間']);
  const end = new Date(activity['結束時間'] || activity['開始時間']);
  
  if (activity['已取消']) return 'cancelled';
  if (now < start) return 'upcoming';
  if (now >= start && now <= end) return 'ongoing';
  if (activity['已報名人數'] >= activity['人數上限']) return 'full';
  return 'completed';
}

function getActivityStatusText(activity) {
  const status = getActivityStatus(activity);
  const map = {
    upcoming: '即將舉辦',
    ongoing: '進行中',
    completed: '已結束',
    cancelled: '已取消',
    full: '額滿'
  };
  return map[status] || '';
}

function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function getNotificationIcon(type) {
  const icons = {
    activity: 'calendar-check',
    message: 'comment',
    system: 'info-circle',
    reminder: 'bell',
    achievement: 'trophy'
  };
  return icons[type] || 'bell';
}

function getNotificationColor(type) {
  const colors = {
    activity: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    message: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
    system: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
    reminder: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
    achievement: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
  };
  return colors[type] || colors.system;
}

function getActivityTypeColor(type) {
  const colors = {
    '健康講座': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    '復健課程': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
    '社交活動': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
    '志工服務': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
    '其他': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
  };
  return colors[type] || colors['其他'];
}

function getTimelineIcon(type) {
  const icons = {
    activity: 'calendar-check',
    achievement: 'trophy',
    join: 'user-plus',
    update: 'edit',
    comment: 'comment'
  };
  return icons[type] || 'circle';
}

function getTimelineColor(type) {
  const colors = {
    activity: '#667eea',
    achievement: '#f5576c',
    join: '#4facfe',
    update: '#43e97b',
    comment: '#fa709a'
  };
  return colors[type] || '#999';
}

function getToastIcon(type) {
  const icons = {
    success: 'check-circle',
    error: 'exclamation-circle',
    warning: 'exclamation-triangle',
    info: 'info-circle'
  };
  return icons[type] || 'info-circle';
}

// ==================== 權限管理 ====================
const PermissionManager = {
  hasPermission(code) {
    const user = window.currentUser;
    if (!user) return false;
    const role = user.role || 'member';
    const map = {
      view_dashboard: ['admin', 'staff'],
      view_members: ['admin', 'staff'],
      view_reports: ['admin', 'staff'],
      manage_activities: ['admin', 'staff'],
      manage_members: ['admin'],
      manage_system: ['admin']
    };
    if (!map[code]) return true;
    return map[code].includes(role);
  }
};

// ==================== 批次操作 ====================
const BatchOperations = {
  activeTableId: null,
  init(tableId) {
    this.activeTableId = tableId;
    showToast('批次操作模式啟動', 'info');
    const bar = document.getElementById('batchToolbar');
    if (bar) bar.classList.add('active');
  },
  clear() {
    this.activeTableId = null;
    const bar = document.getElementById('batchToolbar');
    if (bar) bar.classList.remove('active');
  }
};


// ==================== api.js - API 通訊層 ====================

// 基本 fetch with timeout
async function fetchWithTimeout(url, options = {}, timeout = 30000) {
  return await Promise.race([
    fetch(url, options),
    new Promise((_, reject) => 
      setTimeout(() => reject(new Error('請求逾時')), timeout)
    )
  ]);
}

// 呼叫後端 API
async function callServerFunction(fnName, payload = {}) {
  try {
    const response = await fetchWithTimeout(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        action: fnName,
        payload: payload
      })
    });

    if (!response.ok) {
      throw new Error('網路錯誤 ' + response.status);
    }

    const result = await response.json();
    return result;
    
  } catch (error) {
    console.error('API 呼叫失敗:', fnName, error);
    throw error;
  }
}

// ==================== 快取管理 ====================
const CacheManager = {
  init() {
    // 初始化快取
  },
  
  key(action, payload) {
    const payloadStr = payload ? JSON.stringify(payload) : '';
    return 'api_' + action + '_' + btoa(unescape(encodeURIComponent(payloadStr))).slice(0, 40);
  },
  
  get(key) {
    try {
      const value = localStorage.getItem(key);
      if (!value) return null;
      
      const obj = JSON.parse(value);
      if (obj.exp && Date.now() > obj.exp) {
        localStorage.removeItem(key);
        return null;
      }
      return obj.data;
    } catch (e) {
      return null;
    }
  },
  
  set(key, data, ttlMin = 5) {
    const exp = Date.now() + ttlMin * 60000;
    localStorage.setItem(key, JSON.stringify({ exp, data }));
  },
  
  clear(prefix) {
    Object.keys(localStorage).forEach(k => {
      if (k.startsWith(prefix)) localStorage.removeItem(k);
    });
  },
  
  clearAll() {
    Object.keys(localStorage).forEach(k => {
      if (k.startsWith('api_')) localStorage.removeItem(k);
    });
  }
};

// 帶快取的 API 呼叫
async function callServerFunctionWithCache(action, payload = {}, ttlMin = 5) {
  const key = CacheManager.key(action, payload);
  const cached = CacheManager.get(key);
  
  if (cached) {
    console.log('使用快取:', action);
    return { success: true, ...cached };
  }
  
  const result = await callServerFunction(action, payload);
  
  if (result && result.success) {
    CacheManager.set(key, result, ttlMin);
  }
  
  return result;
}

// ==================== 離線管理 ====================
const OfflineManager = {
  init() {
    // 監聽離線事件
    window.addEventListener('online', this.handleOnline.bind(this));
    window.addEventListener('offline', this.handleOffline.bind(this));
  },
  
  handleOnline() {
    document.body.classList.remove('offline');
    showToast('網路已連接', 'success');
    this.syncOfflineData();
  },
  
  handleOffline() {
    document.body.classList.add('offline');
    showToast('網路已斷線，部分功能可能無法使用', 'warning');
  },
  
  syncOfflineData() {
    // 同步離線資料
    console.log('同步離線資料...');
  }
};

// ==================== 效能監控 ====================
const PerformanceMonitor = {
  logPageLoad() {
    if (window.performance && window.performance.timing) {
      window.addEventListener('load', () => {
        const timing = window.performance.timing;
        const loadTime = timing.loadEventEnd - timing.navigationStart;
        console.log('頁面載入時間:', loadTime, 'ms');
      });
    }
  }
};

// ==================== Toast 通知 ====================
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.innerHTML = `
    <i class="fas fa-${getToastIcon(type)}"></i>
    <span>${escapeHtml(message)}</span>
  `;
  document.body.appendChild(toast);
  
  setTimeout(() => toast.classList.add('show'), 50);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 2800);
}

// ==================== 推播通知 ====================
async function subscribeToPush() {
  if (!('serviceWorker' in navigator)) {
    showToast('瀏覽器不支援推播', 'warning');
    return;
  }
  
  try {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
    });
    
    const result = await callServerFunction('savePushSubscription', {
      subscription: subscription
    });
    
    if (result.success) {
      localStorage.setItem('pushSubscribed', 'true');
      showToast('推播已開啟', 'success');
      const el = document.getElementById('pushNotificationSetting');
      if (el) el.checked = true;
    }
  } catch (error) {
    console.error('推播訂閱失敗:', error);
    showToast('推播訂閱失敗', 'error');
    throw error;
  }
}

async function unsubscribePush() {
  try {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.getSubscription();
    
    if (subscription) {
      await subscription.unsubscribe();
      await callServerFunction('removePushSubscription', {});
    }
    
    localStorage.setItem('pushSubscribed', 'false');
    showToast('推播已關閉', 'success');
    const el = document.getElementById('pushNotificationSetting');
    if (el) el.checked = false;
  } catch (error) {
    console.error('取消推播失敗:', error);
    showToast('取消推播失敗', 'error');
    throw error;
  }
}

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

// ==================== 活動管理 ====================
function createActivitiesPage() {
  return `
    <div class="container">
      <div class="page-header">
        <h1><i class="fas fa-calendar-alt"></i> 活動管理</h1>
        ${PermissionManager.hasPermission('manage_activities') ? `
          <button class="btn btn-primary" onclick="showCreateActivityModal()">
            <i class="fas fa-plus"></i> 新增活動
          </button>
        ` : ''}
      </div>

      <div class="card mb-2">
        <div class="card-body">
          <div class="form-row">
            <div class="form-group">
              <input type="text" id="activitySearchInput" class="form-control" placeholder="搜尋活動名稱..." oninput="filterActivities()">
            </div>
            <div class="form-group">
              <select id="activityTypeFilter" class="form-control" onchange="filterActivities()">
                <option value="">所有類型</option>
                <option value="健康講座">健康講座</option>
                <option value="復健課程">復健課程</option>
                <option value="社交活動">社交活動</option>
                <option value="志工服務">志工服務</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="form-group">
              <select id="activityStatusFilter" class="form-control" onchange="filterActivities()">
                <option value="">所有狀態</option>
                <option value="upcoming">即將舉辦</option>
                <option value="ongoing">進行中</option>
                <option value="completed">已結束</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-3" id="activitiesList">
        <div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>載入中...</p></div>
      </div>
    </div>

    <!-- 新增/編輯活動 Modal -->
    <div class="modal" id="activityModal">
      <div class="modal-content">
        <button class="close-modal" onclick="closeModal('activityModal')">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h2 id="activityModalTitle">新增活動</h2>
        </div>
        <div class="modal-body">
          <form id="activityForm" onsubmit="handleSaveActivity(event)">
            <input type="hidden" id="activityId">
            <div class="form-group">
              <label>活動名稱 *</label>
              <input type="text" id="activityName" class="form-control" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>活動類型 *</label>
                <select id="activityType" class="form-control" required>
                  <option value="">請選擇</option>
                  <option value="健康講座">健康講座</option>
                  <option value="復健課程">復健課程</option>
                  <option value="社交活動">社交活動</option>
                  <option value="志工服務">志工服務</option>
                  <option value="其他">其他</option>
                </select>
              </div>
              <div class="form-group">
                <label>人數上限 *</label>
                <input type="number" id="activityMaxParticipants" class="form-control" min="1" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>開始時間 *</label>
                <input type="datetime-local" id="activityStartTime" class="form-control" required>
              </div>
              <div class="form-group">
                <label>結束時間 *</label>
                <input type="datetime-local" id="activityEndTime" class="form-control" required>
              </div>
            </div>
            <div class="form-group">
              <label>活動地點 *</label>
              <input type="text" id="activityLocation" class="form-control" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>負責人</label>
                <input type="text" id="activityOrganizer" class="form-control">
              </div>
              <div class="form-group">
                <label>聯絡電話</label>
                <input type="tel" id="activityContactPhone" class="form-control">
              </div>
            </div>
            <div class="form-group">
              <label>活動說明</label>
              <textarea id="activityDescription" class="form-control" rows="4"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('activityModal')">取消</button>
          <button class="btn btn-primary" onclick="document.getElementById('activityForm').requestSubmit()">
            <i class="fas fa-save"></i> 儲存
          </button>
        </div>
      </div>
    </div>
  `;
}

let allActivities = [];

async function loadActivities() {
  try {
    const result = await callServerFunction('getActivities', {});
    
    if (result.success) {
      allActivities = result.activities;
      displayActivities(allActivities);
    } else {
      showToast('載入活動失敗', 'error');
    }
  } catch (e) {
    console.error('載入活動失敗:', e);
    showToast('載入活動失敗', 'error');
  }
}

function filterActivities() {
  const searchText = document.getElementById('activitySearchInput').value.toLowerCase();
  const typeFilter = document.getElementById('activityTypeFilter').value;
  const statusFilter = document.getElementById('activityStatusFilter').value;

  const filtered = allActivities.filter(a => {
    const matchSearch = !searchText || a['活動名稱'].toLowerCase().includes(searchText);
    const matchType = !typeFilter || a['活動類型'] === typeFilter;
    const matchStatus = !statusFilter || getActivityStatus(a) === statusFilter;
    return matchSearch && matchType && matchStatus;
  });

  displayActivities(filtered);
}

function displayActivities(activities) {
  const container = document.getElementById('activitiesList');
  
  if (!activities || activities.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-calendar"></i>
        <p>目前沒有活動</p>
      </div>
    `;
    return;
  }

  container.innerHTML = activities.map(a => `
    <div class="activity-card" onclick="navigateTo('activity-detail', {id: '${a['活動ID']}'})">
      <div class="activity-image" style="background: ${getActivityTypeColor(a['活動類型'])};">
        <i class="fas fa-${getActivityIcon(a['活動類型'])}"></i>
      </div>
      <div class="activity-content">
        <span class="activity-category">${escapeHtml(a['活動類型'])}</span>
        <h3 class="activity-title">${escapeHtml(a['活動名稱'])}</h3>
        <div class="activity-meta">
          <span><i class="fas fa-calendar"></i> ${formatDate(a['開始時間'])}</span>
          <span><i class="fas fa-clock"></i> ${formatTime(a['開始時間'])}</span>
          <span><i class="fas fa-map-marker-alt"></i> ${escapeHtml(a['活動地點'])}</span>
          <span><i class="fas fa-users"></i> ${a['已報名人數']}/${a['人數上限']}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width:${Math.min(100, (a['已報名人數'] / a['人數上限'] * 100))}%"></div>
        </div>
        <div class="activity-footer">
          <span class="status-badge ${getActivityStatus(a)}">${getActivityStatusText(a)}</span>
          ${PermissionManager.hasPermission('manage_activities') ? `
            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); editActivity('${a['活動ID']}')">
              <i class="fas fa-edit"></i>
            </button>
          ` : ''}
        </div>
      </div>
    </div>
  `).join('');
}

function showCreateActivityModal() {
  document.getElementById('activityModalTitle').textContent = '新增活動';
  document.getElementById('activityForm').reset();
  document.getElementById('activityId').value = '';
  openModal('activityModal');
}

function editActivity(activityId) {
  const activity = allActivities.find(a => a['活動ID'] === activityId);
  if (!activity) return;

  document.getElementById('activityModalTitle').textContent = '編輯活動';
  document.getElementById('activityId').value = activityId;
  document.getElementById('activityName').value = activity['活動名稱'];
  document.getElementById('activityType').value = activity['活動類型'];
  document.getElementById('activityMaxParticipants').value = activity['人數上限'];
  document.getElementById('activityStartTime').value = activity['開始時間'].replace(' ', 'T');
  document.getElementById('activityEndTime').value = activity['結束時間'].replace(' ', 'T');
  document.getElementById('activityLocation').value = activity['活動地點'];
  document.getElementById('activityOrganizer').value = activity['負責人'] || '';
  document.getElementById('activityContactPhone').value = activity['聯絡電話'] || '';
  document.getElementById('activityDescription').value = activity['活動說明'] || '';
  
  openModal('activityModal');
}

async function handleSaveActivity(event) {
  event.preventDefault();

  const activityId = document.getElementById('activityId').value;
  const data = {
    name: document.getElementById('activityName').value,
    type: document.getElementById('activityType').value,
    maxParticipants: parseInt(document.getElementById('activityMaxParticipants').value),
    startTime: document.getElementById('activityStartTime').value.replace('T', ' '),
    endTime: document.getElementById('activityEndTime').value.replace('T', ' '),
    location: document.getElementById('activityLocation').value,
    organizer: document.getElementById('activityOrganizer').value,
    contactPhone: document.getElementById('activityContactPhone').value,
    description: document.getElementById('activityDescription').value
  };

  document.getElementById('loadingOverlay').classList.add('active');

  try {
    const action = activityId ? 'updateActivity' : 'createActivity';
    if (activityId) data.activityId = activityId;

    const result = await callServerFunction(action, data);
    document.getElementById('loadingOverlay').classList.remove('active');

    if (result.success) {
      showToast(activityId ? '活動已更新' : '活動已新增', 'success');
      closeModal('activityModal');
      CacheManager.clear('api_getActivities');
      loadActivities();
    } else {
      showToast('儲存失敗：' + result.error, 'error');
    }
  } catch (e) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + e.message, 'error');
  }
}

// ==================== 活動詳情 ====================
function createActivityDetailPage(activityId) {
  return `
    <div class="container">
      <div class="page-header">
        <button class="btn btn-secondary" onclick="history.back()">
          <i class="fas fa-arrow-left"></i> 返回
        </button>
      </div>

      <div id="activityDetailContent">
        <div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>載入中...</p></div>
      </div>
    </div>
  `;
}

async function loadActivityDetail(activityId) {
  try {
    const result = await callServerFunction('getActivityDetail', { activityId });
    
    if (result.success) {
      displayActivityDetail(result.activity);
    } else {
      showToast('載入活動詳情失敗', 'error');
    }
  } catch (e) {
    console.error('載入活動詳情失敗:', e);
    showToast('載入活動詳情失敗', 'error');
  }
}

function displayActivityDetail(activity) {
  const container = document.getElementById('activityDetailContent');
  const status = getActivityStatus(activity);
  const canRegister = status === 'upcoming' && activity['已報名人數'] < activity['人數上限'];

  container.innerHTML = `
    <div class="card">
      <div style="height:240px; background:${getActivityTypeColor(activity['活動類型'])}; border-radius:12px 12px 0 0; display:flex; align-items:center; justify-content:center; color:#fff; font-size:64px;">
        <i class="fas fa-${getActivityIcon(activity['活動類型'])}"></i>
      </div>
      <div class="card-body">
        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:1rem;">
          <div>
            <span class="activity-category">${escapeHtml(activity['活動類型'])}</span>
            <h1 style="margin:0.5rem 0;">${escapeHtml(activity['活動名稱'])}</h1>
            <span class="status-badge ${status}">${getActivityStatusText(activity)}</span>
          </div>
          ${canRegister ? `
            <button class="btn btn-primary btn-lg" onclick="registerForActivity('${activity['活動ID']}')">
              <i class="fas fa-user-plus"></i> 立即報名
            </button>
          ` : ''}
        </div>

        <div class="grid grid-2" style="margin-top:1.5rem;">
          <div class="info-section">
            <h3><i class="fas fa-info-circle"></i> 活動資訊</h3>
            <div class="info-items">
              <div class="info-item">
                <label><i class="fas fa-calendar"></i> 開始時間</label>
                <p>${formatDateTime(activity['開始時間'])}</p>
              </div>
              <div class="info-item">
                <label><i class="fas fa-calendar"></i> 結束時間</label>
                <p>${formatDateTime(activity['結束時間'])}</p>
              </div>
              <div class="info-item">
                <label><i class="fas fa-map-marker-alt"></i> 活動地點</label>
                <p>${escapeHtml(activity['活動地點'])}</p>
              </div>
              <div class="info-item">
                <label><i class="fas fa-users"></i> 報名人數</label>
                <p>${activity['已報名人數']} / ${activity['人數上限']}</p>
                <div class="progress-bar">
                  <div class="progress-fill" style="width:${Math.min(100, (activity['已報名人數'] / activity['人數上限'] * 100))}%"></div>
                </div>
              </div>
              ${activity['負責人'] ? `
                <div class="info-item">
                  <label><i class="fas fa-user"></i> 負責人</label>
                  <p>${escapeHtml(activity['負責人'])}</p>
                </div>
              ` : ''}
              ${activity['聯絡電話'] ? `
                <div class="info-item">
                  <label><i class="fas fa-phone"></i> 聯絡電話</label>
                  <p>${escapeHtml(activity['聯絡電話'])}</p>
                </div>
              ` : ''}
            </div>
          </div>

          <div class="info-section">
            <h3><i class="fas fa-align-left"></i> 活動說明</h3>
            <p>${escapeHtml(activity['活動說明'] || '無說明')}</p>
          </div>
        </div>

        ${PermissionManager.hasPermission('manage_activities') ? `
          <div style="margin-top:1.5rem; padding-top:1rem; border-top:1px solid var(--border-color); display:flex; gap:0.5rem;">
            <button class="btn btn-secondary" onclick="editActivity('${activity['活動ID']}')">
              <i class="fas fa-edit"></i> 編輯
            </button>
            <button class="btn btn-danger" onclick="deleteActivity('${activity['活動ID']}')">
              <i class="fas fa-trash"></i> 刪除
            </button>
            <button class="btn btn-primary" onclick="showQRCode('${activity['活動ID']}')">
              <i class="fas fa-qrcode"></i> 顯示 QR Code
            </button>
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

async function registerForActivity(activityId) {
  if (!confirm('確定要報名此活動嗎？')) return;

  document.getElementById('loadingOverlay').classList.add('active');

  try {
    const result = await callServerFunction('registerActivity', {
      activityId,
      memberId: currentUser.id,
      memberName: currentUser.name
    });

    document.getElementById('loadingOverlay').classList.remove('active');

    if (result.success) {
      showToast('報名成功！', 'success');
      CacheManager.clear('api_getActivityDetail');
      CacheManager.clear('api_getHomeStats');
      loadActivityDetail(activityId);
    } else {
      showToast('報名失敗：' + result.error, 'error');
    }
  } catch (e) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + e.message, 'error');
  }
}

async function deleteActivity(activityId) {
  if (!confirm('確定要刪除此活動嗎？此操作無法復原。')) return;

  document.getElementById('loadingOverlay').classList.add('active');

  try {
    const result = await callServerFunction('deleteActivity', { activityId });
    document.getElementById('loadingOverlay').classList.remove('active');

    if (result.success) {
      showToast('活動已刪除', 'success');
      CacheManager.clear('api_getActivities');
      navigateTo('activities');
    } else {
      showToast('刪除失敗：' + result.error, 'error');
    }
  } catch (e) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + e.message, 'error');
  }
}

function showQRCode(activityId) {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:400px;">
      <button class="close-modal" onclick="this.closest('.modal').remove()">
        <i class="fas fa-times"></i>
      </button>
      <div class="modal-header">
        <h2>活動 QR Code</h2>
      </div>
      <div class="modal-body text-center">
        <div id="qrcode-${activityId}" style="display:inline-block;"></div>
        <p style="margin-top:1rem;">請掃描此 QR Code 進行簽到</p>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  // 生成 QR Code
  new QRCode(document.getElementById(`qrcode-${activityId}`), {
    text: activityId,
    width: 256,
    height: 256
  });
}

// ==================== Modal 控制 ====================
function openModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) modal.classList.add('active');
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) modal.classList.remove('active');
}

// 點擊 modal 外部關閉
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal')) {
    e.target.classList.remove('active');
  }
});


// ==================== 會員管理 ====================
function createMembersPage() {
  return `
    <div class="container">
      <div class="page-header">
        <h1><i class="fas fa-users"></i> 會員管理</h1>
        ${PermissionManager.hasPermission('manage_members') ? `
          <button class="btn btn-primary" onclick="showCreateMemberModal()">
            <i class="fas fa-user-plus"></i> 新增會員
          </button>
        ` : ''}
      </div>

      <div class="card mb-2">
        <div class="card-body">
          <div class="form-row">
            <div class="form-group">
              <input type="text" id="memberSearchInput" class="form-control" placeholder="搜尋姓名、電話、電子郵件..." oninput="filterMembers()">
            </div>
            <div class="form-group">
              <select id="memberStatusFilter" class="form-control" onchange="filterMembers()">
                <option value="">所有狀態</option>
                <option value="active">啟用</option>
                <option value="inactive">停用</option>
              </select>
            </div>
            <div class="form-group">
              <button class="btn btn-secondary" onclick="exportMembers()">
                <i class="fas fa-download"></i> 匯出
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>會員編號</th>
              <th>姓名</th>
              <th>性別</th>
              <th>年齡</th>
              <th>電話</th>
              <th>電子郵件</th>
              <th>加入日期</th>
              <th>狀態</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="membersTableBody">
            <tr>
              <td colspan="9" class="text-center">
                <i class="fas fa-spinner fa-spin"></i> 載入中...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="membersPagination" class="text-center mt-2"></div>
    </div>

    <!-- 新增/編輯會員 Modal -->
    <div class="modal" id="memberModal">
      <div class="modal-content">
        <button class="close-modal" onclick="closeModal('memberModal')">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h2 id="memberModalTitle">新增會員</h2>
        </div>
        <div class="modal-body">
          <form id="memberForm" onsubmit="handleSaveMember(event)">
            <input type="hidden" id="memberId">
            <div class="form-row">
              <div class="form-group">
                <label>姓名 *</label>
                <input type="text" id="memberName" class="form-control" required>
              </div>
              <div class="form-group">
                <label>性別 *</label>
                <select id="memberGender" class="form-control" required>
                  <option value="">請選擇</option>
                  <option value="男">男</option>
                  <option value="女">女</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>出生日期 *</label>
              <input type="date" id="memberBirthDate" class="form-control" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>電話 *</label>
                <input type="tel" id="memberPhone" class="form-control" required>
              </div>
              <div class="form-group">
                <label>電子郵件 *</label>
                <input type="email" id="memberEmail" class="form-control" required>
              </div>
            </div>
            <div class="form-group">
              <label>地址</label>
              <input type="text" id="memberAddress" class="form-control">
            </div>
            <div class="form-group">
              <label>緊急聯絡人</label>
              <input type="text" id="memberEmergencyContact" class="form-control">
            </div>
            <div class="form-group">
              <label>緊急聯絡電話</label>
              <input type="tel" id="memberEmergencyPhone" class="form-control">
            </div>
            <div class="form-group">
              <label>備註</label>
              <textarea id="memberNotes" class="form-control" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('memberModal')">取消</button>
          <button class="btn btn-primary" onclick="document.getElementById('memberForm').requestSubmit()">
            <i class="fas fa-save"></i> 儲存
          </button>
        </div>
      </div>
    </div>
  `;
}

let allMembers = [];
let currentMembersPage = 1;
const membersPerPage = 20;

async function loadMembers(page = 1) {
  currentMembersPage = page;
  
  try {
    const result = await callServerFunction('getMembers', {
      page,
      limit: membersPerPage
    });
    
    if (result.success) {
      allMembers = result.members;
      displayMembers(allMembers);
      
      if (result.pagination) {
        updatePagination(result.pagination, 'membersPagination', loadMembers);
      }
    } else {
      showToast('載入會員失敗', 'error');
    }
  } catch (e) {
    console.error('載入會員失敗:', e);
    showToast('載入會員失敗', 'error');
  }
}

function filterMembers() {
  const searchText = document.getElementById('memberSearchInput').value.toLowerCase();
  const statusFilter = document.getElementById('memberStatusFilter').value;

  const filtered = allMembers.filter(m => {
    const matchSearch = !searchText || 
      m['姓名'].toLowerCase().includes(searchText) ||
      (m['電話'] && m['電話'].includes(searchText)) ||
      (m['電子郵件'] && m['電子郵件'].toLowerCase().includes(searchText));
    
    const matchStatus = !statusFilter || 
      (statusFilter === 'active' && m['狀態'] === '啟用') ||
      (statusFilter === 'inactive' && m['狀態'] === '停用');
    
    return matchSearch && matchStatus;
  });

  displayMembers(filtered);
}

function displayMembers(members) {
  const tbody = document.getElementById('membersTableBody');
  
  if (!members || members.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="text-center">
          <div class="empty-state">
            <i class="fas fa-users"></i>
            <p>目前沒有會員資料</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = members.map(m => `
    <tr>
      <td>${escapeHtml(m['會員編號'])}</td>
      <td><strong>${escapeHtml(m['姓名'])}</strong></td>
      <td>${escapeHtml(m['性別'])}</td>
      <td>${calculateAge(m['出生日期'])}歲</td>
      <td>${escapeHtml(m['電話'])}</td>
      <td>${escapeHtml(m['電子郵件'])}</td>
      <td>${formatDate(m['加入日期'])}</td>
      <td>
        <span class="status-badge ${m['狀態'] === '啟用' ? 'active' : 'inactive'}">
          ${escapeHtml(m['狀態'])}
        </span>
      </td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="viewMemberDetail('${m['會員ID']}')">
          <i class="fas fa-eye"></i>
        </button>
        ${PermissionManager.hasPermission('manage_members') ? `
          <button class="btn btn-sm btn-secondary" onclick="editMember('${m['會員ID']}')">
            <i class="fas fa-edit"></i>
          </button>
        ` : ''}
      </td>
    </tr>
  `).join('');
}

function showCreateMemberModal() {
  document.getElementById('memberModalTitle').textContent = '新增會員';
  document.getElementById('memberForm').reset();
  document.getElementById('memberId').value = '';
  openModal('memberModal');
}

function editMember(memberId) {
  const member = allMembers.find(m => m['會員ID'] === memberId);
  if (!member) return;

  document.getElementById('memberModalTitle').textContent = '編輯會員';
  document.getElementById('memberId').value = memberId;
  document.getElementById('memberName').value = member['姓名'];
  document.getElementById('memberGender').value = member['性別'];
  document.getElementById('memberBirthDate').value = member['出生日期'];
  document.getElementById('memberPhone').value = member['電話'];
  document.getElementById('memberEmail').value = member['電子郵件'];
  document.getElementById('memberAddress').value = member['地址'] || '';
  document.getElementById('memberEmergencyContact').value = member['緊急聯絡人'] || '';
  document.getElementById('memberEmergencyPhone').value = member['緊急聯絡電話'] || '';
  document.getElementById('memberNotes').value = member['備註'] || '';
  
  openModal('memberModal');
}

function viewMemberDetail(memberId) {
  navigateTo('profile', { memberId });
}

async function handleSaveMember(event) {
  event.preventDefault();

  const memberId = document.getElementById('memberId').value;
  const data = {
    name: document.getElementById('memberName').value,
    gender: document.getElementById('memberGender').value,
    birthDate: document.getElementById('memberBirthDate').value,
    phone: document.getElementById('memberPhone').value,
    email: document.getElementById('memberEmail').value,
    address: document.getElementById('memberAddress').value,
    emergencyContact: document.getElementById('memberEmergencyContact').value,
    emergencyPhone: document.getElementById('memberEmergencyPhone').value,
    notes: document.getElementById('memberNotes').value
  };

  document.getElementById('loadingOverlay').classList.add('active');

  try {
    const action = memberId ? 'updateMember' : 'createMember';
    if (memberId) data.memberId = memberId;

    const result = await callServerFunction(action, data);
    document.getElementById('loadingOverlay').classList.remove('active');

    if (result.success) {
      showToast(memberId ? '會員資料已更新' : '會員已新增', 'success');
      closeModal('memberModal');
      CacheManager.clear('api_getMembers');
      loadMembers(currentMembersPage);
    } else {
      showToast('儲存失敗：' + result.error, 'error');
    }
  } catch (e) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + e.message, 'error');
  }
}

async function exportMembers() {
  document.getElementById('loadingOverlay').classList.add('active');

  try {
    const result = await callServerFunction('exportMembers', {});
    document.getElementById('loadingOverlay').classList.remove('active');

    if (result.success && result.url) {
      window.open(result.url, '_blank');
      showToast('匯出成功', 'success');
    } else {
      showToast('匯出失敗', 'error');
    }
  } catch (e) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + e.message, 'error');
  }
}

// ==================== 個人資料 ====================
function createProfilePage() {
  return `
    <div class="container">
      <div class="profile-cover" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h1 style="color:#fff;"><i class="fas fa-user-circle"></i> 個人資料</h1>
      </div>

      <div class="profile-info-header">
        <div class="profile-avatar-large">
          ${escapeHtml(currentUser.name.charAt(0))}
          <button class="avatar-edit-btn" onclick="alert('上傳頭像功能開發中')">
            <i class="fas fa-camera"></i>
          </button>
        </div>
        <div style="flex:1;">
          <h2>${escapeHtml(currentUser.name)}</h2>
          <p style="color:var(--text-secondary);">會員編號：${escapeHtml(currentUser.memberId || 'N/A')}</p>
          <div class="profile-badges">
            <span class="badge"><i class="fas fa-check-circle"></i> 已驗證</span>
            <span class="badge badge-success"><i class="fas fa-star"></i> 活躍會員</span>
          </div>
        </div>
        <button class="btn btn-primary" onclick="switchToEditMode()">
          <i class="fas fa-edit"></i> 編輯資料
        </button>
      </div>

      <div class="profile-stats" id="profileStats">
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="fas fa-calendar-check"></i>
          </div>
          <div class="stat-content">
            <h3 id="profileActivitiesCount">-</h3>
            <p>參與活動</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <i class="fas fa-trophy"></i>
          </div>
          <div class="stat-content">
            <h3 id="profilePointsCount">-</h3>
            <p>累積積分</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-content">
            <h3 id="profileDaysCount">-</h3>
            <p>加入天數</p>
          </div>
        </div>
      </div>

      <div class="profile-tabs">
        <div class="tabs-header">
          <button class="tab-btn active" onclick="switchProfileTab('info')">
            <i class="fas fa-info-circle"></i> 基本資料
          </button>
          <button class="tab-btn" onclick="switchProfileTab('activities')">
            <i class="fas fa-calendar"></i> 活動紀錄
          </button>
          <button class="tab-btn" onclick="switchProfileTab('timeline')">
            <i class="fas fa-stream"></i> 動態時間軸
          </button>
        </div>

        <div id="profileTabContent" style="margin-top:1rem;">
          <!-- 內容由 JS 動態載入 -->
        </div>
      </div>
    </div>
  `;
}

async function loadProfileStats() {
  try {
    const result = await callServerFunctionWithCache('getProfileStats', {
      memberId: currentUser.id
    }, 5);

    if (result.success) {
      animateNumber('profileActivitiesCount', result.stats.activitiesCount);
      animateNumber('profilePointsCount', result.stats.points);
      animateNumber('profileDaysCount', result.stats.memberDays);
    }

    // 預設顯示基本資料
    switchProfileTab('info');

  } catch (e) {
    console.error('載入個人統計失敗:', e);
  }
}

function switchProfileTab(tab) {
  // 更新 tab 按鈕狀態
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  event.target.closest('.tab-btn').classList.add('active');

  const content = document.getElementById('profileTabContent');

  switch (tab) {
    case 'info':
      content.innerHTML = createProfileInfoTab();
      loadProfileInfo();
      break;
    case 'activities':
      content.innerHTML = createProfileActivitiesTab();
      loadProfileActivities();
      break;
    case 'timeline':
      content.innerHTML = createProfileTimelineTab();
      loadProfileTimeline();
      break;
  }
}

function createProfileInfoTab() {
  return `
    <div class="info-section">
      <h3><i class="fas fa-user"></i> 個人資訊</h3>
      <div class="info-items" id="profileInfoContent">
        <div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>載入中...</p></div>
      </div>
    </div>
  `;
}

async function loadProfileInfo() {
  try {
    const result = await callServerFunctionWithCache('getMemberProfile', {
      memberId: currentUser.id
    }, 5);

    if (result.success) {
      const profile = result.profile;
      document.getElementById('profileInfoContent').innerHTML = `
        <div class="info-item">
          <label>姓名</label>
          <p>${escapeHtml(profile['姓名'])}</p>
        </div>
        <div class="info-item">
          <label>性別</label>
          <p>${escapeHtml(profile['性別'])}</p>
        </div>
        <div class="info-item">
          <label>出生日期</label>
          <p>${formatDate(profile['出生日期'])} (${calculateAge(profile['出生日期'])}歲)</p>
        </div>
        <div class="info-item">
          <label>電話</label>
          <p>${escapeHtml(profile['電話'])}</p>
        </div>
        <div class="info-item">
          <label>電子郵件</label>
          <p>${escapeHtml(profile['電子郵件'])}</p>
        </div>
        <div class="info-item full-width">
          <label>地址</label>
          <p>${escapeHtml(profile['地址'] || '未填寫')}</p>
        </div>
        <div class="info-item">
          <label>緊急聯絡人</label>
          <p>${escapeHtml(profile['緊急聯絡人'] || '未填寫')}</p>
        </div>
        <div class="info-item">
          <label>緊急聯絡電話</label>
          <p>${escapeHtml(profile['緊急聯絡電話'] || '未填寫')}</p>
        </div>
        <div class="info-item">
          <label>加入日期</label>
          <p>${formatDate(profile['加入日期'])}</p>
        </div>
        <div class="info-item">
          <label>會員狀態</label>
          <p><span class="status-badge ${profile['狀態'] === '啟用' ? 'active' : 'inactive'}">${escapeHtml(profile['狀態'])}</span></p>
        </div>
        ${profile['備註'] ? `
          <div class="info-item full-width">
            <label>備註</label>
            <p>${escapeHtml(profile['備註'])}</p>
          </div>
        ` : ''}
      `;
    }
  } catch (e) {
    console.error('載入個人資料失敗:', e);
  }
}

function createProfileActivitiesTab() {
  return `
    <div id="profileActivitiesContent">
      <div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>載入中...</p></div>
    </div>
  `;
}

async function loadProfileActivities() {
  try {
    const result = await callServerFunctionWithCache('getMemberActivities', {
      memberId: currentUser.id
    }, 5);

    if (result.success && result.activities.length > 0) {
      document.getElementById('profileActivitiesContent').innerHTML = result.activities.map(a => `
        <div class="activity-record-item">
          <div class="activity-record-icon" style="background:${getActivityTypeColor(a['活動類型'])};">
            <i class="fas fa-${getActivityIcon(a['活動類型'])}"></i>
          </div>
          <div style="flex:1;">
            <h4>${escapeHtml(a['活動名稱'])}</h4>
            <p style="color:var(--text-secondary); font-size:0.9rem;">
              <i class="fas fa-calendar"></i> ${formatDate(a['開始時間'])} | 
              <i class="fas fa-map-marker-alt"></i> ${escapeHtml(a['活動地點'])}
            </p>
          </div>
          <span class="status-badge ${a['已簽到'] ? 'active' : 'inactive'}">
            ${a['已簽到'] ? '已簽到' : '未簽到'}
          </span>
        </div>
      `).join('');
    } else {
      document.getElementById('profileActivitiesContent').innerHTML = `
        <div class="empty-state">
          <i class="fas fa-calendar"></i>
          <p>尚無活動紀錄</p>
        </div>
      `;
    }
  } catch (e) {
    console.error('載入活動紀錄失敗:', e);
  }
}

function createProfileTimelineTab() {
  return `
    <div id="profileTimelineContent">
      <div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>載入中...</p></div>
    </div>
  `;
}

async function loadProfileTimeline() {
  try {
    const result = await callServerFunctionWithCache('getMemberTimeline', {
      memberId: currentUser.id
    }, 5);

    if (result.success && result.timeline.length > 0) {
      document.getElementById('profileTimelineContent').innerHTML = result.timeline.map(t => `
        <div class="timeline-item">
          <div class="timeline-marker" style="background:${getTimelineColor(t.type)};">
            <i class="fas fa-${getTimelineIcon(t.type)}"></i>
          </div>
          <div class="timeline-content">
            <div class="timeline-header">
              <strong>${escapeHtml(t.title)}</strong>
              <span style="color:var(--text-secondary); font-size:0.85rem;">${formatRelativeTime(t.timestamp)}</span>
            </div>
            <p>${escapeHtml(t.description)}</p>
            ${t.image ? `<img src="${t.image}" class="timeline-image" alt="">` : ''}
          </div>
        </div>
      `).join('');
    } else {
      document.getElementById('profileTimelineContent').innerHTML = `
        <div class="empty-state">
          <i class="fas fa-stream"></i>
          <p>尚無動態紀錄</p>
        </div>
      `;
    }
  } catch (e) {
    console.error('載入動態時間軸失敗:', e);
  }
}

function switchToEditMode() {
  alert('編輯模式開發中');
}


// ==================== 儀表板 ====================
function createDashboard() {
  return `
    <div class="container">
      <div class="page-header">
        <h1><i class="fas fa-chart-line"></i> 管理儀表板</h1>
        <div>
          <select id="dashboardPeriod" class="form-control" onchange="loadDashboardData()">
            <option value="7">最近 7 天</option>
            <option value="30" selected>最近 30 天</option>
            <option value="90">最近 90 天</option>
            <option value="365">最近一年</option>
          </select>
        </div>
      </div>

      <div class="grid grid-4" id="dashboardStats">
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-content">
            <h3 id="totalMembers">-</h3>
            <p>總會員數</p>
            <span class="stat-change positive" id="membersChange">+0%</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <i class="fas fa-calendar-check"></i>
          </div>
          <div class="stat-content">
            <h3 id="totalActivities">-</h3>
            <p>舉辦活動</p>
            <span class="stat-change positive" id="activitiesChange">+0%</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <i class="fas fa-user-check"></i>
          </div>
          <div class="stat-content">
            <h3 id="totalParticipations">-</h3>
            <p>總參與人次</p>
            <span class="stat-change positive" id="participationsChange">+0%</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <i class="fas fa-percentage"></i>
          </div>
          <div class="stat-content">
            <h3 id="avgAttendanceRate">-</h3>
            <p>平均出席率</p>
            <span class="stat-change positive" id="attendanceChange">+0%</span>
          </div>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="card">
          <div class="card-header">
            <div class="card-title">會員成長趨勢</div>
          </div>
          <div class="card-body">
            <canvas id="memberGrowthChart" height="250"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">活動類型分布</div>
          </div>
          <div class="card-body">
            <canvas id="activityTypeChart" height="250"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">活動參與趨勢</div>
        </div>
        <div class="card-body">
          <canvas id="participationTrendChart" height="300"></canvas>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="card">
          <div class="card-header">
            <div class="card-title">熱門活動 TOP 5</div>
          </div>
          <div class="card-body">
            <div id="topActivitiesList">
              <div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>載入中...</p></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">活躍會員 TOP 5</div>
          </div>
          <div class="card-body">
            <div id="topMembersList">
              <div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>載入中...</p></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

async function loadDashboardData() {
  const period = document.getElementById('dashboardPeriod').value;

  try {
    const result = await callServerFunctionWithCache('getDashboardData', { period }, 10);

    if (result.success) {
      // 更新統計卡片
      updateDashboardStats(result.stats);

      // 繪製圖表
      drawMemberGrowthChart(result.memberGrowth);
      drawActivityTypeChart(result.activityTypes);
      drawParticipationTrendChart(result.participationTrend);

      // 顯示排行榜
      displayTopActivities(result.topActivities);
      displayTopMembers(result.topMembers);
    }
  } catch (e) {
    console.error('載入儀表板資料失敗:', e);
    showToast('載入儀表板資料失敗', 'error');
  }
}

function updateDashboardStats(stats) {
  animateNumber('totalMembers', stats.totalMembers);
  animateNumber('totalActivities', stats.totalActivities);
  animateNumber('totalParticipations', stats.totalParticipations);
  animateNumber('avgAttendanceRate', stats.avgAttendanceRate, '%', 1);

  // 更新變化百分比
  updateStatChange('membersChange', stats.membersChange);
  updateStatChange('activitiesChange', stats.activitiesChange);
  updateStatChange('participationsChange', stats.participationsChange);
  updateStatChange('attendanceChange', stats.attendanceChange);
}

function updateStatChange(id, value) {
  const el = document.getElementById(id);
  if (!el) return;
  
  const isPositive = value >= 0;
  el.className = 'stat-change ' + (isPositive ? 'positive' : 'negative');
  el.innerHTML = `<i class="fas fa-arrow-${isPositive ? 'up' : 'down'}"></i> ${Math.abs(value).toFixed(1)}%`;
}

function drawMemberGrowthChart(data) {
  const ctx = document.getElementById('memberGrowthChart');
  if (!ctx) return;

  if (window.memberGrowthChartInstance) {
    window.memberGrowthChartInstance.destroy();
  }

  window.memberGrowthChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: '會員數',
        data: data.values,
        borderColor: '#667eea',
        backgroundColor: 'rgba(102, 126, 234, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

function drawActivityTypeChart(data) {
  const ctx = document.getElementById('activityTypeChart');
  if (!ctx) return;

  if (window.activityTypeChartInstance) {
    window.activityTypeChartInstance.destroy();
  }

  window.activityTypeChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: data.labels,
      datasets: [{
        data: data.values,
        backgroundColor: [
          '#667eea',
          '#f5576c',
          '#4facfe',
          '#43e97b',
          '#fa709a'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
}

function drawParticipationTrendChart(data) {
  const ctx = document.getElementById('participationTrendChart');
  if (!ctx) return;

  if (window.participationTrendChartInstance) {
    window.participationTrendChartInstance.destroy();
  }

  window.participationTrendChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.labels,
      datasets: [
        {
          label: '報名人數',
          data: data.registrations,
          backgroundColor: 'rgba(102, 126, 234, 0.8)'
        },
        {
          label: '實際出席',
          data: data.attendances,
          backgroundColor: 'rgba(67, 233, 123, 0.8)'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top'
        }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

function displayTopActivities(activities) {
  const container = document.getElementById('topActivitiesList');
  
  if (!activities || activities.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-calendar"></i>
        <p>暫無資料</p>
      </div>
    `;
    return;
  }

  container.innerHTML = activities.map((a, i) => `
    <div class="ranking-item">
      <div class="ranking-number ${i < 3 ? 'top-' + (i + 1) : ''}">${i + 1}</div>
      <div style="flex:1;">
        <strong>${escapeHtml(a['活動名稱'])}</strong>
        <p style="color:var(--text-secondary); font-size:0.85rem; margin:0;">
          ${escapeHtml(a['活動類型'])} | ${formatDate(a['開始時間'])}
        </p>
      </div>
      <div class="ranking-value">
        <strong>${a['參與人數']}</strong> 人
      </div>
    </div>
  `).join('');
}

function displayTopMembers(members) {
  const container = document.getElementById('topMembersList');
  
  if (!members || members.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-users"></i>
        <p>暫無資料</p>
      </div>
    `;
    return;
  }

  container.innerHTML = members.map((m, i) => `
    <div class="ranking-item">
      <div class="ranking-number ${i < 3 ? 'top-' + (i + 1) : ''}">${i + 1}</div>
      <div class="ranking-avatar">${escapeHtml(m['姓名'].charAt(0))}</div>
      <div style="flex:1;">
        <strong>${escapeHtml(m['姓名'])}</strong>
        <p style="color:var(--text-secondary); font-size:0.85rem; margin:0;">
          參與 ${m['參與次數']} 次活動
        </p>
      </div>
      <div class="ranking-value">
        <i class="fas fa-star" style="color:#fbbc04;"></i> ${m['積分']}
      </div>
    </div>
  `).join('');
}

// ==================== 報表管理 ====================
function createReportsPage() {
  return `
    <div class="container">
      <div class="page-header">
        <h1><i class="fas fa-file-alt"></i> 報表管理</h1>
        <button class="btn btn-primary" onclick="showGenerateReportModal()">
          <i class="fas fa-plus"></i> 產生報表
        </button>
      </div>

      <div class="card mb-2">
        <div class="card-body">
          <div class="form-row">
            <div class="form-group">
              <select id="reportTypeFilter" class="form-control" onchange="filterReports()">
                <option value="">所有類型</option>
                <option value="member">會員報表</option>
                <option value="activity">活動報表</option>
                <option value="attendance">出席報表</option>
                <option value="statistics">統計報表</option>
              </select>
            </div>
            <div class="form-group">
              <input type="date" id="reportDateFrom" class="form-control" onchange="filterReports()">
            </div>
            <div class="form-group">
              <input type="date" id="reportDateTo" class="form-control" onchange="filterReports()">
            </div>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>報表名稱</th>
              <th>報表類型</th>
              <th>產生時間</th>
              <th>產生者</th>
              <th>狀態</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="reportsTableBody">
            <tr>
              <td colspan="6" class="text-center">
                <i class="fas fa-spinner fa-spin"></i> 載入中...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="reportsPagination" class="text-center mt-2"></div>
    </div>

    <!-- 產生報表 Modal -->
    <div class="modal" id="generateReportModal">
      <div class="modal-content">
        <button class="close-modal" onclick="closeModal('generateReportModal')">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h2>產生報表</h2>
        </div>
        <div class="modal-body">
          <form id="generateReportForm" onsubmit="handleGenerateReport(event)">
            <div class="form-group">
              <label>報表類型 *</label>
              <select id="reportType" class="form-control" required onchange="updateReportOptions()">
                <option value="">請選擇</option>
                <option value="member">會員報表</option>
                <option value="activity">活動報表</option>
                <option value="attendance">出席報表</option>
                <option value="statistics">統計報表</option>
              </select>
            </div>
            <div class="form-group">
              <label>報表名稱 *</label>
              <input type="text" id="reportName" class="form-control" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>開始日期 *</label>
                <input type="date" id="reportStartDate" class="form-control" required>
              </div>
              <div class="form-group">
                <label>結束日期 *</label>
                <input type="date" id="reportEndDate" class="form-control" required>
              </div>
            </div>
            <div class="form-group" id="reportOptionsContainer">
              <!-- 根據報表類型動態顯示選項 -->
            </div>
            <div class="form-group">
              <label>報表格式 *</label>
              <select id="reportFormat" class="form-control" required>
                <option value="excel">Excel (.xlsx)</option>
                <option value="pdf">PDF (.pdf)</option>
                <option value="csv">CSV (.csv)</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('generateReportModal')">取消</button>
          <button class="btn btn-primary" onclick="document.getElementById('generateReportForm').requestSubmit()">
            <i class="fas fa-file-export"></i> 產生報表
          </button>
        </div>
      </div>
    </div>
  `;
}

let allReports = [];

async function loadReportHistory() {
  try {
    const result = await callServerFunction('getReports', {});
    
    if (result.success) {
      allReports = result.reports;
      displayReports(allReports);
    }
  } catch (e) {
    console.error('載入報表失敗:', e);
    showToast('載入報表失敗', 'error');
  }
}

function filterReports() {
  const typeFilter = document.getElementById('reportTypeFilter').value;
  const dateFrom = document.getElementById('reportDateFrom').value;
  const dateTo = document.getElementById('reportDateTo').value;

  const filtered = allReports.filter(r => {
    const matchType = !typeFilter || r['報表類型'] === typeFilter;
    const matchDateFrom = !dateFrom || new Date(r['產生時間']) >= new Date(dateFrom);
    const matchDateTo = !dateTo || new Date(r['產生時間']) <= new Date(dateTo);
    return matchType && matchDateFrom && matchDateTo;
  });

  displayReports(filtered);
}

function displayReports(reports) {
  const tbody = document.getElementById('reportsTableBody');
  
  if (!reports || reports.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center">
          <div class="empty-state">
            <i class="fas fa-file-alt"></i>
            <p>目前沒有報表</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = reports.map(r => `
    <tr>
      <td><strong>${escapeHtml(r['報表名稱'])}</strong></td>
      <td>${escapeHtml(getReportTypeLabel(r['報表類型']))}</td>
      <td>${formatDateTime(r['產生時間'])}</td>
      <td>${escapeHtml(r['產生者'])}</td>
      <td>
        <span class="status-badge ${r['狀態'] === '完成' ? 'active' : 'inactive'}">
          ${escapeHtml(r['狀態'])}
        </span>
      </td>
      <td>
        ${r['狀態'] === '完成' ? `
          <button class="btn btn-sm btn-primary" onclick="downloadReport('${r['報表ID']}')">
            <i class="fas fa-download"></i> 下載
          </button>
        ` : `
          <button class="btn btn-sm btn-secondary" disabled>
            <i class="fas fa-spinner fa-spin"></i> 處理中
          </button>
        `}
        <button class="btn btn-sm btn-danger" onclick="deleteReport('${r['報表ID']}')">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    </tr>
  `).join('');
}

function getReportTypeLabel(type) {
  const map = {
    member: '會員報表',
    activity: '活動報表',
    attendance: '出席報表',
    statistics: '統計報表'
  };
  return map[type] || type;
}

function showGenerateReportModal() {
  document.getElementById('generateReportForm').reset();
  
  // 設定預設日期範圍（最近30天）
  const today = new Date();
  const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
  document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
  document.getElementById('reportStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
  
  openModal('generateReportModal');
}

function updateReportOptions() {
  const type = document.getElementById('reportType').value;
  const container = document.getElementById('reportOptionsContainer');

  let optionsHtml = '';

  switch (type) {
    case 'member':
      optionsHtml = `
        <label>包含欄位</label>
        <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:0.5rem;">
          <label><input type="checkbox" checked> 基本資料</label>
          <label><input type="checkbox" checked> 聯絡資訊</label>
          <label><input type="checkbox"> 緊急聯絡人</label>
          <label><input type="checkbox"> 參與活動記錄</label>
        </div>
      `;
      break;
    case 'activity':
      optionsHtml = `
        <label>活動類型</label>
        <select class="form-control">
          <option value="">全部</option>
          <option value="健康講座">健康講座</option>
          <option value="復健課程">復健課程</option>
          <option value="社交活動">社交活動</option>
          <option value="志工服務">志工服務</option>
        </select>
      `;
      break;
    case 'attendance':
      optionsHtml = `
        <label>統計方式</label>
        <select class="form-control">
          <option value="detail">詳細記錄</option>
          <option value="summary">彙總統計</option>
        </select>
      `;
      break;
    case 'statistics':
      optionsHtml = `
        <label>統計項目</label>
        <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:0.5rem;">
          <label><input type="checkbox" checked> 會員統計</label>
          <label><input type="checkbox" checked> 活動統計</label>
          <label><input type="checkbox" checked> 出席率統計</label>
          <label><input type="checkbox"> 成長趨勢</label>
        </div>
      `;
      break;
  }

  container.innerHTML = optionsHtml;
}

async function handleGenerateReport(event) {
  event.preventDefault();

  const data = {
    type: document.getElementById('reportType').value,
    name: document.getElementById('reportName').value,
    startDate: document.getElementById('reportStartDate').value,
    endDate: document.getElementById('reportEndDate').value,
    format: document.getElementById('reportFormat').value,
    generatedBy: currentUser.name
  };

  document.getElementById('loadingOverlay').classList.add('active');

  try {
    const result = await callServerFunction('generateReport', data);
    document.getElementById('loadingOverlay').classList.remove('active');

    if (result.success) {
      showToast('報表產生中，完成後將通知您', 'success');
      closeModal('generateReportModal');
      CacheManager.clear('api_getReports');
      setTimeout(() => loadReportHistory(), 1000);
    } else {
      showToast('產生報表失敗：' + result.error, 'error');
    }
  } catch (e) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + e.message, 'error');
  }
}

async function downloadReport(reportId) {
  try {
    const result = await callServerFunction('getReportDownloadUrl', { reportId });
    
    if (result.success && result.url) {
      window.open(result.url, '_blank');
      showToast('下載開始', 'success');
    } else {
      showToast('下載失敗', 'error');
    }
  } catch (e) {
    showToast('下載失敗：' + e.message, 'error');
  }
}

async function deleteReport(reportId) {
  if (!confirm('確定要刪除此報表嗎？')) return;

  document.getElementById('loadingOverlay').classList.add('active');

  try {
    const result = await callServerFunction('deleteReport', { reportId });
    document.getElementById('loadingOverlay').classList.remove('active');

    if (result.success) {
      showToast('報表已刪除', 'success');
      CacheManager.clear('api_getReports');
      loadReportHistory();
    } else {
      showToast('刪除失敗：' + result.error, 'error');
    }
  } catch (e) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + e.message, 'error');
  }
}

// ==================== 設定頁面 ====================
function createSettingsPage() {
  return `
    <div class="container">
      <div class="page-header">
        <h1><i class="fas fa-cog"></i> 系統設定</h1>
      </div>

      <div class="settings-container">
        <div class="settings-sidebar">
          <button class="settings-tab-btn active" onclick="switchSettingsTab('general')">
            <i class="fas fa-sliders-h"></i> 一般設定
          </button>
          <button class="settings-tab-btn" onclick="switchSettingsTab('notification')">
            <i class="fas fa-bell"></i> 通知設定
          </button>
          <button class="settings-tab-btn" onclick="switchSettingsTab('privacy')">
            <i class="fas fa-shield-alt"></i> 隱私設定
          </button>
          <button class="settings-tab-btn" onclick="switchSettingsTab('security')">
            <i class="fas fa-lock"></i> 安全設定
          </button>
          ${PermissionManager.hasPermission('manage_system') ? `
            <button class="settings-tab-btn" onclick="switchSettingsTab('system')">
              <i class="fas fa-server"></i> 系統管理
            </button>
          ` : ''}
        </div>

        <div class="settings-content" id="settingsContent">
          <!-- 內容由 JS 動態載入 -->
        </div>
      </div>
    </div>
  `;
}

function switchSettingsTab(tab) {
  // 更新側邊欄按鈕狀態
  document.querySelectorAll('.settings-tab-btn').forEach(btn => btn.classList.remove('active'));
  event.target.closest('.settings-tab-btn').classList.add('active');

  const content = document.getElementById('settingsContent');

  switch (tab) {
    case 'general':
      content.innerHTML = createGeneralSettings();
      loadGeneralSettings();
      break;
    case 'notification':
      content.innerHTML = createNotificationSettings();
      loadNotificationSettings();
      break;
    case 'privacy':
      content.innerHTML = createPrivacySettings();
      loadPrivacySettings();
      break;
    case 'security':
      content.innerHTML = createSecuritySettings();
      break;
    case 'system':
      content.innerHTML = createSystemSettings();
      loadSystemSettings();
      break;
  }
}

function createGeneralSettings() {
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">一般設定</div>
      </div>
      <div class="card-body">
        <div class="setting-item">
          <div class="setting-info">
            <h4>深色模式</h4>
            <p>切換為深色主題以減少眼睛疲勞</p>
          </div>
          <label class="switch">
            <input type="checkbox" id="darkModeSetting" onchange="toggleDarkMode()">
            <span class="slider"></span>
          </label>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <h4>語言</h4>
            <p>選擇介面顯示語言</p>
          </div>
          <select class="form-control" style="width:200px;">
            <option value="zh-TW" selected>繁體中文</option>
            <option value="zh-CN">简体中文</option>
            <option value="en">English</option>
          </select>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <h4>時區</h4>
            <p>設定顯示時間的時區</p>
          </div>
          <select class="form-control" style="width:200px;">
            <option value="Asia/Taipei" selected>台北 (GMT+8)</option>
            <option value="Asia/Shanghai">上海 (GMT+8)</option>
            <option value="Asia/Tokyo">東京 (GMT+9)</option>
          </select>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <h4>每頁顯示筆數</h4>
            <p>設定列表每頁顯示的資料筆數</p>
          </div>
          <select class="form-control" style="width:200px;">
            <option value="10">10 筆</option>
            <option value="20" selected>20 筆</option>
            <option value="50">50 筆</option>
            <option value="100">100 筆</option>
          </select>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <h4>自動儲存</h4>
            <p>編輯時自動儲存草稿</p>
          </div>
          <label class="switch">
            <input type="checkbox" checked>
            <span class="slider"></span>
          </label>
        </div>

        <div class="mt-2">
          <button class="btn btn-primary" onclick="saveGeneralSettings()">
            <i class="fas fa-save"></i> 儲存設定
          </button>
        </div>
      </div>
    </div>
  `;
}

function createNotificationSettings() {
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">通知設定</div>
      </div>
      <div class="card-body">
        <div class="setting-item">
          <div class="setting-info">
            <h4>推播通知</h4>
            <p>接收瀏覽器推播通知</p>
          </div>
          <label class="switch">
            <input type="checkbox" id="pushNotificationSetting" onchange="togglePushNotification()">
            <span class="slider"></span>
          </label>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <h4>電子郵件通知</h4>
            <p>接收電子郵件通知</p>
          </div>
          <label class="switch">
            <input type="checkbox" checked>
            <span class="slider"></span>
          </label>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <h4>簡訊通知</h4>
            <p>接收手機簡訊通知</p>
          </div>
          <label class="switch">
            <input type="checkbox">
            <span class="slider"></span>
          </label>
        </div>

        <hr>

        <h4 style="margin-top:1.5rem; margin-bottom:1rem;">通知類型</h4>

        <div class="setting-item">
          <div class="setting-info">
            <h4>活動提醒</h4>
            <p>活動開始前提醒我</p>
          </div>
          <label class="switch">
            <input type="checkbox" checked>
            <span class="slider"></span>
          </label>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <h4>新活動通知</h4>
            <p>有新活動時通知我</p>
          </div>
          <label class="switch">
            <input type="checkbox" checked>
            <span class="slider"></span>
          </label>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <h4>系統公告</h4>
            <p>接收系統重要公告</p>
          </div>
          <label class="switch">
            <input type="checkbox" checked>
            <span class="slider"></span>
          </label>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <h4>聊天訊息</h4>
            <p>有新訊息時通知我</p>
          </div>
          <label class="switch">
            <input type="checkbox" checked>
            <span class="slider"></span>
          </label>
        </div>

        <div class="mt-2">
          <button class="btn btn-primary" onclick="saveNotificationSettings()">
            <i class="fas fa-save"></i> 儲存設定
          </button>
        </div>
      </div>
    </div>
  `;
}

function createPrivacySettings() {
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">隱私設定</div>
      </div>
      <div class="card-body">
        <div class="setting-item">
          <div class="setting-info">
            <h4>個人資料公開</h4>
            <p>允許其他會員查看我的基本資料</p>
          </div>
          <label class="switch">
            <input type="checkbox" checked>
            <span class="slider"></span>
          </label>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <h4>活動參與記錄公開</h4>
            <p>允許其他會員查看我的活動參與記錄</p>
          </div>
          <label class="switch">
            <input type="checkbox" checked>
            <span class="slider"></span>
          </label>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <h4>允許搜尋</h4>
            <p>允許其他會員搜尋到我</p>
          </div>
          <label class="switch">
            <input type="checkbox" checked>
            <span class="slider"></span>
          </label>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <h4>資料分析</h4>
            <p>允許系統使用我的資料進行匿名統計分析</p>
          </div>
          <label class="switch">
            <input type="checkbox" checked>
            <span class="slider"></span>
          </label>
        </div>

        <hr>

        <h4 style="margin-top:1.5rem; margin-bottom:1rem;">資料管理</h4>

        <div class="mt-2">
          <button class="btn btn-secondary" onclick="exportMyData()">
            <i class="fas fa-download"></i> 匯出我的資料
          </button>
          <button class="btn btn-danger" onclick="deleteMyAccount()">
            <i class="fas fa-trash"></i> 刪除帳號
          </button>
        </div>

        <div class="mt-2">
          <button class="btn btn-primary" onclick="savePrivacySettings()">
            <i class="fas fa-save"></i> 儲存設定
          </button>
        </div>
      </div>
    </div>
  `;
}

function createSecuritySettings() {
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">安全設定</div>
      </div>
      <div class="card-body">
        <div class="setting-section">
          <h4>變更密碼</h4>
          <form onsubmit="handleChangePassword(event)">
            <div class="form-group">
              <label>目前密碼</label>
              <input type="password" id="currentPassword" class="form-control" required>
            </div>
            <div class="form-group">
              <label>新密碼</label>
              <input type="password" id="newPassword" class="form-control" minlength="6" required>
            </div>
            <div class="form-group">
              <label>確認新密碼</label>
              <input type="password" id="confirmNewPassword" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-key"></i> 變更密碼
            </button>
          </form>
        </div>

        <hr>

        <div class="setting-section">
          <h4>登入裝置</h4>
          <p style="color:var(--text-secondary);">管理已登入的裝置</p>
          <div id="loginDevicesList">
            <div class="device-item">
              <div>
                <i class="fas fa-desktop" style="font-size:1.5rem; color:var(--primary-color);"></i>
              </div>
              <div style="flex:1; margin-left:1rem;">
                <strong>Windows 10 - Chrome</strong>
                <p style="color:var(--text-secondary); font-size:0.85rem; margin:0;">
                  最後活動：剛剛 | IP: 192.168.1.100
                </p>
              </div>
              <span class="badge badge-success">目前裝置</span>
            </div>
          </div>
          <button class="btn btn-danger mt-1" onclick="logoutAllDevices()">
            <i class="fas fa-sign-out-alt"></i> 登出所有裝置
          </button>
        </div>

        <hr>

        <div class="setting-section">
          <h4>雙因素驗證</h4>
          <p style="color:var(--text-secondary);">增強帳號安全性</p>
          <button class="btn btn-primary" onclick="setupTwoFactor()">
            <i class="fas fa-shield-alt"></i> 啟用雙因素驗證
          </button>
        </div>
      </div>
    </div>
  `;
}

function createSystemSettings() {
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">系統管理</div>
      </div>
      <div class="card-body">
        <div class="setting-section">
          <h4>系統資訊</h4>
          <div class="info-items">
            <div class="info-item">
              <label>系統版本</label>
              <p>v1.0.0</p>
            </div>
            <div class="info-item">
              <label>資料庫版本</label>
              <p>PostgreSQL 14.5</p>
            </div>
            <div class="info-item">
              <label>最後更新</label>
              <p>2025-01-15</p>
            </div>
            <div class="info-item">
              <label>系統狀態</label>
              <p><span class="status-badge active">正常運作</span></p>
            </div>
          </div>
        </div>

        <hr>

        <div class="setting-section">
          <h4>資料庫管理</h4>
          <div class="mt-1">
            <button class="btn btn-secondary" onclick="backupDatabase()">
              <i class="fas fa-database"></i> 備份資料庫
            </button>
            <button class="btn btn-secondary" onclick="optimizeDatabase()">
              <i class="fas fa-tachometer-alt"></i> 最佳化資料庫
            </button>
          </div>
        </div>

        <hr>

        <div class="setting-section">
          <h4>快取管理</h4>
          <div class="mt-1">
            <button class="btn btn-secondary" onclick="clearAllCache()">
              <i class="fas fa-broom"></i> 清除所有快取
            </button>
            <button class="btn btn-secondary" onclick="viewCacheStats()">
              <i class="fas fa-chart-bar"></i> 查看快取統計
            </button>
          </div>
        </div>

        <hr>

        <div class="setting-section">
          <h4>系統日誌</h4>
          <div class="mt-1">
            <button class="btn btn-secondary" onclick="viewSystemLogs()">
              <i class="fas fa-file-alt"></i> 查看系統日誌
            </button>
            <button class="btn btn-danger" onclick="clearSystemLogs()">
              <i class="fas fa-trash"></i> 清除日誌
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
}

function loadGeneralSettings() {
  // 載入深色模式設定
  const darkMode = localStorage.getItem('darkMode') === '1';
  document.getElementById('darkModeSetting').checked = darkMode;
}

function loadNotificationSettings() {
  // 載入推播通知設定
  const pushEnabled = localStorage.getItem('pushSubscribed') === 'true';
  document.getElementById('pushNotificationSetting').checked = pushEnabled;
}

function loadPrivacySettings() {
  // 載入隱私設定
}

function loadSystemSettings() {
  // 載入系統設定
}

function toggleDarkMode() {
  const enabled = document.getElementById('darkModeSetting').checked;
  document.documentElement.classList.toggle('dark-theme', enabled);
  localStorage.setItem('darkMode', enabled ? '1' : '0');
  showToast(enabled ? '已切換為深色模式' : '已切換為淺色模式', 'success');
}

async function togglePushNotification() {
  const enabled = document.getElementById('pushNotificationSetting').checked;
  
  if (enabled) {
    try {
      await subscribeToPush();
      showToast('推播通知已啟用', 'success');
    } catch (e) {
      document.getElementById('pushNotificationSetting').checked = false;
      showToast('啟用推播通知失敗：' + e.message, 'error');
    }
  } else {
    await unsubscribeFromPush();
    showToast('推播通知已停用', 'success');
  }
}

function saveGeneralSettings() {
  showToast('一般設定已儲存', 'success');
}

function saveNotificationSettings() {
  showToast('通知設定已儲存', 'success');
}

function savePrivacySettings() {
  showToast('隱私設定已儲存', 'success');
}

async function handleChangePassword(event) {
  event.preventDefault();
  
  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmNewPassword').value;

  if (newPassword !== confirmPassword) {
    showToast('新密碼不一致', 'error');
    return;
  }

  document.getElementById('loadingOverlay').classList.add('active');

  try {
    const result = await callServerFunction('changePassword', {
      memberId: currentUser.id,
      currentPassword,
      newPassword
    });

    document.getElementById('loadingOverlay').classList.remove('active');

    if (result.success) {
      showToast('密碼已變更', 'success');
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmNewPassword').value = '';
    } else {
      showToast('變更密碼失敗：' + result.error, 'error');
    }
  } catch (e) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + e.message, 'error');
  }
}

function logoutAllDevices() {
  if (!confirm('確定要登出所有裝置嗎？您需要重新登入。')) return;
  showToast('此功能開發中', 'info');
}

function setupTwoFactor() {
  showToast('此功能開發中', 'info');
}

function exportMyData() {
  showToast('正在準備您的資料...', 'info');
}

function deleteMyAccount() {
  if (!confirm('確定要刪除帳號嗎？此操作無法復原！')) return;
  if (!confirm('再次確認：您確定要永久刪除您的帳號和所有資料嗎？')) return;
  showToast('此功能開發中', 'info');
}

function backupDatabase() {
  if (!confirm('確定要備份資料庫嗎？')) return;
  showToast('資料庫備份中...', 'info');
}

function optimizeDatabase() {
  if (!confirm('確定要最佳化資料庫嗎？')) return;
  showToast('資料庫最佳化中...', 'info');
}

function clearAllCache() {
  if (!confirm('確定要清除所有快取嗎？')) return;
  CacheManager.clear();
  showToast('快取已清除', 'success');
}

function viewCacheStats() {
  const stats = CacheManager.getStats();
  alert(`快取統計：\n項目數：${stats.count}\n命中率：${stats.hitRate}%`);
}

function viewSystemLogs() {
  showToast('此功能開發中', 'info');
}

function clearSystemLogs() {
  if (!confirm('確定要清除系統日誌嗎？')) return;
  showToast('日誌已清除', 'success');
}

// ==================== QR Code 掃描 ====================
function createQRScannerInterface() {
  return `
    <div class="container">
      <div class="page-header">
        <h1><i class="fas fa-qrcode"></i> QR Code 簽到</h1>
        <button class="btn btn-secondary" onclick="history.back()">
          <i class="fas fa-arrow-left"></i> 返回
        </button>
      </div>

      <div class="card">
        <div class="card-body text-center">
          <div id="qrScannerContainer" style="max-width:500px; margin:0 auto;">
            <video id="qrVideo" style="width:100%; border-radius:8px;"></video>
            <canvas id="qrCanvas" style="display:none;"></canvas>
          </div>

          <div class="mt-2">
            <button class="btn btn-primary btn-lg" id="startScanBtn" onclick="startQRScanner()">
              <i class="fas fa-camera"></i> 開始掃描
            </button>
            <button class="btn btn-danger btn-lg" id="stopScanBtn" onclick="stopQRScanner()" style="display:none;">
              <i class="fas fa-stop"></i> 停止掃描
            </button>
          </div>

          <p class="mt-2" style="color:var(--text-secondary);">
            請將 QR Code 對準鏡頭進行掃描
          </p>

          <hr>

          <h3>或選擇活動手動簽到</h3>
          <div id="manualCheckInList" style="max-width:600px; margin:1rem auto;">
            <div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>載入中...</p></div>
          </div>
        </div>
      </div>
    </div>
  `;
}

let qrScanner = null;

async function loadActivitiesForQR() {
  try {
    const result = await callServerFunction('getTodayActivities', {});
    
    if (result.success && result.activities.length > 0) {
      document.getElementById('manualCheckInList').innerHTML = result.activities.map(a => `
        <div class="activity-card" style="margin-bottom:1rem;">
          <div class="activity-content">
            <h4>${escapeHtml(a['活動名稱'])}</h4>
            <p style="color:var(--text-secondary);">
              <i class="fas fa-clock"></i> ${formatTime(a['開始時間'])} - ${formatTime(a['結束時間'])}
              <br>
              <i class="fas fa-map-marker-alt"></i> ${escapeHtml(a['活動地點'])}
            </p>
            <button class="btn btn-primary" onclick="manualCheckIn('${a['活動ID']}')">
              <i class="fas fa-check"></i> 簽到
            </button>
          </div>
        </div>
      `).join('');
    } else {
      document.getElementById('manualCheckInList').innerHTML = `
        <div class="empty-state">
          <i class="fas fa-calendar"></i>
          <p>今天沒有活動</p>
        </div>
      `;
    }
  } catch (e) {
    console.error('載入活動失敗:', e);
  }
}

async function startQRScanner() {
  try {
    const video = document.getElementById('qrVideo');
    const canvas = document.getElementById('qrCanvas');
    const context = canvas.getContext('2d');

    // 請求相機權限
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment' }
    });

    video.srcObject = stream;
    video.play();

    document.getElementById('startScanBtn').style.display = 'none';
    document.getElementById('stopScanBtn').style.display = 'inline-block';

    // 開始掃描
    qrScanner = setInterval(() => {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);

        if (code) {
          stopQRScanner();
          handleQRCodeScanned(code.data);
        }
      }
    }, 300);

  } catch (e) {
    console.error('啟動掃描器失敗:', e);
    showToast('無法啟動相機：' + e.message, 'error');
  }
}

function stopQRScanner() {
  if (qrScanner) {
    clearInterval(qrScanner);
    qrScanner = null;
  }

  const video = document.getElementById('qrVideo');
  if (video && video.srcObject) {
    video.srcObject.getTracks().forEach(track => track.stop());
    video.srcObject = null;
  }

  document.getElementById('startScanBtn').style.display = 'inline-block';
  document.getElementById('stopScanBtn').style.display = 'none';
}

async function handleQRCodeScanned(activityId) {
  document.getElementById('loadingOverlay').classList.add('active');

  try {
    const result = await callServerFunction('checkInActivity', {
      activityId,
      memberId: currentUser.id,
      memberName: currentUser.name,
      checkInTime: new Date().toISOString()
    });

    document.getElementById('loadingOverlay').classList.remove('active');

    if (result.success) {
      showToast('簽到成功！', 'success');
      // 顯示簽到成功動畫
      showCheckInSuccess();
    } else {
      showToast('簽到失敗：' + result.error, 'error');
    }
  } catch (e) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + e.message, 'error');
  }
}

async function manualCheckIn(activityId) {
  if (!confirm('確定要簽到此活動嗎？')) return;
  await handleQRCodeScanned(activityId);
}

function showCheckInSuccess() {
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s;
  `;
  
  overlay.innerHTML = `
    <div style="text-align:center; color:#fff;">
      <i class="fas fa-check-circle" style="font-size:100px; color:#4caf50; animation: scaleIn 0.5s;"></i>
      <h2 style="margin-top:1rem;">簽到成功！</h2>
      <p>已記錄您的出席</p>
    </div>
  `;

  document.body.appendChild(overlay);

  setTimeout(() => {
    overlay.style.animation = 'fadeOut 0.3s';
    setTimeout(() => overlay.remove(), 300);
  }, 2000);
}

// ==================== 分頁控制 ====================
function updatePagination(pagination, containerId, callback) {
  const container = document.getElementById(containerId);
  if (!container) return;

  const { currentPage, totalPages, totalItems } = pagination;

  if (totalPages <= 1) {
    container.innerHTML = '';
    return;
  }

  let html = '<div class="pagination">';

  // 上一頁
  if (currentPage > 1) {
    html += `<button class="pagination-btn" onclick="${callback.name}(${currentPage - 1})">
      <i class="fas fa-chevron-left"></i>
    </button>`;
  }

  // 頁碼
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, currentPage + 2);

  if (startPage > 1) {
    html += `<button class="pagination-btn" onclick="${callback.name}(1)">1</button>`;
    if (startPage > 2) html += '<span>...</span>';
  }

  for (let i = startPage; i <= endPage; i++) {
    html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="${callback.name}(${i})">${i}</button>`;
  }

  if (endPage < totalPages) {
    if (endPage < totalPages - 1) html += '<span>...</span>';
    html += `<button class="pagination-btn" onclick="${callback.name}(${totalPages})">${totalPages}</button>`;
  }

  // 下一頁
  if (currentPage < totalPages) {
    html += `<button class="pagination-btn" onclick="${callback.name}(${currentPage + 1})">
      <i class="fas fa-chevron-right"></i>
    </button>`;
  }

  html += '</div>';
  html += `<p class="text-center mt-1" style="color:var(--text-secondary); font-size:0.9rem;">
    共 ${totalItems} 筆資料，第 ${currentPage} / ${totalPages} 頁
  </p>`;

  container.innerHTML = html;
}

// ==================== 輔助函數 ====================

// 日期時間格式化
function formatDate(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function formatTime(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${hours}:${minutes}`;
}

function formatDateTime(dateStr) {
  if (!dateStr) return '-';
  return `${formatDate(dateStr)} ${formatTime(dateStr)}`;
}

function formatRelativeTime(dateStr) {
  if (!dateStr) return '-';
  
  const now = new Date();
  const date = new Date(dateStr);
  const diff = now - date;
  
  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);
  
  if (days > 7) return formatDate(dateStr);
  if (days > 0) return `${days} 天前`;
  if (hours > 0) return `${hours} 小時前`;
  if (minutes > 0) return `${minutes} 分鐘前`;
  return '剛剛';
}

// 計算年齡
function calculateAge(birthDateStr) {
  if (!birthDateStr) return '-';
  const birthDate = new Date(birthDateStr);
  const today = new Date();
  let age = today.getFullYear() - birthDate.getFullYear();
  const monthDiff = today.getMonth() - birthDate.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }
  return age;
}

// HTML 跳脫
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// 數字動畫
function animateNumber(elementId, targetValue, suffix = '', decimals = 0) {
  const element = document.getElementById(elementId);
  if (!element) return;

  const startValue = 0;
  const duration = 1000;
  const startTime = Date.now();

  function update() {
    const currentTime = Date.now();
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);

    const currentValue = startValue + (targetValue - startValue) * easeOutQuad(progress);
    element.textContent = currentValue.toFixed(decimals) + suffix;

    if (progress < 1) {
      requestAnimationFrame(update);
    }
  }

  update();
}

function easeOutQuad(t) {
  return t * (2 - t);
}

// 活動相關輔助函數
function getActivityStatus(activity) {
  const now = new Date();
  const startTime = new Date(activity['開始時間']);
  const endTime = new Date(activity['結束時間']);

  if (now < startTime) return 'upcoming';
  if (now > endTime) return 'completed';
  return 'ongoing';
}

function getActivityStatusText(activity) {
  const status = getActivityStatus(activity);
  const map = {
    upcoming: '即將舉辦',
    ongoing: '進行中',
    completed: '已結束'
  };
  return map[status] || '未知';
}

function getActivityTypeColor(type) {
  const colors = {
    '健康講座': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    '復健課程': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
    '社交活動': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
    '志工服務': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
    '其他': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
  };
  return colors[type] || colors['其他'];
}

function getActivityIcon(type) {
  const icons = {
    '健康講座': 'heartbeat',
    '復健課程': 'dumbbell',
    '社交活動': 'users',
    '志工服務': 'hands-helping',
    '其他': 'calendar-alt'
  };
  return icons[type] || icons['其他'];
}

function getTimelineColor(type) {
  const colors = {
    'activity': '#667eea',
    'achievement': '#f5576c',
    'system': '#4facfe',
    'social': '#43e97b'
  };
  return colors[type] || '#999';
}

function getTimelineIcon(type) {
  const icons = {
    'activity': 'calendar-check',
    'achievement': 'trophy',
    'system': 'bell',
    'social': 'comment'
  };
  return icons[type] || 'circle';
}

// Toast 通知
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  
  const icons = {
    success: 'check-circle',
    error: 'exclamation-circle',
    warning: 'exclamation-triangle',
    info: 'info-circle'
  };

  toast.innerHTML = `
    <i class="fas fa-${icons[type]}"></i>
    <span>${escapeHtml(message)}</span>
  `;

  document.body.appendChild(toast);

  // 觸發動畫
  setTimeout(() => toast.classList.add('show'), 10);

  // 自動移除
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// 確認對話框
function showConfirm(message, onConfirm, onCancel) {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:400px;">
      <div class="modal-header">
        <h2>確認</h2>
      </div>
      <div class="modal-body">
        <p>${escapeHtml(message)}</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="confirmCancelBtn">取消</button>
        <button class="btn btn-primary" id="confirmOkBtn">確定</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  document.getElementById('confirmOkBtn').onclick = () => {
    modal.remove();
    if (onConfirm) onConfirm();
  };

  document.getElementById('confirmCancelBtn').onclick = () => {
    modal.remove();
    if (onCancel) onCancel();
  };
}

// 載入指示器
function showLoading(show = true) {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.classList.toggle('active', show);
  }
}

// 錯誤處理
function handleError(error, context = '') {
  console.error(`Error in ${context}:`, error);
  showToast(`發生錯誤：${error.message}`, 'error');
}

// 驗證函數
function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

function validatePhone(phone) {
  const re = /^09\d{8}$/;
  return re.test(phone);
}

function validateRequired(value) {
  return value && value.trim().length > 0;
}

// 搜尋高亮
function highlightSearchText(text, searchText) {
  if (!searchText) return escapeHtml(text);
  const regex = new RegExp(`(${searchText})`, 'gi');
  return escapeHtml(text).replace(regex, '<mark>$1</mark>');
}

// 檔案大小格式化
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// 複製到剪貼簿
async function copyToClipboard(text) {
  try {
    await navigator.clipboard.writeText(text);
    showToast('已複製到剪貼簿', 'success');
  } catch (e) {
    showToast('複製失敗', 'error');
  }
}

// 下載檔案
function downloadFile(url, filename) {
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// 圖片預覽
function previewImage(file, callback) {
  const reader = new FileReader();
  reader.onload = (e) => {
    if (callback) callback(e.target.result);
  };
  reader.readAsDataURL(file);
}

// 防抖函數
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// 節流函數
function throttle(func, limit) {
  let inThrottle;
  return function(...args) {
    if (!inThrottle) {
      func.apply(this, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
}

// ==================== 推播通知 ====================
async function subscribeToPush() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
    throw new Error('瀏覽器不支援推播通知');
  }

  const permission = await Notification.requestPermission();
  if (permission !== 'granted') {
    throw new Error('使用者拒絕推播通知權限');
  }

  try {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
    });

    // 儲存訂閱到伺服器
    await callServerFunction('savePushSubscription', {
      memberId: currentUser.id,
      subscription: JSON.stringify(subscription)
    });

    localStorage.setItem('pushSubscribed', 'true');
    return subscription;
  } catch (e) {
    throw new Error('訂閱推播通知失敗：' + e.message);
  }
}

async function unsubscribeFromPush() {
  try {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.getSubscription();
    
    if (subscription) {
      await subscription.unsubscribe();
      
      // 從伺服器移除訂閱
      await callServerFunction('removePushSubscription', {
        memberId: currentUser.id
      });
    }

    localStorage.setItem('pushSubscribed', 'false');
  } catch (e) {
    console.error('取消訂閱失敗:', e);
  }
}

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding)
    .replace(/\-/g, '+')
    .replace(/_/g, '/');

  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);

  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

// ==================== Service Worker 註冊 ====================
async function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    try {
      const registration = await navigator.serviceWorker.register('/service-worker.js');
      console.log('Service Worker 註冊成功:', registration);
    } catch (e) {
      console.error('Service Worker 註冊失敗:', e);
    }
  }
}

// ==================== 離線偵測 ====================
function setupOfflineDetection() {
  window.addEventListener('online', () => {
    showToast('網路連線已恢復', 'success');
    // 重新載入資料
    const currentRoute = window.location.hash.slice(1).split('?')[0] || 'home';
    loadPageContent(currentRoute);
  });

  window.addEventListener('offline', () => {
    showToast('網路連線已中斷', 'warning');
  });
}

// ==================== 鍵盤快捷鍵 ====================
function setupKeyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + K: 搜尋
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      const searchInput = document.querySelector('input[type="search"], input[placeholder*="搜尋"]');
      if (searchInput) searchInput.focus();
    }

    // Esc: 關閉 Modal
    if (e.key === 'Escape') {
      const activeModal = document.querySelector('.modal.active');
      if (activeModal) activeModal.classList.remove('active');
    }

    // Ctrl/Cmd + S: 儲存
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
      e.preventDefault();
      const saveBtn = document.querySelector('button[type="submit"]:not([disabled])');
      if (saveBtn) saveBtn.click();
    }
  });
}

// ==================== 效能監控 ====================
function setupPerformanceMonitoring() {
  if ('PerformanceObserver' in window) {
    const observer = new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        if (entry.duration > 1000) {
          console.warn('慢速操作:', entry.name, entry.duration + 'ms');
        }
      }
    });

    observer.observe({ entryTypes: ['measure', 'navigation'] });
  }
}

// ==================== 錯誤追蹤 ====================
function setupErrorTracking() {
  window.addEventListener('error', (event) => {
    console.error('全域錯誤:', event.error);
    // 可以在這裡發送錯誤報告到伺服器
  });

  window.addEventListener('unhandledrejection', (event) => {
    console.error('未處理的 Promise 拒絕:', event.reason);
    // 可以在這裡發送錯誤報告到伺服器
  });
}

// ==================== 自動登出 ====================
let inactivityTimer;
const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 分鐘

function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    showToast('閒置時間過長，即將自動登出', 'warning');
    setTimeout(() => {
      logout();
    }, 5000);
  }, INACTIVITY_TIMEOUT);
}

function setupInactivityDetection() {
  ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
    document.addEventListener(event, resetInactivityTimer, true);
  });
  resetInactivityTimer();
}

// ==================== 應用程式初始化 ====================
async function initializeApp() {
  console.log('初始化應用程式...');

  try {
    // 註冊 Service Worker
    await registerServiceWorker();

    // 設定離線偵測
    setupOfflineDetection();

    // 設定鍵盤快捷鍵
    setupKeyboardShortcuts();

    // 設定效能監控
    setupPerformanceMonitoring();

    // 設定錯誤追蹤
    setupErrorTracking();

    // 設定閒置偵測
    setupInactivityDetection();

    // 檢查深色模式設定
    const darkMode = localStorage.getItem('darkMode') === '1';
    document.documentElement.classList.toggle('dark-theme', darkMode);

    // 檢查登入狀態
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
      currentUser = JSON.parse(savedUser);
      showApp();
      
      // 載入初始頁面
      const hash = window.location.hash.slice(1) || 'home';
      navigateTo(hash);
    } else {
      showLogin();
    }

    console.log('應用程式初始化完成');
  } catch (e) {
    console.error('應用程式初始化失敗:', e);
    showToast('應用程式初始化失敗', 'error');
  }
}

// ==================== 頁面載入完成後執行 ====================
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeApp);
} else {
  initializeApp();
}

// ==================== 視窗大小變化處理 ====================
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    // 處理響應式佈局調整
    const isMobile = window.innerWidth < 768;
    document.body.classList.toggle('mobile-view', isMobile);
  }, 250);
});

// ==================== 返回按鈕處理 ====================
window.addEventListener('popstate', (event) => {
  if (event.state && event.state.page) {
    loadPageContent(event.state.page, event.state.params);
  }
});

// ==================== 全域變數匯出 ====================
window.app = {
  navigateTo,
  showToast,
  showConfirm,
  showLoading,
  logout,
  currentUser,
  PermissionManager,
  CacheManager
};

console.log('🎉 長照機構管理系統已載入完成！');
console.log('版本: v1.0.0');
console.log('作者: Your Name');
console.log('授權: MIT License');


</body>
</html>
