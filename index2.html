<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å¸•é‡‘æ£®ç—…å‹æœƒæ•´åˆç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"/>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    /* ä¿ç•™åŸæœ‰çš„æ‰€æœ‰ CSS æ¨£å¼ */
    :root {
      --primary: #06c755;
      --primary-dark: #05b04b;
      --secondary: #00b900;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --border-radius: 12px;
      --purple-1: #667eea;
      --purple-2: #764ba2;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans TC',sans-serif; 
      background: linear-gradient(135deg, var(--purple-1) 0%, var(--purple-2) 100%); 
      min-height:100vh; 
    }
    .hidden { display:none !important; }
    .root-container { max-width: 1200px; margin: 0 auto; }
    .view { display:none; }
    .view.active { display:block; }

    /* å…¶ä»–æ‰€æœ‰åŸæœ‰çš„ CSS ä¿æŒä¸è®Š */
  </style>
</head>
<body>

  <div class="root-container">
    <!-- ä¿ç•™åŸæœ‰çš„æ‰€æœ‰ HTML çµæ§‹ -->
    <!-- view-auth, view-member, view-admin ç­‰ -->
  </div>

  <!-- Toast/Modal/Loading å®¹å™¨ -->
  <div id="toastContainer" class="toast-container"></div>
  <div id="modalContainer"></div>
  <div id="globalLoading" class="loading-overlay"><div class="loading-spinner"></div></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // ========== ä¿®æ­£å¾Œçš„å®Œæ•´ JavaScript ==========
  
  const APP = {
    State: {
      LIFF_IDS: {
        // app: '1656516134-VaGgmaPm',
        // auth: '1656516134-X9oq92g9',
        // member: '1656516134-k8rMQwnQ'
        app: '1656516134-VaGgmaPm',
        auth: '1656516134-VaGgmaPm',
        member: '1656516134-VaGgmaPm'
      },
      API: {
        primary: localStorage.getItem('API_URL') || 'https://script.google.com/macros/s/AKfycbzalre2WU8dM6LwUA02VnjlvtXVpORTzYgqXgCmRuVIvJ42KjZ4XuAkZbgSEGvD7Fp8AQ/exec',
        alt: localStorage.getItem('admin_API_URL') || 'https://script.google.com/macros/s/AKfycbzalre2WU8dM6LwUA02VnjlvtXVpORTzYgqXgCmRuVIvJ42KjZ4XuAkZbgSEGvD7Fp8AQ/exec'
      },
      API_KEY: 'AAbb8520258185202581',
      userProfile: null,
      memberInfo: null,
      isAdmin: true,
      routerView: 'auth',
      appUser: { lineId: '', name: '', picture: '' },
      pageSize: 20
    },

    // ========== å·¥å…·å‡½æ•¸ ==========
    Util: {
      showLoading(show) {
        document.getElementById('globalLoading').classList.toggle('show', !!show);
      },
      
      toast(message, type='info') {
        const container = document.getElementById('toastContainer');
        const colors = { success: '#28a745', error: '#dc3545', warning: '#ffc107', info: '#17a2b8' };
        const icons = { success: 'check-circle-fill', error: 'x-circle-fill', warning: 'exclamation-triangle-fill', info: 'info-circle-fill' };
        const toast = document.createElement('div');
        toast.className = 'toast show';
        toast.style.cssText = `min-width:250px;margin-bottom:10px;background:white;border-left:4px solid ${colors[type]};box-shadow:0 4px 12px rgba(0,0,0,0.15);`;
        toast.innerHTML = `
          <div class="toast-body d-flex align-items-center">
            <i class="bi bi-${icons[type]} me-2" style="color:${colors[type]};font-size:18px;"></i>
            <div class="flex-grow-1" style="font-size:14px;">${message}</div>
            <button type="button" class="btn-close ms-2" aria-label="Close"></button>
          </div>`;
        toast.querySelector('.btn-close').onclick = () => toast.remove();
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      },
      
      modal(html, onSubmit) {
        const container = document.getElementById('modalContainer');
        container.innerHTML = html;
        const modalEl = container.querySelector('.modal');
        const formEl = container.querySelector('form');
        const bsModal = new bootstrap.Modal(modalEl);
        
        if (formEl && typeof onSubmit === 'function') {
          formEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = formEl.querySelector('button[type="submit"]');
            APP.Util.setBtnLoading(btn, true);
            try {
              const fd = new FormData(formEl);
              await onSubmit(fd);
              bsModal.hide();
            } catch (err) {
              APP.Util.toast(err.message || 'æ“ä½œå¤±æ•—', 'error');
            } finally {
              APP.Util.setBtnLoading(btn, false);
            }
          });
        }
        
        modalEl.addEventListener('hidden.bs.modal', () => container.innerHTML = '', { once: true });
        bsModal.show();
      },
      
      setBtnLoading(button, loading) {
        if (!button) return;
        if (loading) {
          button.disabled = true;
          button.dataset.originalText = button.innerHTML;
          button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>è™•ç†ä¸­...';
        } else {
          button.disabled = false;
          if (button.dataset.originalText) button.innerHTML = button.dataset.originalText;
        }
      },
      
      formatDate(dateInput) {
        if (!dateInput) return '-';
        try {
          let d;
          if (dateInput instanceof Date) d = dateInput;
          else if (typeof dateInput === 'number') d = new Date(dateInput);
          else if (typeof dateInput === 'string') {
            const p = Date.parse(dateInput);
            d = isNaN(p) ? new Date(dateInput) : new Date(p);
          } else return '-';
          if (isNaN(d.getTime())) return '-';
          return d.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
        } catch { return '-'; }
      },
      
      formatDateInput(dateString) {
        if (!dateString) return '';
        try {
          const d = (dateString instanceof Date) ? dateString : new Date(dateString);
          if (isNaN(d.getTime())) return '';
          return d.toISOString().split('T')[0];
        } catch { return ''; }
      },
      
      currency(n) { 
        return new Intl.NumberFormat('zh-TW').format(Number(n || 0)); 
      },
      
      getStatusClass(status) {
        const map = {
          'å·²å¯©æ ¸': 'success', 'å¾…å¯©æ ¸': 'warning', 'å·²åœç”¨': 'danger', 
          'å ±åä¸­': 'info', 'å·²é¡æ»¿': 'warning', 'å·²çµæŸ': 'secondary', 
          'å·²å–æ¶ˆ': 'danger', 'å·²å®Œæˆ': 'success', 'è™•ç†ä¸­': 'warning', 
          'å·²å•Ÿç”¨': 'success', 'å·²ææ¬¾': 'success'
        };
        return map[status] || 'secondary';
      }
    },

    // ========== é…ç½® ==========
    Config: {
      updateAPIUrl() {
        const v = document.getElementById('global-api-url').value.trim();
        if (!v) { 
          APP.Util.toast('è«‹è¼¸å…¥æœ‰æ•ˆ URL', 'error'); 
          return; 
        }
        APP.State.API.primary = v;
        APP.State.API.alt = v;
        localStorage.setItem('API_URL', v);
        localStorage.setItem('admin_API_URL', v);
        document.getElementById('current-api-url').textContent = v;
        APP.Util.toast('API ç¶²å€å·²æ›´æ–°', 'success');
      }
    },

    // ========== è·¯ç”± ==========
    Router: {
      go(view) {
        APP.State.routerView = view;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + view).classList.add('active');
        
        if (view === 'member') {
          APP.AppView.initApp();
          APP.Member.initMember();
        } else if (view === 'admin') {
          APP.Admin.initAdmin();
        }
      },
      
      goAdmin() {
        if (!APP.State.isAdmin) { 
          APP.Util.toast('æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™', 'error'); 
          return; 
        }
        APP.Router.go('admin');
      }
    },

    // ========== LIFF ==========
    LIFF: {
      inited: false,
      
      async initAny() {
        if (APP.LIFF.inited) return;
        try {
          const anyId = APP.State.LIFF_IDS.app || APP.State.LIFF_IDS.auth || APP.State.LIFF_IDS.member;
          if (anyId && typeof liff !== 'undefined') {
            await liff.init({ liffId: anyId });
            APP.LIFF.inited = true;
          }
        } catch (e) { 
          console.log('LIFF init error:', e); 
        }
      },
      
      async ensureLogged() {
        try {
          await APP.LIFF.initAny();
          if (typeof liff !== 'undefined' && !liff.isLoggedIn()) {
            liff.login();
          }
        } catch (e) { 
          console.log('LIFF login error:', e); 
        }
      },
      
      async profile() {
        try {
          await APP.LIFF.initAny();
          if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
            return await liff.getProfile();
          }
        } catch (e) { 
          console.log('LIFF profile error:', e); 
        }
        return null;
      }
    },

    // ========== APIï¼ˆçµ±ä¸€ä½¿ç”¨ POST JSONï¼‰ ==========
    API: {
      async call(action, data = {}) {
        try {
          const payload = {
            apiKey: APP.State.API_KEY,
            action,
            ...data
          };
          
          // å¦‚æœæœ‰ memberInfoï¼Œè‡ªå‹•å¸¶å…¥ memberId
          if (APP.State.memberInfo && !data.memberId && !data.lineId) {
            payload.memberId = APP.State.memberInfo.memberId;
          }
          
          // å¦‚æœæœ‰ userProfileï¼Œè‡ªå‹•å¸¶å…¥ lineId
          if (APP.State.userProfile && !data.lineId) {
            payload.lineId = APP.State.userProfile.userId;
          }
          
          const response = await fetch(APP.State.API.primary, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const result = await response.json();
          
          if (!result.success && result.message) {
            throw new Error(result.message);
          }
          
          return result;
        } catch (error) {
          console.error('API Error:', error);
          throw error;
        }
      }
    },

    // ========== èªè­‰ ==========
    Auth: {
      debug(message) {
        const el = document.getElementById('auth-debug');
        if (!el) return;
        const ts = new Date().toLocaleTimeString();
        el.innerHTML += '[' + ts + '] ' + message + '<br/>';
        el.scrollTop = 999999;
      },
      
      setAlert(msg, type = 'info') {
        const el = document.getElementById('auth-alert');
        if (!el) return;
        el.className = 'alert alert-' + (type === 'error' ? 'danger' : type);
        el.textContent = msg;
        el.classList.remove('d-none');
        setTimeout(() => el.classList.add('d-none'), 5000);
      },
      
      setLoading(on) {
        const el = document.getElementById('auth-loading');
        if (el) el.classList.toggle('d-none', !on);
      },
      
      async init() {
        // Tab åˆ‡æ›
        document.querySelectorAll('.auth-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            document.querySelectorAll('.auth-pane').forEach(p => p.classList.remove('active'));
            document.getElementById(tab.dataset.pane).classList.add('active');
          });
        });
        
        const urlEl = document.getElementById('current-api-url');
        if (urlEl) urlEl.textContent = APP.State.API.primary;
        
        // æª¢æŸ¥å·²ç™»å…¥
        const stored = localStorage.getItem('memberInfo');
        if (stored) {
          APP.State.memberInfo = JSON.parse(stored);
          APP.State.isAdmin = !!APP.State.memberInfo?.isAdmin;
          APP.Router.go('member');
          return;
        }
        
        // åˆå§‹åŒ– LIFF
        try {
          await APP.LIFF.initAny();
          if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
            const profile = await liff.getProfile();
            APP.Auth.debug('å·²ç™»å…¥ LINE: ' + profile.displayName);
          }
        } catch (err) {
          APP.Auth.debug('LIFF åˆå§‹åŒ–å¤±æ•—: ' + err.message);
        }
      },
      
      async testAPIConnection() {
        APP.Auth.setLoading(true);
        try {
          APP.Auth.debug('é–‹å§‹æ¸¬è©¦ API...');
          const result = await APP.API.call('test');
          APP.Auth.setLoading(false);
          if (result?.success) {
            APP.Auth.setAlert('API é€£ç·šæˆåŠŸï¼', 'success');
            APP.Auth.debug('æ¸¬è©¦æˆåŠŸ: ' + JSON.stringify(result));
          } else {
            APP.Auth.setAlert('API å›æ‡‰ç•°å¸¸', 'warning');
          }
        } catch (e) {
          APP.Auth.setLoading(false);
          APP.Auth.setAlert('API é€£ç·šå¤±æ•—ï¼š' + e.message, 'error');
          APP.Auth.debug('éŒ¯èª¤: ' + e.message);
        }
      },
      
      clearDebug() {
        const el = document.getElementById('auth-debug');
        if (el) {
          el.innerHTML = '';
          APP.Auth.debug('å·²æ¸…é™¤é™¤éŒ¯è¨˜éŒ„');
        }
      },
      
      async handleEmailLogin(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        
        APP.Auth.setLoading(true);
        try {
          const result = await APP.API.call('login', { email, password });
          APP.Auth.setLoading(false);
          
          if (result?.success) {
            APP.State.memberInfo = result.data;
            APP.State.isAdmin = !!result.data?.isAdmin;
            localStorage.setItem('memberInfo', JSON.stringify(result.data));
            APP.Auth.setAlert('ç™»å…¥æˆåŠŸï¼', 'success');
            setTimeout(() => APP.Router.go('member'), 800);
          } else {
            APP.Auth.setAlert(result?.message || 'ç™»å…¥å¤±æ•—', 'error');
          }
        } catch (e2) {
          APP.Auth.setLoading(false);
          APP.Auth.setAlert('ç³»çµ±éŒ¯èª¤ï¼š' + e2.message, 'error');
        }
      },
      
      async handleLineLogin() {
        APP.Auth.debug('é–‹å§‹ LINE ç™»å…¥');
        try {
          await APP.LIFF.ensureLogged();
          
          if (typeof liff === 'undefined' || !liff.isLoggedIn()) {
            APP.Auth.setAlert('LINE ç™»å…¥å¤±æ•—', 'error');
            return;
          }
          
          const profile = await liff.getProfile();
          APP.Auth.debug('LINE ä½¿ç”¨è€…ï¼š' + profile.displayName);
          APP.Auth.setLoading(true);
          
          const result = await APP.API.call('lineLogin', {
            lineUserId: profile.userId,
            displayName: profile.displayName,
            pictureUrl: profile.pictureUrl || ''
          });
          
          APP.Auth.setLoading(false);
          
          if (result?.success) {
            APP.State.memberInfo = result.data;
            APP.State.isAdmin = !!result.data?.isAdmin;
            localStorage.setItem('memberInfo', JSON.stringify(result.data));
            APP.Auth.setAlert('ç™»å…¥æˆåŠŸï¼', 'success');
            setTimeout(() => APP.Router.go('member'), 800);
          } else {
            APP.Auth.setAlert(result?.message || 'LINE ç™»å…¥å¤±æ•—', 'error');
          }
        } catch (e) {
          APP.Auth.setLoading(false);
          APP.Auth.setAlert('LINE ç™»å…¥å¤±æ•—ï¼š' + e.message, 'error');
          APP.Auth.debug('éŒ¯èª¤: ' + e.message);
        }
      },
      
      async handleRegister(e) {
        e.preventDefault();
        const pwd = document.getElementById('reg-password').value;
        const pwd2 = document.getElementById('reg-password-confirm').value;
        
        if (pwd !== pwd2) { 
          APP.Auth.setAlert('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´', 'error'); 
          return; 
        }
        
        APP.Auth.setLoading(true);
        try {
          let lineUserId = '';
          try {
            await APP.LIFF.initAny();
            if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
              const p = await liff.getProfile();
              lineUserId = p.userId;
            }
          } catch {}
          
          const result = await APP.API.call('register', {
            name: document.getElementById('reg-name').value,
            gender: document.getElementById('reg-gender').value,
            birthday: document.getElementById('reg-birthday').value,
            phone: document.getElementById('reg-phone').value,
            email: document.getElementById('reg-email').value,
            password: pwd,
            lineUserId
          });
          
          APP.Auth.setLoading(false);
          
          if (result?.success) {
            APP.Auth.setAlert('è¨»å†ŠæˆåŠŸï¼è«‹ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸', 'success');
            document.querySelector('.auth-tab[data-pane="pane-login"]').click();
          } else {
            APP.Auth.setAlert(result?.message || 'è¨»å†Šå¤±æ•—', 'error');
          }
        } catch (e2) {
          APP.Auth.setLoading(false);
          APP.Auth.setAlert('ç³»çµ±éŒ¯èª¤ï¼š' + e2.message, 'error');
        }
      },
      
      logout() {
        localStorage.removeItem('memberInfo');
        try { 
          if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
            liff.logout(); 
          }
        } catch (e) {}
        APP.State.memberInfo = null;
        APP.State.isAdmin = false;
        APP.Router.go('auth');
      }
    },

    // ========== è¡Œå‹•ç«¯ App è¦–åœ–ï¼ˆä¿æŒåŸæœ‰é‚è¼¯ï¼Œåªä¿®æ­£ API å‘¼å«ï¼‰ ==========
    AppView: {
      async initApp() {
        // åˆå§‹åŒ– LIFF Profile
        try {
          const prof = await APP.LIFF.profile();
          if (prof) {
            APP.State.userProfile = prof;
            const avatarEl = document.getElementById('appUserAvatar');
            const nameEl = document.getElementById('appUserName');
            const lineIdEl = document.getElementById('appUserLineId');
            
            if (avatarEl) avatarEl.src = prof.pictureUrl || 'https://via.placeholder.com/36';
            if (nameEl) nameEl.textContent = prof.displayName || 'å·²ç™»å…¥';
            if (lineIdEl) lineIdEl.textContent = prof.userId || '-';
          }
        } catch (e) {
          console.log('Profile load error:', e);
        }
        
        // æ¬Šé™è¨­å®š
        const isAdmin = !!APP.State.memberInfo?.isAdmin;
        APP.State.isAdmin = isAdmin;
        document.querySelectorAll('.admin-only').forEach(el => {
          el.style.display = isAdmin ? 'block' : 'none';
        });
        
        // ç¶å®šåº•éƒ¨å°èˆª
        document.querySelectorAll('.bottom-nav .nav-item').forEach(btn => {
          btn.onclick = () => {
            document.querySelectorAll('.bottom-nav .nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const page = btn.getAttribute('data-app-page');
            APP.AppView.switchPage(page);
          };
        });
        
        // ç¶å®šå€‹äººè³‡æ–™è¡¨å–®
        const pf = document.getElementById('profileForm');
        if (pf && !pf.dataset.bind) {
          pf.addEventListener('submit', APP.AppView.submitProfile);
          pf.dataset.bind = '1';
        }
        
        // è¼‰å…¥è³‡æ–™
        APP.AppView.loadAll();
      },
      
      switchPage(page) {
        document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
        const el = document.getElementById('app-page-' + page);
        if (el) { 
          el.classList.add('active'); 
          window.scrollTo({ top: 0, behavior: 'smooth' }); 
        }
      },
      
      async loadAll() {
        APP.Util.showLoading(true);
        try {
          await Promise.all([
            APP.AppView.loadHomeData(),
            APP.AppView.loadActivities(),
            APP.AppView.loadVolunteer(),
            APP.AppView.loadFinance(),
            APP.AppView.loadProfile()
          ]);
        } catch (e) { 
          APP.Util.toast('è³‡æ–™è¼‰å…¥å¤±æ•—ï¼š' + e.message, 'error'); 
        } finally { 
          APP.Util.showLoading(false); 
        }
      },
      
      async loadHomeData() {
        try {
          const result = await APP.API.call('getDashboardData');
          const d = result.data || {};
          
          const el1 = document.getElementById('statActivities');
          const el2 = document.getElementById('statRegistrations');
          const el3 = document.getElementById('statVolunteerHours');
          const el4 = document.getElementById('statDonations');
          
          if (el1) el1.textContent = d.totalActivities || 0;
          if (el2) el2.textContent = d.myRegistrations || 0;
          if (el3) el3.textContent = d.myVolunteerHours || 0;
          if (el4) el4.textContent = '$' + APP.Util.currency(d.myDonationAmount || 0);
          
          APP.AppView.renderRecentActivities(d.recentActivity || []);
        } catch (e) {
          console.error('loadHomeData error:', e);
        }
      },
      
      renderRecentActivities(list) {
        const c = document.getElementById('recentActivities');
        if (!c) return;
        
        if (!list.length) {
          c.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>ç›®å‰æ²’æœ‰æ´»å‹•</p></div>';
          return;
        }
        
        c.innerHTML = list.slice(0, 3).map(a => `
          <div class="activity-item">
            <div class="activity-title">${a.title}</div>
            <div class="activity-info">${a.description || ''}</div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(a.date)}</span>
              <span class="status-badge status-${a.status}">${a.status}</span>
            </div>
          </div>`).join('');
      },
      
      async loadActivities() {
        try {
          const result = await APP.API.call('getActivities');
          const list = result.data || [];
          const open = list.filter(a => a.status === 'é–‹æ”¾å ±å' || a.status === 'å ±åä¸­');
          APP.AppView.renderActivities(open);
          
          const regResult = await APP.API.call('getMyRegistrations');
          APP.AppView.renderMyRegistrations(regResult.data || []);
        } catch (e) {
          console.error('loadActivities error:', e);
        }
      },
      
      renderActivities(activities) {
        const c = document.getElementById('activitiesList');
        if (!c) return;
        
        if (!activities.length) {
          c.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>ç›®å‰æ²’æœ‰é–‹æ”¾å ±åçš„æ´»å‹•</p></div>';
          return;
        }
        
        c.innerHTML = activities.map(a => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="activity-title">${a.title}</div>
              <span class="status-badge status-${a.status}">${a.status}</span>
            </div>
            <div class="activity-info">${a.description || ''}</div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(a.date)} ${a.time || ''}</span>
              <span><i class="bi bi-geo-alt"></i>${a.location || 'æœªæŒ‡å®š'}</span>
              <span><i class="bi bi-people"></i>${a.currentCount || 0}/${a.maxParticipants}</span>
              ${a.fee ? `<span><i class="bi bi-cash"></i>$${APP.Util.currency(a.fee)}</span>` : ''}
            </div>
            <button class="btn btn-sm btn-gradient mt-2" onclick="APP.AppView.registerActivity('${a.id}')">
              <i class="bi bi-check-circle me-1"></i>æˆ‘è¦å ±å
            </button>
          </div>`).join('');
      },
      
      renderMyRegistrations(regs) {
        const c = document.getElementById('myRegistrationsList');
        if (!c) return;
        
        if (!regs.length) {
          c.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>æ‚¨é‚„æ²’æœ‰å ±åä»»ä½•æ´»å‹•</p></div>';
          return;
        }
        
        c.innerHTML = regs.map(r => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="activity-title">${r.activityTitle}</div>
              <span class="status-badge status-${r.status}">${r.status}</span>
            </div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(r.registrationTime)}</span>
            </div>
            ${r.status === 'å·²å ±å' ? `
              <button class="btn btn-sm btn-outline-danger mt-2" onclick="APP.AppView.cancelRegistration('${r.id}')">
                <i class="bi bi-x-circle me-1"></i>å–æ¶ˆå ±å
              </button>` : ''}
          </div>`).join('');
      },
      
      async registerActivity(activityId) {
        if (!confirm('ç¢ºå®šè¦å ±åæ­¤æ´»å‹•å—ï¼Ÿ')) return;
        
        try {
          APP.Util.showLoading(true);
          await APP.API.call('registerActivity', { activityId });
          APP.Util.toast('å ±åæˆåŠŸï¼', 'success');
          await APP.AppView.loadActivities();
          await APP.AppView.loadHomeData();
        } catch (e) { 
          APP.Util.toast('å ±åå¤±æ•—ï¼š' + e.message, 'error'); 
        } finally { 
          APP.Util.showLoading(false); 
        }
      },
      
      async cancelRegistration(regId) {
        if (!confirm('ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ')) return;
        
        try {
          APP.Util.showLoading(true);
          await APP.API.call('cancelRegistration', { registrationId: regId });
          APP.Util.toast('å·²å–æ¶ˆå ±å', 'success');
          await APP.AppView.loadActivities();
          await APP.AppView.loadHomeData();
        } catch (e) { 
          APP.Util.toast('å–æ¶ˆå¤±æ•—ï¼š' + e.message, 'error'); 
        } finally { 
          APP.Util.showLoading(false); 
        }
      },
      
      async loadVolunteer() {
        try {
          const result = await APP.API.call('getVolunteerData');
          const d = result.data || {};
          
          const el1 = document.getElementById('volTotalHours');
          const el2 = document.getElementById('volTotalActivities');
          
          if (el1) el1.textContent = d.stats?.totalHours || 0;
          if (el2) el2.textContent = d.stats?.totalActivities || 0;
          
          APP.AppView.renderVolunteerNeeds(d.needs || []);
          APP.AppView.renderVolunteerRecords(d.records || []);
        } catch (e) {
          console.error('loadVolunteer error:', e);
        }
      },
      
      renderVolunteerNeeds(needs) {
        const c = document.getElementById('volunteerNeedsList');
        if (!c) return;
        
        if (!needs.length) { 
          c.innerHTML = '<div class="empty-state"><i class="bi bi-people"></i><p>ç›®å‰æ²’æœ‰å¿—å·¥éœ€æ±‚</p></div>'; 
          return; 
        }
        
        c.innerHTML = needs.map(n => `
          <div class="activity-item">
            <div class="activity-title">${n.title}</div>
            <div class="activity-info">${n.description || ''}</div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(n.date)} ${n.time || ''}</span>
              <span><i class="bi bi-people"></i>éœ€æ±‚ï¼š${n.needCount}äºº</span>
              <span><i class="bi bi-clock"></i>æ™‚æ•¸ï¼š${n.hours}å°æ™‚</span>
              <span><i class="bi bi-check-circle"></i>å·²å ±åï¼š${n.currentCount || 0}äºº</span>
            </div>
            <button class="btn btn-sm btn-gradient mt-2" onclick="APP.AppView.applyVolunteer('${n.id}')">
              <i class="bi bi-hand-thumbs-up me-1"></i>æˆ‘è¦å ±å
            </button>
          </div>`).join('');
      },
      
      renderVolunteerRecords(records) {
        const c = document.getElementById('myVolunteerRecords');
        if (!c) return;
        
        if (!records.length) { 
          c.innerHTML = '<div class="empty-state"><i class="bi bi-journal-x"></i><p>æ‚¨é‚„æ²’æœ‰å¿—å·¥æœå‹™è¨˜éŒ„</p></div>'; 
          return; 
        }
        
        c.innerHTML = records.map(r => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="activity-title">${r.title}</div>
              <span class="status-badge status-${r.status}">${r.status}</span>
            </div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(r.date)}</span>
              <span><i class="bi bi-clock"></i>${r.hours}å°æ™‚</span>
            </div>
          </div>`).join('');
      },
      
      async applyVolunteer(needId) {
        if (!confirm('ç¢ºå®šè¦å ±åæ­¤å¿—å·¥æœå‹™å—ï¼Ÿ')) return;
        
        try {
          APP.Util.showLoading(true);
          await APP.API.call('applyVolunteer', { needId });
          APP.Util.toast('å ±åæˆåŠŸï¼', 'success');
          await APP.AppView.loadVolunteer();
        } catch (e) { 
          APP.Util.toast('å ±åå¤±æ•—ï¼š' + e.message, 'error'); 
        } finally { 
          APP.Util.showLoading(false); 
        }
      },
      
      async loadFinance() {
        try {
          const result = await APP.API.call('getFinanceData');
          const d = result.data || {};
          
          const el1 = document.getElementById('finTotalDonation');
          const el2 = document.getElementById('finPendingExpenses');
          
          if (el1) el1.textContent = '$' + APP.Util.currency(d.stats?.totalDonation || 0);
          if (el2) el2.textContent = d.stats?.pendingExpenses || 0;
          
          APP.AppView.renderMyDonations(d.donations || []);
          APP.AppView.renderMyExpenses(d.expenses || []);
        } catch (e) {
          console.error('loadFinance error:', e);
        }
      },
      
      renderMyDonations(ds) {
        const c = document.getElementById('myDonationsList');
        if (!c) return;
        
        if (!ds.length) { 
          c.innerHTML = '<div class="empty-state"><i class="bi bi-heart"></i><p>æ‚¨é‚„æ²’æœ‰ææ¬¾è¨˜éŒ„</p></div>'; 
          return; 
        }
        
        c.innerHTML = ds.map(d => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="activity-title">$${APP.Util.currency(d.amount)}</div>
                <div class="activity-info">${d.category || 'ä¸€èˆ¬ææ¬¾'}</div>
                <div class="activity-meta">
                  <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(d.createdAt)}</span>
                  <span class="status-badge status-${d.status}">${d.status}</span>
                </div>
              </div>
            </div>
          </div>`).join('');
      },
      
      renderMyExpenses(xs) {
        const c = document.getElementById('myExpensesList');
        if (!c) return;
        
        if (!xs.length) { 
          c.innerHTML = '<div class="empty-state"><i class="bi bi-receipt"></i><p>æ‚¨é‚„æ²’æœ‰æ”¯å‡ºç”³è«‹</p></div>'; 
          return; 
        }
        
        c.innerHTML = xs.map(x => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="activity-title">$${APP.Util.currency(x.amount)}</div>
              <span class="status-badge status-${x.status}">${x.status}</span>
            </div>
            <div class="activity-info">${x.description || ''}</div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(x.createdAt)}</span>
              <span><i class="bi bi-tag"></i>${x.category}</span>
            </div>
          </div>`).join('');
      },
      
      async loadProfile() {
        try {
          const result = await APP.API.call('getUserInfo');
          const p = result.data || {};
          const form = document.getElementById('profileForm');
          
          if (form) {
            if (form.elements.realName) form.elements.realName.value = p.realName || '';
            if (form.elements.memberType) form.elements.memberType.value = p.memberType || '';
            if (form.elements.phone) form.elements.phone.value = p.phone || '';
            if (form.elements.email) form.elements.email.value = p.email || '';
            if (form.elements.birthday) form.elements.birthday.value = APP.Util.formatDateInput(p.birthday);
            if (form.elements.diagnosisDate) form.elements.diagnosisDate.value = APP.Util.formatDateInput(p.diagnosisDate);
            if (form.elements.address) form.elements.address.value = p.address || '';
          }
          
          const typeEl = document.getElementById('appUserMemberType');
          if (typeEl) typeEl.textContent = p.memberType || '-';
          
          const recResult = await APP.API.call('getMyReceipts');
          APP.AppView.renderMyReceipts(recResult.data || []);
        } catch (e) {
          console.error('loadProfile error:', e);
        }
      },
      
      renderMyReceipts(list) {
        const c = document.getElementById('myReceiptsList');
        if (!c) return;
        
        if (!list.length) { 
          c.innerHTML = '<div class="empty-state"><i class="bi bi-file-earmark-text"></i><p>æ‚¨é‚„æ²’æœ‰æ”¶æ“š</p></div>'; 
          return; 
        }
        
        c.innerHTML = list.map(r => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="activity-title">${r.receiptNumber}</div>
                <div class="activity-meta">
                  <span><i class="bi bi-cash"></i>é‡‘é¡ï¼š$${APP.Util.currency(r.amount)}</span>
                  <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(r.issueDate)}</span>
                </div>
              </div>
              ${r.pdfUrl ? `<button class="btn btn-sm btn-gradient" onclick="window.open('${r.pdfUrl}','_blank')">
                <i class="bi bi-download"></i>ä¸‹è¼‰
              </button>` : ''}
            </div>
          </div>`).join('');
      },
      
      async submitProfile(e) {
        e.preventDefault();
        const f = e.target;
        const data = {
          realName: f.realName.value,
          memberType: f.memberType.value,
          phone: f.phone.value,
          email: f.email.value,
          birthday: f.birthday.value,
          diagnosisDate: f.diagnosisDate.value,
          address: f.address.value
        };
        
        const btn = f.querySelector('button[type="submit"]');
        APP.Util.setBtnLoading(btn, true);
        
        try {
          await APP.API.call('updateProfile', data);
          APP.Util.toast('è³‡æ–™å·²æ›´æ–°', 'success');
          await APP.AppView.loadProfile();
        } catch (e2) { 
          APP.Util.toast('æ›´æ–°å¤±æ•—ï¼š' + e2.message, 'error'); 
        } finally { 
          APP.Util.setBtnLoading(btn, false); 
        }
      },
      
      showDonationModal() {
        const html = `
          <div class="modal fade" id="donationModal" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>æˆ‘è¦ææ¬¾</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="form-floating mb-3">
                    <input type="number" class="form-control" name="amount" required min="1" />
                    <label>ææ¬¾é‡‘é¡ *</label>
                  </div>
                  <div class="form-floating mb-3">
                    <select class="form-select" name="category">
                      <option>ä¸€èˆ¬ææ¬¾</option>
                      <option>æ´»å‹•è´ŠåŠ©</option>
                    </select>
                    <label>ææ¬¾é¡åˆ¥</label>
                  </div>
                  <div class="form-floating mb-3">
                    <textarea class="form-control" name="description" style="height:80px;"></textarea>
                    <label>èªªæ˜</label>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" name="needReceipt" id="needReceipt">
                    <label class="form-check-label" for="needReceipt">éœ€è¦æ”¶æ“š</label>
                  </div>
                  <div class="alert alert-info small">è‹¥æ‚¨çš„é›»å­éƒµä»¶æœªå¡«å¯«ï¼Œæ”¶æ“šå°‡åƒ…ç”¢ç”Ÿ PDF ä¾›ä¸‹è¼‰ï¼Œä¸æœƒå¯„é€ Emailã€‚</div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                  <button type="submit" class="btn btn-gradient">ç¢ºèªææ¬¾</button>
                </div>
              </form>
            </div>
          </div>`;
        
        APP.Util.modal(html, async (fd) => {
          const data = {
            amount: fd.get('amount'),
            category: fd.get('category'),
            description: fd.get('description'),
            needReceipt: fd.get('needReceipt') === 'on'
          };
          
          const result = await APP.API.call('createDonation', data);
          APP.Util.toast('ææ¬¾è¨˜éŒ„å·²æ–°å¢ï¼Œæ„Ÿè¬æ‚¨çš„æ”¯æŒï¼', 'success');
          
          if (result?.data?.pdfUrl) {
            APP.Util.toast('å·²ç”¢ç”Ÿæ”¶æ“š PDFï¼Œè«‹è‡³ã€Œæˆ‘çš„æ”¶æ“šã€ä¸‹è¼‰', 'info');
          }
          
          await APP.AppView.loadFinance();
          await APP.AppView.loadHomeData();
        });
      },
      
      showNewExpenseModal() {
        const html = `
          <div class="modal fade" id="expenseModal" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>æ”¯å‡ºç”³è«‹</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="form-floating mb-3">
                    <input type="number" class="form-control" name="amount" required min="1"/>
                    <label>é‡‘é¡ *</label>
                  </div>
                  <div class="form-floating mb-3">
                    <select class="form-select" name="category" required>
                      <option value="">è«‹é¸æ“‡</option>
                      <option>æ´»å‹•è²»ç”¨</option>
                      <option>è¡Œæ”¿æ”¯å‡º</option>
                      <option>è¨­å‚™æ”¯å‡º</option>
                    </select>
                    <label>é¡åˆ¥ *</label>
                  </div>
                  <div class="form-floating mb-3">
                    <textarea class="form-control" name="description" required style="height:100px;"></textarea>
                    <label>èªªæ˜ *</label>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                  <button type="submit" class="btn btn-gradient">é€å‡ºç”³è«‹</button>
                </div>
              </form>
            </div>
          </div>`;
        
        APP.Util.modal(html, async (fd) => {
          const data = {
            amount: fd.get('amount'),
            category: fd.get('category'),
            description: fd.get('description')
          };
          
          await APP.API.call('createExpense', data);
          APP.Util.toast('æ”¯å‡ºç”³è«‹å·²é€å‡º', 'success');
          await APP.AppView.loadFinance();
        });
      }
    },

    // ========== æœƒå“¡ä¸­å¿ƒï¼ˆä¿æŒåŸæœ‰é‚è¼¯ï¼Œä¿®æ­£ API å‘¼å«ï¼‰ ==========
    Member: {
      selectedMood: 5,
      selectedTags: [],
      
      async initMember() {
        const info = APP.State.memberInfo;
        if (info) {
          const nameEl = document.getElementById('mc-name');
          const noEl = document.getElementById('mc-no');
          const avatarEl = document.getElementById('mc-avatar');
          
          if (nameEl) nameEl.textContent = info.name || '-';
          if (noEl) noEl.textContent = 'æœƒå“¡ç·¨è™Ÿï¼š' + (info.memberNo || '---');
          if (avatarEl) avatarEl.textContent = (info.name || 'A').charAt(0);
        }
        
        APP.Member.loadTodayReminders();
        APP.Member.loadUpcomingEvents();
      },
      
      show(section) {
        document.querySelectorAll('.member-section').forEach(s => s.classList.remove('active'));
        
        switch (section) {
          case 'home':
            document.getElementById('mc-home').classList.add('active');
            APP.Member.loadTodayReminders();
            APP.Member.loadUpcomingEvents();
            break;
          case 'symptom':
            document.getElementById('mc-symptom').classList.add('active');
            APP.Member.loadSymptomHistory();
            break;
          case 'medication':
            document.getElementById('mc-medication').classList.add('active');
            APP.Member.loadMedications();
            break;
          case 'exercise':
            document.getElementById('mc-exercise').classList.add('active');
            break;
          case 'sleep':
            document.getElementById('mc-sleep').classList.add('active');
            break;
          case 'mood':
            document.getElementById('mc-mood').classList.add('active');
            break;
          case 'events':
            document.getElementById('mc-events').classList.add('active');
            APP.Member.loadEvents();
            APP.Member.loadMyEvents();
            break;
          case 'profile':
            document.getElementById('mc-profile').classList.add('active');
            APP.Member.loadProfile();
            APP.Member.loadDonationHistory();
            break;
          default:
            document.getElementById('mc-home').classList.add('active');
        }
      },
      
      async loadTodayReminders() {
        const c = document.getElementById('mc-today-reminders');
        if (!c) return;
        
        try {
          const result = await APP.API.call('getMedications', { 
            memberId: APP.State.memberInfo?.memberId 
          });
          const arr = result.data || [];
          
          if (!arr.length) { 
            c.innerHTML = '<div class="text-center text-muted py-4">ä»Šå¤©æ²’æœ‰æé†’äº‹é …</div>'; 
            return; 
          }
          
          let html = '';
          arr.forEach(m => {
            let times = [];
            try { 
              times = JSON.parse(m.frequency || '[]'); 
            } catch {}
            
            times.forEach(t => {
              html += `
                <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                  <div>
                    <div class="fw-bold">ğŸ’Š ${m.medicineName}</div>
                    <div class="small text-muted">${t} - ${m.dosage || ''}</div>
                  </div>
                  <button class="btn btn-sm btn-primary" onclick="APP.Member.logMedication('${m.medicationId}','${t}')">å·²æœç”¨</button>
                </div>
              `;
            });
          });
          
          c.innerHTML = html;
        } catch (e) {
          c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
        }
      },
      
      async loadUpcomingEvents() {
        const c = document.getElementById('mc-upcoming-events');
        if (!c) return;
        
        try {
          const today = new Date().toISOString().split('T')[0];
          const result = await APP.API.call('getEvents', { 
            status: 'å ±åä¸­', 
            startDate: today,
            page: 1,
            pageSize: 3
          });
          const arr = result.data || [];
          
          if (!arr.length) { 
            c.innerHTML = '<div class="text-center text-muted py-4">ç›®å‰æ²’æœ‰æ´»å‹•</div>'; 
            return; 
          }
          
          c.innerHTML = arr.slice(0, 3).map(ev => `
            <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
              <div>
                <div class="fw-bold">${ev.eventName}</div>
                <div class="small text-muted">ğŸ“… ${ev.eventDate} ${ev.startTime}ã€€ğŸ“ ${ev.location}</div>
              </div>
              <span class="badge bg-info">${ev.registrationCount}/${ev.maxParticipants}</span>
            </div>
          `).join('');
        } catch (e) { 
          c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>'; 
        }
      },
      
      async addSymptom(e) {
        e.preventDefault();
        
        try {
          const result = await APP.API.call('addDailySymptom', {
            memberId: APP.State.memberInfo?.memberId,
            recordDate: new Date().toISOString().split('T')[0],
            tremorLevel: document.getElementById('mc-tremor').value,
            rigidityLevel: document.getElementById('mc-rigidity').value,
            bradykinesiaLevel: document.getElementById('mc-brady').value,
            balanceLevel: document.getElementById('mc-balance').value,
            notes: document.getElementById('mc-symptom-notes').value
          });
          
          if (result?.success) {
            APP.Util.toast('è¨˜éŒ„æˆåŠŸ', 'success');
            e.target.reset();
            APP.Member.loadSymptomHistory();
          } else { 
            APP.Util.toast(result?.message || 'æ–°å¢å¤±æ•—', 'error'); 
          }
        } catch (e2) { 
          APP.Util.toast('ç³»çµ±éŒ¯èª¤ï¼š' + e2.message, 'error'); 
        }
      },
      
      async loadSymptomHistory() {
        const c = document.getElementById('mc-symptom-history');
        if (!c) return;
        
        try {
          const end = new Date().toISOString().split('T')[0];
          const start = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
          
          const result = await APP.API.call('getDailySymptoms', { 
            memberId: APP.State.memberInfo?.memberId, 
            startDate: start, 
            endDate: end 
          });
          const arr = result.data || [];
          
          if (!arr.length) { 
            c.innerHTML = '<div class="text-center text-muted py-4">å°šç„¡è¨˜éŒ„</div>'; 
            return; 
          }
          
          c.innerHTML = arr.map(s => `
            <div class="border rounded p-2 mb-2">
              <div class="fw-bold">${s.recordDate}</div>
              <div class="small text-muted">
                é¡«æŠ–:${s.tremorLevel} | åƒµç¡¬:${s.rigidityLevel} | 
                é²ç·©:${s.bradykinesiaLevel} | å¹³è¡¡:${s.balanceLevel}
              </div>
            </div>
          `).join('');
        } catch (e) { 
          c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>'; 
        }
      },
      
      openAddMedication() {
        const html = `
          <div class="modal fade" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header">
                  <div class="modal-title">æ–°å¢ç”¨è—¥</div>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label class="form-label">è—¥ç‰©åç¨± *</label>
                    <input class="form-control" name="name" required/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">åŠ‘é‡</label>
                    <input class="form-control" name="dosage"/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label mb-2">æœç”¨æ™‚é–“ï¼ˆè‡³å°‘ä¸€å€‹ï¼‰</label><br/>
                    ${['08:00', '12:00', '18:00', '22:00'].map(t => `
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="times" value="${t}" id="t-${t}">
                        <label class="form-check-label" for="t-${t}">${t}</label>
                      </div>`).join('')}
                  </div>
                  <div class="mb-3">
                    <label class="form-label">é–‹å§‹æ—¥æœŸ</label>
                    <input type="date" class="form-control" name="startdate" value="${new Date().toISOString().split('T')[0]}"/>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" name="reminder" id="reminder" checked/>
                    <label class="form-check-label" for="reminder">å•Ÿç”¨æé†’</label>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">æå‰æé†’ï¼ˆåˆ†é˜ï¼‰</label>
                    <input type="number" class="form-control" name="advance" value="10" min="0"/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">å‚™è¨»</label>
                    <textarea class="form-control" name="notes" rows="3"></textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
                  <button class="btn btn-primary" type="submit">æ–°å¢ç”¨è—¥</button>
                </div>
              </form>
            </div>
          </div>`;
        
        APP.Util.modal(html, async (fd) => {
          const times = fd.getAll('times');
          if (!times.length) throw new Error('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æœè—¥æ™‚é–“');
          
          const result = await APP.API.call('addMedication', {
            memberId: APP.State.memberInfo?.memberId,
            medicineName: fd.get('name'),
            dosage: fd.get('dosage'),
            frequency: JSON.stringify(times),
            startDate: fd.get('startdate') || new Date().toISOString().split('T')[0],
            reminderEnabled: fd.get('reminder') === 'on',
            reminderMinutes: fd.get('advance') || 10,
            notes: fd.get('notes') || ''
          });
          
          if (result?.success) {
            APP.Util.toast('ç”¨è—¥æ–°å¢æˆåŠŸ', 'success');
            APP.Member.loadMedications();
            APP.Member.loadTodayReminders();
          }
        });
      },
      
      async loadMedications() {
        const c = document.getElementById('mc-medications-list');
        if (!c) return;
        
        try {
          const result = await APP.API.call('getMedications', { 
            memberId: APP.State.memberInfo?.memberId 
          });
          const arr = result.data || [];
          
          if (!arr.length) { 
            c.innerHTML = '<div class="text-center text-muted py-4">å°šç„¡ç”¨è—¥è³‡æ–™</div>'; 
            return; 
          }
          
          c.innerHTML = arr.map(m => {
            let times = [];
            try { times = JSON.parse(m.frequency || '[]'); } catch {}
            
            return `
              <div class="border rounded p-3 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-bold">${m.medicineName}</div>
                    <div class="small text-muted">åŠ‘é‡ï¼š${m.dosage || '-'}</div>
                    <div class="small text-muted">æ™‚é–“ï¼š${times.join(', ')}</div>
                    <div class="small text-muted">é–‹å§‹æ—¥æœŸï¼š${m.startDate}</div>
                    ${m.notes ? `<div class="small text-muted">å‚™è¨»ï¼š${m.notes}</div>` : ''}
                  </div>
                  <span class="badge ${m.reminderEnabled ? 'bg-success' : 'bg-secondary'}">
                    ${m.reminderEnabled ? 'æé†’é–‹å•Ÿ' : 'æé†’é—œé–‰'}
                  </span>
                </div>
              </div>
            `;
          }).join('');
        } catch (e) { 
          c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>'; 
        }
      },
      
      async logMedication(medicationId, scheduledTime) {
        try {
          const result = await APP.API.call('logMedication', {
            medicationId,
            memberId: APP.State.memberInfo?.memberId,
            scheduledTime,
            status: 'å·²æœç”¨'
          });
          
          if (result?.success) {
            APP.Util.toast('å·²è¨˜éŒ„æœè—¥', 'success');
            APP.Member.loadTodayReminders();
          }
        } catch (e) { 
          APP.Util.toast('è¨˜éŒ„å¤±æ•—ï¼š' + e.message, 'error'); 
        }
      },
      
      async addExercise(e) {
        e.preventDefault();
        
        try {
          const result = await APP.API.call('addExerciseLog', {
            memberId: APP.State.memberInfo?.memberId,
            exerciseDate: document.getElementById('mc-ex-date').value,
            exerciseType: document.getElementById('mc-ex-type').value,
            duration: document.getElementById('mc-ex-duration').value,
            intensity: document.getElementById('mc-ex-intensity').value,
            bodyCondition: document.getElementById('mc-ex-condition').value,
            notes: document.getElementById('mc-ex-notes').value
          });
          
          if (result?.success) {
            APP.Util.toast('é‹å‹•è¨˜éŒ„æˆåŠŸ', 'success');
            e.target.reset();
          }
        } catch (e2) { 
          APP.Util.toast('è¨˜éŒ„å¤±æ•—ï¼š' + e2.message, 'error'); 
        }
      },
      
      async addSleep(e) {
        e.preventDefault();
        
        try {
          const bedtime = document.getElementById('mc-sleep-bedtime').value;
          const waketime = document.getElementById('mc-sleep-wake').value;
          
          // è¨ˆç®—ç¡çœ æ™‚æ•¸
          const bed = new Date('2000-01-01 ' + bedtime);
          let wake = new Date('2000-01-01 ' + waketime);
          if (wake < bed) wake = new Date('2000-01-02 ' + waketime);
          const duration = ((wake - bed) / (1000 * 60 * 60)).toFixed(1);
          
          const result = await APP.API.call('addSleepLog', {
            memberId: APP.State.memberInfo?.memberId,
            sleepDate: document.getElementById('mc-sleep-date').value,
            bedtime,
            wakeTime: waketime,
            duration,
            quality: document.getElementById('mc-sleep-quality').value,
            wakeCount: document.getElementById('mc-sleep-wake-count').value,
            hasDream: document.getElementById('mc-sleep-dream').checked,
            hasNightmare: document.getElementById('mc-sleep-nightmare').checked,
            notes: document.getElementById('mc-sleep-notes').value
          });
          
          if (result?.success) {
            APP.Util.toast('ç¡çœ è¨˜éŒ„æˆåŠŸ', 'success');
            e.target.reset();
          }
        } catch (e2) { 
          APP.Util.toast('è¨˜éŒ„å¤±æ•—ï¼š' + e2.message, 'error'); 
        }
      },
      
      selectMood(score) {
        APP.Member.selectedMood = score;
        document.querySelectorAll('.mood-option').forEach(opt => {
          opt.classList.toggle('active', parseInt(opt.dataset.score) === score);
        });
      },
      
      toggleMoodTag(tag) {
        const idx = APP.Member.selectedTags.indexOf(tag);
        if (idx > -1) {
          APP.Member.selectedTags.splice(idx, 1);
        } else {
          APP.Member.selectedTags.push(tag);
        }
        
        document.querySelectorAll('.mood-tag').forEach(t => {
          t.classList.toggle('active', APP.Member.selectedTags.includes(t.dataset.tag));
        });
      },
      
      async addMood(e) {
        e.preventDefault();
        
        try {
          const result = await APP.API.call('addMoodDiary', {
            memberId: APP.State.memberInfo?.memberId,
            diaryDate: document.getElementById('mc-mood-date').value,
            moodScore: APP.Member.selectedMood,
            moodTags: APP.Member.selectedTags.join(','),
            content: document.getElementById('mc-mood-content').value
          });
          
          if (result?.success) {
            APP.Util.toast('å¿ƒæƒ…æ—¥è¨˜è¨˜éŒ„æˆåŠŸ', 'success');
            e.target.reset();
            APP.Member.selectedMood = 5;
            APP.Member.selectedTags = [];
            document.querySelectorAll('.mood-option').forEach(o => o.classList.remove('active'));
            document.querySelectorAll('.mood-tag').forEach(t => t.classList.remove('active'));
          }
        } catch (e2) { 
          APP.Util.toast('è¨˜éŒ„å¤±æ•—ï¼š' + e2.message, 'error'); 
        }
      },
      
      async loadEvents() {
        const c = document.getElementById('mc-events-list');
        if (!c) return;
        
        try {
          const result = await APP.API.call('getAllEvents');
          const arr = result.data || [];
          
          if (!arr.length) { 
            c.innerHTML = '<div class="text-center text-muted py-4">ç›®å‰æ²’æœ‰æ´»å‹•</div>'; 
            return; 
          }
          
          c.innerHTML = arr.map(ev => `
            <div class="border rounded p-3 mb-2">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="fw-bold">${ev.eventName}</div>
                <span class="badge bg-${APP.Util.getStatusClass(ev.status)}">${ev.status}</span>
              </div>
              <div class="small text-muted mb-2">${ev.description || ''}</div>
              <div class="small text-muted">
                ğŸ“… ${ev.eventDate} ${ev.startTime}-${ev.endTime}<br/>
                ğŸ“ ${ev.location}<br/>
                ğŸ‘¥ ${ev.registrationCount}/${ev.maxParticipants}
                ${ev.fee ? `<br/>ğŸ’° $${APP.Util.currency(ev.fee)}` : ''}
              </div>
              ${ev.status === 'å ±åä¸­' ? `
                <button class="btn btn-sm btn-primary mt-2" onclick="APP.Member.registerEvent('${ev.id}')">
                  ç«‹å³å ±å
                </button>` : ''}
            </div>
          `).join('');
        } catch (e) { 
          c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>'; 
        }
      },
      
      async loadMyEvents() {
        const c = document.getElementById('mc-my-events-list');
        if (!c) return;
        
        try {
          const result = await APP.API.call('getMyEvents', { 
            memberId: APP.State.memberInfo?.memberId 
          });
          const arr = result.data || [];
          
          if (!arr.length) { 
            c.innerHTML = '<div class="text-center text-muted py-4">æ‚¨é‚„æ²’æœ‰å ±åä»»ä½•æ´»å‹•</div>'; 
            return; 
          }
          
          c.innerHTML = arr.map(ev => `
            <div class="border rounded p-3 mb-2">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-bold">${ev.eventName}</div>
                  <div class="small text-muted">
                    ğŸ“… ${ev.eventDate} ${ev.startTime}<br/>
                    ğŸ“ ${ev.location}
                  </div>
                </div>
                <span class="badge bg-${APP.Util.getStatusClass(ev.registrationStatus)}">
                  ${ev.registrationStatus}
                </span>
              </div>
            </div>
          `).join('');
        } catch (e) { 
          c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>'; 
        }
      },
      
      async registerEvent(eventId) {
        if (!confirm('ç¢ºå®šè¦å ±åæ­¤æ´»å‹•å—ï¼Ÿ')) return;
        
        try {
          const result = await APP.API.call('registerActivity', { 
            activityId: eventId,
            memberId: APP.State.memberInfo?.memberId
          });
          
          if (result?.success) {
            APP.Util.toast('å ±åæˆåŠŸï¼', 'success');
            APP.Member.loadEvents();
            APP.Member.loadMyEvents();
          }
        } catch (e) { 
          APP.Util.toast('å ±åå¤±æ•—ï¼š' + e.message, 'error'); 
        }
      },
      
      async loadProfile() {
        try {
          const result = await APP.API.call('getMemberInfo', { 
            memberId: APP.State.memberInfo?.memberId 
          });
          const info = result.data || {};
          
          document.getElementById('mc-profile-name').textContent = info.name || '-';
          document.getElementById('mc-profile-no').textContent = info.memberNo || '-';
          document.getElementById('mc-profile-email').textContent = info.email || '-';
          document.getElementById('mc-profile-phone').textContent = info.phone || '-';
          document.getElementById('mc-profile-address').textContent = info.address || '-';
        } catch (e) {
          console.error('loadProfile error:', e);
        }
      },
      
      async loadDonationHistory() {
        const c = document.getElementById('mc-donation-history');
        if (!c) return;
        
        try {
          const result = await APP.API.call('getFinanceData', { 
            memberId: APP.State.memberInfo?.memberId 
          });
          const arr = result.data?.donations || [];
          
          if (!arr.length) { 
            c.innerHTML = '<div class="text-center text-muted py-4">å°šç„¡ææ¬¾è¨˜éŒ„</div>'; 
            return; 
          }
          
          c.innerHTML = arr.map(d => `
            <div class="border rounded p-2 mb-2">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="fw-bold">$${APP.Util.currency(d.amount)}</div>
                  <div class="small text-muted">${d.category} - ${APP.Util.formatDate(d.createdAt)}</div>
                </div>
                <span class="badge bg-${APP.Util.getStatusClass(d.status)}">${d.status}</span>
              </div>
            </div>
          `).join('');
        } catch (e) { 
          c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>'; 
        }
      }
    },

    // ========== ç®¡ç†å¾Œå° ==========
    Admin: {
      currentPage: 1,
      
      async initAdmin() {
        APP.Admin.show('dashboard');
      },
      
      show(section) {
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        const el = document.getElementById('admin-' + section);
        if (el) el.classList.add('active');
        
        switch (section) {
          case 'dashboard':
            APP.Admin.loadDashboard();
            break;
          case 'members':
            APP.Admin.loadMembers();
            break;
          case 'events':
            APP.Admin.loadEvents();
            break;
          case 'health':
            APP.Admin.loadHealthRecords();
            break;
          case 'donations':
            APP.Admin.loadDonations();
            break;
          case 'volunteers':
            APP.Admin.loadVolunteers();
            break;
          case 'finance':
            APP.Admin.loadFinance();
            break;
        }
      },
      
      async loadDashboard() {
        try {
          const result = await APP.API.call('getDashboardStats');
          const stats = result.data || {};
          
          document.getElementById('admin-stat-members').textContent = stats.totalMembers || 0;
          document.getElementById('admin-stat-events').textContent = stats.monthlyEvents || 0;
          document.getElementById('admin-stat-volunteers').textContent = stats.totalVolunteers || 0;
          document.getElementById('admin-stat-donations').textContent = '$' + APP.Util.currency(stats.monthlyDonations || 0);
          
          const actResult = await APP.API.call('getRecentActivities');
          APP.Admin.renderRecentActivities(actResult.data || []);
          
          const taskResult = await APP.API.call('getPendingTasks');
          APP.Admin.renderPendingTasks(taskResult.data || []);
        } catch (e) {
          console.error('loadDashboard error:', e);
        }
      },
      
      renderRecentActivities(arr) {
        const c = document.getElementById('admin-recent-activities');
        if (!c) return;
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-3">æš«ç„¡å‹•æ…‹</div>';
          return;
        }
        
        c.innerHTML = arr.map(a => `
          <div class="d-flex align-items-start mb-2 pb-2 border-bottom">
            <i class="bi bi-circle-fill text-primary me-2" style="font-size:8px;margin-top:6px;"></i>
            <div class="flex-grow-1">
              <div class="small">${a.description}</div>
              <div class="text-muted" style="font-size:11px;">${a.timestamp}</div>
            </div>
          </div>
        `).join('');
      },
      
      renderPendingTasks(arr) {
        const c = document.getElementById('admin-pending-tasks');
        if (!c) return;
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-3">æ²’æœ‰å¾…è™•ç†äº‹é …</div>';
          return;
        }
        
        c.innerHTML = arr.map(t => `
          <div class="border rounded p-2 mb-2">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-bold">${t.title}</div>
                <div class="small text-muted">${t.description}</div>
              </div>
              <span class="badge bg-${t.priority === 'é«˜' ? 'danger' : 'warning'}">${t.priority}</span>
            </div>
          </div>
        `).join('');
      },
      
      async loadMembers(page = 1, search = '', status = '') {
        APP.Admin.currentPage = page;
        const c = document.getElementById('admin-members-list');
        if (!c) return;
        
        try {
          APP.Util.showLoading(true);
          const result = await APP.API.call('getMembers', { 
            page, 
            pageSize: APP.State.pageSize, 
            search, 
            status 
          });
          const arr = result.data || [];
          const totalPages = result.totalPages || 1;
          
          if (!arr.length) {
            c.innerHTML = '<div class="text-center text-muted py-4">æŸ¥ç„¡è³‡æ–™</div>';
            return;
          }
          
          c.innerHTML = `
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>æœƒå“¡ç·¨è™Ÿ</th>
                  <th>å§“å</th>
                  <th>é›»å­éƒµä»¶</th>
                  <th>æ‰‹æ©Ÿ</th>
                  <th>è¨»å†Šæ—¥æœŸ</th>
                  <th>ç‹€æ…‹</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${arr.map(m => `
                  <tr>
                    <td>${m.memberNo}</td>
                    <td>${m.name}</td>
                    <td>${m.email}</td>
                    <td>${m.phone}</td>
                    <td>${APP.Util.formatDate(m.registerDate)}</td>
                    <td><span class="badge bg-${APP.Util.getStatusClass(m.status)}">${m.status}</span></td>
                    <td>
                      ${m.status === 'å¾…å¯©æ ¸' ? `
                        <button class="btn btn-sm btn-success" onclick="APP.Admin.approveMember('${m.memberId}')">
                          <i class="bi bi-check"></i>
                        </button>` : ''}
                      <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteMember('${m.memberId}')">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            ${APP.Admin.renderPagination(page, totalPages, 'loadMembers')}
          `;
        } catch (e) {
          c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
        } finally {
          APP.Util.showLoading(false);
        }
      },
      
      renderPagination(current, total, funcName) {
        if (total <= 1) return '';
        
        let html = '<nav class="mt-3"><ul class="pagination justify-content-center">';
        
        if (current > 1) {
          html += `<li class="page-item"><a class="page-link" href="#" onclick="APP.Admin.${funcName}(${current - 1});return false;">ä¸Šä¸€é </a></li>`;
        }
        
        for (let i = 1; i <= total; i++) {
          if (i === current) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
          } else if (i === 1 || i === total || Math.abs(i - current) <= 2) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="APP.Admin.${funcName}(${i});return false;">${i}</a></li>`;
          } else if (Math.abs(i - current) === 3) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
        }
        
        if (current < total) {
          html += `<li class="page-item"><a class="page-link" href="#" onclick="APP.Admin.${funcName}(${current + 1});return false;">ä¸‹ä¸€é </a></li>`;
        }
        
        html += '</ul></nav>';
        return html;
      },
      
      async approveMember(memberId) {
        if (!confirm('ç¢ºå®šè¦æ ¸å‡†æ­¤æœƒå“¡å—ï¼Ÿ')) return;
        
        try {
          await APP.API.call('approveMember', { memberId });
          APP.Util.toast('å·²æ ¸å‡†', 'success');
          APP.Admin.loadMembers(APP.Admin.currentPage);
        } catch (e) {
          APP.Util.toast('æ“ä½œå¤±æ•—ï¼š' + e.message, 'error');
        }
      },
      
      async deleteMember(memberId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æœƒå“¡å—ï¼Ÿ')) return;
        
        try {
          await APP.API.call('deleteMember', { memberId });
          APP.Util.toast('å·²åˆªé™¤', 'success');
          APP.Admin.loadMembers(APP.Admin.currentPage);
        } catch (e) {
          APP.Util.toast('æ“ä½œå¤±æ•—ï¼š' + e.message, 'error');
        }
      },
      
      openAddMember() {
        const html = `
          <div class="modal fade" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">æ–°å¢æœƒå“¡</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label class="form-label">å§“å *</label>
                    <input class="form-control" name="name" required/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">é›»å­éƒµä»¶ *</label>
                    <input type="email" class="form-control" name="email" required/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">æ‰‹æ©Ÿ</label>
                    <input class="form-control" name="phone"/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">åœ°å€</label>
                    <input class="form-control" name="address"/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">å‚™è¨»</label>
                    <textarea class="form-control" name="notes" rows="3"></textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                  <button type="submit" class="btn btn-primary">æ–°å¢</button>
                </div>
              </form>
            </div>
          </div>`;
        
        APP.Util.modal(html, async (fd) => {
          await APP.API.call('addMember', {
            name: fd.get('name'),
            email: fd.get('email'),
            phone: fd.get('phone'),
            address: fd.get('address'),
            notes: fd.get('notes')
          });
          APP.Util.toast('æœƒå“¡æ–°å¢æˆåŠŸ', 'success');
          APP.Admin.loadMembers();
        });
      },
      
      async loadEvents(page = 1) {
        APP.Admin.currentPage = page;
        const c = document.getElementById('admin-events-list');
        if (!c) return;
        
        try {
          APP.Util.showLoading(true);
          const result = await APP.API.call('getEvents', { 
            page, 
            pageSize: APP.State.pageSize 
          });
          const arr = result.data || [];
          const totalPages = result.totalPages || 1;
          
          if (!arr.length) {
            c.innerHTML = '<div class="text-center text-muted py-4">æŸ¥ç„¡è³‡æ–™</div>';
            return;
          }
          
          c.innerHTML = `
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>æ´»å‹•åç¨±</th>
                  <th>é¡å‹</th>
                  <th>æ—¥æœŸ</th>
                  <th>åœ°é»</th>
                  <th>äººæ•¸</th>
                  <th>ç‹€æ…‹</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${arr.map(e => `
                  <tr>
                    <td>${e.eventName}</td>
                    <td>${e.eventType}</td>
                    <td>${APP.Util.formatDate(e.eventDate)}</td>
                    <td>${e.location}</td>
                    <td>${e.registrationCount}/${e.maxParticipants}</td>
                    <td><span class="badge bg-${APP.Util.getStatusClass(e.status)}">${e.status}</span></td>
                    <td>
                      <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteEvent('${e.eventId}')">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            ${APP.Admin.renderPagination(page, totalPages, 'loadEvents')}
          `;
        } catch (e) {
          c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
        } finally {
          APP.Util.showLoading(false);
        }
      },
      
      async deleteEvent(eventId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ´»å‹•å—ï¼Ÿ')) return;
        
        try {
          await APP.API.call('deleteEvent', { eventId });
          APP.Util.toast('å·²åˆªé™¤', 'success');
          APP.Admin.loadEvents(APP.Admin.currentPage);
        } catch (e) {
          APP.Util.toast('æ“ä½œå¤±æ•—ï¼š' + e.message, 'error');
        }
      },
      
      openAddEvent() {
        const html = `
          <div class="modal fade" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">æ–°å¢æ´»å‹•</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label class="form-label">æ´»å‹•åç¨± *</label>
                    <input class="form-control" name="eventName" required/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">æ´»å‹•é¡å‹</label>
                    <select class="form-select" name="eventType">
                      <option>è¬›åº§</option>
                      <option>é‹å‹•èª²ç¨‹</option>
                      <option>è¯èª¼æ´»å‹•</option>
                      <option>å…¶ä»–</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">æ´»å‹•æ—¥æœŸ *</label>
                    <input type="date" class="form-control" name="eventDate" required/>
                  </div>
                  <div class="row mb-3">
                    <div class="col-6">
                      <label class="form-label">é–‹å§‹æ™‚é–“</label>
                      <input type="time" class="form-control" name="startTime" value="09:00"/>
                    </div>
                    <div class="col-6">
                      <label class="form-label">çµæŸæ™‚é–“</label>
                      <input type="time" class="form-control" name="endTime" value="12:00"/>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">åœ°é» *</label>
                    <input class="form-control" name="location" required/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">äººæ•¸ä¸Šé™ *</label>
                    <input type="number" class="form-control" name="maxParticipants" value="30" required/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">è²»ç”¨</label>
                    <input type="number" class="form-control" name="fee" value="0"/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">æ´»å‹•èªªæ˜</label>
                    <textarea class="form-control" name="description" rows="3"></textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                  <button type="submit" class="btn btn-primary">æ–°å¢</button>
                </div>
              </form>
            </div>
          </div>`;
        
        APP.Util.modal(html, async (fd) => {
          await APP.API.call('createEvent', {
            eventName: fd.get('eventName'),
            eventType: fd.get('eventType'),
            eventDate: fd.get('eventDate'),
            startTime: fd.get('startTime'),
            endTime: fd.get('endTime'),
            location: fd.get('location'),
            maxParticipants: fd.get('maxParticipants'),
            fee: fd.get('fee'),
            description: fd.get('description')
          });
          APP.Util.toast('æ´»å‹•æ–°å¢æˆåŠŸ', 'success');
          APP.Admin.loadEvents();
        });
      },
      
      async loadHealthRecords(page = 1) {
        APP.Admin.currentPage = page;
        const c = document.getElementById('admin-health-list');
        if (!c) return;
        
        try {
          APP.Util.showLoading(true);
          const result = await APP.API.call('getAllHealthRecords', { 
            page, 
            pageSize: APP.State.pageSize 
          });
          const arr = result.data || [];
          const totalPages = result.totalPages || 1;
          
          if (!arr.length) {
            c.innerHTML = '<div class="text-center text-muted py-4">æŸ¥ç„¡è³‡æ–™</div>';
            return;
          }
          
          c.innerHTML = `
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>æœƒå“¡å§“å</th>
                  <th>è¨˜éŒ„æ—¥æœŸ</th>
                  <th>é¡«æŠ–</th>
                  <th>åƒµç¡¬</th>
                  <th>é²ç·©</th>
                  <th>å¹³è¡¡</th>
                  <th>å‚™è¨»</th>
                </tr>
              </thead>
              <tbody>
                ${arr.map(r => `
                  <tr>
                    <td>${r.memberName}</td>
                    <td>${APP.Util.formatDate(r.recordDate)}</td>
                    <td>${r.tremorLevel}</td>
                    <td>${r.rigidityLevel}</td>
                    <td>${r.bradykinesiaLevel}</td>
                    <td>${r.balanceLevel}</td>
                    <td>${r.notes || '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            ${APP.Admin.renderPagination(page, totalPages, 'loadHealthRecords')}
          `;
        } catch (e) {
          c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
        } finally {
          APP.Util.showLoading(false);
        }
      },
      
      async loadDonations(page = 1) {
        APP.Admin.currentPage = page;
        const c = document.getElementById('admin-donations-list');
        if (!c) return;
        
        try {
          APP.Util.showLoading(true);
          const result = await APP.API.call('getDonations', { 
            page, 
            pageSize: APP.State.pageSize 
          });
          const arr = result.data || [];
          const totalPages = result.totalPages || 1;
          
          if (!arr.length) {
            c.innerHTML = '<div class="text-center text-muted py-4">æŸ¥ç„¡è³‡æ–™</div>';
            return;
          }
          
          c.innerHTML = `
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ææ¬¾äºº</th>
                  <th>é‡‘é¡</th>
                  <th>é¡å‹</th>
                  <th>æ—¥æœŸ</th>
                  <th>ä»˜æ¬¾æ–¹å¼</th>
                  <th>ç‹€æ…‹</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${arr.map(d => `
                  <tr>
                    <td>${d.donorName}</td>
                    <td>$${APP.Util.currency(d.amount)}</td>
                    <td>${d.donationType}</td>
                    <td>${APP.Util.formatDate(d.donationDate)}</td>
                    <td>${d.paymentMethod}</td>
                    <td><span class="badge bg-${APP.Util.getStatusClass(d.status)}">${d.status}</span></td>
                    <td>
                      <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteDonation('${d.donationId}')">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            ${APP.Admin.renderPagination(page, totalPages, 'loadDonations')}
          `;
        } catch (e) {
          c.innerHTML = '<div class="text-center text-danger py-4'>è¼‰å…¥å¤±æ•—</div>';
        } finally {
          APP.Util.showLoading(false);
        }
      },
      
      async deleteDonation(donationId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ææ¬¾è¨˜éŒ„å—ï¼Ÿ')) return;
        
        try {
          await APP.API.call('deleteDonation', { donationId });
          APP.Util.toast('å·²åˆªé™¤', 'success');
          APP.Admin.loadDonations(APP.Admin.currentPage);
        } catch (e) {
          APP.Util.toast('æ“ä½œå¤±æ•—ï¼š' + e.message, 'error');
        }
      },
      
      async loadVolunteers() {
        const c = document.getElementById('admin-volunteers-list');
        if (!c) return;
        
        try {
          APP.Util.showLoading(true);
          const result = await APP.API.call('getVolunteers');
          const arr = result.data || [];
          
          if (!arr.length) {
            c.innerHTML = '<div class="text-center text-muted py-4">æŸ¥ç„¡è³‡æ–™</div>';
            return;
          }
          
          c.innerHTML = `
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>å¿—å·¥ç·¨è™Ÿ</th>
                  <th>å§“å</th>
                  <th>æ‰‹æ©Ÿ</th>
                  <th>åŠ å…¥æ—¥æœŸ</th>
                  <th>ç¸½æ™‚æ•¸</th>
                  <th>ç‹€æ…‹</th>
                </tr>
              </thead>
              <tbody>
                ${arr.map(v => `
                  <tr>
                    <td>${v.volunteerNo}</td>
                    <td>${v.name}</td>
                    <td>${v.phone}</td>
                    <td>${APP.Util.formatDate(v.joinDate)}</td>
                    <td>${v.totalHours}å°æ™‚</td>
                    <td><span class="badge bg-${APP.Util.getStatusClass(v.status)}">${v.status}</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } catch (e) {
          c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
        } finally {
          APP.Util.showLoading(false);
        }
      },
      
      async loadFinance() {
        const c = document.getElementById('admin-finance-list');
        if (!c) return;
        
        try {
          APP.Util.showLoading(true);
          const result = await APP.API.call('getFinanceRecords', {});
          const data = result.data || {};
          
          document.getElementById('admin-total-income').textContent = '$' + APP.Util.currency(data.totalIncome || 0);
          document.getElementById('admin-total-expense').textContent = '$' + APP.Util.currency(data.totalExpense || 0);
          document.getElementById('admin-net-balance').textContent = '$' + APP.Util.currency((data.totalIncome || 0) - (data.totalExpense || 0));
          
          const arr = data.records || [];
          
          if (!arr.length) {
            c.innerHTML = '<div class="text-center text-muted py-4">æŸ¥ç„¡è³‡æ–™</div>';
            return;
          }
          
          c.innerHTML = `
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>æ—¥æœŸ</th>
                  <th>é¡å‹</th>
                  <th>é¡åˆ¥</th>
                  <th>é‡‘é¡</th>
                  <th>å» å•†/ææ¬¾äºº</th>
                  <th>èªªæ˜</th>
                  <th>ç‹€æ…‹</th>
                </tr>
              </thead>
              <tbody>
                ${arr.map(r => `
                  <tr>
                    <td>${APP.Util.formatDate(r.transactionDate)}</td>
                    <td><span class="badge bg-${r.type === 'æ”¶å…¥' ? 'success' : 'danger'}">${r.type}</span></td>
                    <td>${r.category}</td>
                    <td class="${r.type === 'æ”¶å…¥' ? 'text-success' : 'text-danger'}">
                      ${r.type === 'æ”¶å…¥' ? '+' : '-'}$${APP.Util.currency(r.amount)}
                    </td>
                    <td>${r.vendor || '-'}</td>
                    <td>${r.description || '-'}</td>
                    <td><span class="badge bg-${APP.Util.getStatusClass(r.status)}">${r.status}</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } catch (e) {
          c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
        } finally {
          APP.Util.showLoading(false);
        }
      }
    }
  };

  // ========== åˆå§‹åŒ– ==========
  document.addEventListener('DOMContentLoaded', async () => {
    await APP.Auth.init();
    
    // ç¶å®šå…¨åŸŸäº‹ä»¶
    const loginForm = document.getElementById('emailLoginForm');
    if (loginForm) loginForm.addEventListener('submit', APP.Auth.handleEmailLogin);
    
    const regForm = document.getElementById('registerForm');
    if (regForm) regForm.addEventListener('submit', APP.Auth.handleRegister);
    
    const symptomForm = document.getElementById('mc-symptom-form');
    if (symptomForm) symptomForm.addEventListener('submit', APP.Member.addSymptom);
    
    const exerciseForm = document.getElementById('mc-exercise-form');
    if (exerciseForm) exerciseForm.addEventListener('submit', APP.Member.addExercise);
    
    const sleepForm = document.getElementById('mc-sleep-form');
    if (sleepForm) sleepForm.addEventListener('submit', APP.Member.addSleep);
    
    const moodForm = document.getElementById('mc-mood-form');
    if (moodForm) moodForm.addEventListener('submit', APP.Member.addMood);
    
    // è¨­å®šç•¶å‰ API URL
    document.getElementById('current-api-url').textContent = APP.State.API.primary;
    document.getElementById('global-api-url').value = APP.State.API.primary;
  });

  // æš´éœ²å…¨åŸŸå‡½æ•¸ä¾› HTML onclick ä½¿ç”¨
  window.APP = APP;
  </script>
</body>
</html>


