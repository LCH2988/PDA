<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒç®¡ç†ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #00B900 0%, #00a000 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #00B900;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .tabs {
      display: flex;
      background: #f5f5f5;
      overflow-x: auto;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      flex: 1;
      min-width: 100px;
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .tab:hover {
      background: #e8e8e8;
    }

    .tab.active {
      background: white;
      color: #00B900;
      border-bottom: 3px solid #00B900;
    }

    .content {
      padding: 20px;
      min-height: 400px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #e0e0e0;
    }

    .card-header {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-body {
      color: #666;
      line-height: 1.6;
    }

    .btn {
      display: inline-block;
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      text-align: center;
    }

    .btn-primary {
      background: #00B900;
      color: white;
    }

    .btn-primary:hover {
      background: #009900;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 185, 0, 0.3);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 12px;
    }

    .btn-block {
      display: block;
      width: 100%;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
      font-size: 14px;
    }

    .form-control {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-control:focus {
      outline: none;
      border-color: #00B900;
      box-shadow: 0 0 0 3px rgba(0, 185, 0, 0.1);
    }

    .form-control:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
    }

    select.form-control {
      cursor: pointer;
    }

    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-card.green {
      background: linear-gradient(135deg, #00B900 0%, #009900 100%);
    }

    .stat-card.blue {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-card.orange {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .stat-card.red {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #dee2e6;
      font-size: 14px;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #dee2e6;
      font-size: 14px;
      color: #666;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }

    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .badge-secondary {
      background: #e2e3e5;
      color: #383d41;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-state-text {
      font-size: 18px;
      margin-bottom: 10px;
    }

    .empty-state-subtext {
      font-size: 14px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      margin: 20px;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .info-row {
      display: flex;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      flex: 0 0 120px;
      font-weight: 500;
      color: #666;
      font-size: 14px;
    }

    .info-value {
      flex: 1;
      color: #333;
      font-size: 14px;
    }

    .search-box {
      position: relative;
      margin-bottom: 20px;
    }

    .search-box input {
      padding-left: 40px;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
      font-size: 18px;
    }

    .filter-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-group select {
      flex: 1;
      min-width: 150px;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.3s;
      font-size: 16px;
    }

    .icon-btn:hover {
      background: #f0f0f0;
    }

    .icon-btn.edit {
      color: #007bff;
    }

    .icon-btn.delete {
      color: #dc3545;
    }

    .icon-btn.view {
      color: #28a745;
    }

    .profile-header {
      text-align: center;
      padding: 30px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      font-size: 48px;
      color: #667eea;
    }

    .profile-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .profile-id {
      font-size: 14px;
      opacity: 0.9;
    }

    .activity-item {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }

    .activity-item:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .activity-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    .activity-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
      font-size: 14px;
      color: #666;
    }

    .activity-meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .activity-description {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .activity-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 15px;
      border-top: 1px solid #f0f0f0;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00B900 0%, #00d000 100%);
      transition: width 0.3s;
    }

    .admin-only {
      display: none;
    }

    .admin-only.show {
      display: block;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin: 20px 0;
    }

    @media (max-width: 768px) {
      body {
        padding: 0;
      }

      .container {
        border-radius: 0;
      }

      .header h1 {
        font-size: 22px;
      }

      .tabs {
        font-size: 12px;
      }

      .tab {
        padding: 12px 8px;
        min-width: 80px;
      }

      .content {
        padding: 15px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .modal-content {
        width: 95%;
        margin: 10px;
      }

      .table-container {
        font-size: 12px;
      }

      th, td {
        padding: 8px;
      }
    }

    .fade-in {
      animation: fadeIn 0.5s;
    }

    .slide-up {
      animation: slideUp 0.5s;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¤ å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ</h1>
      <p>ç®¡ç†ç³»çµ± v1.0.0</p>
    </div>

    <div id="loadingScreen" class="loading">
      <div class="loading-spinner"></div>
      <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div id="mainContent" style="display: none;">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('home')">ğŸ  é¦–é </button>
        <button class="tab" onclick="switchTab('activities')">ğŸ“‹ æ´»å‹•</button>
        <button class="tab" onclick="switchTab('profile')">ğŸ‘¤ å€‹äºº</button>
        <button class="tab" onclick="switchTab('volunteer')">ğŸ¤ å¿—å·¥</button>
        <button class="tab admin-only" onclick="switchTab('members')">ğŸ‘¥ æˆå“¡</button>
        <button class="tab admin-only" onclick="switchTab('finance')">ğŸ’° è²¡å‹™</button>
        <button class="tab admin-only" onclick="switchTab('reports')">ğŸ“Š å ±è¡¨</button>
        <button class="tab admin-only" onclick="switchTab('settings')">âš™ï¸ è¨­å®š</button>
      </div>

      <div class="content">
        <!-- é¦–é  -->
        <div id="page-home" class="page active">
          <div class="profile-header">
            <div class="profile-avatar">ğŸ‘¤</div>
            <div class="profile-name" id="userName">è¼‰å…¥ä¸­...</div>
            <div class="profile-id" id="userRole">æœƒå“¡</div>
          </div>

          <div class="stats-grid">
            <div class="stat-card green">
              <div class="stat-value" id="stat-activities">0</div>
              <div class="stat-label">æœ¬æœˆæ´»å‹•</div>
            </div>
            <div class="stat-card blue">
              <div class="stat-value" id="stat-registrations">0</div>
              <div class="stat-label">æˆ‘çš„å ±å</div>
            </div>
            <div class="stat-card orange">
              <div class="stat-value" id="stat-volunteer-hours">0</div>
              <div class="stat-label">å¿—å·¥æ™‚æ•¸</div>
            </div>
            <div class="stat-card red admin-only">
              <div class="stat-value" id="stat-members">0</div>
              <div class="stat-label">ç¸½æœƒå“¡æ•¸</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              ğŸ“¢ æœ€æ–°æ¶ˆæ¯
            </div>
            <div class="card-body">
              <p>æ­¡è¿ä½¿ç”¨å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒç®¡ç†ç³»çµ±ï¼</p>
              <p style="margin-top: 10px;">è«‹ä½¿ç”¨ä¸Šæ–¹é¸å–®æŸ¥çœ‹æ´»å‹•ã€ç®¡ç†å€‹äººè³‡æ–™æˆ–åƒèˆ‡å¿—å·¥æœå‹™ã€‚</p>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              ğŸ¯ å¿«é€ŸåŠŸèƒ½
            </div>
            <div class="card-body">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                <button class="btn btn-primary btn-block" onclick="switchTab('activities')">æŸ¥çœ‹æ´»å‹•</button>
                <button class="btn btn-primary btn-block" onclick="switchTab('profile')">å€‹äººè³‡æ–™</button>
                <button class="btn btn-primary btn-block" onclick="switchTab('volunteer')">å¿—å·¥æœå‹™</button>
                <button class="btn btn-secondary btn-block admin-only" onclick="switchTab('members')">æˆå“¡ç®¡ç†</button>
              </div>
            </div>
          </div>
        </div>

        <!-- æ´»å‹•é é¢ -->
        <div id="page-activities" class="page">
          <div class="card">
            <div class="card-header">
              ğŸ“‹ æ´»å‹•åˆ—è¡¨
              <button class="btn btn-primary btn-sm admin-only" onclick="openActivityModal()">+ æ–°å¢æ´»å‹•</button>
            </div>
            <div class="card-body">
              <div class="filter-group">
                <select id="activity-status-filter" class="form-control" onchange="loadActivities()">
                  <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                  <option value="å ±åä¸­" selected>å ±åä¸­</option>
                  <option value="å·²çµæŸ">å·²çµæŸ</option>
                  <option value="å·²å–æ¶ˆ">å·²å–æ¶ˆ</option>
                </select>
                <select id="activity-type-filter" class="form-control" onchange="loadActivities()">
                  <option value="">æ‰€æœ‰é¡å‹</option>
                  <option value="å¥åº·è¬›åº§">å¥åº·è¬›åº§</option>
                  <option value="å¾©å¥èª²ç¨‹">å¾©å¥èª²ç¨‹</option>
                  <option value="ç¤¾äº¤æ´»å‹•">ç¤¾äº¤æ´»å‹•</option>
                  <option value="å¿—å·¥æœå‹™">å¿—å·¥æœå‹™</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
              </div>
              <div id="activities-list"></div>
            </div>
          </div>
        </div>

        <!-- å€‹äººè³‡æ–™é é¢ -->
        <div id="page-profile" class="page">
          <div class="card">
            <div class="card-header">
              ğŸ‘¤ å€‹äººè³‡æ–™
              <button class="btn btn-primary btn-sm" onclick="editProfile()">ç·¨è¼¯è³‡æ–™</button>
            </div>
            <div class="card-body" id="profile-info">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ‘¤</div>
                <div class="empty-state-text">è¼‰å…¥ä¸­...</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              ğŸ“‹ æˆ‘çš„å ±åè¨˜éŒ„
            </div>
            <div class="card-body">
              <div id="my-registrations-list"></div>
            </div>
          </div>
        </div>

        <!-- å¿—å·¥é é¢ -->
        <div id="page-volunteer" class="page">
          <div class="card">
            <div class="card-header">
              ğŸ¤ å¿—å·¥è³‡æ–™
              <button class="btn btn-primary btn-sm" id="volunteer-register-btn" onclick="registerVolunteer()">è¨»å†Šå¿—å·¥</button>
            </div>
            <div class="card-body" id="volunteer-info">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ¤</div>
                <div class="empty-state-text">è¼‰å…¥ä¸­...</div>
              </div>
            </div>
          </div>

          <div class="card" id="volunteer-hours-card" style="display: none;">
            <div class="card-header">
              â±ï¸ æœå‹™æ™‚æ•¸è¨˜éŒ„
              <button class="btn btn-primary btn-sm admin-only" onclick="openVolunteerHoursModal()">+ è¨˜éŒ„æ™‚æ•¸</button>
            </div>
            <div class="card-body">
              <div id="volunteer-hours-list"></div>
            </div>
          </div>
        </div>

        <!-- æˆå“¡ç®¡ç†é é¢ (ç®¡ç†å“¡) -->
        <div id="page-members" class="page">
          <div class="card">
            <div class="card-header">
              ğŸ‘¥ æˆå“¡ç®¡ç†
              <button class="btn btn-primary btn-sm" onclick="openMemberModal()">+ æ–°å¢æˆå“¡</button>
            </div>
            <div class="card-body">
              <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="form-control" id="member-search" placeholder="æœå°‹å§“åã€é›»è©±æˆ–æœƒå“¡ç·¨è™Ÿ..." onkeyup="searchMembers()">
              </div>
              <div class="table-container">
                <table id="members-table">
                  <thead>
                    <tr>
                      <th>æœƒå“¡ç·¨è™Ÿ</th>
                      <th>å§“å</th>
                      <th>æ€§åˆ¥</th>
                      <th>é›»è©±</th>
                      <th>åŠ å…¥æ—¥æœŸ</th>
                      <th>ç‹€æ…‹</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="members-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- è²¡å‹™ç®¡ç†é é¢ (ç®¡ç†å“¡) -->
        <div id="page-finance" class="page">
          <div class="stats-grid">
            <div class="stat-card green">
              <div class="stat-value" id="finance-income">$0</div>
              <div class="stat-label">æœ¬æœˆæ”¶å…¥</div>
            </div>
            <div class="stat-card red">
              <div class="stat-value" id="finance-expense">$0</div>
              <div class="stat-label">æœ¬æœˆæ”¯å‡º</div>
            </div>
            <div class="stat-card blue">
              <div class="stat-value" id="finance-balance">$0</div>
              <div class="stat-label">æœ¬æœˆçµé¤˜</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              ğŸ’° è²¡å‹™è¨˜éŒ„
              <button class="btn btn-primary btn-sm" onclick="openFinanceModal()">+ æ–°å¢äº¤æ˜“</button>
            </div>
            <div class="card-body">
              <div class="filter-group">
                <select id="finance-type-filter" class="form-control" onchange="loadFinance()">
                  <option value="">æ‰€æœ‰é¡å‹</option>
                  <option value="æ”¶å…¥">æ”¶å…¥</option>
                  <option value="æ”¯å‡º">æ”¯å‡º</option>
                </select>
                <select id="finance-month-filter" class="form-control" onchange="loadFinance()">
                  <option value="">é¸æ“‡æœˆä»½</option>
                </select>
              </div>
              <div class="table-container">
                <table id="finance-table">
                  <thead>
                    <tr>
                      <th>æ—¥æœŸ</th>
                      <th>é¡å‹</th>
                      <th>é¡åˆ¥</th>
                      <th>é‡‘é¡</th>
                      <th>æè¿°</th>
                      <th>ç¶“æ‰‹äºº</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="finance-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- å ±è¡¨é é¢ (ç®¡ç†å“¡) -->
        <div id="page-reports" class="page">
          <div class="card">
            <div class="card-header">
              ğŸ“Š çµ±è¨ˆå ±è¡¨
            </div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">é¸æ“‡å ±è¡¨é¡å‹</label>
                <select id="report-type" class="form-control" onchange="generateReport()">
                  <option value="">è«‹é¸æ“‡...</option>
                  <option value="member">æœƒå“¡çµ±è¨ˆ</option>
                  <option value="activity">æ´»å‹•çµ±è¨ˆ</option>
                  <option value="finance">è²¡å‹™çµ±è¨ˆ</option>
                  <option value="volunteer">å¿—å·¥çµ±è¨ˆ</option>
                </select>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">å¹´ä»½</label>
                  <select id="report-year" class="form-control"></select>
                </div>
                <div class="form-group">
                  <label class="form-label">æœˆä»½</label>
                  <select id="report-month" class="form-control">
                    <option value="">å…¨å¹´</option>
                    <option value="1">1æœˆ</option>
                    <option value="2">2æœˆ</option>
                    <option value="3">3æœˆ</option>
                    <option value="4">4æœˆ</option>
                    <option value="5">5æœˆ</option>
                    <option value="6">6æœˆ</option>
                    <option value="7">7æœˆ</option>
                    <option value="8">8æœˆ</option>
                    <option value="9">9æœˆ</option>
                    <option value="10">10æœˆ</option>
                    <option value="11">11æœˆ</option>
                    <option value="12">12æœˆ</option>
                  </select>
                </div>
              </div>
              <button class="btn btn-primary" onclick="generateReport()">ç”Ÿæˆå ±è¡¨</button>
              <div id="report-result" style="margin-top: 20px;"></div>
            </div>
          </div>
        </div>

        <!-- è¨­å®šé é¢ (ç®¡ç†å“¡) -->
        <div id="page-settings" class="page">
          <div class="card">
            <div class="card-header">
              âš™ï¸ ç³»çµ±è¨­å®š
            </div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">ç³»çµ±åç¨±</label>
                <input type="text" class="form-control" value="å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒç®¡ç†ç³»çµ±" disabled>
              </div>
              <div class="form-group">
                <label class="form-label">ç‰ˆæœ¬</label>
                <input type="text" class="form-control" value="1.0.0" disabled>
              </div>
              <div class="form-group">
                <label class="form-label">LIFF ID</label>
                <input type="text" class="form-control" id="liff-id-display" disabled>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              ğŸ” æ¬Šé™ç®¡ç†
            </div>
            <div class="card-body">
              <p>ç®¡ç†å“¡å¯ä»¥åœ¨æ­¤è¨­å®šä½¿ç”¨è€…æ¬Šé™ã€‚</p>
              <button class="btn btn-secondary" onclick="alert('æ­¤åŠŸèƒ½é–‹ç™¼ä¸­')">ç®¡ç†æ¬Šé™</button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              ğŸ“ æ“ä½œæ—¥èªŒ
            </div>
            <div class="card-body">
              <button class="btn btn-secondary" onclick="viewAuditLogs()">æŸ¥çœ‹æ—¥èªŒ</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ´»å‹•è©³æƒ…/ç·¨è¼¯ Modal -->
  <div id="activityModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="activityModalTitle">æ´»å‹•è©³æƒ…</div>
        <button class="modal-close" onclick="closeModal('activityModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <form id="activityForm">
          <input type="hidden" id="activity-id">
          <div class="form-group">
            <label class="form-label">æ´»å‹•åç¨± *</label>
            <input type="text" class="form-control" id="activity-name" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">é¡å‹ *</label>
              <select class="form-control" id="activity-type" required>
                <option value="">è«‹é¸æ“‡</option>
                <option value="å¥åº·è¬›åº§">å¥åº·è¬›åº§</option>
                <option value="å¾©å¥èª²ç¨‹">å¾©å¥èª²ç¨‹</option>
                <option value="ç¤¾äº¤æ´»å‹•">ç¤¾äº¤æ´»å‹•</option>
                <option value="å¿—å·¥æœå‹™">å¿—å·¥æœå‹™</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">ç‹€æ…‹</label>
              <select class="form-control" id="activity-status">
                <option value="å ±åä¸­">å ±åä¸­</option>
                <option value="å·²çµæŸ">å·²çµæŸ</option>
                <option value="å·²å–æ¶ˆ">å·²å–æ¶ˆ</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">æ—¥æœŸ *</label>
              <input type="date" class="form-control" id="activity-date" required>
            </div>
            <div class="form-group">
              <label class="form-label">æ™‚é–“ *</label>
              <input type="time" class="form-control" id="activity-time" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">åœ°é» *</label>
            <input type="text" class="form-control" id="activity-location" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">å ±åä¸Šé™</label>
              <input type="number" class="form-control" id="activity-max" min="0">
            </div>
            <div class="form-group">
              <label class="form-label">é ç®—</label>
              <input type="number" class="form-control" id="activity-budget" min="0">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">æ´»å‹•æè¿°</label>
            <textarea class="form-control" id="activity-description"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('activityModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveActivity()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- æˆå“¡è©³æƒ…/ç·¨è¼¯ Modal -->
  <div id="memberModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="memberModalTitle">æˆå“¡è³‡æ–™</div>
        <button class="modal-close" onclick="closeModal('memberModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <form id="memberForm">
          <input type="hidden" id="member-id">
          <div class="form-group">
            <label class="form-label">å§“å *</label>
            <input type="text" class="form-control" id="member-name" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">æ€§åˆ¥</label>
              <select class="form-control" id="member-gender">
                <option value="">è«‹é¸æ“‡</option>
                <option value="ç”·">ç”·</option>
                <option value="å¥³">å¥³</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">å‡ºç”Ÿæ—¥æœŸ</label>
              <input type="date" class="form-control" id="member-birthdate">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">é›»è©±</label>
            <input type="tel" class="form-control" id="member-phone">
          </div>
          <div class="form-group">
            <label class="form-label">LINE ID</label>
            <input type="text" class="form-control" id="member-lineid">
          </div>
          <div class="form-group">
            <label class="form-label">ç·Šæ€¥è¯çµ¡äºº</label>
            <input type="text" class="form-control" id="member-emergency-contact">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">é—œä¿‚</label>
              <input type="text" class="form-control" id="member-relationship">
            </div>
            <div class="form-group">
              <label class="form-label">ç·Šæ€¥é›»è©±</label>
              <input type="tel" class="form-control" id="member-emergency-phone">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">å¥åº·ç‹€æ³</label>
            <textarea class="form-control" id="member-health"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">ç”¨è—¥è¨˜éŒ„</label>
            <textarea class="form-control" id="member-medication"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">ç‰¹æ®Šéœ€æ±‚</label>
            <textarea class="form-control" id="member-special-needs"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">å‚™è¨»</label>
            <textarea class="form-control" id="member-notes"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('memberModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveMember()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- è²¡å‹™äº¤æ˜“ Modal -->
  <div id="financeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="financeModalTitle">æ–°å¢äº¤æ˜“</div>
        <button class="modal-close" onclick="closeModal('financeModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <form id="financeForm">
          <input type="hidden" id="transaction-id">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">é¡å‹ *</label>
              <select class="form-control" id="transaction-type" required>
                <option value="">è«‹é¸æ“‡</option>
                <option value="æ”¶å…¥">æ”¶å…¥</option>
                <option value="æ”¯å‡º">æ”¯å‡º</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">æ—¥æœŸ *</label>
              <input type="date" class="form-control" id="transaction-date" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">é¡åˆ¥ *</label>
            <input type="text" class="form-control" id="transaction-category" required placeholder="ä¾‹ï¼šæœƒè²»ã€ææ¬¾ã€æ´»å‹•è²»ç”¨">
          </div>
          <div class="form-group">
            <label class="form-label">é‡‘é¡ *</label>
            <input type="number" class="form-control" id="transaction-amount" min="0" step="1" required>
          </div>
          <div class="form-group">
            <label class="form-label">ä»˜æ¬¾æ–¹å¼</label>
            <select class="form-control" id="transaction-payment">
              <option value="">è«‹é¸æ“‡</option>
              <option value="ç¾é‡‘">ç¾é‡‘</option>
              <option value="è½‰å¸³">è½‰å¸³</option>
              <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
              <option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">æ†‘è­‰ç·¨è™Ÿ</label>
            <input type="text" class="form-control" id="transaction-receipt">
          </div>
          <div class="form-group">
            <label class="form-label">æè¿° *</label>
            <textarea class="form-control" id="transaction-description" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('financeModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveTransaction()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- å¿—å·¥æ™‚æ•¸è¨˜éŒ„ Modal -->
  <div id="volunteerHoursModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">è¨˜éŒ„å¿—å·¥æ™‚æ•¸</div>
        <button class="modal-close" onclick="closeModal('volunteerHoursModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <form id="volunteerHoursForm">
          <div class="form-group">
            <label class="form-label">å¿—å·¥ *</label>
            <select class="form-control" id="hours-volunteer-id" required>
              <option value="">è«‹é¸æ“‡å¿—å·¥</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">æœå‹™æ—¥æœŸ *</label>
            <input type="date" class="form-control" id="hours-service-date" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">é–‹å§‹æ™‚é–“ *</label>
              <input type="time" class="form-control" id="hours-start-time" required>
            </div>
            <div class="form-group">
              <label class="form-label">çµæŸæ™‚é–“ *</label>
              <input type="time" class="form-control" id="hours-end-time" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">æœå‹™æ™‚æ•¸ *</label>
            <input type="number" class="form-control" id="hours-total" min="0" step="0.5" required>
          </div>
          <div class="form-group">
            <label class="form-label">æ´»å‹•åç¨±</label>
            <input type="text" class="form-control" id="hours-activity-name">
          </div>
          <div class="form-group">
            <label class="form-label">è©•åˆ† (1-5)</label>
            <select class="form-control" id="hours-rating">
              <option value="">æœªè©•åˆ†</option>
              <option value="5">5 - å„ªç§€</option>
              <option value="4">4 - è‰¯å¥½</option>
              <option value="3">3 - æ™®é€š</option>
              <option value="2">2 - å¾…æ”¹é€²</option>
              <option value="1">1 - ä¸ä½³</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">è©•èª</label>
            <textarea class="form-control" id="hours-comment"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('volunteerHoursModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveVolunteerHours()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== å…¨åŸŸè®Šæ•¸ ====================
    const CONFIG = {
      LIFF_ID: 'YOUR_LIFF_ID',
      GAS_URL: 'YOUR_GAS_WEB_APP_URL'
    };

    let currentUser = null;
    let currentMember = null;
    let currentVolunteer = null;
    let isAdmin = false;
    let allMembers = [];
    let allActivities = [];
    let allTransactions = [];
    let allVolunteers = [];

    // ==================== LIFF åˆå§‹åŒ– ====================
    window.onload = async function() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        currentUser = {
          userId: profile.userId,
          displayName: profile.displayName,
          pictureUrl: profile.pictureUrl
        };

        await initializeApp();
      } catch (error) {
        console.error('LIFFåˆå§‹åŒ–å¤±æ•—:', error);
        showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
      }
    };

    // ==================== æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ– ====================
    async function initializeApp() {
      try {
        // æª¢æŸ¥ä½¿ç”¨è€…è§’è‰²
        const roleData = await apiGet('getUserRole', { checkUserId: currentUser.userId });
        const adminData = await apiGet('isAdmin', { checkUserId: currentUser.userId });
        isAdmin = adminData.isAdmin;

        // è¼‰å…¥æœƒå“¡è³‡æ–™
        const memberData = await apiGet('getMemberByLineId', { lineId: currentUser.userId });
        currentMember = memberData;

        // è¼‰å…¥å¿—å·¥è³‡æ–™
        const volunteerData = await apiGet('getVolunteerByLineId', { lineId: currentUser.userId });
        currentVolunteer = volunteerData;

        // æ›´æ–°UI
        updateUserInfo();
        await loadDashboard();
        
        // é¡¯ç¤ºç®¡ç†å“¡åŠŸèƒ½
        if (isAdmin) {
          document.querySelectorAll('.admin-only').forEach(el => {
            el.classList.add('show');
            el.style.display = '';
          });
        }

        // åˆå§‹åŒ–å¹´ä»½é¸æ“‡å™¨
        initializeYearSelector();
        initializeMonthSelector();

        // éš±è—è¼‰å…¥ç•«é¢
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

        // æª¢æŸ¥URLåƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page');
        const id = urlParams.get('id');
        
        if (page) {
          switchTab(page);
          if (page === 'activity' && id) {
            viewActivity(id);
          }
        }

      } catch (error) {
        console.error('åˆå§‹åŒ–å¤±æ•—:', error);
        showError('è¼‰å…¥è³‡æ–™å¤±æ•—');
      }
    }

    // ==================== API å‘¼å«å‡½æ•¸ ====================
    async function apiGet(action, params = {}) {
      const url = new URL(CONFIG.GAS_URL);
      url.searchParams.append('action', action);
      url.searchParams.append('userId', currentUser.userId);
      
      Object.keys(params).forEach(key => {
        if (params[key] !== null && params[key] !== undefined) {
          url.searchParams.append(key, params[key]);
        }
      });

      const response = await fetch(url);
      const result = await response.json();
      
      if (!result.success && result.error) {
        throw new Error(result.error);
      }
      
      return result.data;
    }

    async function apiPost(action, data) {
      const url = `${CONFIG.GAS_URL}?action=${action}&userId=${currentUser.userId}`;
      
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error || 'æ“ä½œå¤±æ•—');
      }
      
      return result.data;
    }

    // ==================== UI æ›´æ–°å‡½æ•¸ ====================
    function updateUserInfo() {
      const userName = currentMember ? currentMember['å§“å'] : currentUser.displayName;
      const userRole = isAdmin ? 'ç®¡ç†å“¡' : 'æœƒå“¡';
      
      document.getElementById('userName').textContent = userName;
      document.getElementById('userRole').textContent = userRole;
    }

    async function loadDashboard() {
      try {
        // è¼‰å…¥çµ±è¨ˆæ•¸æ“š
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;

        // æœ¬æœˆæ´»å‹•æ•¸
        const activities = await apiGet('getActivities', {
          status: 'å ±åä¸­'
        });
        document.getElementById('stat-activities').textContent = activities.length;

        // æˆ‘çš„å ±åæ•¸
        if (currentMember) {
          const registrations = await apiGet('getMemberRegistrations', {
            memberId: currentMember['æˆå“¡ID']
          });
          document.getElementById('stat-registrations').textContent = registrations.length;
        }

        // å¿—å·¥æ™‚æ•¸
        if (currentVolunteer) {
          const summary = await apiGet('getVolunteerSummary', {
            volunteerId: currentVolunteer['å¿—å·¥ID']
          });
          document.getElementById('stat-volunteer-hours').textContent = summary.totalHours;
        }

        // ç®¡ç†å“¡çµ±è¨ˆ
        if (isAdmin) {
          const memberStats = await apiGet('getMemberStats');
          document.getElementById('stat-members').textContent = memberStats.total;
        }

      } catch (error) {
        console.error('è¼‰å…¥å„€è¡¨æ¿å¤±æ•—:', error);
      }
    }

    // ==================== é é¢åˆ‡æ› ====================
    function switchTab(tabName) {
      // æ›´æ–°æ¨™ç±¤
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      // æ›´æ–°é é¢
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(`page-${tabName}`).classList.add('active');

      // è¼‰å…¥å°æ‡‰è³‡æ–™
      switch(tabName) {
        case 'activities':
          loadActivities();
          break;
        case 'profile':
          loadProfile();
          break;
        case 'volunteer':
          loadVolunteer();
          break;
        case 'members':
          if (isAdmin) loadMembers();
          break;
        case 'finance':
          if (isAdmin) loadFinance();
          break;
      }
    }

    // ==================== æ´»å‹•ç®¡ç† ====================
    async function loadActivities() {
      try {
        const statusFilter = document.getElementById('activity-status-filter').value;
        const typeFilter = document.getElementById('activity-type-filter').value;

        const activities = await apiGet('getActivities', {
          status: statusFilter || undefined,
          type: typeFilter || undefined
        });

        allActivities = activities;
        displayActivities(activities);
      } catch (error) {
        console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', error);
        showError('è¼‰å…¥æ´»å‹•å¤±æ•—');
      }
    }

    function displayActivities(activities) {
      const container = document.getElementById('activities-list');
      
      if (activities.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <div class="empty-state-text">ç›®å‰æ²’æœ‰æ´»å‹•</div>
          </div>
        `;
        return;
      }

      container.innerHTML = activities.map(activity => {
        const progress = activity['å ±åä¸Šé™'] > 0 ? 
          (activity['ç›®å‰å ±åæ•¸'] / activity['å ±åä¸Šé™'] * 100).toFixed(0) : 0;
        
        const statusBadge = activity['ç‹€æ…‹'] === 'å ±åä¸­' ? 'badge-success' : 
                            activity['ç‹€æ…‹'] === 'å·²çµæŸ' ? 'badge-secondary' : 'badge-danger';

        return `
          <div class="activity-item">
            <div class="activity-title">${activity['æ´»å‹•åç¨±']}</div>
            <div class="activity-meta">
              <div class="activity-meta-item">
                <span>ğŸ“…</span>
                <span>${activity['æ—¥æœŸ']} ${activity['æ™‚é–“']}</span>
              </div>
              <div class="activity-meta-item">
                <span>ğŸ“</span>
                <span>${activity['åœ°é»']}</span>
              </div>
              <div class="activity-meta-item">
                <span>ğŸ‘¥</span>
                <span>${activity['ç›®å‰å ±åæ•¸']}/${activity['å ±åä¸Šé™'] || 'ä¸é™'} äºº</span>
              </div>
              <span class="badge ${statusBadge}">${activity['ç‹€æ…‹']}</span>
            </div>
            ${activity['æè¿°'] ? `<div class="activity-description">${activity['æè¿°']}</div>` : ''}
            ${activity['å ±åä¸Šé™'] > 0 ? `
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%"></div>
              </div>
            ` : ''}
            <div class="activity-footer">
              <div></div>
              <div class="action-buttons">
                ${isAdmin ? `
                  <button class="btn btn-sm btn-secondary" onclick="editActivity('${activity['æ´»å‹•ID']}')">ç·¨è¼¯</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteActivity('${activity['æ´»å‹•ID']}')">åˆªé™¤</button>
                ` : ''}
                ${activity['ç‹€æ…‹'] === 'å ±åä¸­' && currentMember ? `
                  <button class="btn btn-sm btn-primary" onclick="registerForActivity('${activity['æ´»å‹•ID']}')">ç«‹å³å ±å</button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function openActivityModal(activityId = null) {
      const modal = document.getElementById('activityModal');
      const title = document.getElementById('activityModalTitle');
      const form = document.getElementById('activityForm');
      
      form.reset();
      
      if (activityId) {
        title.textContent = 'ç·¨è¼¯æ´»å‹•';
        const activity = allActivities.find(a => a['æ´»å‹•ID'] === activityId);
        if (activity) {
          document.getElementById('activity-id').value = activity['æ´»å‹•ID'];
          document.getElementById('activity-name').value = activity['æ´»å‹•åç¨±'];
          document.getElementById('activity-type').value = activity['é¡å‹'];
          document.getElementById('activity-status').value = activity['ç‹€æ…‹'];
          document.getElementById('activity-date').value = activity['æ—¥æœŸ'];
          document.getElementById('activity-time').value = activity['æ™‚é–“'];
          document.getElementById('activity-location').value = activity['åœ°é»'];
          document.getElementById('activity-max').value = activity['å ±åä¸Šé™'];
          document.getElementById('activity-budget').value = activity['é ç®—'];
          document.getElementById('activity-description').value = activity['æè¿°'];
        }
      } else {
        title.textContent = 'æ–°å¢æ´»å‹•';
        document.getElementById('activity-status').value = 'å ±åä¸­';
      }
      
      modal.classList.add('active');
    }

    function editActivity(activityId) {
      openActivityModal(activityId);
    }

    async function saveActivity() {
      try {
        const activityId = document.getElementById('activity-id').value;
        const data = {
          name: document.getElementById('activity-name').value,
          type: document.getElementById('activity-type').value,
          date: document.getElementById('activity-date').value,
          time: document.getElementById('activity-time').value,
          location: document.getElementById('activity-location').value,
          maxParticipants: document.getElementById('activity-max').value,
          budget: document.getElementById('activity-budget').value,
          description: document.getElementById('activity-description').value,
          organizer: currentMember ? currentMember['å§“å'] : currentUser.displayName
        };

        if (activityId) {
          data.activityId = activityId;
          data['ç‹€æ…‹'] = document.getElementById('activity-status').value;
          await apiPost('updateActivity', data);
          showSuccess('æ´»å‹•æ›´æ–°æˆåŠŸ');
        } else {
          await apiPost('createActivity', data);
          showSuccess('æ´»å‹•æ–°å¢æˆåŠŸ');
        }

        closeModal('activityModal');
        loadActivities();
      } catch (error) {
        console.error('å„²å­˜æ´»å‹•å¤±æ•—:', error);
        showError(error.message || 'å„²å­˜å¤±æ•—');
      }
    }

    async function deleteActivity(activityId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ´»å‹•å—ï¼Ÿ')) return;

      try {
        await apiPost('deleteActivity', { activityId });
        showSuccess('æ´»å‹•å·²åˆªé™¤');
        loadActivities();
      } catch (error) {
        console.error('åˆªé™¤æ´»å‹•å¤±æ•—:', error);
        showError('åˆªé™¤å¤±æ•—');
      }
    }

    async function registerForActivity(activityId) {
      if (!currentMember) {
        showError('è«‹å…ˆå®Œæˆæœƒå“¡è¨»å†Š');
        return;
      }

      try {
        await apiPost('registerActivity', {
          activityId: activityId,
          memberId: currentMember['æˆå“¡ID'],
          memberName: currentMember['å§“å']
        });
        showSuccess('å ±åæˆåŠŸï¼');
        loadActivities();
        loadDashboard();
      } catch (error) {
        console.error('å ±åå¤±æ•—:', error);
        showError(error.message || 'å ±åå¤±æ•—');
      }
    }

    // ==================== å€‹äººè³‡æ–™ç®¡ç† ====================
    async function loadProfile() {
      try {
        if (!currentMember) {
          document.getElementById('profile-info').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ‘¤</div>
              <div class="empty-state-text">å°šæœªå»ºç«‹æœƒå“¡è³‡æ–™</div>
              <div class="empty-state-subtext">è«‹è¯çµ¡ç®¡ç†å“¡å”åŠ©å»ºç«‹</div>
            </div>
          `;
          return;
        }

        const html = `
          <div class="info-row">
            <div class="info-label">æœƒå“¡ç·¨è™Ÿ</div>
            <div class="info-value">${currentMember['æˆå“¡ID']}</div>
          </div>
          <div class="info-row">
            <div class="info-label">å§“å</div>
            <div class="info-value">${currentMember['å§“å']}</div>
          </div>
          <div class="info-row">
            <div class="info-label">æ€§åˆ¥</div>
            <div class="info-value">${currentMember['æ€§åˆ¥'] || '-'}</div>
          </div>
          <div class="info-row">
            <div class="info-label">å‡ºç”Ÿæ—¥æœŸ</div>
            <div class="info-value">${currentMember['å‡ºç”Ÿæ—¥æœŸ'] || '-'}</div>
          </div>
          <div class="info-row">
            <div class="info-label">é›»è©±</div>
            <div class="info-value">${currentMember['é›»è©±'] || '-'}</div>
          </div>
          <div class="info-row">
            <div class="info-label">ç·Šæ€¥è¯çµ¡äºº</div>
            <div class="info-value">${currentMember['ç·Šæ€¥è¯çµ¡äºº'] || '-'} (${currentMember['é—œä¿‚'] || '-'})</div>
          </div>
          <div class="info-row">
            <div class="info-label">ç·Šæ€¥é›»è©±</div>
            <div class="info-value">${currentMember['ç·Šæ€¥é›»è©±'] || '-'}</div>
          </div>
          <div class="info-row">
            <div class="info-label">åŠ å…¥æ—¥æœŸ</div>
            <div class="info-value">${currentMember['åŠ å…¥æ—¥æœŸ']}</div>
          </div>
          <div class="info-row">
            <div class="info-label">ç‹€æ…‹</div>
            <div class="info-value">
              <span class="badge ${currentMember['ç‹€æ…‹'] === 'å•Ÿç”¨' ? 'badge-success' : 'badge-danger'}">
                ${currentMember['ç‹€æ…‹']}
              </span>
            </div>
          </div>
        `;

        document.getElementById('profile-info').innerHTML = html;

        // è¼‰å…¥å ±åè¨˜éŒ„
        const registrations = await apiGet('getMemberRegistrations', {
          memberId: currentMember['æˆå“¡ID']
        });

        displayRegistrations(registrations);

      } catch (error) {
        console.error('è¼‰å…¥å€‹äººè³‡æ–™å¤±æ•—:', error);
        showError('è¼‰å…¥è³‡æ–™å¤±æ•—');
      }
    }

    function displayRegistrations(registrations) {
      const container = document.getElementById('my-registrations-list');
      
      if (registrations.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <div class="empty-state-text">å°šç„¡å ±åè¨˜éŒ„</div>
          </div>
        `;
        return;
      }

      const html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>æ´»å‹•åç¨±</th>
                <th>å ±åæ™‚é–“</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${registrations.map(reg => `
                <tr>
                  <td>${reg['æ´»å‹•åç¨±']}</td>
                  <td>${reg['å ±åæ™‚é–“']}</td>
                  <td>
                    <span class="badge ${reg['åƒåŠ ç‹€æ…‹'] === 'å·²ç°½åˆ°' ? 'badge-success' : 'badge-info'}">
                      ${reg['åƒåŠ ç‹€æ…‹']}
                    </span>
                  </td>
                  <td>
                    ${reg['åƒåŠ ç‹€æ…‹'] === 'å·²å ±å' ? `
                      <button class="btn btn-sm btn-danger" onclick="cancelRegistration('${reg['å ±åID']}')">å–æ¶ˆå ±å</button>
                    ` : '-'}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = html;
    }

    function editProfile() {
      if (!isAdmin) {
        showError('è«‹è¯çµ¡ç®¡ç†å“¡ä¿®æ”¹è³‡æ–™');
        return;
      }
      openMemberModal(currentMember['æˆå“¡ID']);
    }

    async function cancelRegistration(registrationId) {
      if (!confirm('ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ')) return;

      try {
        await apiPost('cancelRegistration', { registrationId });
        showSuccess('å·²å–æ¶ˆå ±å');
        loadProfile();
        loadDashboard();
      } catch (error) {
        console.error('å–æ¶ˆå ±åå¤±æ•—:', error);
        showError('å–æ¶ˆå¤±æ•—');
      }
    }

    // ==================== å¿—å·¥ç®¡ç† ====================
    async function loadVolunteer() {
      try {
        if (!currentVolunteer) {
          document.getElementById('volunteer-info').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ¤</div>
              <div class="empty-state-text">å°šæœªè¨»å†Šç‚ºå¿—å·¥</div>
              <div class="empty-state-subtext">é»æ“Šå³ä¸Šè§’æŒ‰éˆ•è¨»å†Š</div>
            </div>
          `;
          document.getElementById('volunteer-hours-card').style.display = 'none';
          return;
        }

        const summary = await apiGet('getVolunteerSummary', {
          volunteerId: currentVolunteer['å¿—å·¥ID']
        });

        const html = `
          <div class="info-row">
            <div class="info-label">å¿—å·¥ç·¨è™Ÿ</div>
            <div class="info-value">${currentVolunteer['å¿—å·¥ID']}</div>
          </div>
          <div class="info-row">
            <div class="info-label">å§“å</div>
            <div class="info-value">${currentVolunteer['å§“å']}</div>
          </div>
          <div class="info-row">
            <div class="info-label">å°ˆé•·</div>
            <div class="info-value">${currentVolunteer['å°ˆé•·'] || '-'}</div>
          </div>
          <div class="info-row">
            <div class="info-label">ç¸½æœå‹™æ™‚æ•¸</div>
            <div class="info-value"><strong>${summary.totalHours}</strong> å°æ™‚</div>
          </div>
          <div class="info-row">
            <div class="info-label">æœå‹™æ¬¡æ•¸</div>
            <div class="info-value">${summary.serviceCount} æ¬¡</div>
          </div>
          <div class="info-row">
            <div class="info-label">å¹³å‡è©•åˆ†</div>
            <div class="info-value">${summary.averageRating} â­</div>
          </div>
          <div class="info-row">
            <div class="info-label">åŠ å…¥æ—¥æœŸ</div>
            <div class="info-value">${currentVolunteer['åŠ å…¥æ—¥æœŸ']}</div>
          </div>
          <div class="info-row">
            <div class="info-label">ç‹€æ…‹</div>
            <div class="info-value">
              <span class="badge ${currentVolunteer['ç‹€æ…‹'] === 'å•Ÿç”¨' ? 'badge-success' : 'badge-danger'}">
                ${currentVolunteer['ç‹€æ…‹']}
              </span>
            </div>
          </div>
        `;

        document.getElementById('volunteer-info').innerHTML = html;
        document.getElementById('volunteer-register-btn').style.display = 'none';
        document.getElementById('volunteer-hours-card').style.display = 'block';

        // è¼‰å…¥æœå‹™è¨˜éŒ„
        displayVolunteerHours(summary.records);

      } catch (error) {
        console.error('è¼‰å…¥å¿—å·¥è³‡æ–™å¤±æ•—:', error);
        showError('è¼‰å…¥è³‡æ–™å¤±æ•—');
      }
    }

    function displayVolunteerHours(hours) {
      const container = document.getElementById('volunteer-hours-list');
      
      if (hours.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">â±ï¸</div>
            <div class="empty-state-text">å°šç„¡æœå‹™è¨˜éŒ„</div>
          </div>
        `;
        return;
      }

      const html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>æœå‹™æ—¥æœŸ</th>
                <th>æ´»å‹•åç¨±</th>
                <th>æœå‹™æ™‚æ•¸</th>
                <th>è©•åˆ†</th>
                <th>è©•èª</th>
              </tr>
            </thead>
            <tbody>
              ${hours.map(h => `
                <tr>
                  <td>${h['æœå‹™æ—¥æœŸ']}</td>
                  <td>${h['æ´»å‹•åç¨±'] || '-'}</td>
                  <td>${h['æœå‹™æ™‚æ•¸']} å°æ™‚</td>
                  <td>${h['è©•åˆ†'] ? h['è©•åˆ†'] + ' â­' : '-'}</td>
                  <td>${h['è©•èª'] || '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = html;
    }

    function registerVolunteer() {
      showError('è«‹è¯çµ¡ç®¡ç†å“¡å”åŠ©è¨»å†Šå¿—å·¥');
    }

    async function openVolunteerHoursModal() {
      const modal = document.getElementById('volunteerHoursModal');
      const form = document.getElementById('volunteerHoursForm');
      form.reset();

      // è¼‰å…¥å¿—å·¥åˆ—è¡¨
      try {
        const volunteers = await apiGet('getVolunteers', { status: 'å•Ÿç”¨' });
        const select = document.getElementById('hours-volunteer-id');
        select.innerHTML = '<option value="">è«‹é¸æ“‡å¿—å·¥</option>' + 
          volunteers.map(v => `<option value="${v['å¿—å·¥ID']}">${v['å§“å']}</option>`).join('');
        
        // è¨­å®šä»Šå¤©æ—¥æœŸ
        document.getElementById('hours-service-date').valueAsDate = new Date();
        
        modal.classList.add('active');
      } catch (error) {
        console.error('è¼‰å…¥å¿—å·¥åˆ—è¡¨å¤±æ•—:', error);
        showError('è¼‰å…¥å¤±æ•—');
      }
    }

    async function saveVolunteerHours() {
      try {
        const volunteerId = document.getElementById('hours-volunteer-id').value;
        const volunteerName = document.getElementById('hours-volunteer-id').selectedOptions[0].text;
        
        const data = {
          volunteerId: volunteerId,
          volunteerName: volunteerName,
          serviceDate: document.getElementById('hours-service-date').value,
          startTime: document.getElementById('hours-start-time').value,
          endTime: document.getElementById('hours-end-time').value,
          hours: document.getElementById('hours-total').value,
          activityName: document.getElementById('hours-activity-name').value,
          rating: document.getElementById('hours-rating').value,
          comment: document.getElementById('hours-comment').value
        };

        await apiPost('recordVolunteerHours', data);
        showSuccess('æ™‚æ•¸è¨˜éŒ„æˆåŠŸ');
        closeModal('volunteerHoursModal');
        loadVolunteer();
      } catch (error) {
        console.error('è¨˜éŒ„æ™‚æ•¸å¤±æ•—:', error);
        showError(error.message || 'è¨˜éŒ„å¤±æ•—');
      }
    }

    // ==================== æˆå“¡ç®¡ç† (ç®¡ç†å“¡) ====================
    async function loadMembers() {
      try {
        const members = await apiGet('getMembers');
        allMembers = members;
        displayMembers(members);
      } catch (error) {
        console.error('è¼‰å…¥æˆå“¡å¤±æ•—:', error);
        showError('è¼‰å…¥æˆå“¡å¤±æ•—');
      }
    }

    function displayMembers(members) {
      const tbody = document.getElementById('members-tbody');
      
      if (members.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">
              <div class="empty-state-text">å°šç„¡æˆå“¡è³‡æ–™</div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = members.map(member => `
        <tr>
          <td>${member['æˆå“¡ID']}</td>
          <td>${member['å§“å']}</td>
          <td>${member['æ€§åˆ¥'] || '-'}</td>
          <td>${member['é›»è©±'] || '-'}</td>
          <td>${member['åŠ å…¥æ—¥æœŸ']}</td>
          <td>
            <span class="badge ${member['ç‹€æ…‹'] === 'å•Ÿç”¨' ? 'badge-success' : 'badge-danger'}">
              ${member['ç‹€æ…‹']}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="icon-btn view" onclick="viewMember('${member['æˆå“¡ID']}')" title="æŸ¥çœ‹">ğŸ‘ï¸</button>
              <button class="icon-btn edit" onclick="openMemberModal('${member['æˆå“¡ID']}')" title="ç·¨è¼¯">âœï¸</button>
              <button class="icon-btn delete" onclick="deleteMember('${member['æˆå“¡ID']}')" title="åˆªé™¤">ğŸ—‘ï¸</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function searchMembers() {
      const keyword = document.getElementById('member-search').value.toLowerCase();
      const filtered = allMembers.filter(m => 
        (m['å§“å'] && m['å§“å'].toLowerCase().includes(keyword)) ||
        (m['é›»è©±'] && m['é›»è©±'].includes(keyword)) ||
        (m['æˆå“¡ID'] && m['æˆå“¡ID'].toLowerCase().includes(keyword))
      );
      displayMembers(filtered);
    }

    function openMemberModal(memberId = null) {
      const modal = document.getElementById('memberModal');
      const title = document.getElementById('memberModalTitle');
      const form = document.getElementById('memberForm');
      
      form.reset();
      
      if (memberId) {
        title.textContent = 'ç·¨è¼¯æˆå“¡';
        const member = allMembers.find(m => m['æˆå“¡ID'] === memberId);
        if (member) {
          document.getElementById('member-id').value = member['æˆå“¡ID'];
          document.getElementById('member-name').value = member['å§“å'];
          document.getElementById('member-gender').value = member['æ€§åˆ¥'];
          document.getElementById('member-birthdate').value = member['å‡ºç”Ÿæ—¥æœŸ'];
          document.getElementById('member-phone').value = member['é›»è©±'];
          document.getElementById('member-lineid').value = member['LINE ID'];
          document.getElementById('member-emergency-contact').value = member['ç·Šæ€¥è¯çµ¡äºº'];
          document.getElementById('member-relationship').value = member['é—œä¿‚'];
          document.getElementById('member-emergency-phone').value = member['ç·Šæ€¥é›»è©±'];
          document.getElementById('member-health').value = member['å¥åº·ç‹€æ³'];
          document.getElementById('member-medication').value = member['ç”¨è—¥è¨˜éŒ„'];
          document.getElementById('member-special-needs').value = member['ç‰¹æ®Šéœ€æ±‚'];
          document.getElementById('member-notes').value = member['å‚™è¨»'];
        }
      } else {
        title.textContent = 'æ–°å¢æˆå“¡';
      }
      
      modal.classList.add('active');
    }

    function viewMember(memberId) {
      openMemberModal(memberId);
      // è¨­å®šæ‰€æœ‰æ¬„ä½ç‚ºå”¯è®€
      document.querySelectorAll('#memberForm input, #memberForm select, #memberForm textarea').forEach(el => {
        el.disabled = true;
      });
      document.querySelector('#memberModal .modal-footer').style.display = 'none';
    }

    async function saveMember() {
      try {
        const memberId = document.getElementById('member-id').value;
        const data = {
          name: document.getElementById('member-name').value,
          gender: document.getElementById('member-gender').value,
          birthDate: document.getElementById('member-birthdate').value,
          phone: document.getElementById('member-phone').value,
          lineId: document.getElementById('member-lineid').value,
          emergencyContact: document.getElementById('member-emergency-contact').value,
          relationship: document.getElementById('member-relationship').value,
          emergencyPhone: document.getElementById('member-emergency-phone').value,
          healthStatus: document.getElementById('member-health').value,
          medication: document.getElementById('member-medication').value,
          specialNeeds: document.getElementById('member-special-needs').value,
          notes: document.getElementById('member-notes').value
        };

        if (memberId) {
          data.memberId = memberId;
          await apiPost('updateMember', data);
          showSuccess('æˆå“¡æ›´æ–°æˆåŠŸ');
        } else {
          await apiPost('addMember', data);
          showSuccess('æˆå“¡æ–°å¢æˆåŠŸ');
        }

        closeModal('memberModal');
        loadMembers();
      } catch (error) {
        console.error('å„²å­˜æˆå“¡å¤±æ•—:', error);
        showError(error.message || 'å„²å­˜å¤±æ•—');
      }
    }

    async function deleteMember(memberId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æˆå“¡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;

      try {
        await apiPost('deleteMember', { memberId });
        showSuccess('æˆå“¡å·²åˆªé™¤');
        loadMembers();
      } catch (error) {
        console.error('åˆªé™¤æˆå“¡å¤±æ•—:', error);
        showError('åˆªé™¤å¤±æ•—');
      }
    }

    // ==================== è²¡å‹™ç®¡ç† (ç®¡ç†å“¡) ====================
    async function loadFinance() {
      try {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;

        // è¼‰å…¥æœ¬æœˆçµ±è¨ˆ
        const summary = await apiGet('getFinanceSummary', { year, month });
        document.getElementById('finance-income').textContent = '$' + summary.totalIncome.toLocaleString();
        document.getElementById('finance-expense').textContent = '$' + summary.totalExpense.toLocaleString();
        document.getElementById('finance-balance').textContent = '$' + summary.balance.toLocaleString();

        // è¼‰å…¥äº¤æ˜“è¨˜éŒ„
        const typeFilter = document.getElementById('finance-type-filter').value;
        const transactions = await apiGet('getTransactions', {
          type: typeFilter || undefined
        });

        allTransactions = transactions;
        displayTransactions(transactions);

      } catch (error) {
        console.error('è¼‰å…¥è²¡å‹™å¤±æ•—:', error);
        showError('è¼‰å…¥è²¡å‹™å¤±æ•—');
      }
    }

    function displayTransactions(transactions) {
      const tbody = document.getElementById('finance-tbody');
      
      if (transactions.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">
              <div class="empty-state-text">å°šç„¡äº¤æ˜“è¨˜éŒ„</div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = transactions.map(t => `
        <tr>
          <td>${t['æ—¥æœŸ']}</td>
          <td>
            <span class="badge ${t['é¡å‹'] === 'æ”¶å…¥' ? 'badge-success' : 'badge-danger'}">
              ${t['é¡å‹']}
            </span>
          </td>
          <td>${t['é¡åˆ¥']}</td>
          <td style="font-weight: bold; color: ${t['é¡å‹'] === 'æ”¶å…¥' ? '#28a745' : '#dc3545'}">
            ${t['é¡å‹'] === 'æ”¶å…¥' ? '+' : '-'}$${parseFloat(t['é‡‘é¡']).toLocaleString()}
          </td>
          <td>${t['æè¿°']}</td>
          <td>${t['ç¶“æ‰‹äºº'] || '-'}</td>
          <td>
            <div class="action-buttons">
              <button class="icon-btn edit" onclick="editTransaction('${t['äº¤æ˜“ID']}')" title="ç·¨è¼¯">âœï¸</button>
              <button class="icon-btn delete" onclick="deleteTransaction('${t['äº¤æ˜“ID']}')" title="åˆªé™¤">ğŸ—‘ï¸</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function openFinanceModal(transactionId = null) {
      const modal = document.getElementById('financeModal');
      const title = document.getElementById('financeModalTitle');
      const form = document.getElementById('financeForm');
      
      form.reset();
      document.getElementById('transaction-date').valueAsDate = new Date();
      
      if (transactionId) {
        title.textContent = 'ç·¨è¼¯äº¤æ˜“';
        const transaction = allTransactions.find(t => t['äº¤æ˜“ID'] === transactionId);
        if (transaction) {
          document.getElementById('transaction-id').value = transaction['äº¤æ˜“ID'];
          document.getElementById('transaction-type').value = transaction['é¡å‹'];
          document.getElementById('transaction-date').value = transaction['æ—¥æœŸ'];
          document.getElementById('transaction-category').value = transaction['é¡åˆ¥'];
          document.getElementById('transaction-amount').value = transaction['é‡‘é¡'];
          document.getElementById('transaction-payment').value = transaction['ä»˜æ¬¾æ–¹å¼'];
          document.getElementById('transaction-receipt').value = transaction['æ†‘è­‰ç·¨è™Ÿ'];
          document.getElementById('transaction-description').value = transaction['æè¿°'];
        }
      } else {
        title.textContent = 'æ–°å¢äº¤æ˜“';
      }
      
      modal.classList.add('active');
    }

    function editTransaction(transactionId) {
      openFinanceModal(transactionId);
    }

    async function saveTransaction() {
      try {
        const transactionId = document.getElementById('transaction-id').value;
        const data = {
          type: document.getElementById('transaction-type').value,
          date: document.getElementById('transaction-date').value,
          category: document.getElementById('transaction-category').value,
          amount: document.getElementById('transaction-amount').value,
          paymentMethod: document.getElementById('transaction-payment').value,
          receiptNo: document.getElementById('transaction-receipt').value,
          description: document.getElementById('transaction-description').value,
          handler: currentMember ? currentMember['å§“å'] : currentUser.displayName
        };

        if (transactionId) {
          data.transactionId = transactionId;
          await apiPost('updateTransaction', data);
          showSuccess('äº¤æ˜“æ›´æ–°æˆåŠŸ');
        } else {
          await apiPost('addTransaction', data);
          showSuccess('äº¤æ˜“æ–°å¢æˆåŠŸ');
        }

        closeModal('financeModal');
        loadFinance();
      } catch (error) {
        console.error('å„²å­˜äº¤æ˜“å¤±æ•—:', error);
        showError(error.message || 'å„²å­˜å¤±æ•—');
      }
    }

    async function deleteTransaction(transactionId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤äº¤æ˜“è¨˜éŒ„å—ï¼Ÿ')) return;

      try {
        await apiPost('deleteTransaction', { transactionId });
        showSuccess('äº¤æ˜“å·²åˆªé™¤');
        loadFinance();
      } catch (error) {
        console.error('åˆªé™¤äº¤æ˜“å¤±æ•—:', error);
        showError('åˆªé™¤å¤±æ•—');
      }
    }

    // ==================== å ±è¡¨åŠŸèƒ½ ====================
    async function generateReport() {
      const reportType = document.getElementById('report-type').value;
      const year = parseInt(document.getElementById('report-year').value);
      const month = document.getElementById('report-month').value ? 
        parseInt(document.getElementById('report-month').value) : null;

      if (!reportType) {
        showError('è«‹é¸æ“‡å ±è¡¨é¡å‹');
        return;
      }

      const container = document.getElementById('report-result');
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>ç”Ÿæˆå ±è¡¨ä¸­...</p></div>';

      try {
        let data;
        let html = '';

        switch(reportType) {
          case 'member':
            data = await apiGet('getMemberStats');
            html = generateMemberReport(data);
            break;
          case 'activity':
            data = await apiGet('getActivityStats', { year, month });
            html = generateActivityReport(data, year, month);
            break;
          case 'finance':
            data = await apiGet('getFinanceSummary', { year, month });
            html = generateFinanceReport(data, year, month);
            break;
          case 'volunteer':
            data = await apiGet('getVolunteerStats', { year, month });
            html = generateVolunteerReport(data, year, month);
            break;
        }

        container.innerHTML = html;
      } catch (error) {
        console.error('ç”Ÿæˆå ±è¡¨å¤±æ•—:', error);
        container.innerHTML = `<div class="alert alert-danger">ç”Ÿæˆå ±è¡¨å¤±æ•—ï¼š${error.message}</div>`;
      }
    }

    function generateMemberReport(data) {
      return `
        <div class="card">
          <div class="card-header">æœƒå“¡çµ±è¨ˆå ±è¡¨</div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-card green">
                <div class="stat-value">${data.total}</div>
                <div class="stat-label">ç¸½æœƒå“¡æ•¸</div>
              </div>
              <div class="stat-card blue">
                <div class="stat-value">${data.active}</div>
                <div class="stat-label">å•Ÿç”¨æœƒå“¡</div>
              </div>
              <div class="stat-card orange">
                <div class="stat-value">${data.male}</div>
                <div class="stat-label">ç”·æ€§æœƒå“¡</div>
              </div>
              <div class="stat-card red">
                <div class="stat-value">${data.female}</div>
                <div class="stat-label">å¥³æ€§æœƒå“¡</div>
              </div>
            </div>
            <h4 style="margin-top: 20px;">å¹´é½¡åˆ†å¸ƒ</h4>
            <div class="table-container">
              <table>
                <tr>
                  <th>å¹´é½¡å±¤</th>
                  <th>äººæ•¸</th>
                </tr>
                <tr>
                  <td>50æ­²ä»¥ä¸‹</td>
                  <td>${data.ageGroups.under50}</td>
                </tr>
                <tr>
                  <td>50-60æ­²</td>
                  <td>${data.ageGroups['50to60']}</td>
                </tr>
                <tr>
                  <td>60-70æ­²</td>
                  <td>${data.ageGroups['60to70']}</td>
                </tr>
                <tr>
                  <td>70æ­²ä»¥ä¸Š</td>
                  <td>${data.ageGroups.over70}</td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function generateActivityReport(data, year, month) {
      const period = month ? `${year}å¹´${month}æœˆ` : `${year}å¹´`;
      return `
        <div class="card">
          <div class="card-header">æ´»å‹•çµ±è¨ˆå ±è¡¨ - ${period}</div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-card green">
                <div class="stat-value">${data.total}</div>
                <div class="stat-label">ç¸½æ´»å‹•æ•¸</div>
              </div>
              <div class="stat-card blue">
                <div class="stat-value">${data.totalParticipants}</div>
                <div class="stat-label">ç¸½åƒèˆ‡äººæ¬¡</div>
              </div>
              <div class="stat-card orange">
                <div class="stat-value">${data.avgParticipants}</div>
                <div class="stat-label">å¹³å‡åƒèˆ‡äººæ•¸</div>
              </div>
              <div class="stat-card red">
                <div class="stat-value">${data.budgetUtilization}%</div>
                <div class="stat-label">é ç®—ä½¿ç”¨ç‡</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function generateFinanceReport(data, year, month) {
      const period = month ? `${year}å¹´${month}æœˆ` : `${year}å¹´`;
      return `
        <div class="card">
          <div class="card-header">è²¡å‹™çµ±è¨ˆå ±è¡¨ - ${period}</div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-card green">
                <div class="stat-value">$${data.totalIncome.toLocaleString()}</div>
                <div class="stat-label">ç¸½æ”¶å…¥</div>
              </div>
              <div class="stat-card red">
                <div class="stat-value">$${data.totalExpense.toLocaleString()}</div>
                <div class="stat-label">ç¸½æ”¯å‡º</div>
              </div>
              <div class="stat-card ${data.balance >= 0 ? 'blue' : 'orange'}">
                <div class="stat-value">$${data.balance.toLocaleString()}</div>
                <div class="stat-label">çµé¤˜</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${data.transactionCount}</div>
                <div class="stat-label">äº¤æ˜“ç­†æ•¸</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function generateVolunteerReport(data, year, month) {
      const period = month ? `${year}å¹´${month}æœˆ` : `${year}å¹´`;
      return `
        <div class="card">
          <div class="card-header">å¿—å·¥çµ±è¨ˆå ±è¡¨ - ${period}</div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-card green">
                <div class="stat-value">${data.totalVolunteers}</div>
                <div class="stat-label">ç¸½å¿—å·¥æ•¸</div>
              </div>
              <div class="stat-card blue">
                <div class="stat-value">${data.activeVolunteers}</div>
                <div class="stat-label">æ´»èºå¿—å·¥</div>
              </div>
              <div class="stat-card orange">
                <div class="stat-value">${data.totalServiceHours}</div>
                <div class="stat-label">ç¸½æœå‹™æ™‚æ•¸</div>
              </div>
              <div class="stat-card red">
                <div class="stat-value">${data.avgServiceHours}</div>
                <div class="stat-label">å¹³å‡æ™‚æ•¸</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ==================== å·¥å…·å‡½æ•¸ ====================
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('active');
      
      // é‡æ–°å•Ÿç”¨è¡¨å–®æ¬„ä½
      const form = modal.querySelector('form');
      if (form) {
        form.querySelectorAll('input, select, textarea').forEach(el => {
          el.disabled = false;
        });
      }
      
      // é¡¯ç¤ºæŒ‰éˆ•
      const footer = modal.querySelector('.modal-footer');
      if (footer) {
        footer.style.display = 'flex';
      }
    }

    function showSuccess(message) {
      alert('âœ… ' + message);
    }

    function showError(message) {
      alert('âŒ ' + message);
    }

    function initializeYearSelector() {
      const select = document.getElementById('report-year');
      const currentYear = new Date().getFullYear();
      
      for (let year = currentYear; year >= currentYear - 5; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + 'å¹´';
        if (year === currentYear) option.selected = true;
        select.appendChild(option);
      }
    }

    function initializeMonthSelector() {
      const select = document.getElementById('finance-month-filter');
      const currentYear = new Date().getFullYear();
      const currentMonth = new Date().getMonth() + 1;
      
      for (let month = 1; month <= 12; month++) {
        const option = document.createElement('option');
        option.value = `${currentYear}-${month.toString().padStart(2, '0')}`;
        option.textContent = `${currentYear}å¹´${month}æœˆ`;
        if (month === currentMonth) option.selected = true;
        select.appendChild(option);
      }
    }

    async function viewAuditLogs() {
      try {
        const logs = await apiGet('getAuditLogs');
        
        let html = `
          <div class="modal active">
            <div class="modal-content">
              <div class="modal-header">
                <div class="modal-title">æ“ä½œæ—¥èªŒ</div>
                <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
              </div>
              <div class="modal-body">
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>æ™‚é–“</th>
                        <th>ä½¿ç”¨è€…</th>
                        <th>æ“ä½œ</th>
                        <th>è©³æƒ…</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${logs.slice(0, 50).map(log => `
                        <tr>
                          <td>${log['æ™‚é–“']}</td>
                          <td>${log['ä½¿ç”¨è€…åç¨±']}</td>
                          <td>${log['æ“ä½œ']}</td>
                          <td>${log['è©³æƒ…']}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
      } catch (error) {
        console.error('è¼‰å…¥æ—¥èªŒå¤±æ•—:', error);
        showError('è¼‰å…¥æ—¥èªŒå¤±æ•—');
      }
    }

    // é»æ“Š modal èƒŒæ™¯é—œé–‰
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
      }
    });
  </script>
</body>
</html>  
