<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友權益促進會管理系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #00B900 0%, #00a000 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #00B900;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .tabs {
      display: flex;
      background: #f5f5f5;
      overflow-x: auto;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      flex: 1;
      min-width: 100px;
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .tab:hover {
      background: #e8e8e8;
    }

    .tab.active {
      background: white;
      color: #00B900;
      border-bottom: 3px solid #00B900;
    }

    .content {
      padding: 20px;
      min-height: 400px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #e0e0e0;
    }

    .card-header {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-body {
      color: #666;
      line-height: 1.6;
    }

    .btn {
      display: inline-block;
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      text-align: center;
    }

    .btn-primary {
      background: #00B900;
      color: white;
    }

    .btn-primary:hover {
      background: #009900;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 185, 0, 0.3);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 12px;
    }

    .btn-block {
      display: block;
      width: 100%;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
      font-size: 14px;
    }

    .form-control {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-control:focus {
      outline: none;
      border-color: #00B900;
      box-shadow: 0 0 0 3px rgba(0, 185, 0, 0.1);
    }

    .form-control:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
    }

    select.form-control {
      cursor: pointer;
    }

    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-card.green {
      background: linear-gradient(135deg, #00B900 0%, #009900 100%);
    }

    .stat-card.blue {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-card.orange {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .stat-card.red {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #dee2e6;
      font-size: 14px;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #dee2e6;
      font-size: 14px;
      color: #666;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }

    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .badge-secondary {
      background: #e2e3e5;
      color: #383d41;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-state-text {
      font-size: 18px;
      margin-bottom: 10px;
    }

    .empty-state-subtext {
      font-size: 14px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      margin: 20px;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .info-row {
      display: flex;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      flex: 0 0 120px;
      font-weight: 500;
      color: #666;
      font-size: 14px;
    }

    .info-value {
      flex: 1;
      color: #333;
      font-size: 14px;
    }

    .search-box {
      position: relative;
      margin-bottom: 20px;
    }

    .search-box input {
      padding-left: 40px;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
      font-size: 18px;
    }

    .filter-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-group select {
      flex: 1;
      min-width: 150px;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.3s;
      font-size: 16px;
    }

    .icon-btn:hover {
      background: #f0f0f0;
    }

    .icon-btn.edit {
      color: #007bff;
    }

    .icon-btn.delete {
      color: #dc3545;
    }

    .icon-btn.view {
      color: #28a745;
    }

    .profile-header {
      text-align: center;
      padding: 30px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      font-size: 48px;
      color: #667eea;
    }

    .profile-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .profile-id {
      font-size: 14px;
      opacity: 0.9;
    }

    .activity-item {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }

    .activity-item:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .activity-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    .activity-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
      font-size: 14px;
      color: #666;
    }

    .activity-meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .activity-description {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .activity-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 15px;
      border-top: 1px solid #f0f0f0;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00B900 0%, #00d000 100%);
      transition: width 0.3s;
    }

    .admin-only {
      display: none;
    }

    .admin-only.show {
      display: block;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin: 20px 0;
    }

    @media (max-width: 768px) {
      body {
        padding: 0;
      }

      .container {
        border-radius: 0;
      }

      .header h1 {
        font-size: 22px;
      }

      .tabs {
        font-size: 12px;
      }

      .tab {
        padding: 12px 8px;
        min-width: 80px;
      }

      .content {
        padding: 15px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .modal-content {
        width: 95%;
        margin: 10px;
      }

      .table-container {
        font-size: 12px;
      }

      th, td {
        padding: 8px;
      }
    }

    .fade-in {
      animation: fadeIn 0.5s;
    }

    .slide-up {
      animation: slideUp 0.5s;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🤝 帕金森病友權益促進會</h1>
      <p>管理系統 v1.0.0</p>
    </div>

    <div id="loadingScreen" class="loading">
      <div class="loading-spinner"></div>
      <p>系統載入中...</p>
    </div>

    <div id="mainContent" style="display: none;">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('home')">🏠 首頁</button>
        <button class="tab" onclick="switchTab('activities')">📋 活動</button>
        <button class="tab" onclick="switchTab('profile')">👤 個人</button>
        <button class="tab" onclick="switchTab('volunteer')">🤝 志工</button>
        <button class="tab admin-only" onclick="switchTab('members')">👥 成員</button>
        <button class="tab admin-only" onclick="switchTab('finance')">💰 財務</button>
        <button class="tab admin-only" onclick="switchTab('reports')">📊 報表</button>
        <button class="tab admin-only" onclick="switchTab('settings')">⚙️ 設定</button>
      </div>

      <div class="content">
        <!-- 首頁 -->
        <div id="page-home" class="page active">
          <div class="profile-header">
            <div class="profile-avatar">👤</div>
            <div class="profile-name" id="userName">載入中...</div>
            <div class="profile-id" id="userRole">會員</div>
          </div>

          <div class="stats-grid">
            <div class="stat-card green">
              <div class="stat-value" id="stat-activities">0</div>
              <div class="stat-label">本月活動</div>
            </div>
            <div class="stat-card blue">
              <div class="stat-value" id="stat-registrations">0</div>
              <div class="stat-label">我的報名</div>
            </div>
            <div class="stat-card orange">
              <div class="stat-value" id="stat-volunteer-hours">0</div>
              <div class="stat-label">志工時數</div>
            </div>
            <div class="stat-card red admin-only">
              <div class="stat-value" id="stat-members">0</div>
              <div class="stat-label">總會員數</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              📢 最新消息
            </div>
            <div class="card-body">
              <p>歡迎使用帕金森病友權益促進會管理系統！</p>
              <p style="margin-top: 10px;">請使用上方選單查看活動、管理個人資料或參與志工服務。</p>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              🎯 快速功能
            </div>
            <div class="card-body">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                <button class="btn btn-primary btn-block" onclick="switchTab('activities')">查看活動</button>
                <button class="btn btn-primary btn-block" onclick="switchTab('profile')">個人資料</button>
                <button class="btn btn-primary btn-block" onclick="switchTab('volunteer')">志工服務</button>
                <button class="btn btn-secondary btn-block admin-only" onclick="switchTab('members')">成員管理</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 活動頁面 -->
        <div id="page-activities" class="page">
          <div class="card">
            <div class="card-header">
              📋 活動列表
              <button class="btn btn-primary btn-sm admin-only" onclick="openActivityModal()">+ 新增活動</button>
            </div>
            <div class="card-body">
              <div class="filter-group">
                <select id="activity-status-filter" class="form-control" onchange="loadActivities()">
                  <option value="">所有狀態</option>
                  <option value="報名中" selected>報名中</option>
                  <option value="已結束">已結束</option>
                  <option value="已取消">已取消</option>
                </select>
                <select id="activity-type-filter" class="form-control" onchange="loadActivities()">
                  <option value="">所有類型</option>
                  <option value="健康講座">健康講座</option>
                  <option value="復健課程">復健課程</option>
                  <option value="社交活動">社交活動</option>
                  <option value="志工服務">志工服務</option>
                  <option value="其他">其他</option>
                </select>
              </div>
              <div id="activities-list"></div>
            </div>
          </div>
        </div>

        <!-- 個人資料頁面 -->
        <div id="page-profile" class="page">
          <div class="card">
            <div class="card-header">
              👤 個人資料
              <button class="btn btn-primary btn-sm" onclick="editProfile()">編輯資料</button>
            </div>
            <div class="card-body" id="profile-info">
              <div class="empty-state">
                <div class="empty-state-icon">👤</div>
                <div class="empty-state-text">載入中...</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              📋 我的報名記錄
            </div>
            <div class="card-body">
              <div id="my-registrations-list"></div>
            </div>
          </div>
        </div>

        <!-- 志工頁面 -->
        <div id="page-volunteer" class="page">
          <div class="card">
            <div class="card-header">
              🤝 志工資料
              <button class="btn btn-primary btn-sm" id="volunteer-register-btn" onclick="registerVolunteer()">註冊志工</button>
            </div>
            <div class="card-body" id="volunteer-info">
              <div class="empty-state">
                <div class="empty-state-icon">🤝</div>
                <div class="empty-state-text">載入中...</div>
              </div>
            </div>
          </div>

          <div class="card" id="volunteer-hours-card" style="display: none;">
            <div class="card-header">
              ⏱️ 服務時數記錄
              <button class="btn btn-primary btn-sm admin-only" onclick="openVolunteerHoursModal()">+ 記錄時數</button>
            </div>
            <div class="card-body">
              <div id="volunteer-hours-list"></div>
            </div>
          </div>
        </div>

        <!-- 成員管理頁面 (管理員) -->
        <div id="page-members" class="page">
          <div class="card">
            <div class="card-header">
              👥 成員管理
              <button class="btn btn-primary btn-sm" onclick="openMemberModal()">+ 新增成員</button>
            </div>
            <div class="card-body">
              <div class="search-box">
                <span class="search-icon">🔍</span>
                <input type="text" class="form-control" id="member-search" placeholder="搜尋姓名、電話或會員編號..." onkeyup="searchMembers()">
              </div>
              <div class="table-container">
                <table id="members-table">
                  <thead>
                    <tr>
                      <th>會員編號</th>
                      <th>姓名</th>
                      <th>性別</th>
                      <th>電話</th>
                      <th>加入日期</th>
                      <th>狀態</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="members-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 財務管理頁面 (管理員) -->
        <div id="page-finance" class="page">
          <div class="stats-grid">
            <div class="stat-card green">
              <div class="stat-value" id="finance-income">$0</div>
              <div class="stat-label">本月收入</div>
            </div>
            <div class="stat-card red">
              <div class="stat-value" id="finance-expense">$0</div>
              <div class="stat-label">本月支出</div>
            </div>
            <div class="stat-card blue">
              <div class="stat-value" id="finance-balance">$0</div>
              <div class="stat-label">本月結餘</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              💰 財務記錄
              <button class="btn btn-primary btn-sm" onclick="openFinanceModal()">+ 新增交易</button>
            </div>
            <div class="card-body">
              <div class="filter-group">
                <select id="finance-type-filter" class="form-control" onchange="loadFinance()">
                  <option value="">所有類型</option>
                  <option value="收入">收入</option>
                  <option value="支出">支出</option>
                </select>
                <select id="finance-month-filter" class="form-control" onchange="loadFinance()">
                  <option value="">選擇月份</option>
                </select>
              </div>
              <div class="table-container">
                <table id="finance-table">
                  <thead>
                    <tr>
                      <th>日期</th>
                      <th>類型</th>
                      <th>類別</th>
                      <th>金額</th>
                      <th>描述</th>
                      <th>經手人</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="finance-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 報表頁面 (管理員) -->
        <div id="page-reports" class="page">
          <div class="card">
            <div class="card-header">
              📊 統計報表
            </div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">選擇報表類型</label>
                <select id="report-type" class="form-control" onchange="generateReport()">
                  <option value="">請選擇...</option>
                  <option value="member">會員統計</option>
                  <option value="activity">活動統計</option>
                  <option value="finance">財務統計</option>
                  <option value="volunteer">志工統計</option>
                </select>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">年份</label>
                  <select id="report-year" class="form-control"></select>
                </div>
                <div class="form-group">
                  <label class="form-label">月份</label>
                  <select id="report-month" class="form-control">
                    <option value="">全年</option>
                    <option value="1">1月</option>
                    <option value="2">2月</option>
                    <option value="3">3月</option>
                    <option value="4">4月</option>
                    <option value="5">5月</option>
                    <option value="6">6月</option>
                    <option value="7">7月</option>
                    <option value="8">8月</option>
                    <option value="9">9月</option>
                    <option value="10">10月</option>
                    <option value="11">11月</option>
                    <option value="12">12月</option>
                  </select>
                </div>
              </div>
              <button class="btn btn-primary" onclick="generateReport()">生成報表</button>
              <div id="report-result" style="margin-top: 20px;"></div>
            </div>
          </div>
        </div>

        <!-- 設定頁面 (管理員) -->
        <div id="page-settings" class="page">
          <div class="card">
            <div class="card-header">
              ⚙️ 系統設定
            </div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">系統名稱</label>
                <input type="text" class="form-control" value="帕金森病友權益促進會管理系統" disabled>
              </div>
              <div class="form-group">
                <label class="form-label">版本</label>
                <input type="text" class="form-control" value="1.0.0" disabled>
              </div>
              <div class="form-group">
                <label class="form-label">LIFF ID</label>
                <input type="text" class="form-control" id="liff-id-display" disabled>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              🔐 權限管理
            </div>
            <div class="card-body">
              <p>管理員可以在此設定使用者權限。</p>
              <button class="btn btn-secondary" onclick="alert('此功能開發中')">管理權限</button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              📝 操作日誌
            </div>
            <div class="card-body">
              <button class="btn btn-secondary" onclick="viewAuditLogs()">查看日誌</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 活動詳情/編輯 Modal -->
  <div id="activityModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="activityModalTitle">活動詳情</div>
        <button class="modal-close" onclick="closeModal('activityModal')">×</button>
      </div>
      <div class="modal-body">
        <form id="activityForm">
          <input type="hidden" id="activity-id">
          <div class="form-group">
            <label class="form-label">活動名稱 *</label>
            <input type="text" class="form-control" id="activity-name" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">類型 *</label>
              <select class="form-control" id="activity-type" required>
                <option value="">請選擇</option>
                <option value="健康講座">健康講座</option>
                <option value="復健課程">復健課程</option>
                <option value="社交活動">社交活動</option>
                <option value="志工服務">志工服務</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">狀態</label>
              <select class="form-control" id="activity-status">
                <option value="報名中">報名中</option>
                <option value="已結束">已結束</option>
                <option value="已取消">已取消</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">日期 *</label>
              <input type="date" class="form-control" id="activity-date" required>
            </div>
            <div class="form-group">
              <label class="form-label">時間 *</label>
              <input type="time" class="form-control" id="activity-time" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">地點 *</label>
            <input type="text" class="form-control" id="activity-location" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">報名上限</label>
              <input type="number" class="form-control" id="activity-max" min="0">
            </div>
            <div class="form-group">
              <label class="form-label">預算</label>
              <input type="number" class="form-control" id="activity-budget" min="0">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">活動描述</label>
            <textarea class="form-control" id="activity-description"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('activityModal')">取消</button>
        <button class="btn btn-primary" onclick="saveActivity()">儲存</button>
      </div>
    </div>
  </div>

  <!-- 成員詳情/編輯 Modal -->
  <div id="memberModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="memberModalTitle">成員資料</div>
        <button class="modal-close" onclick="closeModal('memberModal')">×</button>
      </div>
      <div class="modal-body">
        <form id="memberForm">
          <input type="hidden" id="member-id">
          <div class="form-group">
            <label class="form-label">姓名 *</label>
            <input type="text" class="form-control" id="member-name" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">性別</label>
              <select class="form-control" id="member-gender">
                <option value="">請選擇</option>
                <option value="男">男</option>
                <option value="女">女</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">出生日期</label>
              <input type="date" class="form-control" id="member-birthdate">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">電話</label>
            <input type="tel" class="form-control" id="member-phone">
          </div>
          <div class="form-group">
            <label class="form-label">LINE ID</label>
            <input type="text" class="form-control" id="member-lineid">
          </div>
          <div class="form-group">
            <label class="form-label">緊急聯絡人</label>
            <input type="text" class="form-control" id="member-emergency-contact">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">關係</label>
              <input type="text" class="form-control" id="member-relationship">
            </div>
            <div class="form-group">
              <label class="form-label">緊急電話</label>
              <input type="tel" class="form-control" id="member-emergency-phone">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">健康狀況</label>
            <textarea class="form-control" id="member-health"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">用藥記錄</label>
            <textarea class="form-control" id="member-medication"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">特殊需求</label>
            <textarea class="form-control" id="member-special-needs"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">備註</label>
            <textarea class="form-control" id="member-notes"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('memberModal')">取消</button>
        <button class="btn btn-primary" onclick="saveMember()">儲存</button>
      </div>
    </div>
  </div>

  <!-- 財務交易 Modal -->
  <div id="financeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="financeModalTitle">新增交易</div>
        <button class="modal-close" onclick="closeModal('financeModal')">×</button>
      </div>
      <div class="modal-body">
        <form id="financeForm">
          <input type="hidden" id="transaction-id">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">類型 *</label>
              <select class="form-control" id="transaction-type" required>
                <option value="">請選擇</option>
                <option value="收入">收入</option>
                <option value="支出">支出</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">日期 *</label>
              <input type="date" class="form-control" id="transaction-date" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">類別 *</label>
            <input type="text" class="form-control" id="transaction-category" required placeholder="例：會費、捐款、活動費用">
          </div>
          <div class="form-group">
            <label class="form-label">金額 *</label>
            <input type="number" class="form-control" id="transaction-amount" min="0" step="1" required>
          </div>
          <div class="form-group">
            <label class="form-label">付款方式</label>
            <select class="form-control" id="transaction-payment">
              <option value="">請選擇</option>
              <option value="現金">現金</option>
              <option value="轉帳">轉帳</option>
              <option value="信用卡">信用卡</option>
              <option value="支票">支票</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">憑證編號</label>
            <input type="text" class="form-control" id="transaction-receipt">
          </div>
          <div class="form-group">
            <label class="form-label">描述 *</label>
            <textarea class="form-control" id="transaction-description" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('financeModal')">取消</button>
        <button class="btn btn-primary" onclick="saveTransaction()">儲存</button>
      </div>
    </div>
  </div>

  <!-- 志工時數記錄 Modal -->
  <div id="volunteerHoursModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">記錄志工時數</div>
        <button class="modal-close" onclick="closeModal('volunteerHoursModal')">×</button>
      </div>
      <div class="modal-body">
        <form id="volunteerHoursForm">
          <div class="form-group">
            <label class="form-label">志工 *</label>
            <select class="form-control" id="hours-volunteer-id" required>
              <option value="">請選擇志工</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">服務日期 *</label>
            <input type="date" class="form-control" id="hours-service-date" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">開始時間 *</label>
              <input type="time" class="form-control" id="hours-start-time" required>
            </div>
            <div class="form-group">
              <label class="form-label">結束時間 *</label>
              <input type="time" class="form-control" id="hours-end-time" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">服務時數 *</label>
            <input type="number" class="form-control" id="hours-total" min="0" step="0.5" required>
          </div>
          <div class="form-group">
            <label class="form-label">活動名稱</label>
            <input type="text" class="form-control" id="hours-activity-name">
          </div>
          <div class="form-group">
            <label class="form-label">評分 (1-5)</label>
            <select class="form-control" id="hours-rating">
              <option value="">未評分</option>
              <option value="5">5 - 優秀</option>
              <option value="4">4 - 良好</option>
              <option value="3">3 - 普通</option>
              <option value="2">2 - 待改進</option>
              <option value="1">1 - 不佳</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">評語</label>
            <textarea class="form-control" id="hours-comment"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('volunteerHoursModal')">取消</button>
        <button class="btn btn-primary" onclick="saveVolunteerHours()">儲存</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== 全域變數 ====================
    const CONFIG = {
      LIFF_ID: 'YOUR_LIFF_ID',
      GAS_URL: 'YOUR_GAS_WEB_APP_URL'
    };

    let currentUser = null;
    let currentMember = null;
    let currentVolunteer = null;
    let isAdmin = false;
    let allMembers = [];
    let allActivities = [];
    let allTransactions = [];
    let allVolunteers = [];

    // ==================== LIFF 初始化 ====================
    window.onload = async function() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        currentUser = {
          userId: profile.userId,
          displayName: profile.displayName,
          pictureUrl: profile.pictureUrl
        };

        await initializeApp();
      } catch (error) {
        console.error('LIFF初始化失敗:', error);
        showError('系統初始化失敗，請重新整理頁面');
      }
    };

    // ==================== 應用程式初始化 ====================
    async function initializeApp() {
      try {
        // 檢查使用者角色
        const roleData = await apiGet('getUserRole', { checkUserId: currentUser.userId });
        const adminData = await apiGet('isAdmin', { checkUserId: currentUser.userId });
        isAdmin = adminData.isAdmin;

        // 載入會員資料
        const memberData = await apiGet('getMemberByLineId', { lineId: currentUser.userId });
        currentMember = memberData;

        // 載入志工資料
        const volunteerData = await apiGet('getVolunteerByLineId', { lineId: currentUser.userId });
        currentVolunteer = volunteerData;

        // 更新UI
        updateUserInfo();
        await loadDashboard();
        
        // 顯示管理員功能
        if (isAdmin) {
          document.querySelectorAll('.admin-only').forEach(el => {
            el.classList.add('show');
            el.style.display = '';
          });
        }

        // 初始化年份選擇器
        initializeYearSelector();
        initializeMonthSelector();

        // 隱藏載入畫面
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

        // 檢查URL參數
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page');
        const id = urlParams.get('id');
        
        if (page) {
          switchTab(page);
          if (page === 'activity' && id) {
            viewActivity(id);
          }
        }

      } catch (error) {
        console.error('初始化失敗:', error);
        showError('載入資料失敗');
      }
    }

    // ==================== API 呼叫函數 ====================
    async function apiGet(action, params = {}) {
      const url = new URL(CONFIG.GAS_URL);
      url.searchParams.append('action', action);
      url.searchParams.append('userId', currentUser.userId);
      
      Object.keys(params).forEach(key => {
        if (params[key] !== null && params[key] !== undefined) {
          url.searchParams.append(key, params[key]);
        }
      });

      const response = await fetch(url);
      const result = await response.json();
      
      if (!result.success && result.error) {
        throw new Error(result.error);
      }
      
      return result.data;
    }

    async function apiPost(action, data) {
      const url = `${CONFIG.GAS_URL}?action=${action}&userId=${currentUser.userId}`;
      
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error || '操作失敗');
      }
      
      return result.data;
    }

    // ==================== UI 更新函數 ====================
    function updateUserInfo() {
      const userName = currentMember ? currentMember['姓名'] : currentUser.displayName;
      const userRole = isAdmin ? '管理員' : '會員';
      
      document.getElementById('userName').textContent = userName;
      document.getElementById('userRole').textContent = userRole;
    }

    async function loadDashboard() {
      try {
        // 載入統計數據
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;

        // 本月活動數
        const activities = await apiGet('getActivities', {
          status: '報名中'
        });
        document.getElementById('stat-activities').textContent = activities.length;

        // 我的報名數
        if (currentMember) {
          const registrations = await apiGet('getMemberRegistrations', {
            memberId: currentMember['成員ID']
          });
          document.getElementById('stat-registrations').textContent = registrations.length;
        }

        // 志工時數
        if (currentVolunteer) {
          const summary = await apiGet('getVolunteerSummary', {
            volunteerId: currentVolunteer['志工ID']
          });
          document.getElementById('stat-volunteer-hours').textContent = summary.totalHours;
        }

        // 管理員統計
        if (isAdmin) {
          const memberStats = await apiGet('getMemberStats');
          document.getElementById('stat-members').textContent = memberStats.total;
        }

      } catch (error) {
        console.error('載入儀表板失敗:', error);
      }
    }

    // ==================== 頁面切換 ====================
    function switchTab(tabName) {
      // 更新標籤
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      // 更新頁面
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(`page-${tabName}`).classList.add('active');

      // 載入對應資料
      switch(tabName) {
        case 'activities':
          loadActivities();
          break;
        case 'profile':
          loadProfile();
          break;
        case 'volunteer':
          loadVolunteer();
          break;
        case 'members':
          if (isAdmin) loadMembers();
          break;
        case 'finance':
          if (isAdmin) loadFinance();
          break;
      }
    }

    // ==================== 活動管理 ====================
    async function loadActivities() {
      try {
        const statusFilter = document.getElementById('activity-status-filter').value;
        const typeFilter = document.getElementById('activity-type-filter').value;

        const activities = await apiGet('getActivities', {
          status: statusFilter || undefined,
          type: typeFilter || undefined
        });

        allActivities = activities;
        displayActivities(activities);
      } catch (error) {
        console.error('載入活動失敗:', error);
        showError('載入活動失敗');
      }
    }

    function displayActivities(activities) {
      const container = document.getElementById('activities-list');
      
      if (activities.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">📋</div>
            <div class="empty-state-text">目前沒有活動</div>
          </div>
        `;
        return;
      }

      container.innerHTML = activities.map(activity => {
        const progress = activity['報名上限'] > 0 ? 
          (activity['目前報名數'] / activity['報名上限'] * 100).toFixed(0) : 0;
        
        const statusBadge = activity['狀態'] === '報名中' ? 'badge-success' : 
                            activity['狀態'] === '已結束' ? 'badge-secondary' : 'badge-danger';

        return `
          <div class="activity-item">
            <div class="activity-title">${activity['活動名稱']}</div>
            <div class="activity-meta">
              <div class="activity-meta-item">
                <span>📅</span>
                <span>${activity['日期']} ${activity['時間']}</span>
              </div>
              <div class="activity-meta-item">
                <span>📍</span>
                <span>${activity['地點']}</span>
              </div>
              <div class="activity-meta-item">
                <span>👥</span>
                <span>${activity['目前報名數']}/${activity['報名上限'] || '不限'} 人</span>
              </div>
              <span class="badge ${statusBadge}">${activity['狀態']}</span>
            </div>
            ${activity['描述'] ? `<div class="activity-description">${activity['描述']}</div>` : ''}
            ${activity['報名上限'] > 0 ? `
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%"></div>
              </div>
            ` : ''}
            <div class="activity-footer">
              <div></div>
              <div class="action-buttons">
                ${isAdmin ? `
                  <button class="btn btn-sm btn-secondary" onclick="editActivity('${activity['活動ID']}')">編輯</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteActivity('${activity['活動ID']}')">刪除</button>
                ` : ''}
                ${activity['狀態'] === '報名中' && currentMember ? `
                  <button class="btn btn-sm btn-primary" onclick="registerForActivity('${activity['活動ID']}')">立即報名</button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function openActivityModal(activityId = null) {
      const modal = document.getElementById('activityModal');
      const title = document.getElementById('activityModalTitle');
      const form = document.getElementById('activityForm');
      
      form.reset();
      
      if (activityId) {
        title.textContent = '編輯活動';
        const activity = allActivities.find(a => a['活動ID'] === activityId);
        if (activity) {
          document.getElementById('activity-id').value = activity['活動ID'];
          document.getElementById('activity-name').value = activity['活動名稱'];
          document.getElementById('activity-type').value = activity['類型'];
          document.getElementById('activity-status').value = activity['狀態'];
          document.getElementById('activity-date').value = activity['日期'];
          document.getElementById('activity-time').value = activity['時間'];
          document.getElementById('activity-location').value = activity['地點'];
          document.getElementById('activity-max').value = activity['報名上限'];
          document.getElementById('activity-budget').value = activity['預算'];
          document.getElementById('activity-description').value = activity['描述'];
        }
      } else {
        title.textContent = '新增活動';
        document.getElementById('activity-status').value = '報名中';
      }
      
      modal.classList.add('active');
    }

    function editActivity(activityId) {
      openActivityModal(activityId);
    }

    async function saveActivity() {
      try {
        const activityId = document.getElementById('activity-id').value;
        const data = {
          name: document.getElementById('activity-name').value,
          type: document.getElementById('activity-type').value,
          date: document.getElementById('activity-date').value,
          time: document.getElementById('activity-time').value,
          location: document.getElementById('activity-location').value,
          maxParticipants: document.getElementById('activity-max').value,
          budget: document.getElementById('activity-budget').value,
          description: document.getElementById('activity-description').value,
          organizer: currentMember ? currentMember['姓名'] : currentUser.displayName
        };

        if (activityId) {
          data.activityId = activityId;
          data['狀態'] = document.getElementById('activity-status').value;
          await apiPost('updateActivity', data);
          showSuccess('活動更新成功');
        } else {
          await apiPost('createActivity', data);
          showSuccess('活動新增成功');
        }

        closeModal('activityModal');
        loadActivities();
      } catch (error) {
        console.error('儲存活動失敗:', error);
        showError(error.message || '儲存失敗');
      }
    }

    async function deleteActivity(activityId) {
      if (!confirm('確定要刪除此活動嗎？')) return;

      try {
        await apiPost('deleteActivity', { activityId });
        showSuccess('活動已刪除');
        loadActivities();
      } catch (error) {
        console.error('刪除活動失敗:', error);
        showError('刪除失敗');
      }
    }

    async function registerForActivity(activityId) {
      if (!currentMember) {
        showError('請先完成會員註冊');
        return;
      }

      try {
        await apiPost('registerActivity', {
          activityId: activityId,
          memberId: currentMember['成員ID'],
          memberName: currentMember['姓名']
        });
        showSuccess('報名成功！');
        loadActivities();
        loadDashboard();
      } catch (error) {
        console.error('報名失敗:', error);
        showError(error.message || '報名失敗');
      }
    }

    // ==================== 個人資料管理 ====================
    async function loadProfile() {
      try {
        if (!currentMember) {
          document.getElementById('profile-info').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">👤</div>
              <div class="empty-state-text">尚未建立會員資料</div>
              <div class="empty-state-subtext">請聯絡管理員協助建立</div>
            </div>
          `;
          return;
        }

        const html = `
          <div class="info-row">
            <div class="info-label">會員編號</div>
            <div class="info-value">${currentMember['成員ID']}</div>
          </div>
          <div class="info-row">
            <div class="info-label">姓名</div>
            <div class="info-value">${currentMember['姓名']}</div>
          </div>
          <div class="info-row">
            <div class="info-label">性別</div>
            <div class="info-value">${currentMember['性別'] || '-'}</div>
          </div>
          <div class="info-row">
            <div class="info-label">出生日期</div>
            <div class="info-value">${currentMember['出生日期'] || '-'}</div>
          </div>
          <div class="info-row">
            <div class="info-label">電話</div>
            <div class="info-value">${currentMember['電話'] || '-'}</div>
          </div>
          <div class="info-row">
            <div class="info-label">緊急聯絡人</div>
            <div class="info-value">${currentMember['緊急聯絡人'] || '-'} (${currentMember['關係'] || '-'})</div>
          </div>
          <div class="info-row">
            <div class="info-label">緊急電話</div>
            <div class="info-value">${currentMember['緊急電話'] || '-'}</div>
          </div>
          <div class="info-row">
            <div class="info-label">加入日期</div>
            <div class="info-value">${currentMember['加入日期']}</div>
          </div>
          <div class="info-row">
            <div class="info-label">狀態</div>
            <div class="info-value">
              <span class="badge ${currentMember['狀態'] === '啟用' ? 'badge-success' : 'badge-danger'}">
                ${currentMember['狀態']}
              </span>
            </div>
          </div>
        `;

        document.getElementById('profile-info').innerHTML = html;

        // 載入報名記錄
        const registrations = await apiGet('getMemberRegistrations', {
          memberId: currentMember['成員ID']
        });

        displayRegistrations(registrations);

      } catch (error) {
        console.error('載入個人資料失敗:', error);
        showError('載入資料失敗');
      }
    }

    function displayRegistrations(registrations) {
      const container = document.getElementById('my-registrations-list');
      
      if (registrations.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">📋</div>
            <div class="empty-state-text">尚無報名記錄</div>
          </div>
        `;
        return;
      }

      const html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>活動名稱</th>
                <th>報名時間</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              ${registrations.map(reg => `
                <tr>
                  <td>${reg['活動名稱']}</td>
                  <td>${reg['報名時間']}</td>
                  <td>
                    <span class="badge ${reg['參加狀態'] === '已簽到' ? 'badge-success' : 'badge-info'}">
                      ${reg['參加狀態']}
                    </span>
                  </td>
                  <td>
                    ${reg['參加狀態'] === '已報名' ? `
                      <button class="btn btn-sm btn-danger" onclick="cancelRegistration('${reg['報名ID']}')">取消報名</button>
                    ` : '-'}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = html;
    }

    function editProfile() {
      if (!isAdmin) {
        showError('請聯絡管理員修改資料');
        return;
      }
      openMemberModal(currentMember['成員ID']);
    }

    async function cancelRegistration(registrationId) {
      if (!confirm('確定要取消報名嗎？')) return;

      try {
        await apiPost('cancelRegistration', { registrationId });
        showSuccess('已取消報名');
        loadProfile();
        loadDashboard();
      } catch (error) {
        console.error('取消報名失敗:', error);
        showError('取消失敗');
      }
    }

    // ==================== 志工管理 ====================
    async function loadVolunteer() {
      try {
        if (!currentVolunteer) {
          document.getElementById('volunteer-info').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">🤝</div>
              <div class="empty-state-text">尚未註冊為志工</div>
              <div class="empty-state-subtext">點擊右上角按鈕註冊</div>
            </div>
          `;
          document.getElementById('volunteer-hours-card').style.display = 'none';
          return;
        }

        const summary = await apiGet('getVolunteerSummary', {
          volunteerId: currentVolunteer['志工ID']
        });

        const html = `
          <div class="info-row">
            <div class="info-label">志工編號</div>
            <div class="info-value">${currentVolunteer['志工ID']}</div>
          </div>
          <div class="info-row">
            <div class="info-label">姓名</div>
            <div class="info-value">${currentVolunteer['姓名']}</div>
          </div>
          <div class="info-row">
            <div class="info-label">專長</div>
            <div class="info-value">${currentVolunteer['專長'] || '-'}</div>
          </div>
          <div class="info-row">
            <div class="info-label">總服務時數</div>
            <div class="info-value"><strong>${summary.totalHours}</strong> 小時</div>
          </div>
          <div class="info-row">
            <div class="info-label">服務次數</div>
            <div class="info-value">${summary.serviceCount} 次</div>
          </div>
          <div class="info-row">
            <div class="info-label">平均評分</div>
            <div class="info-value">${summary.averageRating} ⭐</div>
          </div>
          <div class="info-row">
            <div class="info-label">加入日期</div>
            <div class="info-value">${currentVolunteer['加入日期']}</div>
          </div>
          <div class="info-row">
            <div class="info-label">狀態</div>
            <div class="info-value">
              <span class="badge ${currentVolunteer['狀態'] === '啟用' ? 'badge-success' : 'badge-danger'}">
                ${currentVolunteer['狀態']}
              </span>
            </div>
          </div>
        `;

        document.getElementById('volunteer-info').innerHTML = html;
        document.getElementById('volunteer-register-btn').style.display = 'none';
        document.getElementById('volunteer-hours-card').style.display = 'block';

        // 載入服務記錄
        displayVolunteerHours(summary.records);

      } catch (error) {
        console.error('載入志工資料失敗:', error);
        showError('載入資料失敗');
      }
    }

    function displayVolunteerHours(hours) {
      const container = document.getElementById('volunteer-hours-list');
      
      if (hours.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">⏱️</div>
            <div class="empty-state-text">尚無服務記錄</div>
          </div>
        `;
        return;
      }

      const html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>服務日期</th>
                <th>活動名稱</th>
                <th>服務時數</th>
                <th>評分</th>
                <th>評語</th>
              </tr>
            </thead>
            <tbody>
              ${hours.map(h => `
                <tr>
                  <td>${h['服務日期']}</td>
                  <td>${h['活動名稱'] || '-'}</td>
                  <td>${h['服務時數']} 小時</td>
                  <td>${h['評分'] ? h['評分'] + ' ⭐' : '-'}</td>
                  <td>${h['評語'] || '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = html;
    }

    function registerVolunteer() {
      showError('請聯絡管理員協助註冊志工');
    }

    async function openVolunteerHoursModal() {
      const modal = document.getElementById('volunteerHoursModal');
      const form = document.getElementById('volunteerHoursForm');
      form.reset();

      // 載入志工列表
      try {
        const volunteers = await apiGet('getVolunteers', { status: '啟用' });
        const select = document.getElementById('hours-volunteer-id');
        select.innerHTML = '<option value="">請選擇志工</option>' + 
          volunteers.map(v => `<option value="${v['志工ID']}">${v['姓名']}</option>`).join('');
        
        // 設定今天日期
        document.getElementById('hours-service-date').valueAsDate = new Date();
        
        modal.classList.add('active');
      } catch (error) {
        console.error('載入志工列表失敗:', error);
        showError('載入失敗');
      }
    }

    async function saveVolunteerHours() {
      try {
        const volunteerId = document.getElementById('hours-volunteer-id').value;
        const volunteerName = document.getElementById('hours-volunteer-id').selectedOptions[0].text;
        
        const data = {
          volunteerId: volunteerId,
          volunteerName: volunteerName,
          serviceDate: document.getElementById('hours-service-date').value,
          startTime: document.getElementById('hours-start-time').value,
          endTime: document.getElementById('hours-end-time').value,
          hours: document.getElementById('hours-total').value,
          activityName: document.getElementById('hours-activity-name').value,
          rating: document.getElementById('hours-rating').value,
          comment: document.getElementById('hours-comment').value
        };

        await apiPost('recordVolunteerHours', data);
        showSuccess('時數記錄成功');
        closeModal('volunteerHoursModal');
        loadVolunteer();
      } catch (error) {
        console.error('記錄時數失敗:', error);
        showError(error.message || '記錄失敗');
      }
    }

    // ==================== 成員管理 (管理員) ====================
    async function loadMembers() {
      try {
        const members = await apiGet('getMembers');
        allMembers = members;
        displayMembers(members);
      } catch (error) {
        console.error('載入成員失敗:', error);
        showError('載入成員失敗');
      }
    }

    function displayMembers(members) {
      const tbody = document.getElementById('members-tbody');
      
      if (members.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">
              <div class="empty-state-text">尚無成員資料</div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = members.map(member => `
        <tr>
          <td>${member['成員ID']}</td>
          <td>${member['姓名']}</td>
          <td>${member['性別'] || '-'}</td>
          <td>${member['電話'] || '-'}</td>
          <td>${member['加入日期']}</td>
          <td>
            <span class="badge ${member['狀態'] === '啟用' ? 'badge-success' : 'badge-danger'}">
              ${member['狀態']}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="icon-btn view" onclick="viewMember('${member['成員ID']}')" title="查看">👁️</button>
              <button class="icon-btn edit" onclick="openMemberModal('${member['成員ID']}')" title="編輯">✏️</button>
              <button class="icon-btn delete" onclick="deleteMember('${member['成員ID']}')" title="刪除">🗑️</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function searchMembers() {
      const keyword = document.getElementById('member-search').value.toLowerCase();
      const filtered = allMembers.filter(m => 
        (m['姓名'] && m['姓名'].toLowerCase().includes(keyword)) ||
        (m['電話'] && m['電話'].includes(keyword)) ||
        (m['成員ID'] && m['成員ID'].toLowerCase().includes(keyword))
      );
      displayMembers(filtered);
    }

    function openMemberModal(memberId = null) {
      const modal = document.getElementById('memberModal');
      const title = document.getElementById('memberModalTitle');
      const form = document.getElementById('memberForm');
      
      form.reset();
      
      if (memberId) {
        title.textContent = '編輯成員';
        const member = allMembers.find(m => m['成員ID'] === memberId);
        if (member) {
          document.getElementById('member-id').value = member['成員ID'];
          document.getElementById('member-name').value = member['姓名'];
          document.getElementById('member-gender').value = member['性別'];
          document.getElementById('member-birthdate').value = member['出生日期'];
          document.getElementById('member-phone').value = member['電話'];
          document.getElementById('member-lineid').value = member['LINE ID'];
          document.getElementById('member-emergency-contact').value = member['緊急聯絡人'];
          document.getElementById('member-relationship').value = member['關係'];
          document.getElementById('member-emergency-phone').value = member['緊急電話'];
          document.getElementById('member-health').value = member['健康狀況'];
          document.getElementById('member-medication').value = member['用藥記錄'];
          document.getElementById('member-special-needs').value = member['特殊需求'];
          document.getElementById('member-notes').value = member['備註'];
        }
      } else {
        title.textContent = '新增成員';
      }
      
      modal.classList.add('active');
    }

    function viewMember(memberId) {
      openMemberModal(memberId);
      // 設定所有欄位為唯讀
      document.querySelectorAll('#memberForm input, #memberForm select, #memberForm textarea').forEach(el => {
        el.disabled = true;
      });
      document.querySelector('#memberModal .modal-footer').style.display = 'none';
    }

    async function saveMember() {
      try {
        const memberId = document.getElementById('member-id').value;
        const data = {
          name: document.getElementById('member-name').value,
          gender: document.getElementById('member-gender').value,
          birthDate: document.getElementById('member-birthdate').value,
          phone: document.getElementById('member-phone').value,
          lineId: document.getElementById('member-lineid').value,
          emergencyContact: document.getElementById('member-emergency-contact').value,
          relationship: document.getElementById('member-relationship').value,
          emergencyPhone: document.getElementById('member-emergency-phone').value,
          healthStatus: document.getElementById('member-health').value,
          medication: document.getElementById('member-medication').value,
          specialNeeds: document.getElementById('member-special-needs').value,
          notes: document.getElementById('member-notes').value
        };

        if (memberId) {
          data.memberId = memberId;
          await apiPost('updateMember', data);
          showSuccess('成員更新成功');
        } else {
          await apiPost('addMember', data);
          showSuccess('成員新增成功');
        }

        closeModal('memberModal');
        loadMembers();
      } catch (error) {
        console.error('儲存成員失敗:', error);
        showError(error.message || '儲存失敗');
      }
    }

    async function deleteMember(memberId) {
      if (!confirm('確定要刪除此成員嗎？此操作無法復原！')) return;

      try {
        await apiPost('deleteMember', { memberId });
        showSuccess('成員已刪除');
        loadMembers();
      } catch (error) {
        console.error('刪除成員失敗:', error);
        showError('刪除失敗');
      }
    }

    // ==================== 財務管理 (管理員) ====================
    async function loadFinance() {
      try {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;

        // 載入本月統計
        const summary = await apiGet('getFinanceSummary', { year, month });
        document.getElementById('finance-income').textContent = '$' + summary.totalIncome.toLocaleString();
        document.getElementById('finance-expense').textContent = '$' + summary.totalExpense.toLocaleString();
        document.getElementById('finance-balance').textContent = '$' + summary.balance.toLocaleString();

        // 載入交易記錄
        const typeFilter = document.getElementById('finance-type-filter').value;
        const transactions = await apiGet('getTransactions', {
          type: typeFilter || undefined
        });

        allTransactions = transactions;
        displayTransactions(transactions);

      } catch (error) {
        console.error('載入財務失敗:', error);
        showError('載入財務失敗');
      }
    }

    function displayTransactions(transactions) {
      const tbody = document.getElementById('finance-tbody');
      
      if (transactions.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">
              <div class="empty-state-text">尚無交易記錄</div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = transactions.map(t => `
        <tr>
          <td>${t['日期']}</td>
          <td>
            <span class="badge ${t['類型'] === '收入' ? 'badge-success' : 'badge-danger'}">
              ${t['類型']}
            </span>
          </td>
          <td>${t['類別']}</td>
          <td style="font-weight: bold; color: ${t['類型'] === '收入' ? '#28a745' : '#dc3545'}">
            ${t['類型'] === '收入' ? '+' : '-'}$${parseFloat(t['金額']).toLocaleString()}
          </td>
          <td>${t['描述']}</td>
          <td>${t['經手人'] || '-'}</td>
          <td>
            <div class="action-buttons">
              <button class="icon-btn edit" onclick="editTransaction('${t['交易ID']}')" title="編輯">✏️</button>
              <button class="icon-btn delete" onclick="deleteTransaction('${t['交易ID']}')" title="刪除">🗑️</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function openFinanceModal(transactionId = null) {
      const modal = document.getElementById('financeModal');
      const title = document.getElementById('financeModalTitle');
      const form = document.getElementById('financeForm');
      
      form.reset();
      document.getElementById('transaction-date').valueAsDate = new Date();
      
      if (transactionId) {
        title.textContent = '編輯交易';
        const transaction = allTransactions.find(t => t['交易ID'] === transactionId);
        if (transaction) {
          document.getElementById('transaction-id').value = transaction['交易ID'];
          document.getElementById('transaction-type').value = transaction['類型'];
          document.getElementById('transaction-date').value = transaction['日期'];
          document.getElementById('transaction-category').value = transaction['類別'];
          document.getElementById('transaction-amount').value = transaction['金額'];
          document.getElementById('transaction-payment').value = transaction['付款方式'];
          document.getElementById('transaction-receipt').value = transaction['憑證編號'];
          document.getElementById('transaction-description').value = transaction['描述'];
        }
      } else {
        title.textContent = '新增交易';
      }
      
      modal.classList.add('active');
    }

    function editTransaction(transactionId) {
      openFinanceModal(transactionId);
    }

    async function saveTransaction() {
      try {
        const transactionId = document.getElementById('transaction-id').value;
        const data = {
          type: document.getElementById('transaction-type').value,
          date: document.getElementById('transaction-date').value,
          category: document.getElementById('transaction-category').value,
          amount: document.getElementById('transaction-amount').value,
          paymentMethod: document.getElementById('transaction-payment').value,
          receiptNo: document.getElementById('transaction-receipt').value,
          description: document.getElementById('transaction-description').value,
          handler: currentMember ? currentMember['姓名'] : currentUser.displayName
        };

        if (transactionId) {
          data.transactionId = transactionId;
          await apiPost('updateTransaction', data);
          showSuccess('交易更新成功');
        } else {
          await apiPost('addTransaction', data);
          showSuccess('交易新增成功');
        }

        closeModal('financeModal');
        loadFinance();
      } catch (error) {
        console.error('儲存交易失敗:', error);
        showError(error.message || '儲存失敗');
      }
    }

    async function deleteTransaction(transactionId) {
      if (!confirm('確定要刪除此交易記錄嗎？')) return;

      try {
        await apiPost('deleteTransaction', { transactionId });
        showSuccess('交易已刪除');
        loadFinance();
      } catch (error) {
        console.error('刪除交易失敗:', error);
        showError('刪除失敗');
      }
    }

    // ==================== 報表功能 ====================
    async function generateReport() {
      const reportType = document.getElementById('report-type').value;
      const year = parseInt(document.getElementById('report-year').value);
      const month = document.getElementById('report-month').value ? 
        parseInt(document.getElementById('report-month').value) : null;

      if (!reportType) {
        showError('請選擇報表類型');
        return;
      }

      const container = document.getElementById('report-result');
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>生成報表中...</p></div>';

      try {
        let data;
        let html = '';

        switch(reportType) {
          case 'member':
            data = await apiGet('getMemberStats');
            html = generateMemberReport(data);
            break;
          case 'activity':
            data = await apiGet('getActivityStats', { year, month });
            html = generateActivityReport(data, year, month);
            break;
          case 'finance':
            data = await apiGet('getFinanceSummary', { year, month });
            html = generateFinanceReport(data, year, month);
            break;
          case 'volunteer':
            data = await apiGet('getVolunteerStats', { year, month });
            html = generateVolunteerReport(data, year, month);
            break;
        }

        container.innerHTML = html;
      } catch (error) {
        console.error('生成報表失敗:', error);
        container.innerHTML = `<div class="alert alert-danger">生成報表失敗：${error.message}</div>`;
      }
    }

    function generateMemberReport(data) {
      return `
        <div class="card">
          <div class="card-header">會員統計報表</div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-card green">
                <div class="stat-value">${data.total}</div>
                <div class="stat-label">總會員數</div>
              </div>
              <div class="stat-card blue">
                <div class="stat-value">${data.active}</div>
                <div class="stat-label">啟用會員</div>
              </div>
              <div class="stat-card orange">
                <div class="stat-value">${data.male}</div>
                <div class="stat-label">男性會員</div>
              </div>
              <div class="stat-card red">
                <div class="stat-value">${data.female}</div>
                <div class="stat-label">女性會員</div>
              </div>
            </div>
            <h4 style="margin-top: 20px;">年齡分布</h4>
            <div class="table-container">
              <table>
                <tr>
                  <th>年齡層</th>
                  <th>人數</th>
                </tr>
                <tr>
                  <td>50歲以下</td>
                  <td>${data.ageGroups.under50}</td>
                </tr>
                <tr>
                  <td>50-60歲</td>
                  <td>${data.ageGroups['50to60']}</td>
                </tr>
                <tr>
                  <td>60-70歲</td>
                  <td>${data.ageGroups['60to70']}</td>
                </tr>
                <tr>
                  <td>70歲以上</td>
                  <td>${data.ageGroups.over70}</td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function generateActivityReport(data, year, month) {
      const period = month ? `${year}年${month}月` : `${year}年`;
      return `
        <div class="card">
          <div class="card-header">活動統計報表 - ${period}</div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-card green">
                <div class="stat-value">${data.total}</div>
                <div class="stat-label">總活動數</div>
              </div>
              <div class="stat-card blue">
                <div class="stat-value">${data.totalParticipants}</div>
                <div class="stat-label">總參與人次</div>
              </div>
              <div class="stat-card orange">
                <div class="stat-value">${data.avgParticipants}</div>
                <div class="stat-label">平均參與人數</div>
              </div>
              <div class="stat-card red">
                <div class="stat-value">${data.budgetUtilization}%</div>
                <div class="stat-label">預算使用率</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function generateFinanceReport(data, year, month) {
      const period = month ? `${year}年${month}月` : `${year}年`;
      return `
        <div class="card">
          <div class="card-header">財務統計報表 - ${period}</div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-card green">
                <div class="stat-value">$${data.totalIncome.toLocaleString()}</div>
                <div class="stat-label">總收入</div>
              </div>
              <div class="stat-card red">
                <div class="stat-value">$${data.totalExpense.toLocaleString()}</div>
                <div class="stat-label">總支出</div>
              </div>
              <div class="stat-card ${data.balance >= 0 ? 'blue' : 'orange'}">
                <div class="stat-value">$${data.balance.toLocaleString()}</div>
                <div class="stat-label">結餘</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${data.transactionCount}</div>
                <div class="stat-label">交易筆數</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function generateVolunteerReport(data, year, month) {
      const period = month ? `${year}年${month}月` : `${year}年`;
      return `
        <div class="card">
          <div class="card-header">志工統計報表 - ${period}</div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-card green">
                <div class="stat-value">${data.totalVolunteers}</div>
                <div class="stat-label">總志工數</div>
              </div>
              <div class="stat-card blue">
                <div class="stat-value">${data.activeVolunteers}</div>
                <div class="stat-label">活躍志工</div>
              </div>
              <div class="stat-card orange">
                <div class="stat-value">${data.totalServiceHours}</div>
                <div class="stat-label">總服務時數</div>
              </div>
              <div class="stat-card red">
                <div class="stat-value">${data.avgServiceHours}</div>
                <div class="stat-label">平均時數</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ==================== 工具函數 ====================
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('active');
      
      // 重新啟用表單欄位
      const form = modal.querySelector('form');
      if (form) {
        form.querySelectorAll('input, select, textarea').forEach(el => {
          el.disabled = false;
        });
      }
      
      // 顯示按鈕
      const footer = modal.querySelector('.modal-footer');
      if (footer) {
        footer.style.display = 'flex';
      }
    }

    function showSuccess(message) {
      alert('✅ ' + message);
    }

    function showError(message) {
      alert('❌ ' + message);
    }

    function initializeYearSelector() {
      const select = document.getElementById('report-year');
      const currentYear = new Date().getFullYear();
      
      for (let year = currentYear; year >= currentYear - 5; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + '年';
        if (year === currentYear) option.selected = true;
        select.appendChild(option);
      }
    }

    function initializeMonthSelector() {
      const select = document.getElementById('finance-month-filter');
      const currentYear = new Date().getFullYear();
      const currentMonth = new Date().getMonth() + 1;
      
      for (let month = 1; month <= 12; month++) {
        const option = document.createElement('option');
        option.value = `${currentYear}-${month.toString().padStart(2, '0')}`;
        option.textContent = `${currentYear}年${month}月`;
        if (month === currentMonth) option.selected = true;
        select.appendChild(option);
      }
    }

    async function viewAuditLogs() {
      try {
        const logs = await apiGet('getAuditLogs');
        
        let html = `
          <div class="modal active">
            <div class="modal-content">
              <div class="modal-header">
                <div class="modal-title">操作日誌</div>
                <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
              </div>
              <div class="modal-body">
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>時間</th>
                        <th>使用者</th>
                        <th>操作</th>
                        <th>詳情</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${logs.slice(0, 50).map(log => `
                        <tr>
                          <td>${log['時間']}</td>
                          <td>${log['使用者名稱']}</td>
                          <td>${log['操作']}</td>
                          <td>${log['詳情']}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
      } catch (error) {
        console.error('載入日誌失敗:', error);
        showError('載入日誌失敗');
      }
    }

    // 點擊 modal 背景關閉
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
      }
    });
  </script>
</body>
</html>  
