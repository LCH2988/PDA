<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="腦帕金森病友會管理系統">
  <meta name="theme-color" content="#4285f4">
  <title>腦帕金森病友會管理系統</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icon-192x192.png">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  
  <!-- QR Code Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  
  <!-- Google Apps Script Web App URL 與 Push Key -->
  <script>
    // 切換為 false 以連到你的 GAS；本檔預設 true 提供 Mock 後端讓整站可立即 Demo
    const MOCK_ON = true;
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwz6GbcTZQ6-lXU9ZlhNu9DI5slYhqRfYPK0SPtlwLWJraj5BfmwJ19dpJA7tU43N3l/exec';
    const VAPID_PUBLIC_KEY = 'YOUR_VAPID_PUBLIC_KEY_HERE'; // Base64URL 公鑰
  </script>
  
  <style>
    /* ==================== CSS Variables ==================== */
    :root {
      --primary-color: #4285f4;
      --secondary-color: #34a853;
      --danger-color: #ea4335;
      --warning-color: #fbbc04;
      --dark-color: #202124;
      --light-color: #f8f9fa;
      --border-color: #dadce0;
      --text-color: #202124;
      --text-secondary: #5f6368;
      --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.2);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --bg-body: var(--light-color);
      --bg-card: #fff;
    }
    .dark-theme {
      --bg-body: #121212;
      --bg-card: #1e1e1e;
      --text-color: #e4e4e4;
      --text-secondary: #b0b0b0;
      --border-color: #333;
      --shadow: 0 1px 3px rgba(0,0,0,0.6), 0 1px 2px rgba(0,0,0,0.8);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.7);
    }
    /* ==================== Reset & Base ==================== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-color);
      background: var(--bg-body);
      line-height: 1.6;
      overflow-x: hidden;
    }
    a { text-decoration: none; color: inherit; }
    button { border: none; background: none; cursor: pointer; font-family: inherit; }
    input, textarea, select { font-family: inherit; font-size: inherit; }
    /* ==================== Loading Overlay ==================== */
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: none; justify-content: center; align-items: center; z-index: 9999;
    }
    .dark-theme .loading-overlay { background: rgba(0,0,0,0.7); color: #fff; }
    .loading-overlay.active { display: flex; }
    .loading-spinner { text-align: center; }
    .spinner {
      width: 50px; height: 50px; border: 4px solid var(--border-color);
      border-top-color: var(--primary-color);
      border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* ==================== Navigation ==================== */
    .navbar { background: var(--bg-card); box-shadow: var(--shadow); position: sticky; top: 0; z-index: 1000; }
    .navbar-container { max-width: 1200px; margin: 0 auto; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    .navbar-brand { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem; }
    .navbar-menu { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
    .nav-link { color: var(--text-color); transition: var(--transition); padding: 0.5rem 0.75rem; border-radius: 8px; }
    .nav-link:hover { background: var(--light-color); color: var(--primary-color); }
    .dark-theme .nav-link:hover { background: #2a2a2a; }
    .nav-link.active { background: var(--primary-color); color: white; }
    .user-menu { position: relative; }
    .user-avatar {
      width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); color: white;
      display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; transition: var(--transition);
    }
    .user-avatar:hover { transform: scale(1.05); }
    .dropdown-menu {
      position: absolute; right: 0; top: 48px; background: var(--bg-card); border: 1px solid var(--border-color);
      border-radius: 8px; box-shadow: var(--shadow); min-width: 180px; overflow: hidden; display: none;
    }
    .dropdown-menu a { display: block; padding: 0.75rem 1rem; color: var(--text-color); }
    .dropdown-menu a:hover { background: var(--light-color); }
    .dark-theme .dropdown-menu a:hover { background: #2a2a2a; }
    .notification-icon { position: relative; cursor: pointer; color: var(--text-color); }
    /* ==================== Buttons ==================== */
    .btn { padding: 0.6rem 1.1rem; border-radius: 8px; font-weight: 500; transition: var(--transition); display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; border: none; }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-primary:hover { background: #3367d6; transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn-secondary { background: var(--secondary-color); color: white; }
    .btn-secondary:hover { background: #2d8e47; }
    .btn-danger { background: var(--danger-color); color: white; }
    .btn-danger:hover { background: #d33b2c; }
    .btn-sm { padding: 0.4rem 0.7rem; font-size: 0.9rem; }
    .btn-lg { padding: 0.8rem 1.3rem; font-size: 1rem; }
    .btn-block { width: 100%; justify-content: center; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    /* ==================== Forms ==================== */
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 500; color: var(--text-color); }
    .form-control { width: 100%; padding: 0.6rem 0.7rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: var(--transition); background: var(--bg-card); color: var(--text-color); }
    .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1); }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
    /* ==================== Cards ==================== */
    .card { background: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow); padding: 1.2rem; transition: var(--transition); }
    .card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }
    .card-header { border-bottom: 1px solid var(--border-color); padding-bottom: 0.8rem; margin-bottom: 1rem; }
    .card-title { font-size: 1.15rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
    /* ==================== Grid Layouts ==================== */
    .grid { display: grid; gap: 1.5rem; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    /* ==================== KPI Cards ==================== */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .kpi-card { background: var(--bg-card); border-radius: 12px; padding: 1.2rem; box-shadow: var(--shadow); display: flex; gap: 0.9rem; transition: var(--transition); }
    .kpi-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .kpi-icon { width: 52px; height: 52px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; color: white; flex-shrink: 0; }
    .kpi-content h3 { font-size: 1.6rem; font-weight: bold; margin-bottom: 0.2rem; }
    .kpi-content p { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.4rem; }
    .kpi-trend { display: flex; align-items: center; gap: 0.25rem; font-size: 0.85rem; font-weight: 500; }
    .kpi-trend.positive { color: var(--secondary-color); }
    .kpi-trend.negative { color: var(--danger-color); }
    /* ==================== Activity Cards ==================== */
    .activity-card { background: var(--bg-card); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; display: flex; flex-direction: column; }
    .activity-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .activity-image { width: 100%; height: 180px; object-fit: cover; position: relative; display:flex; align-items:center; justify-content:center; color:#fff; font-size:48px; }
    .activity-content { padding: 1rem; display:flex; flex-direction:column; gap:0.6rem; }
    .activity-category { display: inline-block; padding: 0.2rem 0.6rem; background: var(--primary-color); color: white; border-radius: 20px; font-size: 0.8rem; }
    .activity-title { font-size: 1.1rem; font-weight: 600; }
    .activity-meta { display: grid; grid-template-columns: 1fr; gap: 0.35rem; color: var(--text-secondary); font-size: 0.9rem; }
    .activity-meta span { display: flex; align-items: center; gap: 0.5rem; }
    .progress-bar { width: 100%; height: 8px; background: var(--light-color); border-radius: 4px; overflow: hidden; }
    .dark-theme .progress-bar { background: #2a2a2a; }
    .progress-fill { height: 100%; background: var(--primary-color); transition: width 0.3s ease; }
    .activity-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 0.6rem; border-top: 1px solid var(--border-color); }
    .status-badge { padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
    .status-badge.active { background: #e8f5e9; color: var(--secondary-color); }
    .status-badge.inactive { background: #ececec; color: #666; }
    .status-badge.full { background: #fff3e0; color: var(--warning-color); }
    .status-badge.closed { background: #ffebee; color: var(--danger-color); }
    /* ==================== Modal ==================== */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 1rem; }
    .modal.active { display: flex; }
    .modal-content { background: var(--bg-card); border-radius: 12px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; animation: modalSlideIn 0.3s ease; border: 1px solid var(--border-color); }
    @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
    .close-modal { position: absolute; top: 1rem; right: 1rem; width: 32px; height: 32px; border-radius: 50%; background: var(--light-color); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); z-index: 1; }
    .close-modal:hover { background: var(--border-color); }
    .modal-header { padding: 1.4rem; border-bottom: 1px solid var(--border-color); }
    .modal-body { padding: 1.2rem 1.4rem; }
    .modal-footer { padding: 1rem 1.4rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.6rem; }
    /* ==================== Tables ==================== */
    .table-container { overflow-x: auto; background: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow); }
    table { width: 100%; border-collapse: collapse; }
    thead { background: var(--light-color); }
    .dark-theme thead { background: #2a2a2a; }
    th { padding: 0.9rem; text-align: left; font-weight: 600; color: var(--text-color); border-bottom: 2px solid var(--border-color); }
    td { padding: 0.9rem; border-bottom: 1px solid var(--border-color); }
    tr:hover { background: var(--light-color); }
    .dark-theme tr:hover { background: #1b1b1b; }
    /* ==================== Chat Widget ==================== */
    .chat-container { position: fixed; bottom: 80px; right: 20px; width: 350px; height: 500px; background: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow-lg); display: none; flex-direction: column; z-index: 1500; animation: slideUp 0.3s ease; border: 1px solid var(--border-color); }
    .chat-container.active { display: flex; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .chat-header { padding: 0.8rem 1rem; background: var(--primary-color); color: white; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 0.8rem; display: flex; flex-direction: column; gap: 0.6rem; }
    .chat-message { display: flex; gap: 0.5rem; max-width: 80%; }
    .chat-message.own { align-self: flex-end; flex-direction: row-reverse; }
    .chat-message-avatar { width: 28px; height: 28px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; flex-shrink: 0; }
    .chat-message-content { flex: 1; }
    .chat-message-header { display: flex; gap: 0.4rem; margin-bottom: 0.2rem; font-size: 0.8rem; }
    .chat-message-name { font-weight: 600; }
    .chat-message-time { color: var(--text-secondary); }
    .chat-message-text { background: var(--light-color); padding: 0.55rem 0.7rem; border-radius: 10px; word-wrap: break-word; }
    .dark-theme .chat-message-text { background: #2a2a2a; color: #eaeaea; }
    .chat-message.own .chat-message-text { background: var(--primary-color); color: white; }
    .chat-input-container { padding: 0.7rem; border-top: 1px solid var(--border-color); display: flex; gap: 0.5rem; }
    .chat-input-container textarea { flex: 1; border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; resize: none; font-family: inherit; background: var(--bg-card); color: var(--text-color); }
    .chat-toggle-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: var(--shadow-lg); cursor: pointer; transition: var(--transition); z-index: 1400; }
    .chat-toggle-btn:hover { transform: scale(1.05); }
    .chat-badge { position: absolute; top: -5px; right: -5px; min-width: 20px; height: 20px; border-radius: 10px; background: var(--danger-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; padding: 0 5px; }
    /* ==================== Notifications ==================== */
    .notification-badge { position: absolute; top: -5px; right: -5px; min-width: 20px; height: 20px; border-radius: 10px; background: var(--danger-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; padding: 0 5px; }
    .notification-dropdown { position: absolute; right: 0; top: 36px; width: 360px; max-height: 60vh; overflow-y: auto; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: var(--shadow-lg); z-index: 1600; }
    .notification-dropdown-header, .notification-dropdown-footer { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .notification-dropdown-footer { border-top: 1px solid var(--border-color); border-bottom: none; }
    .notification-dropdown-body { max-height: 50vh; overflow-y: auto; }
    .notification-item { padding: 0.8rem; border-bottom: 1px solid var(--border-color); display: flex; gap: 0.8rem; cursor: pointer; transition: var(--transition); }
    .notification-item:hover { background: var(--light-color); }
    .dark-theme .notification-item:hover { background: #1b1b1b; }
    .notification-item.unread { background: #e8f0fe; }
    .dark-theme .notification-item.unread { background: #232c3d; }
    .notification-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0; }
    /* ==================== Toast ==================== */
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-card); padding: 0.8rem 1.2rem; border-radius: 8px; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 0.7rem; z-index: 3000; transition: var(--transition); opacity: 0; border: 1px solid var(--border-color); }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast-success { border-left: 4px solid var(--secondary-color); }
    .toast-error { border-left: 4px solid var(--danger-color); }
    .toast-warning { border-left: 4px solid var(--warning-color); }
    .toast-info { border-left: 4px solid var(--primary-color); }
    /* ==================== Batch Toolbar ==================== */
    .batch-toolbar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-card); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding: 0.8rem 1.2rem; transform: translateY(100%); transition: var(--transition); z-index: 1300; border-top: 1px solid var(--border-color); }
    .batch-toolbar.active { transform: translateY(0); }
    .batch-toolbar-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .batch-actions { display: flex; gap: 0.5rem; }
    /* ==================== Charts ==================== */
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 1.2rem; margin-bottom: 1.5rem; }
    .chart-card { background: var(--bg-card); border-radius: 12px; padding: 1rem; box-shadow: var(--shadow); }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; padding-bottom: 0.6rem; border-bottom: 1px solid var(--border-color); }
    .chart-container { height: 280px; position: relative; }
    /* ==================== QR Scanner ==================== */
    .qr-scanner-container { position: relative; width: 100%; background: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow-lg); }
    .scanner-video-container { position: relative; width: 100%; height: 360px; background: black; border-radius: 8px; overflow: hidden; }
    #qrVideo { width: 100%; height: 100%; object-fit: cover; }
    .scanner-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
    .scanner-frame { width: 240px; height: 240px; border: 3px solid var(--primary-color); border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); }
    /* ==================== Responsive ==================== */
    @media (max-width: 768px) {
      .navbar-menu { gap: 0.5rem; }
      .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
      .charts-grid { grid-template-columns: 1fr; }
      .chat-container { width: 100%; height: 100%; bottom: 0; right: 0; border-radius: 0; }
      .modal-content { max-width: 100%; max-height: 100vh; border-radius: 0; }
    }
    /* ==================== Utilities ==================== */
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mt-3 { margin-top: 1.5rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }
    .mb-3 { margin-bottom: 1.5rem; }
    .p-1 { padding: 0.5rem; }
    .p-2 { padding: 1rem; }
    .p-3 { padding: 1.5rem; }
    .hidden { display: none !important; }
    .visible { display: block !important; }
    .container { max-width: 1200px; margin: 0 auto; padding: 1.2rem; }
    .empty-state { text-align: center; padding: 2rem; color: var(--text-secondary); }
    .empty-state i { font-size: 3rem; margin-bottom: 0.8rem; opacity: 0.3; }
    /* Headers/Sections */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .section { margin-top: 1.2rem; }
    .section-header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 0.6rem; }
    /* Profile */
    .profile-cover { height: 120px; border-radius: 12px; display:flex; align-items:center; padding: 0.8rem; }
    .profile-info-header { display:flex; gap: 1rem; align-items: center; margin-top: -30px; }
    .profile-avatar-large { width: 80px; height: 80px; border-radius: 50%; background: var(--primary-color); color: #fff; display:flex; align-items:center; justify-content:center; font-size: 32px; position: relative; }
    .avatar-edit-btn { position:absolute; bottom:-6px; right:-6px; width:28px; height:28px; border-radius:50%; background:#fff; color:#333; display:flex; align-items:center; justify-content:center; border:1px solid var(--border-color); }
    .profile-badges .badge { display:inline-flex; align-items:center; gap:0.4rem; padding: 0.25rem 0.5rem; border-radius: 999px; background:#eef2ff; color:#333; font-size:0.8rem; margin-right: 0.4rem; }
    .badge-success { background: #e7f7ee; }
    .profile-stats { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.8rem; margin-top: 1rem; }
    .stat-card { background: var(--bg-card); border-radius: 12px; padding: 1rem; box-shadow: var(--shadow); display:flex; gap:0.8rem; align-items:center; }
    .stat-icon { width: 44px; height: 44px; border-radius: 10px; color:#fff; display:flex; align-items:center; justify-content:center; font-size: 1.1rem; }
    .profile-tabs { margin-top: 1rem; }
    .tabs-header { display:flex; gap:0.6rem; flex-wrap: wrap; }
    .tab-btn { padding: 0.5rem 0.8rem; border-radius: 8px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-color); }
    .tab-btn.active { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
    .info-section { background: var(--bg-card); border-radius: 12px; padding: 1rem; box-shadow: var(--shadow); }
    .info-section h3 { margin-bottom: 0.6rem; }
    .info-items { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.6rem; }
    .info-item label { color: var(--text-secondary); font-size: 0.85rem; }
    .info-item p { margin-top: 0.2rem; }
    .full-width { grid-column: 1 / -1; }
    .activity-record-item { background: var(--bg-card); border:1px solid var(--border-color); border-radius: 12px; padding: 0.8rem; display:flex; align-items:center; gap:0.8rem; justify-content: space-between; }
    .activity-record-icon { width:40px;height:40px;border-radius:8px;color:#fff; display:flex;align-items:center;justify-content:center; }
    .timeline-item { display:flex; gap: 0.8rem; margin-bottom: 0.8rem; }
    .timeline-marker { width:32px; height:32px; border-radius:50%; color:#fff; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .timeline-content { background: var(--bg-card); border:1px solid var(--border-color); border-radius: 12px; padding: 0.8rem; flex:1; }
    .timeline-header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 0.4rem; }
    .timeline-image { width:100%; border-radius: 8px; margin-top: 0.4rem; }
    /* search */
    .search-page .search-box-large { display:flex; gap:0.6rem; align-items:center; background: var(--bg-card); border:1px solid var(--border-color); border-radius: 12px; padding: 0.6rem 0.8rem; }
    .search-box-large input { flex:1; border:none; outline:none; background:transparent; color: var(--text-color); }
    .filter-chip { padding: 0.35rem 0.7rem; border-radius: 999px; background: var(--bg-card); border:1px solid var(--border-color); }
    .filter-chip.active { background: var(--primary-color); color:#fff; border-color: var(--primary-color); }
    .search-result-item { display:flex; align-items:center; justify-content: space-between; gap:0.8rem; padding: 0.8rem; border-bottom:1px solid var(--border-color); cursor:pointer; }
    .search-result-icon { width:40px;height:40px;border-radius:8px;color:#fff; display:flex; align-items:center; justify-content:center; }
    mark { background: #fff59d; }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>載入中...</p>
    </div>
  </div>

  <!-- 導覽列容器（固定） -->
  <div id="navbarMount"></div>

  <!-- Main Container -->
  <div id="app"></div>

  <!-- Chat Widget -->
  <div class="chat-container" id="chatContainer">
    <div class="chat-header">
      <h3><i class="fas fa-comments"></i> 病友交流</h3>
      <button class="btn btn-sm" onclick="toggleChat()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="chat-messages" id="chatMessages">
      <div class="chat-welcome">
        <i class="fas fa-comments"></i>
        <p>歡迎來到病友交流區</p>
      </div>
    </div>
    
    <div class="chat-input-container">
      <textarea id="chatInput" placeholder="輸入訊息..." rows="1" onkeydown="handleChatKeydown(event)"></textarea>
      <button class="btn btn-primary" onclick="sendChatMessage()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
  
  <button class="chat-toggle-btn" onclick="toggleChat()" id="chatToggleBtn">
    <i class="fas fa-comments"></i>
    <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
  </button>

  <!-- Scripts（完整單檔：含 utils / permissions / batch / email-editor 的最小可用版本與 Mock API） -->
  <script>
    // =============== utils.js - 工具函式（最小可用版） ===============
    function pad(n){return n<10?'0'+n:n}
    function formatDate(date, withWeek=false){
      try{
        const d = new Date(date);
        if(isNaN(d)) return '';
        const y=d.getFullYear(), m=pad(d.getMonth()+1), day=pad(d.getDate());
        const str = y+'/'+m+'/'+day;
        if(!withWeek) return str;
        const week = ['日','一','二','三','四','五','六'][d.getDay()];
        return str+'（週'+week+'）';
      }catch(e){return ''}
    }
    function formatTime(date){
      try{
        const d = new Date(date);
        if(isNaN(d)) return '';
        return pad(d.getHours())+':'+pad(d.getMinutes());
      }catch(e){return ''}
    }
    function formatDateTime(date){
      try{
        const d = new Date(date);
        if(isNaN(d)) return '';
        return formatDate(d)+' '+formatTime(d);
      }catch(e){return ''}
    }
    function formatRelativeTime(date){
      try{
        const d = new Date(date); const now = new Date();
        const diff = (now - d)/1000;
        if(diff<60) return '剛剛';
        if(diff<3600) return Math.floor(diff/60)+' 分鐘前';
        if(diff<86400) return Math.floor(diff/3600)+' 小時前';
        return Math.floor(diff/86400)+' 天前';
      }catch(e){return ''}
    }
    function calculateAge(date){
      try{
        const d = new Date(date); if(isNaN(d)) return '';
        const now = new Date();
        let age = now.getFullYear()-d.getFullYear();
        const m = now.getMonth()-d.getMonth();
        if(m<0 || (m===0 && now.getDate()<d.getDate())) age--;
        return age;
      }catch(e){return ''}
    }
    function truncateText(text, len=100){
      if(!text) return '';
      return text.length>len? text.slice(0,len)+'…': text;
    }
    function animateNumber(id, value, suffix='', fixed=0){
      const el = document.getElementById(id);
      if(!el) return;
      const start = parseFloat((el.textContent||'0').replace('%',''))||0;
      const end = typeof value==='number'? value: parseFloat(value)||0;
      const diff = end-start;
      const duration = 500; const startTime = performance.now();
      function step(now){
        const t = Math.min(1, (now-startTime)/duration);
        const cur = start + diff*t;
        el.textContent = (fixed? cur.toFixed(fixed): Math.round(cur)) + suffix;
        if(t<1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }
    function updatePagination(pagination, containerId, onPage){
      const container = document.getElementById(containerId);
      if(!container || !pagination) return;
      const { page, totalPages } = pagination;
      let html = '';
      const mkBtn=(p,txt,dis=false)=>`<button class="btn btn-sm" ${dis?'disabled':''} onclick="${dis?'':`${onPage.name}(${p})`}">${txt}</button>`;
      html += mkBtn(1,'«',page<=1);
      html += mkBtn(page-1,'‹',page<=1);
      html += `<span style="margin:0 0.5rem;">第 ${page} / ${totalPages} 頁</span>`;
      html += mkBtn(page+1,'›',page>=totalPages);
      html += mkBtn(totalPages,'»',page>=totalPages);
      container.innerHTML = html;
    }
    function generateStars(score){
      const s = Math.max(0, Math.min(5, Math.round(score)));
      return '<span style="color:#fbbc04;">' + '★'.repeat(s) + '☆'.repeat(5-s) + '</span>';
    }
    function escapeHtml(str=''){
      return String(str).replace(/[&<>"'`=\/]/g,function(s){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[s] || s;
      });
    }
    function getRandomGradient(){
      const gs=[
        '#667eea,#764ba2','#f093fb,#f5576c','#4facfe,#00f2fe','#43e97b,#38f9d7','#fa709a,#fee140'
      ];
      const [a,b]=gs[Math.floor(Math.random()*gs.length)].split(',');
      return `${a} 0%, ${b} 100%`;
    }
    function getActivityIcon(type){
      const map={'健康講座':'stethoscope','復健課程':'dumbbell','社交活動':'users','志工服務':'hands-helping','其他':'calendar'};
      return map[type]||'calendar';
    }
    function getActivityStatus(a){
      const now = new Date();
      const start = new Date(a['開始時間']);
      const end = new Date(a['結束時間']||a['開始時間']);
      if(a['已取消']) return 'cancelled';
      if(now<start) return 'upcoming';
      if(now>=start && now<=end) return 'ongoing';
      if(a['已報名人數']>=a['人數上限']) return 'full';
      return 'completed';
    }
    function getActivityStatusText(a){
      const s = getActivityStatus(a);
      const map={upcoming:'即將舉辦',ongoing:'進行中',completed:'已結束',cancelled:'已取消',full:'額滿'};
      return map[s]||'';
    }
    function validateEmail(email){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }
    // 日期與時區、語系等偏好可擴充，先提供簡易版
    function getNotificationIcon(type){
      const icons={activity:'calendar-check',message:'comment',system:'info-circle',reminder:'bell',achievement:'trophy'};
      return icons[type]||'bell';
    }
    function getNotificationColor(type){
      const colors={
        activity:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        message:'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        system:'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        reminder:'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
        achievement:'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
      };
      return colors[type]||colors.system;
    }
    function getActivityTypeColor(type){
      const colors={
        '健康講座':'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        '復健課程':'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        '社交活動':'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        '志工服務':'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
        '其他':'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
      };
      return colors[type]||colors['其他'];
    }
    function getTimelineIcon(type){ const icons={activity:'calendar-check',achievement:'trophy',join:'user-plus',update:'edit',comment:'comment'}; return icons[type]||'circle'; }
    function getTimelineColor(type){ const colors={activity:'#667eea',achievement:'#f5576c',join:'#4facfe',update:'#43e97b',comment:'#fa709a'}; return colors[type]||'#999'; }
  </script>

  <script>
    // =============== permissions.js - 最小可用權限管理 ===============
    const PermissionManager = {
      // 角色: admin / staff / member
      hasPermission(code){
        const user = window.currentUser;
        if(!user) return false;
        const role = user.role || 'member';
        const map = {
          view_dashboard: ['admin','staff'],
          view_members: ['admin','staff'],
          view_reports: ['admin','staff'],
          manage_activities: ['admin','staff'],
          manage_members: ['admin'],
          manage_system: ['admin']
        };
        if(!map[code]) return true;
        return map[code].includes(role);
      }
    };
  </script>

  <script>
    // =============== batch.js - 最小可用批次操作 ===============
    const BatchOperations = {
      activeTableId: null,
      init(tableId){
        this.activeTableId = tableId;
        showToast('批次操作模式啟動', 'info');
        const bar = document.getElementById('batchToolbar');
        if(bar) bar.classList.add('active');
      },
      clear(){
        this.activeTableId = null;
        const bar = document.getElementById('batchToolbar');
        if(bar) bar.classList.remove('active');
      }
    };
  </script>

  <script>
    // =============== email-editor.js - 最小可用樣板編輯入口占位 ===============
    function createEmailTemplateEditor(){
      return `
        <div class="container">
          <div class="page-header">
            <h1><i class="fas fa-envelope"></i> 電子郵件樣板</h1>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="fas fa-edit"></i> 編輯中</div>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label>樣板名稱</label>
                <input class="form-control" placeholder="例如：活動報名成功通知">
              </div>
              <div class="form-group">
                <label>主旨</label>
                <input class="form-control" placeholder="[腦帕金森病友會] 活動報名成功">
              </div>
              <div class="form-group">
                <label>內容</label>
                <textarea class="form-control" rows="8" placeholder="親愛的 {{name}} 您好..."></textarea>
              </div>
              <div class="text-right">
                <button class="btn btn-secondary" onclick="navigateTo('home')"><i class="fas fa-arrow-left"></i> 返回</button>
                <button class="btn btn-primary"><i class="fas fa-save"></i> 儲存</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }
  </script>

  <script>
    // =============== Mock API 與真實 API 封裝 ===============
    // 基本 fetch with timeout
    async function fetchWithTimeout(url, options={}, timeout=10000){
      return await Promise.race([
        fetch(url, options),
        new Promise((_,rej)=> setTimeout(()=>rej(new Error('請求逾時')), timeout))
      ]);
    }
    async function callServerFunction(fnName, payload){
      if(MOCK_ON) return mockApi(fnName, payload);
      const res = await fetchWithTimeout(SCRIPT_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action: fnName, payload })
      });
      if(!res.ok) throw new Error('網路錯誤 '+res.status);
      return await res.json();
    }
    const CacheManager = {
      init(){},
      key(action, payload){ return 'api_'+action+'_'+(payload? btoa(unescape(encodeURIComponent(JSON.stringify(payload)))).slice(0,40):''); },
      get(k){ try{ const v=localStorage.getItem(k); if(!v) return null; const o=JSON.parse(v); if(o.exp && Date.now()>o.exp){ localStorage.removeItem(k); return null; } return o.data; }catch(e){ return null; } },
      set(k,data,ttlMin=5){ const exp = Date.now()+ttlMin*60000; localStorage.setItem(k, JSON.stringify({exp, data})); },
      clear(prefix){ Object.keys(localStorage).forEach(k=>{ if(k.startsWith(prefix)) localStorage.removeItem(k); }); },
      clearAll(){ Object.keys(localStorage).forEach(k=>{ if(k.startsWith('api_')) localStorage.removeItem(k); }); }
    };
    async function callServerFunctionWithCache(action, payload={}, ttlMin=5){
      const k = CacheManager.key(action, payload);
      const cached = CacheManager.get(k);
      if(cached) return { success:true, ...cached };
      const res = await callServerFunction(action, payload);
      if(res && res.success) CacheManager.set(k, res, ttlMin);
      return res;
    }
    const OfflineManager = {
      init(){},
      syncOfflineData(){/* 可擴充 */}
    };
    const PerformanceMonitor = {
      logPageLoad(){/* 可擴充 */}
    };
    // Mock 資料
    const MOCK_DB = (function(){
      const now = new Date();
      const addDays = (d)=> new Date(now.getTime()+d*86400000).toISOString();
      const activities = Array.from({length:12}).map((_,i)=>({
        '活動ID': 'A'+(1000+i),
        '活動名稱': '活動 '+(i+1),
        '活動類型': ['健康講座','復健課程','社交活動','志工服務','其他'][i%5],
        '開始時間': addDays(i-2),
        '結束時間': addDays(i-2)+'' ,
        '活動地點': ['台北市','新北市','桃園市','台中市','高雄市'][i%5],
        '已報名人數': Math.floor(Math.random()*30),
        '人數上限': 30,
        '活動說明': '這是一個示範用的活動說明，內容僅供展示。',
        '負責人': ['王小明','李小美','陳大文'][i%3],
        '聯絡電話': '02-1234-5678'
      }));
      const members = Array.from({length:25}).map((_,i)=>({
        '會員ID': 'M'+(1000+i),
        '姓名': ['李雷','韓梅梅','張偉','王芳','陳冠宇','林雅婷','吳宗憲','謝怡君'][i%8]+(i+1),
        '性別': i%2===0?'男':'女',
        '電話': '09'+(Math.floor(Math.random()*90000000)+10000000),
        '電子郵件': 'user'+i+'@mail.com',
        '加入日期': addDays(-i-10),
        '狀態': i%7===0?'停用':'啟用',
        '地址': '台灣某地區路段'+i+'號',
        '出生日期': addDays(-1000 - i*30),
        '最後活動日期': addDays(-(i%15)),
        '參與活動數': Math.floor(Math.random()*20),
        '積分': Math.floor(Math.random()*300),
        '緊急聯絡人': '家人'+i,
        '緊急聯絡電話': '02-1234567',
        '特殊需求': i%5===0?'需輪椅':''
      }));
      let chatMessages = [];
      let notifications = [];
      let reports = [];
      return { activities, members, chatMessages, notifications, reports };
    })();
    async function mockApi(action, payload){
      // 簡易延遲模擬
      await new Promise(r=>setTimeout(r, 200));
      const ok = (data={})=>({success:true, ...data});
      const fail = (msg)=>({success:false, error: msg||'發生錯誤'});
      switch(action){
        case 'login': {
          const { username, password } = payload;
          if(username && password){
            const user = {
              id: 'U1001',
              name: username==='admin'?'管理員': '王小明',
              email: 'user@mail.com',
              role: username==='admin'?'admin':'staff',
              status: '啟用',
              joinDate: new Date().toISOString()
            };
            return ok({ user });
          }
          return fail('帳密錯誤');
        }
        case 'register': return ok({});
        case 'forgotPassword': return ok({});
        case 'getHomeStats': return ok({ stats: { upcomingActivities: 5, myRegistrations: 3, myPoints: 120 }});
        case 'getLatestActivities': return ok({ activities: MOCK_DB.activities.slice(0,6) });
        case 'getLatestNews': return ok({ news: [
          { title:'公告：本月社交活動開放報名', content:'歡迎大家踴躍參加。', createdAt: new Date() },
          { title:'志工服務徵求', content:'需要人手協助長者復健活動。', createdAt: new Date(Date.now()-3600*1000) }
        ]});
        case 'getActivities': return ok({ activities: MOCK_DB.activities });
        case 'getActivityDetail': {
          const a = MOCK_DB.activities.find(x=>x['活動ID']===payload.activityId);
          if(!a) return fail('活動不存在');
          return ok({ activity: a });
        }
        case 'registerActivity': return ok({});
        case 'getMembers': {
          const page = payload.page||1, per=10;
          const total = MOCK_DB.members.length;
          const start = (page-1)*per;
          return ok({
            members: MOCK_DB.members.slice(start, start+per),
            stats: { total, active: MOCK_DB.members.filter(m=>m['狀態']==='啟用').length, newThisMonth: 3 },
            pagination: { page, totalPages: Math.ceil(total/per) }
          });
        }
        case 'getMemberDetail': {
          const m = MOCK_DB.members.find(x=>x['會員ID']===payload.memberId);
          if(!m) return fail('會員不存在');
          return ok({ member: m });
        }
        case 'getMemberActivityHistory': {
          return ok({ activities: MOCK_DB.activities.slice(0,5).map(a=>({ ...a, '活動日期': a['開始時間'], '出席狀態': Math.random()>0.3?'已出席':'缺席' })) });
        }
        case 'addMember': return ok({});
        case 'updateMember': return ok({});
        case 'deleteMember': return ok({});
        case 'exportMembers': return ok({ downloadUrl: 'https://example.com/fake-members.xlsx' });
        case 'getChatMessages': return ok({ messages: MOCK_DB.chatMessages.slice(-50) });
        case 'sendChatMessage': {
          const { senderId, senderName, message } = payload;
          MOCK_DB.chatMessages.push({ senderId, senderName, message, timestamp: new Date().toISOString() });
          return ok({});
        }
        case 'getUnreadMessageCount': return ok({ count: Math.max(0, MOCK_DB.chatMessages.length-10) });
        case 'getNotifications': {
          if(MOCK_DB.notifications.length===0){
            MOCK_DB.notifications = [
              { id:'N1', type:'activity', title:'活動提醒', message:'您報名的健康講座將於明日舉行', timestamp:new Date(), read:false, activityId:'A1000' },
              { id:'N2', type:'message', title:'新訊息', message:'病友留言給您', timestamp:new Date(Date.now()-3600*1000), read:false }
            ];
          }
          return ok({ notifications: MOCK_DB.notifications });
        }
        case 'markNotificationAsRead': {
          const n = MOCK_DB.notifications.find(n=>n.id===payload.notificationId);
          if(n) n.read = true;
          return ok({});
        }
        case 'markAllNotificationsAsRead': {
          MOCK_DB.notifications.forEach(n=>n.read=true);
          return ok({});
        }
        case 'savePushSubscription': return ok({});
        case 'removePushSubscription': return ok({});
        case 'getDashboardData': {
          return ok({
            kpis: {
              totalMembers: 250,
              membersTrend: 5,
              totalActivities: 18,
              activitiesTrend: 2,
              attendanceRate: 78,
              attendanceTrend: 3,
              satisfaction: 4.2,
              satisfactionTrend: 0.1
            },
            charts: {
              memberGrowth: { label:'會員數', labels:['一月','二月','三月','四月','五月','六月'], values:[120,140,160,180,210,250] },
              activityParticipation: { label:'參與數', labels:['講座','復健','社交','志工','其他'], values:[60,40,55,30,20] },
              activityType: { labels:['講座','復健','社交','志工','其他'], values:[30,25,20,15,10] },
              locationDistribution: { labels:['台北','新北','桃園','台中','高雄'], values:[50,40,30,25,20] }
            },
            tables: {
              topActivities: Array.from({length:10}).map((_,i)=>({ name:'活動'+(i+1), participants: Math.floor(Math.random()*50)+10, satisfaction: Math.random()*2+3 })),
              activeMembers: Array.from({length:10}).map((_,i)=>({ name:'會員'+(i+1), participations: Math.floor(Math.random()*15)+1, lastParticipation: new Date(Date.now()-i*86400000) }))
            }
          });
        }
        case 'exportDashboard': return ok({ downloadUrl: 'https://example.com/fake-dashboard.pdf' });
        case 'getUpcomingActivities': {
          return ok({ activities: MOCK_DB.activities.filter(a=> new Date(a['開始時間'])>new Date()).slice(0,8) });
        }
        case 'checkInActivity': return ok({ activity: { name:'健康講座示範' } });
        case 'getReportHistory': return ok({ reports: MOCK_DB.reports });
        case 'generateReport': {
          const id = 'R'+(1000+MOCK_DB.reports.length);
          MOCK_DB.reports.unshift({
            id, name: payload.reportName, type: payload.type, generatedAt: new Date(), generatedBy: payload.generatedBy
          });
          return ok({ downloadUrl:'https://example.com/fake-report.pdf' });
        }
        case 'generateQuickReport': return ok({ downloadUrl: 'https://example.com/quick-report.pdf' });
        case 'getReportDownloadUrl': return ok({ downloadUrl: 'https://example.com/report.pdf' });
        case 'deleteReport': {
          MOCK_DB.reports = MOCK_DB.reports.filter(r=>r.id!==payload.reportId);
          return ok({});
        }
        case 'getProfileStats': {
          return ok({ stats: { activitiesCount: 22, attendanceRate: 85, points: 300, memberDays: 540 } });
        }
        case 'getUserActivities': {
          return ok({ activities: MOCK_DB.activities.slice(0,8).map(a=>({ ...a, '活動日期': a['開始時間'], '出席狀態': Math.random()>0.2?'已出席':'缺席' })) });
        }
        case 'getUserAchievements': {
          return ok({ achievements: [
            { icon:'trophy', name:'初次參與', description:'首次參加活動', unlocked:true, unlockedDate:new Date() },
            { icon:'fire', name:'連續參與', description:'連續三次活動', unlocked:false },
            { icon:'hands-helping', name:'志工之星', description:'參與志工服務 5 次', unlocked:false }
          ]});
        }
        case 'getUserTimeline': {
          return ok({ timeline: [
            { type:'join', title:'加入病友會', description:'歡迎加入我們！', timestamp:new Date(Date.now()-5*86400000) },
            { type:'activity', title:'參加健康講座', description:'認識帕金森病之旅', timestamp:new Date(Date.now()-2*86400000) },
            { type:'achievement', title:'獲得初次參與成就', description:'持續努力！', timestamp:new Date(Date.now()-1*86400000) }
          ]});
        }
        case 'updateEmail': return ok({});
        case 'changePassword': return ok({});
        case 'deleteAccount': return ok({});
        case 'exportUserData': return ok({ downloadUrl:'https://example.com/mydata.zip' });
        case 'backupSystemData': return ok({});
        case 'updateProfile': return ok({});
        case 'updateAvatar': return ok({ avatarUrl:'https://example.com/avatar.png' });
        case 'createActivity': return ok({});
        default: return fail('未知的動作：'+action);
      }
    }
  </script>

  <script>
    // =============== APP 主程式（含原本所有頁面與修正） ===============
    let currentUser = null;
    let currentPage = 'home';
    let currentSearchFilter = 'all';

    // Page visibility（避免背景輪詢）
    document.addEventListener('visibilitychange', () => {
      const hidden = document.hidden;
      if(hidden){
        stopChatPolling();
        stopNotificationPolling();
      }else{
        if(currentUser){
          startChatPolling();
          startNotificationPolling();
        }
      }
    });

    // 初始化
    function initializeApp() {
      try {
        // 初始化快取/離線/效能
        CacheManager.init();
        OfflineManager.init();
        PerformanceMonitor.logPageLoad();
        // 網路事件
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);
        // Service Worker
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/service-worker.js')
            .then(()=>console.log('Service Worker 註冊成功'))
            .catch(err=>console.log('Service Worker 註冊失敗:', err));
        }
        // 恢復登入狀態
        const savedUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
        if (savedUser) {
          currentUser = JSON.parse(savedUser);
          navigateTo('home');
          // 登入後才啟動背景工作
          initNotifications();
          setIntervalSafe(checkNewMessages, 10000, 'chatCheck');
        } else {
          navigateTo('login');
        }
      } catch (e) {
        console.error(e);
        showToast('初始化失敗: '+e.message, 'error');
      }
    }
    function setIntervalSafe(fn, ms, key){
      if(!window.__intervals) window.__intervals = {};
      if(window.__intervals[key]) clearInterval(window.__intervals[key]);
      window.__intervals[key] = setInterval(()=>{ if(!document.hidden) fn(); }, ms);
    }

    // 導航
    function navigateTo(page, params = {}) {
      currentPage = page;
      history.pushState({ page, params }, '', `#${page}`);
      renderNavigation(); // 固定更新 navbarMount
      renderPage(page, params);
      window.scrollTo(0, 0);
    }
    function renderNavigation(){
      const mount = document.getElementById('navbarMount');
      if(!currentUser){ mount.innerHTML = ''; return; }
      mount.innerHTML = `
        <nav class="navbar">
          <div class="navbar-container">
            <a href="#" class="navbar-brand" onclick="navigateTo('home'); return false;">
              <i class="fas fa-heartbeat"></i> 腦帕金森病友會
            </a>
            <div class="navbar-menu">
              <a href="#" class="nav-link ${currentPage==='home'?'active':''}" onclick="navigateTo('home'); return false;"><i class="fas fa-home"></i> 首頁</a>
              <a href="#" class="nav-link ${currentPage==='activities'?'active':''}" onclick="navigateTo('activities'); return false;"><i class="fas fa-calendar-alt"></i> 活動</a>
              ${PermissionManager.hasPermission('view_dashboard')?`
                <a href="#" class="nav-link ${currentPage==='dashboard'?'active':''}" onclick="navigateTo('dashboard'); return false;"><i class="fas fa-chart-line"></i> 儀表板</a>
              `:''}
              ${PermissionManager.hasPermission('view_members')?`
                <a href="#" class="nav-link ${currentPage==='members'?'active':''}" onclick="navigateTo('members'); return false;"><i class="fas fa-users"></i> 會員</a>
              `:''}
              ${PermissionManager.hasPermission('view_reports')?`
                <a href="#" class="nav-link ${currentPage==='reports'?'active':''}" onclick="navigateTo('reports'); return false;"><i class="fas fa-file-alt"></i> 報表</a>
              `:''}
              <a href="#" class="nav-link ${currentPage==='email-editor'?'active':''}" onclick="navigateTo('email-editor'); return false;"><i class="fas fa-envelope"></i> 郵件樣板</a>

              <div class="notification-icon" onclick="toggleNotifications()">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationBadge" style="display:none;">0</span>
              </div>

              <div class="user-menu">
                <div class="user-avatar" onclick="toggleUserMenu()">${escapeHtml(currentUser.name.charAt(0))}</div>
                <div class="dropdown-menu" id="userDropdown">
                  <a href="#" onclick="navigateTo('profile'); toggleUserMenu(false); return false;"><i class="fas fa-user"></i> 個人資料</a>
                  <a href="#" onclick="navigateTo('settings'); toggleUserMenu(false); return false;"><i class="fas fa-cog"></i> 設定</a>
                  <a href="#" onclick="logout(); return false;"><i class="fas fa-sign-out-alt"></i> 登出</a>
                </div>
              </div>
            </div>
          </div>
        </nav>
      `;
    }
    function toggleUserMenu(force){
      const dropdown = document.getElementById('userDropdown');
      if(!dropdown) return;
      if(typeof force==='boolean'){ dropdown.style.display = force?'block':'none'; return; }
      dropdown.style.display = dropdown.style.display==='block' ? 'none' : 'block';
    }
    function logout(){
      if (!confirm('確定要登出嗎？')) return;
      localStorage.removeItem('currentUser');
      sessionStorage.removeItem('currentUser');
      currentUser = null;
      stopChatPolling();
      stopNotificationPolling();
      navigateTo('login');
      showToast('已登出', 'success');
    }
    window.addEventListener('popstate', (event) => {
      if (event.state && event.state.page) {
        currentPage = event.state.page;
        renderNavigation();
        renderPage(event.state.page, event.state.params || {});
      }
    });

    // Toast
    function showToast(message, type='info'){
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `<i class="fas fa-${getToastIcon(type)}"></i><span>${escapeHtml(message)}</span>`;
      document.body.appendChild(toast);
      setTimeout(()=> toast.classList.add('show'), 50);
      setTimeout(()=>{
        toast.classList.remove('show');
        setTimeout(()=> toast.remove(), 300);
      }, 2800);
    }
    function getToastIcon(type){
      const icons = {success:'check-circle', error:'exclamation-circle', warning:'exclamation-triangle', info:'info-circle'};
      return icons[type]||'info-circle';
    }

    // 線上/離線
    function handleOnline(){
      document.body.classList.remove('offline');
      showToast('網路已連接', 'success');
      OfflineManager.syncOfflineData();
    }
    function handleOffline(){
      document.body.classList.add('offline');
      showToast('網路已斷線，部分功能可能無法使用', 'warning');
    }

    // ============ Pages 渲染 ============
    function renderPage(page, params={}){
      const app = document.getElementById('app');
      switch(page){
        case 'login': app.innerHTML = createLoginPage(); break;
        case 'register': app.innerHTML = createRegisterPage(); break;
        case 'home': app.innerHTML = createHomePage(); loadHomeData(); break;
        case 'dashboard': app.innerHTML = createDashboard(); loadDashboardData(); break;
        case 'activities': app.innerHTML = createActivitiesPage(); loadActivities(); break;
        case 'activity-detail': app.innerHTML = createActivityDetailPage(params.id); loadActivityDetail(params.id); break;
        case 'members': app.innerHTML = createMembersPage(); loadMembers(); break;
        case 'profile': app.innerHTML = createProfilePage(); setTimeout(()=>{ loadProfileStats(); }, 50); break;
        case 'reports': app.innerHTML = createReportsPage(); setTimeout(()=> loadReportHistory(),50); break;
        case 'settings': app.innerHTML = createSettingsPage(); break;
        case 'qr-scanner': app.innerHTML = createQRScannerInterface(); setTimeout(()=> loadActivitiesForQR(), 50); break;
        case 'email-editor': app.innerHTML = createEmailTemplateEditor(); break;
        case 'permissions': app.innerHTML = `<div class="container"><h1><i class="fas fa-user-shield"></i> 權限管理</h1><p>示範頁。</p></div>`; break;
        default: app.innerHTML = '<div class="container"><h1>404 - 頁面不存在</h1></div>';
      }
    }

    // ============ AUTH ============
    function createLoginPage(){
      return `
        <div class="container">
          <div class="card" style="max-width:520px; margin: 2rem auto;">
            <div class="card-header text-center">
              <div class="card-title"><i class="fas fa-heartbeat"></i> 腦帕金森病友會</div>
              <p>會員管理系統</p>
            </div>
            <div class="card-body">
              <form onsubmit="handleLogin(event)">
                <div class="form-group">
                  <label>帳號</label>
                  <input type="text" id="loginUsername" class="form-control" placeholder="請輸入帳號" required>
                </div>
                <div class="form-group">
                  <label>密碼</label>
                  <input type="password" id="loginPassword" class="form-control" placeholder="請輸入密碼" required>
                </div>
                <div class="form-group">
                  <label><input type="checkbox" id="rememberMe"> 記住我</label>
                </div>
                <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-sign-in-alt"></i> 登入</button>
                <div class="text-center mt-2">
                  <a href="#" onclick="navigateTo('register'); return false;">還沒有帳號？立即註冊</a> |
                  <a href="#" onclick="showForgotPassword(); return false;">忘記密碼？</a>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
    }
    function createRegisterPage(){
      return `
        <div class="container">
          <div class="card" style="max-width:720px; margin: 1.5rem auto;">
            <div class="card-header">
              <div class="card-title"><i class="fas fa-user-plus"></i> 會員註冊</div>
              <p>加入我們的大家庭</p>
            </div>
            <div class="card-body">
              <form onsubmit="handleRegister(event)">
                <div class="form-row">
                  <div class="form-group">
                    <label>姓名 *</label>
                    <input type="text" id="registerName" class="form-control" required>
                  </div>
                  <div class="form-group">
                    <label>性別 *</label>
                    <select id="registerGender" class="form-control" required>
                      <option value="">請選擇</option>
                      <option value="男">男</option>
                      <option value="女">女</option>
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label>出生日期 *</label>
                  <input type="date" id="registerBirthDate" class="form-control" required>
                </div>
                <div class="form-group">
                  <label>電話 *</label>
                  <input type="tel" id="registerPhone" class="form-control" required>
                </div>
                <div class="form-group">
                  <label>電子郵件 *</label>
                  <input type="email" id="registerEmail" class="form-control" required>
                </div>
                <div class="form-group">
                  <label>地址</label>
                  <input type="text" id="registerAddress" class="form-control">
                </div>
                <div class="form-group">
                  <label>帳號 *</label>
                  <input type="text" id="registerUsername" class="form-control" required>
                </div>
                <div class="form-group">
                  <label>密碼 *</label>
                  <input type="password" id="registerPassword" class="form-control" minlength="6" required>
                </div>
                <div class="form-group">
                  <label>確認密碼 *</label>
                  <input type="password" id="registerPasswordConfirm" class="form-control" required>
                </div>
                <div class="form-group">
                  <label><input type="checkbox" id="agreeTerms" required> 我同意服務條款與隱私政策</label>
                </div>
                <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-user-plus"></i> 註冊</button>
                <div class="text-center mt-2">
                  <a href="#" onclick="navigateTo('login'); return false;">已有帳號？立即登入</a>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
    }
    async function handleLogin(event){
      event.preventDefault();
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const rememberMe = document.getElementById('rememberMe').checked;
      document.getElementById('loadingOverlay').classList.add('active');
      try{
        const result = await callServerFunction('login', { username, password });
        document.getElementById('loadingOverlay').classList.remove('active');
        if(result.success){
          currentUser = result.user;
          if (rememberMe) localStorage.setItem('currentUser', JSON.stringify(currentUser));
          else sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
          showToast('登入成功！', 'success');
          navigateTo('home');
          // 啟動背景輪詢
          initNotifications();
          setIntervalSafe(checkNewMessages, 10000, 'chatCheck');
          // 推播
          if (localStorage.getItem('pushSubscribed') !== 'true') {
            setTimeout(async () => {
              if (confirm('是否要開啟推播通知以接收最新消息？')) {
                try{
                  await subscribeToPush();
                }catch(e){
                  // 回復開關
                  const el = document.getElementById('pushNotificationSetting');
                  if(el) el.checked = false;
                }
              }
            }, 1200);
          }
        }else{
          showToast('登入失敗：'+ result.error, 'error');
        }
      }catch(e){
        document.getElementById('loadingOverlay').classList.remove('active');
        showToast('系統錯誤：'+e.message, 'error');
      }
    }
    async function handleRegister(event){
      event.preventDefault();
      const pwd = document.getElementById('registerPassword').value;
      const pwd2 = document.getElementById('registerPasswordConfirm').value;
      if(pwd!==pwd2){ showToast('密碼不一致，請重新輸入', 'error'); return; }
      const data = {
        name: document.getElementById('registerName').value,
        gender: document.getElementById('registerGender').value,
        birthDate: document.getElementById('registerBirthDate').value,
        phone: document.getElementById('registerPhone').value,
        email: document.getElementById('registerEmail').value,
        address: document.getElementById('registerAddress').value,
        username: document.getElementById('registerUsername').value,
        password: pwd
      };
      document.getElementById('loadingOverlay').classList.add('active');
      try{
        const result = await callServerFunction('register', data);
        document.getElementById('loadingOverlay').classList.remove('active');
        if(result.success){
          showToast('註冊成功！請登入', 'success');
          navigateTo('login');
        }else showToast('註冊失敗：'+result.error, 'error');
      }catch(e){
        document.getElementById('loadingOverlay').classList.remove('active');
        showToast('系統錯誤：'+e.message, 'error');
      }
    }
    function showForgotPassword(){
      const email = prompt('請輸入您的註冊電子郵件：'); if(!email) return;
      document.getElementById('loadingOverlay').classList.add('active');
      callServerFunction('forgotPassword', { email }).then(result=>{
        document.getElementById('loadingOverlay').classList.remove('active');
        showToast(result.success?'重設密碼連結已發送到您的信箱':'發送失敗：'+result.error, result.success?'success':'error');
      }).catch(e=>{
        document.getElementById('loadingOverlay').classList.remove('active');
        showToast('系統錯誤：'+e.message, 'error');
      });
    }

    // ============ HOME ============
    function createHomePage(){
      return `
        <div class="container">
          <div class="page-header">
            <div>
              <h1>歡迎回來，${escapeHtml(currentUser.name)}！</h1>
              <p>今天是 ${formatDate(new Date(), true)}</p>
            </div>
            <div>
              <button class="btn btn-secondary" onclick="navigateTo('qr-scanner')"><i class="fas fa-qrcode"></i> QR 簽到</button>
            </div>
          </div>
          <div class="grid grid-3" id="quickStats">
            <div class="stat-card">
              <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-calendar-check"></i></div>
              <div class="stat-content">
                <h3 id="upcomingActivitiesCount">-</h3>
                <p>即將舉辦的活動</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><i class="fas fa-user-check"></i></div>
              <div class="stat-content">
                <h3 id="myRegistrationsCount">-</h3>
                <p>我的報名</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"><i class="fas fa-trophy"></i></div>
              <div class="stat-content">
                <h3 id="myPointsCount">-</h3>
                <p>我的積分</p>
              </div>
            </div>
          </div>
          <section class="section">
            <div class="section-header">
              <h2><i class="fas fa-calendar-alt"></i> 最新活動</h2>
              <a href="#" onclick="navigateTo('activities'); return false;" class="btn btn-primary btn-sm">查看全部 <i class="fas fa-arrow-right"></i></a>
            </div>
            <div class="grid grid-3" id="latestActivities"><div class="loading">載入中...</div></div>
          </section>
          <section class="section">
            <div class="section-header"><h2><i class="fas fa-bullhorn"></i> 最新消息</h2></div>
            <div id="newsList"><div class="loading">載入中...</div></div>
          </section>
          <section class="section">
            <div class="section-header"><h2><i class="fas fa-bolt"></i> 快速操作</h2></div>
            <div class="grid grid-4">
              <button class="btn btn-primary" onclick="navigateTo('activities')"><i class="fas fa-calendar-plus"></i> 報名活動</button>
              <button class="btn btn-secondary" onclick="navigateTo('profile')"><i class="fas fa-user-edit"></i> 編輯資料</button>
              <button class="btn btn-primary" onclick="navigateTo('qr-scanner')"><i class="fas fa-qrcode"></i> QR 簽到</button>
              <button class="btn btn-secondary" onclick="toggleChat()"><i class="fas fa-comments"></i> 病友交流</button>
            </div>
          </section>
        </div>
      `;
    }
    async function loadHomeData(){
      try{
        const statsResult = await callServerFunctionWithCache('getHomeStats', { memberId: currentUser.id }, 5);
        if(statsResult.success){
          document.getElementById('upcomingActivitiesCount').textContent = statsResult.stats.upcomingActivities;
          document.getElementById('myRegistrationsCount').textContent = statsResult.stats.myRegistrations;
          document.getElementById('myPointsCount').textContent = statsResult.stats.myPoints;
        }
        const activitiesResult = await callServerFunctionWithCache('getLatestActivities', { limit:6 }, 5);
        if(activitiesResult.success) displayLatestActivities(activitiesResult.activities);
        const newsResult = await callServerFunctionWithCache('getLatestNews', { limit:5 }, 5);
        if(newsResult.success) displayLatestNews(newsResult.news);
      }catch(e){
        console.error('載入首頁資料失敗:', e);
        showToast('載入資料失敗', 'error');
      }
    }
    function displayLatestActivities(activities){
      const container = document.getElementById('latestActivities');
      if(!activities || activities.length===0){
        container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar"></i><p>目前沒有活動</p></div>';
        return;
      }
      container.innerHTML = activities.map(a=>`
        <div class="activity-card" onclick="navigateTo('activity-detail', {id: '${a['活動ID']}'})">
          <div class="activity-image" style="background: linear-gradient(135deg, ${getRandomGradient()});">
            <i class="fas fa-${getActivityIcon(a['活動類型'])}"></i>
          </div>
          <div class="activity-content">
            <span class="activity-category">${escapeHtml(a['活動類型'])}</span>
            <h3 class="activity-title">${escapeHtml(a['活動名稱'])}</h3>
            <div class="activity-meta">
              <span><i class="fas fa-calendar"></i> ${formatDate(a['開始時間'])}</span>
              <span><i class="fas fa-map-marker-alt"></i> ${escapeHtml(a['活動地點'])}</span>
              <span><i class="fas fa-users"></i> ${a['已報名人數']}/${a['人數上限']}</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" style="width:${(a['已報名人數']/a['人數上限']*100)}%"></div></div>
            <div class="activity-footer">
              <span class="status-badge ${getActivityStatus(a)}">${getActivityStatusText(a)}</span>
              <button class="btn btn-primary btn-sm">查看詳情</button>
            </div>
          </div>
        </div>
      `).join('');
    }
    function displayLatestNews(news){
      const container = document.getElementById('newsList');
      if(!news || news.length===0){
        container.innerHTML = '<div class="empty-state"><i class="fas fa-newspaper"></i><p>目前沒有消息</p></div>';
        return;
      }
      container.innerHTML = news.map(n=>`
        <div class="card" style="margin-bottom:0.6rem;">
          <div class="card-body">
            <h4>${escapeHtml(n.title)}</h4>
            <p>${escapeHtml(n.content)}</p>
            <span class="text-secondary">${formatRelativeTime(n.createdAt)}</span>
          </div>
        </div>
      `).join('');
    }

    // ============ DASHBOARD ============
    function createDashboard(){
      return `
        <div class="container">
          <div class="page-header">
            <h1><i class="fas fa-chart-line"></i> 數據分析儀表板</h1>
            <div class="dashboard-controls" style="display:flex; gap:0.5rem;">
              <select id="dashboardPeriod" onchange="updateDashboard()" class="form-control">
                <option value="week">本週</option>
                <option value="month" selected>本月</option>
                <option value="quarter">本季</option>
                <option value="year">本年</option>
              </select>
              <button class="btn btn-secondary btn-sm" onclick="refreshDashboard()"><i class="fas fa-sync-alt"></i> 重新整理</button>
              <button class="btn btn-primary btn-sm" onclick="exportDashboard()"><i class="fas fa-download"></i> 匯出</button>
            </div>
          </div>
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-users"></i></div>
              <div class="kpi-content">
                <h3 id="kpiTotalMembers">0</h3><p>總會員數</p>
                <div class="kpi-trend positive"><i class="fas fa-arrow-up"></i><span id="kpiMembersTrend">+0%</span></div>
              </div>
            </div>
            <div class="kpi-card">
              <div class="kpi-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><i class="fas fa-calendar-check"></i></div>
              <div class="kpi-content">
                <h3 id="kpiTotalActivities">0</h3><p>舉辦活動</p>
                <div class="kpi-trend positive"><i class="fas fa-arrow-up"></i><span id="kpiActivitiesTrend">+0%</span></div>
              </div>
            </div>
            <div class="kpi-card">
              <div class="kpi-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"><i class="fas fa-user-check"></i></div>
              <div class="kpi-content">
                <h3 id="kpiAttendanceRate">0%</h3><p>平均出席率</p>
                <div class="kpi-trend positive"><i class="fas fa-arrow-up"></i><span id="kpiAttendanceTrend">+0%</span></div>
              </div>
            </div>
            <div class="kpi-card">
              <div class="kpi-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);"><i class="fas fa-smile"></i></div>
              <div class="kpi-content">
                <h3 id="kpiSatisfaction">0</h3><p>滿意度評分</p>
                <div class="kpi-trend positive"><i class="fas fa-arrow-up"></i><span id="kpiSatisfactionTrend">+0</span></div>
              </div>
            </div>
          </div>
          <div class="charts-grid">
            <div class="chart-card">
              <div class="chart-header">
                <h3><i class="fas fa-chart-line"></i> 會員成長趨勢</h3>
                <button class="btn btn-sm" onclick="toggleChartType('memberGrowth')"><i class="fas fa-exchange-alt"></i></button>
              </div>
              <div class="chart-container"><canvas id="memberGrowthChart"></canvas></div>
            </div>
            <div class="chart-card">
              <div class="chart-header">
                <h3><i class="fas fa-chart-bar"></i> 活動參與統計</h3>
                <button class="btn btn-sm" onclick="toggleChartType('activityParticipation')"><i class="fas fa-exchange-alt"></i></button>
              </div>
              <div class="chart-container"><canvas id="activityParticipationChart"></canvas></div>
            </div>
            <div class="chart-card">
              <div class="chart-header"><h3><i class="fas fa-chart-pie"></i> 活動類型分布</h3></div>
              <div class="chart-container"><canvas id="activityTypeChart"></canvas></div>
            </div>
            <div class="chart-card">
              <div class="chart-header"><h3><i class="fas fa-map-marked-alt"></i> 地區分布</h3></div>
              <div class="chart-container"><canvas id="locationDistributionChart"></canvas></div>
            </div>
          </div>
          <div class="grid grid-2">
            <div class="card">
              <div class="card-header"><h3><i class="fas fa-trophy"></i> 熱門活動 Top 10</h3></div>
              <div class="table-container">
                <table id="topActivitiesTable">
                  <thead><tr><th>排名</th><th>活動名稱</th><th>參與人數</th><th>滿意度</th></tr></thead>
                  <tbody><tr><td colspan="4" class="loading">載入中...</td></tr></tbody>
                </table>
              </div>
            </div>
            <div class="card">
              <div class="card-header"><h3><i class="fas fa-star"></i> 活躍會員 Top 10</h3></div>
              <div class="table-container">
                <table id="activeMembersTable">
                  <thead><tr><th>排名</th><th>會員姓名</th><th>參與次數</th><th>最後參與</th></tr></thead>
                  <tbody><tr><td colspan="4" class="loading">載入中...</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    async function loadDashboardData(){
      const period = document.getElementById('dashboardPeriod')?.value || 'month';
      try{
        const result = await callServerFunctionWithCache('getDashboardData', { period }, 5);
        if(result.success){
          updateKPIs(result.kpis);
          updateCharts(result.charts);
          updateTables(result.tables);
        }
      }catch(e){
        console.error(e); showToast('載入資料失敗', 'error');
      }
    }
    function updateKPIs(kpis){
      animateNumber('kpiTotalMembers', kpis.totalMembers);
      updateTrend('kpiMembersTrend', kpis.membersTrend);
      animateNumber('kpiTotalActivities', kpis.totalActivities);
      updateTrend('kpiActivitiesTrend', kpis.activitiesTrend);
      animateNumber('kpiAttendanceRate', kpis.attendanceRate, '%');
      updateTrend('kpiAttendanceTrend', kpis.attendanceTrend, '%');
      animateNumber('kpiSatisfaction', kpis.satisfaction, '', 1);
      updateTrend('kpiSatisfactionTrend', kpis.satisfactionTrend);
    }
    function updateTrend(elementId, value, suffix='%'){
      const el = document.getElementById(elementId); if(!el) return;
      const parent = el.closest('.kpi-trend'); const pos = value>=0;
      parent.className = 'kpi-trend ' + (pos?'positive':'negative');
      parent.querySelector('i').className = 'fas fa-arrow-' + (pos?'up':'down');
      el.textContent = (pos?'+':'') + value + suffix;
    }
    const chartsRegistry = {};
    function destroyChart(id){ if(chartsRegistry[id]){ chartsRegistry[id].destroy(); delete chartsRegistry[id]; } }
    function createLineChart(canvasId, data){
      const c = document.getElementById(canvasId); if(!c) return;
      const ctx = c.getContext('2d'); destroyChart(canvasId);
      chartsRegistry[canvasId] = new Chart(ctx, {
        type:'line',
        data:{ labels:data.labels, datasets:[{ label:data.label, data:data.values, borderColor:'rgb(102,126,234)', backgroundColor:'rgba(102,126,234,0.1)', tension:0.4, fill:true, pointRadius:3, pointHoverRadius:5 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true, grid:{ color:'rgba(0,0,0,0.05)' } }, x:{ grid:{ display:false } } } }
      });
    }
    function createBarChart(canvasId, data){
      const c = document.getElementById(canvasId); if(!c) return;
      const ctx = c.getContext('2d'); destroyChart(canvasId);
      chartsRegistry[canvasId] = new Chart(ctx, {
        type:'bar',
        data:{ labels:data.labels, datasets:[{ label:data.label, data:data.values, backgroundColor:'rgba(240,147,251,0.8)', borderColor:'rgb(240,147,251)', borderWidth:1, borderRadius:8 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true, grid:{ color:'rgba(0,0,0,0.05)' } }, x:{ grid:{ display:false } } } }
      });
    }
    function createDoughnutChart(canvasId, data){
      const c = document.getElementById(canvasId); if(!c) return;
      const ctx = c.getContext('2d'); destroyChart(canvasId);
      chartsRegistry[canvasId] = new Chart(ctx, {
        type:'doughnut',
        data:{ labels:data.labels, datasets:[{ data:data.values, backgroundColor:['rgba(102,126,234,0.8)','rgba(240,147,251,0.8)','rgba(79,172,254,0.8)','rgba(67,233,123,0.8)','rgba(251,188,4,0.8)'], borderWidth:2, borderColor:'#fff' }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'right' } } }
      });
    }
    function createPolarChart(canvasId, data){
      const c = document.getElementById(canvasId); if(!c) return;
      const ctx = c.getContext('2d'); destroyChart(canvasId);
      chartsRegistry[canvasId] = new Chart(ctx, {
        type:'polarArea',
        data:{ labels:data.labels, datasets:[{ data:data.values, backgroundColor:['rgba(102,126,234,0.6)','rgba(240,147,251,0.6)','rgba(79,172,254,0.6)','rgba(67,233,123,0.6)','rgba(251,188,4,0.6)'] }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'right' } } }
      });
    }
    function updateCharts(charts){
      if(charts.memberGrowth) createLineChart('memberGrowthChart', charts.memberGrowth);
      if(charts.activityParticipation) createBarChart('activityParticipationChart', charts.activityParticipation);
      if(charts.activityType) createDoughnutChart('activityTypeChart', charts.activityType);
      if(charts.locationDistribution) createPolarChart('locationDistributionChart', charts.locationDistribution);
    }
    function updateTables(tables){
      if(tables.topActivities){
        const tbody = document.querySelector('#topActivitiesTable tbody');
        tbody.innerHTML = tables.topActivities.map((item,i)=>`
          <tr>
            <td><span class="rank-badge ${i<3?'top-'+(i+1):''}">${i+1}</span></td>
            <td>${escapeHtml(item.name)}</td>
            <td>${item.participants}</td>
            <td><div class="rating">${generateStars(item.satisfaction)} <span>${item.satisfaction.toFixed(1)}</span></div></td>
          </tr>
        `).join('');
      }
      if(tables.activeMembers){
        const tbody = document.querySelector('#activeMembersTable tbody');
        tbody.innerHTML = tables.activeMembers.map((item,i)=>`
          <tr>
            <td><span class="rank-badge ${i<3?'top-'+(i+1):''}">${i+1}</span></td>
            <td>${escapeHtml(item.name)}</td>
            <td>${item.participations}</td>
            <td>${formatRelativeTime(item.lastParticipation)}</td>
          </tr>
        `).join('');
      }
    }
    function toggleChartType(name){
      const id = name+'Chart';
      const chart = chartsRegistry[id];
      if(!chart) return;
      const newType = chart.config.type==='line'?'bar':'line';
      const data = chart.config.data;
      const opts = chart.options;
      chart.destroy();
      chartsRegistry[id] = new Chart(chart.ctx, { type:newType, data, options: opts });
    }
    function refreshDashboard(){ CacheManager.clear('api_getDashboardData'); loadDashboardData(); }
    function updateDashboard(){ loadDashboardData(); }
    async function exportDashboard(){
      const format = prompt('請選擇匯出格式：\n1. PDF\n2. Excel\n3. 圖片', '1');
      if(!format) return; const map={'1':'pdf','2':'xlsx','3':'png'}; const exportFormat = map[format]; if(!exportFormat) return alert('無效的格式');
      document.getElementById('loadingOverlay').classList.add('active');
      try{
        const result = await callServerFunction('exportDashboard', { format: exportFormat, period: document.getElementById('dashboardPeriod').value });
        document.getElementById('loadingOverlay').classList.remove('active');
        if(result.success) window.open(result.downloadUrl, '_blank'); else alert('匯出失敗：'+result.error);
      }catch(e){ document.getElementById('loadingOverlay').classList.remove('active'); alert('系統錯誤：'+e.message); }
    }

    // ============ ACTIVITIES ============
    function createActivitiesPage(){
      return `
        <div class="container">
          <div class="page-header">
            <h1><i class="fas fa-calendar-alt"></i> 活動管理</h1>
            ${PermissionManager.hasPermission('manage_activities')?`<button class="btn btn-primary" onclick="showCreateActivityModal()"><i class="fas fa-plus"></i> 新增活動</button>`:''}
          </div>
          <div class="grid" style="gap:0.6rem;">
            <div class="search-filter-bar" style="display:flex; gap:0.6rem; flex-wrap:wrap;">
              <div class="form-control" style="display:flex; align-items:center; gap:0.5rem; max-width:320px;">
                <i class="fas fa-search"></i>
                <input type="text" id="activitySearch" placeholder="搜尋活動..." onkeyup="filterActivities()" style="flex:1; border:none; outline:none; background:transparent; color:inherit;">
              </div>
              <select id="activityTypeFilter" onchange="filterActivities()" class="form-control" style="max-width:160px;">
                <option value="">所有類型</option>
                <option value="健康講座">健康講座</option>
                <option value="復健課程">復健課程</option>
                <option value="社交活動">社交活動</option>
                <option value="志工服務">志工服務</option>
                <option value="其他">其他</option>
              </select>
              <select id="activityStatusFilter" onchange="filterActivities()" class="form-control" style="max-width:160px;">
                <option value="">所有狀態</option>
                <option value="upcoming">即將舉辦</option>
                <option value="ongoing">進行中</option>
                <option value="completed">已結束</option>
                <option value="cancelled">已取消</option>
              </select>
              <select id="activitySortBy" onchange="filterActivities()" class="form-control" style="max-width:160px;">
                <option value="date">依日期排序</option>
                <option value="popularity">依人氣排序</option>
                <option value="name">依名稱排序</option>
              </select>
            </div>
            <div class="grid grid-3" id="activitiesList"><div class="loading">載入中...</div></div>
          </div>
        </div>
      `;
    }
    async function loadActivities(){
      try{
        const result = await callServerFunctionWithCache('getActivities', {}, 5);
        if(result.success){
          window.allActivities = result.activities;
          displayActivities(result.activities);
        }
      }catch(e){
        console.error('載入活動失敗:', e);
        showToast('載入活動失敗', 'error');
      }
    }
    function displayActivities(activities){
      const container = document.getElementById('activitiesList');
      if(!activities || activities.length===0){
        container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar"></i><p>目前沒有活動</p></div>';
        return;
      }
      container.innerHTML = activities.map(a=>`
        <div class="activity-card" onclick="navigateTo('activity-detail', {id: '${a['活動ID']}'})">
          <div class="activity-image" style="background: linear-gradient(135deg, ${getRandomGradient()});">
            <i class="fas fa-${getActivityIcon(a['活動類型'])}"></i>
          </div>
          <div class="activity-content">
            <span class="activity-category">${escapeHtml(a['活動類型'])}</span>
            <h3 class="activity-title">${escapeHtml(a['活動名稱'])}</h3>
            <div class="activity-meta">
              <span><i class="fas fa-calendar"></i> ${formatDate(a['開始時間'])}</span>
              <span><i class="fas fa-clock"></i> ${formatTime(a['開始時間'])} - ${formatTime(a['結束時間'])}</span>
              <span><i class="fas fa-map-marker-alt"></i> ${escapeHtml(a['活動地點'])}</span>
              <span><i class="fas fa-users"></i> ${a['已報名人數']}/${a['人數上限']}</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" style="width:${(a['已報名人數']/a['人數上限']*100)}%"></div></div>
            <p class="activity-description">${escapeHtml(truncateText(a['活動說明'],100))}</p>
            <div class="activity-footer">
              <span class="status-badge ${getActivityStatus(a)}">${getActivityStatusText(a)}</span>
              <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); registerActivity('${a['活動ID']}')"><i class="fas fa-user-plus"></i> 報名</button>
            </div>
          </div>
        </div>
      `).join('');
    }
    function filterActivities(){
      const searchTerm = (document.getElementById('activitySearch').value||'').toLowerCase();
      const typeFilter = document.getElementById('activityTypeFilter').value;
      const statusFilter = document.getElementById('activityStatusFilter').value;
      const sortBy = document.getElementById('activitySortBy').value;
      let filtered = (window.allActivities||[]).filter(a=>{
        const matchSearch = (a['活動名稱']||'').toLowerCase().includes(searchTerm) || (a['活動說明']||'').toLowerCase().includes(searchTerm);
        const matchType = !typeFilter || a['活動類型']===typeFilter;
        const matchStatus = !statusFilter || getActivityStatus(a)===statusFilter;
        return matchSearch && matchType && matchStatus;
      });
      filtered.sort((a,b)=>{
        switch(sortBy){
          case 'date': return new Date(a['開始時間']) - new Date(b['開始時間']);
          case 'popularity': return b['已報名人數'] - a['已報名人數'];
          case 'name': return (a['活動名稱']||'').localeCompare(b['活動名稱']||'');
          default: return 0;
        }
      });
      displayActivities(filtered);
    }
    function createActivityDetailPage(){ return `<div class="container"><div id="activityDetail"><div class="loading">載入中...</div></div></div>`; }
    async function loadActivityDetail(activityId){
      try{
        const result = await callServerFunction('getActivityDetail', { activityId });
        if(result.success) displayActivityDetail(result.activity);
      }catch(e){ console.error('載入活動詳情失敗:', e); showToast('載入活動詳情失敗', 'error'); }
    }
    function displayActivityDetail(a){
      const container = document.getElementById('activityDetail');
      container.innerHTML = `
        <div class="grid" style="grid-template-columns: 2fr 1fr; gap:1rem;">
          <div class="card">
            <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
              <button class="btn btn-secondary" onclick="history.back()"><i class="fas fa-arrow-left"></i> 返回</button>
              ${PermissionManager.hasPermission('manage_activities')?`
              <div>
                <button class="btn btn-secondary" onclick="editActivity('${a['活動ID']}')"><i class="fas fa-edit"></i> 編輯</button>
                <button class="btn btn-danger" onclick="deleteActivity('${a['活動ID']}')"><i class="fas fa-trash"></i> 刪除</button>
              </div>`:''}
            </div>
            <div class="card-body">
              <div class="activity-detail-image" style="height:220px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:64px; border-radius:12px; background: linear-gradient(135deg, ${getRandomGradient()});">
                <i class="fas fa-${getActivityIcon(a['活動類型'])}"></i>
              </div>
              <div class="mt-2">
                <span class="activity-category">${escapeHtml(a['活動類型'])}</span>
                <h1 class="mt-1">${escapeHtml(a['活動名稱'])}</h1>
                <div class="grid grid-2 mt-2">
                  <div><i class="fas fa-calendar"></i> <strong>日期</strong><p>${formatDate(a['開始時間'],true)}</p></div>
                  <div><i class="fas fa-clock"></i> <strong>時間</strong><p>${formatTime(a['開始時間'])} - ${formatTime(a['結束時間'])}</p></div>
                  <div><i class="fas fa-map-marker-alt"></i> <strong>地點</strong><p>${escapeHtml(a['活動地點'])}</p></div>
                  <div><i class="fas fa-users"></i> <strong>人數</strong><p>${a['已報名人數']} / ${a['人數上限']}</p></div>
                  <div><i class="fas fa-user-tie"></i> <strong>負責人</strong><p>${escapeHtml(a['負責人']||'未指定')}</p></div>
                  <div><i class="fas fa-phone"></i> <strong>聯絡電話</strong><p>${escapeHtml(a['聯絡電話']||'未提供')}</p></div>
                </div>
                <div class="mt-2">
                  <h3>活動說明</h3>
                  <p>${escapeHtml(a['活動說明'])}</p>
                </div>
                <div class="activity-progress mt-2">
                  <div style="display:flex; justify-content:space-between;"><span>報名進度</span><span>${Math.round(a['已報名人數']/a['人數上限']*100)}%</span></div>
                  <div class="progress-bar"><div class="progress-fill" style="width:${(a['已報名人數']/a['人數上限']*100)}%"></div></div>
                </div>
                <div class="mt-2" style="display:flex; gap:0.6rem;">
                  <button class="btn btn-primary btn-lg" onclick="registerActivity('${a['活動ID']}')"><i class="fas fa-user-plus"></i> 立即報名</button>
                  <button class="btn btn-secondary btn-lg" onclick="shareActivity('${a['活動ID']}')"><i class="fas fa-share-alt"></i> 分享</button>
                </div>
              </div>
            </div>
          </div>
          <div class="grid" style="gap:1rem;">
            <div class="card">
              <h3><i class="fas fa-users"></i> 已報名名單</h3>
              <div id="registeredMembersList" class="mt-1"><div class="loading">載入中...</div></div>
            </div>
            <div class="card">
              <h3><i class="fas fa-comments"></i> 活動討論</h3>
              <div id="activityComments" class="mt-1"><div class="loading">載入中...</div></div>
              <div class="mt-1">
                <textarea id="commentText" class="form-control" placeholder="發表您的看法..." rows="3"></textarea>
                <button class="btn btn-primary btn-sm mt-1" onclick="postComment('${a['活動ID']}')"><i class="fas fa-paper-plane"></i> 發送</button>
              </div>
            </div>
          </div>
        </div>
      `;
      // 模擬資料
      setTimeout(()=>{
        document.getElementById('registeredMembersList').innerHTML = `
          <ul>
            <li>王小明</li><li>李小美</li><li>陳大文</li>
          </ul>
        `;
        document.getElementById('activityComments').innerHTML = `
          <div class="card"><div class="card-body"><strong>王小明</strong><p>期待活動！</p><small>${formatRelativeTime(new Date())}</small></div></div>
        `;
      }, 200);
    }
    async function registerActivity(activityId){
      if(!currentUser){ showToast('請先登入', 'warning'); navigateTo('login'); return; }
      if(!confirm('確定要報名此活動嗎？')) return;
      document.getElementById('loadingOverlay').classList.add('active');
      try{
        const result = await callServerFunction('registerActivity', { activityId, memberId: currentUser.id, memberName: currentUser.name });
        document.getElementById('loadingOverlay').classList.remove('active');
        if(result.success){
          showToast('報名成功！', 'success');
          if(currentPage==='activity-detail') loadActivityDetail(activityId); else loadActivities();
        }else showToast('報名失敗：'+result.error, 'error');
      }catch(e){ document.getElementById('loadingOverlay').classList.remove('active'); showToast('系統錯誤：'+e.message, 'error'); }
    }
    function showCreateActivityModal(){
      const modal = document.createElement('div');
      modal.className = 'modal active'; modal.id = 'createActivityModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <button class="close-modal" onclick="closeModal('createActivityModal')"><i class="fas fa-times"></i></button>
          <div class="modal-header"><h2><i class="fas fa-plus"></i> 新增活動</h2></div>
          <div class="modal-body">
            <form id="createActivityForm" onsubmit="handleCreateActivity(event)">
              <div class="form-row">
                <div class="form-group"><label>活動名稱 *</label><input type="text" name="activityName" class="form-control" required></div>
                <div class="form-group"><label>活動類型 *</label>
                  <select name="activityType" class="form-control" required>
                    <option value="">請選擇</option>
                    <option value="健康講座">健康講座</option>
                    <option value="復健課程">復健課程</option>
                    <option value="社交活動">社交活動</option>
                    <option value="志工服務">志工服務</option>
                    <option value="其他">其他</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>開始時間 *</label><input type="datetime-local" name="startTime" class="form-control" required></div>
                <div class="form-group"><label>結束時間 *</label><input type="datetime-local" name="endTime" class="form-control" required></div>
              </div>
              <div class="form-group"><label>活動地點 *</label><input type="text" name="location" class="form-control" required></div>
              <div class="form-row">
                <div class="form-group"><label>人數上限 *</label><input type="number" name="maxParticipants" class="form-control" min="1" required></div>
                <div class="form-group"><label>負責人</label><input type="text" name="organizer" class="form-control"></div>
              </div>
              <div class="form-group"><label>聯絡電話</label><input type="tel" name="contactPhone" class="form-control"></div>
              <div class="form-group"><label>活動說明 *</label><textarea name="description" class="form-control" rows="5" required></textarea></div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createActivityModal')">取消</button>
                <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> 建立活動</button>
              </div>
            </form>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    async function handleCreateActivity(event){
      event.preventDefault();
      const fd = new FormData(event.target);
      const data = {
        name: fd.get('activityName'), type: fd.get('activityType'),
        startTime: fd.get('startTime'), endTime: fd.get('endTime'),
        location: fd.get('location'), maxParticipants: fd.get('maxParticipants'),
        organizer: fd.get('organizer'), contactPhone: fd.get('contactPhone'),
        description: fd.get('description')
      };
      document.getElementById('loadingOverlay').classList.add('active');
      try{
        const result = await callServerFunction('createActivity', data);
        document.getElementById('loadingOverlay').classList.remove('active');
        if(result.success){ showToast('活動建立成功！', 'success'); closeModal('createActivityModal'); loadActivities(); }
        else showToast('建立失敗：'+result.error, 'error');
      }catch(e){ document.getElementById('loadingOverlay').classList.remove('active'); showToast('系統錯誤：'+e.message, 'error'); }
    }

    function closeModal(id){
      const el = document.getElementById(id);
      if(el) el.remove();
    }

    function editActivity(activityId){
      showToast('編輯功能為示範，尚未實作', 'info');
    }
    function deleteActivity(activityId){
      if(!confirm('確定要刪除此活動嗎？')) return;
      showToast('刪除成功（示範）', 'success');
      // 模擬重新整理
      loadActivities();
    }
    function shareActivity(activityId){
      const url = location.origin + '/#activity-detail?id=' + encodeURIComponent(activityId);
      if(navigator.share){
        navigator.share({ title:'活動分享', text:'邀請您參加活動', url });
      }else{
        navigator.clipboard.writeText(url).then(()=> showToast('連結已複製', 'success'));
      }
    }
    function postComment(activityId){
      const txt = document.getElementById('commentText').value.trim();
      if(!txt) return;
      showToast('已發表留言（示範）', 'success');
      document.getElementById('commentText').value = '';
      const box = document.getElementById('activityComments');
      const html = `<div class="card"><div class="card-body"><strong>${escapeHtml(currentUser.name)}</strong><p>${escapeHtml(txt)}</p><small>${formatRelativeTime(new Date())}</small></div></div>`;
      box.insertAdjacentHTML('afterbegin', html);
    }

    // ============ MEMBERS ============
    function createMembersPage(){
      return `
        <div class="container">
          <div class="page-header">
            <h1><i class="fas fa-users"></i> 會員管理</h1>
            <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
              ${PermissionManager.hasPermission('manage_members')?`<button class="btn btn-primary" onclick="showAddMemberModal()"><i class="fas fa-user-plus"></i> 新增會員</button>`:''}
              <button class="btn btn-secondary" onclick="exportMembers()"><i class="fas fa-download"></i> 匯出</button>
            </div>
          </div>
          <div class="grid" style="gap:0.6rem;">
            <div class="search-filter-bar" style="display:flex; gap:0.6rem; flex-wrap:wrap;">
              <div class="form-control" style="display:flex; align-items:center; gap:0.5rem; max-width:320px;">
                <i class="fas fa-search"></i>
                <input type="text" id="memberSearch" placeholder="搜尋姓名/電話/Email..." onkeyup="filterMembers()" style="flex:1; border:none; outline:none; background:transparent;">
              </div>
              <select id="memberStatus" class="form-control" onchange="filterMembers()" style="max-width:160px;">
                <option value="">所有狀態</option>
                <option value="啟用">啟用</option>
                <option value="停用">停用</option>
              </select>
              <select id="memberSort" class="form-control" onchange="filterMembers()" style="max-width:160px;">
                <option value="join">加入日期新到舊</option>
                <option value="name">姓名</option>
                <option value="points">積分高到低</option>
                <option value="activities">參與活動多到少</option>
              </select>
            </div>
            <div class="card">
              <div class="table-container">
                <table id="membersTable">
                  <thead>
                    <tr>
                      <th><input type="checkbox" onclick="toggleAllMembersSelection(this)"></th>
                      <th>會員ID</th><th>姓名</th><th>性別</th><th>電話</th><th>Email</th><th>加入日期</th><th>狀態</th><th>積分</th><th>操作</th>
                    </tr>
                  </thead>
                  <tbody><tr><td colspan="10" class="loading">載入中...</td></tr></tbody>
                </table>
              </div>
            </div>
            <div id="membersPagination" class="text-right"></div>
          </div>

          <div id="batchToolbar" class="batch-toolbar">
            <div class="batch-toolbar-content">
              <div>已選取 <span id="selectedCount">0</span> 位會員</div>
              <div class="batch-actions">
                <button class="btn btn-secondary btn-sm" onclick="batchSendMessage()"><i class="fas fa-paper-plane"></i> 發送訊息</button>
                ${PermissionManager.hasPermission('manage_members')?`
                <button class="btn btn-danger btn-sm" onclick="batchDisableMembers()"><i class="fas fa-user-slash"></i> 停用</button>`:''}
                <button class="btn btn-secondary btn-sm" onclick="BatchOperations.clear()"><i class="fas fa-times"></i> 關閉</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    async function loadMembers(page=1){
      try{
        const result = await callServerFunction('getMembers', { page });
        if(result.success){
          window.__membersPageData = result.members || [];
          window.__membersPagination = result.pagination || { page, totalPages: 1 };
          window.__membersStats = result.stats || {};
          renderMembersTable(window.__membersPageData);
          updatePagination(window.__membersPagination, 'membersPagination', loadMembers);
        }
      }catch(e){
        console.error(e); showToast('載入會員失敗', 'error');
      }
    }
    function renderMembersTable(list){
      const tbody = document.querySelector('#membersTable tbody');
      if(!list || list.length===0){
        tbody.innerHTML = `<tr><td colspan="10" class="empty-state"><i class="fas fa-inbox"></i><p>沒有資料</p></td></tr>`;
        return;
      }
      tbody.innerHTML = list.map(m=>`
        <tr>
          <td><input type="checkbox" class="member-select" value="${escapeHtml(m['會員ID'])}" onchange="onMemberSelectChange()"></td>
          <td>${escapeHtml(m['會員ID'])}</td>
          <td><a href="#" onclick="openMemberDetail('${m['會員ID']}'); return false;">${escapeHtml(m['姓名'])}</a></td>
          <td>${escapeHtml(m['性別'])}</td>
          <td>${escapeHtml(m['電話'])}</td>
          <td>${escapeHtml(m['電子郵件'])}</td>
          <td>${formatDate(m['加入日期'])}</td>
          <td>${escapeHtml(m['狀態'])}</td>
          <td>${m['積分']||0}</td>
          <td>
            <button class="btn btn-secondary btn-sm" onclick="openMemberDetail('${m['會員ID']}')"><i class="fas fa-eye"></i></button>
            ${PermissionManager.hasPermission('manage_members')?`
              <button class="btn btn-secondary btn-sm" onclick="showEditMemberModal('${m['會員ID']}')"><i class="fas fa-edit"></i></button>
              <button class="btn btn-danger btn-sm" onclick="deleteMember('${m['會員ID']}')"><i class="fas fa-trash"></i></button>
            `:''}
          </td>
        </tr>
      `).join('');
    }
    function toggleAllMembersSelection(checkbox){
      document.querySelectorAll('.member-select').forEach(cb=> cb.checked = checkbox.checked);
      onMemberSelectChange();
      if(checkbox.checked) BatchOperations.init('membersTable'); else BatchOperations.clear();
    }
    function onMemberSelectChange(){
      const selected = Array.from(document.querySelectorAll('.member-select:checked'));
      document.getElementById('selectedCount').textContent = selected.length;
      if(selected.length>0) BatchOperations.init('membersTable'); else BatchOperations.clear();
    }
    function getSelectedMemberIds(){
      return Array.from(document.querySelectorAll('.member-select:checked')).map(cb=>cb.value);
    }
    function filterMembers(){
      const q = (document.getElementById('memberSearch').value||'').toLowerCase();
      const status = document.getElementById('memberStatus').value;
      const sort = document.getElementById('memberSort').value;
      let list = (window.__membersPageData||[]).filter(m=>{
        const matchQ = [m['姓名'], m['電話'], m['電子郵件']].some(v=> (v||'').toLowerCase().includes(q));
        const matchS = !status || m['狀態']===status;
        return matchQ && matchS;
      });
      list.sort((a,b)=>{
        switch(sort){
          case 'join': return new Date(b['加入日期']) - new Date(a['加入日期']);
          case 'name': return (a['姓名']||'').localeCompare(b['姓名']||'');
          case 'points': return (b['積分']||0) - (a['積分']||0);
          case 'activities': return (b['參與活動數']||0) - (a['參與活動數']||0);
          default: return 0;
        }
      });
      renderMembersTable(list);
    }
    function openMemberDetail(memberId){
      showMemberDetailModal(memberId);
    }
    function showAddMemberModal(){
      const modal = document.createElement('div');
      modal.className='modal active'; modal.id='addMemberModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width:720px;">
          <button class="close-modal" onclick="closeModal('addMemberModal')"><i class="fas fa-times"></i></button>
          <div class="modal-header"><h2><i class="fas fa-user-plus"></i> 新增會員</h2></div>
          <div class="modal-body">
            <form id="addMemberForm" onsubmit="handleAddMember(event)">
              <div class="form-row">
                <div class="form-group"><label>姓名 *</label><input name="name" class="form-control" required></div>
                <div class="form-group"><label>性別 *</label>
                  <select name="gender" class="form-control" required>
                    <option value="">請選擇</option>
                    <option value="男">男</option>
                    <option value="女">女</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>電話 *</label><input name="phone" class="form-control" required></div>
                <div class="form-group"><label>Email *</label><input type="email" name="email" class="form-control" required></div>
              </div>
              <div class="form-group"><label>地址</label><input name="address" class="form-control"></div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addMemberModal')">取消</button>
                <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> 新增</button>
              </div>
            </form>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    async function handleAddMember(e){
      e.preventDefault();
      const fd = new FormData(e.target);
      const data = Object.fromEntries(fd.entries());
      document.getElementById('loadingOverlay').classList.add('active');
      try{
        const result = await callServerFunction('addMember', data);
        document.getElementById('loadingOverlay').classList.remove('active');
        if(result.success){ showToast('已新增會員', 'success'); closeModal('addMemberModal'); loadMembers(window.__membersPagination?.page||1); }
        else showToast('新增失敗：'+result.error, 'error');
      }catch(err){
        document.getElementById('loadingOverlay').classList.remove('active');
        showToast('系統錯誤：'+err.message, 'error');
      }
    }
    function showEditMemberModal(memberId){
      const m = (window.__membersPageData||[]).find(x=>x['會員ID']===memberId);
      if(!m){ showToast('找不到會員', 'error'); return; }
      const modal = document.createElement('div');
      modal.className='modal active'; modal.id='editMemberModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width:720px;">
          <button class="close-modal" onclick="closeModal('editMemberModal')"><i class="fas fa-times"></i></button>
          <div class="modal-header"><h2><i class="fas fa-user-edit"></i> 編輯會員</h2></div>
          <div class="modal-body">
            <form id="editMemberForm" onsubmit="handleUpdateMember(event, '${m['會員ID']}')">
              <div class="form-row">
                <div class="form-group"><label>姓名 *</label><input name="姓名" class="form-control" value="${escapeHtml(m['姓名'])}" required></div>
                <div class="form-group"><label>性別 *</label>
                  <select name="性別" class="form-control" required>
                    <option value="男" ${m['性別']==='男'?'selected':''}>男</option>
                    <option value="女" ${m['性別']==='女'?'selected':''}>女</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>電話 *</label><input name="電話" class="form-control" value="${escapeHtml(m['電話'])}" required></div>
                <div class="form-group"><label>Email *</label><input type="email" name="電子郵件" class="form-control" value="${escapeHtml(m['電子郵件'])}" required></div>
              </div>
              <div class="form-group"><label>地址</label><input name="地址" class="form-control" value="${escapeHtml(m['地址']||'')}"></div>
              <div class="form-row">
                <div class="form-group"><label>狀態</label>
                  <select name="狀態" class="form-control">
                    <option value="啟用" ${m['狀態']==='啟用'?'selected':''}>啟用</option>
                    <option value="停用" ${m['狀態']==='停用'?'selected':''}>停用</option>
                  </select>
                </div>
                <div class="form-group"><label>積分</label><input type="number" name="積分" class="form-control" value="${m['積分']||0}"></div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editMemberModal')">取消</button>
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 儲存</button>
              </div>
            </form>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    async function handleUpdateMember(e, memberId){
      e.preventDefault();
      const fd = new FormData(e.target);
      const data = Object.fromEntries(fd.entries());
      data['會員ID'] = memberId;
      document.getElementById('loadingOverlay').classList.add('active');
      try{
        const result = await callServerFunction('updateMember', data);
        document.getElementById('loadingOverlay').classList.remove('active');
        if(result.success){ showToast('已更新', 'success'); closeModal('editMemberModal'); loadMembers(window.__membersPagination?.page||1); }
        else showToast('更新失敗：'+result.error, 'error');
      }catch(err){
        document.getElementById('loadingOverlay').classList.remove('active');
        showToast('系統錯誤：'+err.message, 'error');
      }
    }
    async function deleteMember(memberId){
      if(!confirm('確定要刪除此會員嗎？')) return;
      document.getElementById('loadingOverlay').classList.add('active');
      try{
        const result = await callServerFunction('deleteMember', { memberId });
        document.getElementById('loadingOverlay').classList.remove('active');
        if(result.success){ showToast('已刪除', 'success'); loadMembers(window.__membersPagination?.page||1); }
        else showToast('刪除失敗：'+result.error, 'error');
      }catch(err){
        document.getElementById('loadingOverlay').classList.remove('active');
        showToast('系統錯誤：'+err.message, 'error');
      }
    }
    async function exportMembers(){
      document.getElementById('loadingOverlay').classList.add('active');
      try{
        const result = await callServerFunction('exportMembers', {});
        document.getElementById('loadingOverlay').classList.remove('active');
        if(result.success && result.downloadUrl) window.open(result.downloadUrl, '_blank');
        else showToast('匯出失敗', 'error');
      }catch(err){
        document.getElementById('loadingOverlay').classList.remove('active');
        showToast('系統錯誤：'+err.message, 'error');
      }
    }
    function showMemberDetailModal(memberId){
      const modal = document.createElement('div');
      modal.className='modal active'; modal.id='memberDetailModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width:900px;">
          <button class="close-modal" onclick="closeModal('memberDetailModal')"><i class="fas fa-times"></i></button>
          <div class="modal-header"><h2><i class="fas fa-id-card"></i> 會員資訊</h2></div>
          <div class="modal-body" id="memberDetailBody">
            <div class="loading">載入中...</div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      loadMemberDetail(memberId);
    }
    async function loadMemberDetail(memberId){
      try{
        const [detailRes, historyRes] = await Promise.all([
          callServerFunction('getMemberDetail', { memberId }),
          callServerFunction('getMemberActivityHistory', { memberId })
        ]);
        if(detailRes.success){
          const m = detailRes.member;
          const activities = (historyRes.success? historyRes.activities: []) || [];
          document.getElementById('memberDetailBody').innerHTML = `
            <div class="profile-cover" style="background:linear-gradient(135deg, ${getRandomGradient()});"></div>
            <div class="profile-info-header">
              <div class="profile-avatar-large">${escapeHtml(m['姓名'].charAt(0))}<button class="avatar-edit-btn"><i class="fas fa-camera"></i></button></div>
              <div>
                <h2>${escapeHtml(m['姓名'])}</h2>
                <div class="profile-badges">
                  <span class="badge"><i class="fas fa-user"></i> ${escapeHtml(m['性別'])}</span>
                  <span class="badge badge-success"><i class="fas fa-check"></i> ${escapeHtml(m['狀態'])}</span>
                </div>
              </div>
            </div>
            <div class="profile-stats">
              <div class="stat-card"><div class="stat-icon" style="background:#667eea;"><i class="fas fa-calendar-check"></i></div><div><div>參與活動</div><h3>${m['參與活動數']||0}</h3></div></div>
              <div class="stat-card"><div class="stat-icon" style="background:#43e97b;"><i class="fas fa-trophy"></i></div><div><div>積分</div><h3>${m['積分']||0}</h3></div></div>
              <div class="stat-card"><div class="stat-icon" style="background:#f093fb;"><i class="fas fa-clock"></i></div><div><div>最後活動</div><h3>${formatRelativeTime(m['最後活動日期'])}</h3></div></div>
            </div>
            <div class="grid grid-2 profile-tabs">
              <div class="info-section">
                <h3><i class="fas fa-info-circle"></i> 基本資料</h3>
                <div class="info-items">
                  <div class="info-item"><label>電話</label><p>${escapeHtml(m['電話'])}</p></div>
                  <div class="info-item"><label>Email</label><p>${escapeHtml(m['電子郵件'])}</p></div>
                  <div class="info-item full-width"><label>地址</label><p>${escapeHtml(m['地址']||'')}</p></div>
                  <div class="info-item"><label>加入日期</label><p>${formatDate(m['加入日期'])}</p></div>
                </div>
              </div>
              <div class="info-section">
                <h3><i class="fas fa-stream"></i> 活動紀錄</h3>
                <div class="timeline">
                  ${activities.map(a=>`
                    <div class="timeline-item">
                      <div class="timeline-marker" style="background:${getTimelineColor('activity')}"><i class="fas fa-${getTimelineIcon('activity')}"></i></div>
                      <div class="timeline-content">
                        <div class="timeline-header">
                          <strong>${escapeHtml(a['活動名稱'])}</strong>
                          <small>${formatDate(a['活動日期'])} · ${escapeHtml(a['出席狀態'])}</small>
                        </div>
                        <div>${escapeHtml(a['活動說明']||'')}</div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          `;
        }else{
          document.getElementById('memberDetailBody').innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>無法載入會員資料</p></div>`;
        }
      }catch(err){
        document.getElementById('memberDetailBody').innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>系統錯誤：${escapeHtml(err.message)}</p></div>`;
      }
    }
    function batchSendMessage(){
      const ids = getSelectedMemberIds();
      if(ids.length===0) return showToast('請先選擇會員', 'warning');
      alert('將發送訊息給：\n' + ids.join(', '));
    }
    function batchDisableMembers(){
      const ids = getSelectedMemberIds();
      if(ids.length===0) return showToast('請先選擇會員', 'warning');
      if(!confirm('確定停用選取會員？')) return;
      showToast('已停用（示範）', 'success');
      BatchOperations.clear();
      loadMembers(window.__membersPagination?.page||1);
    }

    // ============ REPORTS ============
    function createReportsPage(){
      return `
        <div class="container">
          <div class="page-header">
            <h1><i class="fas fa-file-alt"></i> 報表中心</h1>
            <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
              <button class="btn btn-primary" onclick="showGenerateReportModal()"><i class="fas fa-magic"></i> 產生報表</button>
              <button class="btn btn-secondary" onclick="generateQuickReport()"><i class="fas fa-bolt"></i> 快速報表</button>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><h3><i class="fas fa-history"></i> 產生紀錄</h3></div>
            <div class="table-container">
              <table id="reportsTable">
                <thead><tr><th>時間</th><th>名稱</th><th>類型</th><th>建立人</th><th>動作</th></tr></thead>
                <tbody><tr><td colspan="5" class="loading">載入中...</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }
    async function loadReportHistory(){
      try{
        const res = await callServerFunction('getReportHistory', {});
        if(res.success){
          const tbody = document.querySelector('#reportsTable tbody');
          const list = res.reports || [];
          if(list.length===0){
            tbody.innerHTML = `<tr><td colspan="5" class="empty-state"><i class="fas fa-inbox"></i><p>尚無報表</p></td></tr>`;
            return;
          }
          tbody.innerHTML = list.map(r=>`
            <tr>
              <td>${formatDateTime(r.generatedAt)}</td>
              <td>${escapeHtml(r.name)}</td>
              <td>${escapeHtml(r.type)}</td>
              <td>${escapeHtml(r.generatedBy||'-')}</td>
              <td>
                <button class="btn btn-secondary btn-sm" onclick="downloadReport('${r.id}')"><i class="fas fa-download"></i></button>
                <button class="btn btn-danger btn-sm" onclick="deleteReport('${r.id}')"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
          `).join('');
        }
      }catch(e){
        showToast('載入報表失敗', 'error');
      }
    }
    function showGenerateReportModal(){
      const modal = document.createElement('div');
      modal.className='modal active'; modal.id='genReportModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width:720px;">
          <button class="close-modal" onclick="closeModal('genReportModal')"><i class="fas fa-times"></i></button>
          <div class="modal-header"><h2><i class="fas fa-magic"></i> 產生報表</h2></div>
          <div class="modal-body">
            <form id="genReportForm" onsubmit="handleGenerateReport(event)">
              <div class="form-group"><label>報表名稱 *</label><input name="reportName" class="form-control" required></div>
              <div class="form-row">
                <div class="form-group">
                  <label>報表類型 *</label>
                  <select name="type" class="form-control" required>
                    <option value="">請選擇</option>
                    <option value="members">會員報表</option>
                    <option value="activities">活動報表</option>
                    <option value="attendance">出席報表</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>期間</label>
                  <select name="period" class="form-control">
                    <option value="month">本月</option>
                    <option value="quarter">本季</option>
                    <option value="year">本年</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('genReportModal')">取消</button>
                <button type="submit" class="btn btn-primary"><i class="fas fa-cog"></i> 產生</button>
              </div>
            </form>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    async function handleGenerateReport(e){
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      payload.generatedBy = currentUser?.name || '系統';
      document.getElementById('loadingOverlay').classList.add('active');
      try{
        const res = await callServerFunction('generateReport', payload);
        document.getElementById('loadingOverlay').classList.remove('active');
        if(res.success){
          showToast('報表已產生', 'success');
          closeModal('genReportModal');
          loadReportHistory();
          if(res.downloadUrl) window.open(res.downloadUrl, '_blank');
        }else showToast('產生失敗：'+res.error, 'error');
      }catch(e){
        document.getElementById('loadingOverlay').classList.remove('active');
        showToast('系統錯誤：'+e.message, 'error');
      }
    }
    async function generateQuickReport(){
      document.getElementById('loadingOverlay').classList.add('active');
      try{
        const res = await callServerFunction('generateQuickReport', {});
        document.getElementById('loadingOverlay').classList.remove('active');
        if(res.success && res.downloadUrl) window.open(res.downloadUrl, '_blank');
        loadReportHistory();
      }catch(e){
        document.getElementById('loadingOverlay').classList.remove('active');
        showToast('系統錯誤：'+e.message, 'error');
      }
    }
    async function downloadReport(reportId){
      try{
        const res = await callServerFunction('getReportDownloadUrl', { reportId });
        if(res.success && res.downloadUrl) window.open(res.downloadUrl, '_blank');
      }catch(e){ showToast('下載失敗', 'error'); }
    }
    async function deleteReport(reportId){
      if(!confirm('確定要刪除此報表記錄？')) return;
      try{
        const res = await callServerFunction('deleteReport', { reportId });
        if(res.success){ showToast('已刪除', 'success'); loadReportHistory(); }
      }catch(e){ showToast('刪除失敗', 'error'); }
    }

    // ============ PROFILE ============
    function createProfilePage(){
      const u = currentUser || { name:'', email:'' };
      return `
        <div class="container">
          <div class="page-header">
            <h1><i class="fas fa-user"></i> 個人資料</h1>
          </div>
          <div class="card">
            <div class="card-body">
              <div class="profile-cover" style="background:linear-gradient(135deg, ${getRandomGradient()});"></div>
              <div class="profile-info-header">
                <div class="profile-avatar-large">${escapeHtml(u.name?.charAt(0)||'U')}<button class="avatar-edit-btn" onclick="changeAvatar()"><i class="fas fa-camera"></i></button></div>
                <div>
                  <h2>${escapeHtml(u.name||'使用者')}</h2>
                  <div class="profile-badges">
                    <span class="badge"><i class="fas fa-envelope"></i> ${escapeHtml(u.email||'-')}</span>
                    <span class="badge"><i class="fas fa-id-badge"></i> 角色：${escapeHtml(u.role||'-')}</span>
                  </div>
                </div>
              </div>

              <div class="profile-stats" id="profileStats">
                <div class="stat-card"><div class="stat-icon" style="background:#667eea;"><i class="fas fa-calendar-check"></i></div><div><div>活動數</div><h3 id="psActivities">-</h3></div></div>
                <div class="stat-card"><div class="stat-icon" style="background:#43e97b;"><i class="fas fa-percentage"></i></div><div><div>出席率</div><h3 id="psAttendance">-</h3></div></div>
                <div class="stat-card"><div class="stat-icon" style="background:#f093fb;"><i class="fas fa-trophy"></i></div><div><div>積分</div><h3 id="psPoints">-</h3></div></div>
                <div class="stat-card"><div class="stat-icon" style="background:#fa709a;"><i class="fas fa-calendar"></i></div><div><div>會員天數</div><h3 id="psDays">-</h3></div></div>
              </div>

              <div class="grid grid-2">
                <div class="info-section">
                  <h3><i class="fas fa-info-circle"></i> 我的活動</h3>
                  <div id="myActivities" class="mt-1"><div class="loading">載入中...</div></div>
                </div>
                <div class="info-section">
                  <h3><i class="fas fa-medal"></i> 成就</h3>
                  <div id="myAchievements" class="mt-1"><div class="loading">載入中...</div></div>
                </div>
              </div>

              <div class="info-section mt-2">
                <h3><i class="fas fa-stream"></i> 近期動態</h3>
                <div id="myTimeline" class="mt-1"><div class="loading">載入中...</div></div>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    async function loadProfileStats(){
      try{
        const [statsRes, actRes, achRes, tlRes] = await Promise.all([
          callServerFunction('getProfileStats', { userId: currentUser.id }),
          callServerFunction('getUserActivities', { userId: currentUser.id }),
          callServerFunction('getUserAchievements', { userId: currentUser.id }),
          callServerFunction('getUserTimeline', { userId: currentUser.id })
        ]);
        if(statsRes.success){
          const s = statsRes.stats;
          animateNumber('psActivities', s.activitiesCount);
          animateNumber('psAttendance', s.attendanceRate, '%');
          animateNumber('psPoints', s.points);
          animateNumber('psDays', s.memberDays);
        }
        if(actRes.success){
          const list = actRes.activities || [];
          const el = document.getElementById('myActivities');
          el.innerHTML = list.map(a=>`
            <div class="activity-record-item">
              <div class="activity-record-icon" style="background:${getActivityTypeColor(a['活動類型'])}"><i class="fas fa-${getActivityIcon(a['活動類型'])}"></i></div>
              <div style="flex:1;">
                <div><strong>${escapeHtml(a['活動名稱'])}</strong></div>
                <small>${formatDate(a['活動日期'])} · ${escapeHtml(a['活動地點']||'')}</small>
              </div>
              <div><span class="status-badge ${a['出席狀態']==='已出席'?'active':'inactive'}">${escapeHtml(a['出席狀態'])}</span></div>
            </div>
          `).join('');
        }
        if(achRes.success){
          const list = achRes.achievements || [];
          const el = document.getElementById('myAchievements');
          el.innerHTML = list.map(x=>`
            <div class="activity-record-item">
              <div class="activity-record-icon" style="background:#f093fb;"><i class="fas fa-${escapeHtml(x.icon||'trophy')}"></i></div>
              <div style="flex:1;">
                <div><strong>${escapeHtml(x.name)}</strong></div>
                <small>${escapeHtml(x.description||'')}</small>
              </div>
              <div>${x.unlocked?'<span class="status-badge active">已解鎖</span>':'<span class="status-badge inactive">未解鎖</span>'}</div>
            </div>
          `).join('');
        }
        if(tlRes.success){
          const list = tlRes.timeline || [];
          const el = document.getElementById('myTimeline');
          el.innerHTML = list.map(t=>`
            <div class="timeline-item">
              <div class="timeline-marker" style="background:${getTimelineColor(t.type)}"><i class="fas fa-${getTimelineIcon(t.type)}"></i></div>
              <div class="timeline-content">
                <div class="timeline-header">
                  <strong>${escapeHtml(t.title)}</strong>
                  <small>${formatRelativeTime(t.timestamp)}</small>
                </div>
                <div>${escapeHtml(t.description||'')}</div>
              </div>
            </div>
          `).join('');
        }
      }catch(e){
        console.error(e);
      }
    }
    async function changeAvatar(){
      try{
        const ok = confirm('上傳頭像功能為示範，是否模擬更新？');
        if(!ok) return;
        const res = await callServerFunction('updateAvatar', {});
        if(res.success){
          showToast('頭像已更新（示範）', 'success');
        }
      }catch(e){ showToast('更新失敗', 'error'); }
    }

    // ============ SETTINGS ============
    function createSettingsPage(){
      const pushOn = localStorage.getItem('pushSubscribed')==='true';
      const isDark = document.documentElement.classList.contains('dark-theme');
      return `
        <div class="container">
          <div class="page-header"><h1><i class="fas fa-cog"></i> 設定</h1></div>
          <div class="grid grid-2">
            <div class="card">
              <div class="card-header"><div class="card-title"><i class="fas fa-bell"></i> 通知</div></div>
              <div class="card-body">
                <label><input type="checkbox" id="pushNotificationSetting" ${pushOn?'checked':''} onchange="togglePushNotifications(this)"> 推播通知</label>
                <div class="mt-1">
                  <button class="btn btn-secondary btn-sm" onclick="testNotification()"><i class="fas fa-paper-plane"></i> 測試通知</button>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header"><div class="card-title"><i class="fas fa-moon"></i> 外觀</div></div>
              <div class="card-body">
                <label><input type="checkbox" id="darkModeSetting" ${isDark?'checked':''} onchange="toggleDarkMode(this.checked)"> 深色模式</label>
              </div>
            </div>
            <div class="card">
              <div class="card-header"><div class="card-title"><i class="fas fa-envelope"></i> 聯絡信箱</div></div>
              <div class="card-body">
                <div class="form-group">
                  <label>信箱</label>
                  <input id="settingEmail" class="form-control" value="${escapeHtml(currentUser?.email||'')}">
                </div>
                <button class="btn btn-primary btn-sm" onclick="updateEmailSetting()"><i class="fas fa-save"></i> 儲存</button>
              </div>
            </div>
            <div class="card">
              <div class="card-header"><div class="card-title"><i class="fas fa-key"></i> 變更密碼</div></div>
              <div class="card-body">
                <div class="form-group"><label>新密碼</label><input type="password" id="newPwd" class="form-control"></div>
                <div class="form-group"><label>確認新密碼</label><input type="password" id="newPwd2" class="form-control"></div>
                <button class="btn btn-primary btn-sm" onclick="changePasswordSetting()"><i class="fas fa-save"></i> 更新</button>
              </div>
            </div>
          </div>
          <div class="card mt-2">
            <div class="card-header"><div class="card-title"><i class="fas fa-database"></i> 資料</div></div>
            <div class="card-body" style="display:flex; gap:0.5rem; flex-wrap:wrap;">
              <button class="btn btn-secondary btn-sm" onclick="exportUserData()"><i class="fas fa-download"></i> 匯出我的資料</button>
              ${PermissionManager.hasPermission('manage_system')?`<button class="btn btn-secondary btn-sm" onclick="backupSystemData()"><i class="fas fa-save"></i> 系統備份</button>`:''}
              <button class="btn btn-danger btn-sm" onclick="deleteAccount()"><i class="fas fa-user-slash"></i> 刪除帳號</button>
            </div>
          </div>
        </div>
      `;
    }
    function toggleDarkMode(on){
      if(on) document.documentElement.classList.add('dark-theme');
      else document.documentElement.classList.remove('dark-theme');
      localStorage.setItem('darkMode', on?'1':'0');
    }
    async function updateEmailSetting(){
      const email = document.getElementById('settingEmail').value.trim();
      if(!validateEmail(email)){ showToast('Email 格式不正確', 'error'); return; }
      try{
        const res = await callServerFunction('updateEmail', { email });
        if(res.success){
          currentUser.email = email;
          const key = localStorage.getItem('currentUser') ? 'localStorage' : 'sessionStorage';
          if(key==='localStorage') localStorage.setItem('currentUser', JSON.stringify(currentUser));
          else sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
          showToast('已更新信箱', 'success');
        }else showToast('更新失敗：'+res.error, 'error');
      }catch(e){ showToast('系統錯誤：'+e.message, 'error'); }
    }
    async function changePasswordSetting(){
      const p1 = document.getElementById('newPwd').value;
      const p2 = document.getElementById('newPwd2').value;
      if(!p1 || p1.length<6) return showToast('密碼至少 6 碼', 'warning');
      if(p1!==p2) return showToast('兩次密碼不一致', 'error');
      try{
        const res = await callServerFunction('changePassword', { password: p1 });
        if(res.success) showToast('密碼已更新', 'success'); else showToast('更新失敗：'+res.error, 'error');
      }catch(e){ showToast('系統錯誤：'+e.message, 'error'); }
    }
    async function exportUserData(){
      try{
        const res = await callServerFunction('exportUserData', { userId: currentUser.id });
        if(res.success && res.downloadUrl) window.open(res.downloadUrl, '_blank');
      }catch(e){ showToast('匯出失敗', 'error'); }
    }
    async function backupSystemData(){
      try{
        const res = await callServerFunction('backupSystemData', {});
        if(res.success) showToast('備份已啟動', 'success');
      }catch(e){ showToast('備份失敗', 'error'); }
    }
    async function deleteAccount(){
      if(!confirm('確定刪除帳號？此操作無法復原。')) return;
      try{
        const res = await callServerFunction('deleteAccount', { userId: currentUser.id });
        if(res.success){
          showToast('帳號已刪除', 'success');
          logout();
        }else showToast('刪除失敗：'+res.error, 'error');
      }catch(e){ showToast('系統錯誤：'+e.message, 'error'); }
    }

    // ============ QR 簽到掃描 ============
    function createQRScannerInterface(){
      return `
        <div class="container">
          <div class="page-header">
            <h1><i class="fas fa-qrcode"></i> QR 簽到</h1>
            <div style="display:flex; gap:0.5rem;">
              <select id="qrActivitySelect" class="form-control" style="min-width:220px;">
                <option value="">選擇活動</option>
              </select>
              <button class="btn btn-secondary" onclick="startQRScanner()"><i class="fas fa-play"></i> 開始掃描</button>
              <button class="btn btn-secondary" onclick="stopQRScanner()"><i class="fas fa-stop"></i> 停止</button>
            </div>
          </div>
          <div class="qr-scanner-container">
            <div class="scanner-video-container">
              <video id="qrVideo" playsinline></video>
              <canvas id="qrCanvas" class="hidden"></canvas>
              <div class="scanner-overlay"><div class="scanner-frame"></div></div>
            </div>
          </div>
          <div id="qrResult" class="mt-2"></div>
        </div>
      `;
    }
    async function loadActivitiesForQR(){
      try{
        const res = await callServerFunctionWithCache('getUpcomingActivities', {}, 2);
        const sel = document.getElementById('qrActivitySelect');
        if(res.success && sel){
          const list = res.activities || [];
          sel.innerHTML = '<option value="">選擇活動</option>' + list.map(a=>`<option value="${escapeHtml(a['活動ID'])}">${escapeHtml(a['活動名稱'])}（${formatDate(a['開始時間'])}）</option>`).join('');
        }
      }catch(e){ showToast('載入活動失敗', 'error'); }
    }
    let qrStream = null, qrTimer = null;
    async function startQRScanner(){
      const activityId = document.getElementById('qrActivitySelect').value;
      if(!activityId) return showToast('請先選擇活動', 'warning');
      try{
        const video = document.getElementById('qrVideo');
        qrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }});
        video.srcObject = qrStream; await video.play();
        const canvas = document.getElementById('qrCanvas');
        const ctx = canvas.getContext('2d');
        qrTimer = setInterval(()=>{
          if(video.readyState !== video.HAVE_ENOUGH_DATA) return;
          canvas.width = video.videoWidth; canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(img.data, canvas.width, canvas.height);
          if(code && code.data){
            stopQRScanner();
            handleQRCheckIn(activityId, code.data);
          }
        }, 300);
        showToast('相機已啟動', 'success');
      }catch(e){
        showToast('無法啟動相機：'+e.message, 'error');
      }
    }
    function stopQRScanner(){
      if(qrTimer){ clearInterval(qrTimer); qrTimer = null; }
      if(qrStream){
        qrStream.getTracks().forEach(t=>t.stop());
        qrStream = null;
      }
    }
    async function handleQRCheckIn(activityId, qrText){
      document.getElementById('qrResult').innerHTML = `<div class="card"><div class="card-body"><i class="fas fa-info-circle"></i> 讀取到：${escapeHtml(qrText)}</div></div>`;
      // 假設 QR 內容是 memberId，亦可在此解析格式
      const memberId = qrText.trim();
      try{
        const res = await callServerFunction('checkInActivity', { activityId, memberId });
        if(res.success){
          showToast('簽到成功：'+ (res.activity?.name||''), 'success');
        }else showToast('簽到失敗：'+res.error, 'error');
      }catch(e){ showToast('系統錯誤：'+e.message, 'error'); }
    }

    // ============ Chat ============
    function toggleChat(force){
      const c = document.getElementById('chatContainer');
      const t = document.getElementById('chatToggleBtn');
      const on = typeof force==='boolean' ? force : !c.classList.contains('active');
      if(on){
        c.classList.add('active'); t.style.display='none';
        loadChatHistory(); startChatPolling();
      }else{
        c.classList.remove('active'); t.style.display='flex';
        stopChatPolling();
      }
    }
    async function loadChatHistory(){
      try{
        const res = await callServerFunction('getChatMessages', {});
        if(res.success) renderChatMessages(res.messages||[]);
      }catch(e){ /* ignore */ }
    }
    function renderChatMessages(msgs){
      const box = document.getElementById('chatMessages');
      box.innerHTML = '';
      msgs.forEach(m=> appendChatMessage(m));
      box.scrollTop = box.scrollHeight;
    }
    function appendChatMessage(m){
      const box = document.getElementById('chatMessages');
      const own = m.senderId===currentUser?.id;
      const el = document.createElement('div');
      el.className = 'chat-message'+(own?' own':'');
      el.innerHTML = `
        <div class="chat-message-avatar">${escapeHtml(m.senderName?.charAt(0)||'?')}</div>
        <div class="chat-message-content">
          <div class="chat-message-header">
            <span class="chat-message-name">${escapeHtml(m.senderName||'匿名')}</span>
            <span class="chat-message-time">${formatRelativeTime(m.timestamp)}</span>
          </div>
          <div class="chat-message-text">${escapeHtml(m.message||'')}</div>
        </div>
      `;
      box.appendChild(el);
    }
    async function sendChatMessage(){
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if(!text) return;
      input.value = '';
      try{
        await callServerFunction('sendChatMessage', { senderId: currentUser.id, senderName: currentUser.name, message: text });
        appendChatMessage({ senderId: currentUser.id, senderName: currentUser.name, message: text, timestamp: new Date().toISOString() });
        const box = document.getElementById('chatMessages');
        box.scrollTop = box.scrollHeight;
      }catch(e){ showToast('送出失敗', 'error'); }
    }
    function handleChatKeydown(e){
      if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault(); sendChatMessage();
      }
    }
    function checkNewMessages(){
      // 只更新徽章數量（示範）
      callServerFunction('getUnreadMessageCount', {}).then(res=>{
        const badge = document.getElementById('chatBadge');
        if(res.success && res.count>0){
          badge.textContent = res.count; badge.style.display='flex';
        }else{
          badge.style.display='none';
        }
      }).catch(()=>{});
    }
    function startChatPolling(){
      setIntervalSafe(async ()=>{
        try{
          const res = await callServerFunction('getChatMessages', {});
          if(res.success){
            renderChatMessages(res.messages||[]);
          }
        }catch(e){}
      }, 5000, 'chatPoll');
    }
    function stopChatPolling(){
      if(window.__intervals && window.__intervals['chatPoll']){
        clearInterval(window.__intervals['chatPoll']);
        window.__intervals['chatPoll'] = null;
      }
    }

    // ============ Notifications ============
    let notificationsOpen = false;
    function initNotifications(){
      startNotificationPolling();
      // 初始載入角標
      refreshNotificationBadge();
    }
    function startNotificationPolling(){
      setIntervalSafe(loadNotifications, 12000, 'notifPoll');
    }
    function stopNotificationPolling(){
      if(window.__intervals && window.__intervals['notifPoll']){
        clearInterval(window.__intervals['notifPoll']);
        window.__intervals['notifPoll'] = null;
      }
    }
    async function loadNotifications(){
      try{
        const res = await callServerFunction('getNotifications', { userId: currentUser.id });
        if(res.success){
          renderNotificationDropdown(res.notifications||[]);
          refreshNotificationBadge(res.notifications||[]);
        }
      }catch(e){}
    }
    function refreshNotificationBadge(list){
      const badge = document.getElementById('notificationBadge');
      let count = 0;
      if(Array.isArray(list)) count = list.filter(n=>!n.read).length;
      badge.textContent = count;
      badge.style.display = count>0 ? 'flex' : 'none';
    }
    function toggleNotifications(){
      notificationsOpen = !notificationsOpen;
      if(notificationsOpen){
        openNotificationDropdown();
        loadNotifications();
      }else{
        closeNotificationDropdown();
      }
    }
    function openNotificationDropdown(){
      let dd = document.getElementById('notificationDropdown');
      if(dd){ dd.remove(); }
      dd = document.createElement('div');
      dd.id = 'notificationDropdown';
      dd.className = 'notification-dropdown';
      dd.innerHTML = `
        <div class="notification-dropdown-header">
          <strong>通知</strong>
          <button class="btn btn-sm" onclick="markAllNotificationsAsRead()"><i class="fas fa-check-double"></i> 全部已讀</button>
        </div>
        <div class="notification-dropdown-body" id="notificationList">
          <div class="loading">載入中...</div>
        </div>
        <div class="notification-dropdown-footer">
          <button class="btn btn-secondary btn-sm" onclick="toggleNotifications()"><i class="fas fa-times"></i> 關閉</button>
        </div>
      `;
      const nav = document.querySelector('.notification-icon');
      if(nav){
        nav.style.position='relative';
        nav.appendChild(dd);
      }
      loadNotifications();
    }
    function closeNotificationDropdown(){
      const dd = document.getElementById('notificationDropdown');
      if(dd) dd.remove();
    }
    function renderNotificationDropdown(list){
      const container = document.getElementById('notificationList');
      if(!container) return;
      if(!list || list.length===0){
        container.innerHTML = `<div class="empty-state"><i class="fas fa-bell-slash"></i><p>目前沒有通知</p></div>`;
        return;
      }
      container.innerHTML = list.map(n=>`
        <div class="notification-item ${n.read?'':'unread'}" onclick="onClickNotification('${n.id}', '${escapeHtml(n.type)}', '${escapeHtml(n.activityId||'')}')">
          <div class="notification-icon" style="background:${getNotificationColor(n.type)}"><i class="fas fa-${getNotificationIcon(n.type)}"></i></div>
          <div style="flex:1;">
            <div><strong>${escapeHtml(n.title||'通知')}</strong></div>
            <div>${escapeHtml(n.message||'')}</div>
            <small class="text-secondary">${formatRelativeTime(n.timestamp)}</small>
          </div>
        </div>
      `).join('');
    }
    async function onClickNotification(id, type, activityId){
      try{
        await callServerFunction('markNotificationAsRead', { notificationId: id });
      }catch(e){}
      if(type==='activity' && activityId){
        toggleNotifications();
        navigateTo('activity-detail', { id: activityId });
      }
      loadNotifications();
    }
    async function markAllNotificationsAsRead(){
      try{
        await callServerFunction('markAllNotificationsAsRead', {});
        loadNotifications();
      }catch(e){}
    }

    // ============ Push Notification ============
    async function subscribeToPush(){
      if(!('serviceWorker' in navigator)){ showToast('瀏覽器不支援推播', 'warning'); return; }
      const reg = await navigator.serviceWorker.ready;
      const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
      });
      const ok = await callServerFunction('savePushSubscription', { subscription: sub });
      if(ok.success){
        localStorage.setItem('pushSubscribed', 'true');
        showToast('推播已開啟', 'success');
        const el = document.getElementById('pushNotificationSetting'); if(el) el.checked = true;
      }
    }
    async function unsubscribePush(){
      const reg = await navigator.serviceWorker.ready;
      const sub = await reg.pushManager.getSubscription();
      if(sub){
        await sub.unsubscribe();
        await callServerFunction('removePushSubscription', {});
      }
      localStorage.setItem('pushSubscribed', 'false');
      showToast('推播已關閉', 'success');
      const el = document.getElementById('pushNotificationSetting'); if(el) el.checked = false;
    }
    function togglePushNotifications(checkbox){
      if(checkbox.checked) subscribeToPush().catch(()=>{ checkbox.checked=false; });
      else unsubscribePush().catch(()=>{ checkbox.checked=true; });
    }
    function testNotification(){
      showToast('這是一則測試通知', 'info');
    }
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    // ============ 啟動 ============
    window.addEventListener('load', ()=>{
      // 恢復深色模式
      if(localStorage.getItem('darkMode')==='1') document.documentElement.classList.add('dark-theme');
      initializeApp();
      // hash 導頁
      const hash = location.hash.replace('#','');
      if(hash){
        // 僅針對主頁面名稱
        const [page, paramStr] = hash.split('?');
        navigateTo(page || 'home');
      }
      // 關閉下拉菜單點擊外部關閉
      document.addEventListener('click', (e)=>{
        const dd = document.getElementById('userDropdown');
        if(dd && dd.style.display==='block'){
          const menu = dd.closest('.user-menu');
          if(menu && !menu.contains(e.target)) dd.style.display='none';
        }
      });
    });
  </script>
</body>
</html>
