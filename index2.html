<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="腦帕金森病友會管理系統">
  <meta name="theme-color" content="#4285f4">
  <title>腦帕金森病友會管理系統</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icon-192x192.png">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  
  <!-- QR Code Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  
  <!-- Google Apps Script Web App URL -->
  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzzsqQQiJ9-JSJ5xDt9VeZx0aFXXpmtt1Klv62GuShxftQAZvCMPelLBlNnRFkhV31o/exec';
    const VAPID_PUBLIC_KEY = 'YOUR_VAPID_PUBLIC_KEY_HERE';
  </script>
  
  <!-- Styles -->
  <style>
/* ==================== CSS Variables ==================== */
:root {
  --primary-color: #4285f4;
  --secondary-color: #34a853;
  --danger-color: #ea4335;
  --warning-color: #fbbc04;
  --dark-color: #202124;
  --light-color: #f8f9fa;
  --border-color: #dadce0;
  --text-color: #202124;
  --text-secondary: #5f6368;
  --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
  --shadow-lg: 0 10px 40px rgba(0,0,0,0.2);
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ==================== Reset & Base ==================== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: var(--text-color);
  background: var(--light-color);
  line-height: 1.6;
  overflow-x: hidden;
}

a {
  text-decoration: none;
  color: inherit;
}

button {
  border: none;
  background: none;
  cursor: pointer;
  font-family: inherit;
}

input, textarea, select {
  font-family: inherit;
  font-size: inherit;
}

/* ==================== Loading Overlay ==================== */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.95);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.loading-overlay.active {
  display: flex;
}

.loading-spinner {
  text-align: center;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid var(--border-color);
  border-top-color: var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ==================== Navigation ==================== */
.navbar {
  background: white;
  box-shadow: var(--shadow);
  position: sticky;
  top: 0;
  z-index: 1000;
}

.navbar-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.navbar-brand {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--primary-color);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.navbar-menu {
  display: flex;
  gap: 2rem;
  align-items: center;
}

.nav-link {
  color: var(--text-color);
  transition: var(--transition);
  padding: 0.5rem 1rem;
  border-radius: 8px;
}

.nav-link:hover {
  background: var(--light-color);
  color: var(--primary-color);
}

.nav-link.active {
  background: var(--primary-color);
  color: white;
}

.user-menu {
  position: relative;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  cursor: pointer;
  transition: var(--transition);
}

.user-avatar:hover {
  transform: scale(1.1);
}

/* ==================== Buttons ==================== */
.btn {
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: 500;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  border: none;
}

.btn-primary {
  background: var(--primary-color);
  color: white;
}

.btn-primary:hover {
  background: #3367d6;
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.btn-secondary {
  background: var(--secondary-color);
  color: white;
}

.btn-secondary:hover {
  background: #2d8e47;
}

.btn-danger {
  background: var(--danger-color);
  color: white;
}

.btn-danger:hover {
  background: #d33b2c;
}

.btn-sm {
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
}

.btn-block {
  width: 100%;
  justify-content: center;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ==================== Forms ==================== */
.form-group {
  margin-bottom: 1.5rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: var(--text-color);
}

.form-control {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-size: 1rem;
  transition: var(--transition);
}

.form-control:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
}

/* ==================== Cards ==================== */
.card {
  background: white;
  border-radius: 12px;
  box-shadow: var(--shadow);
  padding: 1.5rem;
  transition: var(--transition);
}

.card:hover {
  box-shadow: var(--shadow-lg);
  transform: translateY(-4px);
}

.card-header {
  border-bottom: 1px solid var(--border-color);
  padding-bottom: 1rem;
  margin-bottom: 1rem;
}

.card-title {
  font-size: 1.25rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

/* ==================== Grid Layouts ==================== */
.grid {
  display: grid;
  gap: 2rem;
}

.grid-2 {
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
}

.grid-3 {
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
}

.grid-4 {
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}

/* ==================== KPI Cards ==================== */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.kpi-card {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: var(--shadow);
  display: flex;
  gap: 1rem;
  transition: var(--transition);
}

.kpi-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.kpi-icon {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: white;
  flex-shrink: 0;
}

.kpi-content {
  flex: 1;
}

.kpi-content h3 {
  font-size: 2rem;
  font-weight: bold;
  margin-bottom: 0.25rem;
}

.kpi-content p {
  color: var(--text-secondary);
  font-size: 0.9rem;
  margin-bottom: 0.5rem;
}

.kpi-trend {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  font-size: 0.85rem;
  font-weight: 500;
}

.kpi-trend.positive {
  color: var(--secondary-color);
}

.kpi-trend.negative {
  color: var(--danger-color);
}

/* ==================== Activity Cards ==================== */
.activity-card {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--shadow);
  transition: var(--transition);
  cursor: pointer;
}

.activity-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.activity-image {
  width: 100%;
  height: 200px;
  object-fit: cover;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
}

.activity-content {
  padding: 1.5rem;
}

.activity-category {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  background: var(--primary-color);
  color: white;
  border-radius: 20px;
  font-size: 0.85rem;
  margin-bottom: 0.5rem;
}

.activity-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.activity-meta {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  color: var(--text-secondary);
  font-size: 0.9rem;
  margin-bottom: 1rem;
}

.activity-meta span {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: var(--light-color);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 0.5rem;
}

.progress-fill {
  height: 100%;
  background: var(--primary-color);
  transition: width 0.3s ease;
}

.activity-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

.status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 500;
}

.status-badge.active {
  background: #e8f5e9;
  color: var(--secondary-color);
}

.status-badge.full {
  background: #fff3e0;
  color: var(--warning-color);
}

.status-badge.closed {
  background: #ffebee;
  color: var(--danger-color);
}

/* ==================== Modal ==================== */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  padding: 1rem;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: 12px;
  max-width: 800px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.close-modal {
  position: absolute;
  top: 1rem;
  right: 1rem;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--light-color);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  z-index: 1;
}

.close-modal:hover {
  background: var(--border-color);
}

.modal-header {
  padding: 2rem;
  border-bottom: 1px solid var(--border-color);
}

.modal-header h2 {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.modal-body {
  padding: 2rem;
}

.modal-footer {
  padding: 1.5rem 2rem;
  border-top: 1px solid var(--border-color);
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
}

/* ==================== Tables ==================== */
.table-container {
  overflow-x: auto;
  background: white;
  border-radius: 12px;
  box-shadow: var(--shadow);
}

table {
  width: 100%;
  border-collapse: collapse;
}

thead {
  background: var(--light-color);
}

th {
  padding: 1rem;
  text-align: left;
  font-weight: 600;
  color: var(--text-color);
  border-bottom: 2px solid var(--border-color);
}

td {
  padding: 1rem;
  border-bottom: 1px solid var(--border-color);
}

tr:hover {
  background: var(--light-color);
}

/* ==================== Chat Widget ==================== */
.chat-container {
  position: fixed;
  bottom: 80px;
  right: 20px;
  width: 350px;
  height: 500px;
  background: white;
  border-radius: 12px;
  box-shadow: var(--shadow-lg);
  display: none;
  flex-direction: column;
  z-index: 1500;
  animation: slideUp 0.3s ease;
}

.chat-container.active {
  display: flex;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.chat-header {
  padding: 1rem;
  background: var(--primary-color);
  color: white;
  border-radius: 12px 12px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.chat-message {
  display: flex;
  gap: 0.5rem;
  max-width: 80%;
}

.chat-message.own {
  align-self: flex-end;
  flex-direction: row-reverse;
}

.chat-message-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.85rem;
  font-weight: bold;
  flex-shrink: 0;
}

.chat-message-content {
  flex: 1;
}

.chat-message-header {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.25rem;
  font-size: 0.85rem;
}

.chat-message-name {
  font-weight: 600;
}

.chat-message-time {
  color: var(--text-secondary);
}

.chat-message-text {
  background: var(--light-color);
  padding: 0.75rem;
  border-radius: 12px;
  word-wrap: break-word;
}

.chat-message.own .chat-message-text {
  background: var(--primary-color);
  color: white;
}

.chat-input-container {
  padding: 1rem;
  border-top: 1px solid var(--border-color);
  display: flex;
  gap: 0.5rem;
}

.chat-input-container textarea {
  flex: 1;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 0.5rem;
  resize: none;
  font-family: inherit;
}

.chat-toggle-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  box-shadow: var(--shadow-lg);
  cursor: pointer;
  transition: var(--transition);
  z-index: 1400;
}

.chat-toggle-btn:hover {
  transform: scale(1.1);
}

.chat-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--danger-color);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: bold;
}

/* ==================== Notifications ==================== */
.notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  min-width: 20px;
  height: 20px;
  border-radius: 10px;
  background: var(--danger-color);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: bold;
  padding: 0 5px;
}

.notification-item {
  padding: 1rem;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  gap: 1rem;
  cursor: pointer;
  transition: var(--transition);
}

.notification-item:hover {
  background: var(--light-color);
}

.notification-item.unread {
  background: #e8f0fe;
}

.notification-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  flex-shrink: 0;
}

/* ==================== Toast ==================== */
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: white;
  padding: 1rem 1.5rem;
  border-radius: 8px;
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  gap: 0.75rem;
  z-index: 3000;
  transition: var(--transition);
  opacity: 0;
}

.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

.toast-success {
  border-left: 4px solid var(--secondary-color);
}

.toast-error {
  border-left: 4px solid var(--danger-color);
}

.toast-warning {
  border-left: 4px solid var(--warning-color);
}

.toast-info {
  border-left: 4px solid var(--primary-color);
}

/* ==================== Batch Toolbar ==================== */
.batch-toolbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  padding: 1rem 2rem;
  transform: translateY(100%);
  transition: var(--transition);
  z-index: 1300;
}

.batch-toolbar.active {
  transform: translateY(0);
}

.batch-toolbar-content {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.batch-actions {
  display: flex;
  gap: 0.5rem;
}

/* ==================== Charts ==================== */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 2rem;
  margin-bottom: 2rem;
}

.chart-card {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: var(--shadow);
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border-color);
}

.chart-container {
  height: 300px;
  position: relative;
}

/* ==================== QR Scanner ==================== */
.qr-scanner-container {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 90%;
  max-width: 600px;
  background: white;
  border-radius: 12px;
  box-shadow: var(--shadow-lg);
  z-index: 2000;
}

.scanner-video-container {
  position: relative;
  width: 100%;
  height: 400px;
  background: black;
  border-radius: 8px;
  overflow: hidden;
}

#qrVideo {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.scanner-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.scanner-frame {
  width: 250px;
  height: 250px;
  border: 3px solid var(--primary-color);
  border-radius: 12px;
  box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
}

/* ==================== Responsive ==================== */
@media (max-width: 768px) {
  .navbar-menu {
    gap: 1rem;
  }
  
  .grid-2, .grid-3, .grid-4 {
    grid-template-columns: 1fr;
  }
  
  .kpi-grid {
    grid-template-columns: 1fr;
  }
  
  .charts-grid {
    grid-template-columns: 1fr;
  }
  
  .chat-container {
    width: 100%;
    height: 100%;
    bottom: 0;
    right: 0;
    border-radius: 0;
  }
  
  .modal-content {
    max-width: 100%;
    max-height: 100vh;
    border-radius: 0;
  }
}

/* ==================== Utilities ==================== */
.text-center { text-align: center; }
.text-right { text-align: right; }
.mt-1 { margin-top: 0.5rem; }
.mt-2 { margin-top: 1rem; }
.mt-3 { margin-top: 1.5rem; }
.mb-1 { margin-bottom: 0.5rem; }
.mb-2 { margin-bottom: 1rem; }
.mb-3 { margin-bottom: 1.5rem; }
.p-1 { padding: 0.5rem; }
.p-2 { padding: 1rem; }
.p-3 { padding: 1.5rem; }

.hidden { display: none !important; }
.visible { display: block !important; }

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

.empty-state {
  text-align: center;
  padding: 3rem;
  color: var(--text-secondary);
}

.empty-state i {
  font-size: 4rem;
  margin-bottom: 1rem;
  opacity: 0.3;
}

  </style>  
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>載入中...</p>
    </div>
  </div>

  <!-- Main Container -->
  <div id="app">
    <!-- 動態內容將在此處渲染 -->
  </div>

  <!-- Chat Widget -->
  <div class="chat-container" id="chatContainer">
    <div class="chat-header">
      <h3><i class="fas fa-comments"></i> 病友交流</h3>
      <button class="btn btn-sm" onclick="toggleChat()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="chat-messages" id="chatMessages">
      <div class="chat-welcome">
        <i class="fas fa-comments"></i>
        <p>歡迎來到病友交流區</p>
      </div>
    </div>
    
    <div class="chat-input-container">
      <textarea id="chatInput" 
                placeholder="輸入訊息..." 
                rows="1"
                onkeydown="handleChatKeydown(event)"></textarea>
      <button class="btn btn-primary" onclick="sendChatMessage()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
  
  <button class="chat-toggle-btn" onclick="toggleChat()" id="chatToggleBtn">
    <i class="fas fa-comments"></i>
    <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
  </button>

  <!-- Notification Dropdown (動態生成) -->
  
  <!-- Scripts -->
  <script>
    // ==================== APP.JS - 主應用程式 ====================

// 全域變數
let currentUser = null;
let currentPage = 'home';

// 應用程式初始化
function initializeApp() {
  console.log('初始化應用程式...');
  
  // 檢查登入狀態
  checkLoginStatus();
  
  // 初始化快取管理器
  CacheManager.init();
  
  // 初始化離線管理器
  OfflineManager.init();
  
  // 載入語言設定
  loadLanguagePreference();
  
  // 初始化效能監控
  PerformanceMonitor.logPageLoad();
  
  // 檢查網路狀態
  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);
  
  // 初始化 Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => console.log('Service Worker 註冊成功'))
      .catch(err => console.log('Service Worker 註冊失敗:', err));
  }
}

// 檢查登入狀態
function checkLoginStatus() {
  const savedUser = localStorage.getItem('currentUser');
  
  if (savedUser) {
    currentUser = JSON.parse(savedUser);
    navigateTo('home');
  } else {
    navigateTo('login');
  }
}

// 頁面導航
function navigateTo(page, params = {}) {
  currentPage = page;
  
  // 更新 URL (不重新載入頁面)
  history.pushState({ page, params }, '', `#${page}`);
  
  // 渲染頁面
  renderPage(page, params);
  
  // 更新導航列
  updateNavigation();
}

// 渲染頁面
function renderPage(page, params = {}) {
  const app = document.getElementById('app');
  
  switch(page) {
    case 'login':
      app.innerHTML = createLoginPage();
      break;
    case 'register':
      app.innerHTML = createRegisterPage();
      break;
    case 'home':
      app.innerHTML = createHomePage();
      loadHomeData();
      break;
    case 'dashboard':
      app.innerHTML = createDashboard();
      loadDashboardData();
      break;
    case 'activities':
      app.innerHTML = createActivitiesPage();
      loadActivities();
      break;
    case 'activity-detail':
      app.innerHTML = createActivityDetailPage(params.id);
      loadActivityDetail(params.id);
      break;
    case 'members':
      app.innerHTML = createMembersPage();
      loadMembers();
      break;
    case 'profile':
      app.innerHTML = createProfilePage();
      loadProfile();
      break;
    case 'reports':
      app.innerHTML = createReportsPage();
      break;
    case 'settings':
      app.innerHTML = createSettingsPage();
      break;
    case 'qr-scanner':
      app.innerHTML = createQRScannerInterface();
      break;
    case 'email-editor':
      app.innerHTML = createEmailTemplateEditor();
      break;
    case 'permissions':
      app.innerHTML = createPermissionManagementUI();
      break;
    default:
      app.innerHTML = '<div class="container"><h1>404 - 頁面不存在</h1></div>';
  }
  
  // 滾動到頂部
  window.scrollTo(0, 0);
}

// 更新導航列
function updateNavigation() {
  const app = document.getElementById('app');
  
  let navHTML = '';
  
  if (currentUser) {
    navHTML = `
      <nav class="navbar">
        <div class="navbar-container">
          <a href="#" class="navbar-brand" onclick="navigateTo('home'); return false;">
            <i class="fas fa-heartbeat"></i>
            腦帕金森病友會
          </a>
          
          <div class="navbar-menu">
            <a href="#" class="nav-link ${currentPage === 'home' ? 'active' : ''}" 
               onclick="navigateTo('home'); return false;">
              <i class="fas fa-home"></i> 首頁
            </a>
            
            <a href="#" class="nav-link ${currentPage === 'activities' ? 'active' : ''}" 
               onclick="navigateTo('activities'); return false;">
              <i class="fas fa-calendar-alt"></i> 活動
            </a>
            
            ${PermissionManager.hasPermission('view_dashboard') ? `
              <a href="#" class="nav-link ${currentPage === 'dashboard' ? 'active' : ''}" 
                 onclick="navigateTo('dashboard'); return false;">
                <i class="fas fa-chart-line"></i> 儀表板
              </a>
            ` : ''}
            
            ${PermissionManager.hasPermission('view_members') ? `
              <a href="#" class="nav-link ${currentPage === 'members' ? 'active' : ''}" 
                 onclick="navigateTo('members'); return false;">
                <i class="fas fa-users"></i> 會員
              </a>
            ` : ''}
            
            ${PermissionManager.hasPermission('view_reports') ? `
              <a href="#" class="nav-link ${currentPage === 'reports' ? 'active' : ''}" 
                 onclick="navigateTo('reports'); return false;">
                <i class="fas fa-file-alt"></i> 報表
              </a>
            ` : ''}
            
            <div class="user-menu">
              <div class="user-avatar" onclick="toggleUserMenu()">
                ${currentUser.name.charAt(0)}
              </div>
              <div class="dropdown-menu" id="userDropdown" style="display: none;">
                <a onclick="navigateTo('profile')">
                  <i class="fas fa-user"></i> 個人資料
                </a>
                <a onclick="navigateTo('settings')">
                  <i class="fas fa-cog"></i> 設定
                </a>
                <a onclick="logout()">
                  <i class="fas fa-sign-out-alt"></i> 登出
                </a>
              </div>
            </div>
            
            <div class="notification-icon" onclick="toggleNotifications()">
              <i class="fas fa-bell"></i>
              <span class="notification-badge" id="notificationBadge">0</span>
            </div>
          </div>
        </div>
      </nav>
    `;
  }
  
  // 插入導航列到頁面頂部
  if (!document.querySelector('.navbar')) {
    app.insertAdjacentHTML('afterbegin', navHTML);
  }
}

// 切換使用者選單
function toggleUserMenu() {
  const dropdown = document.getElementById('userDropdown');
  dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

// 登出
function logout() {
  if (confirm('確定要登出嗎？')) {
    localStorage.removeItem('currentUser');
    currentUser = null;
    navigateTo('login');
    showToast('已登出', 'success');
  }
}

// 網路狀態處理
function handleOnline() {
  document.body.classList.remove('offline');
  showToast('網路已連接', 'success');
  OfflineManager.syncOfflineData();
}

function handleOffline() {
  document.body.classList.add('offline');
  showToast('網路已斷線，部分功能可能無法使用', 'warning');
}

// Toast 通知
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.innerHTML = `
    <i class="fas fa-${getToastIcon(type)}"></i>
    <span>${message}</span>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => toast.classList.add('show'), 100);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function getToastIcon(type) {
  const icons = {
    success: 'check-circle',
    error: 'exclamation-circle',
    warning: 'exclamation-triangle',
    info: 'info-circle'
  };
  return icons[type] || 'info-circle';
}

// 關閉 Modal
function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove('active');
    setTimeout(() => modal.remove(), 300);
  }
}

// 瀏覽器返回按鈕處理
window.addEventListener('popstate', (event) => {
  if (event.state && event.state.page) {
    renderPage(event.state.page, event.state.params || {});
  }
});


// ==================== AUTH.JS - 認證系統 ====================

// 創建登入頁面
function createLoginPage() {
  return `
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <i class="fas fa-heartbeat"></i>
          <h1>腦帕金森病友會</h1>
          <p>會員管理系統</p>
        </div>
        
        <form onsubmit="handleLogin(event)" class="auth-form">
          <div class="form-group">
            <label>帳號</label>
            <input type="text" id="loginUsername" class="form-control" 
                   placeholder="請輸入帳號" required>
          </div>
          
          <div class="form-group">
            <label>密碼</label>
            <input type="password" id="loginPassword" class="form-control" 
                   placeholder="請輸入密碼" required>
          </div>
          
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="rememberMe">
              <span>記住我</span>
            </label>
          </div>
          
          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-sign-in-alt"></i> 登入
          </button>
          
          <div class="auth-links">
            <a href="#" onclick="navigateTo('register'); return false;">
              還沒有帳號？立即註冊
            </a>
            <a href="#" onclick="showForgotPassword(); return false;">
              忘記密碼？
            </a>
          </div>
        </form>
      </div>
    </div>
  `;
}

// 創建註冊頁面
function createRegisterPage() {
  return `
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <i class="fas fa-user-plus"></i>
          <h1>會員註冊</h1>
          <p>加入我們的大家庭</p>
        </div>
        
        <form onsubmit="handleRegister(event)" class="auth-form">
          <div class="form-row">
            <div class="form-group">
              <label>姓名 *</label>
              <input type="text" id="registerName" class="form-control" 
                     placeholder="請輸入姓名" required>
            </div>
            
            <div class="form-group">
              <label>性別 *</label>
              <select id="registerGender" class="form-control" required>
                <option value="">請選擇</option>
                <option value="男">男</option>
                <option value="女">女</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label>出生日期 *</label>
            <input type="date" id="registerBirthDate" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label>電話 *</label>
            <input type="tel" id="registerPhone" class="form-control" 
                   placeholder="請輸入電話" required>
          </div>
          
          <div class="form-group">
            <label>電子郵件 *</label>
            <input type="email" id="registerEmail" class="form-control" 
                   placeholder="請輸入電子郵件" required>
          </div>
          
          <div class="form-group">
            <label>地址</label>
            <input type="text" id="registerAddress" class="form-control" 
                   placeholder="請輸入地址">
          </div>
          
          <div class="form-group">
            <label>帳號 *</label>
            <input type="text" id="registerUsername" class="form-control" 
                   placeholder="請輸入帳號" required>
          </div>
          
          <div class="form-group">
            <label>密碼 *</label>
            <input type="password" id="registerPassword" class="form-control" 
                   placeholder="請輸入密碼（至少6個字元）" required minlength="6">
          </div>
          
          <div class="form-group">
            <label>確認密碼 *</label>
            <input type="password" id="registerPasswordConfirm" class="form-control" 
                   placeholder="請再次輸入密碼" required>
          </div>
          
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="agreeTerms" required>
              <span>我同意<a href="#" onclick="showTerms(); return false;">服務條款</a>與<a href="#" onclick="showPrivacy(); return false;">隱私政策</a></span>
            </label>
          </div>
          
          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-user-plus"></i> 註冊
          </button>
          
          <div class="auth-links">
            <a href="#" onclick="navigateTo('login'); return false;">
              已有帳號？立即登入
            </a>
          </div>
        </form>
      </div>
    </div>
  `;
}

// 處理登入
async function handleLogin(event) {
  event.preventDefault();
  
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;
  const rememberMe = document.getElementById('rememberMe').checked;
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('login', {
      username: username,
      password: password
    });
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      currentUser = result.user;
      
      if (rememberMe) {
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
      } else {
        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
      }
      
      showToast('登入成功！', 'success');
      navigateTo('home');
      
      // 訂閱推播通知
      if (localStorage.getItem('pushSubscribed') !== 'true') {
        setTimeout(() => {
          if (confirm('是否要開啟推播通知以接收最新消息？')) {
            subscribeToPush();
          }
        }, 2000);
      }
    } else {
      showToast('登入失敗：' + result.error, 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 處理註冊
async function handleRegister(event) {
  event.preventDefault();
  
  const password = document.getElementById('registerPassword').value;
  const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
  
  if (password !== passwordConfirm) {
    showToast('密碼不一致，請重新輸入', 'error');
    return;
  }
  
  const registerData = {
    name: document.getElementById('registerName').value,
    gender: document.getElementById('registerGender').value,
    birthDate: document.getElementById('registerBirthDate').value,
    phone: document.getElementById('registerPhone').value,
    email: document.getElementById('registerEmail').value,
    address: document.getElementById('registerAddress').value,
    username: document.getElementById('registerUsername').value,
    password: password
  };
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('register', registerData);
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      showToast('註冊成功！請登入', 'success');
      navigateTo('login');
    } else {
      showToast('註冊失敗：' + result.error, 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 顯示忘記密碼對話框
function showForgotPassword() {
  const email = prompt('請輸入您的註冊電子郵件：');
  if (!email) return;
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  callServerFunction('forgotPassword', { email: email })
    .then(result => {
      document.getElementById('loadingOverlay').classList.remove('active');
      if (result.success) {
        showToast('重設密碼連結已發送到您的信箱', 'success');
      } else {
        showToast('發送失敗：' + result.error, 'error');
      }
    })
    .catch(error => {
      document.getElementById('loadingOverlay').classList.remove('active');
      showToast('系統錯誤：' + error.message, 'error');
    });
}

// 顯示服務條款
function showTerms() {
  alert('服務條款內容...');
}

// 顯示隱私政策
function showPrivacy() {
  alert('隱私政策內容...');
}


// ==================== HOME.JS - 首頁 ====================

// 創建首頁
function createHomePage() {
  return `
    <div class="container">
      <div class="welcome-section">
        <h1>歡迎回來，${currentUser.name}！</h1>
        <p>今天是 ${formatDate(new Date(), true)}</p>
      </div>
      
      <!-- 快速統計 -->
      <div class="quick-stats" id="quickStats">
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="fas fa-calendar-check"></i>
          </div>
          <div class="stat-content">
            <h3 id="upcomingActivitiesCount">-</h3>
            <p>即將舉辦的活動</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <i class="fas fa-user-check"></i>
          </div>
          <div class="stat-content">
            <h3 id="myRegistrationsCount">-</h3>
            <p>我的報名</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <i class="fas fa-trophy"></i>
          </div>
          <div class="stat-content">
            <h3 id="myPointsCount">-</h3>
            <p>我的積分</p>
          </div>
        </div>
      </div>
      
      <!-- 最新活動 -->
      <section class="section">
        <div class="section-header">
          <h2><i class="fas fa-calendar-alt"></i> 最新活動</h2>
          <a href="#" onclick="navigateTo('activities'); return false;" class="btn btn-primary btn-sm">
            查看全部 <i class="fas fa-arrow-right"></i>
          </a>
        </div>
        
        <div class="grid grid-3" id="latestActivities">
          <div class="loading">載入中...</div>
        </div>
      </section>
      
      <!-- 最新消息 -->
      <section class="section">
        <div class="section-header">
          <h2><i class="fas fa-bullhorn"></i> 最新消息</h2>
        </div>
        
        <div class="news-list" id="newsList">
          <div class="loading">載入中...</div>
        </div>
      </section>
      
      <!-- 快速操作 -->
      <section class="section">
        <div class="section-header">
          <h2><i class="fas fa-bolt"></i> 快速操作</h2>
        </div>
        
        <div class="quick-actions">
          <button class="quick-action-btn" onclick="navigateTo('activities')">
            <i class="fas fa-calendar-plus"></i>
            <span>報名活動</span>
          </button>
          
          <button class="quick-action-btn" onclick="navigateTo('profile')">
            <i class="fas fa-user-edit"></i>
            <span>編輯資料</span>
          </button>
          
          <button class="quick-action-btn" onclick="openQRScanner()">
            <i class="fas fa-qrcode"></i>
            <span>QR 簽到</span>
          </button>
          
          <button class="quick-action-btn" onclick="toggleChat()">
            <i class="fas fa-comments"></i>
            <span>病友交流</span>
          </button>
        </div>
      </section>
    </div>
  `;
}

// 載入首頁資料
async function loadHomeData() {
  try {
    // 載入統計資料
    const statsResult = await callServerFunctionWithCache('getHomeStats', {
      memberId: currentUser.id
    }, 5);
    
    if (statsResult.success) {
      document.getElementById('upcomingActivitiesCount').textContent = statsResult.stats.upcomingActivities;
      document.getElementById('myRegistrationsCount').textContent = statsResult.stats.myRegistrations;
      document.getElementById('myPointsCount').textContent = statsResult.stats.myPoints;
    }
    
    // 載入最新活動
    const activitiesResult = await callServerFunctionWithCache('getLatestActivities', {
      limit: 6
    }, 5);
    
    if (activitiesResult.success) {
      displayLatestActivities(activitiesResult.activities);
    }
    
    // 載入最新消息
    const newsResult = await callServerFunctionWithCache('getLatestNews', {
      limit: 5
    }, 5);
    
    if (newsResult.success) {
      displayLatestNews(newsResult.news);
    }
    
  } catch (error) {
    console.error('載入首頁資料失敗:', error);
    showToast('載入資料失敗', 'error');
  }
}

// 顯示最新活動
function displayLatestActivities(activities) {
  const container = document.getElementById('latestActivities');
  
  if (activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar"></i><p>目前沒有活動</p></div>';
    return;
  }
  
  container.innerHTML = activities.map(activity => `
    <div class="activity-card" onclick="navigateTo('activity-detail', {id: '${activity['活動ID']}'})">
      <div class="activity-image" style="background: linear-gradient(135deg, ${getRandomGradient()});">
        <i class="fas fa-${getActivityIcon(activity['活動類型'])}"></i>
      </div>
      <div class="activity-content">
        <span class="activity-category">${activity['活動類型']}</span>
        <h3 class="activity-title">${activity['活動名稱']}</h3>
        <div class="activity-meta">
          <span><i class="fas fa-calendar"></i> ${formatDate(activity['開始時間'])}</span>
          <span><i class="fas fa-map-marker-alt"></i> ${activity['活動地點']}</span>
          <span><i class="fas fa-users"></i> ${activity['已報名人數']}/${activity['人數上限']}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${(activity['已報名人數'] / activity['人數上限'] * 100)}%"></div>
        </div>
        <div class="activity-footer">
          <span class="status-badge ${getActivityStatus(activity)}">${getActivityStatusText(activity)}</span>
          <button class="btn btn-primary btn-sm">查看詳情</button>
        </div>
      </div>
    </div>
  `).join('');
}

// 顯示最新消息
function displayLatestNews(news) {
  const container = document.getElementById('newsList');
  
  if (news.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="fas fa-newspaper"></i><p>目前沒有消息</p></div>';
    return;
  }
  
  container.innerHTML = news.map(item => `
    <div class="news-item">
      <div class="news-icon">
        <i class="fas fa-bullhorn"></i>
      </div>
      <div class="news-content">
        <h4>${item.title}</h4>
        <p>${item.content}</p>
        <span class="news-time">${formatRelativeTime(item.createdAt)}</span>
      </div>
    </div>
  `).join('');
}

// 開啟 QR 掃描器
function openQRScanner() {
  navigateTo('qr-scanner');
}



// ==================== DASHBOARD.JS - 儀表板 ====================

// 創建儀表板
function createDashboard() {
  return `
    <div class="container">
      <div class="dashboard-header">
        <h1><i class="fas fa-chart-line"></i> 數據分析儀表板</h1>
        <div class="dashboard-controls">
          <select id="dashboardPeriod" onchange="updateDashboard()" class="form-control">
            <option value="week">本週</option>
            <option value="month" selected>本月</option>
            <option value="quarter">本季</option>
            <option value="year">本年</option>
          </select>
          <button class="btn btn-secondary btn-sm" onclick="refreshDashboard()">
            <i class="fas fa-sync-alt"></i> 重新整理
          </button>
          <button class="btn btn-primary btn-sm" onclick="exportDashboard()">
            <i class="fas fa-download"></i> 匯出
          </button>
        </div>
      </div>
      
      <!-- KPI Cards -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="fas fa-users"></i>
          </div>
          <div class="kpi-content">
            <h3 id="kpiTotalMembers">0</h3>
            <p>總會員數</p>
            <div class="kpi-trend positive">
              <i class="fas fa-arrow-up"></i>
              <span id="kpiMembersTrend">+0%</span>
            </div>
          </div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <i class="fas fa-calendar-check"></i>
          </div>
          <div class="kpi-content">
            <h3 id="kpiTotalActivities">0</h3>
            <p>舉辦活動</p>
            <div class="kpi-trend positive">
              <i class="fas fa-arrow-up"></i>
              <span id="kpiActivitiesTrend">+0%</span>
            </div>
          </div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <i class="fas fa-user-check"></i>
          </div>
          <div class="kpi-content">
            <h3 id="kpiAttendanceRate">0%</h3>
            <p>平均出席率</p>
            <div class="kpi-trend positive">
              <i class="fas fa-arrow-up"></i>
              <span id="kpiAttendanceTrend">+0%</span>
            </div>
          </div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <i class="fas fa-smile"></i>
          </div>
          <div class="kpi-content">
            <h3 id="kpiSatisfaction">0</h3>
            <p>滿意度評分</p>
            <div class="kpi-trend positive">
              <i class="fas fa-arrow-up"></i>
              <span id="kpiSatisfactionTrend">+0</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Charts Grid -->
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-header">
            <h3><i class="fas fa-chart-line"></i> 會員成長趨勢</h3>
            <button class="btn btn-sm" onclick="toggleChartType('memberGrowth')">
              <i class="fas fa-exchange-alt"></i>
            </button>
          </div>
          <div class="chart-container">
            <canvas id="memberGrowthChart"></canvas>
          </div>
        </div>
        
        <div class="chart-card">
          <div class="chart-header">
            <h3><i class="fas fa-chart-bar"></i> 活動參與統計</h3>
            <button class="btn btn-sm" onclick="toggleChartType('activityParticipation')">
              <i class="fas fa-exchange-alt"></i>
            </button>
          </div>
          <div class="chart-container">
            <canvas id="activityParticipationChart"></canvas>
          </div>
        </div>
        
        <div class="chart-card">
          <div class="chart-header">
            <h3><i class="fas fa-chart-pie"></i> 活動類型分布</h3>
          </div>
          <div class="chart-container">
            <canvas id="activityTypeChart"></canvas>
          </div>
        </div>
        
        <div class="chart-card">
          <div class="chart-header">
            <h3><i class="fas fa-map-marked-alt"></i> 地區分布</h3>
          </div>
          <div class="chart-container">
            <canvas id="locationDistributionChart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Data Tables -->
      <div class="dashboard-tables">
        <div class="table-card">
          <div class="table-header">
            <h3><i class="fas fa-trophy"></i> 熱門活動 Top 10</h3>
          </div>
          <div class="table-container">
            <table id="topActivitiesTable">
              <thead>
                <tr>
                  <th>排名</th>
                  <th>活動名稱</th>
                  <th>參與人數</th>
                  <th>滿意度</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="4" class="loading">載入中...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="table-card">
          <div class="table-header">
            <h3><i class="fas fa-star"></i> 活躍會員 Top 10</h3>
          </div>
          <div class="table-container">
            <table id="activeMembersTable">
              <thead>
                <tr>
                  <th>排名</th>
                  <th>會員姓名</th>
                  <th>參與次數</th>
                  <th>最後參與</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="4" class="loading">載入中...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  `;
}

// 載入儀表板資料
async function loadDashboardData() {
  const period = document.getElementById('dashboardPeriod')?.value || 'month';
  
  try {
    const result = await callServerFunctionWithCache('getDashboardData', { period }, 5);
    
    if (result.success) {
      updateKPIs(result.kpis);
      updateCharts(result.charts);
      updateTables(result.tables);
    }
  } catch (error) {
    console.error('載入儀表板資料失敗:', error);
    showToast('載入資料失敗', 'error');
  }
}

// 更新 KPI
function updateKPIs(kpis) {
  animateNumber('kpiTotalMembers', kpis.totalMembers);
  updateTrend('kpiMembersTrend', kpis.membersTrend);
  
  animateNumber('kpiTotalActivities', kpis.totalActivities);
  updateTrend('kpiActivitiesTrend', kpis.activitiesTrend);
  
  animateNumber('kpiAttendanceRate', kpis.attendanceRate, '%');
  updateTrend('kpiAttendanceTrend', kpis.attendanceTrend, '%');
  
  animateNumber('kpiSatisfaction', kpis.satisfaction, '', 1);
  updateTrend('kpiSatisfactionTrend', kpis.satisfactionTrend);
}

// 更新趨勢
function updateTrend(elementId, value, suffix = '%') {
  const element = document.getElementById(elementId);
  if (!element) return;
  
  const parent = element.closest('.kpi-trend');
  const isPositive = value >= 0;
  
  parent.className = 'kpi-trend ' + (isPositive ? 'positive' : 'negative');
  parent.querySelector('i').className = 'fas fa-arrow-' + (isPositive ? 'up' : 'down');
  element.textContent = (isPositive ? '+' : '') + value + suffix;
}

// 更新圖表
function updateCharts(charts) {
  if (charts.memberGrowth) {
    createLineChart('memberGrowthChart', charts.memberGrowth);
  }
  
  if (charts.activityParticipation) {
    createBarChart('activityParticipationChart', charts.activityParticipation);
  }
  
  if (charts.activityType) {
    createDoughnutChart('activityTypeChart', charts.activityType);
  }
  
  if (charts.locationDistribution) {
    createPolarChart('locationDistributionChart', charts.locationDistribution);
  }
}

// 創建折線圖
function createLineChart(canvasId, data) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  if (canvas.chart) {
    canvas.chart.destroy();
  }
  
  canvas.chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: data.label,
        data: data.values,
        borderColor: 'rgb(102, 126, 234)',
        backgroundColor: 'rgba(102, 126, 234, 0.1)',
        tension: 0.4,
        fill: true,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      }
    }
  });
}

// 創建長條圖
function createBarChart(canvasId, data) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  if (canvas.chart) {
    canvas.chart.destroy();
  }
  
  canvas.chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.labels,
      datasets: [{
        label: data.label,
        data: data.values,
        backgroundColor: 'rgba(240, 147, 251, 0.8)',
        borderColor: 'rgb(240, 147, 251)',
        borderWidth: 1,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      }
    }
  });
}

// 創建圓餅圖
function createDoughnutChart(canvasId, data) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  if (canvas.chart) {
    canvas.chart.destroy();
  }
  
  canvas.chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: data.labels,
      datasets: [{
        data: data.values,
        backgroundColor: [
          'rgba(102, 126, 234, 0.8)',
          'rgba(240, 147, 251, 0.8)',
          'rgba(79, 172, 254, 0.8)',
          'rgba(67, 233, 123, 0.8)',
          'rgba(251, 188, 4, 0.8)'
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right'
        }
      }
    }
  });
}

// 創建極座標圖
function createPolarChart(canvasId, data) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  if (canvas.chart) {
    canvas.chart.destroy();
  }
  
  canvas.chart = new Chart(ctx, {
    type: 'polarArea',
    data: {
      labels: data.labels,
      datasets: [{
        data: data.values,
        backgroundColor: [
          'rgba(102, 126, 234, 0.6)',
          'rgba(240, 147, 251, 0.6)',
          'rgba(79, 172, 254, 0.6)',
          'rgba(67, 233, 123, 0.6)',
          'rgba(251, 188, 4, 0.6)'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right'
        }
      }
    }
  });
}

// 更新表格
function updateTables(tables) {
  if (tables.topActivities) {
    updateTopActivitiesTable(tables.topActivities);
  }
  
  if (tables.activeMembers) {
    updateActiveMembersTable(tables.activeMembers);
  }
}

// 更新熱門活動表格
function updateTopActivitiesTable(data) {
  const tbody = document.querySelector('#topActivitiesTable tbody');
  if (!tbody) return;
  
  tbody.innerHTML = data.map((item, index) => `
    <tr>
      <td>
        <span class="rank-badge ${index < 3 ? 'top-' + (index + 1) : ''}">
          ${index + 1}
        </span>
      </td>
      <td>${item.name}</td>
      <td>${item.participants}</td>
      <td>
        <div class="rating">
          ${generateStars(item.satisfaction)}
          <span>${item.satisfaction.toFixed(1)}</span>
        </div>
      </td>
    </tr>
  `).join('');
}

// 更新活躍會員表格
function updateActiveMembersTable(data) {
  const tbody = document.querySelector('#activeMembersTable tbody');
  if (!tbody) return;
  
  tbody.innerHTML = data.map((item, index) => `
    <tr>
      <td>
        <span class="rank-badge ${index < 3 ? 'top-' + (index + 1) : ''}">
          ${index + 1}
        </span>
      </td>
      <td>${item.name}</td>
      <td>${item.participations}</td>
      <td>${formatRelativeTime(item.lastParticipation)}</td>
    </tr>
  `).join('');
}

// 切換圖表類型
function toggleChartType(chartName) {
  const canvas = document.getElementById(chartName + 'Chart');
  if (!canvas || !canvas.chart) return;
  
  const currentType = canvas.chart.config.type;
  const newType = currentType === 'line' ? 'bar' : 'line';
  
  canvas.chart.config.type = newType;
  canvas.chart.update();
}

// 重新整理儀表板
function refreshDashboard() {
  CacheManager.clear('api_getDashboardData');
  loadDashboardData();
}

// 更新儀表板
function updateDashboard() {
  loadDashboardData();
}

// 匯出儀表板
async function exportDashboard() {
  const format = prompt('請選擇匯出格式：\n1. PDF\n2. Excel\n3. 圖片', '1');
  
  if (!format) return;
  
  let exportFormat;
  switch(format) {
    case '1':
      exportFormat = 'pdf';
      break;
    case '2':
      exportFormat = 'xlsx';
      break;
    case '3':
      exportFormat = 'png';
      break;
    default:
      alert('無效的格式');
      return;
  }
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('exportDashboard', {
      format: exportFormat,
      period: document.getElementById('dashboardPeriod').value
    });
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      window.open(result.downloadUrl, '_blank');
    } else {
      alert('匯出失敗：' + result.error);
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    alert('系統錯誤：' + error.message);
  }
}



// ==================== ACTIVITIES.JS - 活動管理 ====================

// 創建活動頁面
function createActivitiesPage() {
  return `
    <div class="container">
      <div class="page-header">
        <h1><i class="fas fa-calendar-alt"></i> 活動管理</h1>
        ${PermissionManager.hasPermission('manage_activities') ? `
          <button class="btn btn-primary" onclick="showCreateActivityModal()">
            <i class="fas fa-plus"></i> 新增活動
          </button>
        ` : ''}
      </div>
      
      <!-- 搜尋與篩選 -->
      <div class="search-filter-bar">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="activitySearch" placeholder="搜尋活動..." 
                 onkeyup="filterActivities()">
        </div>
        
        <div class="filter-group">
          <select id="activityTypeFilter" onchange="filterActivities()" class="form-control">
            <option value="">所有類型</option>
            <option value="健康講座">健康講座</option>
            <option value="復健課程">復健課程</option>
            <option value="社交活動">社交活動</option>
            <option value="志工服務">志工服務</option>
            <option value="其他">其他</option>
          </select>
          
          <select id="activityStatusFilter" onchange="filterActivities()" class="form-control">
            <option value="">所有狀態</option>
            <option value="upcoming">即將舉辦</option>
            <option value="ongoing">進行中</option>
            <option value="completed">已結束</option>
            <option value="cancelled">已取消</option>
          </select>
          
          <select id="activitySortBy" onchange="filterActivities()" class="form-control">
            <option value="date">依日期排序</option>
            <option value="popularity">依人氣排序</option>
            <option value="name">依名稱排序</option>
          </select>
        </div>
      </div>
      
      <!-- 活動列表 -->
      <div class="grid grid-3" id="activitiesList">
        <div class="loading">載入中...</div>
      </div>
    </div>
  `;
}

// 載入活動列表
async function loadActivities() {
  try {
    const result = await callServerFunctionWithCache('getActivities', {}, 5);
    
    if (result.success) {
      window.allActivities = result.activities;
      displayActivities(result.activities);
    }
  } catch (error) {
    console.error('載入活動失敗:', error);
    showToast('載入活動失敗', 'error');
  }
}

// 顯示活動列表
function displayActivities(activities) {
  const container = document.getElementById('activitiesList');
  
  if (activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar"></i><p>目前沒有活動</p></div>';
    return;
  }
  
  container.innerHTML = activities.map(activity => `
    <div class="activity-card" onclick="navigateTo('activity-detail', {id: '${activity['活動ID']}'})">
      <div class="activity-image" style="background: linear-gradient(135deg, ${getRandomGradient()});">
        <i class="fas fa-${getActivityIcon(activity['活動類型'])}"></i>
      </div>
      <div class="activity-content">
        <span class="activity-category">${activity['活動類型']}</span>
        <h3 class="activity-title">${activity['活動名稱']}</h3>
        <div class="activity-meta">
          <span><i class="fas fa-calendar"></i> ${formatDate(activity['開始時間'])}</span>
          <span><i class="fas fa-clock"></i> ${formatTime(activity['開始時間'])} - ${formatTime(activity['結束時間'])}</span>
          <span><i class="fas fa-map-marker-alt"></i> ${activity['活動地點']}</span>
          <span><i class="fas fa-users"></i> ${activity['已報名人數']}/${activity['人數上限']}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${(activity['已報名人數'] / activity['人數上限'] * 100)}%"></div>
        </div>
        <p class="activity-description">${truncateText(activity['活動說明'], 100)}</p>
        <div class="activity-footer">
          <span class="status-badge ${getActivityStatus(activity)}">${getActivityStatusText(activity)}</span>
          <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); registerActivity('${activity['活動ID']}')">
            <i class="fas fa-user-plus"></i> 報名
          </button>
        </div>
      </div>
    </div>
  `).join('');
}

// 篩選活動
function filterActivities() {
  const searchTerm = document.getElementById('activitySearch').value.toLowerCase();
  const typeFilter = document.getElementById('activityTypeFilter').value;
  const statusFilter = document.getElementById('activityStatusFilter').value;
  const sortBy = document.getElementById('activitySortBy').value;
  
  let filtered = window.allActivities.filter(activity => {
    const matchSearch = activity['活動名稱'].toLowerCase().includes(searchTerm) ||
                       activity['活動說明'].toLowerCase().includes(searchTerm);
    const matchType = !typeFilter || activity['活動類型'] === typeFilter;
    const matchStatus = !statusFilter || getActivityStatus(activity) === statusFilter;
    
    return matchSearch && matchType && matchStatus;
  });
  
  // 排序
  filtered.sort((a, b) => {
    switch(sortBy) {
      case 'date':
        return new Date(a['開始時間']) - new Date(b['開始時間']);
      case 'popularity':
        return b['已報名人數'] - a['已報名人數'];
      case 'name':
        return a['活動名稱'].localeCompare(b['活動名稱']);
      default:
        return 0;
    }
  });
  
  displayActivities(filtered);
}

// 創建活動詳情頁面
function createActivityDetailPage(activityId) {
  return `
    <div class="container">
      <div id="activityDetail">
        <div class="loading">載入中...</div>
      </div>
    </div>
  `;
}

// 載入活動詳情
async function loadActivityDetail(activityId) {
  try {
    const result = await callServerFunction('getActivityDetail', { activityId });
    
    if (result.success) {
      displayActivityDetail(result.activity);
    }
  } catch (error) {
    console.error('載入活動詳情失敗:', error);
    showToast('載入活動詳情失敗', 'error');
  }
}

// 顯示活動詳情
function displayActivityDetail(activity) {
  const container = document.getElementById('activityDetail');
  
  container.innerHTML = `
    <div class="activity-detail">
      <div class="activity-detail-header">
        <button class="btn btn-secondary" onclick="history.back()">
          <i class="fas fa-arrow-left"></i> 返回
        </button>
        ${PermissionManager.hasPermission('manage_activities') ? `
          <div class="activity-actions">
            <button class="btn btn-secondary" onclick="editActivity('${activity['活動ID']}')">
              <i class="fas fa-edit"></i> 編輯
            </button>
            <button class="btn btn-danger" onclick="deleteActivity('${activity['活動ID']}')">
              <i class="fas fa-trash"></i> 刪除
            </button>
          </div>
        ` : ''}
      </div>
      
      <div class="activity-detail-content">
        <div class="activity-detail-main">
          <div class="activity-detail-image" style="background: linear-gradient(135deg, ${getRandomGradient()});">
            <i class="fas fa-${getActivityIcon(activity['活動類型'])}"></i>
          </div>
          
          <div class="activity-detail-info">
            <span class="activity-category">${activity['活動類型']}</span>
            <h1>${activity['活動名稱']}</h1>
            
            <div class="activity-meta-grid">
              <div class="meta-item">
                <i class="fas fa-calendar"></i>
                <div>
                  <strong>日期</strong>
                  <p>${formatDate(activity['開始時間'], true)}</p>
                </div>
              </div>
              
              <div class="meta-item">
                <i class="fas fa-clock"></i>
                <div>
                  <strong>時間</strong>
                  <p>${formatTime(activity['開始時間'])} - ${formatTime(activity['結束時間'])}</p>
                </div>
              </div>
              
              <div class="meta-item">
                <i class="fas fa-map-marker-alt"></i>
                <div>
                  <strong>地點</strong>
                  <p>${activity['活動地點']}</p>
                </div>
              </div>
              
              <div class="meta-item">
                <i class="fas fa-users"></i>
                <div>
                  <strong>人數</strong>
                  <p>${activity['已報名人數']} / ${activity['人數上限']}</p>
                </div>
              </div>
              
              <div class="meta-item">
                <i class="fas fa-user-tie"></i>
                <div>
                  <strong>負責人</strong>
                  <p>${activity['負責人'] || '未指定'}</p>
                </div>
              </div>
              
              <div class="meta-item">
                <i class="fas fa-phone"></i>
                <div>
                  <strong>聯絡電話</strong>
                  <p>${activity['聯絡電話'] || '未提供'}</p>
                </div>
              </div>
            </div>
            
            <div class="activity-description-full">
              <h3>活動說明</h3>
              <p>${activity['活動說明']}</p>
            </div>
            
            <div class="activity-progress">
              <div class="progress-info">
                <span>報名進度</span>
                <span>${Math.round(activity['已報名人數'] / activity['人數上限'] * 100)}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${(activity['已報名人數'] / activity['人數上限'] * 100)}%"></div>
              </div>
            </div>
            
            <div class="activity-actions-main">
              <button class="btn btn-primary btn-lg" onclick="registerActivity('${activity['活動ID']}')">
                <i class="fas fa-user-plus"></i> 立即報名
              </button>
              <button class="btn btn-secondary btn-lg" onclick="shareActivity('${activity['活動ID']}')">
                <i class="fas fa-share-alt"></i> 分享
              </button>
            </div>
          </div>
        </div>
        
        <div class="activity-detail-sidebar">
          <div class="card">
            <h3><i class="fas fa-users"></i> 已報名名單</h3>
            <div id="registeredMembersList">
              <div class="loading">載入中...</div>
            </div>
          </div>
          
          <div class="card">
            <h3><i class="fas fa-comments"></i> 活動討論</h3>
            <div id="activityComments">
              <div class="loading">載入中...</div>
            </div>
            <div class="comment-input">
              <textarea id="commentText" placeholder="發表您的看法..." rows="3"></textarea>
              <button class="btn btn-primary btn-sm" onclick="postComment('${activity['活動ID']}')">
                <i class="fas fa-paper-plane"></i> 發送
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // 載入報名名單
  loadRegisteredMembers(activity['活動ID']);
  
  // 載入評論
  loadActivityComments(activity['活動ID']);
}

// 報名活動
async function registerActivity(activityId) {
  if (!currentUser) {
    showToast('請先登入', 'warning');
    navigateTo('login');
    return;
  }
  
  if (!confirm('確定要報名此活動嗎？')) {
    return;
  }
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('registerActivity', {
      activityId: activityId,
      memberId: currentUser.id,
      memberName: currentUser.name
    });
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      showToast('報名成功！', 'success');
      
      // 重新載入活動詳情
      if (currentPage === 'activity-detail') {
        loadActivityDetail(activityId);
      } else {
        loadActivities();
      }
    } else {
      showToast('報名失敗：' + result.error, 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 顯示新增活動對話框
function showCreateActivityModal() {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'createActivityModal';
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 800px;">
      <button class="close-modal" onclick="closeModal('createActivityModal')">
        <i class="fas fa-times"></i>
      </button>
      
      <div class="modal-header">
        <h2><i class="fas fa-plus"></i> 新增活動</h2>
      </div>
      
      <div class="modal-body">
        <form id="createActivityForm" onsubmit="handleCreateActivity(event)">
          <div class="form-row">
            <div class="form-group">
              <label>活動名稱 *</label>
              <input type="text" name="activityName" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label>活動類型 *</label>
              <select name="activityType" class="form-control" required>
                <option value="">請選擇</option>
                <option value="健康講座">健康講座</option>
                <option value="復健課程">復健課程</option>
                <option value="社交活動">社交活動</option>
                <option value="志工服務">志工服務</option>
                <option value="其他">其他</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>開始時間 *</label>
              <input type="datetime-local" name="startTime" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label>結束時間 *</label>
              <input type="datetime-local" name="endTime" class="form-control" required>
            </div>
          </div>
          
          <div class="form-group">
            <label>活動地點 *</label>
            <input type="text" name="location" class="form-control" required>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>人數上限 *</label>
              <input type="number" name="maxParticipants" class="form-control" min="1" required>
            </div>
            
            <div class="form-group">
              <label>負責人</label>
              <input type="text" name="organizer" class="form-control">
            </div>
          </div>
          
          <div class="form-group">
            <label>聯絡電話</label>
            <input type="tel" name="contactPhone" class="form-control">
          </div>
          
          <div class="form-group">
            <label>活動說明 *</label>
            <textarea name="description" class="form-control" rows="5" required></textarea>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('createActivityModal')">取消</button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-check"></i> 建立活動
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// 處理新增活動
async function handleCreateActivity(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const activityData = {
    name: formData.get('activityName'),
    type: formData.get('activityType'),
    startTime: formData.get('startTime'),
    endTime: formData.get('endTime'),
    location: formData.get('location'),
    maxParticipants: formData.get('maxParticipants'),
    organizer: formData.get('organizer'),
    contactPhone: formData.get('contactPhone'),
    description: formData.get('description')
  };
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('createActivity', activityData);
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      showToast('活動建立成功！', 'success');
      closeModal('createActivityModal');
      loadActivities();
    } else {
      showToast('建立失敗：' + result.error, 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}



// ==================== MEMBERS.JS - 會員管理 ====================

// 創建會員頁面
function createMembersPage() {
  return `
    <div class="container">
      <div class="page-header">
        <h1><i class="fas fa-users"></i> 會員管理</h1>
        ${PermissionManager.hasPermission('manage_members') ? `
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="exportMembers()">
              <i class="fas fa-download"></i> 匯出
            </button>
            <button class="btn btn-primary" onclick="showAddMemberModal()">
              <i class="fas fa-user-plus"></i> 新增會員
            </button>
          </div>
        ` : ''}
      </div>
      
      <!-- 搜尋與篩選 -->
      <div class="search-filter-bar">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="memberSearch" placeholder="搜尋會員..." 
                 onkeyup="filterMembers()">
        </div>
        
        <div class="filter-group">
          <select id="memberStatusFilter" onchange="filterMembers()" class="form-control">
            <option value="">所有狀態</option>
            <option value="active">啟用</option>
            <option value="inactive">停用</option>
          </select>
          
          <select id="memberGenderFilter" onchange="filterMembers()" class="form-control">
            <option value="">所有性別</option>
            <option value="男">男</option>
            <option value="女">女</option>
          </select>
          
          <select id="memberSortBy" onchange="filterMembers()" class="form-control">
            <option value="name">依姓名排序</option>
            <option value="joinDate">依加入日期</option>
            <option value="lastActivity">依最後活動</option>
          </select>
        </div>
        
        ${PermissionManager.hasPermission('manage_members') ? `
          <button class="btn btn-secondary" onclick="BatchOperations.init('membersTable')">
            <i class="fas fa-check-square"></i> 批次操作
          </button>
        ` : ''}
      </div>
      
      <!-- 會員統計 -->
      <div class="stats-row">
        <div class="stat-item">
          <i class="fas fa-users"></i>
          <div>
            <h3 id="totalMembersCount">0</h3>
            <p>總會員數</p>
          </div>
        </div>
        <div class="stat-item">
          <i class="fas fa-user-check"></i>
          <div>
            <h3 id="activeMembersCount">0</h3>
            <p>活躍會員</p>
          </div>
        </div>
        <div class="stat-item">
          <i class="fas fa-user-plus"></i>
          <div>
            <h3 id="newMembersCount">0</h3>
            <p>本月新增</p>
          </div>
        </div>
      </div>
      
      <!-- 會員列表 -->
      <div class="table-container">
        <table id="membersTable">
          <thead>
            <tr>
              <th>會員編號</th>
              <th>姓名</th>
              <th>性別</th>
              <th>電話</th>
              <th>電子郵件</th>
              <th>加入日期</th>
              <th>狀態</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="membersTableBody">
            <tr><td colspan="8" class="loading">載入中...</td></tr>
          </tbody>
        </table>
      </div>
      
      <!-- 分頁 -->
      <div class="pagination" id="membersPagination"></div>
    </div>
  `;
}

// 載入會員列表
async function loadMembers(page = 1) {
  try {
    const result = await callServerFunctionWithCache('getMembers', { page }, 5);
    
    if (result.success) {
      window.allMembers = result.members;
      displayMembers(result.members);
      updateMemberStats(result.stats);
      updatePagination(result.pagination, 'membersPagination', loadMembers);
    }
  } catch (error) {
    console.error('載入會員失敗:', error);
    showToast('載入會員失敗', 'error');
  }
}

// 顯示會員列表
function displayMembers(members) {
  const tbody = document.getElementById('membersTableBody');
  
  if (members.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">目前沒有會員資料</td></tr>';
    return;
  }
  
  tbody.innerHTML = members.map(member => `
    <tr data-id="${member['會員ID']}">
      <td>${member['會員ID']}</td>
      <td>
        <div class="member-info">
          <div class="member-avatar">${member['姓名'].charAt(0)}</div>
          <span>${member['姓名']}</span>
        </div>
      </td>
      <td>${member['性別']}</td>
      <td>${member['電話']}</td>
      <td>${member['電子郵件']}</td>
      <td>${formatDate(member['加入日期'])}</td>
      <td>
        <span class="status-badge ${member['狀態'] === '啟用' ? 'active' : 'inactive'}">
          ${member['狀態']}
        </span>
      </td>
      <td>
        <div class="action-buttons">
          <button class="btn btn-sm btn-secondary" onclick="viewMemberDetail('${member['會員ID']}')" title="查看">
            <i class="fas fa-eye"></i>
          </button>
          ${PermissionManager.hasPermission('manage_members') ? `
            <button class="btn btn-sm btn-primary" onclick="editMember('${member['會員ID']}')" title="編輯">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteMember('${member['會員ID']}')" title="刪除">
              <i class="fas fa-trash"></i>
            </button>
          ` : ''}
        </div>
      </td>
    </tr>
  `).join('');
}

// 更新會員統計
function updateMemberStats(stats) {
  animateNumber('totalMembersCount', stats.total);
  animateNumber('activeMembersCount', stats.active);
  animateNumber('newMembersCount', stats.newThisMonth);
}

// 篩選會員
function filterMembers() {
  const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
  const statusFilter = document.getElementById('memberStatusFilter').value;
  const genderFilter = document.getElementById('memberGenderFilter').value;
  const sortBy = document.getElementById('memberSortBy').value;
  
  let filtered = window.allMembers.filter(member => {
    const matchSearch = member['姓名'].toLowerCase().includes(searchTerm) ||
                       member['電話'].includes(searchTerm) ||
                       member['電子郵件'].toLowerCase().includes(searchTerm);
    const matchStatus = !statusFilter || member['狀態'] === (statusFilter === 'active' ? '啟用' : '停用');
    const matchGender = !genderFilter || member['性別'] === genderFilter;
    
    return matchSearch && matchStatus && matchGender;
  });
  
  // 排序
  filtered.sort((a, b) => {
    switch(sortBy) {
      case 'name':
        return a['姓名'].localeCompare(b['姓名']);
      case 'joinDate':
        return new Date(b['加入日期']) - new Date(a['加入日期']);
      case 'lastActivity':
        return new Date(b['最後活動日期']) - new Date(a['最後活動日期']);
      default:
        return 0;
    }
  });
  
  displayMembers(filtered);
}

// 查看會員詳情
async function viewMemberDetail(memberId) {
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('getMemberDetail', { memberId });
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      showMemberDetailModal(result.member);
    } else {
      showToast('載入會員資料失敗', 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 顯示會員詳情對話框
function showMemberDetailModal(member) {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'memberDetailModal';
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 900px;">
      <button class="close-modal" onclick="closeModal('memberDetailModal')">
        <i class="fas fa-times"></i>
      </button>
      
      <div class="modal-header">
        <h2><i class="fas fa-user"></i> 會員詳細資料</h2>
      </div>
      
      <div class="modal-body">
        <div class="member-detail-grid">
          <div class="member-detail-sidebar">
            <div class="member-avatar-large">${member['姓名'].charAt(0)}</div>
            <h3>${member['姓名']}</h3>
            <p class="member-id">會員編號：${member['會員ID']}</p>
            <span class="status-badge ${member['狀態'] === '啟用' ? 'active' : 'inactive'}">
              ${member['狀態']}
            </span>
            
            <div class="member-stats">
              <div class="stat">
                <i class="fas fa-calendar-check"></i>
                <div>
                  <strong>${member['參與活動數'] || 0}</strong>
                  <span>參與活動</span>
                </div>
              </div>
              <div class="stat">
                <i class="fas fa-trophy"></i>
                <div>
                  <strong>${member['積分'] || 0}</strong>
                  <span>累積積分</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="member-detail-main">
            <div class="detail-section">
              <h4><i class="fas fa-info-circle"></i> 基本資料</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <label>性別</label>
                  <p>${member['性別']}</p>
                </div>
                <div class="detail-item">
                  <label>出生日期</label>
                  <p>${formatDate(member['出生日期'])}</p>
                </div>
                <div class="detail-item">
                  <label>年齡</label>
                  <p>${calculateAge(member['出生日期'])} 歲</p>
                </div>
                <div class="detail-item">
                  <label>加入日期</label>
                  <p>${formatDate(member['加入日期'])}</p>
                </div>
              </div>
            </div>
            
            <div class="detail-section">
              <h4><i class="fas fa-address-card"></i> 聯絡資訊</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <label>電話</label>
                  <p>${member['電話']}</p>
                </div>
                <div class="detail-item">
                  <label>電子郵件</label>
                  <p>${member['電子郵件']}</p>
                </div>
                <div class="detail-item full-width">
                  <label>地址</label>
                  <p>${member['地址'] || '未提供'}</p>
                </div>
              </div>
            </div>
            
            <div class="detail-section">
              <h4><i class="fas fa-heartbeat"></i> 健康資訊</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <label>緊急聯絡人</label>
                  <p>${member['緊急聯絡人'] || '未提供'}</p>
                </div>
                <div class="detail-item">
                  <label>緊急聯絡電話</label>
                  <p>${member['緊急聯絡電話'] || '未提供'}</p>
                </div>
                <div class="detail-item full-width">
                  <label>特殊需求</label>
                  <p>${member['特殊需求'] || '無'}</p>
                </div>
              </div>
            </div>
            
            <div class="detail-section">
              <h4><i class="fas fa-history"></i> 參與記錄</h4>
              <div id="memberActivityHistory">
                <div class="loading">載入中...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('memberDetailModal')">關閉</button>
        ${PermissionManager.hasPermission('manage_members') ? `
          <button class="btn btn-primary" onclick="editMember('${member['會員ID']}')">
            <i class="fas fa-edit"></i> 編輯資料
          </button>
        ` : ''}
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // 載入參與記錄
  loadMemberActivityHistory(member['會員ID']);
}

// 載入會員參與記錄
async function loadMemberActivityHistory(memberId) {
  try {
    const result = await callServerFunction('getMemberActivityHistory', { memberId });
    
    const container = document.getElementById('memberActivityHistory');
    
    if (result.success && result.activities.length > 0) {
      container.innerHTML = `
        <div class="activity-history-list">
          ${result.activities.map(activity => `
            <div class="activity-history-item">
              <div class="activity-history-icon">
                <i class="fas fa-${getActivityIcon(activity['活動類型'])}"></i>
              </div>
              <div class="activity-history-content">
                <h5>${activity['活動名稱']}</h5>
                <p>${formatDate(activity['活動日期'])}</p>
              </div>
              <span class="status-badge ${activity['出席狀態'] === '已出席' ? 'active' : 'inactive'}">
                ${activity['出席狀態']}
              </span>
            </div>
          `).join('')}
        </div>
      `;
    } else {
      container.innerHTML = '<p class="empty-state">尚無參與記錄</p>';
    }
  } catch (error) {
    console.error('載入參與記錄失敗:', error);
    document.getElementById('memberActivityHistory').innerHTML = '<p class="error">載入失敗</p>';
  }
}

// 顯示新增會員對話框
function showAddMemberModal() {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'addMemberModal';
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 800px;">
      <button class="close-modal" onclick="closeModal('addMemberModal')">
        <i class="fas fa-times"></i>
      </button>
      
      <div class="modal-header">
        <h2><i class="fas fa-user-plus"></i> 新增會員</h2>
      </div>
      
      <div class="modal-body">
        <form id="addMemberForm" onsubmit="handleAddMember(event)">
          <div class="form-row">
            <div class="form-group">
              <label>姓名 *</label>
              <input type="text" name="name" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label>性別 *</label>
              <select name="gender" class="form-control" required>
                <option value="">請選擇</option>
                <option value="男">男</option>
                <option value="女">女</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label>出生日期 *</label>
            <input type="date" name="birthDate" class="form-control" required>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>電話 *</label>
              <input type="tel" name="phone" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label>電子郵件 *</label>
              <input type="email" name="email" class="form-control" required>
            </div>
          </div>
          
          <div class="form-group">
            <label>地址</label>
            <input type="text" name="address" class="form-control">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>緊急聯絡人</label>
              <input type="text" name="emergencyContact" class="form-control">
            </div>
            
            <div class="form-group">
              <label>緊急聯絡電話</label>
              <input type="tel" name="emergencyPhone" class="form-control">
            </div>
          </div>
          
          <div class="form-group">
            <label>特殊需求</label>
            <textarea name="specialNeeds" class="form-control" rows="3"></textarea>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('addMemberModal')">取消</button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-check"></i> 新增會員
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// 處理新增會員
async function handleAddMember(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const memberData = {
    name: formData.get('name'),
    gender: formData.get('gender'),
    birthDate: formData.get('birthDate'),
    phone: formData.get('phone'),
    email: formData.get('email'),
    address: formData.get('address'),
    emergencyContact: formData.get('emergencyContact'),
    emergencyPhone: formData.get('emergencyPhone'),
    specialNeeds: formData.get('specialNeeds')
  };
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('addMember', memberData);
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      showToast('會員新增成功！', 'success');
      closeModal('addMemberModal');
      loadMembers();
    } else {
      showToast('新增失敗：' + result.error, 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 編輯會員
async function editMember(memberId) {
  // 先關閉詳情對話框（如果有開啟）
  closeModal('memberDetailModal');
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('getMemberDetail', { memberId });
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      showEditMemberModal(result.member);
    } else {
      showToast('載入會員資料失敗', 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 顯示編輯會員對話框
function showEditMemberModal(member) {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'editMemberModal';
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 800px;">
      <button class="close-modal" onclick="closeModal('editMemberModal')">
        <i class="fas fa-times"></i>
      </button>
      
      <div class="modal-header">
        <h2><i class="fas fa-user-edit"></i> 編輯會員資料</h2>
      </div>
      
      <div class="modal-body">
        <form id="editMemberForm" onsubmit="handleEditMember(event, '${member['會員ID']}')">
          <div class="form-row">
            <div class="form-group">
              <label>姓名 *</label>
              <input type="text" name="name" class="form-control" value="${member['姓名']}" required>
            </div>
            
            <div class="form-group">
              <label>性別 *</label>
              <select name="gender" class="form-control" required>
                <option value="男" ${member['性別'] === '男' ? 'selected' : ''}>男</option>
                <option value="女" ${member['性別'] === '女' ? 'selected' : ''}>女</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label>出生日期 *</label>
            <input type="date" name="birthDate" class="form-control" value="${member['出生日期']}" required>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>電話 *</label>
              <input type="tel" name="phone" class="form-control" value="${member['電話']}" required>
            </div>
            
            <div class="form-group">
              <label>電子郵件 *</label>
              <input type="email" name="email" class="form-control" value="${member['電子郵件']}" required>
            </div>
          </div>
          
          <div class="form-group">
            <label>地址</label>
            <input type="text" name="address" class="form-control" value="${member['地址'] || ''}">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>緊急聯絡人</label>
              <input type="text" name="emergencyContact" class="form-control" value="${member['緊急聯絡人'] || ''}">
            </div>
            
            <div class="form-group">
              <label>緊急聯絡電話</label>
              <input type="tel" name="emergencyPhone" class="form-control" value="${member['緊急聯絡電話'] || ''}">
            </div>
          </div>
          
          <div class="form-group">
            <label>特殊需求</label>
            <textarea name="specialNeeds" class="form-control" rows="3">${member['特殊需求'] || ''}</textarea>
          </div>
          
          <div class="form-group">
            <label>狀態</label>
            <select name="status" class="form-control">
              <option value="啟用" ${member['狀態'] === '啟用' ? 'selected' : ''}>啟用</option>
              <option value="停用" ${member['狀態'] === '停用' ? 'selected' : ''}>停用</option>
            </select>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('editMemberModal')">取消</button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> 儲存變更
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// 處理編輯會員
async function handleEditMember(event, memberId) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const memberData = {
    memberId: memberId,
    name: formData.get('name'),
    gender: formData.get('gender'),
    birthDate: formData.get('birthDate'),
    phone: formData.get('phone'),
    email: formData.get('email'),
    address: formData.get('address'),
    emergencyContact: formData.get('emergencyContact'),
    emergencyPhone: formData.get('emergencyPhone'),
    specialNeeds: formData.get('specialNeeds'),
    status: formData.get('status')
  };
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('updateMember', memberData);
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      showToast('會員資料已更新！', 'success');
      closeModal('editMemberModal');
      loadMembers();
    } else {
      showToast('更新失敗：' + result.error, 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 刪除會員
async function deleteMember(memberId) {
  if (!confirm('確定要刪除此會員嗎？此操作無法復原。')) {
    return;
  }
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('deleteMember', { memberId });
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      showToast('會員已刪除', 'success');
      loadMembers();
    } else {
      showToast('刪除失敗：' + result.error, 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 匯出會員
async function exportMembers() {
  const format = prompt('請選擇匯出格式：\n1. Excel\n2. CSV\n3. PDF', '1');
  
  if (!format) return;
  
  let exportFormat;
  switch(format) {
    case '1':
      exportFormat = 'xlsx';
      break;
    case '2':
      exportFormat = 'csv';
      break;
    case '3':
      exportFormat = 'pdf';
      break;
    default:
      alert('無效的格式');
      return;
  }
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('exportMembers', { format: exportFormat });
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      window.open(result.downloadUrl, '_blank');
    } else {
      alert('匯出失敗：' + result.error);
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    alert('系統錯誤：' + error.message);
  }
}



// ==================== CHAT.JS - 即時聊天 ====================

let chatMessages = [];
let chatPollingInterval = null;

// 切換聊天視窗
function toggleChat() {
  const chatContainer = document.getElementById('chatContainer');
  const chatToggleBtn = document.getElementById('chatToggleBtn');
  
  if (chatContainer.classList.contains('active')) {
    chatContainer.classList.remove('active');
    chatToggleBtn.innerHTML = '<i class="fas fa-comments"></i><span class="chat-badge" id="chatBadge" style="display: none;">0</span>';
  } else {
    chatContainer.classList.add('active');
    chatToggleBtn.innerHTML = '<i class="fas fa-times"></i>';
    loadChatMessages();
    startChatPolling();
    
    // 清除未讀標記
    const badge = document.getElementById('chatBadge');
    if (badge) {
      badge.style.display = 'none';
      badge.textContent = '0';
    }
  }
}

// 載入聊天訊息
async function loadChatMessages() {
  try {
    const result = await callServerFunction('getChatMessages', {
      limit: 50
    });
    
    if (result.success) {
      chatMessages = result.messages;
      displayChatMessages();
      scrollChatToBottom();
    }
  } catch (error) {
    console.error('載入聊天訊息失敗:', error);
  }
}

// 顯示聊天訊息
function displayChatMessages() {
  const container = document.getElementById('chatMessages');
  
  if (chatMessages.length === 0) {
    container.innerHTML = `
      <div class="chat-welcome">
        <i class="fas fa-comments"></i>
        <p>歡迎來到病友交流區</p>
        <p>開始與其他病友交流吧！</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = chatMessages.map(msg => `
    <div class="chat-message ${msg.senderId === currentUser.id ? 'own' : ''}">
      <div class="chat-message-avatar">${msg.senderName.charAt(0)}</div>
      <div class="chat-message-content">
        <div class="chat-message-header">
          <span class="chat-message-name">${msg.senderName}</span>
          <span class="chat-message-time">${formatRelativeTime(msg.timestamp)}</span>
        </div>
        <div class="chat-message-text">${escapeHtml(msg.message)}</div>
      </div>
    </div>
  `).join('');
}

// 發送聊天訊息
async function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  
  if (!message) return;
  
  try {
    const result = await callServerFunction('sendChatMessage', {
      senderId: currentUser.id,
      senderName: currentUser.name,
      message: message
    });
    
    if (result.success) {
      input.value = '';
      input.style.height = 'auto';
      loadChatMessages();
    }
  } catch (error) {
    console.error('發送訊息失敗:', error);
    showToast('發送訊息失敗', 'error');
  }
}

// 處理聊天輸入鍵盤事件
function handleChatKeydown(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendChatMessage();
  }
  
  // 自動調整高度
  const textarea = event.target;
  textarea.style.height = 'auto';
  textarea.style.height = textarea.scrollHeight + 'px';
}

// 滾動到聊天底部
function scrollChatToBottom() {
  const container = document.getElementById('chatMessages');
  container.scrollTop = container.scrollHeight;
}

// 開始輪詢新訊息
function startChatPolling() {
  if (chatPollingInterval) {
    clearInterval(chatPollingInterval);
  }
  
  chatPollingInterval = setInterval(() => {
    loadChatMessages();
  }, 5000); // 每5秒檢查一次
}

// 停止輪詢
function stopChatPolling() {
  if (chatPollingInterval) {
    clearInterval(chatPollingInterval);
    chatPollingInterval = null;
  }
}

// 檢查新訊息（背景執行）
async function checkNewMessages() {
  if (document.getElementById('chatContainer').classList.contains('active')) {
    return; // 聊天視窗已開啟，不需要通知
  }
  
  try {
    const result = await callServerFunction('getUnreadMessageCount', {
      userId: currentUser.id
    });
    
    if (result.success && result.count > 0) {
      const badge = document.getElementById('chatBadge');
      if (badge) {
        badge.style.display = 'block';
        badge.textContent = result.count;
      }
    }
  } catch (error) {
    console.error('檢查新訊息失敗:', error);
  }
}

// 定期檢查新訊息
setInterval(checkNewMessages, 10000); // 每10秒檢查一次



// ==================== NOTIFICATIONS.JS - 通知系統 ====================

let notifications = [];
let notificationPollingInterval = null;

// 初始化通知系統
function initNotifications() {
  loadNotifications();
  startNotificationPolling();
}

// 載入通知
async function loadNotifications() {
  try {
    const result = await callServerFunction('getNotifications', {
      userId: currentUser.id,
      limit: 20
    });
    
    if (result.success) {
      notifications = result.notifications;
      updateNotificationBadge();
    }
  } catch (error) {
    console.error('載入通知失敗:', error);
  }
}

// 更新通知徽章
function updateNotificationBadge() {
  const badge = document.getElementById('notificationBadge');
  const unreadCount = notifications.filter(n => !n.read).length;
  
  if (badge) {
    badge.textContent = unreadCount;
    badge.style.display = unreadCount > 0 ? 'block' : 'none';
  }
}

// 切換通知下拉選單
function toggleNotifications() {
  let dropdown = document.getElementById('notificationDropdown');
  
  if (dropdown) {
    dropdown.remove();
    return;
  }
  
  dropdown = document.createElement('div');
  dropdown.id = 'notificationDropdown';
  dropdown.className = 'notification-dropdown';
  
  dropdown.innerHTML = `
    <div class="notification-dropdown-header">
      <h3>通知</h3>
      <button class="btn btn-sm" onclick="markAllAsRead()">
        <i class="fas fa-check-double"></i> 全部已讀
      </button>
    </div>
    
    <div class="notification-dropdown-body">
      ${notifications.length === 0 ? `
        <div class="empty-state">
          <i class="fas fa-bell-slash"></i>
          <p>目前沒有通知</p>
        </div>
      ` : notifications.map(notification => `
        <div class="notification-item ${notification.read ? '' : 'unread'}" 
             onclick="handleNotificationClick('${notification.id}')">
          <div class="notification-icon" style="background: ${getNotificationColor(notification.type)};">
            <i class="fas fa-${getNotificationIcon(notification.type)}"></i>
          </div>
          <div class="notification-content">
            <h4>${notification.title}</h4>
            <p>${notification.message}</p>
            <span class="notification-time">${formatRelativeTime(notification.timestamp)}</span>
          </div>
        </div>
      `).join('')}
    </div>
    
    <div class="notification-dropdown-footer">
      <a href="#" onclick="navigateTo('notifications'); return false;">
        查看全部通知
      </a>
    </div>
  `;
  
  document.querySelector('.notification-icon').appendChild(dropdown);
  
  // 點擊外部關閉
  setTimeout(() => {
    document.addEventListener('click', closeNotificationDropdown);
  }, 100);
}

// 關閉通知下拉選單
function closeNotificationDropdown(event) {
  const dropdown = document.getElementById('notificationDropdown');
  if (dropdown && !dropdown.contains(event.target)) {
    dropdown.remove();
    document.removeEventListener('click', closeNotificationDropdown);
  }
}

// 處理通知點擊
async function handleNotificationClick(notificationId) {
  const notification = notifications.find(n => n.id === notificationId);
  if (!notification) return;
  
  // 標記為已讀
  await markNotificationAsRead(notificationId);
  
  // 根據通知類型執行相應動作
  switch(notification.type) {
    case 'activity':
      navigateTo('activity-detail', { id: notification.activityId });
      break;
    case 'message':
      toggleChat();
      break;
    case 'system':
      // 顯示詳細訊息
      alert(notification.message);
      break;
  }
  
  // 關閉下拉選單
  document.getElementById('notificationDropdown')?.remove();
}

// 標記通知為已讀
async function markNotificationAsRead(notificationId) {
  try {
    await callServerFunction('markNotificationAsRead', {
      notificationId: notificationId
    });
    
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
      notification.read = true;
      updateNotificationBadge();
    }
  } catch (error) {
    console.error('標記通知失敗:', error);
  }
}

// 標記全部為已讀
async function markAllAsRead() {
  try {
    await callServerFunction('markAllNotificationsAsRead', {
      userId: currentUser.id
    });
    
    notifications.forEach(n => n.read = true);
    updateNotificationBadge();
    
    const dropdown = document.getElementById('notificationDropdown');
    if (dropdown) {
      dropdown.remove();
    }
    
    showToast('已標記全部為已讀', 'success');
  } catch (error) {
    console.error('標記全部已讀失敗:', error);
    showToast('操作失敗', 'error');
  }
}

// 開始輪詢通知
function startNotificationPolling() {
  if (notificationPollingInterval) {
    clearInterval(notificationPollingInterval);
  }
  
  notificationPollingInterval = setInterval(() => {
    loadNotifications();
  }, 30000); // 每30秒檢查一次
}

// 停止輪詢通知
function stopNotificationPolling() {
  if (notificationPollingInterval) {
    clearInterval(notificationPollingInterval);
    notificationPollingInterval = null;
  }
}

// 發送推播通知
async function sendPushNotification(title, message, data = {}) {
  if (!('Notification' in window)) {
    console.log('此瀏覽器不支援推播通知');
    return;
  }
  
  if (Notification.permission === 'granted') {
    const notification = new Notification(title, {
      body: message,
      icon: '/icon-192x192.png',
      badge: '/icon-192x192.png',
      data: data,
      tag: 'stroke-support-notification'
    });
    
    notification.onclick = function(event) {
      event.preventDefault();
      window.focus();
      if (data.url) {
        navigateTo(data.url);
      }
      notification.close();
    };
  }
}

// 訂閱推播通知
async function subscribeToPush() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
    console.log('此瀏覽器不支援推播通知');
    return;
  }
  
  try {
    const permission = await Notification.requestPermission();
    
    if (permission !== 'granted') {
      console.log('使用者拒絕推播通知');
      return;
    }
    
    const registration = await navigator.serviceWorker.ready;
    
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
    });
    
    // 將訂閱資訊傳送到伺服器
    await callServerFunction('savePushSubscription', {
      userId: currentUser.id,
      subscription: JSON.stringify(subscription)
    });
    
    localStorage.setItem('pushSubscribed', 'true');
    showToast('推播通知已開啟', 'success');
    
  } catch (error) {
    console.error('訂閱推播通知失敗:', error);
  }
}

// 取消訂閱推播通知
async function unsubscribeFromPush() {
  try {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.getSubscription();
    
    if (subscription) {
      await subscription.unsubscribe();
      
      await callServerFunction('removePushSubscription', {
        userId: currentUser.id
      });
      
      localStorage.removeItem('pushSubscribed');
      showToast('推播通知已關閉', 'success');
    }
  } catch (error) {
    console.error('取消訂閱失敗:', error);
  }
}

// 輔助函數：轉換 VAPID Key
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding)
    .replace(/\-/g, '+')
    .replace(/_/g, '/');
  
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

// 獲取通知圖示
function getNotificationIcon(type) {
  const icons = {
    activity: 'calendar-check',
    message: 'comment',
    system: 'info-circle',
    reminder: 'bell',
    achievement: 'trophy'
  };
  return icons[type] || 'bell';
}

// 獲取通知顏色
function getNotificationColor(type) {
  const colors = {
    activity: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    message: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
    system: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
    reminder: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
    achievement: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
  };
  return colors[type] || colors.system;
}



// ==================== QRCODE.JS - QR Code 功能 ====================

let qrScanner = null;
let videoStream = null;

// 創建 QR 掃描器介面
function createQRScannerInterface() {
  return `
    <div class="container">
      <div class="qr-scanner-page">
        <div class="page-header">
          <button class="btn btn-secondary" onclick="history.back()">
            <i class="fas fa-arrow-left"></i> 返回
          </button>
          <h1><i class="fas fa-qrcode"></i> QR Code 簽到</h1>
        </div>
        
        <div class="qr-scanner-container">
          <div class="scanner-video-container">
            <video id="qrVideo" autoplay playsinline></video>
            <div class="scanner-overlay">
              <div class="scanner-frame"></div>
            </div>
          </div>
          
          <div class="scanner-controls">
            <button class="btn btn-primary btn-lg" onclick="startQRScanner()">
              <i class="fas fa-camera"></i> 開始掃描
            </button>
            <button class="btn btn-secondary btn-lg" onclick="stopQRScanner()">
              <i class="fas fa-stop"></i> 停止掃描
            </button>
          </div>
          
          <div class="scanner-result" id="scannerResult" style="display: none;">
            <div class="result-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <h3>掃描成功！</h3>
            <p id="scannerResultText"></p>
          </div>
          
          <div class="scanner-tips">
            <h4><i class="fas fa-lightbulb"></i> 使用提示</h4>
            <ul>
              <li>將 QR Code 對準掃描框</li>
              <li>保持適當距離，確保 QR Code 清晰可見</li>
              <li>掃描成功後會自動完成簽到</li>
            </ul>
          </div>
        </div>
        
        <div class="qr-generator-section">
          <h2><i class="fas fa-qrcode"></i> 產生 QR Code</h2>
          <p>為活動產生簽到用的 QR Code</p>
          
          <div class="form-group">
            <label>選擇活動</label>
            <select id="activitySelect" class="form-control">
              <option value="">載入中...</option>
            </select>
          </div>
          
          <button class="btn btn-primary" onclick="generateActivityQRCode()">
            <i class="fas fa-qrcode"></i> 產生 QR Code
          </button>
          
          <div id="qrCodeDisplay" style="display: none; margin-top: 2rem; text-align: center;">
            <div id="qrCodeCanvas"></div>
            <button class="btn btn-secondary mt-2" onclick="downloadQRCode()">
              <i class="fas fa-download"></i> 下載 QR Code
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
}

// 啟動 QR 掃描器
async function startQRScanner() {
  try {
    const video = document.getElementById('qrVideo');
    
    // 請求相機權限
    videoStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment' }
    });
    
    video.srcObject = videoStream;
    video.play();
    
    // 開始掃描
    scanQRCode();
    
  } catch (error) {
    console.error('啟動相機失敗:', error);
    showToast('無法啟動相機，請檢查權限設定', 'error');
  }
}

// 停止 QR 掃描器
function stopQRScanner() {
  if (videoStream) {
    videoStream.getTracks().forEach(track => track.stop());
    videoStream = null;
  }
  
  const video = document.getElementById('qrVideo');
  if (video) {
    video.srcObject = null;
  }
  
  if (qrScanner) {
    clearInterval(qrScanner);
    qrScanner = null;
  }
}

// 掃描 QR Code
function scanQRCode() {
  const video = document.getElementById('qrVideo');
  const canvas = document.createElement('canvas');
  const context = canvas.getContext('2d');
  
  qrScanner = setInterval(() => {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      
      if (code) {
        handleQRCodeScanned(code.data);
      }
    }
  }, 300);
}

// 處理掃描到的 QR Code
async function handleQRCodeScanned(data) {
  stopQRScanner();
  
  try {
    // 解析 QR Code 資料
    const qrData = JSON.parse(data);
    
    if (qrData.type === 'activity_checkin') {
      // 活動簽到
      await processActivityCheckIn(qrData.activityId);
    } else {
      showToast('無效的 QR Code', 'error');
    }
  } catch (error) {
    console.error('處理 QR Code 失敗:', error);
    showToast('QR Code 格式錯誤', 'error');
  }
}

// 處理活動簽到
async function processActivityCheckIn(activityId) {
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('checkInActivity', {
      activityId: activityId,
      memberId: currentUser.id,
      memberName: currentUser.name,
      checkInTime: new Date().toISOString()
    });
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      showScannerResult('簽到成功！', result.activity.name);
      showToast('簽到成功！', 'success');
      
      // 發送通知
      sendPushNotification(
        '簽到成功',
        `您已成功簽到：${result.activity.name}`,
        { url: 'activity-detail', activityId: activityId }
      );
    } else {
      showToast('簽到失敗：' + result.error, 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 顯示掃描結果
function showScannerResult(title, message) {
  const resultDiv = document.getElementById('scannerResult');
  const resultText = document.getElementById('scannerResultText');
  
  resultText.textContent = message;
  resultDiv.style.display = 'block';
  
  setTimeout(() => {
    resultDiv.style.display = 'none';
  }, 5000);
}

// 載入活動列表（用於產生 QR Code）
async function loadActivitiesForQR() {
  try {
    const result = await callServerFunction('getUpcomingActivities', {});
    
    const select = document.getElementById('activitySelect');
    
    if (result.success && result.activities.length > 0) {
      select.innerHTML = '<option value="">請選擇活動</option>' +
        result.activities.map(activity => `
          <option value="${activity['活動ID']}">${activity['活動名稱']} - ${formatDate(activity['開始時間'])}</option>
        `).join('');
    } else {
      select.innerHTML = '<option value="">目前沒有活動</option>';
    }
  } catch (error) {
    console.error('載入活動失敗:', error);
  }
}

// 產生活動 QR Code
function generateActivityQRCode() {
  const activityId = document.getElementById('activitySelect').value;
  
  if (!activityId) {
    showToast('請選擇活動', 'warning');
    return;
  }
  
  const qrData = JSON.stringify({
    type: 'activity_checkin',
    activityId: activityId,
    timestamp: new Date().toISOString()
  });
  
  const qrCodeCanvas = document.getElementById('qrCodeCanvas');
  qrCodeCanvas.innerHTML = '';
  
  new QRCode(qrCodeCanvas, {
    text: qrData,
    width: 300,
    height: 300,
    colorDark: '#000000',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.H
  });
  
  document.getElementById('qrCodeDisplay').style.display = 'block';
  showToast('QR Code 已產生', 'success');
}

// 下載 QR Code
function downloadQRCode() {
  const canvas = document.querySelector('#qrCodeCanvas canvas');
  if (!canvas) {
    showToast('請先產生 QR Code', 'warning');
    return;
  }
  
  const activitySelect = document.getElementById('activitySelect');
  const activityName = activitySelect.options[activitySelect.selectedIndex].text;
  
  canvas.toBlob(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `QRCode_${activityName}_${Date.now()}.png`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('QR Code 已下載', 'success');
  });
}

// 頁面載入時初始化
if (currentPage === 'qr-scanner') {
  setTimeout(() => {
    loadActivitiesForQR();
  }, 100);
}



// ==================== REPORTS.JS - 報表系統 ====================

// 創建報表頁面
function createReportsPage() {
  return `
    <div class="container">
      <div class="page-header">
        <h1><i class="fas fa-file-alt"></i> 報表中心</h1>
        <button class="btn btn-primary" onclick="showCustomReportModal()">
          <i class="fas fa-plus"></i> 自訂報表
        </button>
      </div>
      
      <!-- 報表類型選擇 -->
      <div class="report-types-grid">
        <div class="report-type-card" onclick="generateReport('member')">
          <div class="report-type-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="fas fa-users"></i>
          </div>
          <h3>會員報表</h3>
          <p>會員統計、成長趨勢、活躍度分析</p>
        </div>
        
        <div class="report-type-card" onclick="generateReport('activity')">
          <div class="report-type-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <i class="fas fa-calendar-alt"></i>
          </div>
          <h3>活動報表</h3>
          <p>活動統計、參與率、滿意度分析</p>
        </div>
        
        <div class="report-type-card" onclick="generateReport('attendance')">
          <div class="report-type-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <i class="fas fa-user-check"></i>
          </div>
          <h3>出席報表</h3>
          <p>出席統計、簽到記錄、缺席分析</p>
        </div>
        
        <div class="report-type-card" onclick="generateReport('financial')">
          <div class="report-type-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <i class="fas fa-dollar-sign"></i>
          </div>
          <h3>財務報表</h3>
          <p>收支統計、預算執行、經費分析</p>
        </div>
      </div>
      
      <!-- 快速報表 -->
      <section class="section">
        <div class="section-header">
          <h2><i class="fas fa-bolt"></i> 快速報表</h2>
        </div>
        
        <div class="quick-reports-grid">
          <div class="quick-report-item" onclick="generateQuickReport('monthly')">
            <i class="fas fa-calendar-alt"></i>
            <span>本月摘要</span>
          </div>
          
          <div class="quick-report-item" onclick="generateQuickReport('quarterly')">
            <i class="fas fa-chart-line"></i>
            <span>季度報告</span>
          </div>
          
          <div class="quick-report-item" onclick="generateQuickReport('annual')">
            <i class="fas fa-file-pdf"></i>
            <span>年度報告</span>
          </div>
          
          <div class="quick-report-item" onclick="generateQuickReport('custom')">
            <i class="fas fa-sliders-h"></i>
            <span>自訂期間</span>
          </div>
        </div>
      </section>
      
      <!-- 報表歷史 -->
      <section class="section">
        <div class="section-header">
          <h2><i class="fas fa-history"></i> 報表歷史</h2>
        </div>
        
        <div class="table-container">
          <table id="reportHistoryTable">
            <thead>
              <tr>
                <th>報表名稱</th>
                <th>類型</th>
                <th>產生時間</th>
                <th>產生者</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="reportHistoryBody">
              <tr><td colspan="5" class="loading">載入中...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  `;
}

// 產生報表
async function generateReport(type) {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'reportConfigModal';
  
  modal.innerHTML = `
    <div class="modal-content">
      <button class="close-modal" onclick="closeModal('reportConfigModal')">
        <i class="fas fa-times"></i>
      </button>
      
      <div class="modal-header">
        <h2><i class="fas fa-file-alt"></i> 產生${getReportTypeName(type)}</h2>
      </div>
      
      <div class="modal-body">
        <form id="reportConfigForm" onsubmit="handleGenerateReport(event, '${type}')">
          <div class="form-group">
            <label>報表期間 *</label>
            <div class="form-row">
              <input type="date" name="startDate" class="form-control" required>
              <span style="padding: 0.75rem;">至</span>
              <input type="date" name="endDate" class="form-control" required>
            </div>
          </div>
          
          <div class="form-group">
            <label>報表格式 *</label>
            <select name="format" class="form-control" required>
              <option value="pdf">PDF</option>
              <option value="xlsx">Excel</option>
              <option value="csv">CSV</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>包含圖表</label>
            <label class="checkbox-label">
              <input type="checkbox" name="includeCharts" checked>
              <span>在報表中包含統計圖表</span>
            </label>
          </div>
          
          <div class="form-group">
            <label>報表名稱</label>
            <input type="text" name="reportName" class="form-control" 
                   placeholder="留空則自動產生">
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('reportConfigModal')">取消</button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-file-export"></i> 產生報表
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// 處理產生報表
async function handleGenerateReport(event, type) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const reportConfig = {
    type: type,
    startDate: formData.get('startDate'),
    endDate: formData.get('endDate'),
    format: formData.get('format'),
    includeCharts: formData.get('includeCharts') === 'on',
    reportName: formData.get('reportName') || `${getReportTypeName(type)}_${Date.now()}`,
    generatedBy: currentUser.name
  };
  
  closeModal('reportConfigModal');
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('generateReport', reportConfig);
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      showToast('報表產生成功！', 'success');
      
      // 開啟下載連結
      window.open(result.downloadUrl, '_blank');
      
      // 重新載入報表歷史
      loadReportHistory();
    } else {
      showToast('產生報表失敗：' + result.error, 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 產生快速報表
async function generateQuickReport(period) {
  let startDate, endDate;
  const today = new Date();
  
  switch(period) {
    case 'monthly':
      startDate = new Date(today.getFullYear(), today.getMonth(), 1);
      endDate = today;
      break;
    case 'quarterly':
      const quarter = Math.floor(today.getMonth() / 3);
      startDate = new Date(today.getFullYear(), quarter * 3, 1);
      endDate = today;
      break;
    case 'annual':
      startDate = new Date(today.getFullYear(), 0, 1);
      endDate = today;
      break;
    case 'custom':
      generateReport('custom');
      return;
  }
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('generateQuickReport', {
      period: period,
      startDate: startDate.toISOString(),
      endDate: endDate.toISOString(),
      format: 'pdf'
    });
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      window.open(result.downloadUrl, '_blank');
      showToast('報表已產生', 'success');
    } else {
      showToast('產生報表失敗', 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 載入報表歷史
async function loadReportHistory() {
  try {
    const result = await callServerFunction('getReportHistory', {
      limit: 20
    });
    
    const tbody = document.getElementById('reportHistoryBody');
    
    if (result.success && result.reports.length > 0) {
      tbody.innerHTML = result.reports.map(report => `
        <tr>
          <td>${report.name}</td>
          <td><span class="badge">${getReportTypeName(report.type)}</span></td>
          <td>${formatDateTime(report.generatedAt)}</td>
          <td>${report.generatedBy}</td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-sm btn-primary" onclick="downloadReport('${report.id}')" title="下載">
                <i class="fas fa-download"></i>
              </button>
              <button class="btn btn-sm btn-secondary" onclick="viewReport('${report.id}')" title="預覽">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteReport('${report.id}')" title="刪除">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="5" class="empty-state">目前沒有報表記錄</td></tr>';
    }
  } catch (error) {
    console.error('載入報表歷史失敗:', error);
  }
}

// 下載報表
async function downloadReport(reportId) {
  try {
    const result = await callServerFunction('getReportDownloadUrl', { reportId });
    
    if (result.success) {
      window.open(result.downloadUrl, '_blank');
    } else {
      showToast('無法下載報表', 'error');
    }
  } catch (error) {
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 查看報表
function viewReport(reportId) {
  downloadReport(reportId);
}

// 刪除報表
async function deleteReport(reportId) {
  if (!confirm('確定要刪除此報表嗎？')) {
    return;
  }
  
  try {
    const result = await callServerFunction('deleteReport', { reportId });
    
    if (result.success) {
      showToast('報表已刪除', 'success');
      loadReportHistory();
    } else {
      showToast('刪除失敗', 'error');
    }
  } catch (error) {
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 獲取報表類型名稱
function getReportTypeName(type) {
  const names = {
    member: '會員報表',
    activity: '活動報表',
    attendance: '出席報表',
    financial: '財務報表',
    custom: '自訂報表'
  };
  return names[type] || '報表';
}

// 顯示自訂報表對話框
function showCustomReportModal() {
  alert('自訂報表功能開發中...');
}

// 頁面載入時初始化
if (currentPage === 'reports') {
  setTimeout(() => {
    loadReportHistory();
  }, 100);
}



// ==================== SETTINGS.JS - 設定頁面 ====================

// 創建設定頁面
function createSettingsPage() {
  return `
    <div class="container">
      <div class="page-header">
        <h1><i class="fas fa-cog"></i> 系統設定</h1>
      </div>
      
      <div class="settings-container">
        <!-- 側邊選單 -->
        <div class="settings-sidebar">
          <div class="settings-menu">
            <a href="#" class="settings-menu-item active" onclick="showSettingsTab('general'); return false;">
              <i class="fas fa-sliders-h"></i>
              <span>一般設定</span>
            </a>
            <a href="#" class="settings-menu-item" onclick="showSettingsTab('account'); return false;">
              <i class="fas fa-user-cog"></i>
              <span>帳號設定</span>
            </a>
            <a href="#" class="settings-menu-item" onclick="showSettingsTab('notifications'); return false;">
              <i class="fas fa-bell"></i>
              <span>通知設定</span>
            </a>
            <a href="#" class="settings-menu-item" onclick="showSettingsTab('privacy'); return false;">
              <i class="fas fa-shield-alt"></i>
              <span>隱私設定</span>
            </a>
            <a href="#" class="settings-menu-item" onclick="showSettingsTab('appearance'); return false;">
              <i class="fas fa-palette"></i>
              <span>外觀設定</span>
            </a>
            ${PermissionManager.hasPermission('manage_system') ? `
              <a href="#" class="settings-menu-item" onclick="showSettingsTab('system'); return false;">
                <i class="fas fa-server"></i>
                <span>系統管理</span>
              </a>
            ` : ''}
          </div>
        </div>
        
        <!-- 設定內容 -->
        <div class="settings-content">
          <div id="settingsTabContent">
            ${createGeneralSettings()}
          </div>
        </div>
      </div>
    </div>
  `;
}

// 創建一般設定
function createGeneralSettings() {
  return `
    <div class="settings-section">
      <h2>一般設定</h2>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>語言</h4>
          <p>選擇系統顯示語言</p>
        </div>
        <div class="setting-control">
          <select id="languageSetting" class="form-control" onchange="changeLanguage()">
            <option value="zh-TW" selected>繁體中文</option>
            <option value="zh-CN">簡體中文</option>
            <option value="en">English</option>
          </select>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>時區</h4>
          <p>設定顯示時間的時區</p>
        </div>
        <div class="setting-control">
          <select id="timezoneSetting" class="form-control">
            <option value="Asia/Taipei" selected>台北 (GMT+8)</option>
            <option value="Asia/Shanghai">上海 (GMT+8)</option>
            <option value="Asia/Hong_Kong">香港 (GMT+8)</option>
          </select>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>日期格式</h4>
          <p>選擇日期顯示格式</p>
        </div>
        <div class="setting-control">
          <select id="dateFormatSetting" class="form-control">
            <option value="YYYY/MM/DD" selected>2024/01/15</option>
            <option value="DD/MM/YYYY">15/01/2024</option>
            <option value="MM/DD/YYYY">01/15/2024</option>
          </select>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>自動儲存</h4>
          <p>編輯表單時自動儲存草稿</p>
        </div>
        <div class="setting-control">
          <label class="switch">
            <input type="checkbox" id="autoSaveSetting" checked>
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="saveGeneralSettings()">
        <i class="fas fa-save"></i> 儲存設定
      </button>
    </div>
  `;
}

// 創建帳號設定
function createAccountSettings() {
  return `
    <div class="settings-section">
      <h2>帳號設定</h2>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>個人資料</h4>
          <p>更新您的個人資料</p>
        </div>
        <div class="setting-control">
          <button class="btn btn-secondary" onclick="navigateTo('profile')">
            <i class="fas fa-user-edit"></i> 編輯資料
          </button>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>變更密碼</h4>
          <p>定期更換密碼以保護帳號安全</p>
        </div>
        <div class="setting-control">
          <button class="btn btn-secondary" onclick="showChangePasswordModal()">
            <i class="fas fa-key"></i> 變更密碼
          </button>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>電子郵件</h4>
          <p>更新您的電子郵件地址</p>
        </div>
        <div class="setting-control">
          <input type="email" id="emailSetting" class="form-control" value="${currentUser.email}">
          <button class="btn btn-primary btn-sm mt-2" onclick="updateEmail()">更新</button>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>兩步驟驗證</h4>
          <p>增強帳號安全性</p>
        </div>
        <div class="setting-control">
          <label class="switch">
            <input type="checkbox" id="twoFactorSetting">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="setting-item danger">
        <div class="setting-info">
          <h4>刪除帳號</h4>
          <p>永久刪除您的帳號及所有資料</p>
        </div>
        <div class="setting-control">
          <button class="btn btn-danger" onclick="deleteAccount()">
            <i class="fas fa-trash"></i> 刪除帳號
          </button>
        </div>
      </div>
    </div>
  `;
}

// 創建通知設定
function createNotificationSettings() {
  const isPushEnabled = localStorage.getItem('pushSubscribed') === 'true';
  
  return `
    <div class="settings-section">
      <h2>通知設定</h2>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>推播通知</h4>
          <p>接收即時推播通知</p>
        </div>
        <div class="setting-control">
          <label class="switch">
            <input type="checkbox" id="pushNotificationSetting" ${isPushEnabled ? 'checked' : ''} 
                   onchange="togglePushNotifications()">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>電子郵件通知</h4>
          <p>透過電子郵件接收通知</p>
        </div>
        <div class="setting-control">
          <label class="switch">
            <input type="checkbox" id="emailNotificationSetting" checked>
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>活動提醒</h4>
          <p>在活動開始前提醒您</p>
        </div>
        <div class="setting-control">
          <select id="activityReminderSetting" class="form-control">
            <option value="0">不提醒</option>
            <option value="30" selected>30分鐘前</option>
            <option value="60">1小時前</option>
            <option value="1440">1天前</option>
          </select>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>新活動通知</h4>
          <p>有新活動時通知我</p>
        </div>
        <div class="setting-control">
          <label class="switch">
            <input type="checkbox" id="newActivityNotificationSetting" checked>
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>訊息通知</h4>
          <p>收到新訊息時通知我</p>
        </div>
        <div class="setting-control">
          <label class="switch">
            <input type="checkbox" id="messageNotificationSetting" checked>
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>系統公告</h4>
          <p>接收系統重要公告</p>
        </div>
        <div class="setting-control">
          <label class="switch">
            <input type="checkbox" id="systemNotificationSetting" checked>
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="saveNotificationSettings()">
        <i class="fas fa-save"></i> 儲存設定
      </button>
    </div>
  `;
}

// 創建隱私設定
function createPrivacySettings() {
  return `
    <div class="settings-section">
      <h2>隱私設定</h2>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>個人資料可見性</h4>
          <p>控制誰可以看到您的個人資料</p>
        </div>
        <div class="setting-control">
          <select id="profileVisibilitySetting" class="form-control">
            <option value="public">所有人</option>
            <option value="members" selected>僅會員</option>
            <option value="private">僅自己</option>
          </select>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>顯示參與活動</h4>
          <p>讓其他會員看到您參與的活動</p>
        </div>
        <div class="setting-control">
          <label class="switch">
            <input type="checkbox" id="showActivitiesSetting" checked>
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>允許訊息</h4>
          <p>允許其他會員傳送訊息給您</p>
        </div>
        <div class="setting-control">
          <label class="switch">
            <input type="checkbox" id="allowMessagesSetting" checked>
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>資料分析</h4>
          <p>允許系統收集使用資料以改善服務</p>
        </div>
        <div class="setting-control">
          <label class="switch">
            <input type="checkbox" id="analyticsConsentSetting" checked>
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>下載我的資料</h4>
          <p>下載您在系統中的所有資料</p>
        </div>
        <div class="setting-control">
          <button class="btn btn-secondary" onclick="downloadMyData()">
            <i class="fas fa-download"></i> 下載資料
          </button>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="savePrivacySettings()">
        <i class="fas fa-save"></i> 儲存設定
      </button>
    </div>
  `;
}

// 創建外觀設定
function createAppearanceSettings() {
  return `
    <div class="settings-section">
      <h2>外觀設定</h2>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>主題模式</h4>
          <p>選擇淺色或深色主題</p>
        </div>
        <div class="setting-control">
          <select id="themeSetting" class="form-control" onchange="changeTheme()">
            <option value="light" selected>淺色模式</option>
            <option value="dark">深色模式</option>
            <option value="auto">自動切換</option>
          </select>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>主題色彩</h4>
          <p>自訂系統主題色彩</p>
        </div>
        <div class="setting-control">
          <div class="color-picker-grid">
            <div class="color-option" style="background: #667eea;" onclick="changeAccentColor('#667eea')"></div>
            <div class="color-option" style="background: #f093fb;" onclick="changeAccentColor('#f093fb')"></div>
            <div class="color-option" style="background: #4facfe;" onclick="changeAccentColor('#4facfe')"></div>
            <div class="color-option" style="background: #43e97b;" onclick="changeAccentColor('#43e97b')"></div>
            <div class="color-option" style="background: #fa709a;" onclick="changeAccentColor('#fa709a')"></div>
          </div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>字體大小</h4>
          <p>調整系統字體大小</p>
        </div>
        <div class="setting-control">
          <select id="fontSizeSetting" class="form-control" onchange="changeFontSize()">
            <option value="small">小</option>
            <option value="medium" selected>中</option>
            <option value="large">大</option>
            <option value="xlarge">特大</option>
          </select>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>動畫效果</h4>
          <p>啟用或停用介面動畫</p>
        </div>
        <div class="setting-control">
          <label class="switch">
            <input type="checkbox" id="animationSetting" checked onchange="toggleAnimations()">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>精簡模式</h4>
          <p>使用更簡潔的介面設計</p>
        </div>
        <div class="setting-control">
          <label class="switch">
            <input type="checkbox" id="compactModeSetting" onchange="toggleCompactMode()">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="saveAppearanceSettings()">
        <i class="fas fa-save"></i> 儲存設定
      </button>
    </div>
  `;
}

// 創建系統管理設定
function createSystemSettings() {
  return `
    <div class="settings-section">
      <h2>系統管理</h2>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>權限管理</h4>
          <p>管理使用者角色與權限</p>
        </div>
        <div class="setting-control">
          <button class="btn btn-secondary" onclick="navigateTo('permissions')">
            <i class="fas fa-user-shield"></i> 管理權限
          </button>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>資料備份</h4>
          <p>備份系統資料</p>
        </div>
        <div class="setting-control">
          <button class="btn btn-secondary" onclick="backupData()">
            <i class="fas fa-database"></i> 立即備份
          </button>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>系統日誌</h4>
          <p>查看系統操作記錄</p>
        </div>
        <div class="setting-control">
          <button class="btn btn-secondary" onclick="viewSystemLogs()">
            <i class="fas fa-file-alt"></i> 查看日誌
          </button>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>快取管理</h4>
          <p>清除系統快取以釋放空間</p>
        </div>
        <div class="setting-control">
          <button class="btn btn-secondary" onclick="clearSystemCache()">
            <i class="fas fa-broom"></i> 清除快取
          </button>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>系統維護模式</h4>
          <p>啟用維護模式以進行系統更新</p>
        </div>
        <div class="setting-control">
          <label class="switch">
            <input type="checkbox" id="maintenanceModeSetting">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-info">
          <h4>系統資訊</h4>
          <p>版本：v1.0.0<br>最後更新：2024-01-15</p>
        </div>
        <div class="setting-control">
          <button class="btn btn-secondary" onclick="checkForUpdates()">
            <i class="fas fa-sync-alt"></i> 檢查更新
          </button>
        </div>
      </div>
    </div>
  `;
}

// 切換設定分頁
function showSettingsTab(tab) {
  // 更新選單狀態
  document.querySelectorAll('.settings-menu-item').forEach(item => {
    item.classList.remove('active');
  });
  event.target.closest('.settings-menu-item').classList.add('active');
  
  // 更新內容
  const content = document.getElementById('settingsTabContent');
  
  switch(tab) {
    case 'general':
      content.innerHTML = createGeneralSettings();
      break;
    case 'account':
      content.innerHTML = createAccountSettings();
      break;
    case 'notifications':
      content.innerHTML = createNotificationSettings();
      break;
    case 'privacy':
      content.innerHTML = createPrivacySettings();
      break;
    case 'appearance':
      content.innerHTML = createAppearanceSettings();
      break;
    case 'system':
      content.innerHTML = createSystemSettings();
      break;
  }
}

// 儲存一般設定
function saveGeneralSettings() {
  const settings = {
    language: document.getElementById('languageSetting').value,
    timezone: document.getElementById('timezoneSetting').value,
    dateFormat: document.getElementById('dateFormatSetting').value,
    autoSave: document.getElementById('autoSaveSetting').checked
  };
  
  localStorage.setItem('generalSettings', JSON.stringify(settings));
  showToast('設定已儲存', 'success');
}

// 儲存通知設定
function saveNotificationSettings() {
  const settings = {
    email: document.getElementById('emailNotificationSetting').checked,
    activityReminder: document.getElementById('activityReminderSetting').value,
    newActivity: document.getElementById('newActivityNotificationSetting').checked,
    message: document.getElementById('messageNotificationSetting').checked,
    system: document.getElementById('systemNotificationSetting').checked
  };
  
  localStorage.setItem('notificationSettings', JSON.stringify(settings));
  showToast('設定已儲存', 'success');
}

// 儲存隱私設定
function savePrivacySettings() {
  const settings = {
    profileVisibility: document.getElementById('profileVisibilitySetting').value,
    showActivities: document.getElementById('showActivitiesSetting').checked,
    allowMessages: document.getElementById('allowMessagesSetting').checked,
    analyticsConsent: document.getElementById('analyticsConsentSetting').checked
  };
  
  localStorage.setItem('privacySettings', JSON.stringify(settings));
  showToast('設定已儲存', 'success');
}

// 儲存外觀設定
function saveAppearanceSettings() {
  showToast('設定已儲存', 'success');
}

// 切換推播通知
function togglePushNotifications() {
  const enabled = document.getElementById('pushNotificationSetting').checked;
  
  if (enabled) {
    subscribeToPush();
  } else {
    unsubscribeFromPush();
  }
}

// 變更語言
function changeLanguage() {
  const language = document.getElementById('languageSetting').value;
  // 實作語言切換邏輯
  showToast('語言設定已更新', 'success');
}

// 變更主題
function changeTheme() {
  const theme = document.getElementById('themeSetting').value;
  document.body.className = theme === 'dark' ? 'dark-theme' : '';
  localStorage.setItem('theme', theme);
}

// 變更主題色彩
function changeAccentColor(color) {
  document.documentElement.style.setProperty('--primary-color', color);
  localStorage.setItem('accentColor', color);
  showToast('主題色彩已更新', 'success');
}

// 變更字體大小
function changeFontSize() {
  const size = document.getElementById('fontSizeSetting').value;
  document.body.setAttribute('data-font-size', size);
  localStorage.setItem('fontSize', size);
}

// 切換動畫
function toggleAnimations() {
  const enabled = document.getElementById('animationSetting').checked;
  document.body.classList.toggle('no-animations', !enabled);
  localStorage.setItem('animations', enabled);
}

// 切換精簡模式
function toggleCompactMode() {
  const enabled = document.getElementById('compactModeSetting').checked;
  document.body.classList.toggle('compact-mode', enabled);
  localStorage.setItem('compactMode', enabled);
}

// 顯示變更密碼對話框
function showChangePasswordModal() {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'changePasswordModal';
  
  modal.innerHTML = `
    <div class="modal-content">
      <button class="close-modal" onclick="closeModal('changePasswordModal')">
        <i class="fas fa-times"></i>
      </button>
      
      <div class="modal-header">
        <h2><i class="fas fa-key"></i> 變更密碼</h2>
      </div>
      
      <div class="modal-body">
        <form id="changePasswordForm" onsubmit="handleChangePassword(event)">
          <div class="form-group">
            <label>目前密碼 *</label>
            <input type="password" name="currentPassword" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label>新密碼 *</label>
            <input type="password" name="newPassword" class="form-control" minlength="6" required>
          </div>
          
          <div class="form-group">
            <label>確認新密碼 *</label>
            <input type="password" name="confirmPassword" class="form-control" minlength="6" required>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('changePasswordModal')">取消</button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-check"></i> 確認變更
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// 處理變更密碼
async function handleChangePassword(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const newPassword = formData.get('newPassword');
  const confirmPassword = formData.get('confirmPassword');
  
  if (newPassword !== confirmPassword) {
    showToast('新密碼與確認密碼不一致', 'error');
    return;
  }
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('changePassword', {
      userId: currentUser.id,
      currentPassword: formData.get('currentPassword'),
      newPassword: newPassword
    });
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      showToast('密碼已更新', 'success');
      closeModal('changePasswordModal');
    } else {
      showToast('變更失敗：' + result.error, 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 更新電子郵件
async function updateEmail() {
  const newEmail = document.getElementById('emailSetting').value;
  
  if (!newEmail || !validateEmail(newEmail)) {
    showToast('請輸入有效的電子郵件地址', 'error');
    return;
  }
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('updateEmail', {
      userId: currentUser.id,
      newEmail: newEmail
    });
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      currentUser.email = newEmail;
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      showToast('電子郵件已更新', 'success');
    } else {
      showToast('更新失敗：' + result.error, 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 刪除帳號
async function deleteAccount() {
  const confirmation = prompt('此操作無法復原。請輸入「刪除我的帳號」以確認：');
  
  if (confirmation !== '刪除我的帳號') {
    return;
  }
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('deleteAccount', {
      userId: currentUser.id
    });
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      showToast('帳號已刪除', 'success');
      logout();
    } else {
      showToast('刪除失敗：' + result.error, 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 下載我的資料
async function downloadMyData() {
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('exportUserData', {
      userId: currentUser.id
    });
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      window.open(result.downloadUrl, '_blank');
      showToast('資料已準備下載', 'success');
    } else {
      showToast('匯出失敗', 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 備份資料
async function backupData() {
  if (!confirm('確定要立即備份系統資料嗎？')) {
    return;
  }
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('backupSystemData', {});
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      showToast('備份已完成', 'success');
    } else {
      showToast('備份失敗', 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 查看系統日誌
function viewSystemLogs() {
  alert('系統日誌功能開發中...');
}

// 清除系統快取
function clearSystemCache() {
  if (!confirm('確定要清除所有快取嗎？')) {
    return;
  }
  
  CacheManager.clearAll();
  showToast('快取已清除', 'success');
}

// 檢查更新
async function checkForUpdates() {
  document.getElementById('loadingOverlay').classList.add('active');
  
  setTimeout(() => {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統已是最新版本', 'success');
  }, 1500);
}



// ==================== PROFILE.JS - 個人資料頁面 ====================

// 創建個人資料頁面
function createProfilePage() {
  return `
    <div class="container">
      <div class="profile-page">
        <div class="profile-header">
          <div class="profile-cover" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <button class="btn btn-secondary btn-sm" onclick="history.back()">
              <i class="fas fa-arrow-left"></i> 返回
            </button>
          </div>
          
          <div class="profile-info-header">
            <div class="profile-avatar-large">
              ${currentUser.name.charAt(0)}
              <button class="avatar-edit-btn" onclick="changeAvatar()">
                <i class="fas fa-camera"></i>
              </button>
            </div>
            
            <div class="profile-header-info">
              <h1>${currentUser.name}</h1>
              <p class="profile-id">會員編號：${currentUser.id}</p>
              <div class="profile-badges">
                <span class="badge badge-primary">
                  <i class="fas fa-star"></i> 活躍會員
                </span>
                <span class="badge badge-success">
                  <i class="fas fa-trophy"></i> 參與達人
                </span>
              </div>
            </div>
            
            <div class="profile-header-actions">
              <button class="btn btn-primary" onclick="editProfile()">
                <i class="fas fa-edit"></i> 編輯資料
              </button>
              <button class="btn btn-secondary" onclick="shareProfile()">
                <i class="fas fa-share-alt"></i> 分享
              </button>
            </div>
          </div>
        </div>
        
        <div class="profile-content">
          <!-- 統計卡片 -->
          <div class="profile-stats">
            <div class="stat-card">
              <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="fas fa-calendar-check"></i>
              </div>
              <div class="stat-content">
                <h3 id="profileActivitiesCount">0</h3>
                <p>參與活動</p>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <i class="fas fa-percentage"></i>
              </div>
              <div class="stat-content">
                <h3 id="profileAttendanceRate">0%</h3>
                <p>出席率</p>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <i class="fas fa-trophy"></i>
              </div>
              <div class="stat-content">
                <h3 id="profilePoints">0</h3>
                <p>累積積分</p>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <i class="fas fa-clock"></i>
              </div>
              <div class="stat-content">
                <h3 id="profileMemberDays">0</h3>
                <p>加入天數</p>
              </div>
            </div>
          </div>
          
          <!-- 分頁內容 -->
          <div class="profile-tabs">
            <div class="tabs-header">
              <button class="tab-btn active" onclick="showProfileTab('info')">
                <i class="fas fa-user"></i> 基本資料
              </button>
              <button class="tab-btn" onclick="showProfileTab('activities')">
                <i class="fas fa-calendar"></i> 活動記錄
              </button>
              <button class="tab-btn" onclick="showProfileTab('achievements')">
                <i class="fas fa-trophy"></i> 成就徽章
              </button>
              <button class="tab-btn" onclick="showProfileTab('timeline')">
                <i class="fas fa-stream"></i> 動態時間軸
              </button>
            </div>
            
            <div class="tabs-content" id="profileTabContent">
              ${createProfileInfoTab()}
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// 創建基本資料分頁
function createProfileInfoTab() {
  return `
    <div class="profile-info-grid">
      <div class="info-section">
        <h3><i class="fas fa-user"></i> 個人資訊</h3>
        <div class="info-items">
          <div class="info-item">
            <label>姓名</label>
            <p>${currentUser.name}</p>
          </div>
          <div class="info-item">
            <label>性別</label>
            <p>${currentUser.gender || '未設定'}</p>
          </div>
          <div class="info-item">
            <label>出生日期</label>
            <p>${currentUser.birthDate ? formatDate(currentUser.birthDate) : '未設定'}</p>
          </div>
          <div class="info-item">
            <label>年齡</label>
            <p>${currentUser.birthDate ? calculateAge(currentUser.birthDate) + ' 歲' : '未設定'}</p>
          </div>
        </div>
      </div>
      
      <div class="info-section">
        <h3><i class="fas fa-address-card"></i> 聯絡資訊</h3>
        <div class="info-items">
          <div class="info-item">
            <label>電話</label>
            <p>${currentUser.phone || '未設定'}</p>
          </div>
          <div class="info-item">
            <label>電子郵件</label>
            <p>${currentUser.email || '未設定'}</p>
          </div>
          <div class="info-item full-width">
            <label>地址</label>
            <p>${currentUser.address || '未設定'}</p>
          </div>
        </div>
      </div>
      
      <div class="info-section">
        <h3><i class="fas fa-heartbeat"></i> 健康資訊</h3>
        <div class="info-items">
          <div class="info-item">
            <label>緊急聯絡人</label>
            <p>${currentUser.emergencyContact || '未設定'}</p>
          </div>
          <div class="info-item">
            <label>緊急聯絡電話</label>
            <p>${currentUser.emergencyPhone || '未設定'}</p>
          </div>
          <div class="info-item full-width">
            <label>特殊需求</label>
            <p>${currentUser.specialNeeds || '無'}</p>
          </div>
        </div>
      </div>
      
      <div class="info-section">
        <h3><i class="fas fa-info-circle"></i> 其他資訊</h3>
        <div class="info-items">
          <div class="info-item">
            <label>加入日期</label>
            <p>${currentUser.joinDate ? formatDate(currentUser.joinDate) : '未知'}</p>
          </div>
          <div class="info-item">
            <label>會員狀態</label>
            <p><span class="status-badge active">${currentUser.status || '啟用'}</span></p>
          </div>
          <div class="info-item full-width">
            <label>自我介紹</label>
            <p>${currentUser.bio || '這個人很懶，什麼都沒留下...'}</p>
          </div>
        </div>
      </div>
    </div>
  `;
}

// 創建活動記錄分頁
function createProfileActivitiesTab() {
  return `
    <div class="profile-activities">
      <div class="activities-filter">
        <select id="activityFilterType" class="form-control" onchange="filterProfileActivities()">
          <option value="">所有類型</option>
          <option value="健康講座">健康講座</option>
          <option value="復健課程">復健課程</option>
          <option value="社交活動">社交活動</option>
          <option value="志工服務">志工服務</option>
        </select>
        
        <select id="activityFilterStatus" class="form-control" onchange="filterProfileActivities()">
          <option value="">所有狀態</option>
          <option value="completed">已完成</option>
          <option value="upcoming">即將參加</option>
          <option value="cancelled">已取消</option>
        </select>
      </div>
      
      <div id="profileActivitiesList">
        <div class="loading">載入中...</div>
      </div>
    </div>
  `;
}

// 創建成就徽章分頁
function createProfileAchievementsTab() {
  return `
    <div class="profile-achievements">
      <div class="achievements-summary">
        <h3>已獲得 <span id="achievementCount">0</span> 個成就</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="achievementProgress" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="achievements-grid" id="achievementsList">
        <div class="loading">載入中...</div>
      </div>
    </div>
  `;
}

// 創建動態時間軸分頁
function createProfileTimelineTab() {
  return `
    <div class="profile-timeline">
      <div id="timelineList">
        <div class="loading">載入中...</div>
      </div>
    </div>
  `;
}

// 切換個人資料分頁
function showProfileTab(tab) {
  // 更新分頁按鈕狀態
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // 更新內容
  const content = document.getElementById('profileTabContent');
  
  switch(tab) {
    case 'info':
      content.innerHTML = createProfileInfoTab();
      break;
    case 'activities':
      content.innerHTML = createProfileActivitiesTab();
      loadProfileActivities();
      break;
    case 'achievements':
      content.innerHTML = createProfileAchievementsTab();
      loadProfileAchievements();
      break;
    case 'timeline':
      content.innerHTML = createProfileTimelineTab();
      loadProfileTimeline();
      break;
  }
}

// 載入個人統計資料
async function loadProfileStats() {
  try {
    const result = await callServerFunction('getProfileStats', {
      userId: currentUser.id
    });
    
    if (result.success) {
      animateNumber('profileActivitiesCount', result.stats.activitiesCount);
      animateNumber('profileAttendanceRate', result.stats.attendanceRate, '%');
      animateNumber('profilePoints', result.stats.points);
      animateNumber('profileMemberDays', result.stats.memberDays);
    }
  } catch (error) {
    console.error('載入統計資料失敗:', error);
  }
}

// 載入個人活動記錄
async function loadProfileActivities() {
  try {
    const result = await callServerFunction('getUserActivities', {
      userId: currentUser.id
    });
    
    const container = document.getElementById('profileActivitiesList');
    
    if (result.success && result.activities.length > 0) {
      container.innerHTML = result.activities.map(activity => `
        <div class="activity-record-item">
          <div class="activity-record-icon" style="background: ${getActivityTypeColor(activity['活動類型'])};">
            <i class="fas fa-${getActivityIcon(activity['活動類型'])}"></i>
          </div>
          <div class="activity-record-content">
            <h4>${activity['活動名稱']}</h4>
            <p>${formatDate(activity['活動日期'])} · ${activity['活動地點']}</p>
            <div class="activity-record-meta">
              <span class="badge">${activity['活動類型']}</span>
              <span class="status-badge ${activity['出席狀態'] === '已出席' ? 'active' : 'inactive'}">
                ${activity['出席狀態']}
              </span>
            </div>
          </div>
          <button class="btn btn-sm btn-secondary" onclick="navigateTo('activity-detail', {id: '${activity['活動ID']}'})">
            <i class="fas fa-eye"></i> 查看
          </button>
        </div>
      `).join('');
    } else {
      container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar"></i><p>尚無活動記錄</p></div>';
    }
  } catch (error) {
    console.error('載入活動記錄失敗:', error);
  }
}

// 載入個人成就
async function loadProfileAchievements() {
  try {
    const result = await callServerFunction('getUserAchievements', {
      userId: currentUser.id
    });
    
    const container = document.getElementById('achievementsList');
    const countElement = document.getElementById('achievementCount');
    const progressElement = document.getElementById('achievementProgress');
    
    if (result.success) {
      const unlockedCount = result.achievements.filter(a => a.unlocked).length;
      const totalCount = result.achievements.length;
      const progress = (unlockedCount / totalCount * 100).toFixed(0);
      
      countElement.textContent = unlockedCount;
      progressElement.style.width = progress + '%';
      
      container.innerHTML = result.achievements.map(achievement => `
        <div class="achievement-card ${achievement.unlocked ? 'unlocked' : 'locked'}">
          <div class="achievement-icon">
            <i class="fas fa-${achievement.icon}"></i>
          </div>
          <h4>${achievement.name}</h4>
          <p>${achievement.description}</p>
          ${achievement.unlocked ? `
            <span class="achievement-date">
              <i class="fas fa-check"></i> ${formatDate(achievement.unlockedDate)}
            </span>
          ` : `
            <span class="achievement-locked">
              <i class="fas fa-lock"></i> 尚未解鎖
            </span>
          `}
        </div>
      `).join('');
    }
  } catch (error) {
    console.error('載入成就失敗:', error);
  }
}

// 載入動態時間軸
async function loadProfileTimeline() {
  try {
    const result = await callServerFunction('getUserTimeline', {
      userId: currentUser.id
    });
    
    const container = document.getElementById('timelineList');
    
    if (result.success && result.timeline.length > 0) {
      container.innerHTML = result.timeline.map(item => `
        <div class="timeline-item">
          <div class="timeline-marker" style="background: ${getTimelineColor(item.type)};">
            <i class="fas fa-${getTimelineIcon(item.type)}"></i>
          </div>
          <div class="timeline-content">
            <div class="timeline-header">
              <h4>${item.title}</h4>
              <span class="timeline-date">${formatRelativeTime(item.timestamp)}</span>
            </div>
            <p>${item.description}</p>
            ${item.image ? `<img src="${item.image}" alt="${item.title}" class="timeline-image">` : ''}
          </div>
        </div>
      `).join('');
    } else {
      container.innerHTML = '<div class="empty-state"><i class="fas fa-stream"></i><p>尚無動態記錄</p></div>';
    }
  } catch (error) {
    console.error('載入動態時間軸失敗:', error);
  }
}

// 編輯個人資料
function editProfile() {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'editProfileModal';
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 800px;">
      <button class="close-modal" onclick="closeModal('editProfileModal')">
        <i class="fas fa-times"></i>
      </button>
      
      <div class="modal-header">
        <h2><i class="fas fa-user-edit"></i> 編輯個人資料</h2>
      </div>
      
      <div class="modal-body">
        <form id="editProfileForm" onsubmit="handleEditProfile(event)">
          <div class="form-row">
            <div class="form-group">
              <label>姓名 *</label>
              <input type="text" name="name" class="form-control" value="${currentUser.name}" required>
            </div>
            
            <div class="form-group">
              <label>性別</label>
              <select name="gender" class="form-control">
                <option value="">請選擇</option>
                <option value="男" ${currentUser.gender === '男' ? 'selected' : ''}>男</option>
                <option value="女" ${currentUser.gender === '女' ? 'selected' : ''}>女</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label>出生日期</label>
            <input type="date" name="birthDate" class="form-control" value="${currentUser.birthDate || ''}">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>電話</label>
              <input type="tel" name="phone" class="form-control" value="${currentUser.phone || ''}">
            </div>
            
            <div class="form-group">
              <label>電子郵件</label>
              <input type="email" name="email" class="form-control" value="${currentUser.email || ''}">
            </div>
          </div>
          
          <div class="form-group">
            <label>地址</label>
            <input type="text" name="address" class="form-control" value="${currentUser.address || ''}">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>緊急聯絡人</label>
              <input type="text" name="emergencyContact" class="form-control" value="${currentUser.emergencyContact || ''}">
            </div>
            
            <div class="form-group">
              <label>緊急聯絡電話</label>
              <input type="tel" name="emergencyPhone" class="form-control" value="${currentUser.emergencyPhone || ''}">
            </div>
          </div>
          
          <div class="form-group">
            <label>特殊需求</label>
            <textarea name="specialNeeds" class="form-control" rows="3">${currentUser.specialNeeds || ''}</textarea>
          </div>
          
          <div class="form-group">
            <label>自我介紹</label>
            <textarea name="bio" class="form-control" rows="4" maxlength="200">${currentUser.bio || ''}</textarea>
            <small>最多 200 字</small>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('editProfileModal')">取消</button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> 儲存變更
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// 處理編輯個人資料
async function handleEditProfile(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const profileData = {
    userId: currentUser.id,
    name: formData.get('name'),
    gender: formData.get('gender'),
    birthDate: formData.get('birthDate'),
    phone: formData.get('phone'),
    email: formData.get('email'),
    address: formData.get('address'),
    emergencyContact: formData.get('emergencyContact'),
    emergencyPhone: formData.get('emergencyPhone'),
    specialNeeds: formData.get('specialNeeds'),
    bio: formData.get('bio')
  };
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('updateProfile', profileData);
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      // 更新本地用戶資料
      Object.assign(currentUser, profileData);
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      
      showToast('個人資料已更新', 'success');
      closeModal('editProfileModal');
      
      // 重新載入頁面
      navigateTo('profile');
    } else {
      showToast('更新失敗：' + result.error, 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 更換頭像
function changeAvatar() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    // 檢查檔案大小（最大 5MB）
    if (file.size > 5 * 1024 * 1024) {
      showToast('圖片大小不能超過 5MB', 'error');
      return;
    }
    
    document.getElementById('loadingOverlay').classList.add('active');
    
    try {
      // 轉換為 Base64
      const reader = new FileReader();
      reader.onload = async (event) => {
        const base64 = event.target.result;
        
        const result = await callServerFunction('updateAvatar', {
          userId: currentUser.id,
          avatar: base64
        });
        
        document.getElementById('loadingOverlay').classList.remove('active');
        
        if (result.success) {
          currentUser.avatar = result.avatarUrl;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          showToast('頭像已更新', 'success');
          navigateTo('profile');
        } else {
          showToast('更新失敗：' + result.error, 'error');
        }
      };
      
      reader.readAsDataURL(file);
    } catch (error) {
      document.getElementById('loadingOverlay').classList.remove('active');
      showToast('系統錯誤：' + error.message, 'error');
    }
  };
  
  input.click();
}

// 分享個人資料
function shareProfile() {
  const profileUrl = window.location.origin + '?profile=' + currentUser.id;
  
  if (navigator.share) {
    navigator.share({
      title: currentUser.name + ' 的個人資料',
      text: '查看我在帕金森病友支持系統的個人資料',
      url: profileUrl
    }).catch(err => console.log('分享失敗:', err));
  } else {
    // 複製連結
    navigator.clipboard.writeText(profileUrl).then(() => {
      showToast('連結已複製到剪貼簿', 'success');
    });
  }
}

// 篩選個人活動記錄
function filterProfileActivities() {
  // 實作篩選邏輯
  loadProfileActivities();
}

// 獲取活動類型顏色
function getActivityTypeColor(type) {
  const colors = {
    '健康講座': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    '復健課程': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
    '社交活動': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
    '志工服務': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
    '其他': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
  };
  return colors[type] || colors['其他'];
}

// 獲取時間軸圖示
function getTimelineIcon(type) {
  const icons = {
    activity: 'calendar-check',
    achievement: 'trophy',
    join: 'user-plus',
    update: 'edit',
    comment: 'comment'
  };
  return icons[type] || 'circle';
}

// 獲取時間軸顏色
function getTimelineColor(type) {
  const colors = {
    activity: '#667eea',
    achievement: '#f5576c',
    join: '#4facfe',
    update: '#43e97b',
    comment: '#fa709a'
  };
  return colors[type] || '#999';
}

// 頁面載入時初始化
if (currentPage === 'profile') {
  setTimeout(() => {
    loadProfileStats();
  }, 100);
}



// ==================== SEARCH.JS - 搜尋功能 ====================

let searchHistory = [];
let searchResults = [];

// 創建搜尋頁面
function createSearchPage() {
  return `
    <div class="container">
      <div class="search-page">
        <div class="search-header">
          <h1><i class="fas fa-search"></i> 搜尋</h1>
        </div>
        
        <div class="search-box-large">
          <i class="fas fa-search"></i>
          <input type="text" id="mainSearchInput" placeholder="搜尋活動、會員、資訊..." 
                 onkeyup="handleSearchInput(event)" autofocus>
          <button class="btn btn-primary" onclick="performSearch()">搜尋</button>
        </div>
        
        <div class="search-filters">
          <button class="filter-chip active" data-filter="all" onclick="setSearchFilter('all')">
            全部
          </button>
          <button class="filter-chip" data-filter="activities" onclick="setSearchFilter('activities')">
            <i class="fas fa-calendar"></i> 活動
          </button>
          <button class="filter-chip" data-filter="members" onclick="setSearchFilter('members')">
            <i class="fas fa-users"></i> 會員
          </button>
          <button class="filter-chip" data-filter="resources" onclick="setSearchFilter('resources')">
            <i class="fas fa-book"></i> 資源
          </button>
        </div>
        
        <div id="searchContent">
          ${createSearchHistorySection()}
        </div>
      </div>
    </div>
  `;
}

// 創建搜尋歷史區塊
function createSearchHistorySection() {
  loadSearchHistory();
  
  if (searchHistory.length === 0) {
    return `
      <div class="search-suggestions">
        <h3>熱門搜尋</h3>
        <div class="suggestion-chips">
          <button class="suggestion-chip" onclick="quickSearch('健康講座')">健康講座</button>
          <button class="suggestion-chip" onclick="quickSearch('復健課程')">復健課程</button>
          <button class="suggestion-chip" onclick="quickSearch('社交活動')">社交活動</button>
          <button class="suggestion-chip" onclick="quickSearch('志工服務')">志工服務</button>
        </div>
      </div>
    `;
  }
  
  return `
    <div class="search-history">
      <div class="search-history-header">
        <h3><i class="fas fa-history"></i> 最近搜尋</h3>
        <button class="btn btn-sm btn-secondary" onclick="clearSearchHistory()">
          <i class="fas fa-trash"></i> 清除
        </button>
      </div>
      <div class="search-history-list">
        ${searchHistory.map(item => `
          <div class="search-history-item" onclick="quickSearch('${item}')">
            <i class="fas fa-history"></i>
            <span>${item}</span>
            <button class="btn-icon" onclick="event.stopPropagation(); removeSearchHistoryItem('${item}')">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

// 處理搜尋輸入
function handleSearchInput(event) {
  if (event.key === 'Enter') {
    performSearch();
  } else {
    // 即時搜尋建議
    const query = event.target.value.trim();
    if (query.length >= 2) {
      showSearchSuggestions(query);
    }
  }
}

// 執行搜尋
async function performSearch() {
  const query = document.getElementById('mainSearchInput').value.trim();
  
  if (!query) {
    showToast('請輸入搜尋關鍵字', 'warning');
    return;
  }
  
  // 加入搜尋歷史
  addToSearchHistory(query);
  
  document.getElementById('loadingOverlay').classList.add('active');
  
  try {
    const result = await callServerFunction('search', {
      query: query,
      filter: currentSearchFilter || 'all'
    });
    
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (result.success) {
      searchResults = result.results;
      displaySearchResults(result.results, query);
    } else {
      showToast('搜尋失敗', 'error');
    }
  } catch (error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    console.error('搜尋失敗:', error);
    showToast('系統錯誤：' + error.message, 'error');
  }
}

// 顯示搜尋結果
function displaySearchResults(results, query) {
  const container = document.getElementById('searchContent');
  
  if (results.length === 0) {
    container.innerHTML = `
      <div class="search-no-results">
        <i class="fas fa-search"></i>
        <h3>找不到「${query}」的相關結果</h3>
        <p>請嘗試其他關鍵字或調整篩選條件</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = `
    <div class="search-results">
      <div class="search-results-header">
        <h3>找到 ${results.length} 個結果</h3>
      </div>
      
      ${results.map(result => createSearchResultItem(result)).join('')}
    </div>
  `;
}

// 創建搜尋結果項目
function createSearchResultItem(result) {
  switch(result.type) {
    case 'activity':
      return `
        <div class="search-result-item" onclick="navigateTo('activity-detail', {id: '${result.id}'})">
          <div class="search-result-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="fas fa-calendar"></i>
          </div>
          <div class="search-result-content">
            <span class="search-result-type">活動</span>
            <h4>${highlightSearchTerm(result.title)}</h4>
            <p>${highlightSearchTerm(result.description)}</p>
            <div class="search-result-meta">
              <span><i class="fas fa-calendar"></i> ${formatDate(result.date)}</span>
              <span><i class="fas fa-map-marker-alt"></i> ${result.location}</span>
            </div>
          </div>
          <i class="fas fa-chevron-right"></i>
        </div>
      `;
      
    case 'member':
      return `
        <div class="search-result-item" onclick="viewMemberDetail('${result.id}')">
          <div class="search-result-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <i class="fas fa-user"></i>
          </div>
          <div class="search-result-content">
            <span class="search-result-type">會員</span>
            <h4>${highlightSearchTerm(result.name)}</h4>
            <p>會員編號：${result.memberId}</p>
          </div>
          <i class="fas fa-chevron-right"></i>
        </div>
      `;
      
    case 'resource':
      return `
        <div class="search-result-item" onclick="openResource('${result.url}')">
          <div class="search-result-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <i class="fas fa-book"></i>
          </div>
          <div class="search-result-content">
            <span class="search-result-type">資源</span>
            <h4>${highlightSearchTerm(result.title)}</h4>
            <p>${highlightSearchTerm(result.description)}</p>
          </div>
          <i class="fas fa-chevron-right"></i>
        </div>
      `;
      
    default:
      return '';
  }
}

// 高亮搜尋關鍵字
function highlightSearchTerm(text) {
  const query = document.getElementById('mainSearchInput').value.trim();
  if (!query) return text;
  
  const regex = new RegExp(`(${query})`, 'gi');
  return text.replace(regex, '<mark>$1</mark>');
}

// 設定搜尋篩選
function setSearchFilter(filter) {
  currentSearchFilter = filter;
  
  document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // 如果已有搜尋結果，重新搜尋
  const query = document.getElementById('mainSearchInput').value.trim();
  if (query) {
    performSearch();
  }
}

// 快速搜尋
function quickSearch(query) {
  document.getElementById('mainSearchInput').value = query;
  performSearch();
}

// 載入搜尋歷史
function loadSearchHistory() {
  const history = localStorage.getItem('searchHistory');
  if (history) {
    searchHistory = JSON.parse(history);
  }
}

// 加入搜尋歷史
function addToSearchHistory(query) {
  // 移除重複項目
  searchHistory = searchHistory.filter(item => item !== query);
  
  // 加入到開頭
  searchHistory.unshift(query);
  
  // 只保留最近 10 筆
  searchHistory = searchHistory.slice(0, 10);
  
  // 儲存
  localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
}

// 移除搜尋歷史項目
function removeSearchHistoryItem(query) {
  searchHistory = searchHistory.filter(item => item !== query);
  localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
  
  // 重新顯示
  document.getElementById('searchContent').innerHTML = createSearchHistorySection();
}

// 清除搜尋歷史
function clearSearchHistory() {
  if (!confirm('確定要清除所有搜尋歷史嗎？')) {
    return;
  }
  
  searchHistory = [];
  localStorage.removeItem('searchHistory');
  
  document.getElementById('searchContent').innerHTML = createSearchHistorySection();
  showToast('搜尋歷史已清除', 'success');
}

// 顯示搜尋建議
async function showSearchSuggestions(query) {
  // 實作即時搜尋建議
  // 這裡可以呼叫 API 獲取建議
}

// 開啟資源
function openResource(url) {
  window.open(url, '_blank');
}



<!-- 
  </script>

  
  <script src="permissions.js"></script>
  <script src="batch.js"></script>
  <script src="email-editor.js"></script>
  <script src="utils.js"></script>
  
  <script> -->
    // 初始化應用程式
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });
  </script>
</body>
</html>
