<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>帕金森病友會管理系統</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
  <style>
    :root {
      --primary-color: #00B900;
      --secondary-color: #06C755;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #0dcaf0;
      --dark-color: #212529;
      --light-bg: #f8f9fa;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--light-bg); padding-bottom: 80px; }
    #loadingScreen { position: fixed; inset: 0; background: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
    .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    .app-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: #fff; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
    .app-header h1 { font-size: 1.5rem; font-weight: bold; margin: 0; }
    .user-info { background: #fff; margin: -20px 15px 20px; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,.1); }
    .user-avatar { width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--primary-color); }
    .content-area { padding: 20px 15px; }
    .card { border: none; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,.08); margin-bottom: 15px; overflow: hidden; transition: transform .3s, box-shadow .3s; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 4px 20px rgba(0,0,0,.12); }
    .card-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: #fff; font-weight: bold; border: none; padding: 15px; }
    .stat-card { background: #fff; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,.08); margin-bottom: 15px; }
    .stat-card .icon { font-size: 2.5rem; margin-bottom: 10px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stat-card .number { font-size: 2rem; font-weight: bold; color: var(--dark-color); }
    .stat-card .label { color: #666; font-size: .9rem; }
    .activity-item { background: #fff; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,.08); position: relative; }
    .status-badge { position: absolute; top: 15px; right: 15px; padding: 5px 12px; border-radius: 20px; font-size: .8rem; font-weight: bold; }
    .status-badge.open { background: #d4edda; color: #155724; }
    .status-badge.full { background: #fff3cd; color: #856404; }
    .status-badge.closed { background: #f8d7da; color: #721c24; }
    .btn { border-radius: 10px; padding: 10px 20px; font-weight: 500; transition: all .3s; }
    .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border: none; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,185,0,.3); }
    .btn-outline-primary { border: 2px solid var(--primary-color); color: var(--primary-color); }
    .btn-outline-primary:hover { background: var(--primary-color); color: #fff; }
    .form-control, .form-select { border-radius: 10px; border: 2px solid #e0e0e0; padding: 12px 15px; transition: all .3s; }
    .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 .2rem rgba(0,185,0,.15); }
    .form-label { font-weight: 600; color: var(--dark-color); margin-bottom: 8px; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; box-shadow: 0 -2px 10px rgba(0,0,0,.1); display: flex; justify-content: space-around; padding: 10px 0; z-index: 1000; }
    .bottom-nav-item { flex: 1; text-align: center; padding: 5px; color: #666; text-decoration: none; transition: all .3s; cursor: pointer; }
    .bottom-nav-item.active { color: var(--primary-color); }
    .bottom-nav-item i { font-size: 1.5rem; display: block; margin-bottom: 3px; }
    .bottom-nav-item span { font-size: .75rem; }
    .modal-content { border-radius: 20px; border: none; }
    .modal-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: #fff; border-radius: 20px 20px 0 0; }
    .badge { padding: 6px 12px; border-radius: 20px; font-weight: 500; }
    .alert { border-radius: 15px; border: none; }
    .empty-state { text-align: center; padding: 40px 20px; color: #999; }
    .empty-state i { font-size: 4rem; margin-bottom: 15px; opacity: .3; }
    .admin-badge { background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: #fff; padding: 3px 10px; border-radius: 15px; font-size: .75rem; font-weight: bold; margin-left: 10px; }
    .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; justify-content: center; align-items: center; z-index: 9998; }
    .loading-overlay .spinner-border { width: 3rem; height: 3rem; color: #fff; }
    .rating-stars i { cursor: pointer; transition: all .2s; font-size: 2rem; color: #ddd; }
    .rating-stars i.active { color: #ffc107; }
    .rating-stars i:hover { transform: scale(1.2); }
    @media (max-width: 576px) {
      .app-header h1 { font-size: 1.2rem; }
      .stat-card .number { font-size: 1.5rem; }
    }
    .page-section { display: none; }
    .page-section.active { display: block; }
  </style>
</head>
<body>
  <div id="loadingScreen">
    <div class="spinner"></div>
    <p class="mt-3 text-muted">載入中...</p>
  </div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
  </div>

  <div id="appContainer" style="display:none;">
    <div class="app-header">
      <h1><i class="bi bi-heart-pulse"></i> 帕金森病友會</h1>
    </div>

    <div class="user-info">
      <div class="d-flex align-items-center">
        <img id="userAvatar" src="" alt="User Avatar" class="user-avatar me-3" />
        <div class="flex-grow-1">
          <h5 class="mb-0">
            <span id="userName">載入中...</span>
            <span id="adminBadge" class="admin-badge" style="display:none;">管理員</span>
          </h5>
          <small class="text-muted">
            <span id="memberType">會員類型</span> |
            <span id="memberStatus">狀態</span>
          </small>
        </div>
      </div>
    </div>

    <div class="content-area">
      <div id="dashboardSection" class="page-section active">
        <div class="row g-3">
          <div class="col-6">
            <div class="stat-card">
              <i class="bi bi-calendar-event icon"></i>
              <div class="number" id="statTotalActivities">0</div>
              <div class="label">開放活動</div>
            </div>
          </div>
          <div class="col-6">
            <div class="stat-card">
              <i class="bi bi-check-circle icon"></i>
              <div class="number" id="statMyRegistrations">0</div>
              <div class="label">我的報名</div>
            </div>
          </div>
          <div class="col-6">
            <div class="stat-card">
              <i class="bi bi-clock-history icon"></i>
              <div class="number" id="statVolunteerHours">0</div>
              <div class="label">志工時數</div>
            </div>
          </div>
          <div class="col-6">
            <div class="stat-card">
              <i class="bi bi-currency-dollar icon"></i>
              <div class="number" id="statDonationAmount">0</div>
              <div class="label">捐款金額</div>
            </div>
          </div>
        </div>

        <div class="card mt-4">
          <div class="card-header"><i class="bi bi-star-fill"></i> 最新活動</div>
          <div class="card-body" id="recentActivitiesContainer">
            <div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有活動</p></div>
          </div>
        </div>
      </div>

      <div id="activitiesSection" class="page-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4><i class="bi bi-calendar-event"></i> 活動列表</h4>
          <button class="btn btn-primary btn-sm" id="btnCreateActivity" style="display:none;">
            <i class="bi bi-plus-circle"></i> 新增活動
          </button>
        </div>
        <div id="activitiesContainer">
          <div class="empty-state"><i class="bi bi-inbox"></i><p>載入中...</p></div>
        </div>
      </div>

      <div id="myRegistrationsSection" class="page-section">
        <h4 class="mb-3"><i class="bi bi-list-check"></i> 我的報名</h4>
        <div id="myRegistrationsContainer">
          <div class="empty-state"><i class="bi bi-inbox"></i><p>載入中...</p></div>
        </div>
      </div>

      <div id="volunteerSection" class="page-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4><i class="bi bi-people"></i> 志工服務</h4>
          <button class="btn btn-primary btn-sm" id="btnCreateVolunteer" style="display:none;">
            <i class="bi bi-plus-circle"></i> 新增需求
          </button>
        </div>

        <div class="card mb-3">
          <div class="card-header">志工需求列表</div>
          <div class="card-body" id="volunteerNeedsContainer">
            <div class="empty-state"><i class="bi bi-inbox"></i><p>載入中...</p></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">我的志工記錄</div>
          <div class="card-body" id="myVolunteerRecordsContainer">
            <div class="empty-state"><i class="bi bi-inbox"></i><p>載入中...</p></div>
          </div>
        </div>
      </div>

      <div id="financeSection" class="page-section">
        <h4 class="mb-3"><i class="bi bi-wallet2"></i> 財務管理</h4>

        <div id="financialSummaryCard" style="display:none;">
          <div class="card mb-3">
            <div class="card-header">財務總覽</div>
            <div class="card-body">
              <div class="row text-center">
                <div class="col-4">
                  <h5 class="text-success" id="summaryIncome">$0</h5>
                  <small class="text-muted">總收入</small>
                </div>
                <div class="col-4">
                  <h5 class="text-danger" id="summaryExpense">$0</h5>
                  <small class="text-muted">總支出</small>
                </div>
                <div class="col-4">
                  <h5 class="text-primary" id="summaryBalance">$0</h5>
                  <small class="text-muted">結餘</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>捐款記錄</span>
            <button class="btn btn-sm btn-light" id="btnAddDonation">
              <i class="bi bi-plus"></i> 新增
            </button>
          </div>
          <div class="card-body" id="donationsContainer">
            <div class="empty-state"><i class="bi bi-inbox"></i><p>載入中...</p></div>
          </div>
        </div>

        <div class="card" id="expensesCard" style="display:none;">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>支出記錄</span>
            <button class="btn btn-sm btn-light" id="btnAddExpense">
              <i class="bi bi-plus"></i> 新增
            </button>
          </div>
          <div class="card-body" id="expensesContainer">
            <div class="empty-state"><i class="bi bi-inbox"></i><p>載入中...</p></div>
          </div>
        </div>
      </div>

      <div id="profileSection" class="page-section">
        <h4 class="mb-3"><i class="bi bi-person-circle"></i> 個人資料</h4>
        <div class="card">
          <div class="card-body">
            <form id="profileForm">
              <div class="mb-3">
                <label class="form-label">真實姓名 *</label>
                <input type="text" class="form-control" id="profileRealName" required />
              </div>
              <div class="mb-3">
                <label class="form-label">會員類型 *</label>
                <select class="form-select" id="profileMemberType" required>
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                  <option value="贊助者">贊助者</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">電話</label>
                <input type="tel" class="form-control" id="profilePhone" />
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" id="profileEmail" />
              </div>
              <div class="mb-3">
                <label class="form-label">生日</label>
                <input type="date" class="form-control" id="profileBirthday" />
              </div>
              <div class="mb-3">
                <label class="form-label">地址</label>
                <textarea class="form-control" id="profileAddress" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">確診日期（病友填寫）</label>
                <input type="date" class="form-control" id="profileDiagnosisDate" />
              </div>
              <div class="mb-3">
                <label class="form-label">疾病階段</label>
                <select class="form-select" id="profileDiseaseStage">
                  <option value="">請選擇</option>
                  <option value="第一期">第一期</option>
                  <option value="第二期">第二期</option>
                  <option value="第三期">第三期</option>
                  <option value="第四期">第四期</option>
                  <option value="第五期">第五期</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">目前用藥</label>
                <textarea class="form-control" id="profileMedications" rows="2" placeholder="請列出目前使用的藥物"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">主要症狀</label>
                <textarea class="form-control" id="profileSymptoms" rows="2" placeholder="例如：顫抖、僵硬、行動緩慢等"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">行動能力</label>
                <select class="form-select" id="profileMobility">
                  <option value="">請選擇</option>
                  <option value="獨立行走">獨立行走</option>
                  <option value="需要輔具">需要輔具</option>
                  <option value="需要協助">需要協助</option>
                  <option value="使用輪椅">使用輪椅</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">照顧者姓名</label>
                <input type="text" class="form-control" id="profileCaregiverName" />
              </div>
              <div class="mb-3">
                <label class="form-label">照顧者電話</label>
                <input type="tel" class="form-control" id="profileCaregiverPhone" />
              </div>
              <div class="mb-3">
                <label class="form-label">緊急聯絡人</label>
                <input type="text" class="form-control" id="profileEmergencyContact" placeholder="姓名 / 電話 / 關係" />
              </div>
              <div class="mb-3">
                <label class="form-label">備註</label>
                <textarea class="form-control" id="profileNotes" rows="3"></textarea>
              </div>
              <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-save"></i> 儲存資料
              </button>
            </form>
          </div>
        </div>

        <div id="adminSection" style="display:none;">
          <h5 class="mt-4 mb-3 text-danger">
            <i class="bi bi-shield-lock"></i> 管理員功能
          </h5>
          <div class="card mb-3">
            <div class="card-body">
              <button class="btn btn-outline-primary w-100 mb-2" id="btnManageMembers">
                <i class="bi bi-people"></i> 會員管理
              </button>
              <button class="btn btn-outline-primary w-100 mb-2" id="btnSystemSettings">
                <i class="bi bi-gear"></i> 系統設定
              </button>
              <button class="btn btn-outline-primary w-100" id="btnViewLogs">
                <i class="bi bi-file-text"></i> 系統日誌
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="bottom-nav">
      <a class="bottom-nav-item active" data-page="dashboard">
        <i class="bi bi-house-door-fill"></i><span>首頁</span>
      </a>
      <a class="bottom-nav-item" data-page="activities">
        <i class="bi bi-calendar-event"></i><span>活動</span>
      </a>
      <a class="bottom-nav-item" data-page="volunteer">
        <i class="bi bi-people"></i><span>志工</span>
      </a>
      <a class="bottom-nav-item" data-page="finance">
        <i class="bi bi-wallet2"></i><span>財務</span>
      </a>
      <a class="bottom-nav-item" data-page="profile">
        <i class="bi bi-person-circle"></i><span>我的</span>
      </a>
    </div>
  </div>

  <!-- Modals: 活動/志工/捐款/支出/回饋 -->
  <div class="modal fade" id="createActivityModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 新增活動</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="createActivityForm">
          <div class="mb-3"><label class="form-label">活動名稱 *</label>
            <input type="text" class="form-control" id="activityTitle" required /></div>
          <div class="mb-3"><label class="form-label">活動說明</label>
            <textarea class="form-control" id="activityDescription" rows="3"></textarea></div>
          <div class="mb-3"><label class="form-label">活動日期 *</label>
            <input type="date" class="form-control" id="activityDate" required /></div>
          <div class="mb-3"><label class="form-label">活動時間</label>
            <input type="time" class="form-control" id="activityTime" /></div>
          <div class="mb-3"><label class="form-label">活動地點</label>
            <input type="text" class="form-control" id="activityLocation" /></div>
          <div class="mb-3"><label class="form-label">人數上限 *</label>
            <input type="number" class="form-control" id="activityMaxParticipants" min="1" required /></div>
          <div class="mb-3"><label class="form-label">活動費用</label>
            <input type="number" class="form-control" id="activityFee" min="0" value="0" /></div>
          <button type="submit" class="btn btn-primary w-100">建立活動</button>
        </form>
      </div>
    </div></div>
  </div>

  <div class="modal fade" id="createVolunteerModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 新增志工需求</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="createVolunteerForm">
          <div class="mb-3"><label class="form-label">需求名稱 *</label>
            <input type="text" class="form-control" id="volunteerTitle" required /></div>
          <div class="mb-3"><label class="form-label">需求說明</label>
            <textarea class="form-control" id="volunteerDescription" rows="3"></textarea></div>
          <div class="mb-3"><label class="form-label">服務日期 *</label>
            <input type="date" class="form-control" id="volunteerDate" required /></div>
          <div class="mb-3"><label class="form-label">服務時間</label>
            <input type="time" class="form-control" id="volunteerTime" /></div>
          <div class="mb-3"><label class="form-label">需求人數 *</label>
            <input type="number" class="form-control" id="volunteerNeedCount" min="1" required /></div>
          <div class="mb-3"><label class="form-label">服務時數 *</label>
            <input type="number" class="form-control" id="volunteerHours" min="0.5" step="0.5" required /></div>
          <button type="submit" class="btn btn-primary w-100">建立需求</button>
        </form>
      </div>
    </div></div>
  </div>

  <div class="modal fade" id="addDonationModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-currency-dollar"></i> 新增捐款</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addDonationForm">
          <div class="mb-3"><label class="form-label">捐款類別 *</label>
            <select class="form-select" id="donationCategory" required>
              <option value="">請選擇</option>
              <option value="一般捐款">一般捐款</option>
              <option value="活動贊助">活動贊助</option>
              <option value="設備捐贈">設備捐贈</option>
            </select></div>
          <div class="mb-3"><label class="form-label">捐款金額 *</label>
            <input type="number" class="form-control" id="donationAmount" min="1" required /></div>
          <div class="mb-3"><label class="form-label">說明</label>
            <textarea class="form-control" id="donationDescription" rows="2"></textarea></div>
          <div class="mb-3"><div class="form-check">
            <input class="form-check-input" type="checkbox" id="donationNeedReceipt" />
            <label class="form-check-label" for="donationNeedReceipt">需要收據</label>
          </div></div>
          <button type="submit" class="btn btn-primary w-100">提交捐款</button>
        </form>
      </div>
    </div></div>
  </div>

  <div class="modal fade" id="addExpenseModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-receipt"></i> 新增支出</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addExpenseForm">
          <div class="mb-3"><label class="form-label">支出類別 *</label>
            <select class="form-select" id="expenseCategory" required>
              <option value="">請選擇</option>
              <option value="活動費用">活動費用</option>
              <option value="行政支出">行政支出</option>
              <option value="設備支出">設備支出</option>
              <option value="其他">其他</option>
            </select></div>
          <div class="mb-3"><label class="form-label">支出金額 *</label>
            <input type="number" class="form-control" id="expenseAmount" min="1" required /></div>
          <div class="mb-3"><label class="form-label">說明</label>
            <textarea class="form-control" id="expenseDescription" rows="2"></textarea></div>
          <button type="submit" class="btn btn-primary w-100">提交支出</button>
        </form>
      </div>
    </div></div>
  </div>

  <div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-star"></i> 活動回饋</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="feedbackForm">
          <input type="hidden" id="feedbackActivityId" />
          <div class="mb-3">
            <label class="form-label">評分 *</label>
            <div class="d-flex justify-content-center gap-2 rating-stars" id="ratingStars">
              <i class="bi bi-star" data-rating="1"></i>
              <i class="bi bi-star" data-rating="2"></i>
              <i class="bi bi-star" data-rating="3"></i>
              <i class="bi bi-star" data-rating="4"></i>
              <i class="bi bi-star" data-rating="5"></i>
            </div>
            <input type="hidden" id="feedbackRating" required />
          </div>
          <div class="mb-3">
            <label class="form-label">意見回饋</label>
            <textarea class="form-control" id="feedbackComment" rows="4" placeholder="請分享您的參與心得..."></textarea>
          </div>
          <button type="submit" class="btn btn-primary w-100">提交回饋</button>
        </form>
      </div>
    </div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const CONFIG = {
      LIFF_ID: '1656516134-X9oq92g9', // TODO: 替換
      API_URL: 'https://script.google.com/macros/s/AKfycbzTCgCwwXrQuStfegZRJlNf4TAZgtJVw1iRjLaL3gRUF4dJqcY0RQ3zF3IYIxvqFPB3sA/exec',   // TODO: 替換
      API_KEY: 'AAbb8520258185202581'            // TODO: 替換
    };

    let currentUser = null;
    let isAdmin = false;

    async function initializeLiff() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        currentUser = {
          lineId: profile.userId,
          lineName: profile.displayName,
          pictureUrl: profile.pictureUrl
        };
        document.getElementById('userAvatar').src = profile.pictureUrl || 'https://via.placeholder.com/60';
        await checkUserRegistration();
      } catch (error) {
        console.error('LIFF 初始化失敗:', error);
        showAlert('系統初始化失敗，請重新整理頁面', 'danger');
      }
    }

    async function callAPI(action, data = {}) {
      showLoading(true);
      try {
        const requestBody = { action, apiKey: CONFIG.API_KEY, lineId: currentUser?.lineId || '', ...data };
        const response = await fetch(CONFIG.API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody),
          redirect: 'follow'
        });
        if (!response.ok) throw new Error('HTTP 錯誤: ' + response.status);
        const text = await response.text();
        let result;
        try { result = JSON.parse(text); } catch { throw new Error('伺服器回應格式錯誤'); }
        if (!result.success) throw new Error(result.message || '操作失敗');
        return result.data;
      } catch (error) {
        console.error('API 呼叫失敗:', error);
        let msg = 'API 呼叫失敗';
        if (error.message.includes('Failed to fetch')) msg = '網路連線失敗，請檢查網路狀態';
        else if (error.message.includes('CORS')) msg = 'API 存取權限錯誤，請聯絡管理員';
        else if (error.message) msg = error.message;
        showAlert(msg, 'danger');
        throw error;
      } finally {
        showLoading(false);
      }
    }

    async function checkUserRegistration() {
      try {
        const userData = await callAPI('getUserInfo');
        if (userData) {
          currentUser = { ...currentUser, ...userData };
          isAdmin = !!userData.isAdmin;
          document.getElementById('userName').textContent = userData.realName || userData.lineName;
          document.getElementById('memberType').textContent = userData.memberType || '未設定';
          document.getElementById('memberStatus').textContent = userData.status || '未知';

          if (isAdmin) {
            document.getElementById('adminBadge').style.display = 'inline-block';
            document.getElementById('btnCreateActivity').style.display = 'block';
            document.getElementById('btnCreateVolunteer').style.display = 'block';
            document.getElementById('financialSummaryCard').style.display = 'block';
            document.getElementById('expensesCard').style.display = 'block';
          }
          await loadDashboardData();
          initializeApp();
        }
      } catch (error) {
        if (confirm('您尚未註冊，是否立即註冊？')) {
          showRegistrationForm();
        } else {
          showAlert('請先完成註冊才能使用系統', 'warning');
        }
      }
    }

    function showRegistrationForm() {
      const html = `
        <div class="card">
          <div class="card-header">會員註冊</div>
          <div class="card-body">
            <form id="registrationForm">
              <div class="mb-3"><label class="form-label">真實姓名 *</label>
                <input type="text" class="form-control" id="regRealName" required /></div>
              <div class="mb-3"><label class="form-label">會員類型 *</label>
                <select class="form-select" id="regMemberType" required>
                  <option value="">請選擇</option>
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                  <option value="贊助者">贊助者</option>
                </select></div>
              <div class="mb-3"><label class="form-label">電話</label>
                <input type="tel" class="form-control" id="regPhone" /></div>
              <button type="submit" class="btn btn-primary w-100">完成註冊</button>
            </form>
          </div>
        </div>
      `;
      document.querySelector('.content-area').innerHTML = html;
      document.getElementById('registrationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          await callAPI('register', {
            lineId: currentUser.lineId,
            realName: document.getElementById('regRealName').value,
            memberType: document.getElementById('regMemberType').value,
            phone: document.getElementById('regPhone').value,
            lineName: currentUser.lineName,
            pictureUrl: currentUser.pictureUrl
          });
          showAlert('註冊成功！', 'success');
          setTimeout(() => location.reload(), 1200);
        } catch (error) {
          showAlert('註冊失敗：' + error.message, 'danger');
        }
      });
    }

    function initializeApp() {
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('appContainer').style.display = 'block';
      setupEventListeners();
      loadProfileData();
    }

    async function loadDashboardData() {
      try {
        const data = await callAPI('getDashboardData');
        document.getElementById('statTotalActivities').textContent = data.totalActivities || 0;
        document.getElementById('statMyRegistrations').textContent = data.myRegistrations || 0;
        document.getElementById('statVolunteerHours').textContent = data.myVolunteerHours || 0;
        document.getElementById('statDonationAmount').textContent = data.myDonationAmount || 0;

        const container = document.getElementById('recentActivitiesContainer');
        if (data.recentActivities && data.recentActivities.length > 0) {
          container.innerHTML = data.recentActivities.map(act => `
            <div class="mb-2 pb-2 border-bottom">
              <h6 class="mb-1">${act.title}</h6>
              <small class="text-muted">
                <i class="bi bi-calendar"></i> ${act.date}
                <i class="bi bi-people ms-2"></i> ${act.currentParticipants || 0}/${act.maxParticipants}
              </small>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有活動</p></div>';
        }
        if (isAdmin) await loadFinancialSummary();
      } catch (e) { console.error(e); }
    }

    async function loadFinancialSummary() {
      try {
        const data = await callAPI('getFinancialSummary');
        document.getElementById('summaryIncome').textContent = '$' + (data.totalIncome || 0).toLocaleString();
        document.getElementById('summaryExpense').textContent = '$' + (data.totalExpense || 0).toLocaleString();
        document.getElementById('summaryBalance').textContent = '$' + (data.balance || 0).toLocaleString();
      } catch (e) { console.error(e); }
    }

    async function loadActivities() {
      try {
        const activities = await callAPI('getActivities');
        const container = document.getElementById('activitiesContainer');
        if (!activities || activities.length === 0) {
          container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有活動</p></div>';
          return;
        }
        container.innerHTML = activities.map(act => {
          const isFull = (act.currentParticipants || 0) >= act.maxParticipants;
          const statusClass = act.status === '開放報名' ? (isFull ? 'full' : 'open') : 'closed';
          const statusText = act.status === '開放報名' ? (isFull ? '名額已滿' : '開放報名') : act.status;
          return `
            <div class="activity-item">
              <span class="status-badge ${statusClass}">${statusText}</span>
              <h5 class="mb-2">${act.title}</h5>
              <p class="text-muted mb-2">${act.description || '無說明'}</p>
              <div class="mb-2"><i class="bi bi-calendar3"></i> ${act.date} ${act.time || ''}</div>
              <div class="mb-2"><i class="bi bi-geo-alt"></i> ${act.location || '待定'}</div>
              <div class="mb-3">
                <i class="bi bi-people"></i> ${act.currentParticipants || 0}/${act.maxParticipants} 人
                ${act.fee > 0 ? ` | <i class="bi bi-currency-dollar"></i> ${act.fee} 元` : ''}
              </div>
              <div class="d-flex gap-2">
                ${(act.status === '開放報名' && !isFull) ? `
                  <button class="btn btn-primary btn-sm flex-grow-1" onclick="registerForActivity('${act.id}')">
                    <i class="bi bi-check-circle"></i> 我要報名
                  </button>` : ''}
                <button class="btn btn-outline-secondary btn-sm" onclick="viewActivityInfo('${act.id}')">
                  <i class="bi bi-info-circle"></i> 詳情
                </button>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        document.getElementById('activitiesContainer').innerHTML =
          '<div class="alert alert-danger">載入失敗，請重新整理頁面</div>';
      }
    }

    async function viewActivityInfo(activityId) {
      try {
        const activity = await callAPI('getActivity', { activityId });
        const info = `
          <div class="alert alert-info">
            <h5>${activity.title}</h5>
            <p>${activity.description || '無說明'}</p>
            <hr>
            <p><strong>日期：</strong>${activity.date} ${activity.time || ''}</p>
            <p><strong>地點：</strong>${activity.location || '待定'}</p>
            <p><strong>人數：</strong>${activity.currentParticipants || 0}/${activity.maxParticipants}</p>
            <p><strong>費用：</strong>$${activity.fee || 0}</p>
            <p><strong>狀態：</strong>${activity.status}</p>
          </div>`;
        showAlert(info, 'info');
      } catch (error) { showAlert('載入活動資訊失敗', 'danger'); }
    }

    async function registerForActivity(activityId) {
      if (!confirm('確定要報名此活動嗎？')) return;
      try {
        await callAPI('registerActivity', { activityId });
        showAlert('報名成功！', 'success');
        loadActivities(); loadMyRegistrations(); loadDashboardData();
      } catch (e) { showAlert('報名失敗：' + e.message, 'danger'); }
    }

    async function loadMyRegistrations() {
      try {
        const registrations = await callAPI('getMyRegistrations');
        const container = document.getElementById('myRegistrationsContainer');
        if (!registrations || registrations.length === 0) {
          container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有報名記錄</p></div>';
          return;
        }
        container.innerHTML = registrations.map(reg => `
          <div class="activity-item">
            <h5 class="mb-2">${reg.activityTitle}</h5>
            <div class="mb-2">
              <span class="badge bg-${reg.status === '已報名' ? 'success' : reg.status === '已取消' ? 'secondary' : 'primary'}">${reg.status}</span>
              ${reg.paymentStatus ? `<span class="badge bg-${reg.paymentStatus === '已付款' ? 'success' : 'warning'} ms-2">${reg.paymentStatus}</span>` : ''}
              ${reg.attended ? '<span class="badge bg-info ms-2">已簽到</span>' : ''}
            </div>
            <div class="mb-2"><i class="bi bi-calendar3"></i> 報名時間：${new Date(reg.createdAt).toLocaleString('zh-TW')}</div>
            <div class="d-flex gap-2">
              ${reg.status === '已報名' ? `
              <button class="btn btn-outline-danger btn-sm" onclick="cancelMyRegistration('${reg.id}')">
                <i class="bi bi-x-circle"></i> 取消報名
              </button>` : ''}
              ${reg.status === '已完成' && !reg.feedbackSubmitted ? `
              <button class="btn btn-outline-primary btn-sm" onclick="showFeedbackModal('${reg.activityId}')">
                <i class="bi bi-star"></i> 活動回饋
              </button>` : ''}
            </div>
          </div>
        `).join('');
      } catch (e) { console.error(e); }
    }

    async function cancelMyRegistration(registrationId) {
      if (!confirm('確定要取消報名嗎？')) return;
      try {
        await callAPI('cancelRegistration', { registrationId });
        showAlert('已取消報名', 'success');
        loadMyRegistrations(); loadDashboardData();
      } catch (e) { showAlert('取消失敗：' + e.message, 'danger'); }
    }

    function showFeedbackModal(activityId) {
      document.getElementById('feedbackActivityId').value = activityId;
      document.getElementById('feedbackRating').value = '';
      document.getElementById('feedbackComment').value = '';
      document.querySelectorAll('#ratingStars i').forEach(star => {
        star.classList.remove('bi-star-fill', 'active'); star.classList.add('bi-star');
      });
      const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
      modal.show();
    }

    async function loadVolunteerNeeds() {
      try {
        const needs = await callAPI('getVolunteerNeeds');
        const container = document.getElementById('volunteerNeedsContainer');
        if (!needs || needs.length === 0) {
          container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有志工需求</p></div>';
          return;
        }
        container.innerHTML = needs.map(need => {
          const isFull = (need.currentCount || 0) >= need.needCount;
          return `
            <div class="activity-item">
              <h5 class="mb-2">${need.title}</h5>
              <p class="text-muted mb-2">${need.description || '無說明'}</p>
              <div class="mb-2"><i class="bi bi-calendar3"></i> ${need.date} ${need.time || ''}</div>
              <div class="mb-3">
                <i class="bi bi-people"></i> ${need.currentCount || 0}/${need.needCount} 人
                | <i class="bi bi-clock"></i> ${need.hours} 小時
              </div>
              ${(need.status === '招募中' && !isFull) ? `
                <button class="btn btn-primary btn-sm w-100" onclick="applyForVolunteer('${need.id}')">
                  <i class="bi bi-hand-thumbs-up"></i> 我要報名
                </button>` : `<span class="badge bg-secondary">已額滿</span>`}
            </div>
          `;
        }).join('');
      } catch (e) { console.error(e); }
    }

    async function applyForVolunteer(needId) {
      if (!confirm('確定要報名此志工服務嗎？')) return;
      try {
        await callAPI('applyVolunteer', { needId });
        showAlert('報名成功！', 'success');
        loadVolunteerNeeds(); loadMyVolunteerRecords(); loadDashboardData();
      } catch (e) { showAlert('報名失敗：' + e.message, 'danger'); }
    }

    async function loadMyVolunteerRecords() {
      try {
        const records = await callAPI('getMyVolunteerRecords');
        const container = document.getElementById('myVolunteerRecordsContainer');
        if (!records || records.length === 0) {
          container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有志工記錄</p></div>';
          return;
        }
        container.innerHTML = records.map(rec => `
          <div class="activity-item">
            <h6 class="mb-2">${rec.title || '志工服務'}</h6>
            <div class="mb-2"><span class="badge bg-${rec.status === '已完成' ? 'success' : 'primary'}">${rec.status}</span></div>
            <div class="mb-2"><i class="bi bi-calendar3"></i> ${rec.createdAt ? new Date(rec.createdAt).toLocaleDateString('zh-TW') : ''} | <i class="bi bi-clock"></i> ${rec.hours} 小時</div>
          </div>
        `).join('');
      } catch (e) { console.error(e); }
    }

    async function loadDonations() {
      try {
        const donations = await callAPI('getDonations');
        const container = document.getElementById('donationsContainer');
        if (!donations || donations.length === 0) {
          container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有捐款記錄</p></div>';
          return;
        }
        container.innerHTML = donations.map(don => `
          <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
            <div>
              <h6 class="mb-1">${don.category}</h6>
              <small class="text-muted">${new Date(don.createdAt).toLocaleDateString('zh-TW')}</small>
              <div><small>${don.description || ''}</small></div>
            </div>
            <div class="text-end">
              <h6 class="text-success mb-1">$${(don.amount || 0).toLocaleString()}</h6>
              <span class="badge bg-${don.status === '已確認' ? 'success' : 'warning'}">${don.status}</span>
            </div>
          </div>
        `).join('');
      } catch (e) { console.error(e); }
    }

    async function loadExpenses() {
      try {
        const expenses = await callAPI('getExpenses');
        const container = document.getElementById('expensesContainer');
        if (!expenses || expenses.length === 0) {
          container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有支出記錄</p></div>';
          return;
        }
        container.innerHTML = expenses.map(exp => `
          <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
            <div>
              <h6 class="mb-1">${exp.category}</h6>
              <small class="text-muted">${new Date(exp.createdAt).toLocaleDateString('zh-TW')}</small>
              <div><small>${exp.description || ''}</small></div>
            </div>
            <div class="text-end">
              <h6 class="text-danger mb-1">$${(exp.amount || 0).toLocaleString()}</h6>
              <span class="badge bg-${exp.status === '已核准' ? 'success' : 'warning'}">${exp.status}</span>
            </div>
          </div>
        `).join('');
      } catch (e) { console.error(e); }
    }

    function loadProfileData() {
      if (!currentUser) return;
      document.getElementById('profileRealName').value = currentUser.realName || '';
      document.getElementById('profileMemberType').value = currentUser.memberType || '';
      document.getElementById('profilePhone').value = currentUser.phone || '';
      document.getElementById('profileEmail').value = currentUser.email || '';
      document.getElementById('profileBirthday').value = currentUser.birthday || '';
      document.getElementById('profileAddress').value = currentUser.address || '';
      document.getElementById('profileDiagnosisDate').value = currentUser.diagnosisDate || '';
      document.getElementById('profileDiseaseStage').value = currentUser.diseaseStage || '';
      document.getElementById('profileMedications').value = currentUser.medications || '';
      document.getElementById('profileSymptoms').value = currentUser.symptoms || '';
      document.getElementById('profileMobility').value = currentUser.mobility || '';
      document.getElementById('profileCaregiverName').value = currentUser.caregiverName || '';
      document.getElementById('profileCaregiverPhone').value = currentUser.caregiverPhone || '';
      document.getElementById('profileEmergencyContact').value = currentUser.emergencyContact || '';
      document.getElementById('profileNotes').value = currentUser.notes || '';
    }

    function setupEventListeners() {
      document.querySelectorAll('.bottom-nav-item').forEach(item => {
        item.addEventListener('click', function() { switchPage(this.dataset.page); });
      });

      document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          await callAPI('updateProfile', {
            realName: document.getElementById('profileRealName').value,
            memberType: document.getElementById('profileMemberType').value,
            phone: document.getElementById('profilePhone').value,
            email: document.getElementById('profileEmail').value,
            birthday: document.getElementById('profileBirthday').value,
            address: document.getElementById('profileAddress').value,
            diagnosisDate: document.getElementById('profileDiagnosisDate').value,
            diseaseStage: document.getElementById('profileDiseaseStage').value,
            medications: document.getElementById('profileMedications').value,
            symptoms: document.getElementById('profileSymptoms').value,
            mobility: document.getElementById('profileMobility').value,
            caregiverName: document.getElementById('profileCaregiverName').value,
            caregiverPhone: document.getElementById('profileCaregiverPhone').value,
            emergencyContact: document.getElementById('profileEmergencyContact').value,
            notes: document.getElementById('profileNotes').value
          });
          showAlert('個人資料已更新', 'success');
          await checkUserRegistration();
        } catch (e) { showAlert('更新失敗：' + e.message, 'danger'); }
      });

      const btnCreateActivity = document.getElementById('btnCreateActivity');
      if (btnCreateActivity) {
        btnCreateActivity.addEventListener('click', () => {
          const modal = new bootstrap.Modal(document.getElementById('createActivityModal'));
          modal.show();
        });
      }
      document.getElementById('createActivityForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          await callAPI('createActivity', {
            title: document.getElementById('activityTitle').value,
            description: document.getElementById('activityDescription').value,
            date: document.getElementById('activityDate').value,
            time: document.getElementById('activityTime').value,
            location: document.getElementById('activityLocation').value,
            maxParticipants: document.getElementById('activityMaxParticipants').value,
            fee: document.getElementById('activityFee').value
          });
          showAlert('活動已建立', 'success');
          bootstrap.Modal.getInstance(document.getElementById('createActivityModal')).hide();
          document.getElementById('createActivityForm').reset();
          loadActivities();
        } catch (e) { showAlert('建立失敗：' + e.message, 'danger'); }
      });

      const btnCreateVolunteer = document.getElementById('btnCreateVolunteer');
      if (btnCreateVolunteer) {
        btnCreateVolunteer.addEventListener('click', () => {
          const modal = new bootstrap.Modal(document.getElementById('createVolunteerModal'));
          modal.show();
        });
      }
      document.getElementById('createVolunteerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          await callAPI('createVolunteerNeed', {
            title: document.getElementById('volunteerTitle').value,
            description: document.getElementById('volunteerDescription').value,
            date: document.getElementById('volunteerDate').value,
            time: document.getElementById('volunteerTime').value,
            needCount: document.getElementById('volunteerNeedCount').value,
            hours: document.getElementById('volunteerHours').value
          });
          showAlert('志工需求已建立', 'success');
          bootstrap.Modal.getInstance(document.getElementById('createVolunteerModal')).hide();
          document.getElementById('createVolunteerForm').reset();
          loadVolunteerNeeds();
        } catch (e) { showAlert('建立失敗：' + e.message, 'danger'); }
      });

      document.getElementById('btnAddDonation').addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('addDonationModal'));
        modal.show();
      });
      document.getElementById('addDonationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          await callAPI('createDonation', {
            category: document.getElementById('donationCategory').value,
            amount: document.getElementById('donationAmount').value,
            description: document.getElementById('donationDescription').value,
            needReceipt: document.getElementById('donationNeedReceipt').checked
          });
          showAlert('捐款記錄已建立', 'success');
          bootstrap.Modal.getInstance(document.getElementById('addDonationModal')).hide();
          document.getElementById('addDonationForm').reset();
          loadDonations(); loadDashboardData();
        } catch (e) { showAlert('建立失敗：' + e.message, 'danger'); }
      });

      const btnAddExpense = document.getElementById('btnAddExpense');
      if (btnAddExpense) {
        btnAddExpense.addEventListener('click', () => {
          const modal = new bootstrap.Modal(document.getElementById('addExpenseModal'));
          modal.show();
        });
      }
      document.getElementById('addExpenseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          await callAPI('createExpense', {
            category: document.getElementById('expenseCategory').value,
            amount: document.getElementById('expenseAmount').value,
            description: document.getElementById('expenseDescription').value
          });
          showAlert('支出記錄已建立', 'success');
          bootstrap.Modal.getInstance(document.getElementById('addExpenseModal')).hide();
          document.getElementById('addExpenseForm').reset();
          loadExpenses();
        } catch (e) { showAlert('建立失敗：' + e.message, 'danger'); }
      });

      document.querySelectorAll('#ratingStars i').forEach(star => {
        star.addEventListener('click', function() {
          const rating = Number(this.dataset.rating);
          document.getElementById('feedbackRating').value = rating;
          document.querySelectorAll('#ratingStars i').forEach((s, idx) => {
            if (idx < rating) { s.classList.remove('bi-star'); s.classList.add('bi-star-fill', 'active'); }
            else { s.classList.remove('bi-star-fill', 'active'); s.classList.add('bi-star'); }
          });
        });
      });
      document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const rating = document.getElementById('feedbackRating').value;
        if (!rating) { showAlert('請選擇評分', 'warning'); return; }
        try {
          await callAPI('submitFeedback', {
            activityId: document.getElementById('feedbackActivityId').value,
            rating: rating,
            comment: document.getElementById('feedbackComment').value
          });
          showAlert('感謝您的回饋！', 'success');
          bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
          loadMyRegistrations();
        } catch (e) { showAlert('提交失敗：' + e.message, 'danger'); }
      });

      const btnManageMembers = document.getElementById('btnManageMembers');
      if (btnManageMembers) {
        btnManageMembers.addEventListener('click', () => {
          liff.openWindow({ url: 'YOUR_ADMIN_LIFF_URL', external: false }); // TODO: 替換
        });
      }
      const btnSystemSettings = document.getElementById('btnSystemSettings');
      if (btnSystemSettings) {
        btnSystemSettings.addEventListener('click', () => { showAlert('請使用管理後台進行系統設定', 'info'); });
      }
      const btnViewLogs = document.getElementById('btnViewLogs');
      if (btnViewLogs) {
        btnViewLogs.addEventListener('click', () => { showAlert('請使用管理後台查看系統日誌', 'info'); });
      }
    }

    function switchPage(page) {
      document.querySelectorAll('.bottom-nav-item').forEach(i => i.classList.remove('active'));
      document.querySelector(`[data-page="${page}"]`).classList.add('active');
      document.querySelectorAll('.page-section').forEach(sec => sec.classList.remove('active'));
      const sectionMap = {
        'dashboard':'dashboardSection','activities':'activitiesSection','myRegistrations':'myRegistrationsSection',
        'volunteer':'volunteerSection','finance':'financeSection','profile':'profileSection'
      };
      const sectionId = sectionMap[page];
      if (sectionId) {
        document.getElementById(sectionId).classList.add('active');
        switch (page) {
          case 'activities': loadActivities(); break;
          case 'myRegistrations': loadMyRegistrations(); break;
          case 'volunteer': loadVolunteerNeeds(); loadMyVolunteerRecords(); break;
          case 'finance': loadDonations(); if (isAdmin) { loadExpenses(); loadFinancialSummary(); } break;
        }
      }
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function showAlert(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
      alertDiv.style.zIndex = '9999';
      alertDiv.style.minWidth = '300px';
      alertDiv.style.maxWidth = '90%';
      alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
      document.body.appendChild(alertDiv);
      setTimeout(() => { alertDiv.remove(); }, 5000);
    }

    window.addEventListener('load', () => { initializeLiff(); });
    // 將函式暴露給 onclick
    window.registerForActivity = registerForActivity;
    window.viewActivityInfo = viewActivityInfo;
    window.cancelMyRegistration = cancelMyRegistration;
    window.applyForVolunteer = applyForVolunteer;
    window.showFeedbackModal = showFeedbackModal;
  </script>
</body>
</html>
