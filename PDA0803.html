<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會財務會計系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
      .sidebar {
          min-height: 100vh;
          background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
          transition: all 0.3s;
      }
      
      .sidebar .nav-link {
          color: #ecf0f1;
          padding: 12px 20px;
          margin: 2px 0;
          border-radius: 8px;
          transition: all 0.3s;
      }
      
      .sidebar .nav-link:hover {
          background-color: rgba(255, 255, 255, 0.1);
          color: #fff;
          transform: translateX(5px);
      }
      
      .sidebar .nav-link.active {
          background-color: #3498db;
          color: #fff;
      }
      
      .main-content {
          background-color: #f8f9fa;
          min-height: 100vh;
      }
      
      .card {
          border: none;
          border-radius: 15px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          transition: transform 0.3s, box-shadow 0.3s;
      }
      
      .card:hover {
          transform: translateY(-5px);
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }
      
      .btn-primary {
          background: linear-gradient(45deg, #3498db, #2980b9);
          border: none;
          border-radius: 25px;
          padding: 10px 25px;
          transition: all 0.3s;
      }
      
      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
      }
      
      .table {
          border-radius: 10px;
          overflow: hidden;
      }
      
      .table thead th {
          background: linear-gradient(45deg, #34495e, #2c3e50);
          color: white;
          border: none;
          padding: 15px;
      }
      
      .loading {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 9999;
      }
      
      .loading-spinner {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          color: white;
          text-align: center;
      }
      
      .alert {
          border-radius: 10px;
          border: none;
      }
      
      @media (max-width: 768px) {
          .sidebar {
              position: fixed;
              left: -100%;
              top: 0;
              z-index: 1000;
              width: 250px;
              transition: left 0.3s;
          }
          
          .sidebar.active {
              left: 0;
          }
          
          .main-content {
              margin-left: 0;
          }
      }
      
      .page-content {
          display: none;
      }
      
      .page-content.active {
          display: block;
      }
      
      .stats-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border-radius: 15px;
      }
      
      .income-card {
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }
      
      .expense-card {
          background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      }
      
      .member-card {
          background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      }
      
      .account-card {
          background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      }
  </style>
</head>
<body>
  <!-- Loading 動畫 -->
  <div class="loading" id="loadingOverlay">
      <div class="loading-spinner">
          <div class="spinner-border" role="status">
              <span class="visually-hidden">載入中...</span>
          </div>
          <div class="mt-3">載入中，請稍候...</div>
      </div>
  </div>

  <!-- Alert 容器 -->
  <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1050;"></div>

  <div class="container-fluid">
      <div class="row">
          <!-- 側邊欄 -->
          <nav class="col-md-3 col-lg-2 d-md-block sidebar" id="sidebar">
              <div class="position-sticky pt-3">
                  <div class="text-center mb-4">
                      <h5 class="text-white">財務會計系統</h5>
                      <small class="text-light">台灣帕金森病友權益促進會</small>
                  </div>
                  
                  <ul class="nav flex-column">
                      <li class="nav-item">
                          <a class="nav-link active" href="#" data-page="dashboard">
                              <i class="fas fa-tachometer-alt me-2"></i>
                              儀表板
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" data-page="members">
                              <i class="fas fa-users me-2"></i>
                              會員管理
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" data-page="income">
                              <i class="fas fa-plus-circle me-2"></i>
                              收入管理
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" data-page="expenses">
                              <i class="fas fa-minus-circle me-2"></i>
                              支出管理
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" data-page="accounts">
                              <i class="fas fa-university me-2"></i>
                              帳戶管理
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" data-page="reports">
                              <i class="fas fa-chart-bar me-2"></i>
                              報表分析
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" data-page="settings">
                              <i class="fas fa-cog me-2"></i>
                              系統設定
                          </a>
                      </li>
                  </ul>
              </div>
          </nav>

          <!-- 主要內容區 -->
          <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content" id="mainContent">
              <!-- 手機版選單按鈕 -->
              <div class="d-md-none">
                  <button class="btn btn-primary mb-3" type="button" onclick="toggleSidebar()">
                      <i class="fas fa-bars"></i> 選單
                  </button>
              </div>

              <!-- 儀表板頁面 -->
              <div class="page-content active" id="dashboard">
                  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                      <h1 class="h2">儀表板</h1>
                      <div class="btn-toolbar mb-2 mb-md-0">
                          <div class="btn-group me-2">
                              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshDashboard()">
                                  <i class="fas fa-refresh"></i> 重新整理
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- 統計卡片 -->
                  <div class="row mb-4">
                      <div class="col-xl-3 col-md-6 mb-4">
                          <div class="card stats-card income-card">
                              <div class="card-body">
                                  <div class="row no-gutters align-items-center">
                                      <div class="col mr-2">
                                          <div class="text-xs font-weight-bold text-white text-uppercase mb-1">
                                              本月收入
                                          </div>
                                          <div class="h5 mb-0 font-weight-bold text-white" id="monthlyIncome">
                                              載入中...
                                          </div>
                                      </div>
                                      <div class="col-auto">
                                          <i class="fas fa-dollar-sign fa-2x text-white-50"></i>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <div class="col-xl-3 col-md-6 mb-4">
                          <div class="card stats-card expense-card">
                              <div class="card-body">
                                  <div class="row no-gutters align-items-center">
                                      <div class="col mr-2">
                                          <div class="text-xs font-weight-bold text-white text-uppercase mb-1">
                                              本月支出
                                          </div>
                                          <div class="h5 mb-0 font-weight-bold text-white" id="monthlyExpenses">
                                              載入中...
                                          </div>
                                      </div>
                                      <div class="col-auto">
                                          <i class="fas fa-shopping-cart fa-2x text-white-50"></i>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <div class="col-xl-3 col-md-6 mb-4">
                          <div class="card stats-card member-card">
                              <div class="card-body">
                                  <div class="row no-gutters align-items-center">
                                      <div class="col mr-2">
                                          <div class="text-xs font-weight-bold text-white text-uppercase mb-1">
                                              會員總數
                                          </div>
                                          <div class="h5 mb-0 font-weight-bold text-white" id="totalMembers">
                                              載入中...
                                          </div>
                                      </div>
                                      <div class="col-auto">
                                          <i class="fas fa-users fa-2x text-white-50"></i>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <div class="col-xl-3 col-md-6 mb-4">
                          <div class="card stats-card account-card">
                              <div class="card-body">
                                  <div class="row no-gutters align-items-center">
                                      <div class="col mr-2">
                                          <div class="text-xs font-weight-bold text-white text-uppercase mb-1">
                                              銀行帳戶
                                          </div>
                                          <div class="h5 mb-0 font-weight-bold text-white" id="totalAccounts">
                                              載入中...
                                          </div>
                                      </div>
                                      <div class="col-auto">
                                          <i class="fas fa-university fa-2x text-white-50"></i>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- 最近交易 -->
                  <div class="row">
                      <div class="col-12">
                          <div class="card">
                              <div class="card-header">
                                  <h5 class="card-title mb-0">系統概況</h5>
                              </div>
                              <div class="card-body">
                                  <div id="systemOverview">
                                      <p class="text-muted">系統運作正常，所有功能可正常使用。</p>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 會員管理頁面 -->
              <div class="page-content" id="members">
                  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                      <h1 class="h2">會員管理</h1>
                      <div class="btn-toolbar mb-2 mb-md-0">
                          <div class="btn-group me-2">
                              <button type="button" class="btn btn-primary" onclick="showAddMemberModal()">
                                  <i class="fas fa-plus"></i> 新增會員
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- 會員列表 -->
                  <div class="card">
                      <div class="card-body">
                          <div class="table-responsive">
                              <table class="table table-hover">
                                  <thead>
                                      <tr>
                                          <th>會員編號</th>
                                          <th>姓名</th>
                                          <th>電話</th>
                                          <th>Email</th>
                                          <th>狀態</th>
                                          <th>加入日期</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody id="membersTableBody">
                                      <tr>
                                          <td colspan="7" class="text-center">載入中...</td>
                                      </tr>
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 收入管理頁面 -->
              <div class="page-content" id="income">
                  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                      <h1 class="h2">收入管理</h1>
                      <div class="btn-toolbar mb-2 mb-md-0">
                          <div class="btn-group me-2">
                              <button type="button" class="btn btn-primary" onclick="showAddIncomeModal()">
                                  <i class="fas fa-plus"></i> 新增收入
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- 收入列表 -->
                  <div class="card">
                      <div class="card-body">
                          <div class="table-responsive">
                              <table class="table table-hover">
                                  <thead>
                                      <tr>
                                          <th>日期</th>
                                          <th>項目</th>
                                          <th>金額</th>
                                          <th>會計科目</th>
                                          <th>銀行帳戶</th>
                                          <th>狀態</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody id="incomeTableBody">
                                      <tr>
                                          <td colspan="7" class="text-center">載入中...</td>
                                      </tr>
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 支出管理頁面 -->
              <div class="page-content" id="expenses">
                  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                      <h1 class="h2">支出管理</h1>
                      <div class="btn-toolbar mb-2 mb-md-0">
                          <div class="btn-group me-2">
                              <button type="button" class="btn btn-primary" onclick="showAddExpenseModal()">
                                  <i class="fas fa-plus"></i> 新增支出
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- 支出列表 -->
                  <div class="card">
                      <div class="card-body">
                          <div class="table-responsive">
                              <table class="table table-hover">
                                  <thead>
                                      <tr>
                                          <th>日期</th>
                                          <th>項目</th>
                                          <th>金額</th>
                                          <th>會計科目</th>
                                          <th>銀行帳戶</th>
                                          <th>申請人</th>
                                          <th>狀態</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody id="expensesTableBody">
                                      <tr>
                                          <td colspan="8" class="text-center">載入中...</td>
                                      </tr>
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 帳戶管理頁面 -->
              <div class="page-content" id="accounts">
                  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                      <h1 class="h2">帳戶管理</h1>
                      <div class="btn-toolbar mb-2 mb-md-0">
                          <div class="btn-group me-2">
                              <button type="button" class="btn btn-primary" onclick="showAddAccountModal()">
                                  <i class="fas fa-plus"></i> 新增帳戶
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- 銀行帳戶列表 -->
                  <div class="card">
                      <div class="card-body">
                          <div class="table-responsive">
                              <table class="table table-hover">
                                  <thead>
                                      <tr>
                                          <th>銀行名稱</th>
                                          <th>帳戶名稱</th>
                                          <th>帳號</th>
                                          <th>餘額</th>
                                          <th>狀態</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody id="accountsTableBody">
                                      <tr>
                                          <td colspan="6" class="text-center">載入中...</td>
                                      </tr>
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 報表分析頁面 -->
              <div class="page-content" id="reports">
                  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                      <h1 class="h2">報表分析</h1>
                      <div class="btn-toolbar mb-2 mb-md-0">
                          <div class="btn-group me-2">
                              <button type="button" class="btn btn-primary" onclick="generateFinancialReport()">
                                  <i class="fas fa-file-alt"></i> 生成財務報表
                              </button>
                          </div>
                      </div>
                  </div>

                  <div class="card">
                      <div class="card-body">
                          <div id="reportContent">
                              <p class="text-muted text-center">點擊上方按鈕生成報表</p>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 系統設定頁面 -->
              <div class="page-content" id="settings">
                  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                      <h1 class="h2">系統設定</h1>
                  </div>

                  <div class="row">
                      <div class="col-md-6">
                          <div class="card">
                              <div class="card-header">
                                  <h5 class="card-title mb-0">組織資訊</h5>
                              </div>
                              <div class="card-body">
                                  <form id="orgInfoForm" onsubmit="saveOrganizationInfo(event)">
                                      <div class="mb-3">
                                          <label for="orgName" class="form-label">組織名稱</label>
                                          <input type="text" class="form-control" id="orgName" name="name" required>
                                      </div>
                                      <div class="mb-3">
                                          <label for="orgAddress" class="form-label">地址</label>
                                          <textarea class="form-control" id="orgAddress" name="address" rows="3"></textarea>
                                      </div>
                                      <div class="mb-3">
                                          <label for="orgPhone" class="form-label">電話</label>
                                          <input type="tel" class="form-control" id="orgPhone" name="phone">
                                      </div>
                                      <div class="mb-3">
                                          <label for="orgEmail" class="form-label">Email</label>
                                          <input type="email" class="form-control" id="orgEmail" name="email">
                                      </div>
                                      <div class="mb-3">
                                          <label for="orgTaxId" class="form-label">統一編號</label>
                                          <input type="text" class="form-control" id="orgTaxId" name="taxId">
                                      </div>
                                      <button type="submit" class="btn btn-primary">儲存設定</button>
                                  </form>
                              </div>
                          </div>
                      </div>

                      <div class="col-md-6">
                          <div class="card">
                              <div class="card-header">
                                  <h5 class="card-title mb-0">系統管理</h5>
                              </div>
                              <div class="card-body">
                                  <div class="d-grid gap-2">
                                      <button type="button" class="btn btn-info" onclick="createSystemBackup()">
                                          <i class="fas fa-download"></i> 建立系統備份
                                      </button>
                                      <button type="button" class="btn btn-warning" onclick="cleanupSystemData()">
                                          <i class="fas fa-broom"></i> 清理系統資料
                                      </button>
                                      <button type="button" class="btn btn-danger" onclick="resetSystemSettings()">
                                          <i class="fas fa-undo"></i> 重置系統設定
                                      </button>
                                  </div>
                                  
                                  <hr>
                                  
                                  <div id="systemStatus">
                                      <h6>系統狀態</h6>
                                      <p class="text-muted">載入中...</p>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </main>
      </div>
  </div>

  <!-- 新增會員 Modal -->
  <div class="modal fade" id="addMemberModal" tabindex="-1">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">新增會員</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="addMemberForm">
                      <div class="mb-3">
                          <label for="memberName" class="form-label">姓名 *</label>
                          <input type="text" class="form-control" id="memberName" name="name" required>
                      </div>
                      <div class="mb-3">
                          <label for="memberPhone" class="form-label">電話</label>
                          <input type="tel" class="form-control" id="memberPhone" name="phone">
                      </div>
                      <div class="mb-3">
                          <label for="memberEmail" class="form-label">Email</label>
                          <input type="email" class="form-control" id="memberEmail" name="email">
                      </div>
                      <div class="mb-3">
                          <label for="memberAddress" class="form-label">地址</label>
                          <textarea class="form-control" id="memberAddress" name="address" rows="3"></textarea>
                      </div>
                      <div class="mb-3">
                          <label for="memberBirthdate" class="form-label">生日</label>
                          <input type="date" class="form-control" id="memberBirthdate" name="birthdate">
                      </div>
                      <div class="mb-3">
                          <label for="memberNotes" class="form-label">備註</label>
                          <textarea class="form-control" id="memberNotes" name="notes" rows="2"></textarea>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="addMember()">新增</button>
              </div>
          </div>
      </div>
  </div>

  <!-- 新增收入 Modal -->
  <div class="modal fade" id="addIncomeModal" tabindex="-1">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">新增收入</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="addIncomeForm">
                      <div class="mb-3">
                          <label for="incomeDate" class="form-label">日期 *</label>
                          <input type="date" class="form-control" id="incomeDate" name="date" required>
                      </div>
                      <div class="mb-3">
                          <label for="incomeDescription" class="form-label">項目描述 *</label>
                          <input type="text" class="form-control" id="incomeDescription" name="description" required>
                      </div>
                      <div class="mb-3">
                          <label for="incomeAmount" class="form-label">金額 *</label>
                          <input type="number" class="form-control" id="incomeAmount" name="amount" step="0.01" required>
                      </div>
                      <div class="mb-3">
                          <label for="incomeAccount" class="form-label">會計科目</label>
                          <select class="form-control" id="incomeAccount" name="account">
                              <option value="">請選擇</option>
                              <option value="income_membership">會員費收入</option>
                              <option value="income_donation">捐款收入</option>
                              <option value="income_activity">活動收入</option>
                              <option value="income_other">其他收入</option>
                          </select>
                      </div>
                      <div class="mb-3">
                          <label for="incomeBankAccount" class="form-label">銀行帳戶</label>
                          <select class="form-control" id="incomeBankAccount" name="bankAccount">
                              <option value="">請選擇</option>
                          </select>
                      </div>
                      <div class="mb-3">
                          <label for="incomeNotes" class="form-label">備註</label>
                          <textarea class="form-control" id="incomeNotes" name="notes" rows="2"></textarea>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="addIncome()">新增</button>
              </div>
          </div>
      </div>
  </div>

  <!-- 新增支出 Modal -->
  <div class="modal fade" id="addExpenseModal" tabindex="-1">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">新增支出</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="addExpenseForm">
                      <div class="mb-3">
                          <label for="expenseDate" class="form-label">日期 *</label>
                          <input type="date" class="form-control" id="expenseDate" name="date" required>
                      </div>
                      <div class="mb-3">
                          <label for="expenseDescription" class="form-label">項目描述 *</label>
                          <input type="text" class="form-control" id="expenseDescription" name="description" required>
                      </div>
                      <div class="mb-3">
                          <label for="expenseAmount" class="form-label">金額 *</label>
                          <input type="number" class="form-control" id="expenseAmount" name="amount" step="0.01" required>
                      </div>
                      <div class="mb-3">
                          <label for="expenseAccount" class="form-label">會計科目</label>
                          <select class="form-control" id="expenseAccount" name="account">
                              <option value="">請選擇</option>
                              <option value="expense_activity">活動支出</option>
                              <option value="expense_admin">行政支出</option>
                              <option value="expense_equipment">設備支出</option>
                              <option value="expense_other">其他支出</option>
                          </select>
                      </div>
                      <div class="mb-3">
                          <label for="expenseBankAccount" class="form-label">銀行帳戶</label>
                          <select class="form-control" id="expenseBankAccount" name="bankAccount">
                              <option value="">請選擇</option>
                          </select>
                      </div>
                      <div class="mb-3">
                          <label for="expenseApplicant" class="form-label">申請人</label>
                          <input type="text" class="form-control" id="expenseApplicant" name="applicant">
                      </div>
                      <div class="mb-3">
                          <label for="expenseNotes" class="form-label">備註</label>
                          <textarea class="form-control" id="expenseNotes" name="notes" rows="2"></textarea>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="addExpense()">新增</button>
              </div>
          </div>
      </div>
  </div>

  <!-- 新增銀行帳戶 Modal -->
  <div class="modal fade" id="addAccountModal" tabindex="-1">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">新增銀行帳戶</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="addAccountForm">
                      <div class="mb-3">
                          <label for="bankName" class="form-label">銀行名稱 *</label>
                          <input type="text" class="form-control" id="bankName" name="bankName" required>
                      </div>
                      <div class="mb-3">
                          <label for="accountName" class="form-label">帳戶名稱 *</label>
                          <input type="text" class="form-control" id="accountName" name="accountName" required>
                      </div>
                      <div class="mb-3">
                          <label for="accountNumber" class="form-label">帳號 *</label>
                          <input type="text" class="form-control" id="accountNumber" name="accountNumber" required>
                      </div>
                      <div class="mb-3">
                          <label for="initialBalance" class="form-label">初始餘額</label>
                          <input type="number" class="form-control" id="initialBalance" name="initialBalance" step="0.01" value="0">
                      </div>
                      <div class="mb-3">
                          <label for="accountNotes" class="form-label">備註</label>
                          <textarea class="form-control" id="accountNotes" name="notes" rows="2"></textarea>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="addBankAccount()">新增</button>
              </div>
          </div>
      </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
      // API 基礎 URL - 請替換為您的 Google Apps Script URL
      const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwS_U60FXGHFbdiF48knE1bi3EJxM_OFFNrmca1qWzDiXc6NKmqdpycXF0j0yz8UHy1/exec';

      // API 呼叫函數
      async function apiCall(action, data = {}) {
          try {
              const params = new URLSearchParams({
                  action: action,
                  data: JSON.stringify(data),
                  _: Date.now()
              });
              
              const response = await fetch(`${API_BASE_URL}?${params}`, {
                  method: 'GET',
                  headers: {
                      'Accept': 'application/json',
                  }
              });
              
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              const result = await response.json();
              return result;
          } catch (error) {
              console.error('API呼叫錯誤:', error);
              throw new Error('無法連接到伺服器，請檢查網路連線或聯絡系統管理員');
          }
      }

      // 初始化應用程式
      async function initializeApp() {
          try {
              showLoading(true);
              await loadSystemSettings();
              await loadDashboardData();
              await loadBankAccountOptions();
              console.log('系統初始化完成');
          } catch (error) {
              console.error('初始化錯誤:', error);
              showAlert('系統初始化失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      // 載入儀表板資料
      async function loadDashboardData() {
          try {
              const [incomeStats, expenseStats, memberStats, accountStats] = await Promise.all([
                  apiCall('getIncomeStatistics', { period: 'month' }),
                  apiCall('getExpensesStatistics', { period: 'month' }),
                  apiCall('getMembers'),
                  apiCall('getBankAccounts')
              ]);
              
              document.getElementById('monthlyIncome').textContent = 
                  formatCurrency(incomeStats.data?.total || 0);
              document.getElementById('monthlyExpenses').textContent = 
                  formatCurrency(expenseStats.data?.total || 0);
              document.getElementById('totalMembers').textContent = 
                  memberStats.data?.length || 0;
              document.getElementById('totalAccounts').textContent = 
                  accountStats.data?.length || 0;
                  
          } catch (error) {
              console.error('載入儀表板資料錯誤:', error);
              showAlert('載入儀表板資料失敗: ' + error.message, 'warning');
          }
      }

      // 載入會員資料
      async function loadMembersData() {
          try {
              const result = await apiCall('getMembers');
              
              if (result.success) {
                  displayMembersTable(result.data);
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('載入會員資料錯誤:', error);
              showAlert('載入會員資料失敗: ' + error.message, 'danger');
              document.getElementById('membersTableBody').innerHTML = 
                  '<tr><td colspan="7" class="text-center text-danger">載入失敗</td></tr>';
          }
      }

      // 顯示會員表格
      function displayMembersTable(members) {
          const tbody = document.getElementById('membersTableBody');
          
          if (members.length === 0) {
              tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暫無會員資料</td></tr>';
              return;
          }
          
          tbody.innerHTML = members.map(member => `
              <tr>
                  <td>${member.id}</td>
                  <td>${member.name}</td>
                  <td>${member.phone || '-'}</td>
                  <td>${member.email || '-'}</td>
                  <td>
                      <span class="badge ${member.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                          ${member.status === 'active' ? '正常' : '停用'}
                      </span>
                  </td>
                  <td>${member.joinDate}</td>
                  <td>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteMemberConfirm('${member.id}')">
                          <i class="fas fa-trash"></i>
                      </button>
                  </td>
              </tr>
          `).join('');
      }

      // 載入收入資料
      async function loadIncomeData() {
          try {
              const result = await apiCall('getIncome');
              
              if (result.success) {
                  displayIncomeTable(result.data);
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('載入收入資料錯誤:', error);
              showAlert('載入收入資料失敗: ' + error.message, 'danger');
              document.getElementById('incomeTableBody').innerHTML = 
                  '<tr><td colspan="7" class="text-center text-danger">載入失敗</td></tr>';
          }
      }

      // 顯示收入表格
      function displayIncomeTable(income) {
          const tbody = document.getElementById('incomeTableBody');
          
          if (income.length === 0) {
              tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暫無收入資料</td></tr>';
              return;
          }
          
          tbody.innerHTML = income.map(item => `
              <tr>
                  <td>${item.date}</td>
                  <td>${item.description}</td>
                  <td>${formatCurrency(item.amount)}</td>
                  <td>${getAccountName(item.account)}</td>
                  <td>${item.bankAccount || '-'}</td>
                  <td>
                      <span class="badge bg-success">已確認</span>
                  </td>
                  <td>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteIncomeConfirm('${item.id}')">
                          <i class="fas fa-trash"></i>
                      </button>
                  </td>
              </tr>
          `).join('');
      }

      // 載入支出資料
      async function loadExpensesData() {
          try {
              const result = await apiCall('getExpenses');
              
              if (result.success) {
                  displayExpensesTable(result.data);
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('載入支出資料錯誤:', error);
              showAlert('載入支出資料失敗: ' + error.message, 'danger');
              document.getElementById('expensesTableBody').innerHTML = 
                  '<tr><td colspan="8" class="text-center text-danger">載入失敗</td></tr>';
          }
      }

      // 顯示支出表格
      function displayExpensesTable(expenses) {
          const tbody = document.getElementById('expensesTableBody');
          
          if (expenses.length === 0) {
              tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">暫無支出資料</td></tr>';
              return;
          }
          
          tbody.innerHTML = expenses.map(item => `
              <tr>
                  <td>${item.date}</td>
                  <td>${item.description}</td>
                  <td>${formatCurrency(item.amount)}</td>
                  <td>${getAccountName(item.account)}</td>
                  <td>${item.bankAccount || '-'}</td>
                  <td>${item.applicant || '-'}</td>
                  <td>
                      <span class="badge ${getStatusBadgeClass(item.status)}">
                          ${getStatusText(item.status)}
                      </span>
                  </td>
                  <td>
                      ${item.status === 'pending' ? 
                          `<button class="btn btn-sm btn-outline-success me-1" onclick="approveExpenseConfirm('${item.id}')">
                              <i class="fas fa-check"></i>
                          </button>` : ''}
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteExpenseConfirm('${item.id}')">
                          <i class="fas fa-trash"></i>
                      </button>
                  </td>
              </tr>
          `).join('');
      }

      // 載入銀行帳戶資料
      async function loadBankAccountsData() {
          try {
              const result = await apiCall('getBankAccounts');
              
              if (result.success) {
                  displayAccountsTable(result.data);
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('載入銀行帳戶資料錯誤:', error);
              showAlert('載入銀行帳戶資料失敗: ' + error.message, 'danger');
              document.getElementById('accountsTableBody').innerHTML = 
                  '<tr><td colspan="6" class="text-center text-danger">載入失敗</td></tr>';
          }
      }

      // 顯示銀行帳戶表格
      function displayAccountsTable(accounts) {
          const tbody = document.getElementById('accountsTableBody');
          
          if (accounts.length === 0) {
              tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">暫無帳戶資料</td></tr>';
              return;
          }
          
          tbody.innerHTML = accounts.map(account => `
              <tr>
                  <td>${account.bankName}</td>
                  <td>${account.accountName}</td>
                  <td>${account.accountNumber}</td>
                  <td>${formatCurrency(account.balance)}</td>
                  <td>
                      <span class="badge ${account.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                          ${account.status === 'active' ? '啟用' : '停用'}
                      </span>
                  </td>
                  <td>
                      <button class="btn btn-sm btn-outline-primary me-1" onclick="toggleAccountStatus('${account.id}')">
                          <i class="fas fa-toggle-${account.status === 'active' ? 'on' : 'off'}"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteAccountConfirm('${account.id}')">
                          <i class="fas fa-trash"></i>
                      </button>
                  </td>
              </tr>
          `).join('');
      }

      // 載入銀行帳戶選項
      async function loadBankAccountOptions() {
          try {
              const result = await apiCall('getBankAccountOptions');
              
              if (result.success) {
                  const incomeSelect = document.getElementById('incomeBankAccount');
                  const expenseSelect = document.getElementById('expenseBankAccount');
                  
                  const options = result.data.map(account => 
                      `<option value="${account.id}">${account.name}</option>`
                  ).join('');
                  
                  incomeSelect.innerHTML = '<option value="">請選擇</option>' + options;
                  expenseSelect.innerHTML = '<option value="">請選擇</option>' + options;
              }
          } catch (error) {
              console.error('載入銀行帳戶選項錯誤:', error);
          }
      }

      // 載入系統設定
      async function loadSystemSettings() {
          try {
              const result = await apiCall('getOrganizationInfo');
              
              if (result.success && result.data) {
                  const orgInfo = result.data;
                  document.getElementById('orgName').value = orgInfo.name || '';
                  document.getElementById('orgAddress').value = orgInfo.address || '';
                  document.getElementById('orgPhone').value = orgInfo.phone || '';
                  document.getElementById('orgEmail').value = orgInfo.email || '';
                  document.getElementById('orgTaxId').value = orgInfo.taxId || '';
              }
          } catch (error) {
              console.error('載入系統設定錯誤:', error);
              showAlert('載入系統設定失敗: ' + error.message, 'warning');
          }
      }

      // Modal 顯示函數
      function showAddMemberModal() {
          const modal = new bootstrap.Modal(document.getElementById('addMemberModal'));
          modal.show();
      }

      function showAddIncomeModal() {
          const modal = new bootstrap.Modal(document.getElementById('addIncomeModal'));
          modal.show();
      }

      function showAddExpenseModal() {
          const modal = new bootstrap.Modal(document.getElementById('addExpenseModal'));
          modal.show();
      }

      function showAddAccountModal() {
          const modal = new bootstrap.Modal(document.getElementById('addAccountModal'));
          modal.show();
      }

      // CRUD 操作函數
      async function addMember() {
          try {
              const form = document.getElementById('addMemberForm');
              const formData = new FormData(form);
              const memberData = Object.fromEntries(formData.entries());
              
              if (!memberData.name) {
                  showAlert('請輸入會員姓名', 'warning');
                  return;
              }
              
              showLoading(true);
              
              const result = await apiCall('addMember', memberData);
              
              if (result.success) {
                  showAlert('會員新增成功', 'success');
                  bootstrap.Modal.getInstance(document.getElementById('addMemberModal')).hide();
                  form.reset();
                  await loadMembersData();
                  await loadDashboardData();
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('新增會員錯誤:', error);
              showAlert('新增會員失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      async function addIncome() {
          try {
              const form = document.getElementById('addIncomeForm');
              const formData = new FormData(form);
              const incomeData = Object.fromEntries(formData.entries());
              
              if (!incomeData.date || !incomeData.amount || !incomeData.description) {
                  showAlert('請填寫所有必填欄位', 'warning');
                  return;
              }
              
              showLoading(true);
              
              const result = await apiCall('addIncome', incomeData);
              
              if (result.success) {
                  showAlert('收入新增成功', 'success');
                  bootstrap.Modal.getInstance(document.getElementById('addIncomeModal')).hide();
                  form.reset();
                  await loadIncomeData();
                  await loadDashboardData();
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('新增收入錯誤:', error);
              showAlert('新增收入失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      async function addExpense() {
          try {
              const form = document.getElementById('addExpenseForm');
              const formData = new FormData(form);
              const expenseData = Object.fromEntries(formData.entries());
              
              if (!expenseData.date || !expenseData.amount || !expenseData.description) {
                  showAlert('請填寫所有必填欄位', 'warning');
                  return;
              }
              
              showLoading(true);
              
              const result = await apiCall('addExpense', expenseData);
              
              if (result.success) {
                  showAlert('支出新增成功', 'success');
                  bootstrap.Modal.getInstance(document.getElementById('addExpenseModal')).hide();
                  form.reset();
                  await loadExpensesData();
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('新增支出錯誤:', error);
              showAlert('新增支出失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      async function addBankAccount() {
          try {
              const form = document.getElementById('addAccountForm');
              const formData = new FormData(form);
              const accountData = Object.fromEntries(formData.entries());
              
              if (!accountData.bankName || !accountData.accountName || !accountData.accountNumber) {
                  showAlert('請填寫所有必填欄位', 'warning');
                  return;
              }
              
              showLoading(true);
              
              const result = await apiCall('addBankAccount', accountData);
              
              if (result.success) {
                  showAlert('銀行帳戶新增成功', 'success');
                  bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
                  form.reset();
                  await loadBankAccountsData();
                  await loadBankAccountOptions();
                  await loadDashboardData();
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('新增銀行帳戶錯誤:', error);
              showAlert('新增銀行帳戶失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      // 刪除確認函數
      function deleteMemberConfirm(id) {
          if (confirm('確定要刪除此會員嗎？此操作無法復原。')) {
              deleteMember(id);
          }
      }

      function deleteIncomeConfirm(id) {
          if (confirm('確定要刪除此收入記錄嗎？此操作無法復原。')) {
              deleteIncome(id);
          }
      }

      function deleteExpenseConfirm(id) {
          if (confirm('確定要刪除此支出記錄嗎？此操作無法復原。')) {
              deleteExpense(id);
          }
      }

      function deleteAccountConfirm(id) {
          if (confirm('確定要刪除此銀行帳戶嗎？此操作無法復原。')) {
              deleteBankAccount(id);
          }
      }

      function approveExpenseConfirm(id) {
          if (confirm('確定要核准此支出嗎？核准後將從銀行帳戶扣除金額。')) {
              approveExpense(id);
          }
      }

      // 刪除操作函數
      async function deleteMember(id) {
          try {
              showLoading(true);
              const result = await apiCall('deleteMember', { id });
              
              if (result.success) {
                  showAlert('會員刪除成功', 'success');
                  await loadMembersData();
                  await loadDashboardData();
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('刪除會員錯誤:', error);
              showAlert('刪除會員失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      async function deleteIncome(id) {
          try {
              showLoading(true);
              const result = await apiCall('deleteIncome', { id });
              
              if (result.success) {
                  showAlert('收入記錄刪除成功', 'success');
                  await loadIncomeData();
                  await loadDashboardData();
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('刪除收入錯誤:', error);
              showAlert('刪除收入失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      async function deleteExpense(id) {
          try {
              showLoading(true);
              const result = await apiCall('deleteExpense', { id });
              
              if (result.success) {
                  showAlert('支出記錄刪除成功', 'success');
                  await loadExpensesData();
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('刪除支出錯誤:', error);
              showAlert('刪除支出失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      async function deleteBankAccount(id) {
          try {
              showLoading(true);
              const result = await apiCall('deleteBankAccount', { id });
              
              if (result.success) {
                  showAlert('銀行帳戶刪除成功', 'success');
                  await loadBankAccountsData();
                  await loadBankAccountOptions();
                  await loadDashboardData();
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('刪除銀行帳戶錯誤:', error);
              showAlert('刪除銀行帳戶失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      async function approveExpense(id) {
          try {
              showLoading(true);
              const result = await apiCall('approveExpense', { id });
              
              if (result.success) {
                  showAlert('支出核准成功', 'success');
                  await loadExpensesData();
                  await loadDashboardData();
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('核准支出錯誤:', error);
              showAlert('核准支出失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      async function toggleAccountStatus(id) {
          try {
              showLoading(true);
              const result = await apiCall('toggleBankAccountStatus', { id });
              
              if (result.success) {
                  showAlert('帳戶狀態更新成功', 'success');
                  await loadBankAccountsData();
                  await loadBankAccountOptions();
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('更新帳戶狀態錯誤:', error);
              showAlert('更新帳戶狀態失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      // 系統管理函數
      async function saveOrganizationInfo(event) {
          event.preventDefault();
          
          try {
              const form = event.target;
              const formData = new FormData(form);
              const orgData = Object.fromEntries(formData.entries());
              
              showLoading(true);
              
              const result = await apiCall('updateOrganizationInfo', orgData);
              
              if (result.success) {
                  showAlert('組織資訊儲存成功', 'success');
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('儲存組織資訊錯誤:', error);
              showAlert('儲存組織資訊失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      async function createSystemBackup() {
          try {
              if (!confirm('確定要建立系統備份嗎？這可能需要一些時間。')) {
                  return;
              }
              
              showLoading(true);
              const result = await apiCall('createBackup');
              
              if (result.success) {
                  showAlert('系統備份建立成功', 'success');
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('建立備份錯誤:', error);
              showAlert('建立備份失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      async function cleanupSystemData() {
          try {
              if (!confirm('確定要清理系統資料嗎？這將清除30天前的系統記錄。')) {
                  return;
              }
              
              showLoading(true);
              const result = await apiCall('cleanupSystem');
              
              if (result.success) {
                  showAlert('系統清理完成', 'success');
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('系統清理錯誤:', error);
              showAlert('系統清理失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      async function resetSystemSettings() {
          try {
              if (!confirm('確定要重置系統設定嗎？這將恢復所有設定為預設值。')) {
                  return;
              }
              
              showLoading(true);
              const result = await apiCall('resetSettings');
              
              if (result.success) {
                  showAlert('系統設定重置成功', 'success');
                  await loadSystemSettings();
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('重置設定錯誤:', error);
              showAlert('重置設定失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      // 報表生成函數
      async function generateFinancialReport() {
          try {
              showLoading(true);
              const result = await apiCall('getFinancialReport');
              
              if (result.success) {
                  displayFinancialReport(result.data);
                  showAlert('財務報表生成成功', 'success');
              } else {
                  throw new Error(result.message);
              }
          } catch (error) {
              console.error('生成報表錯誤:', error);
              showAlert('生成報表失敗: ' + error.message, 'danger');
          } finally {
              showLoading(false);
          }
      }

      function displayFinancialReport(reportData) {
          const reportContent = document.getElementById('reportContent');
          
          reportContent.innerHTML = `
              <div class="row">
                  <div class="col-md-6">
                      <h5>財務概況 (${reportData.period})</h5>
                      <table class="table table-bordered">
                          <tr>
                              <td>總收入</td>
                              <td class="text-end text-success">${formatCurrency(reportData.totalIncome)}</td>
                          </tr>
                          <tr>
                              <td>總支出</td>
                              <td class="text-end text-danger">${formatCurrency(reportData.totalExpenses)}</td>
                          </tr>
                          <tr class="table-primary">
                              <td><strong>淨收入</strong></td>
                              <td class="text-end"><strong>${formatCurrency(reportData.netIncome)}</strong></td>
                          </tr>
                      </table>
                  </div>
                  <div class="col-md-6">
                      <h5>銀行帳戶餘額</h5>
                      <table class="table table-bordered">
                          ${reportData.bankAccounts.map(account => `
                              <tr>
                                  <td>${account.bankName} - ${account.accountName}</td>
                                  <td class="text-end">${formatCurrency(account.balance)}</td>
                              </tr>
                          `).join('')}
                      </table>
                  </div>
              </div>
              <div class="text-muted text-end mt-3">
                  <small>報表生成時間: ${new Date(reportData.generatedTime).toLocaleString('zh-TW')}</small>
              </div>
          `;
      }

      // 頁面切換函數
      function switchPage(pageName) {
          // 隱藏所有頁面
          document.querySelectorAll('.page-content').forEach(page => {
              page.classList.remove('active');
          });
          
          // 顯示選中的頁面
          document.getElementById(pageName).classList.add('active');
          
          // 更新導航狀態
          document.querySelectorAll('.nav-link').forEach(link => {
              link.classList.remove('active');
          });
          document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
          
          // 載入對應的資料
          switch (pageName) {
              case 'dashboard':
                  loadDashboardData();
                  break;
              case 'members':
                  loadMembersData();
                  break;
              case 'income':
                  loadIncomeData();
                  break;
              case 'expenses':
                  loadExpensesData();
                  break;
              case 'accounts':
                  loadBankAccountsData();
                  break;
              case 'settings':
                  loadSystemSettings();
                  break;
          }
      }

      // 工具函數
      function showLoading(show) {
          const loadingOverlay = document.getElementById('loadingOverlay');
          loadingOverlay.style.display = show ? 'block' : 'none';
      }

      function showAlert(message, type = 'info') {
          const alertContainer = document.getElementById('alertContainer');
          const alertId = 'alert_' + Date.now();
          
          const alertHtml = `
              <div class="alert alert-${type} alert-dismissible fade show" id="${alertId}" role="alert">
                  ${message}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
          `;
          
          alertContainer.insertAdjacentHTML('beforeend', alertHtml);
          
          // 自動移除 alert
          setTimeout(() => {
              const alertElement = document.getElementById(alertId);
              if (alertElement) {
                  bootstrap.Alert.getOrCreateInstance(alertElement).close();
              }
          }, 5000);
      }

      function formatCurrency(amount) {
          return new Intl.NumberFormat('zh-TW', {
              style: 'currency',
              currency: 'TWD',
              minimumFractionDigits: 0
          }).format(amount);
      }

      function getAccountName(accountId) {
          const accountNames = {
              'income_membership': '會員費收入',
              'income_donation': '捐款收入',
              'income_activity': '活動收入',
              'income_other': '其他收入',
              'expense_activity': '活動支出',
              'expense_admin': '行政支出',
              'expense_equipment': '設備支出',
              'expense_other': '其他支出'
          };
          return accountNames[accountId] || accountId || '-';
      }

      function getStatusText(status) {
          const statusTexts = {
              'pending': '待核准',
              'approved': '已核准',
              'rejected': '已拒絕',
              'confirmed': '已確認'
          };
          return statusTexts[status] || status;
      }

      function getStatusBadgeClass(status) {
          const badgeClasses = {
              'pending': 'bg-warning',
              'approved': 'bg-success',
              'rejected': 'bg-danger',
              'confirmed': 'bg-success'
          };
          return badgeClasses[status] || 'bg-secondary';
      }

      function toggleSidebar() {
          const sidebar = document.getElementById('sidebar');
          sidebar.classList.toggle('active');
      }

      function refreshDashboard() {
          loadDashboardData();
      }

      // 事件監聽器
      document.addEventListener('DOMContentLoaded', function() {
          // 導航點擊事件
          document.querySelectorAll('[data-page]').forEach(link => {
              link.addEventListener('click', function(e) {
                  e.preventDefault();
                  const pageName = this.getAttribute('data-page');
                  switchPage(pageName);
              });
          });

          // 設置今天的日期為預設值
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('incomeDate').value = today;
          document.getElementById('expenseDate').value = today;

          // 初始化應用程式
          initializeApp();
      });

      // 視窗大小改變時隱藏側邊欄
      window.addEventListener('resize', function() {
          if (window.innerWidth >= 768) {
              document.getElementById('sidebar').classList.remove('active');
          }
      });

      // 點擊主內容區域時隱藏側邊欄（手機版）
      document.getElementById('mainContent').addEventListener('click', function() {
          if (window.innerWidth < 768) {
              document.getElementById('sidebar').classList.remove('active');
          }
      });
  </script>
</body>
</html>
