<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>非營利組織財務管理系統</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Microsoft JhengHei', '微軟正黑體', Arial, sans-serif;
          background-color: #f5f5f5;
          line-height: 1.6;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 20px;
      }

      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          border-radius: 10px;
          margin-bottom: 30px;
          text-align: center;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }

      .header h1 {
          font-size: 2.5em;
          margin-bottom: 10px;
      }

      .header p {
          font-size: 1.1em;
          opacity: 0.9;
      }

      .nav-tabs {
          display: flex;
          background: white;
          border-radius: 10px;
          overflow: hidden;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          margin-bottom: 30px;
          flex-wrap: wrap;
      }

      .nav-tab {
          flex: 1;
          padding: 15px 20px;
          background: white;
          border: none;
          cursor: pointer;
          font-size: 16px;
          font-weight: 500;
          color: #666;
          transition: all 0.3s ease;
          border-bottom: 3px solid transparent;
          min-width: 120px;
      }

      .nav-tab:hover {
          background: #f8f9fa;
          color: #333;
      }

      .nav-tab.active {
          background: #667eea;
          color: white;
          border-bottom-color: #5a6fd8;
      }

      .tab-content {
          display: none;
          background: white;
          padding: 30px;
          border-radius: 10px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .tab-content.active {
          display: block;
      }

      .form-section {
          margin-bottom: 40px;
      }

      .form-section h3 {
          color: #333;
          margin-bottom: 20px;
          padding-bottom: 10px;
          border-bottom: 2px solid #667eea;
          font-size: 1.3em;
      }

      .form-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 20px;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
          width: 100%;
          padding: 12px;
          border: 2px solid #e1e5e9;
          border-radius: 6px;
          font-size: 14px;
          transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
          padding: 12px 24px;
          border: none;
          border-radius: 6px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          margin-right: 10px;
          margin-bottom: 10px;
      }

      .btn-primary {
          background: #667eea;
          color: white;
      }

      .btn-primary:hover {
          background: #5a6fd8;
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
          background: #6c757d;
          color: white;
      }

      .btn-secondary:hover {
          background: #5a6268;
      }

      .btn-success {
          background: #28a745;
          color: white;
      }

      .btn-success:hover {
          background: #218838;
      }

      .btn-danger {
          background: #dc3545;
          color: white;
      }

      .btn-danger:hover {
          background: #c82333;
      }

      .alert {
          padding: 15px;
          margin: 20px 0;
          border-radius: 6px;
          font-weight: 500;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .alert-error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .alert-info {
          background: #d1ecf1;
          color: #0c5460;
          border: 1px solid #bee5eb;
      }

      .data-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
          background: white;
          border-radius: 6px;
          overflow: hidden;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .data-table th,
      .data-table td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #e1e5e9;
      }

      .data-table th {
          background: #f8f9fa;
          font-weight: 600;
          color: #333;
      }

      .data-table tr:hover {
          background: #f8f9fa;
      }

      .loading {
          display: none;
          text-align: center;
          padding: 20px;
          color: #666;
      }

      .loading.show {
          display: block;
      }

      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
      }

      .stat-card {
          background: white;
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          text-align: center;
          border-left: 4px solid #667eea;
      }

      .stat-card h4 {
          color: #666;
          font-size: 0.9em;
          margin-bottom: 10px;
          text-transform: uppercase;
          letter-spacing: 1px;
      }

      .stat-card .stat-value {
          font-size: 2em;
          font-weight: bold;
          color: #333;
      }

      .search-box {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
          flex-wrap: wrap;
      }

      .search-box input,
      .search-box select {
          flex: 1;
          min-width: 200px;
      }

      .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
      }

      .modal-content {
          background-color: white;
          margin: 5% auto;
          padding: 30px;
          border-radius: 10px;
          width: 90%;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
      }

      .close {
          color: #aaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
      }

      .close:hover {
          color: #000;
      }

      @media (max-width: 768px) {
          .container {
              padding: 10px;
          }
          
          .nav-tabs {
              flex-direction: column;
          }
          
          .nav-tab {
              flex: none;
          }
          
          .form-grid {
              grid-template-columns: 1fr;
          }
          
          .stats-grid {
              grid-template-columns: 1fr;
          }
      }

      .progress-bar {
          width: 100%;
          height: 20px;
          background-color: #e1e5e9;
          border-radius: 10px;
          overflow: hidden;
          margin: 10px 0;
      }

      .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, #667eea, #764ba2);
          width: 0%;
          transition: width 0.3s ease;
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>💰 財務管理系統</h1>
          <p>非營利組織專用財務管理解決方案</p>
      </div>

      <div class="nav-tabs">
          <button class="nav-tab active" onclick="showTab('dashboard')">📊 儀表板</button>
          <button class="nav-tab" onclick="showTab('members')">👥 會員管理</button>
          <button class="nav-tab" onclick="showTab('income')">💰 收入管理</button>
          <button class="nav-tab" onclick="showTab('expenses')">💸 支出管理</button>
          <button class="nav-tab" onclick="showTab('receipts')">🧾 電子收據</button>
          <button class="nav-tab" onclick="showTab('accounts')">📋 會計科目</button>
          <button class="nav-tab" onclick="showTab('banks')">🏦 銀行帳戶</button>
          <button class="nav-tab" onclick="showTab('reports')">📈 報表分析</button>
          <button class="nav-tab" onclick="showTab('settings')">⚙️ 系統設定</button>
      </div>

      <!-- 儀表板 -->
      <div id="dashboard" class="tab-content active">
          <div class="stats-grid">
              <div class="stat-card">
                  <h4>總會員數</h4>
                  <div class="stat-value" id="totalMembers">-</div>
              </div>
              <div class="stat-card">
                  <h4>本月收入</h4>
                  <div class="stat-value" id="monthlyIncome">-</div>
              </div>
              <div class="stat-card">
                  <h4>本月支出</h4>
                  <div class="stat-value" id="monthlyExpenses">-</div>
              </div>
              <div class="stat-card">
                  <h4>帳戶餘額</h4>
                  <div class="stat-value" id="totalBalance">-</div>
              </div>
          </div>
          
          <div class="form-section">
              <h3>系統狀態</h3>
              <button class="btn btn-primary" onclick="refreshDashboard()">🔄 重新整理</button>
              <button class="btn btn-secondary" onclick="checkSystemHealth()">🏥 系統健康檢查</button>
              <div id="systemStatus"></div>
          </div>
      </div>

      <!-- 會員管理 -->
      <div id="members" class="tab-content">
          <div class="form-section">
              <h3>新增會員</h3>
              <form id="memberForm" class="form-grid">
                  <div class="form-group">
                      <label for="memberName">姓名 *</label>
                      <input type="text" id="memberName" required>
                  </div>
                  <div class="form-group">
                      <label for="memberPhone">電話 *</label>
                      <input type="tel" id="memberPhone" required>
                  </div>
                  <div class="form-group">
                      <label for="memberEmail">電子郵件</label>
                      <input type="email" id="memberEmail">
                  </div>
                  <div class="form-group">
                      <label for="memberAddress">地址</label>
                      <textarea id="memberAddress" rows="3"></textarea>
                  </div>
                  <div class="form-group">
                      <label for="memberBirthday">生日</label>
                      <input type="date" id="memberBirthday">
                  </div>
                  <div class="form-group">
                      <label for="memberType">會員類型</label>
                      <select id="memberType">
                          <option value="一般會員">一般會員</option>
                          <option value="贊助會員">贊助會員</option>
                          <option value="榮譽會員">榮譽會員</option>
                      </select>
                  </div>
              </form>
              <button class="btn btn-primary" onclick="addMember()">➕ 新增會員</button>
              <button class="btn btn-secondary" onclick="clearMemberForm()">🗑️ 清除表單</button>
          </div>

          <div class="form-section">
              <h3>會員列表</h3>
              <div class="search-box">
                  <input type="text" id="memberSearch" placeholder="搜尋會員姓名、電話或郵件">
                  <select id="memberTypeFilter">
                      <option value="">所有類型</option>
                      <option value="一般會員">一般會員</option>
                      <option value="贊助會員">贊助會員</option>
                      <option value="榮譽會員">榮譽會員</option>
                  </select>
                  <button class="btn btn-primary" onclick="searchMembers()">🔍 搜尋</button>
                  <button class="btn btn-success" onclick="loadMembers()">📋 載入全部</button>
              </div>
              <div class="loading" id="membersLoading">載入中...</div>
              <div id="membersTable"></div>
          </div>
      </div>

      <!-- 收入管理 -->
      <div id="income" class="tab-content">
          <div class="form-section">
              <h3>新增收入記錄</h3>
              <form id="incomeForm" class="form-grid">
                  <div class="form-group">
                      <label for="incomeDate">日期 *</label>
                      <input type="date" id="incomeDate" required>
                  </div>
                  <div class="form-group">
                      <label for="incomePayer">付款人 *</label>
                      <input type="text" id="incomePayer" required>
                  </div>
                  <div class="form-group">
                      <label for="incomeAmount">金額 *</label>
                      <input type="number" id="incomeAmount" min="0" step="0.01" required>
                  </div>
                  <div class="form-group">
                      <label for="incomePurpose">用途 *</label>
                      <input type="text" id="incomePurpose" required>
                  </div>
                  <div class="form-group">
                      <label for="incomeMethod">付款方式</label>
                      <select id="incomeMethod">
                          <option value="現金">現金</option>
                          <option value="轉帳">轉帳</option>
                          <option value="支票">支票</option>
                          <option value="信用卡">信用卡</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="incomeAccount">會計科目</label>
                      <select id="incomeAccount">
                          <option value="捐款收入">捐款收入</option>
                          <option value="會費收入">會費收入</option>
                          <option value="活動收入">活動收入</option>
                          <option value="其他收入">其他收入</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="incomeBank">銀行帳戶</label>
                      <select id="incomeBank">
                          <option value="">請選擇銀行帳戶</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="incomeNotes">備註</label>
                      <textarea id="incomeNotes" rows="2"></textarea>
                  </div>
              </form>
              <button class="btn btn-primary" onclick="addIncome()">➕ 新增收入</button>
              <button class="btn btn-secondary" onclick="clearIncomeForm()">🗑️ 清除表單</button>
          </div>

          <div class="form-section">
              <h3>收入記錄</h3>
              <div class="search-box">
                  <input type="date" id="incomeStartDate" placeholder="開始日期">
                  <input type="date" id="incomeEndDate" placeholder="結束日期">
                  <input type="text" id="incomePayerSearch" placeholder="付款人">
                  <select id="incomeMethodFilter">
                      <option value="">所有付款方式</option>
                      <option value="現金">現金</option>
                      <option value="轉帳">轉帳</option>
                      <option value="支票">支票</option>
                      <option value="信用卡">信用卡</option>
                  </select>
                  <button class="btn btn-primary" onclick="searchIncome()">🔍 搜尋</button>
                  <button class="btn btn-success" onclick="loadIncome()">📋 載入全部</button>
              </div>
              <div class="loading" id="incomeLoading">載入中...</div>
              <div id="incomeTable"></div>
          </div>
      </div>

      <!-- 支出管理 -->
      <div id="expenses" class="tab-content">
          <div class="form-section">
              <h3>新增支出記錄</h3>
              <form id="expenseForm" class="form-grid">
                  <div class="form-group">
                      <label for="expenseDate">日期 *</label>
                      <input type="date" id="expenseDate" required>
                  </div>
                  <div class="form-group">
                      <label for="expenseVendor">收款人/廠商 *</label>
                      <input type="text" id="expenseVendor" required>
                  </div>
                  <div class="form-group">
                      <label for="expenseAmount">金額 *</label>
                      <input type="number" id="expenseAmount" min="0" step="0.01" required>
                  </div>
                  <div class="form-group">
                      <label for="expensePurpose">用途 *</label>
                      <input type="text" id="expensePurpose" required>
                  </div>
                  <div class="form-group">
                      <label for="expenseMethod">付款方式</label>
                      <select id="expenseMethod">
                          <option value="現金">現金</option>
                          <option value="轉帳">轉帳</option>
                          <option value="支票">支票</option>
                          <option value="信用卡">信用卡</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="expenseAccount">會計科目</label>
                      <select id="expenseAccount">
                          <option value="辦公費用">辦公費用</option>
                          <option value="活動費用">活動費用</option>
                          <option value="人事費用">人事費用</option>
                          <option value="其他費用">其他費用</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="expenseBank">銀行帳戶</label>
                      <select id="expenseBank">
                          <option value="">請選擇銀行帳戶</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="expenseNotes">備註</label>
                      <textarea id="expenseNotes" rows="2"></textarea>
                  </div>
              </form>
              <button class="btn btn-primary" onclick="addExpense()">➕ 新增支出</button>
              <button class="btn btn-secondary" onclick="clearExpenseForm()">🗑️ 清除表單</button>
          </div>

          <div class="form-section">
              <h3>支出記錄</h3>
              <div class="search-box">
                  <input type="date" id="expenseStartDate" placeholder="開始日期">
                  <input type="date" id="expenseEndDate" placeholder="結束日期">
                  <input type="text" id="expenseVendorSearch" placeholder="收款人/廠商">
                  <select id="expenseMethodFilter">
                      <option value="">所有付款方式</option>
                      <option value="現金">現金</option>
                      <option value="轉帳">轉帳</option>
                      <option value="支票">支票</option>
                      <option value="信用卡">信用卡</option>
                  </select>
                  <button class="btn btn-primary" onclick="searchExpenses()">🔍 搜尋</button>
                  <button class="btn btn-success" onclick="loadExpenses()">📋 載入全部</button>
              </div>
              <div class="loading" id="expensesLoading">載入中...</div>
              <div id="expensesTable"></div>
          </div>
      </div>

      <!-- 電子收據 -->
      <div id="receipts" class="tab-content">
          <div class="form-section">
              <h3>生成電子收據</h3>
              <form id="receiptForm" class="form-grid">
                  <div class="form-group">
                      <label for="receiptIncomeId">選擇收入記錄 *</label>
                      <select id="receiptIncomeId" required>
                          <option value="">請選擇收入記錄</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="receiptNumber">收據編號 *</label>
                      <input type="text" id="receiptNumber" required>
                  </div>
                  <div class="form-group">
                      <label for="receiptDate">開立日期</label>
                      <input type="date" id="receiptDate">
                  </div>
              </form>
              <button class="btn btn-primary" onclick="generateReceipt()">📄 生成收據</button>
              <button class="btn btn-secondary" onclick="generateReceiptNumber()">🔢 自動編號</button>
          </div>

          <div class="form-section">
              <h3>收據管理</h3>
              <div class="search-box">
                  <input type="text" id="receiptSearch" placeholder="搜尋收據編號或付款人">
                  <select id="receiptStatusFilter">
                      <option value="">所有狀態</option>
                      <option value="未發送">未發送</option>
                      <option value="已發送">已發送</option>
                  </select>
                  <button class="btn btn-primary" onclick="searchReceipts()">🔍 搜尋</button>
                  <button class="btn btn-success" onclick="loadReceipts()">📋 載入全部</button>
              </div>
              <div class="loading" id="receiptsLoading">載入中...</div>
              <div id="receiptsTable"></div>
          </div>
      </div>

      <!-- 會計科目 -->
      <div id="accounts" class="tab-content">
          <div class="form-section">
              <h3>新增會計科目</h3>
              <form id="accountForm" class="form-grid">
                  <div class="form-group">
                      <label for="accountCode">科目代碼 *</label>
                      <input type="text" id="accountCode" required>
                  </div>
                  <div class="form-group">
                      <label for="accountName">科目名稱 *</label>
                      <input type="text" id="accountName" required>
                  </div>
                  <div class="form-group">
                      <label for="accountType">科目類型</label>
                      <select id="accountType">
                          <option value="收入">收入</option>
                          <option value="支出">支出</option>
                          <option value="資產">資產</option>
                          <option value="負債">負債</option>
                          <option value="權益">權益</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="accountParent">上層科目</label>
                      <select id="accountParent">
                          <option value="">無上層科目</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="accountDescription">說明</label>
                      <textarea id="accountDescription" rows="2"></textarea>
                  </div>
              </form>
              <button class="btn btn-primary" onclick="addAccount()">➕ 新增科目</button>
              <button class="btn btn-secondary" onclick="clearAccountForm()">🗑️ 清除表單</button>
          </div>

          <div class="form-section">
              <h3>會計科目列表</h3>
              <div class="search-box">
                  <input type="text" id="accountSearch" placeholder="搜尋科目代碼或名稱">
                  <select id="accountTypeFilter">
                      <option value="">所有類型</option>
                      <option value="收入">收入</option>
                      <option value="支出">支出</option>
                      <option value="資產">資產</option>
                      <option value="負債">負債</option>
                      <option value="權益">權益</option>
                  </select>
                  <button class="btn btn-primary" onclick="searchAccounts()">🔍 搜尋</button>
                  <button class="btn btn-success" onclick="loadAccounts()">📋 載入全部</button>
              </div>
              <div class="loading" id="accountsLoading">載入中...</div>
              <div id="accountsTable"></div>
          </div>
      </div>

      <!-- 銀行帳戶 -->
      <div id="banks" class="tab-content">
          <div class="form-section">
              <h3>新增銀行帳戶</h3>
              <form id="bankForm" class="form-grid">
                  <div class="form-group">
                      <label for="bankAccountName">帳戶名稱 *</label>
                      <input type="text" id="bankAccountName" required>
                  </div>
                  <div class="form-group">
                      <label for="bankName">銀行名稱 *</label>
                      <input type="text" id="bankName" required>
                  </div>
                  <div class="form-group">
                      <label for="bankBranch">分行名稱</label>
                      <input type="text" id="bankBranch">
                  </div>
                  <div class="form-group">
                      <label for="bankAccountNumber">帳號 *</label>
                      <input type="text" id="bankAccountNumber" required>
                  </div>
                  <div class="form-group">
                      <label for="bankAccountType">帳戶類型</label>
                      <select id="bankAccountType">
                          <option value="活期存款">活期存款</option>
                          <option value="定期存款">定期存款</option>
                          <option value="支票存款">支票存款</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="bankBalance">目前餘額</label>
                      <input type="number" id="bankBalance" min="0" step="0.01" value="0">
                  </div>
                  <div class="form-group">
                      <label for="bankCurrency">幣別</label>
                      <select id="bankCurrency">
                          <option value="TWD">台幣 (TWD)</option>
                          <option value="USD">美元 (USD)</option>
                          <option value="EUR">歐元 (EUR)</option>
                          <option value="JPY">日圓 (JPY)</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="bankDescription">說明</label>
                      <textarea id="bankDescription" rows="2"></textarea>
                  </div>
              </form>
              <button class="btn btn-primary" onclick="addBankAccount()">➕ 新增帳戶</button>
              <button class="btn btn-secondary" onclick="clearBankForm()">🗑️ 清除表單</button>
          </div>

          <div class="form-section">
              <h3>銀行帳戶列表</h3>
              <div class="search-box">
                  <input type="text" id="bankSearch" placeholder="搜尋帳戶名稱或銀行">
                  <select id="bankStatusFilter">
                      <option value="">所有狀態</option>
                      <option value="true">啟用</option>
                      <option value="false">停用</option>
                  </select>
                  <button class="btn btn-primary" onclick="searchBankAccounts()">🔍 搜尋</button>
                  <button class="btn btn-success" onclick="loadBankAccounts()">📋 載入全部</button>
              </div>
              <div class="loading" id="banksLoading">載入中...</div>
              <div id="banksTable"></div>
          </div>
      </div>

      <!-- 報表分析 -->
      <div id="reports" class="tab-content">
          <div class="form-section">
              <h3>財務報表</h3>
              <div class="form-grid">
                  <div class="form-group">
                      <label for="reportStartDate">開始日期</label>
                      <input type="date" id="reportStartDate">
                  </div>
                  <div class="form-group">
                      <label for="reportEndDate">結束日期</label>
                      <input type="date" id="reportEndDate">
                  </div>
                  <div class="form-group">
                      <label for="reportType">報表類型</label>
                      <select id="reportType">
                          <option value="summary">財務摘要</option>
                          <option value="income">收入明細</option>
                          <option value="expense">支出明細</option>
                          <option value="balance">資產負債</option>
                      </select>
                  </div>
              </div>
              <button class="btn btn-primary" onclick="generateReport()">📊 生成報表</button>
              <button class="btn btn-success" onclick="exportReport()">📤 匯出報表</button>
          </div>

          <div class="form-section">
              <h3>報表結果</h3>
              <div class="loading" id="reportsLoading">載入中...</div>
              <div id="reportResults"></div>
          </div>
      </div>

      <!-- 系統設定 -->
      <div id="settings" class="tab-content">
          <div class="form-section">
              <h3>組織資訊設定</h3>
              <form id="orgForm" class="form-grid">
                  <div class="form-group">
                      <label for="orgName">組織名稱</label>
                      <input type="text" id="orgName">
                  </div>
                  <div class="form-group">
                      <label for="orgAddress">組織地址</label>
                      <textarea id="orgAddress" rows="2"></textarea>
                  </div>
                  <div class="form-group">
                      <label for="orgPhone">聯絡電話</label>
                      <input type="tel" id="orgPhone">
                  </div>
                  <div class="form-group">
                      <label for="orgEmail">電子郵件</label>
                      <input type="email" id="orgEmail">
                  </div>
                  <div class="form-group">
                      <label for="orgTaxId">統一編號</label>
                      <input type="text" id="orgTaxId">
                  </div>
              </form>
              <button class="btn btn-primary" onclick="saveOrgSettings()">💾 儲存設定</button>
              <button class="btn btn-secondary" onclick="loadOrgSettings()">🔄 重新載入</button>
          </div>

          <div class="form-section">
              <h3>系統工具</h3>
              <button class="btn btn-success" onclick="backupData()">💾 備份資料</button>
              <button class="btn btn-danger" onclick="confirmDataReset()">🗑️ 重置系統</button>
              <button class="btn btn-secondary" onclick="checkSystemHealth()">🏥 系統檢查</button>
          </div>

          <div class="form-section">
              <h3>API設定</h3>
              <div class="form-group">
                  <label for="apiUrl">API網址</label>
                  <input type="url" id="apiUrl" placeholder="請輸入您的Google Apps Script Web App URL">
                  <small>請在Google Apps Script部署後，將Web App URL貼到這裡</small>
              </div>
              <button class="btn btn-primary" onclick="saveApiUrl()">💾 儲存API網址</button>
              <button class="btn btn-secondary" onclick="testApiConnection()">🔗 測試連線</button>
          </div>
      </div>

      <!-- 結果顯示區域 -->
      <div id="result"></div>
  </div>

  <!-- 模態視窗 -->
  <div id="modal" class="modal">
      <div class="modal-content">
          <span class="close" onclick="closeModal()">&times;</span>
          <div id="modalContent"></div>
      </div>
  </div>

  <script>
      // 全域變數
      let API_URL = localStorage.getItem('apiUrl') || '';
      let currentEditId = null;

      // 初始化
      document.addEventListener('DOMContentLoaded', function() {
          // 設定今天的日期為預設值
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('incomeDate').value = today;
          document.getElementById('expenseDate').value = today;
          document.getElementById('receiptDate').value = today;
          
          // 載入API網址
          if (API_URL) {
              document.getElementById('apiUrl').value = API_URL;
          }
          
          // 初始載入儀表板
          refreshDashboard();
      });

      // 顯示結果訊息
      function showResult(result, duration = 5000) {
          const resultDiv = document.getElementById('result');
          resultDiv.className = 'alert ' + (result.success ? 'alert-success' : 'alert-error');
          resultDiv.innerHTML = `
              <strong>${result.success ? '✅ 成功' : '❌ 錯誤'}</strong><br>
              ${result.message}
              ${result.data ? `<br><small>詳細資訊: ${JSON.stringify(result.data)}</small>` : ''}
          `;
          resultDiv.scrollIntoView({ behavior: 'smooth' });
          
          // 自動隱藏
          setTimeout(() => {
              resultDiv.innerHTML = '';
              resultDiv.className = '';
          }, duration);
      }

      // 顯示載入狀態
      function showLoading(elementId, show = true) {
          const element = document.getElementById(elementId);
          if (element) {
              element.classList.toggle('show', show);
          }
      }

      // API呼叫函數
      async function callAPI(action, data = {}) {
          if (!API_URL) {
              showResult({
                  success: false,
                  message: '請先在系統設定中設定API網址'
              });
              return null;
          }

          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: action,
                      data: data
                  })
              });

              if (!response.ok) {
                  throw new Error(`HTTP錯誤: ${response.status}`);
              }

              const result = await response.json();
              return result;
          } catch (error) {
              console.error('API呼叫錯誤:', error);
              showResult({
                  success: false,
                  message: `網路錯誤: ${error.message}`
              });
              return null;
          }
      }

      // 標籤切換
      function showTab(tabName) {
          // 隱藏所有標籤內容
          const tabs = document.querySelectorAll('.tab-content');
          tabs.forEach(tab => tab.classList.remove('active'));

          // 移除所有標籤按鈕的active類別
          const tabButtons = document.querySelectorAll('.nav-tab');
          tabButtons.forEach(button => button.classList.remove('active'));

          // 顯示選中的標籤
          document.getElementById(tabName).classList.add('active');
          event.target.classList.add('active');

          // 載入對應資料
          switch(tabName) {
              case 'dashboard':
                  refreshDashboard();
                  break;
              case 'members':
                  loadMembers();
                  break;
              case 'income':
                  loadIncome();
                  loadBankAccountsForSelect('incomeBank');
                  break;
              case 'expenses':
                  loadExpenses();
                  loadBankAccountsForSelect('expenseBank');
                  break;
              case 'receipts':
                  loadReceipts();
                  loadIncomeForReceipts();
                  break;
              case 'accounts':
                  loadAccounts();
                  break;
              case 'banks':
                  loadBankAccounts();
                  break;
              case 'settings':
                  loadOrgSettings();
                  break;
          }
      }

      // 儀表板功能
      async function refreshDashboard() {
          showLoading('dashboardLoading', true);
          
          try {
              // 載入統計資料
              const [membersResult, incomeResult, expensesResult, bankResult] = await Promise.all([
                  callAPI('getMembersData'),
                  callAPI('getIncomeData'),
                  callAPI('getExpensesData'),
                  callAPI('getBankAccountsData')
              ]);

              // 更新統計卡片
              if (membersResult && membersResult.success) {
                  document.getElementById('totalMembers').textContent = membersResult.data.length;
              }

              if (incomeResult && incomeResult.success) {
                  const currentMonth = new Date().getMonth();
                  const currentYear = new Date().getFullYear();
                  const monthlyIncome = incomeResult.data
                      .filter(item => {
                          const itemDate = new Date(item['日期']);
                          return itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear;
                      })
                      .reduce((sum, item) => sum + parseFloat(item['金額'] || 0), 0);
                  
                  document.getElementById('monthlyIncome').textContent = `$${monthlyIncome.toLocaleString()}`;
              }

              if (expensesResult && expensesResult.success) {
                  const currentMonth = new Date().getMonth();
                  const currentYear = new Date().getFullYear();
                  const monthlyExpenses = expensesResult.data
                      .filter(item => {
                          const itemDate = new Date(item['日期']);
                          return itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear;
                      })
                      .reduce((sum, item) => sum + parseFloat(item['金額'] || 0), 0);
                  
                  document.getElementById('monthlyExpenses').textContent = `$${monthlyExpenses.toLocaleString()}`;
              }

              if (bankResult && bankResult.success) {
                  const totalBalance = bankResult.data
                      .reduce((sum, account) => sum + parseFloat(account['目前餘額'] || 0), 0);
                  
                  document.getElementById('totalBalance').textContent = `$${totalBalance.toLocaleString()}`;
              }

          } catch (error) {
              console.error('載入儀表板錯誤:', error);
          } finally {
              showLoading('dashboardLoading', false);
          }
      }

      async function checkSystemHealth() {
          const result = await callAPI('health');
          if (result) {
              document.getElementById('systemStatus').innerHTML = `
                  <div class="alert alert-${result.success ? 'success' : 'error'}">
                      <strong>系統狀態:</strong> ${result.message}<br>
                      <strong>時間:</strong> ${result.timestamp || '未知'}<br>
                      <strong>版本:</strong> ${result.version || '未知'}
                  </div>
              `;
          }
      }

      // 會員管理功能
      async function addMember() {
          const memberData = {
              '姓名': document.getElementById('memberName').value,
              '電話': document.getElementById('memberPhone').value,
              '電子郵件': document.getElementById('memberEmail').value,
              '地址': document.getElementById('memberAddress').value,
              '生日': document.getElementById('memberBirthday').value,
              '會員類型': document.getElementById('memberType').value
          };

          const result = await callAPI('addMember', memberData);
          if (result) {
              showResult(result);
              if (result.success) {
                  clearMemberForm();
                  loadMembers();
              }
          }
      }

      function clearMemberForm() {
          document.getElementById('memberForm').reset();
      }

      async function loadMembers() {
          showLoading('membersLoading', true);
          const result = await callAPI('getMembersData');
          showLoading('membersLoading', false);
          
          if (result && result.success) {
              displayMembersTable(result.data);
          }
      }

      function displayMembersTable(members) {
          const tableHtml = `
              <table class="data-table">
                  <thead>
                      <tr>
                          <th>姓名</th>
                          <th>電話</th>
                          <th>電子郵件</th>
                          <th>會員類型</th>
                          <th>加入日期</th>
                          <th>操作</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${members.map(member => `
                          <tr>
                              <td>${member['姓名'] || ''}</td>
                              <td>${member['電話'] || ''}</td>
                              <td>${member['電子郵件'] || ''}</td>
                              <td>${member['會員類型'] || ''}</td>
                              <td>${formatDate(member['加入日期'])}</td>
                              <td>
                                  <button class="btn btn-secondary" onclick="editMember('${member['ID']}')">編輯</button>
                                  <button class="btn btn-danger" onclick="deleteMember('${member['ID']}')">刪除</button>
                              </td>
                          </tr>
                      `).join('')}
                  </tbody>
              </table>
          `;
          document.getElementById('membersTable').innerHTML = tableHtml;
      }

      async function searchMembers() {
          const searchTerm = document.getElementById('memberSearch').value;
          const typeFilter = document.getElementById('memberTypeFilter').value;
          
          showLoading('membersLoading', true);
          const result = await callAPI('getMembersData', {
              search: searchTerm,
              type: typeFilter
          });
          showLoading('membersLoading', false);
          
          if (result && result.success) {
              displayMembersTable(result.data);
          }
      }

      // 收入管理功能
      async function addIncome() {
          const incomeData = {
              '日期': document.getElementById('incomeDate').value,
              '付款人': document.getElementById('incomePayer').value,
              '金額': parseFloat(document.getElementById('incomeAmount').value),
              '用途': document.getElementById('incomePurpose').value,
              '付款方式': document.getElementById('incomeMethod').value,
              '會計科目': document.getElementById('incomeAccount').value,
              '銀行帳戶': document.getElementById('incomeBank').value,
              '備註': document.getElementById('incomeNotes').value
          };

          const result = await callAPI('addIncome', incomeData);
          if (result) {
              showResult(result);
              if (result.success) {
                  clearIncomeForm();
                  loadIncome();
              }
          }
      }

      function clearIncomeForm() {
          document.getElementById('incomeForm').reset();
          document.getElementById('incomeDate').value = new Date().toISOString().split('T')[0];
      }

      async function loadIncome() {
          showLoading('incomeLoading', true);
          const result = await callAPI('getIncomeData');
          showLoading('incomeLoading', false);
          
          if (result && result.success) {
              displayIncomeTable(result.data);
          }
      }

      function displayIncomeTable(income) {
          const tableHtml = `
              <table class="data-table">
                  <thead>
                      <tr>
                          <th>日期</th>
                          <th>付款人</th>
                          <th>金額</th>
                          <th>用途</th>
                          <th>付款方式</th>
                          <th>會計科目</th>
                          <th>操作</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${income.map(item => `
                          <tr>
                              <td>${formatDate(item['日期'])}</td>
                              <td>${item['付款人'] || ''}</td>
                              <td>$${parseFloat(item['金額'] || 0).toLocaleString()}</td>
                              <td>${item['用途'] || ''}</td>
                              <td>${item['付款方式'] || ''}</td>
                              <td>${item['會計科目'] || ''}</td>
                              <td>
                                  <button class="btn btn-secondary" onclick="editIncome('${item['ID']}')">編輯</button>
                                  <button class="btn btn-danger" onclick="deleteIncome('${item['ID']}')">刪除</button>
                              </td>
                          </tr>
                      `).join('')}
                  </tbody>
              </table>
          `;
          document.getElementById('incomeTable').innerHTML = tableHtml;
      }

      async function searchIncome() {
          const startDate = document.getElementById('incomeStartDate').value;
          const endDate = document.getElementById('incomeEndDate').value;
          const payer = document.getElementById('incomePayerSearch').value;
          const method = document.getElementById('incomeMethodFilter').value;
          
          showLoading('incomeLoading', true);
          const result = await callAPI('getIncomeData', {
              startDate: startDate,
              endDate: endDate,
              payer: payer,
              method: method
          });
          showLoading('incomeLoading', false);
          
          if (result && result.success) {
              displayIncomeTable(result.data);
          }
      }

      // 支出管理功能
      async function addExpense() {
          const expenseData = {
              '日期': document.getElementById('expenseDate').value,
              '收款人': document.getElementById('expenseVendor').value,
              '金額': parseFloat(document.getElementById('expenseAmount').value),
              '用途': document.getElementById('expensePurpose').value,
              '付款方式': document.getElementById('expenseMethod').value,
              '會計科目': document.getElementById('expenseAccount').value,
              '銀行帳戶': document.getElementById('expenseBank').value,
              '備註': document.getElementById('expenseNotes').value
          };

          const result = await callAPI('addExpense', expenseData);
          if (result) {
              showResult(result);
              if (result.success) {
                  clearExpenseForm();
                  loadExpenses();
              }
          }
      }

      function clearExpenseForm() {
          document.getElementById('expenseForm').reset();
          document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
      }

      async function loadExpenses() {
          showLoading('expensesLoading', true);
          const result = await callAPI('getExpensesData');
          showLoading('expensesLoading', false);
          
          if (result && result.success) {
              displayExpensesTable(result.data);
          }
      }

      function displayExpensesTable(expenses) {
          const tableHtml = `
              <table class="data-table">
                  <thead>
                      <tr>
                          <th>日期</th>
                          <th>收款人</th>
                          <th>金額</th>
                          <th>用途</th>
                          <th>付款方式</th>
                          <th>會計科目</th>
                          <th>操作</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${expenses.map(item => `
                          <tr>
                              <td>${formatDate(item['日期'])}</td>
                              <td>${item['收款人'] || ''}</td>
                              <td>$${parseFloat(item['金額'] || 0).toLocaleString()}</td>
                              <td>${item['用途'] || ''}</td>
                              <td>${item['付款方式'] || ''}</td>
                              <td>${item['會計科目'] || ''}</td>
                              <td>
                                  <button class="btn btn-secondary" onclick="editExpense('${item['ID']}')">編輯</button>
                                  <button class="btn btn-danger" onclick="deleteExpense('${item['ID']}')">刪除</button>
                              </td>
                          </tr>
                      `).join('')}
                  </tbody>
              </table>
          `;
          document.getElementById('expensesTable').innerHTML = tableHtml;
      }

      async function searchExpenses() {
          const startDate = document.getElementById('expenseStartDate').value;
          const endDate = document.getElementById('expenseEndDate').value;
          const vendor = document.getElementById('expenseVendorSearch').value;
          const method = document.getElementById('expenseMethodFilter').value;
          
          showLoading('expensesLoading', true);
          const result = await callAPI('getExpensesData', {
              startDate: startDate,
              endDate: endDate,
              vendor: vendor,
              method: method
          });
          showLoading('expensesLoading', false);
          
          if (result && result.success) {
              displayExpensesTable(result.data);
          }
      }

      // 電子收據功能
      async function generateReceipt() {
          const receiptData = {
              '收入ID': document.getElementById('receiptIncomeId').value,
              '收據編號': document.getElementById('receiptNumber').value,
              '開立日期': document.getElementById('receiptDate').value
          };

          const result = await callAPI('generateReceipt', receiptData);
          if (result) {
              showResult(result);
              if (result.success) {
                  loadReceipts();
              }
          }
      }

      function generateReceiptNumber() {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const time = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
          
          const receiptNumber = `R${year}${month}${day}${time}`;
          document.getElementById('receiptNumber').value = receiptNumber;
      }

      async function loadReceipts() {
          showLoading('receiptsLoading', true);
          const result = await callAPI('getReceiptsData');
          showLoading('receiptsLoading', false);
          
          if (result && result.success) {
              displayReceiptsTable(result.data);
          }
      }

      function displayReceiptsTable(receipts) {
          const tableHtml = `
              <table class="data-table">
                  <thead>
                      <tr>
                          <th>收據編號</th>
                          <th>付款人</th>
                          <th>金額</th>
                          <th>開立日期</th>
                          <th>發送狀態</th>
                          <th>操作</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${receipts.map(receipt => `
                          <tr>
                              <td>${receipt['收據編號'] || ''}</td>
                              <td>${receipt['付款人'] || ''}</td>
                              <td>$${parseFloat(receipt['金額'] || 0).toLocaleString()}</td>
                              <td>${formatDate(receipt['開立日期'])}</td>
                              <td>
                                  <span class="badge ${receipt['發送狀態'] === '已發送' ? 'badge-success' : 'badge-warning'}">
                                      ${receipt['發送狀態'] || '未發送'}
                                  </span>
                              </td>
                              <td>
                                  <button class="btn btn-primary" onclick="sendReceipt('${receipt['ID']}')">發送</button>
                                  <button class="btn btn-secondary" onclick="downloadReceipt('${receipt['PDF檔案ID']}')">下載</button>
                              </td>
                          </tr>
                      `).join('')}
                  </tbody>
              </table>
          `;
          document.getElementById('receiptsTable').innerHTML = tableHtml;
      }

      async function sendReceipt(receiptId) {
          const result = await callAPI('sendReceipt', { receiptId: receiptId });
          if (result) {
              showResult(result);
              if (result.success) {
                  loadReceipts();
              }
          }
      }

      async function loadIncomeForReceipts() {
          const result = await callAPI('getIncomeData');
          if (result && result.success) {
              const select = document.getElementById('receiptIncomeId');
              select.innerHTML = '<option value="">請選擇收入記錄</option>';
              
              result.data.forEach(income => {
                  const option = document.createElement('option');
                  option.value = income['ID'];
                  option.textContent = `${income['付款人']} - $${parseFloat(income['金額']).toLocaleString()} (${formatDate(income['日期'])})`;
                  select.appendChild(option);
              });
          }
      }

      // 會計科目功能
      async function addAccount() {
          const accountData = {
              '科目代碼': document.getElementById('accountCode').value,
              '科目名稱': document.getElementById('accountName').value,
              '科目類型': document.getElementById('accountType').value,
              '上層科目': document.getElementById('accountParent').value,
              '說明': document.getElementById('accountDescription').value
          };

          const result = await callAPI('addAccount', accountData);
          if (result) {
              showResult(result);
              if (result.success) {
                  clearAccountForm();
                  loadAccounts();
              }
          }
      }

      function clearAccountForm() {
          document.getElementById('accountForm').reset();
      }

      async function loadAccounts() {
          showLoading('accountsLoading', true);
          const result = await callAPI('getAccountsData');
          showLoading('accountsLoading', false);
          
          if (result && result.success) {
              displayAccountsTable(result.data);
          }
      }

      function displayAccountsTable(accounts) {
          const tableHtml = `
              <table class="data-table">
                  <thead>
                      <tr>
                          <th>科目代碼</th>
                          <th>科目名稱</th>
                          <th>科目類型</th>
                          <th>上層科目</th>
                          <th>是否啟用</th>
                          <th>操作</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${accounts.map(account => `
                          <tr>
                              <td>${account['科目代碼'] || ''}</td>
                              <td>${account['科目名稱'] || ''}</td>
                              <td>${account['科目類型'] || ''}</td>
                              <td>${account['上層科目'] || '無'}</td>
                              <td>
                                  <span class="badge ${account['是否啟用'] ? 'badge-success' : 'badge-warning'}">
                                      ${account['是否啟用'] ? '啟用' : '停用'}
                                  </span>
                              </td>
                              <td>
                                  <button class="btn btn-secondary" onclick="editAccount('${account['ID']}')">編輯</button>
                                  <button class="btn btn-${account['是否啟用'] ? 'danger' : 'success'}" 
                                          onclick="toggleAccountStatus('${account['ID']}')">
                                      ${account['是否啟用'] ? '停用' : '啟用'}
                                  </button>
                              </td>
                          </tr>
                      `).join('')}
                  </tbody>
              </table>
          `;
          document.getElementById('accountsTable').innerHTML = tableHtml;
      }

      async function searchAccounts() {
          const searchTerm = document.getElementById('accountSearch').value;
          const typeFilter = document.getElementById('accountTypeFilter').value;
          
          showLoading('accountsLoading', true);
          const result = await callAPI('getAccountsData', {
              search: searchTerm,
              type: typeFilter
          });
          showLoading('accountsLoading', false);
          
          if (result && result.success) {
              displayAccountsTable(result.data);
          }
      }

      // 銀行帳戶功能
      async function addBankAccount() {
          const bankData = {
              '帳戶名稱': document.getElementById('bankAccountName').value,
              '銀行名稱': document.getElementById('bankName').value,
              '分行名稱': document.getElementById('bankBranch').value,
              '帳號': document.getElementById('bankAccountNumber').value,
              '帳戶類型': document.getElementById('bankAccountType').value,
              '目前餘額': parseFloat(document.getElementById('bankBalance').value) || 0,
              '幣別': document.getElementById('bankCurrency').value,
              '說明': document.getElementById('bankDescription').value
          };

          const result = await callAPI('addBankAccount', bankData);
          if (result) {
              showResult(result);
              if (result.success) {
                  clearBankForm();
                  loadBankAccounts();
              }
          }
      }

      function clearBankForm() {
          document.getElementById('bankForm').reset();
          document.getElementById('bankBalance').value = '0';
      }

      async function loadBankAccounts() {
          showLoading('banksLoading', true);
          const result = await callAPI('getBankAccountsData');
          showLoading('banksLoading', false);
          
          if (result && result.success) {
              displayBankAccountsTable(result.data);
          }
      }

      function displayBankAccountsTable(accounts) {
          const tableHtml = `
              <table class="data-table">
                  <thead>
                      <tr>
                          <th>帳戶名稱</th>
                          <th>銀行</th>
                          <th>帳號</th>
                          <th>類型</th>
                          <th>餘額</th>
                          <th>幣別</th>
                          <th>狀態</th>
                          <th>操作</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${accounts.map(account => `
                          <tr>
                              <td>${account['帳戶名稱'] || ''}</td>
                              <td>${account['銀行名稱'] || ''}</td>
                              <td>${account['帳號'] || ''}</td>
                              <td>${account['帳戶類型'] || ''}</td>
                              <td>$${parseFloat(account['目前餘額'] || 0).toLocaleString()}</td>
                              <td>${account['幣別'] || 'TWD'}</td>
                              <td>
                                  <span class="badge ${account['是否啟用'] ? 'badge-success' : 'badge-warning'}">
                                      ${account['是否啟用'] ? '啟用' : '停用'}
                                  </span>
                              </td>
                              <td>
                                  <button class="btn btn-secondary" onclick="editBankAccount('${account['ID']}')">編輯</button>
                                  <button class="btn btn-primary" onclick="updateBalance('${account['ID']}')">更新餘額</button>
                                  <button class="btn btn-${account['是否啟用'] ? 'danger' : 'success'}" 
                                          onclick="toggleBankStatus('${account['ID']}')">
                                      ${account['是否啟用'] ? '停用' : '啟用'}
                                  </button>
                              </td>
                          </tr>
                      `).join('')}
                  </tbody>
              </table>
          `;
          document.getElementById('banksTable').innerHTML = tableHtml;
      }

      async function searchBankAccounts() {
          const searchTerm = document.getElementById('bankSearch').value;
          const statusFilter = document.getElementById('bankStatusFilter').value;
          
          showLoading('banksLoading', true);
          const result = await callAPI('getBankAccountsData', {
              search: searchTerm,
              enabled: statusFilter ? statusFilter === 'true' : undefined
          });
          showLoading('banksLoading', false);
          
          if (result && result.success) {
              displayBankAccountsTable(result.data);
          }
      }

      async function loadBankAccountsForSelect(selectId) {
          const result = await callAPI('getBankAccountsData', { enabled: true });
          if (result && result.success) {
              const select = document.getElementById(selectId);
              select.innerHTML = '<option value="">請選擇銀行帳戶</option>';
              
              result.data.forEach(account => {
                  const option = document.createElement('option');
                  option.value = account['ID'];
                  option.textContent = `${account['帳戶名稱']} (${account['銀行名稱']})`;
                  select.appendChild(option);
              });
          }
      }

      async function updateBalance(accountId) {
          const newBalance = prompt('請輸入新的餘額:');
          if (newBalance !== null && !isNaN(parseFloat(newBalance))) {
              const result = await callAPI('updateAccountBalance', {
                  accountId: accountId,
                  newBalance: parseFloat(newBalance),
                  reason: '手動更新',
                  recordTransaction: true
              });
              
              if (result) {
                  showResult(result);
                  if (result.success) {
                      loadBankAccounts();
                  }
              }
          }
      }

      async function toggleBankStatus(accountId) {
          const result = await callAPI('toggleBankAccountStatus', { accountId: accountId });
          if (result) {
              showResult(result);
              if (result.success) {
                  loadBankAccounts();
              }
          }
      }

      // 報表功能
      async function generateReport() {
          const reportData = {
              startDate: document.getElementById('reportStartDate').value,
              endDate: document.getElementById('reportEndDate').value,
              type: document.getElementById('reportType').value
          };

          showLoading('reportsLoading', true);
          const result = await callAPI('generateReport', reportData);
          showLoading('reportsLoading', false);

          if (result && result.success) {
              displayReportResults(result.data);
          }
      }

      function displayReportResults(reportData) {
          let html = '';
          
          if (reportData.summary) {
              html += `
                  <div class="stats-grid">
                      <div class="stat-card">
                          <h4>總收入</h4>
                          <div class="stat-value">$${reportData.summary.totalIncome.toLocaleString()}</div>
                      </div>
                      <div class="stat-card">
                          <h4>總支出</h4>
                          <div class="stat-value">$${reportData.summary.totalExpenses.toLocaleString()}</div>
                      </div>
                      <div class="stat-card">
                          <h4>淨收入</h4>
                          <div class="stat-value">$${reportData.summary.netIncome.toLocaleString()}</div>
                      </div>
                  </div>
              `;
          }

          if (reportData.details && reportData.details.length > 0) {
              html += `
                  <table class="data-table">
                      <thead>
                          <tr>
                              ${Object.keys(reportData.details[0]).map(key => `<th>${key}</th>`).join('')}
                          </tr>
                      </thead>
                      <tbody>
                          ${reportData.details.map(row => `
                              <tr>
                                  ${Object.values(row).map(value => `<td>${value}</td>`).join('')}
                              </tr>
                          `).join('')}
                      </tbody>
                  </table>
              `;
          }

          document.getElementById('reportResults').innerHTML = html;
      }

      async function exportReport() {
          const reportData = {
              startDate: document.getElementById('reportStartDate').value,
              endDate: document.getElementById('reportEndDate').value,
              type: document.getElementById('reportType').value,
              export: true
          };

          const result = await callAPI('exportReport', reportData);
          if (result && result.success) {
              showResult({
                  success: true,
                  message: '報表匯出成功，請檢查您的Google Drive'
              });
          }
      }

      // 系統設定功能
      async function saveOrgSettings() {
          const orgData = {
              '組織名稱': document.getElementById('orgName').value,
              '組織地址': document.getElementById('orgAddress').value,
              '聯絡電話': document.getElementById('orgPhone').value,
              '電子郵件': document.getElementById('orgEmail').value,
              '統一編號': document.getElementById('orgTaxId').value
          };

          const result = await callAPI('updateSettings', { organizationInfo: orgData });
          if (result) {
              showResult(result);
          }
      }

      async function loadOrgSettings() {
          const result = await callAPI('getSettings');
          if (result && result.success && result.data.organizationInfo) {
              const org = result.data.organizationInfo;
              document.getElementById('orgName').value = org['組織名稱'] || '';
              document.getElementById('orgAddress').value = org['組織地址'] || '';
              document.getElementById('orgPhone').value = org['聯絡電話'] || '';
              document.getElementById('orgEmail').value = org['電子郵件'] || '';
              document.getElementById('orgTaxId').value = org['統一編號'] || '';
          }
      }

      function saveApiUrl() {
          const apiUrl = document.getElementById('apiUrl').value;
          if (apiUrl) {
              API_URL = apiUrl;
              localStorage.setItem('apiUrl', apiUrl);
              showResult({
                  success: true,
                  message: 'API網址已儲存'
              });
          } else {
              showResult({
                  success: false,
                  message: '請輸入有效的API網址'
              });
          }
      }

      async function testApiConnection() {
          if (!API_URL) {
              showResult({
                  success: false,
                  message: '請先設定API網址'
              });
              return;
          }

          const result = await callAPI('health');
          if (result) {
              showResult({
                  success: result.success,
                  message: result.success ? 'API連線測試成功' : 'API連線測試失敗'
              });
          }
      }

      async function backupData() {
          const result = await callAPI('backupData');
          if (result) {
              showResult(result);
          }
      }

      function confirmDataReset() {
          if (confirm('⚠️ 警告：此操作將清除所有資料，且無法復原。確定要繼續嗎？')) {
              if (confirm('請再次確認：您真的要重置整個系統嗎？')) {
                  resetSystemData();
              }
          }
      }

      async function resetSystemData() {
          const result = await callAPI('resetSystem');
          if (result) {
              showResult(result);
              if (result.success) {
                  // 重新載入頁面
                  setTimeout(() => {
                      location.reload();
                  }, 2000);
              }
          }
      }

      // 通用編輯和刪除功能
      async function editMember(memberId) {
          // 實作會員編輯功能
          showModal('編輯會員', '編輯功能開發中...');
      }

      async function deleteMember(memberId) {
          if (confirm('確定要刪除這個會員嗎？')) {
              const result = await callAPI('deleteMember', { id: memberId });
              if (result) {
                  showResult(result);
                  if (result.success) {
                      loadMembers();
                  }
              }
          }
      }

      async function editIncome(incomeId) {
          showModal('編輯收入', '編輯功能開發中...');
      }

      async function deleteIncome(incomeId) {
          if (confirm('確定要刪除這筆收入記錄嗎？')) {
              const result = await callAPI('deleteIncome', { id: incomeId });
              if (result) {
                  showResult(result);
                  if (result.success) {
                      loadIncome();
                  }
              }
          }
      }

      async function editExpense(expenseId) {
          showModal('編輯支出', '編輯功能開發中...');
      }

      async function deleteExpense(expenseId) {
          if (confirm('確定要刪除這筆支出記錄嗎？')) {
              const result = await callAPI('deleteExpense', { id: expenseId });
              if (result) {
                  showResult(result);
                  if (result.success) {
                      loadExpenses();
                  }
              }
          }
      }

      async function editAccount(accountId) {
          showModal('編輯會計科目', '編輯功能開發中...');
      }

      async function toggleAccountStatus(accountId) {
          const result = await callAPI('toggleAccountStatus', { accountId: accountId });
          if (result) {
              showResult(result);
              if (result.success) {
                  loadAccounts();
              }
          }
      }

      async function editBankAccount(accountId) {
          showModal('編輯銀行帳戶', '編輯功能開發中...');
      }

      // 模態視窗功能
      function showModal(title, content) {
          document.getElementById('modalContent').innerHTML = `
              <h2>${title}</h2>
              <p>${content}</p>
          `;
          document.getElementById('modal').style.display = 'block';
      }

      function closeModal() {
          document.getElementById('modal').style.display = 'none';
      }

      // 點擊模態視窗外部關閉
      window.onclick = function(event) {
          const modal = document.getElementById('modal');
          if (event.target === modal) {
              closeModal();
          }
      }

      // 工具函數
      function formatDate(dateString) {
          if (!dateString) return '';
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return dateString;
          return date.toLocaleDateString('zh-TW');
      }

      function formatCurrency(amount) {
          return new Intl.NumberFormat('zh-TW', {
              style: 'currency',
              currency: 'TWD'
          }).format(amount || 0);
      }

      // 鍵盤快捷鍵
      document.addEventListener('keydown', function(e) {
          // Ctrl + S 儲存
          if (e.ctrlKey && e.key === 's') {
              e.preventDefault();
              // 根據當前標籤執行對應的儲存操作
              const activeTab = document.querySelector('.tab-content.active');
              if (activeTab) {
                  switch(activeTab.id) {
                      case 'members':
                          addMember();
                          break;
                      case 'income':
                          addIncome();
                          break;
                      case 'expenses':
                          addExpense();
                          break;
                      case 'accounts':
                          addAccount();
                          break;
                      case 'banks':
                          addBankAccount();
                          break;
                      case 'settings':
                          saveOrgSettings();
                          break;
                  }
              }
          }
          
          // Esc 關閉模態視窗
          if (e.key === 'Escape') {
              closeModal();
          }
      });

      // 自動儲存草稿功能
      function autoSaveDraft() {
          const forms = ['memberForm', 'incomeForm', 'expenseForm', 'accountForm', 'bankForm'];
          
          forms.forEach(formId => {
              const form = document.getElementById(formId);
              if (form) {
                  const inputs = form.querySelectorAll('input, select, textarea');
                  inputs.forEach(input => {
                      input.addEventListener('input', function() {
                          const draftKey = `draft_${formId}`;
                          const formData = new FormData(form);
                          const draftData = {};
                          
                          for (let [key, value] of formData.entries()) {
                              draftData[key] = value;
                          }
                          
                          localStorage.setItem(draftKey, JSON.stringify(draftData));
                      });
                  });
              }
          });
      }

      // 載入草稿
      function loadDrafts() {
          const forms = ['memberForm', 'incomeForm', 'expenseForm', 'accountForm', 'bankForm'];
          
          forms.forEach(formId => {
              const draftKey = `draft_${formId}`;
              const draftData = localStorage.getItem(draftKey);
              
              if (draftData) {
                  try {
                      const data = JSON.parse(draftData);
                      const form = document.getElementById(formId);
                      
                      if (form) {
                          Object.keys(data).forEach(key => {
                              const input = form.querySelector(`[name="${key}"]`);
                              if (input) {
                                  input.value = data[key];
                              }
                          });
                      }
                  } catch (error) {
                      console.error('載入草稿錯誤:', error);
                  }
              }
          });
      }

      // 清除草稿
      function clearDraft(formId) {
          const draftKey = `draft_${formId}`;
          localStorage.removeItem(draftKey);
      }

      // 頁面載入完成後執行
      window.addEventListener('load', function() {
          autoSaveDraft();
          loadDrafts();
          
          // 設定日期欄位預設值為今天
          const today = new Date().toISOString().split('T')[0];
          const dateInputs = document.querySelectorAll('input[type="date"]');
          dateInputs.forEach(input => {
              if (!input.value) {
                  input.value = today;
              }
          });
      });

      // 響應式設計支援
      function handleResize() {
          const container = document.querySelector('.container');
          if (window.innerWidth < 768) {
              container.classList.add('mobile');
          } else {
              container.classList.remove('mobile');
          }
      }

      window.addEventListener('resize', handleResize);
      handleResize(); // 初始執行

      // 列印功能
      function printReport() {
          const reportContent = document.getElementById('reportResults').innerHTML;
          if (reportContent) {
              const printWindow = window.open('', '_blank');
              printWindow.document.write(`
                  <html>
                      <head>
                          <title>財務報表</title>
                          <style>
                              body { font-family: Arial, sans-serif; }
                              table { width: 100%; border-collapse: collapse; }
                              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                              th { background-color: #f2f2f2; }
                              .stat-card { display: inline-block; margin: 10px; padding: 15px; border: 1px solid #ddd; }
                          </style>
                      </head>
                      <body>
                          <h1>財務報表</h1>
                          ${reportContent}
                      </body>
                  </html>
              `);
              printWindow.document.close();
              printWindow.print();
          }
      }

      // 匯出CSV功能
      function exportToCSV(data, filename) {
          if (!data || data.length === 0) return;
          
          const headers = Object.keys(data[0]);
          const csvContent = [
              headers.join(','),
              ...data.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
          ].join('\n');
          
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          
          if (link.download !== undefined) {
              const url = URL.createObjectURL(blob);
              link.setAttribute('href', url);
              link.setAttribute('download', filename);
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
          }
      }

      // 初始化完成提示
      console.log('💰 非營利組織財務管理系統已載入完成');
      console.log('🚀 請在系統設定中設定您的Google Apps Script API網址');
  </script>

  <!-- 新增CSS樣式 -->
  <style>
      .badge {
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 12px;
          font-weight: bold;
          text-transform: uppercase;
      }

      .badge-success {
          background-color: #28a745;
          color: white;
      }

      .badge-warning {
          background-color: #ffc107;
          color: #212529;
      }

      .badge-danger {
          background-color: #dc3545;
          color: white;
      }

      .mobile .form-grid {
          grid-template-columns: 1fr;
      }

      .mobile .nav-tabs {
          overflow-x: auto;
          white-space: nowrap;
      }

      .mobile .nav-tab {
          min-width: 100px;
          font-size: 14px;
      }

      .mobile .data-table {
          font-size: 12px;
      }

      .mobile .data-table th,
      .mobile .data-table td {
          padding: 6px;
      }

      @media print {
          .nav-tabs,
          .btn,
          .search-box {
              display: none !important;
          }
          
          .tab-content {
              display: block !important;
          }
      }

      /* 載入動畫 */
      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .loading::before {
          content: '';
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid #667eea;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-right: 10px;
      }

      /* 成功動畫 */
      @keyframes fadeInUp {
          from {
              opacity: 0;
              transform: translateY(30px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }

      .alert {
          animation: fadeInUp 0.5s ease-out;
      }

      /* 按鈕懸停效果 */
      .btn {
          position: relative;
          overflow: hidden;
      }

      .btn::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
          transition: left 0.5s;
      }

      .btn:hover::before {
          left: 100%;
      }
  </style>
</body>
</html>
      
