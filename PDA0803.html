<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣帕金森病友權益促進會 - 財務會計系統</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #17a2b8;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }
        body { font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f5f6fa; }
        .sidebar { position: fixed; top: 0; left: 0; height: 100vh; width: 250px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; transform: translateX(-250px); transition: transform 0.3s ease; z-index: 1000; overflow-y: auto; }
        .sidebar.active { transform: translateX(0); }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-header h4 { margin: 0; font-size: 16px; font-weight: bold; }
        .sidebar-menu { list-style: none; padding: 0; margin: 20px 0; }
        .sidebar-menu a { display: block; padding: 15px 20px; color: white; text-decoration: none; transition: all 0.3s ease; border-left: 3px solid transparent; }
        .sidebar-menu a:hover, .sidebar-menu a.active { background-color: rgba(255,255,255,0.1); border-left-color: white; padding-left: 25px; }
        .sidebar-menu i { margin-right: 10px; width: 20px; text-align: center; }
        .main-content { margin-left: 0; padding: 20px; transition: margin-left 0.3s ease; min-height: 100vh; }
        .main-content.sidebar-open { margin-left: 250px; }
        .top-navbar { background: white; padding: 15px 20px; margin: -20px -20px 20px -20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .menu-toggle { background: none; border: none; font-size: 20px; color: var(--primary-color); cursor: pointer; }
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border-radius: 10px 10px 0 0 !important; padding: 15px 20px; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card .icon { font-size: 2.5rem; margin-bottom: 10px; }
        .stat-card .number { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        .stat-card .label { color: #666; font-size: 0.9rem; }
        .stat-card.income { border-left: 4px solid var(--success-color); }
        .stat-card.expense { border-left: 4px solid var(--danger-color); }
        .stat-card.member { border-left: 4px solid var(--info-color); }
        .stat-card.balance { border-left: 4px solid var(--warning-color); }
        .table-responsive { border-radius: 10px; overflow: hidden; }
        .table th { background-color: var(--light-color); font-weight: 600; }
        .table td { vertical-align: middle; }
        .btn { border-radius: 6px; font-weight: 500; }
        .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25); }
        .modal-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; }
        .modal-content { border-radius: 10px; border: none; }
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; }
        .loading.show { display: flex; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .search-bar { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chart-container { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
        .status-active, .status-approved, .status-sent { background-color: #d4edda; color: #155724; }
        .status-inactive, .status-rejected { background-color: #f8d7da; color: #721c24; }
        .status-pending, .status-unsent, .status-created { background-color: #fff3cd; color: #856404; }
        .amount-positive { color: var(--success-color); font-weight: bold; }
        .amount-negative { color: var(--danger-color); font-weight: bold; }
        .pagination { justify-content: center; margin-top: 20px; }
        @media (max-width: 768px) {
            .sidebar { width: 100%; transform: translateX(-100%); }
            .main-content.sidebar-open { margin-left: 0; }
        }
    </style>
</head>
<body>
    <!-- 載入動畫 -->
    <div class="loading" id="loadingOverlay"><div class="spinner"></div></div>

    <!-- 側邊欄 -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4>財務會計系統</h4>
            <small>台灣帕金森病友權益促進會</small>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" data-page="dashboard" class="active"><i class="fas fa-tachometer-alt"></i> 儀表板</a></li>
            <li><a href="#" data-page="members"><i class="fas fa-users"></i> 會員管理</a></li>
            <li><a href="#" data-page="income"><i class="fas fa-arrow-up"></i> 收入管理</a></li>
            <li><a href="#" data-page="expenses"><i class="fas fa-arrow-down"></i> 支出管理</a></li>
            <li><a href="#" data-page="receipts"><i class="fas fa-receipt"></i> 電子收據</a></li>
            <li><a href="#" data-page="accounts"><i class="fas fa-list"></i> 會計科目</a></li>
            <li><a href="#" data-page="bank-accounts"><i class="fas fa-university"></i> 銀行帳戶</a></li>
            <li><a href="#" data-page="reports"><i class="fas fa-chart-bar"></i> 報表分析</a></li>
            <li><a href="#" data-page="settings"><i class="fas fa-cog"></i> 系統設定</a></li>
        </ul>
    </nav>

    <!-- 主要內容區域 -->
    <main class="main-content" id="mainContent">
        <!-- 頂部導航 -->
        <div class="top-navbar">
            <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
            <div class="user-info"><span>管理員</span> <i class="fas fa-user-circle fa-lg"></i></div>
        </div>
        
        <div id="alert-container"></div>

        <!-- 儀表板頁面 -->
        <div class="page-content active" id="dashboard-page">
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3"><div class="stat-card member"><div class="icon"><i class="fas fa-users text-info"></i></div><div class="number" id="totalMembers">0</div><div class="label">總會員數</div></div></div>
                <div class="col-md-3 col-sm-6 mb-3"><div class="stat-card income"><div class="icon"><i class="fas fa-arrow-up text-success"></i></div><div class="number" id="monthlyIncome">$0</div><div class="label">本月收入</div></div></div>
                <div class="col-md-3 col-sm-6 mb-3"><div class="stat-card expense"><div class="icon"><i class="fas fa-arrow-down text-danger"></i></div><div class="number" id="monthlyExpenses">$0</div><div class="label">本月支出</div></div></div>
                <div class="col-md-3 col-sm-6 mb-3"><div class="stat-card balance"><div class="icon"><i class="fas fa-wallet text-warning"></i></div><div class="number" id="totalBalance">$0</div><div class="label">帳戶總餘額</div></div></div>
            </div>
            <div class="row">
                <div class="col-md-8"><div class="chart-container"><h5>收支趨勢圖</h5><canvas id="incomeExpenseChart"></canvas></div></div>
                <div class="col-md-4"><div class="card"><div class="card-header"><h5>最近交易</h5></div><div class="card-body" id="recentTransactions"><p class="text-muted">載入中...</p></div></div></div>
            </div>
        </div>

        <!-- 會員管理頁面 -->
        <div class="page-content" id="members-page">
            <div class="search-bar row g-2">
                <div class="col-md-4"><input type="text" class="form-control" id="memberSearch" placeholder="搜尋會員姓名、電話..."></div>
                <div class="col-md-3"><select class="form-select" id="memberStatusFilter"><option value="">所有狀態</option><option value="正常">正常</option><option value="停權">停權</option></select></div>
                <div class="col-md-auto"><button class="btn btn-primary w-100" onclick="searchMembers()"><i class="fas fa-search"></i> 搜尋</button></div>
                <div class="col-md-auto ms-md-auto"><button class="btn btn-success w-100" onclick="showMemberModal()"><i class="fas fa-plus"></i> 新增會員</button></div>
            </div>
            <div class="card"><div class="card-header"><h5>會員列表</h5></div><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>會員編號</th><th>姓名</th><th>電話</th><th>電子郵件</th><th>狀態</th><th>加入日期</th><th>操作</th></tr></thead><tbody id="membersTableBody"></tbody></table></div><nav><ul class="pagination" id="membersPagination"></ul></nav></div></div>
        </div>
        
        <!-- 收入管理頁面 -->
        <div class="page-content" id="income-page">
             <div class="search-bar row g-2">
                <div class="col-md-3"><input type="date" class="form-control" id="incomeStartDate"></div>
                <div class="col-md-3"><input type="date" class="form-control" id="incomeEndDate"></div>
                <div class="col-md-3"><select class="form-select" id="incomeAccountFilter"><option value="">所有科目</option></select></div>
                <div class="col-md-auto"><button class="btn btn-primary" onclick="searchIncome()"><i class="fas fa-search"></i> 搜尋</button></div>
                <div class="col-md-auto ms-md-auto"><button class="btn btn-success" onclick="showIncomeModal()"><i class="fas fa-plus"></i> 新增收入</button></div>
            </div>
            <div class="card"><div class="card-header"><h5>收入記錄</h5></div><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>日期</th><th>會計科目</th><th>金額</th><th>付款人</th><th>付款方式</th><th>操作</th></tr></thead><tbody id="incomeTableBody"></tbody></table></div><nav><ul class="pagination" id="incomePagination"></ul></nav></div></div>
        </div>

        <!-- 支出管理頁面 -->
        <div class="page-content" id="expenses-page">
            <div class="search-bar row g-2">
                <div class="col-md-3"><input type="date" class="form-control" id="expenseStartDate"></div>
                <div class="col-md-3"><input type="date" class="form-control" id="expenseEndDate"></div>
                <div class="col-md-3"><select class="form-select" id="expenseStatusFilter"><option value="">所有狀態</option><option value="待審核">待審核</option><option value="已核准">已核准</option><option value="已拒絕">已拒絕</option></select></div>
                <div class="col-md-auto"><button class="btn btn-primary" onclick="searchExpenses()"><i class="fas fa-search"></i> 搜尋</button></div>
                <div class="col-md-auto ms-md-auto"><button class="btn btn-success" onclick="showExpenseModal()"><i class="fas fa-plus"></i> 新增支出</button></div>
            </div>
            <div class="card"><div class="card-header"><h5>支出記錄</h5></div><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>日期</th><th>會計科目</th><th>金額</th><th>收款人</th><th>狀態</th><th>操作</th></tr></thead><tbody id="expensesTableBody"></tbody></table></div><nav><ul class="pagination" id="expensesPagination"></ul></nav></div></div>
        </div>

        <!-- 電子收據頁面 -->
        <div class="page-content" id="receipts-page">
            <div class="card"><div class="card-header"><h5>電子收據列表</h5></div><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>收據編號</th><th>金額</th><th>開立日期</th><th>收據狀態</th><th>郵件狀態</th><th>操作</th></tr></thead><tbody id="receiptsTableBody"></tbody></table></div><nav><ul class="pagination" id="receiptsPagination"></ul></nav></div></div>
        </div>

        <!-- 會計科目頁面 -->
        <div class="page-content" id="accounts-page">
            <div class="card"><div class="card-header"><h5>會計科目列表</h5></div><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>科目代碼</th><th>科目名稱</th><th>科目類型</th><th>是否啟用</th><th>說明</th></tr></thead><tbody id="accountsTableBody"></tbody></table></div></div></div>
        </div>

        <!-- 銀行帳戶頁面 -->
        <div class="page-content" id="bank-accounts-page">
<!-- ... 接續上一段 HTML ... -->
            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-success" onclick="showBankAccountModal()">
                    <i class="fas fa-plus"></i> 新增帳戶
                </button>
            </div>
            <div class="card">
                <div class="card-header"><h5>銀行帳戶列表</h5></div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>帳戶名稱</th>
                                    <th>銀行名稱</th>
                                    <th>帳號</th>
                                    <th>目前餘額</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="bankAccountsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 報表分析頁面 -->
        <div class="page-content" id="reports-page">
            <div class="row mb-4">
                <div class="col-md-3 mb-3"><div class="card h-100"><div class="card-body text-center"><i class="fas fa-chart-line fa-2x text-primary mb-2"></i><h6>財務報表</h6><button class="btn btn-primary btn-sm" onclick="generateFinancialReport()">產生報表</button></div></div></div>
                <div class="col-md-3 mb-3"><div class="card h-100"><div class="card-body text-center"><i class="fas fa-balance-scale fa-2x text-success mb-2"></i><h6>資產負債表</h6><button class="btn btn-success btn-sm" onclick="generateBalanceSheet()">產生報表</button></div></div></div>
                <div class="col-md-3 mb-3"><div class="card h-100"><div class="card-body text-center"><i class="fas fa-hand-holding-usd fa-2x text-info mb-2"></i><h6>現金流量表</h6><button class="btn btn-info btn-sm" onclick="generateCashFlowReport()">產生報表</button></div></div></div>
                <div class="col-md-3 mb-3"><div class="card h-100"><div class="card-body text-center"><i class="fas fa-heart fa-2x text-danger mb-2"></i><h6>捐款報表</h6><button class="btn btn-danger btn-sm" onclick="generateDonationReport()">產生報表</button></div></div></div>
            </div>
            <div class="card">
                <div class="card-header"><h5>報表內容</h5></div>
                <div class="card-body">
                    <div id="reportContent"><p class="text-muted text-center">請選擇上方的報表類型來產生報表</p></div>
                </div>
            </div>
        </div>

        <!-- 系統設定頁面 -->
        <div class="page-content" id="settings-page">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><h5>組織基本資訊</h5></div>
                        <div class="card-body">
                            <form id="organizationForm">
                                <div class="mb-3"><label class="form-label">組織名稱</label><input type="text" class="form-control" id="orgName" required></div>
                                <div class="mb-3"><label class="form-label">組織地址</label><textarea class="form-control" id="orgAddress" rows="2"></textarea></div>
                                <div class="mb-3"><label class="form-label">聯絡電話</label><input type="tel" class="form-control" id="orgPhone"></div>
                                <div class="mb-3"><label class="form-label">電子郵件</label><input type="email" class="form-control" id="orgEmail"></div>
                                <div class="mb-3"><label class="form-label">統一編號</label><input type="text" class="form-control" id="orgTaxId"></div>
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 儲存設定</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><h5>系統管理</h5></div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-info" onclick="createBackup()"><i class="fas fa-download"></i> 建立系統備份</button>
                                <button class="btn btn-warning" onclick="cleanupSystem()"><i class="fas fa-broom"></i> 清理空白行</button>
                                <button class="btn btn-danger" onclick="resetSettings()"><i class="fas fa-redo"></i> 重置系統設定</button>
                            </div>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-header"><h5>系統狀態</h5></div>
                        <div class="card-body" id="systemStatus"><p class="text-muted">載入中...</p></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 會員資料模態框 -->
    <div class="modal fade" id="memberModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="memberForm">
                    <div class="modal-header"><h5 class="modal-title" id="memberModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <input type="hidden" name="id">
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">姓名 *</label><input type="text" class="form-control" name="姓名" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">電話 *</label><input type="tel" class="form-control" name="電話" required></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">電子郵件</label><input type="email" class="form-control" name="電子郵件"></div>
                            <div class="col-md-6 mb-3"><label class="form-label">出生日期</label><input type="date" class="form-control" name="出生日期"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">會員類型</label><select class="form-select" name="會員類型"><option value="一般會員">一般會員</option><option value="贊助會員">贊助會員</option><option value="榮譽會員">榮譽會員</option></select></div>
                            <div class="col-md-6 mb-3"><label class="form-label">會員狀態</label><select class="form-select" name="會員狀態"><option value="正常">正常</option><option value="停權">停權</option></select></div>
                        </div>
                        <div class="mb-3"><label class="form-label">地址</label><textarea class="form-control" name="地址" rows="2"></textarea></div>
                        <div class="mb-3"><label class="form-label">加入日期 *</label><input type="date" class="form-control" name="加入日期" required></div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button type="submit" class="btn btn-primary">儲存</button></div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 收入/支出 模態框 -->
    <div class="modal fade" id="transactionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="transactionForm">
                    <div class="modal-header"><h5 class="modal-title" id="transactionModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <input type="hidden" name="id"><input type="hidden" name="type">
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">日期 *</label><input type="date" class="form-control" name="日期" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">金額 *</label><input type="number" class="form-control" name="金額" min="0" step="0.01" required></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">會計科目 *</label><select class="form-select" name="會計科目" id="transactionAccountSelect" required></select></div>
                            <div class="col-md-6 mb-3"><label class="form-label" id="transactionPartyLabel"></label><input type="text" class="form-control" name="party" required></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">付款方式</label><select class="form-select" name="付款方式"><option value="現金">現金</option><option value="銀行轉帳">銀行轉帳</option><option value="支票">支票</option><option value="信用卡">信用卡</option><option value="其他">其他</option></select></div>
                            <div class="col-md-6 mb-3"><label class="form-label">銀行帳戶</label><select class="form-select" name="銀行帳戶" id="transactionBankSelect"></select></div>
                        </div>
                        <div class="mb-3"><label class="form-label">說明</label><textarea class="form-control" name="說明" rows="3"></textarea></div>
                        <div class="mb-3 form-check" id="autoGenerateReceiptWrapper"><input class="form-check-input" type="checkbox" name="自動生成收據" id="autoGenerateReceipt" checked><label class="form-check-label" for="autoGenerateReceipt">自動生成電子收據</label></div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button type="submit" class="btn btn-primary">儲存</button></div>
                </form>
            </div>
        </div>
    </div>

    <!-- 銀行帳戶模態框 -->
    <div class="modal fade" id="bankAccountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="bankAccountForm">
                    <div class="modal-header"><h5 class="modal-title" id="bankAccountModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <input type="hidden" name="id">
                        <div class="mb-3"><label class="form-label">帳戶名稱 *</label><input type="text" class="form-control" name="帳戶名稱" required></div>
                        <div class="mb-3"><label class="form-label">銀行名稱 *</label><input type="text" class="form-control" name="銀行名稱" required></div>
                        <div class="mb-3"><label class="form-label">帳號 *</label><input type="text" class="form-control" name="帳號" required></div>
                        <div class="mb-3"><label class="form-label">初始餘額</label><input type="number" class="form-control" name="目前餘額" min="0" step="0.01" value="0"></div>
                        <div class="mb-3"><div class="form-check"><input class="form-check-input" type="checkbox" name="是否啟用" id="bankAccountEnabled" checked><label class="form-check-label" for="bankAccountEnabled">啟用此帳戶</label></div></div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button type="submit" class="btn btn-primary">儲存</button></div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // =============================================================================
        // 全域設定與變數
        // =============================================================================
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbw2y0OfB-r1D8jS7mFunST0iYRNezZtnpzfX_yOBYvKDvzvsCMiUm38wG0poJwmUqkv/exec'; // 請替換成您的 Google Apps Script URL
        let currentPage = 'dashboard';
        let chartInstances = {};
        let memberModal, transactionModal, bankAccountModal;

        // =============================================================================
        // 初始化
        // =============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        async function initializeApp() {
            showLoading(true);
            setupEventListeners();
            initializeModals();
            await loadPageData('dashboard');
            showLoading(false);
        }

        function initializeModals() {
            memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
            transactionModal = new bootstrap.Modal(document.getElementById('transactionModal'));
            bankAccountModal = new bootstrap.Modal(document.getElementById('bankAccountModal'));
        }

        function setupEventListeners() {
            document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    switchPage(link.dataset.page);
                });
            });
            document.getElementById('memberForm').addEventListener('submit', handleMemberFormSubmit);
            document.getElementById('transactionForm').addEventListener('submit', handleTransactionFormSubmit);
            document.getElementById('bankAccountForm').addEventListener('submit', handleBankAccountFormSubmit);
            document.getElementById('organizationForm').addEventListener('submit', saveOrganizationInfo);
        }

        // =============================================================================
        // 頁面導航與資料載入
        // =============================================================================
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('mainContent').classList.toggle('sidebar-open');
        }

        async function switchPage(pageName) {
            if (!pageName) return;
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById(`${pageName}-page`).classList.add('active');
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            document.querySelector(`.sidebar-menu a[data-page="${pageName}"]`).classList.add('active');
            currentPage = pageName;
            await loadPageData(pageName);
            if (window.innerWidth <= 768) toggleSidebar();
        }

        async function loadPageData(pageName, page = 1, params = {}) {
            showLoading(true);
            try {
                switch (pageName) {
                    case 'dashboard': await loadDashboardData(); break;
                    case 'members': await loadMembersData(page, params); break;
                    case 'income': await loadIncomeData(page, params); break;
                    case 'expenses': await loadExpensesData(page, params); break;
                    case 'receipts': await loadReceiptsData(page, params); break;
                    case 'accounts': await loadAccountsData(); break;
// ... 接續上一段 JavaScript ...
                    case 'bank-accounts': await loadBankAccountsData(); break;
                    case 'settings': await loadSystemSettings(); break;
                }
            } catch (error) {
                showAlert(`載入頁面資料失敗: ${error.message}`, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // =============================================================================
        // API 呼叫與工具函數
        // =============================================================================
        async function apiCall(action, data = {}) {
            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, data })
                });
                if (!response.ok) throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.message || 'API 請求失敗');
                return result;
            } catch (error) {
                console.error('API 呼叫錯誤:', error);
                throw error;
            }
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('show', show);
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function formatCurrency(amount) {
            return `NT$ ${parseInt(amount || 0).toLocaleString()}`;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function updatePagination(containerId, pagination, loadFunction, params = {}) {
            const container = document.getElementById(containerId);
            if (!container || !pagination || pagination.totalPages <= 1) {
                if(container) container.innerHTML = '';
                return;
            }
            let html = '';
            const paramsJson = JSON.stringify(params);

            // 上一頁
            html += `<li class="page-item ${!pagination.hasPreviousPage ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="${loadFunction.name}(${pagination.currentPage - 1}, ${paramsJson})">上一頁</a></li>`;
            
            // 頁碼
            for (let i = 1; i <= pagination.totalPages; i++) {
                html += `<li class="page-item ${i === pagination.currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="${loadFunction.name}(${i}, ${paramsJson})">${i}</a></li>`;
            }

            // 下一頁
            html += `<li class="page-item ${!pagination.hasNextPage ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="${loadFunction.name}(${pagination.currentPage + 1}, ${paramsJson})">下一頁</a></li>`;
            
            container.innerHTML = html;
        }

        // =============================================================================
        // 資料載入與顯示函數
        // =============================================================================
        async function loadDashboardData() {
            const results = await Promise.allSettled([
                apiCall('getMembers'),
                apiCall('getIncomeStatistics', { month: new Date().toISOString().slice(0, 7) }),
                apiCall('getExpensesStatistics', { month: new Date().toISOString().slice(0, 7) }),
                apiCall('getBankAccounts'),
                apiCall('getIncome', { limit: 3 }),
                apiCall('getExpenses', { limit: 3 }),
                apiCall('getFinancialReport', { months: 12 })
            ]);

            if (results[0].status === 'fulfilled') document.getElementById('totalMembers').textContent = results[0].value.pagination.totalCount;
            if (results[1].status === 'fulfilled') document.getElementById('monthlyIncome').textContent = formatCurrency(results[1].value.data.totalAmount);
            if (results[2].status === 'fulfilled') document.getElementById('monthlyExpenses').textContent = formatCurrency(results[2].value.data.totalAmount);
            if (results[3].status === 'fulfilled') {
                const totalBalance = results[3].value.data.reduce((sum, acc) => sum + (parseFloat(acc['目前餘額']) || 0), 0);
                document.getElementById('totalBalance').textContent = formatCurrency(totalBalance);
            }
            
            // 最近交易
            const recentIncome = results[4].status === 'fulfilled' ? results[4].value.data : [];
            const recentExpenses = results[5].status === 'fulfilled' ? results[5].value.data : [];
            displayRecentTransactions(recentIncome, recentExpenses);
            
            // 圖表
            if (results[6].status === 'fulfilled') updateIncomeExpenseChart(results[6].value.data.monthly);
            else initializeCharts();
        }

        function displayRecentTransactions(income, expenses) {
            const container = document.getElementById('recentTransactions');
            let html = '';
            if (income.length > 0) {
                html += '<h6 class="text-success">最近收入</h6>';
                income.forEach(item => {
                    html += `<div class="d-flex justify-content-between mb-2"><div><small class="text-muted">${formatDate(item['日期'])}</small><br>${item['付款人']}</div><span class="text-success">+${formatCurrency(item['金額'])}</span></div>`;
                });
            }
            if (expenses.length > 0) {
                html += '<h6 class="text-danger mt-3">最近支出</h6>';
                expenses.forEach(item => {
                    html += `<div class="d-flex justify-content-between mb-2"><div><small class="text-muted">${formatDate(item['日期'])}</small><br>${item['收款人']}</div><span class="text-danger">-${formatCurrency(item['金額'])}</span></div>`;
                });
            }
            container.innerHTML = html || '<p class="text-muted text-center">暫無交易記錄</p>';
        }

        async function loadMembersData(page = 1, params = {}) {
            const result = await apiCall('getMembers', { page, limit: 10, ...params });
            const tbody = document.getElementById('membersTableBody');
            tbody.innerHTML = result.data.map(member => `
                <tr>
                    <td>${member['會員編號']}</td>
                    <td>${member['姓名']}</td>
                    <td>${member['電話']}</td>
                    <td>${member['電子郵件'] || '-'}</td>
                    <td><span class="status-badge ${member['會員狀態'] === '正常' ? 'status-active' : 'status-inactive'}">${member['會員狀態']}</span></td>
                    <td>${formatDate(member['加入日期'])}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editMember('${member.ID}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${member.ID}', 'deleteMember', loadMembersData)"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            if (result.data.length === 0) tbody.innerHTML = '<tr><td colspan="7" class="text-center">暫無資料</td></tr>';
            updatePagination('membersPagination', result.pagination, loadMembersData, params);
        }

        async function loadIncomeData(page = 1, params = {}) {
            const result = await apiCall('getIncome', { page, limit: 10, ...params });
            const tbody = document.getElementById('incomeTableBody');
            tbody.innerHTML = result.data.map(item => `
                <tr>
                    <td>${formatDate(item['日期'])}</td>
                    <td>${item['會計科目']}</td>
                    <td class="amount-positive">${formatCurrency(item['金額'])}</td>
                    <td>${item['付款人']}</td>
                    <td>${item['付款方式'] || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editTransaction('${item.ID}', 'income')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${item.ID}', 'deleteIncome', loadIncomeData)"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            if (result.data.length === 0) tbody.innerHTML = '<tr><td colspan="6" class="text-center">暫無資料</td></tr>';
            updatePagination('incomePagination', result.pagination, loadIncomeData, params);
        }

        async function loadExpensesData(page = 1, params = {}) {
            const result = await apiCall('getExpenses', { page, limit: 10, ...params });
            const tbody = document.getElementById('expensesTableBody');
            const statusClasses = { '待審核': 'status-pending', '已核准': 'status-approved', '已拒絕': 'status-rejected' };
            tbody.innerHTML = result.data.map(item => `
                <tr>
                    <td>${formatDate(item['日期'])}</td>
                    <td>${item['會計科目']}</td>
                    <td class="amount-negative">${formatCurrency(item['金額'])}</td>
                    <td>${item['收款人']}</td>
                    <td><span class="status-badge ${statusClasses[item['狀態']]}">${item['狀態']}</span></td>
                    <td>
                        ${item['狀態'] === '待審核' ? `<button class="btn btn-sm btn-outline-success" onclick="approveExpense('${item.ID}')"><i class="fas fa-check"></i></button>` : ''}
                        <button class="btn btn-sm btn-outline-primary" onclick="editTransaction('${item.ID}', 'expense')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${item.ID}', 'deleteExpense', loadExpensesData)"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            if (result.data.length === 0) tbody.innerHTML = '<tr><td colspan="6" class="text-center">暫無資料</td></tr>';
            updatePagination('expensesPagination', result.pagination, loadExpensesData, params);
        }
        
        async function loadReceiptsData(page = 1, params = {}) {
            const result = await apiCall('getReceipts', { page, limit: 10, ...params });
            const tbody = document.getElementById('receiptsTableBody');
            const statusClasses = { '已開立': 'status-created', '已發送': 'status-sent' };
            const mailStatusClasses = { '未發送': 'status-unsent', '已發送': 'status-sent' };
            tbody.innerHTML = result.data.map(item => `
                <tr>
                    <td>${item['收據編號']}</td>
                    <td class="amount-positive">${formatCurrency(item['金額'])}</td>
                    <td>${formatDate(item['開立日期'])}</td>
                    <td><span class="status-badge ${statusClasses[item['收據狀態']]}">${item['收據狀態']}</span></td>
                    <td><span class="status-badge ${mailStatusClasses[item['郵件狀態']]}">${item['郵件狀態']}</span></td>
                    <td><button class="btn btn-sm btn-outline-info" disabled><i class="fas fa-paper-plane"></i></button></td>
                </tr>
            `).join('');
            if (result.data.length === 0) tbody.innerHTML = '<tr><td colspan="6" class="text-center">暫無資料</td></tr>';
            updatePagination('receiptsPagination', result.pagination, loadReceiptsData, params);
        }

        async function loadAccountsData() {
            const result = await apiCall('getAccounts');
            const tbody = document.getElementById('accountsTableBody');
            tbody.innerHTML = result.data.map(item => `
                <tr>
                    <td>${item['科目代碼']}</td>
                    <td>${item['科目名稱']}</td>
                    <td>${item['科目類型']}</td>
                    <td><span class="status-badge ${item['是否啟用'] ? 'status-active' : 'status-inactive'}">${item['是否啟用'] ? '是' : '否'}</span></td>
                    <td>${item['說明'] || '-'}</td>
                </tr>
            `).join('');
        }

        async function loadBankAccountsData() {
            const result = await apiCall('getBankAccounts');
            const tbody = document.getElementById('bankAccountsTableBody');
            tbody.innerHTML = result.data.map(item => `
                <tr>
                    <td>${item['帳戶名稱']}</td>
                    <td>${item['銀行名稱']}</td>
                    <td>${item['帳號']}</td>
                    <td>${formatCurrency(item['目前餘額'])}</td>
                    <td><span class="status-badge ${item['是否啟用'] ? 'status-active' : 'status-inactive'}">${item['是否啟用'] ? '啟用' : '停用'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editBankAccount('${item.ID}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${item.ID}', 'deleteBankAccount', loadBankAccountsData)"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            if (result.data.length === 0) tbody.innerHTML = '<tr><td colspan="6" class="text-center">暫無資料</td></tr>';
        }

        async function loadSystemSettings() {
            const [orgInfo, sysStatus] = await Promise.all([apiCall('getOrganizationInfo'), apiCall('getSystemStatus')]);
            const orgData = orgInfo.data;
            document.getElementById('orgName').value = orgData.name || '';
            document.getElementById('orgAddress').value = orgData.address || '';
            document.getElementById('orgPhone').value = orgData.phone || '';
            document.getElementById('orgEmail').value = orgData.email || '';
            document.getElementById('orgTaxId').value = orgData.taxId || '';

            const status = sysStatus.data;
            document.getElementById('systemStatus').innerHTML = `
                <p><strong>系統版本:</strong> ${status.systemVersion}</p>
                <p><strong>資料統計:</strong></p>
                <ul>
                    <li>會員: ${status.dataStats['會員資料'] || 0}</li>
                    <li>收入: ${status.dataStats['收入記錄'] || 0}</li>
                    <li>支出: ${status.dataStats['支出記錄'] || 0}</li>
                </ul>`;
        }

        // =============================================================================
        // 搜尋功能
        // =============================================================================
        function searchMembers() {
            const params = {
                search: document.getElementById('memberSearch').value,
                status: document.getElementById('memberStatusFilter').value
            };
            loadMembersData(1, params);
        }

        function searchIncome() {
            const params = {
                startDate: document.getElementById('incomeStartDate').value,
                endDate: document.getElementById('incomeEndDate').value,
                account: document.getElementById('incomeAccountFilter').value,
            };
            loadIncomeData(1, params);
        }

        function searchExpenses() {
            const params = {
                startDate: document.getElementById('expenseStartDate').value,
                endDate: document.getElementById('expenseEndDate').value,
                status: document.getElementById('expenseStatusFilter').value
            };
            loadExpensesData(1, params);
        }

        // =============================================================================
        // Modal 與表單處理
        // =============================================================================
        // --- 會員 ---
        function showMemberModal() {
            document.getElementById('memberForm').reset();
            document.querySelector('#memberForm input[name="id"]').value = '';
            document.getElementById('memberModalTitle').textContent = '新增會員';
            document.querySelector('#memberForm input[name="加入日期"]').valueAsDate = new Date();
            memberModal.show();
        }

        async function editMember(id) {
            const result = await apiCall('getMembers', { id: id });
            if (result.data.length > 0) {
                const form = document.getElementById('memberForm');
                const member = result.data[0];
                form.querySelector('[name="id"]').value = member.ID;
                form.querySelector('[name="姓名"]').value = member['姓名'];
                form.querySelector('[name="電話"]').value = member['電話'];
                form.querySelector('[name="電子郵件"]').value = member['電子郵件'];
                form.querySelector('[name="出生日期"]').value = member['出生日期'] ? member['出生日期'].split('T')[0] : '';
                form.querySelector('[name="會員類型"]').value = member['會員類型'];
                form.querySelector('[name="會員狀態"]').value = member['會員狀態'];
                form.querySelector('[name="地址"]').value = member['地址'];
                form.querySelector('[name="加入日期"]').value = member['加入日期'] ? member['加入日期'].split('T')[0] : '';
                document.getElementById('memberModalTitle').textContent = '編輯會員';
                memberModal.show();
            }
        }

        async function handleMemberFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const action = data.id ? 'updateMember' : 'addMember';
            
            showLoading(true);
            try {
                await apiCall(action, data);
                showAlert(`會員資料${data.id ? '更新' : '新增'}成功`, 'success');
                memberModal.hide();
                loadMembersData();
                if (currentPage === 'dashboard') loadDashboardData();
            } catch (error) {
                showAlert(error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // --- 交易 (收入/支出) ---
        async function populateTransactionOptions(type) {
            const [accounts, bankAccounts] = await Promise.all([
                apiCall('getAccounts', { type: type, enabledOnly: true }),
                apiCall('getBankAccountOptions')
            ]);
            const accountSelect = document.getElementById('transactionAccountSelect');
            accountSelect.innerHTML = `<option value="">請選擇</option>` + accounts.data.map(a => `<option value="${a['科目名稱']}">${a['科目代碼']} - ${a['科目名稱']}</option>`).join('');
            
            const bankSelect = document.getElementById('transactionBankSelect');
            bankSelect.innerHTML = `<option value="">無</option>` + bankAccounts.data.map(a => `<option value="${a.label}">${a.label}</option>`).join('');
        }

        async function showIncomeModal() {
            await populateTransactionOptions('收入');
            const form = document.getElementById('transactionForm');
            form.reset();
            form.querySelector('[name="id"]').value = '';
            form.querySelector('[name="type"]').value = 'income';
            document.getElementById('transactionModalTitle').textContent = '新增收入';
            document.getElementById('transactionPartyLabel').textContent = '付款人 *';
            document.querySelector('#transactionForm input[name="日期"]').valueAsDate = new Date();
            document.getElementById('autoGenerateReceiptWrapper').style.display = 'block';
            transactionModal.show();
        }

        async function showExpenseModal() {
            await populateTransactionOptions('支出');
            const form = document.getElementById('transactionForm');
            form.reset();
            form.querySelector('[name="id"]').value = '';
            form.querySelector('[name="type"]').value = 'expense';
            document.getElementById('transactionModalTitle').textContent = '新增支出';
            document.getElementById('transactionPartyLabel').textContent = '收款人 *';
            document.querySelector('#transactionForm input[name="日期"]').valueAsDate = new Date();
            document.getElementById('autoGenerateReceiptWrapper').style.display = 'none';
            transactionModal.show();
        }

        async function editTransaction(id, type) {
            const action = type === 'income' ? 'getIncome' : 'getExpenses';
            await populateTransactionOptions(type === 'income' ? '收入' : '支出');
            const result = await apiCall(action, { id: id });

            if (result.data.length > 0) {
                const item = result.data[0];
                const form = document.getElementById('transactionForm');
                form.reset();
                form.querySelector('[name="id"]').value = item.ID;
                form.querySelector('[name="type"]').value = type;
                form.querySelector('[name="日期"]').value = item['日期'] ? item['日期'].split('T')[0] : '';
                form.querySelector('[name="金額"]').value = item['金額'];
                form.querySelector('[name="會計科目"]').value = item['會計科目'];
                form.querySelector('[name="party"]').value = type === 'income' ? item['付款人'] : item['收款人'];
                form.querySelector('[name="付款方式"]').value = item['付款方式'];
                form.querySelector('[name="銀行帳戶"]').value = item['銀行帳戶'];
                form.querySelector('[name="說明"]').value = item['說明'];
                
                document.getElementById('transactionModalTitle').textContent = `編輯${type === 'income' ? '收入' : '支出'}`;
                document.getElementById('transactionPartyLabel').textContent = `${type === 'income' ? '付款人' : '收款人'} *`;
                document.getElementById('autoGenerateReceiptWrapper').style.display = type === 'income' ? 'block' : 'none';

                transactionModal.show();
            }
        }

        async function handleTransactionFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const type = data.type;
            
            // 根據類型調整欄位名稱
            if (type === 'income') {
                data['付款人'] = data.party;
            } else {
                data['收款人'] = data.party;
            }
            delete data.party;

            const action = data.id 
                ? (type === 'income' ? 'updateIncome' : 'updateExpense')
                : (type === 'income' ? 'addIncome' : 'addExpense');

            showLoading(true);
            try {
                await apiCall(action, data);
                showAlert(`記錄${data.id ? '更新' : '新增'}成功`, 'success');
                transactionModal.hide();
                if (type === 'income') await loadIncomeData();
                else await loadExpensesData();
                if (currentPage === 'dashboard') await loadDashboardData();
            } catch (error) {
                showAlert(error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        // --- 銀行帳戶 ---
        function showBankAccountModal() {
            document.getElementById('bankAccountForm').reset();
            document.querySelector('#bankAccountForm input[name="id"]').value = '';
            document.getElementById('bankAccountModalTitle').textContent = '新增銀行帳戶';
            document.getElementById('bankAccountEnabled').checked = true;
            bankAccountModal.show();
        }

        async function editBankAccount(id) {
            const result = await apiCall('getBankAccounts', { id: id });
            if (result.data.length > 0) {
                const item = result.data[0];
                const form = document.getElementById('bankAccountForm');
                form.querySelector('[name="id"]').value = item.ID;
                form.querySelector('[name="帳戶名稱"]').value = item['帳戶名稱'];
                form.querySelector('[name="銀行名稱"]').value = item['銀行名稱'];
                form.querySelector('[name="帳號"]').value = item['帳號'];
                form.querySelector('[name="目前餘額"]').value = item['目前餘額'];
                form.querySelector('[name="是否啟用"]').checked = item['是否啟用'];
                document.getElementById('bankAccountModalTitle').textContent = '編輯銀行帳戶';
                bankAccountModal.show();
            }
        }

        async function handleBankAccountFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data['是否啟用'] = form.querySelector('[name="是否啟用"]').checked;
            const action = data.id ? 'updateBankAccount' : 'addBankAccount';
            
            showLoading(true);
            try {
                await apiCall(action, data);
                showAlert(`銀行帳戶${data.id ? '更新' : '新增'}成功`, 'success');
                bankAccountModal.hide();
                loadBankAccountsData();
                if (currentPage === 'dashboard') loadDashboardData();
            } catch (error) {
                showAlert(error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // =============================================================================
        // 操作功能 (刪除, 核准, 系統管理)
        // =============================================================================
        async function deleteItem(id, action, reloadFunction) {
            if (!confirm('確定要刪除此項目嗎？此操作無法復原。')) return;
            showLoading(true);
            try {
                await apiCall(action, { id: id });
                showAlert('刪除成功', 'success');
                await reloadFunction();
                if (currentPage === 'dashboard') await loadDashboardData();
            } catch (error) {
                showAlert(error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        async function approveExpense(id) {
            if (!confirm('確定要核准這筆支出嗎？')) return;
            showLoading(true);
            try {
                await apiCall('approveExpense', { id: id, approver: '管理員' });
                showAlert('支出已核准', 'success');
                await loadExpensesData();
            } catch (error) {
                showAlert(error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        async function saveOrganizationInfo(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('orgName').value,
                address: document.getElementById('orgAddress').value,
                phone: document.getElementById('orgPhone').value,
                email: document.getElementById('orgEmail').value,
                taxId: document.getElementById('orgTaxId').value,
            };
            showLoading(true);
            try {
                await apiCall('updateOrganizationInfo', data);
                showAlert('組織資訊更新成功', 'success');
            } catch (error) {
                showAlert(error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        async function createBackup() {
            if (!confirm('確定要建立系統備份嗎？')) return;
            showLoading(true);
            try {
                const result = await apiCall('createBackup');
                showAlert(`備份成功！<a href="${result.data.backupUrl}" target="_blank">點此查看</a>`, 'success');
            } catch (error) {
                showAlert(error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        async function cleanupSystem() {
            if (!confirm('確定要清理系統中的所有空白行嗎？')) return;
            showLoading(true);
            try {
                const result = await apiCall('cleanupSystem');
                showAlert(result.message, 'success');
            } catch (error) {
                showAlert(error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        async function resetSettings() {
            if (!confirm('警告：確定要重置所有系統設定嗎？此操作無法復原。')) return;
            showLoading(true);
            try {
                await apiCall('resetSettings');
                showAlert('系統設定已重置', 'success');
                await loadSystemSettings();
            } catch (error) {
                showAlert(error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // =============================================================================
        // 圖表與報表
        // =============================================================================
        function initializeCharts() {
            const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
            if (chartInstances.incomeExpenseChart) chartInstances.incomeExpenseChart.destroy();
            chartInstances.incomeExpenseChart = new Chart(ctx, {
// ... 接續上一段 JavaScript ...
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: '收入', data: [], borderColor: '#28a745', backgroundColor: 'rgba(40, 167, 69, 0.1)', tension: 0.3, fill: true },
                        { label: '支出', data: [], borderColor: '#dc3545', backgroundColor: 'rgba(220, 53, 69, 0.1)', tension: 0.3, fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: value => `NT$ ${value / 1000}k` } } }
                }
            });
        }

        function updateIncomeExpenseChart(monthlyData = []) {
            if (!chartInstances.incomeExpenseChart) initializeCharts();
            const chart = chartInstances.incomeExpenseChart;
            
            const labels = monthlyData.map(d => d.month);
            const income = monthlyData.map(d => d.income);
            const expenses = monthlyData.map(d => d.expenses);

            chart.data.labels = labels;
            chart.data.datasets[0].data = income;
            chart.data.datasets[1].data = expenses;
            chart.update();
        }

        async function generateFinancialReport() {
            showLoading(true);
            try {
                const result = await apiCall('getFinancialReport');
                displayFinancialReport(result.data);
            } catch(error) {
                showAlert(error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        function displayFinancialReport(data) {
            const container = document.getElementById('reportContent');
            const netIncomeClass = data.summary.netIncome >= 0 ? 'text-success' : 'text-danger';
            let html = `<h4>財務報表 (${data.period.startDate} ~ ${data.period.endDate})</h4><hr>`;
            html += `<div class="row mb-3">
                <div class="col-md-4"><h5>總收入</h5><p class="h4 text-success">${formatCurrency(data.summary.totalIncome)}</p></div>
                <div class="col-md-4"><h5>總支出</h5><p class="h4 text-danger">${formatCurrency(data.summary.totalExpenses)}</p></div>
                <div class="col-md-4"><h5>本期損益</h5><p class="h4 ${netIncomeClass}">${formatCurrency(data.summary.netIncome)}</p></div>
            </div>`;
            
            const incomeDetails = Object.entries(data.income.byAccount).map(([acc, stats]) => `<tr><td>${acc}</td><td class="text-end">${formatCurrency(stats.amount)}</td></tr>`).join('');
            const expenseDetails = Object.entries(data.expenses.byAccount).map(([acc, stats]) => `<tr><td>${acc}</td><td class="text-end">${formatCurrency(stats.amount)}</td></tr>`).join('');

            html += `<div class="row"><div class="col-md-6"><h6>收入明細</h6><table class="table table-sm"><tbody>${incomeDetails}</tbody></table></div>
                <div class="col-md-6"><h6>支出明細</h6><table class="table table-sm"><tbody>${expenseDetails}</tbody></table></div></div>`;
            container.innerHTML = html;
        }
        
        async function generateBalanceSheet() {
            showLoading(true);
            try {
                const result = await apiCall('getBalanceSheet');
                const data = result.data;
                const container = document.getElementById('reportContent');
                container.innerHTML = `<h4>資產負債表 (截至 ${data.generatedAt.split(' ')[0]})</h4><hr>
                    <div class="row">
                        <div class="col-md-6">
                            <h5>資產</h5>
                            <table class="table">
                                <tr><td>銀行存款</td><td class="text-end">${formatCurrency(data.assets.bankDeposits)}</td></tr>
                                <tr class="table-light"><th>總資產</th><th class="text-end">${formatCurrency(data.assets.total)}</th></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>負債及權益</h5>
                             <table class="table">
                                <tr><td>應付帳款 (待審核支出)</td><td class="text-end">${formatCurrency(data.liabilities.accountsPayable)}</td></tr>
                                <tr class="table-light"><th>總負債</th><th class="text-end">${formatCurrency(data.liabilities.total)}</th></tr>
                                <tr><td>累積盈餘</td><td class="text-end">${formatCurrency(data.equity.retainedEarnings)}</td></tr>
                                <tr class="table-light"><th>總權益</th><th class="text-end">${formatCurrency(data.equity.total)}</th></tr>
                                <tr class="table-primary"><th>負債及權益總計</th><th class="text-end">${formatCurrency(data.liabilities.total + data.equity.total)}</th></tr>
                            </table>
                        </div>
                    </div>`;
            } catch(error) {
                showAlert(error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        async function generateCashFlowReport() {
            showLoading(true);
            try {
                const result = await apiCall('getCashFlowReport');
                const data = result.data;
                const container = document.getElementById('reportContent');
                container.innerHTML = `<h4>現金流量表 (${data.period.startDate} ~ ${data.period.endDate})</h4><hr>
                    <table class="table">
                        <tbody>
                            <tr class="table-light"><th colspan="2">營業活動現金流量</th></tr>
                            <tr><td>現金流入 (總收入)</td><td class="text-end">${formatCurrency(data.operating.cashInflows)}</td></tr>
                            <tr><td>現金流出 (總支出)</td><td class="text-end">(${formatCurrency(data.operating.cashOutflows)})</td></tr>
                            <tr><th>營業活動淨現金流量</th><th class="text-end">${formatCurrency(data.operating.netCashFlow)}</th></tr>
                            <tr class="table-light"><th colspan="2">投資與籌資活動現金流量</th></tr>
                            <tr><td>(本系統未記錄)</td><td class="text-end">0</td></tr>
                            <tr class="table-primary"><th>本期現金淨增加(減少)</th><th class="text-end">${formatCurrency(data.netIncrease)}</th></tr>
                        </tbody>
                    </table>`;
            } catch(error) {
                showAlert(error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        async function generateDonationReport() {
            showLoading(true);
            try {
                const result = await apiCall('getDonationReport');
                const data = result.data;
                const container = document.getElementById('reportContent');
                let html = `<h4>捐款報表 (${data.period.startDate} ~ ${data.period.endDate})</h4><hr>
                    <p><strong>總捐款金額:</strong> ${formatCurrency(data.totalAmount)}</p>
                    <p><strong>總筆數:</strong> ${data.count}</p>
                    <table class="table table-sm table-striped"><thead><tr><th>日期</th><th>捐款人</th><th>金額</th></tr></thead><tbody>`;
                data.donations.forEach(d => {
                    html += `<tr><td>${formatDate(d['日期'])}</td><td>${d['付款人']}</td><td class="text-end">${formatCurrency(d['金額'])}</td></tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch(error) {
                showAlert(error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>


