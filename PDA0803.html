<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>非營利組織財務管理系統</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
      :root {
          --primary-color: #2c3e50;
          --secondary-color: #3498db;
          --success-color: #27ae60;
          --danger-color: #e74c3c;
          --warning-color: #f39c12;
          --info-color: #17a2b8;
          --light-color: #f8f9fa;
          --dark-color: #343a40;
      }

      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background-color: var(--light-color);
      }

      .navbar {
          background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      .navbar-brand {
          font-weight: bold;
          font-size: 1.5rem;
      }

      .sidebar {
          background: white;
          min-height: calc(100vh - 76px);
          box-shadow: 2px 0 10px rgba(0,0,0,0.1);
          padding: 0;
      }

      .sidebar .nav-link {
          color: var(--dark-color);
          padding: 15px 20px;
          border-bottom: 1px solid #eee;
          transition: all 0.3s;
      }

      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
          background-color: var(--secondary-color);
          color: white;
          transform: translateX(5px);
      }

      .sidebar .nav-link i {
          width: 20px;
          margin-right: 10px;
      }

      .main-content {
          padding: 30px;
          background-color: var(--light-color);
          min-height: calc(100vh - 76px);
      }

      .card {
          border: none;
          border-radius: 15px;
          box-shadow: 0 5px 20px rgba(0,0,0,0.1);
          transition: transform 0.3s;
      }

      .card:hover {
          transform: translateY(-5px);
      }

      .card-header {
          background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
          color: white;
          border-radius: 15px 15px 0 0 !important;
          padding: 20px;
      }

      .stats-card {
          background: linear-gradient(135deg, var(--success-color), #2ecc71);
          color: white;
          border-radius: 15px;
          padding: 25px;
          margin-bottom: 20px;
      }

      .stats-card.income {
          background: linear-gradient(135deg, var(--success-color), #2ecc71);
      }

      .stats-card.expense {
          background: linear-gradient(135deg, var(--danger-color), #c0392b);
      }

      .stats-card.balance {
          background: linear-gradient(135deg, var(--info-color), #3498db);
      }

      .stats-card.members {
          background: linear-gradient(135deg, var(--warning-color), #e67e22);
      }

      .btn-primary {
          background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
          border: none;
          border-radius: 25px;
          padding: 10px 25px;
          transition: all 0.3s;
      }

      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      }

      .table {
          border-radius: 10px;
          overflow: hidden;
      }

      .table thead th {
          background-color: var(--primary-color);
          color: white;
          border: none;
      }

      .modal-content {
          border-radius: 15px;
          border: none;
      }

      .modal-header {
          background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
          color: white;
          border-radius: 15px 15px 0 0;
      }

      .form-control, .form-select {
          border-radius: 10px;
          border: 2px solid #e9ecef;
          transition: border-color 0.3s;
      }

      .form-control:focus, .form-select:focus {
          border-color: var(--secondary-color);
          box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
      }

      .loading {
          display: none;
          text-align: center;
          padding: 50px;
      }

      .spinner-border {
          color: var(--secondary-color);
      }

      .alert {
          border-radius: 10px;
          border: none;
      }

      .page-title {
          color: var(--primary-color);
          margin-bottom: 30px;
          font-weight: bold;
      }

      .action-buttons {
          margin-bottom: 20px;
      }

      .search-box {
          max-width: 300px;
          margin-left: auto;
      }

      .tab-content {
          background: white;
          border-radius: 0 15px 15px 15px;
          padding: 30px;
          box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      }

      .nav-tabs .nav-link {
          border-radius: 15px 15px 0 0;
          border: none;
          color: var(--dark-color);
          margin-right: 5px;
      }

      .nav-tabs .nav-link.active {
          background-color: white;
          color: var(--primary-color);
          font-weight: bold;
      }

      .chart-container {
          position: relative;
          height: 400px;
          margin: 20px 0;
      }

      @media (max-width: 768px) {
          .sidebar {
              position: fixed;
              top: 76px;
              left: -250px;
              width: 250px;
              z-index: 1000;
              transition: left 0.3s;
          }

          .sidebar.show {
              left: 0;
          }

          .main-content {
              margin-left: 0;
              padding: 15px;
          }
      }
  </style>
</head>
<body>
  <!-- 導航列 -->
  <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
          <button class="navbar-toggler d-lg-none" type="button" id="sidebarToggle">
              <span class="navbar-toggler-icon"></span>
          </button>
          <a class="navbar-brand" href="#">
              <i class="fas fa-chart-line me-2"></i>
              財務管理系統
          </a>
          <div class="navbar-nav ms-auto">
              <div class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                      <i class="fas fa-user-circle me-1"></i>
                      管理員
                  </a>
                  <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#" onclick="showSystemSettings()">
                          <i class="fas fa-cog me-2"></i>系統設定
                      </a></li>
                      <li><a class="dropdown-item" href="#" onclick="systemHealthCheck()">
                          <i class="fas fa-heartbeat me-2"></i>系統檢查
                      </a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item" href="#" onclick="logout()">
                          <i class="fas fa-sign-out-alt me-2"></i>登出
                      </a></li>
                  </ul>
              </div>
          </div>
      </div>
  </nav>

  <div class="container-fluid">
      <div class="row">
          <!-- 側邊欄 -->
          <nav class="col-lg-2 sidebar" id="sidebar">
              <div class="nav flex-column">
                  <a class="nav-link active" href="#" onclick="showDashboard()">
                      <i class="fas fa-tachometer-alt"></i>
                      儀表板
                  </a>
                  <a class="nav-link" href="#" onclick="showMembers()">
                      <i class="fas fa-users"></i>
                      會員管理
                  </a>
                  <a class="nav-link" href="#" onclick="showIncome()">
                      <i class="fas fa-plus-circle"></i>
                      收入管理
                  </a>
                  <a class="nav-link" href="#" onclick="showExpenses()">
                      <i class="fas fa-minus-circle"></i>
                      支出管理
                  </a>
                  <a class="nav-link" href="#" onclick="showBankAccounts()">
                      <i class="fas fa-university"></i>
                      銀行帳戶
                  </a>
                  <a class="nav-link" href="#" onclick="showReceipts()">
                      <i class="fas fa-receipt"></i>
                      電子收據
                  </a>
                  <a class="nav-link" href="#" onclick="showAccounts()">
                      <i class="fas fa-list-alt"></i>
                      會計科目
                  </a>
                  <a class="nav-link" href="#" onclick="showReports()">
                      <i class="fas fa-chart-bar"></i>
                      報表分析
                  </a>
                  <a class="nav-link" href="#" onclick="showSystemManagement()">
                      <i class="fas fa-tools"></i>
                      系統管理
                  </a>
              </div>
          </nav>

          <!-- 主要內容區 -->
          <main class="col-lg-10 main-content">
              <!-- 載入中提示 -->
              <div id="loading" class="loading">
                  <div class="spinner-border" role="status">
                      <span class="visually-hidden">載入中...</span>
                  </div>
                  <p class="mt-3">載入中，請稍候...</p>
              </div>

              <!-- 儀表板 -->
              <div id="dashboard" class="content-section">
                  <h2 class="page-title">
                      <i class="fas fa-tachometer-alt me-2"></i>
                      系統儀表板
                  </h2>
                  
                  <!-- 統計卡片 -->
                  <div class="row mb-4">
                      <div class="col-lg-3 col-md-6">
                          <div class="stats-card members">
                              <div class="d-flex justify-content-between align-items-center">
                                  <div>
                                      <h3 id="totalMembers">0</h3>
                                      <p class="mb-0">總會員數</p>
                                  </div>
                                  <i class="fas fa-users fa-2x opacity-75"></i>
                              </div>
                          </div>
                      </div>
                      <div class="col-lg-3 col-md-6">
                          <div class="stats-card income">
                              <div class="d-flex justify-content-between align-items-center">
                                  <div>
                                      <h3 id="monthlyIncome">NT$ 0</h3>
                                      <p class="mb-0">本月收入</p>
                                  </div>
                                  <i class="fas fa-plus-circle fa-2x opacity-75"></i>
                              </div>
                          </div>
                      </div>
                      <div class="col-lg-3 col-md-6">
                          <div class="stats-card expense">
                              <div class="d-flex justify-content-between align-items-center">
                                  <div>
                                      <h3 id="monthlyExpenses">NT$ 0</h3>
                                      <p class="mb-0">本月支出</p>
                                  </div>
                                  <i class="fas fa-minus-circle fa-2x opacity-75"></i>
                              </div>
                          </div>
                      </div>
                      <div class="col-lg-3 col-md-6">
                          <div class="stats-card balance">
                              <div class="d-flex justify-content-between align-items-center">
                                  <div>
                                      <h3 id="totalBalance">NT$ 0</h3>
                                      <p class="mb-0">銀行餘額</p>
                                  </div>
                                  <i class="fas fa-university fa-2x opacity-75"></i>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- 圖表區域 -->
                  <div class="row">
                      <div class="col-lg-8">
                          <div class="card">
                              <div class="card-header">
                                  <h5 class="mb-0">
                                      <i class="fas fa-chart-line me-2"></i>
                                      收支趨勢圖
                                  </h5>
                              </div>
                              <div class="card-body">
                                  <div class="chart-container">
                                      <canvas id="incomeExpenseChart"></canvas>
                                  </div>
                              </div>
                          </div>
                      </div>
                      <div class="col-lg-4">
                          <div class="card">
                              <div class="card-header">
                                  <h5 class="mb-0">
                                      <i class="fas fa-chart-pie me-2"></i>
                                      收入來源分布
                                  </h5>
                              </div>
                              <div class="card-body">
                                  <div class="chart-container">
                                      <canvas id="incomeSourceChart"></canvas>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- 最近活動 -->
                  <div class="row mt-4">
                      <div class="col-12">
                          <div class="card">
                              <div class="card-header">
                                  <h5 class="mb-0">
                                      <i class="fas fa-clock me-2"></i>
                                      最近活動
                                  </h5>
                              </div>
                              <div class="card-body">
                                  <div id="recentActivities">
                                      <p class="text-muted">載入中...</p>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 會員管理 -->
              <div id="members" class="content-section" style="display: none;">
                  <h2 class="page-title">
                      <i class="fas fa-users me-2"></i>
                      會員管理
                  </h2>

                  <div class="action-buttons d-flex justify-content-between align-items-center">
                      <div>
                          <button class="btn btn-primary" onclick="showAddMemberModal()">
                              <i class="fas fa-plus me-2"></i>新增會員
                          </button>
                          <button class="btn btn-success" onclick="exportMembers()">
                              <i class="fas fa-download me-2"></i>匯出資料
                          </button>
                          <button class="btn btn-info" onclick="showImportMembersModal()">
                              <i class="fas fa-upload me-2"></i>批量匯入
                          </button>
                      </div>
                      <div class="search-box">
                          <input type="text" class="form-control" id="memberSearch" placeholder="搜尋會員...">
                      </div>
                  </div>

                  <div class="card">
                      <div class="card-body">
                          <div class="table-responsive">
                              <table id="membersTable" class="table table-striped table-hover">
                                  <thead>
                                      <tr>
                                          <th>姓名</th>
                                          <th>電話</th>
                                          <th>電子郵件</th>
                                          <th>會員類型</th>
                                          <th>加入日期</th>
                                          <th>狀態</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      <!-- 動態載入 -->
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 收入管理 -->
              <div id="income" class="content-section" style="display: none;">
                  <h2 class="page-title">
                      <i class="fas fa-plus-circle me-2"></i>
                      收入管理
                  </h2>

                  <div class="action-buttons d-flex justify-content-between align-items-center">
                      <div>
                          <button class="btn btn-primary" onclick="showAddIncomeModal()">
                              <i class="fas fa-plus me-2"></i>新增收入
                          </button>
                          <button class="btn btn-success" onclick="exportIncome()">
                              <i class="fas fa-download me-2"></i>匯出資料
                          </button>
                      </div>
                      <div class="d-flex gap-2">
                          <input type="month" class="form-control" id="incomeMonthFilter" style="width: 150px;">
                          <select class="form-select" id="incomeCategoryFilter" style="width: 150px;">
                              <option value="">所有類別</option>
                          </select>
                      </div>
                  </div>

                  <div class="card">
                      <div class="card-body">
                          <div class="table-responsive">
                              <table id="incomeTable" class="table table-striped table-hover">
                                  <thead>
                                      <tr>
                                          <th>日期</th>
                                          <th>捐款人</th>
                                          <th>金額</th>
                                          <th>收入類別</th>
                                          <th>銀行帳戶</th>
                                          <th>收據編號</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      <!-- 動態載入 -->
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 支出管理 -->
              <div id="expenses" class="content-section" style="display: none;">
                  <h2 class="page-title">
                      <i class="fas fa-minus-circle me-2"></i>
                      支出管理
                  </h2>

                  <div class="action-buttons d-flex justify-content-between align-items-center">
                      <div>
                          <button class="btn btn-primary" onclick="showAddExpenseModal()">
                              <i class="fas fa-plus me-2"></i>新增支出
                          </button>
                          <button class="btn btn-success" onclick="exportExpenses()">
                              <i class="fas fa-download me-2"></i>匯出資料
                          </button>
                      </div>
                      <div class="d-flex gap-2">
                          <input type="month" class="form-control" id="expenseMonthFilter" style="width: 150px;">
                          <select class="form-select" id="expenseStatusFilter" style="width: 120px;">
                              <option value="">所有狀態</option>
                              <option value="待核准">待核准</option>
                              <option value="已核准">已核准</option>
                              <option value="已拒絕">已拒絕</option>
                          </select>
                      </div>
                  </div>

                  <div class="card">
                      <div class="card-body">
                          <div class="table-responsive">
                              <table id="expensesTable" class="table table-striped table-hover">
                                  <thead>
                                      <tr>
                                          <th>日期</th>
                                          <th>項目</th>
                                          <th>金額</th>
                                          <th>類別</th>
                                          <th>申請人</th>
                                          <th>狀態</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      <!-- 動態載入 -->
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 銀行帳戶管理 -->
              <div id="bankAccounts" class="content-section" style="display: none;">
                  <h2 class="page-title">
                      <i class="fas fa-university me-2"></i>
                      銀行帳戶管理
                  </h2>

                  <div class="action-buttons d-flex justify-content-between align-items-center">
                      <div>
                          <button class="btn btn-primary" onclick="showAddBankAccountModal()">
                              <i class="fas fa-plus me-2"></i>新增帳戶
                          </button>
                          <button class="btn btn-info" onclick="showReconcileModal()">
                              <i class="fas fa-balance-scale me-2"></i>帳戶對帳
                          </button>
                      </div>
                  </div>

                  <div class="row mb-4">
                      <div class="col-12">
                          <div class="card">
                              <div class="card-header">
                                  <h5 class="mb-0">
                                      <i class="fas fa-chart-pie me-2"></i>
                                      帳戶餘額總覽
                                  </h5>
                              </div>
                              <div class="card-body">
                                  <div id="bankAccountsSummary">
                                      <p class="text-muted">載入中...</p>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="card">
                      <div class="card-body">
                          <div class="table-responsive">
                              <table id="bankAccountsTable" class="table table-striped table-hover">
                                  <thead>
                                      <tr>
                                          <th>帳戶名稱</th>
                                          <th>銀行名稱</th>
                                          <th>帳號</th>
                                          <th>類型</th>
                                          <th>目前餘額</th>
                                          <th>狀態</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      <!-- 動態載入 -->
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 電子收據管理 -->
              <div id="receipts" class="content-section" style="display: none;">
                  <h2 class="page-title">
                      <i class="fas fa-receipt me-2"></i>
                      電子收據管理
                  </h2>

                  <div class="action-buttons d-flex justify-content-between align-items-center">
                      <div>
                          <button class="btn btn-primary" onclick="showGenerateReceiptModal()">
                              <i class="fas fa-plus me-2"></i>生成收據
                          </button>
                          <button class="btn btn-success" onclick="exportReceipts()">
                              <i class="fas fa-download me-2"></i>匯出列表
                          </button>
                      </div>
                      <div class="d-flex gap-2">
                          <input type="month" class="form-control" id="receiptMonthFilter" style="width: 150px;">
                          <select class="form-select" id="receiptStatusFilter" style="width: 120px;">
                              <option value="">所有狀態</option>
                              <option value="已生成">已生成</option>
                              <option value="已發送">已發送</option>
                              <option value="發送失敗">發送失敗</option>
                          </select>
                      </div>
                  </div>

                  <div class="card">
                      <div class="card-body">
                          <div class="table-responsive">
                              <table id="receiptsTable" class="table table-striped table-hover">
                                  <thead>
                                      <tr>
                                          <th>收據編號</th>
                                          <th>捐款人</th>
                                          <th>金額</th>
                                          <th>日期</th>
                                          <th>類型</th>
                                          <th>狀態</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      <!-- 動態載入 -->
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 會計科目管理 -->
              <div id="accounts" class="content-section" style="display: none;">
                  <h2 class="page-title">
                      <i class="fas fa-list-alt me-2"></i>
                      會計科目管理
                  </h2>

                  <div class="action-buttons d-flex justify-content-between align-items-center">
                      <div>
                          <button class="btn btn-primary" onclick="showAddAccountModal()">
                              <i class="fas fa-plus me-2"></i>新增科目
                          </button>
                          <button class="btn btn-success" onclick="exportAccounts()">
                              <i class="fas fa-download me-2"></i>匯出科目表
                          </button>
                      </div>
                      <div>
                          <select class="form-select" id="accountTypeFilter" style="width: 150px;">
                              <option value="">所有類型</option>
                              <option value="資產">資產</option>
                              <option value="負債">負債</option>
                              <option value="淨資產">淨資產</option>
                              <option value="收入">收入</option>
                              <option value="支出">支出</option>
                          </select>
                      </div>
                  </div>

                  <div class="card">
                      <div class="card-body">
                          <div class="table-responsive">
                              <table id="accountsTable" class="table table-striped table-hover">
                                  <thead>
                                      <tr>
                                          <th>科目代碼</th>
                                          <th>科目名稱</th>
                                          <th>類型</th>
                                          <th>層級</th>
                                          <th>上級科目</th>
                                          <th>狀態</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      <!-- 動態載入 -->
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 報表分析 -->
              <div id="reports" class="content-section" style="display: none;">
                  <h2 class="page-title">
                      <i class="fas fa-chart-bar me-2"></i>
                      報表分析
                  </h2>

                  <ul class="nav nav-tabs" id="reportTabs">
                      <li class="nav-item">
                          <a class="nav-link active" href="#monthlyReport" data-bs-toggle="tab">月報表</a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#annualReport" data-bs-toggle="tab">年報表</a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#donorReport" data-bs-toggle="tab">捐款人報表</a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#budgetReport" data-bs-toggle="tab">預算報表</a>
                      </li>
                  </ul>

                  <div class="tab-content" id="reportTabContent">
                      <!-- 月報表 -->
                      <div class="tab-pane fade show active" id="monthlyReport">
                          <div class="row mb-3">
                              <div class="col-md-4">
                                  <label class="form-label">選擇年月</label>
                                  <input type="month" class="form-control" id="monthlyReportDate">
                              </div>
                              <div class="col-md-4 d-flex align-items-end">
                                  <button class="btn btn-primary" onclick="generateMonthlyReport()">
                                      <i class="fas fa-chart-line me-2"></i>生成報表
                                  </button>
                              </div>
                          </div>
                          <div id="monthlyReportContent">
                              <p class="text-muted">請選擇年月並點擊生成報表</p>
                          </div>
                      </div>

                      <!-- 年報表 -->
                      <div class="tab-pane fade" id="annualReport">
                          <div class="row mb-3">
                              <div class="col-md-4">
                                  <label class="form-label">選擇年度</label>
                                  <select class="form-select" id="annualReportYear">
                                      <!-- 動態生成年份選項 -->
                                  </select>
                              </div>
                              <div class="col-md-4 d-flex align-items-end">
                                  <button class="btn btn-primary" onclick="generateAnnualReport()">
                                      <i class="fas fa-chart-bar me-2"></i>生成報表
                                  </button>
                              </div>
                          </div>
                          <div id="annualReportContent">
                              <p class="text-muted">請選擇年度並點擊生成報表</p>
                          </div>
                      </div>

                      <!-- 捐款人報表 -->
                      <div class="tab-pane fade" id="donorReport">
                          <div class="row mb-3">
                              <div class="col-md-3">
                                  <label class="form-label">開始日期</label>
                                  <input type="date" class="form-control" id="donorReportStartDate">
                              </div>
                              <div class="col-md-3">
                                  <label class="form-label">結束日期</label>
                                  <input type="date" class="form-control" id="donorReportEndDate">
                              </div>
                              <div class="col-md-3">
                                  <label class="form-label">最低金額</label>
                                  <input type="number" class="form-control" id="donorReportMinAmount" placeholder="0">
                              </div>
                              <div class="col-md-3 d-flex align-items-end">
                                  <button class="btn btn-primary" onclick="generateDonorReport()">
                                      <i class="fas fa-users me-2"></i>生成報表
                                  </button>
                              </div>
                          </div>
                          <div id="donorReportContent">
                              <p class="text-muted">請設定查詢條件並點擊生成報表</p>
                          </div>
                      </div>

                      <!-- 預算報表 -->
                      <div class="tab-pane fade" id="budgetReport">
                          <div class="row mb-3">
                              <div class="col-md-4">
                                  <label class="form-label">預算年度</label>
                                  <select class="form-select" id="budgetReportYear">
                                      <!-- 動態生成年份選項 -->
                                  </select>
                              </div>
                              <div class="col-md-4 d-flex align-items-end">
                                  <button class="btn btn-primary" onclick="generateBudgetReport()">
                                      <i class="fas fa-calculator me-2"></i>生成報表
                                  </button>
                              </div>
                          </div>
                          <div id="budgetReportContent">
                              <p class="text-muted">請選擇預算年度並點擊生成報表</p>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 系統管理 -->
              <div id="systemManagement" class="content-section" style="display: none;">
                  <h2 class="page-title">
                      <i class="fas fa-tools me-2"></i>
                      系統管理
                  </h2>

                  <div class="row">
                      <!-- 系統狀態 -->
                      <div class="col-lg-6">
                          <div class="card mb-4">
                              <div class="card-header">
                                  <h5 class="mb-0">
                                      <i class="fas fa-heartbeat me-2"></i>
                                      系統狀態
                                  </h5>
                              </div>
                              <div class="card-body">
                                  <div id="systemStatus">
                                      <p class="text-muted">載入中...</p>
                                  </div>
                                  <button class="btn btn-info" onclick="systemHealthCheck()">
                                      <i class="fas fa-sync me-2"></i>檢查系統狀態
                                  </button>
                              </div>
                          </div>
                      </div>

                      <!-- 備份管理 -->
                      <div class="col-lg-6">
                          <div class="card mb-4">
                              <div class="card-header">
                                  <h5 class="mb-0">
                                      <i class="fas fa-database me-2"></i>
                                      備份管理
                                  </h5>
                              </div>
                              <div class="card-body">
                                  <div id="backupInfo">
                                      <p class="text-muted">載入中...</p>
                                  </div>
                                  <div class="d-flex gap-2">
                                      <button class="btn btn-success" onclick="createBackup()">
                                          <i class="fas fa-save me-2"></i>立即備份
                                      </button>
                                      <button class="btn btn-warning" onclick="showRestoreModal()">
                                          <i class="fas fa-undo me-2"></i>還原備份
                                      </button>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <!-- 資料清理 -->
                      <div class="col-lg-6">
                          <div class="card mb-4">
                              <div class="card-header">
                                  <h5 class="mb-0">
                                      <i class="fas fa-broom me-2"></i>
                                      資料清理
                                  </h5>
                              </div>
                              <div class="card-body">
                                  <p>清理系統中的冗餘資料和暫存檔案</p>
                                  <button class="btn btn-warning" onclick="showCleanupModal()">
                                      <i class="fas fa-trash-alt me-2"></i>開始清理
                                  </button>
                              </div>
                          </div>
                      </div>

                      <!-- 系統設定 -->
                      <div class="col-lg-6">
                          <div class="card mb-4">
                              <div class="card-header">
                                  <h5 class="mb-0">
                                      <i class="fas fa-cog me-2"></i>
                                      系統設定
                                  </h5>
                              </div>
                              <div class="card-body">
                                  <p>管理系統基本設定和參數</p>
                                  <button class="btn btn-primary" onclick="showSystemSettings()">
                                      <i class="fas fa-edit me-2"></i>編輯設定
                                  </button>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </main>
      </div>
  </div>

  <!-- 模態視窗區域 -->
  
  <!-- 新增會員模態視窗 -->
  <div class="modal fade" id="addMemberModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="fas fa-user-plus me-2"></i>新增會員
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="addMemberForm">
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">姓名 *</label>
                                  <input type="text" class="form-control" name="姓名" required>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">電話 *</label>
                                  <input type="tel" class="form-control" name="電話" required>
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">電子郵件</label>
                                  <input type="email" class="form-control" name="電子郵件">
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">會員類型</label>
                                  <select class="form-select" name="會員類型">
                                      <option value="一般會員">一般會員</option>
                                      <option value="贊助會員">贊助會員</option>
                                      <option value="榮譽會員">榮譽會員</option>
                                  </select>
                              </div>
                          </div>
                      </div>
                      <div class="mb-3">
                          <label class="form-label">地址</label>
                          <textarea class="form-control" name="地址" rows="2"></textarea>
                      </div>
                      <div class="mb-3">
                          <label class="form-label">備註</label>
                          <textarea class="form-control" name="備註" rows="2"></textarea>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="addMember()">新增會員</button>
              </div>
          </div>
      </div>
  </div>

  <!-- 新增收入模態視窗 -->
  <div class="modal fade" id="addIncomeModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="fas fa-plus-circle me-2"></i>新增收入記錄
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="addIncomeForm">
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">日期 *</label>
                                  <input type="date" class="form-control" name="日期" required>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">金額 *</label>
                                  <input type="number" class="form-control" name="金額" step="0.01" required>
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">捐款人</label>
                                  <input type="text" class="form-control" name="捐款人">
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">收入類別</label>
                                  <select class="form-select" name="收入類別" id="incomeCategory">
                                      <!-- 動態載入 -->
                                  </select>
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">銀行帳戶</label>
                                  <select class="form-select" name="銀行帳戶" id="incomeBankAccount">
                                      <!-- 動態載入 -->
                                  </select>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">會計科目</label>
                                  <select class="form-select" name="會計科目" id="incomeAccount">
                                      <!-- 動態載入 -->
                                  </select>
                              </div>
                          </div>
                      </div>
                      <div class="mb-3">
                          <label class="form-label">說明</label>
                          <textarea class="form-control" name="說明" rows="2"></textarea>
                      </div>
                      <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="generateReceipt">
                          <label class="form-check-label" for="generateReceipt">
                              自動生成收據
                          </label>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="addIncome()">新增收入</button>
              </div>
          </div>
      </div>
  </div>

  <!-- 新增支出模態視窗 -->
  <div class="modal fade" id="addExpenseModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="fas fa-minus-circle me-2"></i>新增支出記錄
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="addExpenseForm">
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">日期 *</label>
                                  <input type="date" class="form-control" name="日期" required>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">金額 *</label>
                                  <input type="number" class="form-control" name="金額" step="0.01" required>
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">項目 *</label>
                                  <input type="text" class="form-control" name="項目" required>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">支出類別</label>
                                  <select class="form-select" name="支出類別" id="expenseCategory">
                                      <!-- 動態載入 -->
                                  </select>
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">申請人</label>
                                  <input type="text" class="form-control" name="申請人">
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">銀行帳戶</label>
                                  <select class="form-select" name="銀行帳戶" id="expenseBankAccount">
                                      <!-- 動態載入 -->
                                  </select>
                              </div>
                          </div>
                      </div>
                      <div class="mb-3">
                          <label class="form-label">說明</label>
                          <textarea class="form-control" name="說明" rows="2"></textarea>
                      </div>
                      <div class="mb-3">
                          <label class="form-label">收據檔案</label>
                          <input type="file" class="form-control" id="expenseReceipt" accept="image/*,application/pdf">
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="addExpense()">新增支出</button>
              </div>
          </div>
      </div>
  </div>

  <!-- 新增銀行帳戶模態視窗 -->
  <div class="modal fade" id="addBankAccountModal" tabindex="-1">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="fas fa-university me-2"></i>新增銀行帳戶
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="addBankAccountForm">
                      <div class="mb-3">
                          <label class="form-label">帳戶名稱 *</label>
                          <input type="text" class="form-control" name="帳戶名稱" required>
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">銀行名稱 *</label>
                                  <input type="text" class="form-control" name="銀行名稱" required>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label class="form-label">帳戶類型</label>
                                  <select class="form-select" name="帳戶類型">
                                      <option value="支票帳戶">支票帳戶</option>
                                      <option value="儲蓄帳戶">儲蓄帳戶</option>
                                      <option value="定期存款">定期存款</option>
                                      <option value="外幣帳戶">外幣帳戶</option>
                                  </select>
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-8">
                              <div class="mb-3">
                                  <label class="form-label">帳號 *</label>
                                  <input type="text" class="form-control" name="帳號" required>
                              </div>
                          </div>
                          <div class="col-md-4">
                              <div class="mb-3">
                                  <label class="form-label">幣別</label>
                                  <select class="form-select" name="幣別">
                                      <option value="TWD">TWD</option>
                                      <option value="USD">USD</option>
                                      <option value="EUR">EUR</option>
                                      <option value="JPY">JPY</option>
                                  </select>
                              </div>
                          </div>
                      </div>
                      <div class="mb-3">
                          <label class="form-label">初始餘額</label>
                          <input type="number" class="form-control" name="目前餘額" step="0.01" value="0">
                      </div>
                      <div class="mb-3">
                          <label class="form-label">說明</label>
                          <textarea class="form-control" name="說明" rows="2"></textarea>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="addBankAccount()">新增帳戶</button>
              </div>
          </div>
      </div>
  </div>

  <!-- JavaScript 引用 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.32/sweetalert2.min.js"></script>

  <script>
      // 全域變數
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyAzz8QxpSv8mHIOvW18Fv7bweD5sPd16ERIhlxlrYkzh_cXeMBFEtjACLgFI3XJCy9/exec'; // 請替換為實際的Web App URL
      let currentSection = 'dashboard';
      let dataCache = {};

      // 頁面載入完成後初始化
      $(document).ready(function() {
          initializeApp();
      });

      // 初始化應用程式
      function initializeApp() {
          // 設定當前日期
          const today = new Date().toISOString().split('T')[0];
          const currentMonth = new Date().toISOString().slice(0, 7);
          
          $('input[type="date"]').val(today);
          $('input[type="month"]').val(currentMonth);
          
          // 生成年份選項
          generateYearOptions();
          
          // 載入儀表板
          showDashboard();
          
          // 設定事件監聽器
          setupEventListeners();
          
          // 載入基礎資料
          loadBaseData();
      }

      // 設定事件監聽器
      function setupEventListeners() {
          // 側邊欄切換
          $('#sidebarToggle').click(function() {
              $('#sidebar').toggleClass('show');
          });

          // 搜尋功能
          $('#memberSearch').on('input', debounce(function() {
              if ($.fn.DataTable.isDataTable('#membersTable')) {
                  $('#membersTable').DataTable().search(this.value).draw();
              }
          }, 300));

          // 篩選器
          $('#incomeMonthFilter, #incomeCategoryFilter').change(function() {
              loadIncomeData();
          });

          $('#expenseMonthFilter, #expenseStatusFilter').change(function() {
              loadExpensesData();
          });

          $('#receiptMonthFilter, #receiptStatusFilter').change(function() {
              loadReceiptsData();
          });

          $('#accountTypeFilter').change(function() {
              loadAccountsData();
          });
      }

      // API調用函數
      async function callAPI(action, data = {}) {
          showLoading(true);
          
          try {
              const response = await fetch(WEB_APP_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: action,
                      data: data
                  })
              });

              const result = await response.json();
              
              if (!result.success && result.message) {
                  showAlert('error', result.message);
              }
              
              return result;
          } catch (error) {
              console.error('API調用錯誤:', error);
              showAlert('error', '網路錯誤或服務不可用');
              return {
                  success: false,
                  message: '網路錯誤或服務不可用',
                  error: error.message
              };
          } finally {
              showLoading(false);
          }
      }

      // 載入基礎資料
      async function loadBaseData() {
          try {
              // 載入銀行帳戶選項
              const bankAccountsResult = await callAPI('getBankAccountOptions');
              if (bankAccountsResult.success) {
                  updateBankAccountOptions(bankAccountsResult.data);
              }

              // 載入收入類別
              const incomeCategories = await callAPI('getSetting', { key: 'income_categories' });
              if (incomeCategories.success) {
                  updateCategoryOptions('#incomeCategory', JSON.parse(incomeCategories.data.value || '[]'));
              }

              // 載入支出類別
              const expenseCategories = await callAPI('getSetting', { key: 'expense_categories' });
              if (expenseCategories.success) {
                  updateCategoryOptions('#expenseCategory', JSON.parse(expenseCategories.data.value || '[]'));
              }

              // 載入會計科目選項
              const accountsResult = await callAPI('getAccountOptions');
              if (accountsResult.success) {
                  updateAccountOptions(accountsResult.data);
              }

          } catch (error) {
              console.error('載入基礎資料錯誤:', error);
          }
      }

      // 更新銀行帳戶選項
      function updateBankAccountOptions(options) {
          const selectors = ['#incomeBankAccount', '#expenseBankAccount'];
          
          selectors.forEach(selector => {
              const $select = $(selector);
              $select.empty().append('<option value="">請選擇帳戶</option>');
              
              options.forEach(option => {
                  $select.append(`<option value="${option.value}">${option.label}</option>`);
              });
          });
      }

      // 更新類別選項
      function updateCategoryOptions(selector, categories) {
          const $select = $(selector);
          $select.empty().append('<option value="">請選擇類別</option>');
          
          categories.forEach(category => {
              $select.append(`<option value="${category}">${category}</option>`);
          });
      }

      // 更新會計科目選項
      function updateAccountOptions(options) {
          const selectors = ['#incomeAccount'];
          
          selectors.forEach(selector => {
              const $select = $(selector);
              $select.empty().append('<option value="">請選擇科目</option>');
              
              options.forEach(option => {
                  $select.append(`<option value="${option.code}">${option.code} - ${option.name}</option>`);
              });
          });
      }

      // 顯示載入狀態
      function showLoading(show) {
          if (show) {
              $('#loading').show();
          } else {
              $('#loading').hide();
          }
      }

      // 顯示提示訊息
      function showAlert(type, message, title = '') {
          const icons = {
              success: 'success',
              error: 'error',
              warning: 'warning',
              info: 'info'
          };

          Swal.fire({
              icon: icons[type] || 'info',              
              title: title || (type === 'success' ? '成功' : type === 'error' ? '錯誤' : '提示'),
              text: message,
              confirmButtonColor: '#3498db',
              timer: type === 'success' ? 3000 : undefined,
              timerProgressBar: type === 'success'
          });
      }

      // 防抖函數
      function debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
              const later = () => {
                  clearTimeout(timeout);
                  func(...args);
              };
              clearTimeout(timeout);
              timeout = setTimeout(later, wait);
          };
      }

      // 生成年份選項
      function generateYearOptions() {
          const currentYear = new Date().getFullYear();
          const yearSelectors = ['#annualReportYear', '#budgetReportYear'];
          
          yearSelectors.forEach(selector => {
              const $select = $(selector);
              $select.empty();
              
              for (let year = currentYear; year >= currentYear - 10; year--) {
                  $select.append(`<option value="${year}">${year}</option>`);
              }
          });
      }

      // 格式化金額
      function formatCurrency(amount, currency = 'TWD') {
          const formatter = new Intl.NumberFormat('zh-TW', {
              style: 'currency',
              currency: currency,
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
          });
          return formatter.format(amount || 0);
      }

      // 格式化日期
      function formatDate(dateString) {
          if (!dateString) return '';
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW');
      }

      // 切換內容區域
      function switchSection(sectionName) {
          // 隱藏所有內容區域
          $('.content-section').hide();
          
          // 顯示指定區域
          $(`#${sectionName}`).show();
          
          // 更新導航狀態
          $('.sidebar .nav-link').removeClass('active');
          $(`.sidebar .nav-link[onclick="show${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)}()"]`).addClass('active');
          
          currentSection = sectionName;
      }

      // 儀表板相關函數
      async function showDashboard() {
          switchSection('dashboard');
          await loadDashboardData();
      }

      async function loadDashboardData() {
          try {
              // 載入統計資料
              const statsResult = await callAPI('getDashboardStats');
              if (statsResult.success) {
                  updateDashboardStats(statsResult.data);
              }

              // 載入圖表資料
              await loadDashboardCharts();
              
              // 載入最近活動
              await loadRecentActivities();
              
          } catch (error) {
              console.error('載入儀表板資料錯誤:', error);
          }
      }

      function updateDashboardStats(stats) {
          $('#totalMembers').text(stats.totalMembers || 0);
          $('#monthlyIncome').text(formatCurrency(stats.monthlyIncome || 0));
          $('#monthlyExpenses').text(formatCurrency(stats.monthlyExpenses || 0));
          $('#totalBalance').text(formatCurrency(stats.totalBalance || 0));
      }

      async function loadDashboardCharts() {
          try {
              // 收支趨勢圖
              const trendResult = await callAPI('getIncomeExpenseTrend', { 
                  months: 12 
              });
              
              if (trendResult.success) {
                  createIncomeExpenseChart(trendResult.data);
              }

              // 收入來源分布圖
              const sourceResult = await callAPI('getIncomeSourceDistribution');
              if (sourceResult.success) {
                  createIncomeSourceChart(sourceResult.data);
              }
              
          } catch (error) {
              console.error('載入圖表資料錯誤:', error);
          }
      }

      function createIncomeExpenseChart(data) {
          const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
          
          new Chart(ctx, {
              type: 'line',
              data: {
                  labels: data.labels,
                  datasets: [{
                      label: '收入',
                      data: data.income,
                      borderColor: '#27ae60',
                      backgroundColor: 'rgba(39, 174, 96, 0.1)',
                      tension: 0.4
                  }, {
                      label: '支出',
                      data: data.expenses,
                      borderColor: '#e74c3c',
                      backgroundColor: 'rgba(231, 76, 60, 0.1)',
                      tension: 0.4
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: {
                          position: 'top',
                      }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          ticks: {
                              callback: function(value) {
                                  return formatCurrency(value);
                              }
                          }
                      }
                  }
              }
          });
      }

      function createIncomeSourceChart(data) {
          const ctx = document.getElementById('incomeSourceChart').getContext('2d');
          
          new Chart(ctx, {
              type: 'doughnut',
              data: {
                  labels: data.labels,
                  datasets: [{
                      data: data.values,
                      backgroundColor: [
                          '#3498db',
                          '#2ecc71',
                          '#f39c12',
                          '#e74c3c',
                          '#9b59b6',
                          '#1abc9c'
                      ]
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: {
                          position: 'bottom'
                      }
                  }
              }
          });
      }

      async function loadRecentActivities() {
          try {
              const result = await callAPI('getRecentActivities', { limit: 10 });
              if (result.success) {
                  displayRecentActivities(result.data);
              }
          } catch (error) {
              console.error('載入最近活動錯誤:', error);
          }
      }

      function displayRecentActivities(activities) {
          const container = $('#recentActivities');
          
          if (activities.length === 0) {
              container.html('<p class="text-muted">暫無最近活動</p>');
              return;
          }

          let html = '<div class="list-group">';
          activities.forEach(activity => {
              const icon = getActivityIcon(activity.type);
              const time = formatDate(activity.timestamp);
              
              html += `
                  <div class="list-group-item d-flex align-items-center">
                      <i class="${icon} me-3 text-primary"></i>
                      <div class="flex-grow-1">
                          <div class="fw-bold">${activity.title}</div>
                          <small class="text-muted">${activity.description}</small>
                      </div>
                      <small class="text-muted">${time}</small>
                  </div>
              `;
          });
          html += '</div>';
          
          container.html(html);
      }

      function getActivityIcon(type) {
          const icons = {
              member: 'fas fa-user-plus',
              income: 'fas fa-plus-circle',
              expense: 'fas fa-minus-circle',
              receipt: 'fas fa-receipt',
              system: 'fas fa-cog'
          };
          return icons[type] || 'fas fa-info-circle';
      }

      // 會員管理相關函數
      async function showMembers() {
          switchSection('members');
          await loadMembersData();
      }

      async function loadMembersData() {
          try {
              const result = await callAPI('getMembers');
              if (result.success) {
                  displayMembersTable(result.data);
              }
          } catch (error) {
              console.error('載入會員資料錯誤:', error);
          }
      }

      function displayMembersTable(data) {
          // 如果表格已存在，先銷毀
          if ($.fn.DataTable.isDataTable('#membersTable')) {
              $('#membersTable').DataTable().destroy();
          }

          const tableBody = $('#membersTable tbody');
          tableBody.empty();

          data.forEach(member => {
              const statusBadge = member['是否啟用'] ? 
                  '<span class="badge bg-success">啟用</span>' : 
                  '<span class="badge bg-secondary">停用</span>';

              const row = `
                  <tr>
                      <td>${member['姓名'] || ''}</td>
                      <td>${member['電話'] || ''}</td>
                      <td>${member['電子郵件'] || ''}</td>
                      <td>${member['會員類型'] || ''}</td>
                      <td>${formatDate(member['加入日期'])}</td>
                      <td>${statusBadge}</td>
                      <td>
                          <button class="btn btn-sm btn-outline-primary" onclick="editMember('${member.ID}')">
                              <i class="fas fa-edit"></i>
                          </button>
                          <button class="btn btn-sm btn-outline-danger" onclick="deleteMember('${member.ID}')">
                              <i class="fas fa-trash"></i>
                          </button>
                      </td>
                  </tr>
              `;
              tableBody.append(row);
          });

          // 初始化DataTable
          $('#membersTable').DataTable({
              language: {
                  url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
              },
              pageLength: 25,
              order: [[4, 'desc']], // 按加入日期降序排列
              columnDefs: [
                  { orderable: false, targets: [6] } // 操作欄不可排序
              ]
          });
      }

      function showAddMemberModal() {
          $('#addMemberForm')[0].reset();
          $('#addMemberModal').modal('show');
      }

      async function addMember() {
          const form = document.getElementById('addMemberForm');
          const formData = new FormData(form);
          const memberData = Object.fromEntries(formData.entries());

          // 驗證必填欄位
          if (!memberData['姓名'] || !memberData['電話']) {
              showAlert('warning', '請填寫必填欄位');
              return;
          }

          try {
              const result = await callAPI('addMember', memberData);
              if (result.success) {
                  showAlert('success', '會員新增成功');
                  $('#addMemberModal').modal('hide');
                  await loadMembersData();
              }
          } catch (error) {
              console.error('新增會員錯誤:', error);
          }
      }

      async function editMember(memberId) {
          // 實作編輯會員功能
          showAlert('info', '編輯功能開發中');
      }

      async function deleteMember(memberId) {
          const result = await Swal.fire({
              title: '確認刪除',
              text: '確定要刪除此會員嗎？此操作無法復原。',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#e74c3c',
              cancelButtonColor: '#6c757d',
              confirmButtonText: '確定刪除',
              cancelButtonText: '取消'
          });

          if (result.isConfirmed) {
              try {
                  const deleteResult = await callAPI('deleteMember', { id: memberId });
                  if (deleteResult.success) {
                      showAlert('success', '會員刪除成功');
                      await loadMembersData();
                  }
              } catch (error) {
                  console.error('刪除會員錯誤:', error);
              }
          }
      }

      async function exportMembers() {
          try {
              const result = await callAPI('exportData', { 
                  dataType: 'members',
                  format: 'csv'
              });
              
              if (result.success && result.data.downloadUrl) {
                  window.open(result.data.downloadUrl, '_blank');
                  showAlert('success', '會員資料匯出成功');
              }
          } catch (error) {
              console.error('匯出會員資料錯誤:', error);
          }
      }

      function showImportMembersModal() {
          showAlert('info', '批量匯入功能開發中');
      }

      // 收入管理相關函數
      async function showIncome() {
          switchSection('income');
          await loadIncomeData();
      }

      async function loadIncomeData() {
          try {
              const filters = {
                  month: $('#incomeMonthFilter').val(),
                  category: $('#incomeCategoryFilter').val()
              };

              const result = await callAPI('getIncome', filters);
              if (result.success) {
                  displayIncomeTable(result.data);
              }
          } catch (error) {
              console.error('載入收入資料錯誤:', error);
          }
      }

      function displayIncomeTable(data) {
          if ($.fn.DataTable.isDataTable('#incomeTable')) {
              $('#incomeTable').DataTable().destroy();
          }

          const tableBody = $('#incomeTable tbody');
          tableBody.empty();

          data.forEach(income => {
              const row = `
                  <tr>
                      <td>${formatDate(income['日期'])}</td>
                      <td>${income['捐款人'] || ''}</td>
                      <td class="text-end">${formatCurrency(income['金額'])}</td>
                      <td>${income['收入類別'] || ''}</td>
                      <td>${income['銀行帳戶'] || ''}</td>
                      <td>${income['收據編號'] || ''}</td>
                      <td>
                          <button class="btn btn-sm btn-outline-primary" onclick="editIncome('${income.ID}')">
                              <i class="fas fa-edit"></i>
                          </button>
                          <button class="btn btn-sm btn-outline-danger" onclick="deleteIncome('${income.ID}')">
                              <i class="fas fa-trash"></i>
                          </button>
                      </td>
                  </tr>
              `;
              tableBody.append(row);
          });

          $('#incomeTable').DataTable({
              language: {
                  url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
              },
              pageLength: 25,
              order: [[0, 'desc']],
              columnDefs: [
                  { orderable: false, targets: [6] }
              ]
          });
      }

      function showAddIncomeModal() {
          $('#addIncomeForm')[0].reset();
          // 設定預設日期為今天
          $('input[name="日期"]').val(new Date().toISOString().split('T')[0]);
          $('#addIncomeModal').modal('show');
      }

      async function addIncome() {
          const form = document.getElementById('addIncomeForm');
          const formData = new FormData(form);
          const incomeData = Object.fromEntries(formData.entries());

          // 驗證必填欄位
          if (!incomeData['日期'] || !incomeData['金額']) {
              showAlert('warning', '請填寫必填欄位');
              return;
          }

          // 轉換金額為數字
          incomeData['金額'] = parseFloat(incomeData['金額']);

          try {
              const result = await callAPI('addIncome', incomeData);
              if (result.success) {
                  showAlert('success', '收入記錄新增成功');
                  $('#addIncomeModal').modal('hide');
                  
                  // 如果勾選自動生成收據
                  if ($('#generateReceipt').is(':checked') && incomeData['捐款人']) {
                      await generateReceiptForIncome(result.data.id, incomeData);
                  }
                  
                  await loadIncomeData();
              }
          } catch (error) {
              console.error('新增收入記錄錯誤:', error);
          }
      }

      async function generateReceiptForIncome(incomeId, incomeData) {
          try {
              const receiptData = {
                  '捐款人姓名': incomeData['捐款人'],
                  '捐款金額': incomeData['金額'],
                  '捐款日期': incomeData['日期'],
                  '捐款用途': incomeData['說明'] || '一般捐款',
                  '收據類型': '個人捐贈',
                  '發送方式': 'download'
              };

              const result = await callAPI('generateReceipt', receiptData);
              if (result.success) {
                  showAlert('success', '收據已自動生成');
              }
          } catch (error) {
              console.error('生成收據錯誤:', error);
          }
      }

      async function editIncome(incomeId) {
          showAlert('info', '編輯功能開發中');
      }

      async function deleteIncome(incomeId) {
          const result = await Swal.fire({
              title: '確認刪除',
              text: '確定要刪除此收入記錄嗎？',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#e74c3c',
              cancelButtonColor: '#6c757d',
              confirmButtonText: '確定刪除',
              cancelButtonText: '取消'
          });

          if (result.isConfirmed) {
              try {
                  const deleteResult = await callAPI('deleteIncome', { id: incomeId });
                  if (deleteResult.success) {
                      showAlert('success', '收入記錄刪除成功');
                      await loadIncomeData();
                  }
              } catch (error) {
                  console.error('刪除收入記錄錯誤:', error);
              }
          }
      }

      async function exportIncome() {
          try {
              const result = await callAPI('exportData', { 
                  dataType: 'income',
                  format: 'csv'
              });
              
              if (result.success && result.data.downloadUrl) {
                  window.open(result.data.downloadUrl, '_blank');
                  showAlert('success', '收入資料匯出成功');
              }
          } catch (error) {
              console.error('匯出收入資料錯誤:', error);
          }
      }

      // 支出管理相關函數
      async function showExpenses() {
          switchSection('expenses');
          await loadExpensesData();
      }

      async function loadExpensesData() {
          try {
              const filters = {
                  month: $('#expenseMonthFilter').val(),
                  status: $('#expenseStatusFilter').val()
              };

              const result = await callAPI('getExpenses', filters);
              if (result.success) {
                  displayExpensesTable(result.data);
              }
          } catch (error) {
              console.error('載入支出資料錯誤:', error);
          }
      }

      function displayExpensesTable(data) {
          if ($.fn.DataTable.isDataTable('#expensesTable')) {
              $('#expensesTable').DataTable().destroy();
          }

          const tableBody = $('#expensesTable tbody');
          tableBody.empty();

          data.forEach(expense => {
              const statusBadge = getExpenseStatusBadge(expense['核准狀態']);
              
              const row = `
                  <tr>
                      <td>${formatDate(expense['日期'])}</td>
                      <td>${expense['項目'] || ''}</td>
                      <td class="text-end">${formatCurrency(expense['金額'])}</td>
                      <td>${expense['支出類別'] || ''}</td>
                      <td>${expense['申請人'] || ''}</td>
                      <td>${statusBadge}</td>
                      <td>
                          ${expense['核准狀態'] === '待核准' ? `
                              <button class="btn btn-sm btn-outline-success" onclick="approveExpense('${expense.ID}')">
                                  <i class="fas fa-check"></i>
                              </button>
                              <button class="btn btn-sm btn-outline-danger" onclick="rejectExpense('${expense.ID}')">
                                  <i class="fas fa-times"></i>
                              </button>
                          ` : ''}
                          <button class="btn btn-sm btn-outline-primary" onclick="editExpense('${expense.ID}')">
                              <i class="fas fa-edit"></i>
                          </button>
                      </td>
                  </tr>
              `;
              tableBody.append(row);
          });

          $('#expensesTable').DataTable({
              language: {
                  url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
              },
              pageLength: 25,
              order: [[0, 'desc']],
              columnDefs: [
                  { orderable: false, targets: [6] }
              ]
          });
      }

      function getExpenseStatusBadge(status) {
          const badges = {
              '待核准': '<span class="badge bg-warning">待核准</span>',
              '已核准': '<span class="badge bg-success">已核准</span>',
              '已拒絕': '<span class="badge bg-danger">已拒絕</span>'
          };
          return badges[status] || '<span class="badge bg-secondary">未知</span>';
      }

      function showAddExpenseModal() {
          $('#addExpenseForm')[0].reset();
          $('input[name="日期"]').val(new Date().toISOString().split('T')[0]);
          $('#addExpenseModal').modal('show');
      }

      async function addExpense() {
          const form = document.getElementById('addExpenseForm');
          const formData = new FormData(form);
          const expenseData = Object.fromEntries(formData.entries());

          if (!expenseData['日期'] || !expenseData['項目'] || !expenseData['金額']) {
              showAlert('warning', '請填寫必填欄位');
              return;
          }

          expenseData['金額'] = parseFloat(expenseData['金額']);
          expenseData['核准狀態'] = '待核准';

          try {
              const result = await callAPI('addExpense', expenseData);
              if (result.success) {
                  showAlert('success', '支出記錄新增成功');
                  $('#addExpenseModal').modal('hide');
                  await loadExpensesData();
              }
          } catch (error) {
              console.error('新增支出記錄錯誤:', error);
          }
      }

      async function approveExpense(expenseId) {
          const result = await Swal.fire({
              title: '核准支出',
              text: '確定要核准此筆支出嗎？',
              icon: 'question',
              showCancelButton: true,
              confirmButtonColor: '#27ae60',
              cancelButtonColor: '#6c757d',
              confirmButtonText: '確定核准',
              cancelButtonText: '取消'
          });

          if (result.isConfirmed) {
              try {
                  const approveResult = await callAPI('approveExpense', { 
                      id: expenseId,
                      approver: '系統管理員'
                  });
                  
                  if (approveResult.success) {
                      showAlert('success', '支出已核准');
                      await loadExpensesData();
                  }
              } catch (error) {
                  console.error('核准支出錯誤:', error);
              }
          }
      }

      async function rejectExpense(expenseId) {
          const { value: reason } = await Swal.fire({
              title: '拒絕支出',
              input: 'textarea',
              inputLabel: '請輸入拒絕理由',
              inputPlaceholder: '請說明拒絕的原因...',
              showCancelButton: true,
              confirmButtonText: '確定拒絕',
              cancelButtonText: '取消',
              inputValidator: (value) => {
                  if (!value) {
                      return '請輸入拒絕理由'
                  }
              }
          });

          if (reason) {
              try {
                  const rejectResult = await callAPI('rejectExpense', { 
                      id: expenseId,
                      reason: reason
                  });
                  
                  if (rejectResult.success) {
                      showAlert('success', '支出已拒絕');
                      await loadExpensesData();
                  }
              } catch (error) {
                  console.error('拒絕支出錯誤:', error);
              }
          }
      }

      async function editExpense(expenseId) {
          showAlert('info', '編輯功能開發中');
      }

      async function exportExpenses() {
          try {
              const result = await callAPI('exportData', { 
                  dataType: 'expenses',
                  format: 'csv'
              });
              
              if (result.success && result.data.downloadUrl) {
                  window.open(result.data.downloadUrl, '_blank');
                  showAlert('success', '支出資料匯出成功');
              }
          } catch (error) {
              console.error('匯出支出資料錯誤:', error);
          }
      }

      // 銀行帳戶管理相關函數
      async function showBankAccounts() {
          switchSection('bankAccounts');
          await loadBankAccountsData();
      }

      async function loadBankAccountsData() {
          try {
              const result = await callAPI('getBankAccounts');
              if (result.success) {
                  displayBankAccountsTable(result.data);
                  await loadBankAccountsSummary();
              }
          } catch (error) {
              console.error('載入銀行帳戶資料錯誤:', error);
          }
      }

      function displayBankAccountsTable(data) {
          if ($.fn.DataTable.isDataTable('#bankAccountsTable')) {
              $('#bankAccountsTable').DataTable().destroy();
          }

          const tableBody = $('#bankAccountsTable tbody');
          tableBody.empty();

          data.forEach(account => {
              const statusBadge = account['是否啟用'] ? 
                  '<span class="badge bg-success">啟用</span>' : 
                  '<span class="badge bg-secondary">停用</span>';

              const row = `
                  <tr>
                      <td>${account['帳戶名稱'] || ''}</td>
                      <td>${account['銀行名稱'] || ''}</td>
                      <td>${account['帳號'] || ''}</td>
                      <td>${account['帳戶類型'] || ''}</td>
                      <td class="text-end">${formatCurrency(account['目前餘額'], account['幣別'])}</td>
                      <td>${statusBadge}</td>
                      <td>
                          <button class="btn btn-sm btn-outline-info" onclick="reconcileAccount('${account.ID}')">
                              <i class="fas fa-balance-scale"></i>
                          </button>
                          <button class="btn btn-sm btn-outline-primary" onclick="editBankAccount('${account.ID}')">
                              <i class="fas fa-edit"></i>
                          </button>
                      </td>
                  </tr>
              `;
              tableBody.append(row);
          });

          $('#bankAccountsTable').DataTable({
              language: {
                  url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
              },
              pageLength: 25,
              columnDefs: [
                  { orderable: false, targets: [6] }
              ]
          });
      }

      async function loadBankAccountsSummary() {
          try {
              const result = await callAPI('getTotalBankBalance');
              if (result.success) {
                  displayBankAccountsSummary(result.data);
              }
          } catch (error) {
              console.error('載入銀行帳戶總覽錯誤:', error);
          }
      }

      function displayBankAccountsSummary(data) {
          const summary = $('#bankAccountsSummary');
          
          let html = `
              <div class="row">
                  <div class="col-md-4">
                      <div class="text-center">
                          <h4 class="text-primary">${data.totalAccounts}</h4>
                          <p class="text-muted mb-0">總帳戶數</p>
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="text-center">
                          <h4 class="text-success">${formatCurrency(data.totalTWD)}</h4>
                          <p class="text-muted mb-0">台幣總餘額</p>
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="text-center">
                          <h4 class="text-info">${formatCurrency(data.totalUSD, 'USD')}</h4>
                          <p class="text-muted mb-0">美金總餘額</p>
                      </div>
                  </div>
              </div>
          `;
          
          summary.html(html);
      }

      function showAddBankAccountModal() {
          $('#addBankAccountForm')[0].reset();
          $('#addBankAccountModal').modal('show');
      }

      async function addBankAccount() {
          const form = document.getElementById('addBankAccountForm');
          const formData = new FormData(form);
          const accountData = Object.fromEntries(formData.entries());

          if (!accountData['帳戶名稱'] || !accountData['銀行名稱'] || !accountData['帳號']) {
              showAlert('warning', '請填寫必填欄位');
              return;
          }

          accountData['目前餘額'] = parseFloat(accountData['目前餘額'] || 0);
          accountData['是否啟用'] = true;

          try {
              const result = await callAPI('addBankAccount', accountData);
              if (result.success) {
                  showAlert('success', '銀行帳戶新增成功');
                  $('#addBankAccountModal').modal('hide');
                  await loadBankAccountsData();
              }
          } catch (error) {
              console.error('新增銀行帳戶錯誤:', error);
          }
      }

      async function reconcileAccount(accountId) {
          const { value: formValues } = await Swal.fire({
              title: '帳戶對帳',
              html: `
                  <div class="mb-3">
                      <label class="form-label">銀行對帳單餘額</label>
                      <input type="number" id="statementBalance" class="form-control" step="0.01" required>
                  </div>
                  <div class="mb-3">
                      <label class="form-label">對帳日期</label>
                      <input type="date" id="reconcileDate" class="form-control" value="${new Date().toISOString().split('T')[0]}" required>
                  </div>
              `,
              focusConfirm: false,
              showCancelButton: true,
              confirmButtonText: '執行對帳',
              cancelButtonText: '取消',
              preConfirm: () => {
                  return {
                      statementBalance: document.getElementById('statementBalance').value,
                      reconcileDate: document.getElementById('reconcileDate').value
                  }
              }
          });

          if (formValues) {
              try {
                  const result = await callAPI('reconcileBankAccount', {
                      accountId: accountId,
                      statementBalance: parseFloat(formValues.statementBalance),
                      reconcileDate: formValues.reconcileDate,
                      autoAdjust: true
                  });

                  if (result.success) {
                      showAlert('success', '帳戶對帳完成');
                      await loadBankAccountsData();
                  }
              } catch (error) {
                  console.error('帳戶對帳錯誤:', error);
              }
          }
      }

      function showReconcileModal() {
          showAlert('info', '請在帳戶列表中點擊對帳按鈕進行個別帳戶對帳');
      }

      async function editBankAccount(accountId) {
          showAlert('info', '編輯功能開發中');
      }

      // 電子收據管理相關函數
      async function showReceipts() {
          switchSection('receipts');
          await loadReceiptsData();
      }

      async function loadReceiptsData() {
          try {
              const filters = {
                  month: $('#receiptMonthFilter').val(),
                  status: $('#receiptStatusFilter').val()
              };

              const result = await callAPI('getReceipts', filters);
              if (result.success) {
                  displayReceiptsTable(result.data);
              }
          } catch (error) {
              console.error('載入收據資料錯誤:', error);
          }
      }

      function displayReceiptsTable(data) {
          if ($.fn.DataTable.isDataTable('#receiptsTable')) {
              $('#receiptsTable').DataTable().destroy();
          }

          const tableBody = $('#receiptsTable tbody');
          tableBody.empty();

          data.forEach(receipt => {
              const statusBadge = getReceiptStatusBadge(receipt['狀態']);
              
              const row = `
                  <tr>
                      <td>${receipt['收據編號'] || ''}</td>
                      <td>${receipt['捐款人姓名'] || ''}</td>
                      <td class="text-end">${formatCurrency(receipt['捐款金額'])}</td>
                      <td>${formatDate(receipt['捐款日期'])}</td>
                      <td>${receipt['收據類型'] || ''}</td>
                      <td>${statusBadge}</td>
                      <td>
                          <button class="btn btn-sm btn-outline-primary" onclick="downloadReceipt('${receipt.ID}')">
                              <i class="fas fa-download"></i>
                          </button>
                          <button class="btn btn-sm btn-outline-success" onclick="resendReceipt('${receipt.ID}')">
                              <i class="fas fa-paper-plane"></i>
                          </button>
                      </td>
                  </tr>
              `;
              tableBody.append(row);
          });

          $('#receiptsTable').DataTable({
              language: {
                  url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
              },
              pageLength: 25,
              order: [[3, 'desc']],
              columnDefs: [
                  { orderable: false, targets: [6] }
              ]
          });
      }

      function getReceiptStatusBadge(status) {
          const badges = {
              '已生成': '<span class="badge bg-info">已生成</span>',
              '已發送': '<span class="badge bg-success">已發送</span>',
              '發送失敗': '<span class="badge bg-danger">發送失敗</span>'
          };
          return badges[status] || '<span class="badge bg-secondary">未知</span>';
      }

      function showGenerateReceiptModal() {
          showAlert('info', '收據生成功能開發中');
      }

      async function downloadReceipt(receiptId) {
          try {
              const result = await callAPI('downloadReceipt', { id: receiptId });
              if (result.success && result.data.downloadUrl) {
                  window.open(result.data.downloadUrl, '_blank');
              }
          } catch (error) {
              console.error('下載收據錯誤:', error);
          }
      }

      async function resendReceipt(receiptId) {
          const { value: email } = await Swal.fire({
              title: '重新發送收據',
              input: 'email',
              inputLabel: '收件人電子郵件',
              inputPlaceholder: '請輸入電子郵件地址',
              showCancelButton: true,
              confirmButtonText: '發送',
              cancelButtonText: '取消',
              inputValidator: (value) => {
                  if (!value) {
                      return '請輸入電子郵件地址'
                  }
                  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                      return '請輸入有效的電子郵件地址'
                  }
              }
          });

          if (email) {
              try {
                  const result = await callAPI('resendReceipt', {
                      receiptId: receiptId,
                      email: email,
                      method: 'email'
                  });

                  if (result.success) {
                      showAlert('success', '收據已重新發送');
                      await loadReceiptsData();
                  }
              } catch (error) {
                  console.error('重新發送收據錯誤:', error);
              }
          }
      }

      async function exportReceipts() {
          try {
              const result = await callAPI('exportData', { 
                  dataType: 'receipts',
                  format: 'csv'
              });
              
              if (result.success && result.data.downloadUrl) {
                  window.open(result.data.downloadUrl, '_blank');
                  showAlert('success', '收據列表匯出成功');
              }
          } catch (error) {
              console.error('匯出收據列表錯誤:', error);
          }
      }

      // 會計科目管理相關函數
      async function showAccounts() {
          switchSection('accounts');
          await loadAccountsData();
      }

      async function loadAccountsData() {
          try {
              const filters = {
                  type: $('#accountTypeFilter').val()
              };

              const result = await callAPI('getAccounts', filters);
              if (result.success) {
                  displayAccountsTable(result.data);
              }
          } catch (error) {
              console.error('載入會計科目資料錯誤:', error);
          }
      }

      function displayAccountsTable(data) {
          if ($.fn.DataTable.isDataTable('#accountsTable')) {
              $('#accountsTable').DataTable().destroy();
          }

          const tableBody = $('#accountsTable tbody');
          tableBody.empty();

          data.forEach(account => {
              const statusBadge = account['是否啟用'] ? 
                  '<span class="badge bg-success">啟用</span>' : 
                  '<span class="badge bg-secondary">停用</span>';

              const row = `
                  <tr>
                      <td>${account['科目代碼'] || ''}</td>
                      <td>${account['科目名稱'] || ''}</td>
                      <td>${account['科目類型'] || ''}</td>
                      <td>${account['層級'] || ''}</td>
                      <td>${account['上級科目'] || ''}</td>
                      <td>${statusBadge}</td>
                      <td>
                          <button class="btn btn-sm btn-outline-primary" onclick="editAccount('${account.ID}')">
                              <i class="fas fa-edit"></i>
                          </button>
                      </td>
                  </tr>
              `;
              tableBody.append(row);
          });

          $('#accountsTable').DataTable({
              language: {
                  url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
              },
              pageLength: 25,
              order: [[0, 'asc']],
              columnDefs: [
                  { orderable: false, targets: [6] }
              ]
          });
      }

      function showAddAccountModal() {
          showAlert('info', '新增會計科目功能開發中');
      }

      async function editAccount(accountId) {
          showAlert('info', '編輯功能開發中');
      }

      async function exportAccounts() {
          try {
              const result = await callAPI('exportData', { 
                  dataType: 'accounts',
                  format: 'csv'
              });
              
              if (result.success && result.data.downloadUrl) {
                  window.open(result.data.downloadUrl, '_blank');
                  showAlert('success', '會計科目表匯出成功');
              }
          } catch (error) {
              console.error('匯出會計科目表錯誤:', error);
          }
      }

      // 報表分析相關函數
      async function showReports() {
          switchSection('reports');
          // 預設載入月報表
          if (!$('#monthlyReportDate').val()) {
              $('#monthlyReportDate').val(new Date().toISOString().slice(0, 7));
          }
      }

      async function generateMonthlyReport() {
          const month = $('#monthlyReportDate').val();
          if (!month) {
              showAlert('warning', '請選擇年月');
              return;
          }

          try {
              const [year, monthNum] = month.split('-');
              const result = await callAPI('generateMonthlyReport', {
                  year: parseInt(year),
                  month: parseInt(monthNum),
                  includeDetails: true,
                  format: 'detailed'
              });

              if (result.success) {
                  displayMonthlyReport(result.data);
              }
          } catch (error) {
              console.error('生成月報表錯誤:', error);
          }
      }

      function displayMonthlyReport(data) {
          const container = $('#monthlyReportContent');
          
          let html = `
              <div class="row mb-4">
                  <div class="col-md-4">
                      <div class="card bg-success text-white">
                          <div class="card-body">
                              <h5>本月收入</h5>
                              <h3>${formatCurrency(data.totalIncome)}</h3>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="card bg-danger text-white">
                          <div class="card-body">
                              <h5>本月支出</h5>
                              <h3>${formatCurrency(data.totalExpenses)}</h3>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="card bg-info text-white">
                          <div class="card-body">
                              <h5>本月結餘</h5>
                              <h3>${formatCurrency(data.netIncome)}</h3>
                          </div>
                      </div>
                  </div>
              </div>
          `;

          if (data.details && data.details.length > 0) {
              html += `
                  <div class="card">
                      <div class="card-header">
                          <h5>詳細記錄</h5>
                      </div>
                      <div class="card-body">
                          <div class="table-responsive">
                              <table class="table table-striped">
                                  <thead>
                                      <tr>
                                          <th>日期</th>
                                          <th>項目</th>
                                          <th>類型</th>
                                          <th>金額</th>
                                      </tr>
                                  </thead>
                                  <tbody>
              `;

              data.details.forEach(item => {
                  const amountClass = item.type === '收入' ? 'text-success' : 'text-danger';
                  const amountPrefix = item.type === '收入' ? '+' : '-';
                  
                  html += `
                      <tr>
                          <td>${formatDate(item.date)}</td>
                          <td>${item.description}</td>
                          <td>${item.type}</td>
                          <td class="${amountClass}">${amountPrefix}${formatCurrency(item.amount)}</td>
                      </tr>
                  `;
              });

              html += `
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              `;
          }

          container.html(html);
      }

      async function generateAnnualReport() {
          const year = $('#annualReportYear').val();
          if (!year) {
              showAlert('warning', '請選擇年度');
              return;
          }

          try {
              const result = await callAPI('generateAnnualReport', {
                  year: parseInt(year),
                  reportType: 'comprehensive',
                  includeCharts: true
              });

              if (result.success) {
                  displayAnnualReport(result.data);
              }
          } catch (error) {
              console.error('生成年報表錯誤:', error);
          }
      }

      function displayAnnualReport(data) {
          const container = $('#annualReportContent');
          
          let html = `
              <div class="row mb-4">
                  <div class="col-md-3">
                      <div class="card bg-primary text-white">
                          <div class="card-body text-center">
                              <h5>年度收入</h5>
                              <h3>${formatCurrency(data.totalIncome)}</h3>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card bg-warning text-white">
                          <div class="card-body text-center">
                              <h5>年度支出</h5>
                              <h3>${formatCurrency(data.totalExpenses)}</h3>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card bg-success text-white">
                          <div class="card-body text-center">
                              <h5>年度結餘</h5>
                              <h3>${formatCurrency(data.netIncome)}</h3>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card bg-info text-white">
                          <div class="card-body text-center">
                              <h5>平均月收入</h5>
                              <h3>${formatCurrency(data.avgMonthlyIncome)}</h3>
                          </div>
                      </div>
                  </div>
              </div>
          `;

          if (data.monthlyData) {
              html += `
                  <div class="card">
                      <div class="card-header">
                          <h5>月度趨勢</h5>
                      </div>
                      <div class="card-body">
                          <canvas id="annualTrendChart" height="400"></canvas>
                      </div>
                  </div>
              `;
          }

          container.html(html);

          // 繪製年度趨勢圖
          if (data.monthlyData) {
              setTimeout(() => {
                  createAnnualTrendChart(data.monthlyData);
              }, 100);
          }
      }

      function createAnnualTrendChart(data) {
          const ctx = document.getElementById('annualTrendChart').getContext('2d');
          
          new Chart(ctx, {
              type: 'bar',
              data: {
                  labels: data.labels,
                  datasets: [{
                      label: '收入',
                      data: data.income,
                      backgroundColor: 'rgba(39, 174, 96, 0.8)'
                  }, {
                      label: '支出',
                      data: data.expenses,
                      backgroundColor: 'rgba(231, 76, 60, 0.8)'
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: {
                          position: 'top',
                      }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          ticks: {
                              callback: function(value) {
                                  return formatCurrency(value);
                              }
                          }
                      }
                  }
              }
          });
      }

      async function generateDonorReport() {
          const startDate = $('#donorReportStartDate').val();
          const endDate = $('#donorReportEndDate').val();
          const minAmount = $('#donorReportMinAmount').val();

          if (!startDate || !endDate) {
              showAlert('warning', '請選擇查詢日期範圍');
              return;
          }

          try {
              const result = await callAPI('generateDonorReport', {
                  startDate: startDate,
                  endDate: endDate,
                  minAmount: parseFloat(minAmount || 0),
                  groupBy: 'month',
                  includeRecurring: true
              });

              if (result.success) {
                  displayDonorReport(result.data);
              }
          } catch (error) {
              console.error('生成捐款人報表錯誤:', error);
          }
      }

      function displayDonorReport(data) {
          const container = $('#donorReportContent');
          
          let html = `
              <div class="row mb-4">
                  <div class="col-md-4">
                      <div class="card bg-info text-white">
                          <div class="card-body text-center">
                              <h5>捐款人數</h5>
                              <h3>${data.totalDonors}</h3>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="card bg-success text-white">
                          <div class="card-body text-center">
                              <h5>總捐款金額</h5>
                              <h3>${formatCurrency(data.totalAmount)}</h3>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="card bg-warning text-white">
                          <div class="card-body text-center">
                              <h5>平均捐款</h5>
                              <h3>${formatCurrency(data.avgAmount)}</h3>
                          </div>
                      </div>
                  </div>
              </div>
          `;

          if (data.donors && data.donors.length > 0) {
              html += `
                  <div class="card">
                      <div class="card-header">
                          <h5>捐款人明細</h5>
                      </div>
                      <div class="card-body">
                          <div class="table-responsive">
                              <table class="table table-striped">
                                  <thead>
                                      <tr>
                                          <th>捐款人</th>
                                          <th>捐款次數</th>
                                          <th>總金額</th>
                                          <th>最後捐款日期</th>
                                      </tr>
                                  </thead>
                                  <tbody>
              `;

              data.donors.forEach(donor => {
                  html += `
                      <tr>
                          <td>${donor.name}</td>
                          <td>${donor.count}</td>
                          <td>${formatCurrency(donor.totalAmount)}</td>
                          <td>${formatDate(donor.lastDonationDate)}</td>
                      </tr>
                  `;
              });

              html += `
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              `;
          }

          container.html(html);
      }

      async function generateBudgetReport() {
          const year = $('#budgetReportYear').val();
          if (!year) {
              showAlert('warning', '請選擇預算年度');
              return;
          }

          try {
              const result = await callAPI('generateBudgetReport', {
                  year: parseInt(year),
                  category: 'all',
                  comparisonType: 'budget_vs_actual'
              });

              if (result.success) {
                  displayBudgetReport(result.data);
              }
          } catch (error) {
              console.error('生成預算報表錯誤:', error);
          }
      }

      function displayBudgetReport(data) {
          const container = $('#budgetReportContent');
          container.html('<p class="text-muted">預算報表功能開發中...</p>');
      }

      // 系統管理相關函數
      async function showSystemManagement() {
          switchSection('systemManagement');
          await loadSystemStatus();
          await loadBackupInfo();
      }

      async function loadSystemStatus() {
          try {
              const result = await callAPI('systemHealthCheck');
              if (result.success) {
                  displaySystemStatus(result.data);
              }
          } catch (error) {
              console.error('載入系統狀態錯誤:', error);
              $('#systemStatus').html('<p class="text-danger">無法載入系統狀態</p>');
          }
      }

      function displaySystemStatus(status) {
          const container = $('#systemStatus');
          
          const statusClass = status.overall === 'healthy' ? 'text-success' : 'text-warning';
          const statusText = status.overall === 'healthy' ? '正常' : '需要注意';
          
          let html = `
              <div class="mb-3">
                  <h6 class="${statusClass}">
                      <i class="fas fa-circle me-2"></i>
                      系統狀態：${statusText}
                  </h6>
              </div>
              <div class="row">
                  <div class="col-6">
                      <small class="text-muted">資料庫連接：</small>
                      <span class="${status.database ? 'text-success' : 'text-danger'}">
                          ${status.database ? '正常' : '異常'}
                      </span>
                  </div>
                  <div class="col-6">
                      <small class="text-muted">郵件服務：</small>
                      <span class="${status.email ? 'text-success' : 'text-danger'}">
                          ${status.email ? '正常' : '異常'}
                      </span>
                  </div>
              </div>
              <div class="row mt-2">
                  <div class="col-6">
                      <small class="text-muted">儲存空間：</small>
                      <span class="text-info">${status.storage}%</span>
                  </div>
                  <div class="col-6">
                      <small class="text-muted">最後檢查：</small>
                      <span class="text-muted">${formatDate(status.lastCheck)}</span>
                  </div>
              </div>
          `;
          
          container.html(html);
      }

      async function systemHealthCheck() {
          await loadSystemStatus();
          showAlert('success', '系統狀態檢查完成');
      }

      async function loadBackupInfo() {
          try {
              const result = await callAPI('getBackupInfo');
              if (result.success) {
                  displayBackupInfo(result.data);
              }
          } catch (error) {
              console.error('載入備份資訊錯誤:', error);
              $('#backupInfo').html('<p class="text-danger">無法載入備份資訊</p>');
          }
      }

      function displayBackupInfo(info) {
          const container = $('#backupInfo');
          
          let html = `
              <div class="mb-3">
                  <small class="text-muted">最後備份：</small>
                  <span class="fw-bold">${formatDate(info.lastBackup) || '從未備份'}</span>
              </div>
              <div class="mb-3">
                  <small class="text-muted">備份檔案數：</small>
                  <span class="fw-bold">${info.backupCount || 0}</span>
              </div>
              <div class="mb-3">
                  <small class="text-muted">自動備份：</small>
                  <span class="${info.autoBackupEnabled ? 'text-success' : 'text-warning'}">
                      ${info.autoBackupEnabled ? '已啟用' : '已停用'}
                  </span>
              </div>
          `;
          
          container.html(html);
      }

      async function createBackup() {
          const result = await Swal.fire({
              title: '建立備份',
              text: '確定要建立系統備份嗎？',
              icon: 'question',
              showCancelButton: true,
              confirmButtonColor: '#27ae60',
              cancelButtonColor: '#6c757d',
              confirmButtonText: '確定備份',
              cancelButtonText: '取消'
          });

          if (result.isConfirmed) {
              try {
                  const backupResult = await callAPI('createSystemBackup', {
                      includeFiles: true,
                      backupName: `手動備份_${new Date().toISOString().slice(0, 10)}`
                  });

                  if (backupResult.success) {
                      showAlert('success', '系統備份建立成功');
                      await loadBackupInfo();
                  }
              } catch (error) {
                  console.error('建立備份錯誤:', error);
              }
          }
      }

      function showRestoreModal() {
          showAlert('info', '還原備份功能開發中');
      }

      function showCleanupModal() {
          showAlert('info', '資料清理功能開發中');
      }

      function showSystemSettings() {
          showAlert('info', '系統設定功能開發中');
      }

      function logout() {
          showAlert('info', '登出功能開發中');
      }

      // 載入SweetAlert2 CSS
      sweetAlertCSS.href = 'https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.32/sweetalert2.min.css';
      document.head.appendChild(sweetAlertCSS);

      // 全域錯誤處理
      window.addEventListener('error', function(e) {
          console.error('JavaScript錯誤:', e.error);
          showAlert('error', '系統發生錯誤，請重新整理頁面或聯繫管理員');
      });

      // 網路連線狀態檢查
      window.addEventListener('online', function() {
          showAlert('success', '網路連線已恢復', '連線狀態');
      });

      window.addEventListener('offline', function() {
          showAlert('warning', '網路連線中斷，部分功能可能無法使用', '連線狀態');
      });

      // 頁面可見性變化處理
      document.addEventListener('visibilitychange', function() {
          if (!document.hidden && currentSection === 'dashboard') {
              // 當頁面重新可見且在儀表板時，重新載入數據
              setTimeout(() => {
                  loadDashboardData();
              }, 1000);
          }
      });

      // 響應式處理
      function handleResize() {
          if (window.innerWidth <= 768) {
              // 移動設備處理
              $('#sidebar').removeClass('show');
          }
      }

      window.addEventListener('resize', debounce(handleResize, 250));

      // 鍵盤快捷鍵
      document.addEventListener('keydown', function(e) {
          // Ctrl + S 儲存當前表單
          if (e.ctrlKey && e.key === 's') {
              e.preventDefault();
              const activeModal = $('.modal.show');
              if (activeModal.length > 0) {
                  const submitBtn = activeModal.find('.btn-primary').last();
                  if (submitBtn.length > 0) {
                      submitBtn.click();
                  }
              }
          }
          
          // ESC 關閉模態視窗
          if (e.key === 'Escape') {
              const activeModal = $('.modal.show');
              if (activeModal.length > 0) {
                  activeModal.modal('hide');
              }
          }
      });

      // 表單驗證增強
      function enhanceFormValidation() {
          // 為所有必填欄位添加即時驗證
          $('input[required], select[required], textarea[required]').on('blur', function() {
              const $this = $(this);
              if (!$this.val()) {
                  $this.addClass('is-invalid');
                  if (!$this.next('.invalid-feedback').length) {
                      $this.after('<div class="invalid-feedback">此欄位為必填</div>');
                  }
              } else {
                  $this.removeClass('is-invalid').addClass('is-valid');
              }
          });

          // 電子郵件格式驗證
          $('input[type="email"]').on('blur', function() {
              const $this = $(this);
              const email = $this.val();
              if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                  $this.addClass('is-invalid');
                  if (!$this.next('.invalid-feedback').length) {
                      $this.after('<div class="invalid-feedback">請輸入有效的電子郵件格式</div>');
                  }
              } else if (email) {
                  $this.removeClass('is-invalid').addClass('is-valid');
              }
          });

          // 電話號碼格式驗證
          $('input[type="tel"]').on('blur', function() {
              const $this = $(this);
              const phone = $this.val();
              if (phone && !/^[\d\-\+\(\)\s]+$/.test(phone)) {
                  $this.addClass('is-invalid');
                  if (!$this.next('.invalid-feedback').length) {
                      $this.after('<div class="invalid-feedback">請輸入有效的電話號碼</div>');
                  }
              } else if (phone) {
                  $this.removeClass('is-invalid').addClass('is-valid');
              }
          });

          // 數字欄位驗證
          $('input[type="number"]').on('blur', function() {
              const $this = $(this);
              const value = $this.val();
              const min = $this.attr('min');
              const max = $this.attr('max');
              
              if (value) {
                  const numValue = parseFloat(value);
                  if (isNaN(numValue)) {
                      $this.addClass('is-invalid');
                      if (!$this.next('.invalid-feedback').length) {
                          $this.after('<div class="invalid-feedback">請輸入有效的數字</div>');
                      }
                  } else if (min && numValue < parseFloat(min)) {
                      $this.addClass('is-invalid');
                      if (!$this.next('.invalid-feedback').length) {
                          $this.after(`<div class="invalid-feedback">數值不能小於 ${min}</div>`);
                      }
                  } else if (max && numValue > parseFloat(max)) {
                      $this.addClass('is-invalid');
                      if (!$this.next('.invalid-feedback').length) {
                          $this.after(`<div class="invalid-feedback">數值不能大於 ${max}</div>`);
                      }
                  } else {
                      $this.removeClass('is-invalid').addClass('is-valid');
                  }
              }
          });
      }

      // 數據快取管理
      const cacheManager = {
          set: function(key, data, expireMinutes = 5) {
              const expireTime = new Date().getTime() + (expireMinutes * 60 * 1000);
              const cacheData = {
                  data: data,
                  expire: expireTime
              };
              localStorage.setItem(`cache_${key}`, JSON.stringify(cacheData));
          },
          
          get: function(key) {
              const cacheStr = localStorage.getItem(`cache_${key}`);
              if (!cacheStr) return null;
              
              try {
                  const cache = JSON.parse(cacheStr);
                  if (new Date().getTime() > cache.expire) {
                      localStorage.removeItem(`cache_${key}`);
                      return null;
                  }
                  return cache.data;
              } catch (e) {
                  localStorage.removeItem(`cache_${key}`);
                  return null;
              }
          },
          
          clear: function(pattern = '') {
              const keys = Object.keys(localStorage);
              keys.forEach(key => {
                  if (key.startsWith('cache_') && key.includes(pattern)) {
                      localStorage.removeItem(key);
                  }
              });
          }
      };

      // 性能監控
      const performanceMonitor = {
          startTime: {},
          
          start: function(operation) {
              this.startTime[operation] = performance.now();
          },
          
          end: function(operation) {
              if (this.startTime[operation]) {
                  const duration = performance.now() - this.startTime[operation];
                  console.log(`操作 ${operation} 耗時: ${duration.toFixed(2)}ms`);
                  delete this.startTime[operation];
                  
                  // 如果操作耗時超過3秒，顯示警告
                  if (duration > 3000) {
                      console.warn(`操作 ${operation} 耗時過長: ${duration.toFixed(2)}ms`);
                  }
              }
          }
      };

      // 增強的API調用函數（帶快取和重試機制）
      async function callAPIWithCache(action, data = {}, useCache = false, retries = 3) {
          const cacheKey = `${action}_${JSON.stringify(data)}`;
          
          // 檢查快取
          if (useCache) {
              const cachedData = cacheManager.get(cacheKey);
              if (cachedData) {
                  console.log(`使用快取數據: ${action}`);
                  return cachedData;
              }
          }
          
          performanceMonitor.start(action);
          
          for (let attempt = 1; attempt <= retries; attempt++) {
              try {
                  const result = await callAPI(action, data);
                  
                  // 成功時儲存快取
                  if (result.success && useCache) {
                      cacheManager.set(cacheKey, result);
                  }
                  
                  performanceMonitor.end(action);
                  return result;
                  
              } catch (error) {
                  console.warn(`API調用失敗 (嘗試 ${attempt}/${retries}):`, error);
                  
                  if (attempt === retries) {
                      performanceMonitor.end(action);
                      throw error;
                  }
                  
                  // 重試前等待
                  await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
              }
          }
      }

      // 批量操作支援
      async function batchOperation(operations, batchSize = 5) {
          const results = [];
          
          for (let i = 0; i < operations.length; i += batchSize) {
              const batch = operations.slice(i, i + batchSize);
              const batchPromises = batch.map(op => callAPI(op.action, op.data));
              
              try {
                  const batchResults = await Promise.all(batchPromises);
                  results.push(...batchResults);
                  
                  // 顯示進度
                  const progress = Math.min(100, Math.round(((i + batchSize) / operations.length) * 100));
                  console.log(`批量操作進度: ${progress}%`);
                  
              } catch (error) {
                  console.error('批量操作錯誤:', error);
                  break;
              }
              
              // 批次間稍作延遲，避免過載
              if (i + batchSize < operations.length) {
                  await new Promise(resolve => setTimeout(resolve, 100));
              }
          }
          
          return results;
      }

      // 匯出功能增強
      async function enhancedExport(dataType, format = 'csv', options = {}) {
          try {
              showLoading(true);
              
              const exportData = {
                  dataType: dataType,
                  format: format,
                  options: {
                      includeHeaders: true,
                      dateFormat: 'YYYY-MM-DD',
                      encoding: 'UTF-8',
                      ...options
                  }
              };
              
              const result = await callAPI('exportData', exportData);
              
              if (result.success) {
                  if (result.data.downloadUrl) {
                      // 創建隱藏的下載連結
                      const link = document.createElement('a');
                      link.href = result.data.downloadUrl;
                      link.download = result.data.filename || `${dataType}_${new Date().toISOString().slice(0, 10)}.${format}`;
                      document.body.appendChild(link);
                      link.click();
                      document.body.removeChild(link);
                      
                      showAlert('success', `${dataType}資料匯出成功`);
                  } else if (result.data.content) {
                      // 直接下載內容
                      downloadContent(result.data.content, result.data.filename, result.data.mimeType);
                      showAlert('success', `${dataType}資料匯出成功`);
                  }
              }
              
          } catch (error) {
              console.error('匯出錯誤:', error);
              showAlert('error', '匯出失敗，請稍後再試');
          } finally {
              showLoading(false);
          }
      }

      // 直接下載內容
      function downloadContent(content, filename, mimeType = 'text/csv') {
          const blob = new Blob([content], { type: mimeType });
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
      }

      // 初始化增強功能
      $(document).ready(function() {
          enhanceFormValidation();
          
          // 設定自動儲存草稿功能
          let autoSaveTimer;
          $('form').on('input change', function() {
              clearTimeout(autoSaveTimer);
              const formId = $(this).attr('id');
              if (formId) {
                  autoSaveTimer = setTimeout(() => {
                      saveFormDraft(formId);
                  }, 2000);
              }
          });
      });

      // 表單草稿儲存
      function saveFormDraft(formId) {
          const form = document.getElementById(formId);
          if (form) {
              const formData = new FormData(form);
              const draftData = Object.fromEntries(formData.entries());
              localStorage.setItem(`draft_${formId}`, JSON.stringify(draftData));
              console.log(`已儲存表單草稿: ${formId}`);
          }
      }

      // 載入表單草稿
      function loadFormDraft(formId) {
          const draftStr = localStorage.getItem(`draft_${formId}`);
          if (draftStr) {
              try {
                  const draftData = JSON.parse(draftStr);
                  const form = document.getElementById(formId);
                  
                  Object.keys(draftData).forEach(name => {
                      const input = form.querySelector(`[name="${name}"]`);
                      if (input) {
                          input.value = draftData[name];
                      }
                  });
                  
                  showAlert('info', '已載入之前的草稿內容');
              } catch (e) {
                  console.error('載入草稿錯誤:', e);
              }
          }
      }

      // 清除表單草稿
      function clearFormDraft(formId) {
          localStorage.removeItem(`draft_${formId}`);
      }

      // 主題切換功能
      function toggleTheme() {
          const currentTheme = document.body.getAttribute('data-theme');
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          
          document.body.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
          
          showAlert('success', `已切換至${newTheme === 'dark' ? '深色' : '淺色'}主題`);
      }

      // 載入儲存的主題
      function loadSavedTheme() {
          const savedTheme = localStorage.getItem('theme') || 'light';
          document.body.setAttribute('data-theme', savedTheme);
      }

      // 頁面載入完成後執行
      $(document).ready(function() {
          loadSavedTheme();
      });
function printReport(elementId) {
    const element = document.getElementById(elementId);
    if (!element) return;

    // 開新視窗
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
        alert('請允許瀏覽器彈出視窗，以使用列印功能');
        return;
    }

    // HTML 內容
    const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>列印報表</title>
            <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
            <style>
                @media print {
                    .no-print { display: none !important; }
                    body { font-size: 12px; }
                    .card { border: 1px solid #ddd; margin-bottom: 20px; }
                }
            </style>
        </head>
        <body>
            <div class="container-fluid">
                ${element.innerHTML}
            </div>
            <script>
                window.onload = function() {
                    setTimeout(function() {
                        window.print();
                        window.onafterprint = function() {
                            window.close();
                        }
                    }, 100);
                }
            <\/script>
        </body>
        </html>
    `;

    // 寫入內容並關閉 document
    printWindow.document.open();
    printWindow.document.write(htmlContent);
    printWindow.document.close();
}


      // 全螢幕功能
      function toggleFullscreen() {
          if (!document.fullscreenElement) {
              document.documentElement.requestFullscreen();
          } else {
              document.exitFullscreen();
          }
      }

      // 語音提示功能（如果瀏覽器支援）
      function speak(text) {
          if ('speechSynthesis' in window) {
              const utterance = new SpeechSynthesisUtterance(text);
              utterance.lang = 'zh-TW';
              speechSynthesis.speak(utterance);
          }
      }

      // 輔助功能增強
      function enhanceAccessibility() {
          // 為所有按鈕添加鍵盤支援
          $('button, .btn').attr('tabindex', '0').on('keydown', function(e) {
              if (e.key === 'Enter' || e.key === ' ') {
                  e.preventDefault();
                  $(this).click();
              }
          });
          
          // 為表格添加鍵盤導航
          $('table').attr('role', 'table');
          $('th').attr('role', 'columnheader');
          $('td').attr('role', 'cell');
          
          // 為模態視窗添加焦點管理
          $('.modal').on('shown.bs.modal', function() {
              $(this).find('input, select, textarea, button').first().focus();
          });
      }

      // 初始化輔助功能
      $(document).ready(function() {
          enhanceAccessibility();
      });

      console.log('非營利組織財務管理系統已載入完成');
      console.log('版本: 1.0.0');
      console.log('最後更新: 2024-08-03');
  </script>
</body>
</html>
