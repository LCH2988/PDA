<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會 - 財務管理系統</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
      .sidebar {
          position: fixed;
          top: 0;
          bottom: 0;
          left: 0;
          z-index: 100;
          padding: 48px 0 0;
          box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
      }

      .sidebar-sticky {
          position: relative;
          top: 0;
          height: calc(100vh - 48px);
          padding-top: .5rem;
          overflow-x: hidden;
          overflow-y: auto;
      }

      .main-content {
          margin-left: 240px;
          padding: 20px;
      }

      .navbar-brand {
          padding-top: .75rem;
          padding-bottom: .75rem;
          font-size: 1rem;
          background-color: rgba(0, 0, 0, .25);
          box-shadow: inset -1px 0 0 rgba(0, 0, 0, .25);
      }

      .sidebar .nav-link {
          font-weight: 500;
          color: #333;
          padding: 0.75rem 1rem;
          margin: 0.125rem 0;
          border-radius: 0.375rem;
          transition: all 0.15s ease-in-out;
      }

      .sidebar .nav-link:hover {
          background-color: rgba(0, 123, 255, 0.1);
          color: #007bff;
      }

      .sidebar .nav-link.active {
          background-color: #007bff;
          color: white;
      }

      .card {
          box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
          border: 1px solid rgba(0, 0, 0, 0.125);
          transition: box-shadow 0.15s ease-in-out;
      }

      .card:hover {
          box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      }

      .border-left-primary { border-left: 4px solid #007bff !important; }
      .border-left-success { border-left: 4px solid #28a745 !important; }
      .border-left-info { border-left: 4px solid #17a2b8 !important; }
      .border-left-warning { border-left: 4px solid #ffc107 !important; }

      .text-xs { font-size: 0.75rem; }
      .font-weight-bold { font-weight: 700 !important; }
      .text-gray-800 { color: #5a5c69 !important; }

      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255, 255, 255, 0.9);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }

      .demo-mode-banner {
          background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
          color: white;
          text-align: center;
          padding: 10px;
          font-weight: bold;
      }

      /* 表格排序指示器 */
      th[data-sort] {
          cursor: pointer;
          user-select: none;
          position: relative;
      }

      th[data-sort]:hover {
          background-color: #f8f9fa;
      }

      th[data-sort]::after {
          content: ' ⇅';
          color: #6c757d;
          font-size: 0.8em;
      }

      th.sort-asc::after {
          content: ' ↑';
          color: #007bff;
      }

      th.sort-desc::after {
          content: ' ↓';
          color: #007bff;
      }

      /* 表單驗證樣式 */
      .is-invalid {
          border-color: #dc3545;
      }

      .is-invalid:focus {
          border-color: #dc3545;
          box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
      }

      /* 搜尋框樣式 */
      .search-box {
          position: relative;
      }

      .search-box .form-control {
          padding-left: 2.5rem;
      }

      .search-box .search-icon {
          position: absolute;
          left: 0.75rem;
          top: 50%;
          transform: translateY(-50%);
          color: #6c757d;
      }

      /* Modal 樣式改進 */
      .modal-header {
          background-color: #f8f9fa;
          border-bottom: 1px solid #dee2e6;
      }

      .modal-footer {
          background-color: #f8f9fa;
          border-top: 1px solid #dee2e6;
      }

      /* 統計卡片動畫 */
      .stats-card {
          transition: transform 0.2s ease-in-out;
      }

      .stats-card:hover {
          transform: translateY(-2px);
      }

      /* 響應式設計 */
      @media (max-width: 767.98px) {
          .sidebar {
              transform: translateX(-100%);
              transition: transform 0.3s ease-in-out;
          }

          .sidebar.show {
              transform: translateX(0);
          }

          .main-content {
              margin-left: 0 !important;
          }

          .table-responsive {
              font-size: 0.875rem;
          }
          
          .btn-group-sm > .btn {
              padding: 0.125rem 0.25rem;
              font-size: 0.75rem;
          }
      }

      /* 列印樣式 */
      @media print {
          .sidebar,
          .navbar,
          .btn,
          .no-print {
              display: none !important;
          }
          
          .main-content {
              margin-left: 0 !important;
          }
          
          .card {
              border: 1px solid #dee2e6 !important;
              box-shadow: none !important;
          }
      }

      /* 自訂樣式 */
      .receipt-preview {
          border: 2px solid #007bff;
          border-radius: 8px;
          padding: 20px;
          background: white;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .receipt-header {
          text-align: center;
          border-bottom: 2px solid #007bff;
          padding-bottom: 15px;
          margin-bottom: 20px;
      }

      .receipt-content {
          line-height: 1.8;
      }

      .form-floating > label {
          color: #6c757d;
      }

      .badge {
          font-size: 0.75em;
      }

      .toast {
          min-width: 300px;
      }

      .toast-header {
          border-bottom: none;
      }

      .spinner-border {
          width: 3rem;
          height: 3rem;
      }
  </style>
</head>

<body>
  <!-- 示範模式橫幅 -->
  <div class="demo-mode-banner">
      <i class="fas fa-info-circle"></i> 完整功能版本 - 所有功能均已實現
  </div>

  <!-- 導航列 -->
  <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
      <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">財務管理系統</a>
      <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
          <span class="navbar-toggler-icon"></span>
      </button>
      <div class="navbar-nav">
          <div class="nav-item text-nowrap">
              <a class="nav-link px-3" href="#" onclick="logout()">登出</a>
          </div>
      </div>
  </nav>

  <div class="container-fluid">
      <div class="row">
          <!-- 側邊欄 -->
          <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
              <div class="position-sticky pt-3">
                  <ul class="nav flex-column">
                      <li class="nav-item">
                          <a class="nav-link active" href="#" onclick="loadPage('dashboard')">
                              <i class="fas fa-tachometer-alt"></i> 儀表板
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('members')">
                              <i class="fas fa-users"></i> 會員管理
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('income')">
                              <i class="fas fa-arrow-up text-success"></i> 收入管理
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('expenses')">
                              <i class="fas fa-arrow-down text-danger"></i> 支出管理
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('accounts')">
                              <i class="fas fa-list"></i> 會計科目
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('bank-accounts')">
                              <i class="fas fa-university"></i> 銀行帳戶
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('receipts')">
                              <i class="fas fa-receipt"></i> 電子收據
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('reports')">
                              <i class="fas fa-chart-bar"></i> 財務報表
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('settings')">
                              <i class="fas fa-cog"></i> 系統設定
                          </a>
                      </li>
                  </ul>
              </div>
          </nav>

          <!-- 主要內容區域 -->
          <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
              <div id="content-area">
                  <!-- 內容將由 JavaScript 動態載入 -->
              </div>
          </main>
      </div>
  </div>

  <!-- 載入中覆蓋層 -->
  <div class="loading-overlay" id="loadingOverlay">
      <div class="text-center">
          <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">載入中...</span>
          </div>
          <p class="mt-2">載入中...</p>
      </div>
  </div>

  <!-- Toast 容器 -->
  <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer">
  </div>

  <!-- 通用 Modal -->
  <div class="modal fade" id="universalModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="universalModalTitle">標題</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="universalModalBody">
                  內容
              </div>
              <div class="modal-footer" id="universalModalFooter">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" id="universalModalConfirm">確定</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
      // 全域變數
      let currentPage = 'dashboard';
      let currentChart = null;
      let nextId = 1000; // 用於生成新記錄的 ID
      
      // 完整示範資料
      const systemData = {
          dashboard: {
              stats: {
                  totalMembers: 156,
                  totalIncome: 850000,
                  totalExpenses: 680000,
                  netIncome: 170000
              },
              recentTransactions: [
                  { date: '2024-12-19', type: '收入', account: '會費收入', amount: 15000, description: '12月會費' },
                  { date: '2024-12-18', type: '支出', account: '活動費用', amount: -8000, description: '健康講座費用' },
                  { date: '2024-12-17', type: '收入', account: '捐款收入', amount: 25000, description: '愛心捐款' },
                  { date: '2024-12-16', type: '支出', account: '辦公費用', amount: -3000, description: '文具用品' },
                  { date: '2024-12-15', type: '收入', account: '政府補助', amount: 50000, description: '年度補助款' }
              ],
              monthlyData: [
                  { month: '1月', income: 45000, expense: 38000 },
                  { month: '2月', income: 52000, expense: 41000 },
                  { month: '3月', income: 48000, expense: 39000 },
                  { month: '4月', income: 55000, expense: 43000 },
                  { month: '5月', income: 51000, expense: 40000 },
                  { month: '6月', income: 58000, expense: 45000 }
              ]
          },
          members: [
              { id: 1, name: '王小明', phone: '0912345678', email: 'wang@email.com', type: '一般會員', status: '正常', joinDate: '2023-01-15', address: '台北市中正區重慶南路100號', emergencyContact: '王太太 0987654321', notes: '定期參與活動' },
              { id: 2, name: '李美華', phone: '0923456789', email: 'li@email.com', type: '榮譽會員', status: '正常', joinDate: '2022-03-20', address: '台北市大安區信義路200號', emergencyContact: '李先生 0976543210', notes: '長期志工' },
              { id: 3, name: '張志強', phone: '0934567890', email: 'zhang@email.com', type: '一般會員', status: '暫停', joinDate: '2023-06-10', address: '新北市板橋區中山路300號', emergencyContact: '張女士 0965432109', notes: '暫停會籍中' },
              { id: 4, name: '陳淑芬', phone: '0945678901', email: 'chen@email.com', type: '贊助會員', status: '正常', joinDate: '2023-08-05', address: '台中市西區台灣大道400號', emergencyContact: '陳先生 0954321098', notes: '大額贊助者' },
              { id: 5, name: '林建國', phone: '0956789012', email: 'lin@email.com', type: '一般會員', status: '正常', joinDate: '2023-11-12', address: '高雄市前金區中正四路500號', emergencyContact: '林太太 0943210987', notes: '新加入會員' }
          ],
          income: [
              { id: 1, date: '2024-12-19', account: '會費收入', amount: 15000, payer: '王小明', method: '轉帳', description: '12月會費', category: '會費', invoiceNumber: 'INV-2024-001' },
              { id: 2, date: '2024-12-17', account: '捐款收入', amount: 25000, payer: '李美華', method: '現金', description: '愛心捐款', category: '捐款', invoiceNumber: 'INV-2024-002' },
              { id: 3, date: '2024-12-15', account: '政府補助', amount: 50000, payer: '衛生局', method: '轉帳', description: '年度補助款', category: '補助', invoiceNumber: 'INV-2024-003' },
              { id: 4, date: '2024-12-10', account: '活動收入', amount: 8000, payer: '參加者', method: '現金', description: '健康講座報名費', category: '活動', invoiceNumber: 'INV-2024-004' },
              { id: 5, date: '2024-12-05', account: '會費收入', amount: 12000, payer: '張志強', method: '轉帳', description: '補繳會費', category: '會費', invoiceNumber: 'INV-2024-005' }
          ],
          expenses: [
              { id: 1, date: '2024-12-18', account: '活動費用', amount: 8000, payee: '講師費', method: '現金', status: '已核准', description: '健康講座費用', category: '活動', approver: '理事長', receiptNumber: 'REC-2024-001' },
              { id: 2, date: '2024-12-16', account: '辦公費用', amount: 3000, payee: '文具店', method: '現金', status: '已核准', description: '文具用品', category: '辦公', approver: '秘書長', receiptNumber: 'REC-2024-002' },
              { id: 3, date: '2024-12-14', account: '交通費', amount: 2500, payee: '計程車', method: '現金', status: '待審核', description: '外訪交通費', category: '交通', approver: '', receiptNumber: 'REC-2024-003' },
              { id: 4, date: '2024-12-12', account: '水電費', amount: 4500, payee: '台電公司', method: '轉帳', status: '已核准', description: '12月電費', category: '水電', approver: '會計', receiptNumber: 'REC-2024-004' },
              { id: 5, date: '2024-12-08', account: '租金', amount: 15000, payee: '房東', method: '轉帳', status: '已核准', description: '12月租金', category: '租金', approver: '理事長', receiptNumber: 'REC-2024-005' }
          ],
          accounts: [
              { id: 1, code: '4001', name: '會費收入', type: '收入', parent: '', status: '啟用', description: '會員繳交之會費' },
              { id: 2, code: '4002', name: '捐款收入', type: '收入', parent: '', status: '啟用', description: '各界愛心捐款' },
              { id: 3, code: '4003', name: '政府補助', type: '收入', parent: '', status: '啟用', description: '政府機關補助款' },
              { id: 4, code: '4004', name: '活動收入', type: '收入', parent: '', status: '啟用', description: '活動報名費等收入' },
              { id: 5, code: '5001', name: '活動費用', type: '支出', parent: '', status: '啟用', description: '舉辦活動相關費用' },
              { id: 6, code: '5002', name: '辦公費用', type: '支出', parent: '', status: '啟用', description: '辦公室營運費用' },
              { id: 7, code: '5003', name: '交通費', type: '支出', parent: '', status: '啟用', description: '交通運輸費用' },
              { id: 8, code: '5004', name: '水電費', type: '支出', parent: '', status: '啟用', description: '水電瓦斯費用' },
              { id: 9, code: '5005', name: '租金', type: '支出', parent: '', status: '啟用', description: '辦公室租金' }
          ],
          bankAccounts: [
              { id: 1, name: '主要帳戶', bank: '台灣銀行', account: '123-456-789', balance: 450000, active: true, accountType: '支票存款', openDate: '2022-01-01' },
              { id: 2, name: '活動專戶', bank: '第一銀行', account: '987-654-321', balance: 85000, active: true, accountType: '活期存款', openDate: '2022-06-15' },
              { id: 3, name: '備用帳戶', bank: '華南銀行', account: '555-666-777', balance: 25000, active: false, accountType: '定期存款', openDate: '2023-01-01' }
          ],
          receipts: [
              { id: 1, number: 'R2024120001', date: '2024-12-19', payer: '王小明', amount: 15000, status: '已開立', emailStatus: '已發送', purpose: '會費繳交', paymentMethod: '轉帳' },
              { id: 2, number: 'R2024120002', date: '2024-12-17', payer: '李美華', amount: 25000, status: '已開立', emailStatus: '已發送', purpose: '愛心捐款', paymentMethod: '現金' },
              { id: 3, number: 'R2024120003', date: '2024-12-15', payer: '衛生局', amount: 50000, status: '已開立', emailStatus: '未發送', purpose: '政府補助', paymentMethod: '轉帳' },
              { id: 4, number: 'R2024120004', date: '2024-12-10', payer: '參加者', amount: 8000, status: '已開立', emailStatus: '已發送', purpose: '活動報名', paymentMethod: '現金' },
              { id: 5, number: 'R2024120005', date: '2024-12-05', payer: '張志強', amount: 12000, status: '已開立', emailStatus: '已發送', purpose: '會費補繳', paymentMethod: '轉帳' }
          ],
          settings: {
              organization: {
                  name: '台灣帕金森病友權益促進會',
                  taxId: '12345678',
                  address: '台北市中正區重慶南路一段122號',
                  phone: '02-2388-1234',
                  email: 'info@parkinson-taiwan.org',
                  website: 'https://www.parkinson-taiwan.org',
                  chairman: '王理事長',
                  secretary: '李秘書長'
              },
              system: {
                  autoBackup: true,
                  backupFrequency: 'daily',
                  emailNotification: true,
                  receiptPrefix: 'R',
                  invoicePrefix: 'INV',
                  fiscalYearStart: '01-01'
              }
          }
      };

      // 初始化應用程式
      $(document).ready(function() {
          console.log('系統初始化中...');
          showToast('歡迎使用財務管理系統完整版', 'success');
          loadPage('dashboard');
          
          // 初始化事件監聽器
          initializeEventListeners();
      });

      // 初始化事件監聽器
      function initializeEventListeners() {
          // 響應式處理
          $(window).on('resize', function() {
              if (window.innerWidth >= 768) {
                  $('#sidebarMenu').removeClass('show');
              }
          });

          // 側邊欄切換
          $('.navbar-toggler').on('click', function() {
              $('#sidebarMenu').toggleClass('show');
          });

          // 點擊外部關閉側邊欄
          $(document).on('click', function(e) {
              if (window.innerWidth < 768) {
                  if (!$(e.target).closest('#sidebarMenu, .navbar-toggler').length) {
                      $('#sidebarMenu').removeClass('show');
                  }
              }
          });

          // 鍵盤快捷鍵
          $(document).on('keydown', function(e) {
              if (e.ctrlKey && e.key >= '1' && e.key <= '9') {
                  e.preventDefault();
                  const pages = ['dashboard', 'members', 'income', 'expenses', 'accounts', 'bank-accounts', 'receipts', 'reports', 'settings'];
                  const pageIndex = parseInt(e.key) - 1;
                  if (pages[pageIndex]) {
                      loadPage(pages[pageIndex]);
                  }
                  return false;
              }
              
              if (e.key === 'Escape') {
                  $('.toast').toast('hide');
                  $('#universalModal').modal('hide');
              }
          });

          // 表格排序
          $(document).on('click', 'th[data-sort]', function() {
              sortTable($(this));
          });

          // 表單驗證
          $(document).on('submit', 'form', function(e) {
              e.preventDefault();
              return validateAndSubmitForm($(this));
          });

          // 搜尋功能
          $(document).on('input', '.search-input', function() {
              const searchTerm = $(this).val();
              const targetTable = $(this).data('target');
              searchTable(searchTerm, targetTable);
          });
      }

      // 載入頁面
      function loadPage(page) {
          showLoading();
          
          // 更新導航狀態
          $('.nav-link').removeClass('active');
          $(`.nav-link[onclick="loadPage('${page}')"]`).addClass('active');
          
          currentPage = page;
          
          setTimeout(() => {
              switch(page) {
                  case 'dashboard':
                      loadDashboard();
                      break;
                  case 'members':
                      loadMembers();
                      break;
                  case 'income':
                      loadIncome();
                      break;
                  case 'expenses':
                      loadExpenses();
                      break;
                  case 'accounts':
                      loadAccounts();
                      break;
                  case 'bank-accounts':
                      loadBankAccounts();
                      break;
                  case 'receipts':
                      loadReceipts();
                      break;
                  case 'reports':
                      loadReports();
                      break;
                  case 'settings':
                      loadSettings();
                      break;
                  default:
                      loadDashboard();
              }
              hideLoading();
          }, 300);
      }

      // 載入儀表板
      function loadDashboard() {
          const data = systemData.dashboard;
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">儀表板</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshDashboard()">
                              <i class="fas fa-sync-alt"></i> 重新整理
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-info" onclick="exportDashboard()">
                              <i class="fas fa-download"></i> 匯出摘要
                          </button>
                      </div>
                  </div>
              </div>

              <!-- 統計卡片 -->
              <div class="row mb-4">
                  <div class="col-xl-3 col-md-6 mb-4">
                      <div class="card border-left-primary shadow h-100 py-2 stats-card">
                          <div class="card-body">
                              <div class="row no-gutters align-items-center">
                                  <div class="col mr-2">
                                      <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                          會員總數</div>
                                      <div class="h5 mb-0 font-weight-bold text-gray-800">${data.stats.totalMembers}</div>
                                  </div>
                                  <div class="col-auto">
                                      <i class="fas fa-users fa-2x text-gray-300"></i>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="col-xl-3 col-md-6 mb-4">
                      <div class="card border-left-success shadow h-100 py-2 stats-card">
                          <div class="card-body">
                              <div class="row no-gutters align-items-center">
                                  <div class="col mr-2">
                                      <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                          總收入</div>
                                      <div class="h5 mb-0 font-weight-bold text-gray-800">$${formatCurrency(data.stats.totalIncome)}</div>
                                  </div>
                                  <div class="col-auto">
                                      <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="col-xl-3 col-md-6 mb-4">
                      <div class="card border-left-info shadow h-100 py-2 stats-card">
                          <div class="card-body">
                              <div class="row no-gutters align-items-center">
                                  <div class="col mr-2">
                                      <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                          總支出</div>
                                      <div class="h5 mb-0 font-weight-bold text-gray-800">$${formatCurrency(data.stats.totalExpenses)}</div>
                                  </div>
                                  <div class="col-auto">
                                      <i class="fas fa-credit-card fa-2x text-gray-300"></i>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="col-xl-3 col-md-6 mb-4">
                      <div class="card border-left-warning shadow h-100 py-2 stats-card">
                          <div class="card-body">
                              <div class="row no-gutters align-items-center">
                                  <div class="col mr-2">
                                      <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                          淨收益</div>
                                      <div class="h5 mb-0 font-weight-bold text-gray-800">$${formatCurrency(data.stats.netIncome)}</div>
                                  </div>
                                  <div class="col-auto">
                                      <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 圖表和最近交易 -->
              <div class="row">
                  <div class="col-lg-8">
                      <div class="card shadow mb-4">
                          <div class="card-header py-3 d-flex justify-content-between align-items-center">
                              <h6 class="m-0 font-weight-bold text-primary">收入支出趨勢</h6>
                              <div class="btn-group btn-group-sm">
                                  <button class="btn btn-outline-secondary" onclick="changeChartType('line')">線圖</button>
                                  <button class="btn btn-outline-secondary" onclick="changeChartType('bar')">柱狀圖</button>
                              </div>
                          </div>
                          <div class="card-body">
                              <canvas id="incomeExpenseChart" width="400" height="200"></canvas>
                          </div>
                      </div>
                  </div>

                  <div class="col-lg-4">
                      <div class="card shadow mb-4">
                          <div class="card-header py-3">
                              <h6 class="m-0 font-weight-bold text-primary">最近交易</h6>
                          </div>
                          <div class="card-body">
                              <div class="list-group list-group-flush">
                                  ${data.recentTransactions.map(transaction => `
                                      <div class="list-group-item d-flex justify-content-between align-items-center">
                                          <div>
                                              <h6 class="mb-1">${transaction.account}</h6>
                                              <p class="mb-1 text-muted small">${transaction.description}</p>
                                              <small class="text-muted">${formatDate(transaction.date)}</small>
                                          </div>
                                          <span class="badge ${transaction.amount > 0 ? 'bg-success' : 'bg-danger'} rounded-pill">
                                              ${transaction.amount > 0 ? '+' : ''}${formatCurrency(Math.abs(transaction.amount))}
                                          </span>
                                      </div>
                                  `).join('')}
                              </div>
                              <div class="text-center mt-3">
                                  <button class="btn btn-sm btn-outline-primary" onclick="loadPage('income')">
                                      查看所有交易 <i class="fas fa-arrow-right"></i>
                                  </button>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
          
          // 初始化圖表
          setTimeout(() => {
              initializeChart('line');
          }, 100);
      }

      // 初始化圖表
      function initializeChart(type = 'line') {
          const ctx = document.getElementById('incomeExpenseChart');
          if (!ctx) return;

          // 銷毀現有圖表
          if (currentChart) {
              currentChart.destroy();
          }

          const data = systemData.dashboard.monthlyData;
          
          currentChart = new Chart(ctx, {
              type: type,
              data: {
                  labels: data.map(item => item.month),
                  datasets: [{
                      label: '收入',
                      data: data.map(item => item.income),
                      borderColor: 'rgb(75, 192, 192)',
                      backgroundColor: type === 'bar' ? 'rgba(75, 192, 192, 0.8)' : 'rgba(75, 192, 192, 0.2)',
                      tension: 0.1
                  }, {
                      label: '支出',
                      data: data.map(item => item.expense),
                      borderColor: 'rgb(255, 99, 132)',
                      backgroundColor: type === 'bar' ? 'rgba(255, 99, 132, 0.8)' : 'rgba(255, 99, 132, 0.2)',
                      tension: 0.1
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      title: {
                          display: true,
                          text: '月度收入支出趨勢'
                      },
                      legend: {
                          display: true,
                          position: 'top'
                      }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          ticks: {
                              callback: function(value) {
                                  return '$' + value.toLocaleString();
                              }
                          }
                      }
                  },
                  interaction: {
                      intersect: false,
                      mode: 'index'
                  }
              }
          });
      }

      // 改變圖表類型
      function changeChartType(type) {
          initializeChart(type);
          $('.btn-group .btn').removeClass('active');
          $(`.btn-group .btn[onclick="changeChartType('${type}')"]`).addClass('active');
      }

      // 載入會員管理
      function loadMembers() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">會員管理</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-primary" onclick="showAddMemberModal()">
                              <i class="fas fa-plus"></i> 新增會員
                          </button>
                          <button type="button" class="btn btn-outline-secondary" onclick="exportMembers()">
                              <i class="fas fa-download"></i> 匯出
                          </button>
                          <button type="button" class="btn btn-outline-info" onclick="importMembers()">
                              <i class="fas fa-upload"></i> 匯入
                          </button>
                      </div>
                  </div>
              </div>

              <!-- 搜尋和篩選 -->
              <div class="row mb-3">
                  <div class="col-md-4">
                      <div class="search-box">
                          <i class="fas fa-search search-icon"></i>
                          <input type="text" class="form-control search-input" placeholder="搜尋會員..." data-target="#membersTable">
                      </div>
                  </div>
                  <div class="col-md-3">
                      <select class="form-select" onchange="filterMembers('type', this.value)">
                          <option value="">所有會員類型</option>
                          <option value="一般會員">一般會員</option>
                          <option value="榮譽會員">榮譽會員</option>
                          <option value="贊助會員">贊助會員</option>
                      </select>
                  </div>
                  <div class="col-md-3">
                      <select class="form-select" onchange="filterMembers('status', this.value)">
                          <option value="">所有狀態</option>
                          <option value="正常">正常</option>
                          <option value="暫停">暫停</option>
                      </select>
                  </div>
                  <div class="col-md-2">
                      <button class="btn btn-outline-secondary w-100" onclick="clearMemberFilters()">
                          <i class="fas fa-times"></i> 清除
                      </button>
                  </div>
              </div>

              <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">會員列表 (${systemData.members.length} 人)</h5>
                      <div class="btn-group btn-group-sm">
                          <button class="btn btn-outline-secondary" onclick="selectAllMembers()">全選</button>
                          <button class="btn btn-outline-danger" onclick="batchDeleteMembers()">批次刪除</button>
                      </div>
                  </div>
                  <div class="card-body">
                      <div class="table-responsive">
                          <table class="table table-hover" id="membersTable">
                              <thead>
                                  <tr>
                                      <th><input type="checkbox" id="selectAllMembersCheckbox" onchange="toggleAllMembers()"></th>
                                      <th data-sort="name">姓名</th>
                                      <th data-sort="phone">電話</th>
                                      <th>電子郵件</th>
                                      <th data-sort="type">會員類型</th>
                                      <th data-sort="status">狀態</th>
                                      <th data-sort="joinDate">加入日期</th>
                                      <th class="no-print">操作</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${systemData.members.map(member => `
                                      <tr data-member-id="${member.id}">
                                          <td><input type="checkbox" class="member-checkbox" value="${member.id}"></td>
                                          <td>${member.name}</td>
                                          <td>${member.phone}</td>
                                          <td>${member.email}</td>
                                          <td><span class="badge bg-primary">${member.type}</span></td>
                                          <td><span class="badge ${member.status === '正常' ? 'bg-success' : 'bg-warning'}">${member.status}</span></td>
                                          <td>${formatDate(member.joinDate)}</td>
                                          <td class="no-print">
                                              <div class="btn-group btn-group-sm">
                                                  <button class="btn btn-outline-info" onclick="viewMember(${member.id})" title="檢視">
                                                      <i class="fas fa-eye"></i>
                                                  </button>
                                                  <button class="btn btn-outline-primary" onclick="editMember(${member.id})" title="編輯">
                                                      <i class="fas fa-edit"></i>
                                                  </button>
                                                  <button class="btn btn-outline-danger" onclick="deleteMember(${member.id})" title="刪除">
                                                      <i class="fas fa-trash"></i>
                                                  </button>
                                              </div>
                                          </td>
                                      </tr>
                                  `).join('')}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
      }

      // 顯示新增會員 Modal
      function showAddMemberModal() {
          const modalContent = `
              <form id="addMemberForm">
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="memberName" name="name" required>
                              <label for="memberName">姓名 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="tel" class="form-control phone-input" id="memberPhone" name="phone" required>
                              <label for="memberPhone">電話 *</label>
                          </div>
                      </div>
                  </div>
                  
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="email" class="form-control" id="memberEmail" name="email" required>
                              <label for="memberEmail">電子郵件 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="memberType" name="type" required>
                                  <option value="">選擇會員類型</option>
                                  <option value="一般會員">一般會員</option>
                                  <option value="榮譽會員">榮譽會員</option>
                                  <option value="贊助會員">贊助會員</option>
                              </select>
                              <label for="memberType">會員類型 *</label>
                          </div>
                      </div>
                  </div>

                  <div class="form-floating mb-3">
                      <textarea class="form-control" id="memberAddress" name="address" style="height: 80px"></textarea>
                      <label for="memberAddress">地址</label>
                  </div>

                  <div class="form-floating mb-3">
                      <input type="text" class="form-control" id="memberEmergencyContact" name="emergencyContact">
                      <label for="memberEmergencyContact">緊急聯絡人</label>
                  </div>

                  <div class="form-floating mb-3">
                      <textarea class="form-control" id="memberNotes" name="notes" style="height: 60px"></textarea>
                      <label for="memberNotes">備註</label>
                  </div>
              </form>
          `;

          showModal('新增會員', modalContent, function() {
              const form = document.getElementById('addMemberForm');
              if (validateForm(form)) {
                  const formData = new FormData(form);
                  const newMember = {
                      id: ++nextId,
                      name: formData.get('name'),
                      phone: formData.get('phone'),
                      email: formData.get('email'),
                      type: formData.get('type'),
                      status: '正常',
                      joinDate: new Date().toISOString().split('T')[0],
                      address: formData.get('address') || '',
                      emergencyContact: formData.get('emergencyContact') || '',
                      notes: formData.get('notes') || ''
                  };
                  
                  systemData.members.push(newMember);
                  systemData.dashboard.stats.totalMembers = systemData.members.length;
                  
                  showToast('會員新增成功', 'success');
                  $('#universalModal').modal('hide');
                  loadMembers();
              }
          });
      }

      // 檢視會員詳情
      function viewMember(id) {
          const member = systemData.members.find(m => m.id === id);
          if (!member) return;

          const modalContent = `
              <div class="row">
                  <div class="col-md-6">
                      <strong>姓名：</strong> ${member.name}
                  </div>
                  <div class="col-md-6">
                      <strong>電話：</strong> ${member.phone}
                  </div>
              </div>
              <div class="row mt-2">
                  <div class="col-md-6">
                      <strong>電子郵件：</strong> ${member.email}
                  </div>
                  <div class="col-md-6">
                      <strong>會員類型：</strong> <span class="badge bg-primary">${member.type}</span>
                  </div>
              </div>
              <div class="row mt-2">
                  <div class="col-md-6">
                      <strong>狀態：</strong> <span class="badge ${member.status === '正常' ? 'bg-success' : 'bg-warning'}">${member.status}</span>
                  </div>
                  <div class="col-md-6">
                      <strong>加入日期：</strong> ${formatDate(member.joinDate)}
                  </div>
              </div>
              <div class="row mt-2">
                  <div class="col-12">
                      <strong>地址：</strong> ${member.address || '未填寫'}
                  </div>
              </div>
              <div class="row mt-2">
                  <div class="col-12">
                      <strong>緊急聯絡人：</strong> ${member.emergencyContact || '未填寫'}
                  </div>
              </div>
              <div class="row mt-2">
                  <div class="col-12">
                      <strong>備註：</strong> ${member.notes || '無'}
                  </div>
              </div>
          `;

          showModal('會員詳情 - ' + member.name, modalContent, null, false);
      }

      // 編輯會員
      function editMember(id) {
          const member = systemData.members.find(m => m.id === id);
          if (!member) return;

          const modalContent = `
              <form id="editMemberForm">
                  <input type="hidden" name="id" value="${member.id}">
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="editMemberName" name="name" value="${member.name}" required>
                              <label for="editMemberName">姓名 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="tel" class="form-control phone-input" id="editMemberPhone" name="phone" value="${member.phone}" required>
                              <label for="editMemberPhone">電話 *</label>
                          </div>
                      </div>
                  </div>
                  
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="email" class="form-control" id="editMemberEmail" name="email" value="${member.email}" required>
                              <label for="editMemberEmail">電子郵件 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="editMemberType" name="type" required>
                                  <option value="一般會員" ${member.type === '一般會員' ? 'selected' : ''}>一般會員</option>
                                  <option value="榮譽會員" ${member.type === '榮譽會員' ? 'selected' : ''}>榮譽會員</option>
                                  <option value="贊助會員" ${member.type === '贊助會員' ? 'selected' : ''}>贊助會員</option>
                              </select>
                              <label for="editMemberType">會員類型 *</label>
                          </div>
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="editMemberStatus" name="status" required>
                                  <option value="正常" ${member.status === '正常' ? 'selected' : ''}>正常</option>
                                  <option value="暫停" ${member.status === '暫停' ? 'selected' : ''}>暫停</option>
                              </select>
                              <label for="editMemberStatus">狀態 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="date" class="form-control" id="editMemberJoinDate" name="joinDate" value="${member.joinDate}" required>
                              <label for="editMemberJoinDate">加入日期 *</label>
                          </div>
                      </div>
                  </div>

                  <div class="form-floating mb-3">
                      <textarea class="form-control" id="editMemberAddress" name="address" style="height: 80px">${member.address || ''}</textarea>
                      <label for="editMemberAddress">地址</label>
                  </div>

                  <div class="form-floating mb-3">
                      <input type="text" class="form-control" id="editMemberEmergencyContact" name="emergencyContact" value="${member.emergencyContact || ''}">
                      <label for="editMemberEmergencyContact">緊急聯絡人</label>
                  </div>

                  <div class="form-floating mb-3">
                      <textarea class="form-control" id="editMemberNotes" name="notes" style="height: 60px">${member.notes || ''}</textarea>
                      <label for="editMemberNotes">備註</label>
                  </div>
              </form>
          `;

          showModal('編輯會員 - ' + member.name, modalContent, function() {
              const form = document.getElementById('editMemberForm');
              if (validateForm(form)) {
                  const formData = new FormData(form);
                  const memberIndex = systemData.members.findIndex(m => m.id === id);
                  
                  systemData.members[memberIndex] = {
                      ...systemData.members[memberIndex],
                      name: formData.get('name'),
                      phone: formData.get('phone'),
                      email: formData.get('email'),
                      type: formData.get('type'),
                      status: formData.get('status'),
                      joinDate: formData.get('joinDate'),
                      address: formData.get('address') || '',
                      emergencyContact: formData.get('emergencyContact') || '',
                      notes: formData.get('notes') || ''
                  };
                  
                  showToast('會員資料更新成功', 'success');
                  $('#universalModal').modal('hide');
                  loadMembers();
              }
          });
      }

      // 刪除會員
      function deleteMember(id) {
          const member = systemData.members.find(m => m.id === id);
          if (!member) return;

          if (confirm(`確定要刪除會員「${member.name}」嗎？此操作無法復原。`)) {
              const memberIndex = systemData.members.findIndex(m => m.id === id);
              systemData.members.splice(memberIndex, 1);
              systemData.dashboard.stats.totalMembers = systemData.members.length;
              
              showToast('會員刪除成功', 'success');
              loadMembers();
          }
      }

      // 載入收入管理
      function loadIncome() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">收入管理</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-primary" onclick="showAddIncomeModal()">
                              <i class="fas fa-plus"></i> 新增收入
                          </button>
                          <button type="button" class="btn btn-outline-secondary" onclick="exportIncome()">
                              <i class="fas fa-download"></i> 匯出
                          </button>
                      </div>
                  </div>
              </div>

              <!-- 統計摘要 -->
              <div class="row mb-4">
                  <div class="col-md-3">
                      <div class="card border-left-success">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">本月收入</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">$${formatCurrency(calculateMonthlyIncome())}</div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card border-left-info">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-info text-uppercase mb-1">總收入</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">$${formatCurrency(systemData.dashboard.stats.totalIncome)}</div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card border-left-primary">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">收入筆數</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">${systemData.income.length}</div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card border-left-warning">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">平均收入</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">$${formatCurrency(systemData.dashboard.stats.totalIncome / systemData.income.length)}</div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 搜尋和篩選 -->
              <div class="row mb-3">
                  <div class="col-md-4">
                      <div class="search-box">
                          <i class="fas fa-search search-icon"></i>
                          <input type="text" class="form-control search-input" placeholder="搜尋收入記錄..." data-target="#incomeTable">
                      </div>
                  </div>
                  <div class="col-md-2">
                      <input type="date" class="form-control" id="startDate" onchange="filterIncomeByDate()">
                  </div>
                  <div class="col-md-2">
                      <input type="date" class="form-control" id="endDate" onchange="filterIncomeByDate()">
                  </div>
                  <div class="col-md-2">
                      <select class="form-select" onchange="filterIncome('category', this.value)">
                          <option value="">所有類別</option>
                          <option value="會費">會費</option>
                          <option value="捐款">捐款</option>
                          <option value="補助">補助</option>
                          <option value="活動">活動</option>
                      </select>
                  </div>
                  <div class="col-md-2">
                      <button class="btn btn-outline-secondary w-100" onclick="clearIncomeFilters()">
                          <i class="fas fa-times"></i> 清除
                      </button>
                  </div>
              </div>

              <div class="card">
                  <div class="card-header">
                      <h5 class="mb-0">收入記錄</h5>
                  </div>
                  <div class="card-body">
                      <div class="table-responsive">
                          <table class="table table-hover" id="incomeTable">
                              <thead>
                                  <tr>
                                      <th data-sort="date">日期</th>
                                      <th data-sort="account">會計科目</th>
                                      <th data-sort="amount">金額</th>
                                      <th>付款人</th>
                                      <th>付款方式</th>
                                      <th>類別</th>
                                      <th>發票號碼</th>
                                      <th>說明</th>
                                      <th class="no-print">操作</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${systemData.income.map(item => `
                                      <tr data-income-id="${item.id}">
                                          <td>${formatDate(item.date)}</td>
                                          <td>${item.account}</td>
                                          <td class="text-success fw-bold">$${formatCurrency(item.amount)}</td>
                                          <td>${item.payer}</td>
                                          <td><span class="badge bg-info">${item.method}</span></td>
                                          <td><span class="badge bg-secondary">${item.category}</span></td>
                                          <td><code>${item.invoiceNumber}</code></td>
                                          <td>${item.description}</td>
                                          <td class="no-print">
                                              <div class="btn-group btn-group-sm">
                                                  <button class="btn btn-outline-info" onclick="viewIncome(${item.id})" title="檢視">
                                                      <i class="fas fa-eye"></i>
                                                  </button>
                                                  <button class="btn btn-outline-primary" onclick="editIncome(${item.id})" title="編輯">
                                                      <i class="fas fa-edit"></i>
                                                  </button>
                                                  <button class="btn btn-outline-success" onclick="generateReceipt(${item.id})" title="產生收據">
                                                      <i class="fas fa-receipt"></i>
                                                  </button>
                                                  <button class="btn btn-outline-danger" onclick="deleteIncome(${item.id})" title="刪除">
                                                      <i class="fas fa-trash"></i>
                                                  </button>
                                              </div>
                                          </td>
                                      </tr>
                                  `).join('')}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
      }

      // 顯示新增收入 Modal
      function showAddIncomeModal() {
          const modalContent = `
              <form id="addIncomeForm">
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="date" class="form-control" id="incomeDate" name="date" value="${new Date().toISOString().split('T')[0]}" required>
                              <label for="incomeDate">日期 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="incomeAccount" name="account" required>
                                  <option value="">選擇會計科目</option>
                                  ${systemData.accounts.filter(acc => acc.type === '收入' && acc.status === '啟用').map(acc => 
                                      `<option value="${acc.name}">${acc.name}</option>`
                                  ).join('')}
                              </select>
                              <label for="incomeAccount">會計科目 *</label>
                          </div>
                      </div>
                  </div>
                  
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="number" class="form-control currency-input" id="incomeAmount" name="amount" min="0" step="1" required>
                              <label for="incomeAmount">金額 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="incomePayer" name="payer" required>
                              <label for="incomePayer">付款人 *</label>
                          </div>
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="incomeMethod" name="method" required>
                                  <option value="">選擇付款方式</option>
                                  <option value="現金">現金</option>
                                  <option value="轉帳">轉帳</option>
                                  <option value="支票">支票</option>
                                  <option value="信用卡">信用卡</option>
                              </select>
                              <label for="incomeMethod">付款方式 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="incomeCategory" name="category" required>
                                  <option value="">選擇類別</option>
                                  <option value="會費">會費</option>
                                  <option value="捐款">捐款</option>
                                  <option value="補助">補助</option>
                                  <option value="活動">活動</option>
                              </select>
                              <label for="incomeCategory">類別 *</label>
                          </div>
                      </div>
                  </div>

                  <div class="form-floating mb-3">
                      <input type="text" class="form-control" id="incomeInvoiceNumber" name="invoiceNumber" value="INV-${new Date().getFullYear()}-${String(systemData.income.length + 1).padStart(3, '0')}">
                      <label for="incomeInvoiceNumber">發票號碼</label>
                  </div>

                  <div class="form-floating mb-3">
                      <textarea class="form-control" id="incomeDescription" name="description" style="height: 80px" required></textarea>
                      <label for="incomeDescription">說明 *</label>
                  </div>
              </form>
          `;

          showModal('新增收入', modalContent, function() {
              const form = document.getElementById('addIncomeForm');
              if (validateForm(form)) {
                  const formData = new FormData(form);
                  const newIncome = {
                      id: ++nextId,
                      date: formData.get('date'),
                      account: formData.get('account'),
                      amount: parseInt(formData.get('amount')),
                      payer: formData.get('payer'),
                      method: formData.get('method'),
                      category: formData.get('category'),
                      invoiceNumber: formData.get('invoiceNumber'),
                      description: formData.get('description')
                  };
                  
                  systemData.income.push(newIncome);
                  systemData.dashboard.stats.totalIncome += newIncome.amount;
                  systemData.dashboard.stats.netIncome = systemData.dashboard.stats.totalIncome - systemData.dashboard.stats.totalExpenses;
                  
                  showToast('收入記錄新增成功', 'success');
                  $('#universalModal').modal('hide');
                  loadIncome();
              }
          });
      }

      // 檢視收入詳情
      function viewIncome(id) {
          const income = systemData.income.find(i => i.id === id);
          if (!income) return;

          const modalContent = `
              <div class="row">
                  <div class="col-md-6">
                      <strong>日期：</strong> ${formatDate(income.date)}
                  </div>
                  <div class="col-md-6">
                      <strong>會計科目：</strong> ${income.account}
                  </div>
              </div>
              <div class="row mt-2">
                  <div class="col-md-6">
                      <strong>金額：</strong> <span class="text-success fw-bold">$${formatCurrency(income.amount)}</span>
                  </div>
                  <div class="col-md-6">
                      <strong>付款人：</strong> ${income.payer}
                  </div>
              </div>
              <div class="row mt-2">
                  <div class="col-md-6">
                      <strong>付款方式：</strong> <span class="badge bg-info">${income.method}</span>
                  </div>
                  <div class="col-md-6">
                      <strong>類別：</strong> <span class="badge bg-secondary">${income.category}</span>
                  </div>
              </div>
              <div class="row mt-2">
                  <div class="col-md-6">
                      <strong>發票號碼：</strong> <code>${income.invoiceNumber}</code>
                  </div>
              </div>
              <div class="row mt-2">
                  <div class="col-12">
                      <strong>說明：</strong> ${income.description}
                  </div>
              </div>
          `;

          showModal('收入詳情', modalContent, null, false);
      }

      // 編輯收入
      function editIncome(id) {
          const income = systemData.income.find(i => i.id === id);
          if (!income) return;

          const modalContent = `
              <form id="editIncomeForm">
                  <input type="hidden" name="id" value="${income.id}">
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="date" class="form-control" id="editIncomeDate" name="date" value="${income.date}" required>
                              <label for="editIncomeDate">日期 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="editIncomeAccount" name="account" required>
                                  ${systemData.accounts.filter(acc => acc.type === '收入' && acc.status === '啟用').map(acc => 
                                      `<option value="${acc.name}" ${acc.name === income.account ? 'selected' : ''}>${acc.name}</option>`
                                  ).join('')}
                              </select>
                              <label for="editIncomeAccount">會計科目 *</label>
                          </div>
                      </div>
                  </div>
                  
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="number" class="form-control currency-input" id="editIncomeAmount" name="amount" value="${income.amount}" min="0" step="1" required>
                              <label for="editIncomeAmount">金額 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="editIncomePayer" name="payer" value="${income.payer}" required>
                              <label for="editIncomePayer">付款人 *</label>
                          </div>
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="editIncomeMethod" name="method" required>
                                  <option value="現金" ${income.method === '現金' ? 'selected' : ''}>現金</option>
                                  <option value="轉帳" ${income.method === '轉帳' ? 'selected' : ''}>轉帳</option>
                                  <option value="支票" ${income.method === '支票' ? 'selected' : ''}>支票</option>
                                  <option value="信用卡" ${income.method === '信用卡' ? 'selected' : ''}>信用卡</option>
                              </select>
                              <label for="editIncomeMethod">付款方式 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="editIncomeCategory" name="category" required>
                                  <option value="會費" ${income.category === '會費' ? 'selected' : ''}>會費</option>
                                  <option value="捐款" ${income.category === '捐款' ? 'selected' : ''}>捐款</option>
                                  <option value="補助" ${income.category === '補助' ? 'selected' : ''}>補助</option>
                                  <option value="活動" ${income.category === '活動' ? 'selected' : ''}>活動</option>
                              </select>
                              <label for="editIncomeCategory">類別 *</label>
                          </div>
                      </div>
                  </div>

                  <div class="form-floating mb-3">
                      <input type="text" class="form-control" id="editIncomeInvoiceNumber" name="invoiceNumber" value="${income.invoiceNumber}">
                      <label for="editIncomeInvoiceNumber">發票號碼</label>
                  </div>

                  <div class="form-floating mb-3">
                      <textarea class="form-control" id="editIncomeDescription" name="description" style="height: 80px" required>${income.description}</textarea>
                      <label for="editIncomeDescription">說明 *</label>
                  </div>
              </form>
          `;

          showModal('編輯收入', modalContent, function() {
              const form = document.getElementById('editIncomeForm');
              if (validateForm(form)) {
                  const formData = new FormData(form);
                  const incomeIndex = systemData.income.findIndex(i => i.id === id);
                  const oldAmount = systemData.income[incomeIndex].amount;
                  const newAmount = parseInt(formData.get('amount'));
                  
                  systemData.income[incomeIndex] = {
                      ...systemData.income[incomeIndex],
                      date: formData.get('date'),
                      account: formData.get('account'),
                      amount: newAmount,
                      payer: formData.get('payer'),
                      method: formData.get('method'),
                      category: formData.get('category'),
                      invoiceNumber: formData.get('invoiceNumber'),
                      description: formData.get('description')
                  };
                  
                  // 更新統計
                  systemData.dashboard.stats.totalIncome = systemData.dashboard.stats.totalIncome - oldAmount + newAmount;
                  systemData.dashboard.stats.netIncome = systemData.dashboard.stats.totalIncome - systemData.dashboard.stats.totalExpenses;
                  
                  showToast('收入記錄更新成功', 'success');
                  $('#universalModal').modal('hide');
                  loadIncome();
              }
          });
      }

      // 刪除收入
      function deleteIncome(id) {
          const income = systemData.income.find(i => i.id === id);
          if (!income) return;

          if (confirm(`確定要刪除此收入記錄嗎？\n金額：$${formatCurrency(income.amount)}\n說明：${income.description}`)) {
              const incomeIndex = systemData.income.findIndex(i => i.id === id);
              const deletedAmount = systemData.income[incomeIndex].amount;
              
              systemData.income.splice(incomeIndex, 1);
              systemData.dashboard.stats.totalIncome -= deletedAmount;
              systemData.dashboard.stats.netIncome = systemData.dashboard.stats.totalIncome - systemData.dashboard.stats.totalExpenses;
              
              showToast('收入記錄刪除成功', 'success');
              loadIncome();
          }
      }

      // 產生收據
      function generateReceipt(incomeId) {
          const income = systemData.income.find(i => i.id === incomeId);
          if (!income) return;

          // 檢查是否已有收據
          const existingReceipt = systemData.receipts.find(r => r.purpose === income.description && r.amount === income.amount);
          if (existingReceipt) {
              showToast('此收入已有對應收據', 'warning');
              return;
          }

          const receiptNumber = `R${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(systemData.receipts.length + 1).padStart(4, '0')}`;
          
          const newReceipt = {
              id: ++nextId,
              number: receiptNumber,
              date: income.date,
              payer: income.payer,
              amount: income.amount,
              status: '已開立',
              emailStatus: '未發送',
              purpose: income.description,
              paymentMethod: income.method
          };

          systemData.receipts.push(newReceipt);
          showToast('收據產生成功', 'success');
          
          // 顯示收據預覽
          showReceiptPreview(newReceipt);
      }

      // 載入支出管理
      function loadExpenses() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">支出管理</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-primary" onclick="showAddExpenseModal()">
                              <i class="fas fa-plus"></i> 新增支出
                          </button>
                          <button type="button" class="btn btn-outline-secondary" onclick="exportExpenses()">
                              <i class="fas fa-download"></i> 匯出
                          </button>
                          <button type="button" class="btn btn-outline-warning" onclick="showPendingApprovals()">
                              <i class="fas fa-clock"></i> 待審核 (${systemData.expenses.filter(e => e.status === '待審核').length})
                          </button>
                      </div>
                  </div>
              </div>

              <!-- 統計摘要 -->
              <div class="row mb-4">
                  <div class="col-md-3">
                      <div class="card border-left-danger">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">本月支出</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">$${formatCurrency(calculateMonthlyExpenses())}</div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card border-left-info">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-info text-uppercase mb-1">總支出</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">$${formatCurrency(systemData.dashboard.stats.totalExpenses)}</div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card border-left-warning">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">待審核</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">${systemData.expenses.filter(e => e.status === '待審核').length}</div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card border-left-success">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">已核准</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">${systemData.expenses.filter(e => e.status === '已核准').length}</div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 搜尋和篩選 -->
              <div class="row mb-3">
                  <div class="col-md-4">
                      <div class="search-box">
                          <i class="fas fa-search search-icon"></i>
                          <input type="text" class="form-control search-input" placeholder="搜尋支出記錄..." data-target="#expensesTable">
                      </div>
                  </div>
                  <div class="col-md-2">
                      <select class="form-select" onchange="filterExpenses('status', this.value)">
                          <option value="">所有狀態</option>
                          <option value="已核准">已核准</option>
                          <option value="待審核">待審核</option>
                          <option value="已拒絕">已拒絕</option>
                      </select>
                  </div>
                  <div class="col-md-2">
                      <select class="form-select" onchange="filterExpenses('category', this.value)">
                          <option value="">所有類別</option>
                          <option value="活動">活動</option>
                          <option value="辦公">辦公</option>
                          <option value="交通">交通</option>
                          <option value="水電">水電</option>
                          <option value="租金">租金</option>
                      </select>
                  </div>
                  <div class="col-md-2">
                      <input type="date" class="form-control" id="expenseStartDate" onchange="filterExpensesByDate()">
                  </div>
                  <div class="col-md-2">
                      <button class="btn btn-outline-secondary w-100" onclick="clearExpenseFilters()">
                          <i class="fas fa-times"></i> 清除
                      </button>
                  </div>
              </div>

              <div class="card">
                  <div class="card-header">
                      <h5 class="mb-0">支出記錄</h5>
                  </div>
                  <div class="card-body">
                      <div class="table-responsive">
                          <table class="table table-hover" id="expensesTable">
                              <thead>
                                  <tr>
                                      <th data-sort="date">日期</th>
                                      <th data-sort="account">會計科目</th>
                                      <th data-sort="amount">金額</th>
                                      <th>收款人</th>
                                      <th>付款方式</th>
                                      <th data-sort="status">狀態</th>
                                      <th>類別</th>
                                      <th>核准人</th>
                                      <th>說明</th>
                                      <th class="no-print">操作</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${systemData.expenses.map(item => `
                                      <tr data-expense-id="${item.id}">
                                          <td>${formatDate(item.date)}</td>
                                          <td>${item.account}</td>
                                          <td class="text-danger fw-bold">$${formatCurrency(item.amount)}</td>
                                          <td>${item.payee}</td>
                                          <td><span class="badge bg-info">${item.method}</span></td>
                                          <td><span class="badge ${getStatusBadgeClass(item.status)}">${item.status}</span></td>
                                          <td><span class="badge bg-secondary">${item.category}</span></td>
                                          <td>${item.approver || '-'}</td>
                                          <td>${item.description}</td>
                                          <td class="no-print">
                                              <div class="btn-group btn-group-sm">
                                                  <button class="btn btn-outline-info" onclick="viewExpense(${item.id})" title="檢視">
                                                      <i class="fas fa-eye"></i>
                                                  </button>
                                                  <button class="btn btn-outline-primary" onclick="editExpense(${item.id})" title="編輯">
                                                      <i class="fas fa-edit"></i>
                                                  </button>
                                                  ${item.status === '待審核' ? `
                                                      <button class="btn btn-outline-success" onclick="approveExpense(${item.id})" title="核准">
                                                          <i class="fas fa-check"></i>
                                                      </button>
                                                      <button class="btn btn-outline-warning" onclick="rejectExpense(${item.id})" title="拒絕">
                                                          <i class="fas fa-times"></i>
                                                      </button>
                                                  ` : ''}
                                                  <button class="btn btn-outline-danger" onclick="deleteExpense(${item.id})" title="刪除">
                                                      <i class="fas fa-trash"></i>
                                                  </button>
                                              </div>
                                          </td>
                                      </tr>
                                  `).join('')}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
      }

      // 顯示新增支出 Modal
      function showAddExpenseModal() {
          const modalContent = `
              <form id="addExpenseForm">
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="date" class="form-control" id="expenseDate" name="date" value="${new Date().toISOString().split('T')[0]}" required>
                              <label for="expenseDate">日期 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="expenseAccount" name="account" required>
                                  <option value="">選擇會計科目</option>
                                  ${systemData.accounts.filter(acc => acc.type === '支出' && acc.status === '啟用').map(acc => 
                                      `<option value="${acc.name}">${acc.name}</option>`
                                  ).join('')}
                              </select>
                              <label for="expenseAccount">會計科目 *</label>
                          </div>
                      </div>
                  </div>
                  
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="number" class="form-control currency-input" id="expenseAmount" name="amount" min="0" step="1" required>
                              <label for="expenseAmount">金額 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="expensePayee" name="payee" required>
                              <label for="expensePayee">收款人 *</label>
                          </div>
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="expenseMethod" name="method" required>
                                  <option value="">選擇付款方式</option>
                                  <option value="現金">現金</option>
                                  <option value="轉帳">轉帳</option>
                                  <option value="支票">支票</option>
                                  <option value="信用卡">信用卡</option>
                              </select>
                              <label for="expenseMethod">付款方式 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="expenseCategory" name="category" required>
                                  <option value="">選擇類別</option>
                                  <option value="活動">活動</option>
                                  <option value="辦公">辦公</option>
                                  <option value="交通">交通</option>
                                  <option value="水電">水電</option>
                                  <option value="租金">租金</option>
                              </select>
                              <label for="expenseCategory">類別 *</label>
                          </div>
                      </div>
                  </div>

                  <div class="form-floating mb-3">
                      <input type="text" class="form-control" id="expenseReceiptNumber" name="receiptNumber" value="REC-${new Date().getFullYear()}-${String(systemData.expenses.length + 1).padStart(3, '0')}">
                      <label for="expenseReceiptNumber">收據號碼</label>
                  </div>

                  <div class="form-floating mb-3">
                      <textarea class="form-control" id="expenseDescription" name="description" style="height: 80px" required></textarea>
                      <label for="expenseDescription">說明 *</label>
                  </div>
              </form>
          `;

          showModal('新增支出', modalContent, function() {
              const form = document.getElementById('addExpenseForm');
              if (validateForm(form)) {
                  const formData = new FormData(form);
                  const newExpense = {
                      id: ++nextId,
                      date: formData.get('date'),
                      account: formData.get('account'),
                      amount: parseInt(formData.get('amount')),
                      payee: formData.get('payee'),
                      method: formData.get('method'),
                      status: '待審核',
                      category: formData.get('category'),
                      approver: '',
                      receiptNumber: formData.get('receiptNumber'),
                      description: formData.get('description')
                  };
                  
                  systemData.expenses.push(newExpense);
                  
                  showToast('支出記錄新增成功，等待審核', 'success');
                  $('#universalModal').modal('hide');
                  loadExpenses();
              }
          });
      }

      // 核准支出
      function approveExpense(id) {
          const expense = systemData.expenses.find(e => e.id === id);
          if (!expense) return;

          if (confirm(`確定要核准此支出嗎？\n金額：$${formatCurrency(expense.amount)}\n說明：${expense.description}`)) {
              const expenseIndex = systemData.expenses.findIndex(e => e.id === id);
              systemData.expenses[expenseIndex].status = '已核准';
              systemData.expenses[expenseIndex].approver = '系統管理員';
              
              // 更新統計
              systemData.dashboard.stats.totalExpenses += expense.amount;
              systemData.dashboard.stats.netIncome = systemData.dashboard.stats.totalIncome - systemData.dashboard.stats.totalExpenses;
              
              showToast('支出已核准', 'success');
              loadExpenses();
          }
      }

      // 拒絕支出
      function rejectExpense(id) {
          const expense = systemData.expenses.find(e => e.id === id);
          if (!expense) return;

          const reason = prompt('請輸入拒絕原因：');
          if (reason) {
              const expenseIndex = systemData.expenses.findIndex(e => e.id === id);
              systemData.expenses[expenseIndex].status = '已拒絕';
              systemData.expenses[expenseIndex].approver = '系統管理員';
              systemData.expenses[expenseIndex].rejectReason = reason;
              
              showToast('支出已拒絕', 'warning');
              loadExpenses();
          }
      }

      // 載入會計科目
      function loadAccounts() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">會計科目</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-primary" onclick="showAddAccountModal()">
                              <i class="fas fa-plus"></i> 新增科目
                          </button>
                          <button type="button" class="btn btn-outline-secondary" onclick="exportAccounts()">
                              <i class="fas fa-download"></i> 匯出
                          </button>
                          <button type="button" class="btn btn-outline-info" onclick="importAccounts()">
                              <i class="fas fa-upload"></i> 匯入
                          </button>
                      </div>
                  </div>
              </div>

              <!-- 統計摘要 -->
              <div class="row mb-4">
                  <div class="col-md-3">
                      <div class="card border-left-success">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">收入科目</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">${systemData.accounts.filter(a => a.type === '收入').length}</div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card border-left-danger">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">支出科目</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">${systemData.accounts.filter(a => a.type === '支出').length}</div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card border-left-primary">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">啟用中</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">${systemData.accounts.filter(a => a.status === '啟用').length}</div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card border-left-warning">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">停用中</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">${systemData.accounts.filter(a => a.status === '停用').length}</div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 搜尋和篩選 -->
              <div class="row mb-3">
                  <div class="col-md-4">
                      <div class="search-box">
                          <i class="fas fa-search search-icon"></i>
                          <input type="text" class="form-control search-input" placeholder="搜尋科目..." data-target="#accountsTable">
                      </div>
                  </div>
                  <div class="col-md-3">
                      <select class="form-select" onchange="filterAccounts('type', this.value)">
                          <option value="">所有類型</option>
                          <option value="收入">收入</option>
                          <option value="支出">支出</option>
                      </select>
                  </div>
                  <div class="col-md-3">
                      <select class="form-select" onchange="filterAccounts('status', this.value)">
                          <option value="">所有狀態</option>
                          <option value="啟用">啟用</option>
                          <option value="停用">停用</option>
                      </select>
                  </div>
                  <div class="col-md-2">
                      <button class="btn btn-outline-secondary w-100" onclick="clearAccountFilters()">
                          <i class="fas fa-times"></i> 清除
                      </button>
                  </div>
              </div>

              <div class="card">
                  <div class="card-header">
                      <h5 class="mb-0">科目列表</h5>
                  </div>
                  <div class="card-body">
                      <div class="table-responsive">
                          <table class="table table-hover" id="accountsTable">
                              <thead>
                                  <tr>
                                      <th data-sort="code">科目代碼</th>
                                      <th data-sort="name">科目名稱</th>
                                      <th data-sort="type">類型</th>
                                      <th>上級科目</th>
                                      <th data-sort="status">狀態</th>
                                      <th>說明</th>
                                      <th class="no-print">操作</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${systemData.accounts.map(account => `
                                      <tr data-account-id="${account.id}">
                                          <td><code>${account.code}</code></td>
                                          <td>${account.name}</td>
                                          <td><span class="badge ${account.type === '收入' ? 'bg-success' : 'bg-danger'}">${account.type}</span></td>
                                          <td>${account.parent || '-'}</td>
                                          <td><span class="badge ${account.status === '啟用' ? 'bg-success' : 'bg-secondary'}">${account.status}</span></td>
                                          <td>${account.description}</td>
                                          <td class="no-print">
                                              <div class="btn-group btn-group-sm">
                                                  <button class="btn btn-outline-primary" onclick="editAccount(${account.id})" title="編輯">
                                                      <i class="fas fa-edit"></i>
                                                  </button>
                                                  <button class="btn btn-outline-${account.status === '啟用' ? 'warning' : 'success'}" onclick="toggleAccountStatus(${account.id})" title="${account.status === '啟用' ? '停用' : '啟用'}">
                                                      <i class="fas fa-${account.status === '啟用' ? 'pause' : 'play'}"></i>
                                                  </button>
                                                  <button class="btn btn-outline-danger" onclick="deleteAccount(${account.id})" title="刪除">
                                                      <i class="fas fa-trash"></i>
                                                  </button>
                                              </div>
                                          </td>
                                      </tr>
                                  `).join('')}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
      }

      // 顯示新增會計科目 Modal
      function showAddAccountModal() {
          const modalContent = `
              <form id="addAccountForm">
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="accountCode" name="code" required pattern="[0-9]{4}" maxlength="4">
                              <label for="accountCode">科目代碼 (4位數字) *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="accountName" name="name" required>
                              <label for="accountName">科目名稱 *</label>
                          </div>
                      </div>
                  </div>
                  
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="accountType" name="type" required>
                                  <option value="">選擇類型</option>
                                  <option value="收入">收入</option>
                                  <option value="支出">支出</option>
                              </select>
                              <label for="accountType">類型 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="accountParent" name="parent">
                                  <option value="">選擇上級科目</option>
                                  ${systemData.accounts.map(acc => 
                                      `<option value="${acc.name}">${acc.name}</option>`
                                  ).join('')}
                              </select>
                              <label for="accountParent">上級科目</label>
                          </div>
                      </div>
                  </div>

                  <div class="form-floating mb-3">
                      <textarea class="form-control" id="accountDescription" name="description" style="height: 80px" required></textarea>
                      <label for="accountDescription">說明 *</label>
                  </div>
              </form>
          `;

          showModal('新增會計科目', modalContent, function() {
              const form = document.getElementById('addAccountForm');
              if (validateForm(form)) {
                  const formData = new FormData(form);
                  
                  // 檢查科目代碼是否重複
                  const existingAccount = systemData.accounts.find(a => a.code === formData.get('code'));
                  if (existingAccount) {
                      showToast('科目代碼已存在', 'error');
                      return;
                  }
                  
                  const newAccount = {
                      id: ++nextId,
                      code: formData.get('code'),
                      name: formData.get('name'),
                      type: formData.get('type'),
                      parent: formData.get('parent') || '',
                      status: '啟用',
                      description: formData.get('description')
                  };
                  
                  systemData.accounts.push(newAccount);
                  
                  showToast('會計科目新增成功', 'success');
                  $('#universalModal').modal('hide');
                  loadAccounts();
              }
          });
      }

      // 編輯會計科目
      function editAccount(id) {
          const account = systemData.accounts.find(a => a.id === id);
          if (!account) return;

          const modalContent = `
              <form id="editAccountForm">
                  <input type="hidden" name="id" value="${account.id}">
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="editAccountCode" name="code" value="${account.code}" required pattern="[0-9]{4}" maxlength="4">
                              <label for="editAccountCode">科目代碼 (4位數字) *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="editAccountName" name="name" value="${account.name}" required>
                              <label for="editAccountName">科目名稱 *</label>
                          </div>
                      </div>
                  </div>
                  
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="editAccountType" name="type" required>
                                  <option value="收入" ${account.type === '收入' ? 'selected' : ''}>收入</option>
                                  <option value="支出" ${account.type === '支出' ? 'selected' : ''}>支出</option>
                              </select>
                              <label for="editAccountType">類型 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="editAccountParent" name="parent">
                                  <option value="">選擇上級科目</option>
                                  ${systemData.accounts.filter(acc => acc.id !== id).map(acc => 
                                      `<option value="${acc.name}" ${acc.name === account.parent ? 'selected' : ''}>${acc.name}</option>`
                                  ).join('')}
                              </select>
                              <label for="editAccountParent">上級科目</label>
                          </div>
                      </div>
                  </div>

                  <div class="form-floating mb-3">
                      <textarea class="form-control" id="editAccountDescription" name="description" style="height: 80px" required>${account.description}</textarea>
                      <label for="editAccountDescription">說明 *</label>
                  </div>
              </form>
          `;

          showModal('編輯會計科目 - ' + account.name, modalContent, function() {
              const form = document.getElementById('editAccountForm');
              if (validateForm(form)) {
                  const formData = new FormData(form);
                  
                  // 檢查科目代碼是否重複（排除自己）
                  const existingAccount = systemData.accounts.find(a => a.code === formData.get('code') && a.id !== id);
                  if (existingAccount) {
                      showToast('科目代碼已存在', 'error');
                      return;
                  }
                  
                  const accountIndex = systemData.accounts.findIndex(a => a.id === id);
                  
                  systemData.accounts[accountIndex] = {
                      ...systemData.accounts[accountIndex],
                      code: formData.get('code'),
                      name: formData.get('name'),
                      type: formData.get('type'),
                      parent: formData.get('parent') || '',
                      description: formData.get('description')
                  };
                  
                  showToast('會計科目更新成功', 'success');
                  $('#universalModal').modal('hide');
                  loadAccounts();
              }
          });
      }

      // 切換會計科目狀態
      function toggleAccountStatus(id) {
          const account = systemData.accounts.find(a => a.id === id);
          if (!account) return;

          const newStatus = account.status === '啟用' ? '停用' : '啟用';
          const action = newStatus === '啟用' ? '啟用' : '停用';
          
          if (confirm(`確定要${action}科目「${account.name}」嗎？`)) {
              const accountIndex = systemData.accounts.findIndex(a => a.id === id);
              systemData.accounts[accountIndex].status = newStatus;
              
              showToast(`科目已${action}`, 'success');
              loadAccounts();
          }
      }

      // 刪除會計科目
      function deleteAccount(id) {
          const account = systemData.accounts.find(a => a.id === id);
          if (!account) return;

          // 檢查是否有交易使用此科目
          const hasIncome = systemData.income.some(i => i.account === account.name);
          const hasExpense = systemData.expenses.some(e => e.account === account.name);
          
          if (hasIncome || hasExpense) {
              showToast('此科目已有交易記錄，無法刪除', 'error');
              return;
          }

          if (confirm(`確定要刪除科目「${account.name}」嗎？此操作無法復原。`)) {
              const accountIndex = systemData.accounts.findIndex(a => a.id === id);
              systemData.accounts.splice(accountIndex, 1);
              
              showToast('會計科目刪除成功', 'success');
              loadAccounts();
          }
      }

      // 載入銀行帳戶
      function loadBankAccounts() {
          const totalBalance = systemData.bankAccounts.filter(acc => acc.active).reduce((sum, acc) => sum + acc.balance, 0);
          
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">銀行帳戶</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-primary" onclick="showAddBankAccountModal()">
                              <i class="fas fa-plus"></i> 新增帳戶
                          </button>
                          <button type="button" class="btn btn-outline-success" onclick="reconcileAccounts()">
                              <i class="fas fa-balance-scale"></i> 對帳
                          </button>
                          <button type="button" class="btn btn-outline-info" onclick="showTransferModal()">
                              <i class="fas fa-exchange-alt"></i> 轉帳
                          </button>
                      </div>
                  </div>
              </div>

              <!-- 帳戶總覽 -->
              <div class="row mb-4">
                  <div class="col-md-4">
                      <div class="card border-left-primary">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">總餘額</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">$${formatCurrency(totalBalance)}</div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="card border-left-success">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">啟用帳戶</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">${systemData.bankAccounts.filter(acc => acc.active).length}</div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="card border-left-warning">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">停用帳戶</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">${systemData.bankAccounts.filter(acc => !acc.active).length}</div>
                          </div>
                      </div>
                  </div>
              </div>

              <div class="card">
                  <div class="card-header">
                      <h5 class="mb-0">帳戶列表</h5>
                  </div>
                  <div class="card-body">
                      <div class="table-responsive">
                          <table class="table table-hover" id="bankAccountsTable">
                              <thead>
                                  <tr>
                                      <th data-sort="name">帳戶名稱</th>
                                      <th>銀行</th>
                                      <th>帳號</th>
                                      <th>帳戶類型</th>
                                      <th data-sort="balance">餘額</th>
                                      <th>開戶日期</th>
                                      <th data-sort="active">狀態</th>
                                      <th class="no-print">操作</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${systemData.bankAccounts.map(account => `
                                      <tr data-bank-account-id="${account.id}">
                                          <td><strong>${account.name}</strong></td>
                                          <td>${account.bank}</td>
                                          <td><code>${account.account}</code></td>
                                          <td><span class="badge bg-info">${account.accountType}</span></td>
                                          <td class="fw-bold ${account.balance >= 0 ? 'text-success' : 'text-danger'}">$${formatCurrency(account.balance)}</td>
                                          <td>${formatDate(account.openDate)}</td>
                                          <td><span class="badge ${account.active ? 'bg-success' : 'bg-secondary'}">${account.active ? '啟用' : '停用'}</span></td>
                                          <td class="no-print">
                                              <div class="btn-group btn-group-sm">
                                                  <button class="btn btn-outline-info" onclick="viewBankAccountTransactions(${account.id})" title="交易記錄">
                                                      <i class="fas fa-list"></i>
                                                  </button>
                                                  <button class="btn btn-outline-primary" onclick="editBankAccount(${account.id})" title="編輯">
                                                      <i class="fas fa-edit"></i>
                                                  </button>
                                                  <button class="btn btn-outline-${account.active ? 'warning' : 'success'}" onclick="toggleBankAccountStatus(${account.id})" title="${account.active ? '停用' : '啟用'}">
                                                      <i class="fas fa-${account.active ? 'pause' : 'play'}"></i>
                                                  </button>
                                                  <button class="btn btn-outline-danger" onclick="deleteBankAccount(${account.id})" title="刪除">
                                                      <i class="fas fa-trash"></i>
                                                  </button>
                                              </div>
                                          </td>
                                      </tr>
                                  `).join('')}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
      }

      // 顯示新增銀行帳戶 Modal
      function showAddBankAccountModal() {
          const modalContent = `
              <form id="addBankAccountForm">
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="bankAccountName" name="name" required>
                              <label for="bankAccountName">帳戶名稱 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="bankName" name="bank" required>
                                  <option value="">選擇銀行</option>
                                  <option value="台灣銀行">台灣銀行</option>
                                  <option value="第一銀行">第一銀行</option>
                                  <option value="華南銀行">華南銀行</option>
                                  <option value="彰化銀行">彰化銀行</option>
                                  <option value="台北富邦">台北富邦</option>
                                  <option value="國泰世華">國泰世華</option>
                                  <option value="中國信託">中國信託</option>
                                  <option value="玉山銀行">玉山銀行</option>
                                  <option value="台新銀行">台新銀行</option>
                              </select>
                              <label for="bankName">銀行 *</label>
                          </div>
                      </div>
                  </div>
                  
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="bankAccountNumber" name="account" required pattern="[0-9-]+">
                              <label for="bankAccountNumber">帳號 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="bankAccountType" name="accountType" required>
                                  <option value="">選擇帳戶類型</option>
                                  <option value="活期存款">活期存款</option>
                                  <option value="支票存款">支票存款</option>
                                  <option value="定期存款">定期存款</option>
                              </select>
                              <label for="bankAccountType">帳戶類型 *</label>
                          </div>
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="number" class="form-control currency-input" id="bankAccountBalance" name="balance" value="0" step="1">
                              <label for="bankAccountBalance">初始餘額</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="date" class="form-control" id="bankAccountOpenDate" name="openDate" value="${new Date().toISOString().split('T')[0]}" required>
                              <label for="bankAccountOpenDate">開戶日期 *</label>
                          </div>
                      </div>
                  </div>
              </form>
          `;

          showModal('新增銀行帳戶', modalContent, function() {
              const form = document.getElementById('addBankAccountForm');
              if (validateForm(form)) {
                  const formData = new FormData(form);
                  
                  // 檢查帳號是否重複
                  const existingAccount = systemData.bankAccounts.find(a => a.account === formData.get('account'));
                  if (existingAccount) {
                      showToast('帳號已存在', 'error');
                      return;
                  }
                  
                  const newBankAccount = {
                      id: ++nextId,
                      name: formData.get('name'),
                      bank: formData.get('bank'),
                      account: formData.get('account'),
                      accountType: formData.get('accountType'),
                      balance: parseInt(formData.get('balance') || 0),
                      openDate: formData.get('openDate'),
                      active: true
                  };
                  
                  systemData.bankAccounts.push(newBankAccount);
                  
                  showToast('銀行帳戶新增成功', 'success');
                  $('#universalModal').modal('hide');
                  loadBankAccounts();
              }
          });
      }

      // 載入電子收據
      function loadReceipts() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">電子收據</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-primary" onclick="showCreateReceiptModal()">
                              <i class="fas fa-plus"></i> 開立收據
                          </button>
                          <button type="button" class="btn btn-outline-success" onclick="batchSendReceipts()">
                              <i class="fas fa-envelope"></i> 批次發送
                          </button>
                          <button type="button" class="btn btn-outline-secondary" onclick="exportReceipts()">
                              <i class="fas fa-download"></i> 匯出
                          </button>
                      </div>
                  </div>
              </div>

              <!-- 統計摘要 -->
              <div class="row mb-4">
                  <div class="col-md-3">
                      <div class="card border-left-primary">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">總收據數</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">${systemData.receipts.length}</div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card border-left-success">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">已發送</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">${systemData.receipts.filter(r => r.emailStatus === '已發送').length}</div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card border-left-warning">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">未發送</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">${systemData.receipts.filter(r => r.emailStatus === '未發送').length}</div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card border-left-info">
                          <div class="card-body">
                              <div class="text-xs font-weight-bold text-info text-uppercase mb-1">總金額</div>
                              <div class="h5 mb-0 font-weight-bold text-gray-800">$${formatCurrency(systemData.receipts.reduce((sum, r) => sum + r.amount, 0))}</div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 搜尋和篩選 -->
              <div class="row mb-3">
                  <div class="col-md-4">
                      <div class="search-box">
                          <i class="fas fa-search search-icon"></i>
                          <input type="text" class="form-control search-input" placeholder="搜尋收據..." data-target="#receiptsTable">
                      </div>
                  </div>
                  <div class="col-md-2">
                      <select class="form-select" onchange="filterReceipts('status', this.value)">
                          <option value="">所有狀態</option>
                          <option value="已開立">已開立</option>
                          <option value="已作廢">已作廢</option>
                      </select>
                  </div>
                  <div class="col-md-2">
                      <select class="form-select" onchange="filterReceipts('emailStatus', this.value)">
                          <option value="">發送狀態</option>
                          <option value="已發送">已發送</option>
                          <option value="未發送">未發送</option>
                      </select>
                  </div>
                  <div class="col-md-2">
                      <input type="date" class="form-control" id="receiptStartDate" onchange="filterReceiptsByDate()">
                  </div>
                  <div class="col-md-2">
                      <button class="btn btn-outline-secondary w-100" onclick="clearReceiptFilters()">
                          <i class="fas fa-times"></i> 清除
                      </button>
                  </div>
              </div>

              <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">收據列表</h5>
                      <div class="btn-group btn-group-sm">
                          <button class="btn btn-outline-secondary" onclick="selectAllReceipts()">全選</button>
                          <button class="btn btn-outline-primary" onclick="batchPrintReceipts()">批次列印</button>
                      </div>
                  </div>
                  <div class="card-body">
                      <div class="table-responsive">
                          <table class="table table-hover" id="receiptsTable">
                              <thead>
                                  <tr>
                                      <th><input type="checkbox" id="selectAllReceiptsCheckbox" onchange="toggleAllReceipts()"></th>
                                      <th data-sort="number">收據號碼</th>
                                      <th data-sort="date">日期</th>
                                      <th>付款人</th>
                                      <th data-sort="amount">金額</th>
                                      <th>用途</th>
                                      <th>付款方式</th>
                                      <th data-sort="status">狀態</th>
                                      <th>發送狀態</th>
                                      <th class="no-print">操作</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${systemData.receipts.map(receipt => `
                                      <tr data-receipt-id="${receipt.id}">
                                          <td><input type="checkbox" class="receipt-checkbox" value="${receipt.id}"></td>
                                          <td><code>${receipt.number}</code></td>
                                          <td>${formatDate(receipt.date)}</td>
                                          <td>${receipt.payer}</td>
                                          <td class="text-success fw-bold">$${formatCurrency(receipt.amount)}</td>
                                          <td>${receipt.purpose}</td>
                                          <td><span class="badge bg-info">${receipt.paymentMethod}</span></td>
                                          <td><span class="badge ${receipt.status === '已開立' ? 'bg-success' : 'bg-danger'}">${receipt.status}</span></td>
                                          <td><span class="badge ${receipt.emailStatus === '已發送' ? 'bg-success' : 'bg-warning'}">${receipt.emailStatus}</span></td>
                                          <td class="no-print">
                                              <div class="btn-group btn-group-sm">
                                                  <button class="btn btn-outline-info" onclick="previewReceipt(${receipt.id})" title="預覽">
                                                      <i class="fas fa-eye"></i>
                                                  </button>
                                                  <button class="btn btn-outline-success" onclick="printReceipt(${receipt.id})" title="列印">
                                                      <i class="fas fa-print"></i>
                                                  </button>
                                                  <button class="btn btn-outline-primary" onclick="sendReceiptEmail(${receipt.id})" title="發送Email">
                                                      <i class="fas fa-envelope"></i>
                                                  </button>
                                                  <button class="btn btn-outline-warning" onclick="editReceipt(${receipt.id})" title="編輯">
                                                      <i class="fas fa-edit"></i>
                                                  </button>
                                                  <button class="btn btn-outline-danger" onclick="voidReceipt(${receipt.id})" title="作廢">
                                                      <i class="fas fa-ban"></i>
                                                  </button>
                                              </div>
                                          </td>
                                      </tr>
                                  `).join('')}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
      }

      // 顯示開立收據 Modal
      function showCreateReceiptModal() {
          const modalContent = `
              <form id="createReceiptForm">
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="receiptNumber" name="number" value="R${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(systemData.receipts.length + 1).padStart(4, '0')}" readonly>
                              <label for="receiptNumber">收據號碼</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="date" class="form-control" id="receiptDate" name="date" value="${new Date().toISOString().split('T')[0]}" required>
                              <label for="receiptDate">日期 *</label>
                          </div>
                      </div>
                  </div>
                  
                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="receiptPayer" name="payer" required>
                              <label for="receiptPayer">付款人 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="number" class="form-control currency-input" id="receiptAmount" name="amount" min="0" step="1" required>
                              <label for="receiptAmount">金額 *</label>
                          </div>
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="receiptPurpose" name="purpose" required>
                              <label for="receiptPurpose">用途 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating mb-3">
                              <select class="form-select" id="receiptPaymentMethod" name="paymentMethod" required>
                                  <option value="">選擇付款方式</option>
                                  <option value="現金">現金</option>
                                  <option value="轉帳">轉帳</option>
                                  <option value="支票">支票</option>
                                  <option value="信用卡">信用卡</option>
                              </select>
                              <label for="receiptPaymentMethod">付款方式 *</label>
                          </div>
                      </div>
                  </div>

                  <div class="form-check mb-3">
                      <input class="form-check-input" type="checkbox" id="sendEmailImmediately" name="sendEmail">
                      <label class="form-check-label" for="sendEmailImmediately">
                          立即發送Email
                      </label>
                  </div>
              </form>
          `;

          showModal('開立收據', modalContent, function() {
              const form = document.getElementById('createReceiptForm');
              if (validateForm(form)) {
                  const formData = new FormData(form);
                  const newReceipt = {
                      id: ++nextId,
                      number: formData.get('number'),
                      date: formData.get('date'),
                      payer: formData.get('payer'),
                      amount: parseInt(formData.get('amount')),
                      purpose: formData.get('purpose'),
                      paymentMethod: formData.get('paymentMethod'),
                      status: '已開立',
                      emailStatus: formData.get('sendEmail') ? '已發送' : '未發送'
                  };
                  
                  systemData.receipts.push(newReceipt);
                  
                  showToast('收據開立成功', 'success');
                  $('#universalModal').modal('hide');
                  loadReceipts();
                  
                  // 如果選擇立即發送Email，顯示預覽
                  if (formData.get('sendEmail')) {
                      setTimeout(() => showReceiptPreview(newReceipt), 500);
                  }
              }
          });
      }

      // 預覽收據
      function previewReceipt(id) {
          const receipt = systemData.receipts.find(r => r.id === id);
          if (!receipt) return;
          
          showReceiptPreview(receipt);
      }

      // 顯示收據預覽
      function showReceiptPreview(receipt) {
          const modalContent = `
              <div class="receipt-preview">
                  <div class="receipt-header">
                      <h3>${systemData.settings.organization.name}</h3>
                      <p>統一編號：${systemData.settings.organization.taxId}</p>
                      <p>${systemData.settings.organization.address}</p>
                      <p>電話：${systemData.settings.organization.phone}</p>
                      <h4 class="mt-3 text-primary">收據</h4>
                  </div>
                  
                  <div class="receipt-content">
                      <div class="row mb-2">
                          <div class="col-6"><strong>收據號碼：</strong></div>
                          <div class="col-6">${receipt.number}</div>
                      </div>
                      <div class="row mb-2">
                          <div class="col-6"><strong>日期：</strong></div>
                          <div class="col-6">${formatDate(receipt.date)}</div>
                      </div>
                      <div class="row mb-2">
                          <div class="col-6"><strong>付款人：</strong></div>
                          <div class="col-6">${receipt.payer}</div>
                      </div>
                      <div class="row mb-2">
                          <div class="col-6"><strong>金額：</strong></div>
                          <div class="col-6 text-success fw-bold">新台幣 ${formatCurrency(receipt.amount)} 元整</div>
                      </div>
                      <div class="row mb-2">
                          <div class="col-6"><strong>用途：</strong></div>
                          <div class="col-6">${receipt.purpose}</div>
                      </div>
                      <div class="row mb-2">
                          <div class="col-6"><strong>付款方式：</strong></div>
                          <div class="col-6">${receipt.paymentMethod}</div>
                      </div>
                      
                      <div class="text-center mt-4">
                          <p>此收據為電子收據，具有法律效力</p>
                          <p class="text-muted">開立時間：${new Date().toLocaleString()}</p>
                      </div>
                  </div>
              </div>
          `;

          const footerContent = `
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
              <button type="button" class="btn btn-success" onclick="printReceipt(${receipt.id})">
                  <i class="fas fa-print"></i> 列印
              </button>
              <button type="button" class="btn btn-primary" onclick="sendReceiptEmail(${receipt.id})">
                  <i class="fas fa-envelope"></i> 發送Email
              </button>
          `;

          showModal('收據預覽 - ' + receipt.number, modalContent, null, false, footerContent);
      }

      // 列印收據
      function printReceipt(id) {
          const receipt = systemData.receipts.find(r => r.id === id);
          if (!receipt) return;

          // 創建列印視窗
          const printWindow = window.open('', '_blank');
          const printContent = `
              <!DOCTYPE html>
              <html>
              <head>
                  <title>收據 - ${receipt.number}</title>
                  <style>
                      body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 20px; }
                      .receipt { max-width: 600px; margin: 0 auto; border: 2px solid #007bff; padding: 20px; }
                      .header { text-align: center; border-bottom: 2px solid #007bff; padding-bottom: 15px; margin-bottom: 20px; }
                      .content { line-height: 2; }
                      .row { display: flex; margin-bottom: 10px; }
                      .col-6 { width: 50%; }
                      .text-center { text-align: center; }
                      .text-success { color: #28a745; }
                      .fw-bold { font-weight: bold; }
                      .mt-4 { margin-top: 2rem; }
                      .text-muted { color: #6c757d; }
                  </style>
              </head>
              <body>
                  <div class="receipt">
                      <div class="header">
                          <h2>${systemData.settings.organization.name}</h2>
                          <p>統一編號：${systemData.settings.organization.taxId}</p>
                          <p>${systemData.settings.organization.address}</p>
                          <p>電話：${systemData.settings.organization.phone}</p>
                          <h3 style="color: #007bff; margin-top: 20px;">收據</h3>
                      </div>
                      
                      <div class="content">
                          <div class="row">
                              <div class="col-6"><strong>收據號碼：</strong></div>
                              <div class="col-6">${receipt.number}</div>
                          </div>
                          <div class="row">
                              <div class="col-6"><strong>日期：</strong></div>
                              <div class="col-6">${formatDate(receipt.date)}</div>
                          </div>
                          <div class="row">
                              <div class="col-6"><strong>付款人：</strong></div>
                              <div class="col-6">${receipt.payer}</div>
                          </div>
                          <div class="row">
                              <div class="col-6"><strong>金額：</strong></div>
                              <div class="col-6 text-success fw-bold">新台幣 ${formatCurrency(receipt.amount)} 元整</div>
                          </div>
                          <div class="row">
                              <div class="col-6"><strong>用途：</strong></div>
                              <div class="col-6">${receipt.purpose}</div>
                          </div>
                          <div class="row">
                              <div class="col-6"><strong>付款方式：</strong></div>
                              <div class="col-6">${receipt.paymentMethod}</div>
                          </div>
                          
                          <div class="text-center mt-4">
                              <p>此收據為電子收據，具有法律效力</p>
                              <p class="text-muted">列印時間：${new Date().toLocaleString()}</p>
                          </div>
                      </div>
                  </div>
                  <script>
                      window.onload = function() {
                          window.print();
                          window.close();
                      }
                  </script>
              </body>
              </html>
          `;

          printWindow.document.write(printContent);
          printWindow.document.close();
          
          showToast('收據已發送至列印', 'success');
      }

      // 發送收據Email
      function sendReceiptEmail(id) {
          const receipt = systemData.receipts.find(r => r.id === id);
          if (!receipt) return;

          // 模擬發送Email
          setTimeout(() => {
              const receiptIndex = systemData.receipts.findIndex(r => r.id === id);
              systemData.receipts[receiptIndex].emailStatus = '已發送';
              
              showToast(`收據 ${receipt.number} 已發送至 ${receipt.payer} 的Email`, 'success');
              
              if (currentPage === 'receipts') {
                  loadReceipts();
              }
          }, 1000);
      }

      // 載入財務報表
      function loadReports() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">財務報表</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-outline-primary" onclick="generateIncomeStatement()">
                              <i class="fas fa-chart-line"></i> 損益表
                          </button>
                          <button type="button" class="btn btn-outline-success" onclick="generateBalanceSheet()">
                              <i class="fas fa-balance-scale"></i> 資產負債表
                          </button>
                          <button type="button" class="btn btn-outline-info" onclick="generateCashFlow()">
                              <i class="fas fa-money-bill-wave"></i> 現金流量表
                          </button>
                      </div>
                  </div>
              </div>

              <!-- 報表篩選 -->
              <div class="card mb-4">
                  <div class="card-header">
                      <h5 class="mb-0">報表設定</h5>
                  </div>
                  <div class="card-body">
                      <div class="row">
                          <div class="col-md-3">
                              <div class="form-floating">
                                  <select class="form-select" id="reportType" onchange="updateReportType()">
                                      <option value="monthly">月報表</option>
                                      <option value="quarterly">季報表</option>
                                      <option value="yearly">年報表</option>
                                      <option value="custom">自訂期間</option>
                                  </select>
                                  <label for="reportType">報表類型</label>
                              </div>
                          </div>
                          <div class="col-md-3">
                              <div class="form-floating">
                                  <input type="date" class="form-control" id="reportStartDate" value="${new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0]}">
                                  <label for="reportStartDate">開始日期</label>
                              </div>
                          </div>
                          <div class="col-md-3">
                              <div class="form-floating">
                                  <input type="date" class="form-control" id="reportEndDate" value="${new Date().toISOString().split('T')[0]}">
                                  <label for="reportEndDate">結束日期</label>
                              </div>
                          </div>
                          <div class="col-md-3">
                              <button class="btn btn-primary w-100 h-100" onclick="generateReport()">
                                  <i class="fas fa-chart-bar"></i> 產生報表
                              </button>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 報表內容 -->
              <div class="row">
                  <div class="col-lg-8">
                      <div class="card">
                          <div class="card-header d-flex justify-content-between align-items-center">
                              <h5 class="mb-0">收支分析圖表</h5>
                              <div class="btn-group btn-group-sm">
                                  <button class="btn btn-outline-secondary active" onclick="showChart('income-expense')">收支對比</button>
                                  <button class="btn btn-outline-secondary" onclick="showChart('category')">類別分析</button>
                                  <button class="btn btn-outline-secondary" onclick="showChart('trend')">趨勢分析</button>
                              </div>
                          </div>
                          <div class="card-body">
                              <canvas id="reportChart" width="400" height="200"></canvas>
                          </div>
                      </div>
                  </div>

                  <div class="col-lg-4">
                      <div class="card">
                          <div class="card-header">
                              <h5 class="mb-0">財務摘要</h5>
                          </div>
                          <div class="card-body">
                              <div class="mb-3">
                                  <div class="d-flex justify-content-between">
                                      <span>總收入：</span>
                                      <span class="text-success fw-bold">$${formatCurrency(systemData.dashboard.stats.totalIncome)}</span>
                                  </div>
                              </div>
                              <div class="mb-3">
                                  <div class="d-flex justify-content-between">
                                      <span>總支出：</span>
                                      <span class="text-danger fw-bold">$${formatCurrency(systemData.dashboard.stats.totalExpenses)}</span>
                                  </div>
                              </div>
                              <div class="mb-3">
                                  <div class="d-flex justify-content-between">
                                      <span>淨收益：</span>
                                      <span class="fw-bold ${systemData.dashboard.stats.netIncome >= 0 ? 'text-success' : 'text-danger'}">$${formatCurrency(systemData.dashboard.stats.netIncome)}</span>
                                  </div>
                              </div>
                              <hr>
                              <div class="mb-3">
                                  <div class="d-flex justify-content-between">
                                      <span>銀行餘額：</span>
                                      <span class="text-primary fw-bold">$${formatCurrency(systemData.bankAccounts.filter(acc => acc.active).reduce((sum, acc) => sum + acc.balance, 0))}</span>
                                  </div>
                              </div>
                              <div class="mb-3">
                                  <div class="d-flex justify-content-between">
                                      <span>會員人數：</span>
                                      <span class="text-info fw-bold">${systemData.members.length} 人</span>
                                  </div>
                              </div>
                              <div class="mb-3">
                                  <div class="d-flex justify-content-between">
                                      <span>收據數量：</span>
                                      <span class="text-warning fw-bold">${systemData.receipts.length} 張</span>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <div class="card mt-3">
                          <div class="card-header">
                              <h5 class="mb-0">快速操作</h5>
                          </div>
                          <div class="card-body">
                              <div class="d-grid gap-2">
                                  <button class="btn btn-outline-primary" onclick="exportFinancialReport()">
                                      <i class="fas fa-file-excel"></i> 匯出Excel報表
                                  </button>
                                  <button class="btn btn-outline-secondary" onclick="printFinancialReport()">
                                      <i class="fas fa-print"></i> 列印報表
                                  </button>
                                  <button class="btn btn-outline-info" onclick="emailFinancialReport()">
                                      <i class="fas fa-envelope"></i> Email報表
                                  </button>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 詳細報表表格 -->
              <div class="card mt-4">
                  <div class="card-header">
                      <h5 class="mb-0">詳細報表</h5>
                  </div>
                  <div class="card-body">
                      <div id="detailedReport">
                          <p class="text-muted text-center">請點擊上方「產生報表」按鈕來產生詳細報表</p>
                      </div>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
          
          // 初始化圖表
          setTimeout(() => {
              initializeReportChart();
          }, 100);
      }

      // 初始化報表圖表
      function initializeReportChart() {
          const ctx = document.getElementById('reportChart');
          if (!ctx) return;

          // 銷毀現有圖表
          if (currentChart) {
              currentChart.destroy();
          }

          const data = systemData.dashboard.monthlyData;
          
          currentChart = new Chart(ctx, {
              type: 'bar',
              data: {
                  labels: data.map(item => item.month),
                  datasets: [{
                      label: '收入',
                      data: data.map(item => item.income),
                      backgroundColor: 'rgba(75, 192, 192, 0.8)',
                      borderColor: 'rgba(75, 192, 192, 1)',
                      borderWidth: 1
                  }, {
                      label: '支出',
                      data: data.map(item => item.expense),
                      backgroundColor: 'rgba(255, 99, 132, 0.8)',
                      borderColor: 'rgba(255, 99, 132, 1)',
                      borderWidth: 1
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      title: {
                          display: true,
                          text: '收支對比圖'
                      },
                      legend: {
                          display: true,
                          position: 'top'
                      }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          ticks: {
                              callback: function(value) {
                                  return '$' + value.toLocaleString();
                              }
                          }
                      }
                  }
              }
          });
      }

      // 產生報表
      function generateReport() {
          const reportType = document.getElementById('reportType').value;
          const startDate = document.getElementById('reportStartDate').value;
          const endDate = document.getElementById('reportEndDate').value;

          // 篩選期間內的資料
          const filteredIncome = systemData.income.filter(item => 
              item.date >= startDate && item.date <= endDate
          );
          const filteredExpenses = systemData.expenses.filter(item => 
              item.date >= startDate && item.date <= endDate && item.status === '已核准'
          );

          const totalIncome = filteredIncome.reduce((sum, item) => sum + item.amount, 0);
          const totalExpenses = filteredExpenses.reduce((sum, item) => sum + item.amount, 0);
          const netIncome = totalIncome - totalExpenses;

          // 按類別統計
          const incomeByCategory = {};
          const expensesByCategory = {};

          filteredIncome.forEach(item => {
              incomeByCategory[item.category] = (incomeByCategory[item.category] || 0) + item.amount;
          });

          filteredExpenses.forEach(item => {
              expensesByCategory[item.category] = (expensesByCategory[item.category] || 0) + item.amount;
          });

          // 產生詳細報表HTML
          const reportHTML = `
              <div class="report-summary mb-4">
                  <h6>報表期間：${formatDate(startDate)} 至 ${formatDate(endDate)}</h6>
                  <div class="row">
                      <div class="col-md-4">
                          <div class="card border-left-success">
                              <div class="card-body">
                                  <div class="text-xs font-weight-bold text-success text-uppercase mb-1">期間收入</div>
                                  <div class="h6 mb-0 font-weight-bold text-gray-800">$${formatCurrency(totalIncome)}</div>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="card border-left-danger">
                              <div class="card-body">
                                  <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">期間支出</div>
                                  <div class="h6 mb-0 font-weight-bold text-gray-800">$${formatCurrency(totalExpenses)}</div>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="card border-left-${netIncome >= 0 ? 'success' : 'warning'}">
                              <div class="card-body">
                                  <div class="text-xs font-weight-bold text-${netIncome >= 0 ? 'success' : 'warning'} text-uppercase mb-1">淨收益</div>
                                  <div class="h6 mb-0 font-weight-bold text-gray-800">$${formatCurrency(netIncome)}</div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <div class="row">
                  <div class="col-md-6">
                      <h6>收入明細</h6>
                      <div class="table-responsive">
                          <table class="table table-sm">
                              <thead>
                                  <tr>
                                      <th>類別</th>
                                      <th class="text-end">金額</th>
                                      <th class="text-end">比例</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${Object.entries(incomeByCategory).map(([category, amount]) => `
                                      <tr>
                                          <td>${category}</td>
                                          <td class="text-end text-success">$${formatCurrency(amount)}</td>
                                          <td class="text-end">${((amount / totalIncome) * 100).toFixed(1)}%</td>
                                      </tr>
                                  `).join('')}
                                  <tr class="table-success fw-bold">
                                      <td>總計</td>
                                      <td class="text-end">$${formatCurrency(totalIncome)}</td>
                                      <td class="text-end">100.0%</td>
                                  </tr>
                              </tbody>
                          </table>
                      </div>
                  </div>

                  <div class="col-md-6">
                      <h6>支出明細</h6>
                      <div class="table-responsive">
                          <table class="table table-sm">
                              <thead>
                                  <tr>
                                      <th>類別</th>
                                      <th class="text-end">金額</th>
                                      <th class="text-end">比例</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${Object.entries(expensesByCategory).map(([category, amount]) => `
                                      <tr>
                                          <td>${category}</td>
                                          <td class="text-end text-danger">$${formatCurrency(amount)}</td>
                                          <td class="text-end">${totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(1) : 0}%</td>
                                      </tr>
                                  `).join('')}
                                  <tr class="table-danger fw-bold">
                                      <td>總計</td>
                                      <td class="text-end">$${formatCurrency(totalExpenses)}</td>
                                      <td class="text-end">100.0%</td>
                                  </tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>

              <div class="mt-4">
                  <h6>交易明細</h6>
                  <div class="table-responsive">
                      <table class="table table-sm table-striped">
                          <thead>
                              <tr>
                                  <th>日期</th>
                                  <th>類型</th>
                                  <th>科目</th>
                                  <th>說明</th>
                                  <th class="text-end">收入</th>
                                  <th class="text-end">支出</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${[...filteredIncome.map(item => ({...item, type: '收入'})), 
                                 ...filteredExpenses.map(item => ({...item, type: '支出'}))]
                                 .sort((a, b) => new Date(a.date) - new Date(b.date))
                                 .map(item => `
                                  <tr>
                                      <td>${formatDate(item.date)}</td>
                                      <td><span class="badge ${item.type === '收入' ? 'bg-success' : 'bg-danger'}">${item.type}</span></td>
                                      <td>${item.account}</td>
                                      <td>${item.description}</td>
                                      <td class="text-end text-success">${item.type === '收入' ? '$' + formatCurrency(item.amount) : '-'}</td>
                                      <td class="text-end text-danger">${item.type === '支出' ? '$' + formatCurrency(item.amount) : '-'}</td>
                                  </tr>
                              `).join('')}
                          </tbody>
                      </table>
                  </div>
              </div>
          `;

          document.getElementById('detailedReport').innerHTML = reportHTML;
          showToast('報表產生完成', 'success');
      }

      // 載入系統設定
      function loadSettings() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">系統設定</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-success" onclick="saveSettings()">
                              <i class="fas fa-save"></i> 儲存設定
                          </button>
                          <button type="button" class="btn btn-outline-warning" onclick="resetSettings()">
                              <i class="fas fa-undo"></i> 重置
                          </button>
                          <button type="button" class="btn btn-outline-info" onclick="exportSettings()">
                              <i class="fas fa-download"></i> 匯出設定
                          </button>
                      </div>
                  </div>
              </div>

              <div class="row">
                  <div class="col-lg-8">
                      <!-- 組織資訊 -->
                      <div class="card mb-4">
                          <div class="card-header">
                              <h5 class="mb-0"><i class="fas fa-building"></i> 組織資訊</h5>
                          </div>
                          <div class="card-body">
                              <form id="organizationForm">
                                  <div class="row">
                                      <div class="col-md-6">
                                          <div class="form-floating mb-3">
                                              <input type="text" class="form-control" id="orgName" name="name" value="${systemData.settings.organization.name}" required>
                                              <label for="orgName">組織名稱 *</label>
                                          </div>
                                      </div>
                                      <div class="col-md-6">
                                          <div class="form-floating mb-3">
                                              <input type="text" class="form-control" id="orgTaxId" name="taxId" value="${systemData.settings.organization.taxId}" pattern="[0-9]{8}">
                                              <label for="orgTaxId">統一編號</label>
                                          </div>
                                      </div>
                                  </div>
                                  
                                  <div class="form-floating mb-3">
                                      <textarea class="form-control" id="orgAddress" name="address" style="height: 80px">${systemData.settings.organization.address}</textarea>
                                      <label for="orgAddress">地址</label>
                                  </div>

                                  <div class="row">
                                      <div class="col-md-6">
                                          <div class="form-floating mb-3">
                                              <input type="tel" class="form-control" id="orgPhone" name="phone" value="${systemData.settings.organization.phone}">
                                              <label for="orgPhone">電話</label>
                                          </div>
                                      </div>
                                      <div class="col-md-6">
                                          <div class="form-floating mb-3">
                                              <input type="email" class="form-control" id="orgEmail" name="email" value="${systemData.settings.organization.email}">
                                              <label for="orgEmail">電子郵件</label>
                                          </div>
                                      </div>
                                  </div>
                              </form>
                          </div>
                      </div>

                      <!-- 系統設定 -->
                      <div class="card mb-4">
                          <div class="card-header">
                              <h5 class="mb-0"><i class="fas fa-cogs"></i> 系統設定</h5>
                          </div>
                          <div class="card-body">
                              <form id="systemForm">
                                  <div class="row">
                                      <div class="col-md-6">
                                          <div class="form-floating mb-3">
                                              <select class="form-select" id="currency" name="currency">
                                                  <option value="TWD" ${systemData.settings.system.currency === 'TWD' ? 'selected' : ''}>新台幣 (TWD)</option>
                                                  <option value="USD" ${systemData.settings.system.currency === 'USD' ? 'selected' : ''}>美元 (USD)</option>
                                                  <option value="CNY" ${systemData.settings.system.currency === 'CNY' ? 'selected' : ''}>人民幣 (CNY)</option>
                                              </select>
                                              <label for="currency">預設幣別</label>
                                          </div>
                                      </div>
                                      <div class="col-md-6">
                                          <div class="form-floating mb-3">
                                              <select class="form-select" id="dateFormat" name="dateFormat">
                                                  <option value="YYYY-MM-DD" ${systemData.settings.system.dateFormat === 'YYYY-MM-DD' ? 'selected' : ''}>YYYY-MM-DD</option>
                                                  <option value="DD/MM/YYYY" ${systemData.settings.system.dateFormat === 'DD/MM/YYYY' ? 'selected' : ''}>DD/MM/YYYY</option>
                                                  <option value="MM/DD/YYYY" ${systemData.settings.system.dateFormat === 'MM/DD/YYYY' ? 'selected' : ''}>MM/DD/YYYY</option>
                                              </select>
                                              <label for="dateFormat">日期格式</label>
                                          </div>
                                      </div>
                                  </div>

                                  <div class="row">
                                      <div class="col-md-6">
                                          <div class="form-floating mb-3">
                                              <select class="form-select" id="fiscalYearStart" name="fiscalYearStart">
                                                  ${Array.from({length: 12}, (_, i) => {
                                                      const month = i + 1;
                                                      const monthName = new Date(2000, i).toLocaleDateString('zh-TW', {month: 'long'});
                                                      return `<option value="${month}" ${systemData.settings.system.fiscalYearStart === month ? 'selected' : ''}>${month}月 (${monthName})</option>`;
                                                  }).join('')}
                                              </select>
                                              <label for="fiscalYearStart">會計年度開始月份</label>
                                          </div>
                                      </div>
                                      <div class="col-md-6">
                                          <div class="form-floating mb-3">
                                              <input type="number" class="form-control" id="receiptValidDays" name="receiptValidDays" value="${systemData.settings.system.receiptValidDays}" min="1" max="365">
                                              <label for="receiptValidDays">收據有效天數</label>
                                          </div>
                                      </div>
                                  </div>

                                  <div class="form-check mb-3">
                                      <input class="form-check-input" type="checkbox" id="autoBackup" name="autoBackup" ${systemData.settings.system.autoBackup ? 'checked' : ''}>
                                      <label class="form-check-label" for="autoBackup">
                                          啟用自動備份
                                      </label>
                                  </div>

                                  <div class="form-check mb-3">
                                      <input class="form-check-input" type="checkbox" id="emailNotifications" name="emailNotifications" ${systemData.settings.system.emailNotifications ? 'checked' : ''}>
                                      <label class="form-check-label" for="emailNotifications">
                                          啟用Email通知
                                      </label>
                                  </div>
                              </form>
                          </div>
                      </div>

                      <!-- 權限設定 -->
                      <div class="card mb-4">
                          <div class="card-header">
                              <h5 class="mb-0"><i class="fas fa-shield-alt"></i> 權限設定</h5>
                          </div>
                          <div class="card-body">
                              <form id="permissionsForm">
                                  <div class="row">
                                      <div class="col-md-6">
                                          <h6>收入管理</h6>
                                          <div class="form-check mb-2">
                                              <input class="form-check-input" type="checkbox" id="canAddIncome" name="canAddIncome" ${systemData.settings.permissions.canAddIncome ? 'checked' : ''}>
                                              <label class="form-check-label" for="canAddIncome">新增收入</label>
                                          </div>
                                          <div class="form-check mb-2">
                                              <input class="form-check-input" type="checkbox" id="canEditIncome" name="canEditIncome" ${systemData.settings.permissions.canEditIncome ? 'checked' : ''}>
                                              <label class="form-check-label" for="canEditIncome">編輯收入</label>
                                          </div>
                                          <div class="form-check mb-3">
                                              <input class="form-check-input" type="checkbox" id="canDeleteIncome" name="canDeleteIncome" ${systemData.settings.permissions.canDeleteIncome ? 'checked' : ''}>
                                              <label class="form-check-label" for="canDeleteIncome">刪除收入</label>
                                          </div>
                                      </div>
                                      <div class="col-md-6">
                                          <h6>支出管理</h6>
                                          <div class="form-check mb-2">
                                              <input class="form-check-input" type="checkbox" id="canAddExpense" name="canAddExpense" ${systemData.settings.permissions.canAddExpense ? 'checked' : ''}>
                                              <label class="form-check-label" for="canAddExpense">新增支出</label>
                                          </div>
                                          <div class="form-check mb-2">
                                              <input class="form-check-input" type="checkbox" id="canApproveExpense" name="canApproveExpense" ${systemData.settings.permissions.canApproveExpense ? 'checked' : ''}>
                                              <label class="form-check-label" for="canApproveExpense">核准支出</label>
                                          </div>
                                          <div class="form-check mb-3">
                                              <input class="form-check-input" type="checkbox" id="canDeleteExpense" name="canDeleteExpense" ${systemData.settings.permissions.canDeleteExpense ? 'checked' : ''}>
                                              <label class="form-check-label" for="canDeleteExpense">刪除支出</label>
                                          </div>
                                      </div>
                                  </div>
                              </form>
                          </div>
                      </div>
                  </div>

                  <div class="col-lg-4">
                      <!-- 系統狀態 -->
                      <div class="card mb-4">
                          <div class="card-header">
                              <h5 class="mb-0"><i class="fas fa-info-circle"></i> 系統狀態</h5>
                          </div>
                          <div class="card-body">
                              <div class="mb-3">
                                  <small class="text-muted">系統版本</small>
                                  <div class="fw-bold">v1.0.0</div>
                              </div>
                              <div class="mb-3">
                                  <small class="text-muted">最後備份時間</small>
                                  <div class="fw-bold">${new Date().toLocaleString()}</div>
                              </div>
                              <div class="mb-3">
                                  <small class="text-muted">資料庫大小</small>
                                  <div class="fw-bold">2.5 MB</div>
                              </div>
                              <div class="mb-3">
                                  <small class="text-muted">系統狀態</small>
                                  <div class="fw-bold text-success">正常運行</div>
                              </div>
                          </div>
                      </div>

                      <!-- 快速操作 -->
                      <div class="card mb-4">
                          <div class="card-header">
                              <h5 class="mb-0"><i class="fas fa-tools"></i> 系統維護</h5>
                          </div>
                          <div class="card-body">
                              <div class="d-grid gap-2">
                                  <button class="btn btn-outline-primary" onclick="backupData()">
                                      <i class="fas fa-database"></i> 備份資料
                                  </button>
                                  <button class="btn btn-outline-warning" onclick="clearCache()">
                                      <i class="fas fa-broom"></i> 清除快取
                                  </button>
                                  <button class="btn btn-outline-info" onclick="checkUpdates()">
                                      <i class="fas fa-sync"></i> 檢查更新
                                  </button>
                                  <button class="btn btn-outline-danger" onclick="resetSystem()">
                                      <i class="fas fa-exclamation-triangle"></i> 重置系統
                                  </button>
                              </div>
                          </div>
                      </div>

                      <!-- 幫助資訊 -->
                      <div class="card">
                          <div class="card-header">
                              <h5 class="mb-0"><i class="fas fa-question-circle"></i> 幫助</h5>
                          </div>
                          <div class="card-body">
                              <div class="d-grid gap-2">
                                  <button class="btn btn-outline-info" onclick="showUserManual()">
                                      <i class="fas fa-book"></i> 使用手冊
                                  </button>
                                  <button class="btn btn-outline-secondary" onclick="contactSupport()">
                                      <i class="fas fa-headset"></i> 技術支援
                                  </button>
                                  <button class="btn btn-outline-primary" onclick="showAbout()">
                                      <i class="fas fa-info"></i> 關於系統
                                  </button>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
      }

      // 儲存設定
      function saveSettings() {
          const orgForm = document.getElementById('organizationForm');
          const sysForm = document.getElementById('systemForm');
          const permForm = document.getElementById('permissionsForm');

          if (validateForm(orgForm) && validateForm(sysForm)) {
              // 更新組織資訊
              const orgData = new FormData(orgForm);
              systemData.settings.organization = {
                  name: orgData.get('name'),
                  taxId: orgData.get('taxId'),
                  address: orgData.get('address'),
                  phone: orgData.get('phone'),
                  email: orgData.get('email')
              };

              // 更新系統設定
              const sysData = new FormData(sysForm);
              systemData.settings.system = {
                  currency: sysData.get('currency'),
                  dateFormat: sysData.get('dateFormat'),
                  fiscalYearStart: parseInt(sysData.get('fiscalYearStart')),
                  receiptValidDays: parseInt(sysData.get('receiptValidDays')),
                  autoBackup: sysData.has('autoBackup'),
                  emailNotifications: sysData.has('emailNotifications')
              };

              // 更新權限設定
              const permData = new FormData(permForm);
              systemData.settings.permissions = {
                  canAddIncome: permData.has('canAddIncome'),
                  canEditIncome: permData.has('canEditIncome'),
                  canDeleteIncome: permData.has('canDeleteIncome'),
                  canAddExpense: permData.has('canAddExpense'),
                  canApproveExpense: permData.has('canApproveExpense'),
                  canDeleteExpense: permData.has('canDeleteExpense')
              };

              showToast('設定儲存成功', 'success');
          }
      }

      // 工具函數
      function formatCurrency(amount) {
          return Math.abs(amount).toLocaleString();
      }

      function formatDate(dateString) {
          return new Date(dateString).toLocaleDateString('zh-TW');
      }

      function calculateMonthlyIncome() {
          const currentMonth = new Date().getMonth() + 1;
          const currentYear = new Date().getFullYear();
          
          return systemData.income
              .filter(item => {
                  const itemDate = new Date(item.date);
                  return itemDate.getMonth() + 1 === currentMonth && 
                         itemDate.getFullYear() === currentYear;
              })
              .reduce((sum, item) => sum + item.amount, 0);
      }

      function calculateMonthlyExpenses() {
          const currentMonth = new Date().getMonth() + 1;
          const currentYear = new Date().getFullYear();
          
          return systemData.expenses
              .filter(item => {
                  const itemDate = new Date(item.date);
                  return itemDate.getMonth() + 1 === currentMonth && 
                         itemDate.getFullYear() === currentYear &&
                         item.status === '已核准';
              })
              .reduce((sum, item) => sum + item.amount, 0);
      }

      function showModal(title, content, onConfirm = null, showConfirm = true, customFooter = null) {
          const modalHTML = `
              <div class="modal fade" id="universalModal" tabindex="-1" aria-labelledby="universalModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                          <div class="modal-header">
                              <h5 class="modal-title" id="universalModalLabel">${title}</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                              ${content}
                          </div>
                          <div class="modal-footer">
                              ${customFooter || `
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                  ${showConfirm ? '<button type="button" class="btn btn-primary" id="confirmBtn">確定</button>' : ''}
                              `}
                          </div>
                      </div>
                  </div>
              </div>
          `;

          // 移除現有的 modal
          const existingModal = document.getElementById('universalModal');
          if (existingModal) {
              existingModal.remove();
          }

          // 添加新的 modal
          document.body.insertAdjacentHTML('beforeend', modalHTML);

          // 綁定確認按鈕事件
          if (onConfirm && showConfirm) {
              document.getElementById('confirmBtn').addEventListener('click', onConfirm);
          }

          // 顯示 modal
          const modal = new bootstrap.Modal(document.getElementById('universalModal'));
          modal.show();
      }

      function showToast(message, type = 'info') {
          const toastContainer = document.getElementById('toast-container') || createToastContainer();
          const toastId = 'toast-' + Date.now();
          
          const bgClass = {
              'success': 'bg-success',
              'error': 'bg-danger',
              'warning': 'bg-warning',
              'info': 'bg-info'
          }[type] || 'bg-info';

          const toastHTML = `
              <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                  <div class="d-flex">
                      <div class="toast-body">
                          ${message}
                      </div>
                      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                  </div>
              </div>
          `;

          toastContainer.insertAdjacentHTML('beforeend', toastHTML);
          
          const toastElement = document.getElementById(toastId);
          const toast = new bootstrap.Toast(toastElement);
          toast.show();

          // 自動移除 toast 元素
          toastElement.addEventListener('hidden.bs.toast', () => {
              toastElement.remove();
          });
      }

      function createToastContainer() {
          const container = document.createElement('div');
          container.id = 'toast-container';
          container.className = 'toast-container position-fixed top-0 end-0 p-3';
          container.style.zIndex = '9999';
          document.body.appendChild(container);
          return container;
      }

      function validateForm(form) {
          const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
          let isValid = true;

          inputs.forEach(input => {
              if (!input.value.trim()) {
                  input.classList.add('is-invalid');
                  isValid = false;
              } else {
                  input.classList.remove('is-invalid');
              }
          });

          if (!isValid) {
              showToast('請填寫所有必填欄位', 'error');
          }

          return isValid;
      }

      // 搜尋功能
      function initializeSearch() {
          document.addEventListener('input', function(e) {
              if (e.target.classList.contains('search-input')) {
                  const searchTerm = e.target.value.toLowerCase();
                  const targetTable = document.querySelector(e.target.dataset.target);
                  
                  if (targetTable) {
                      const rows = targetTable.querySelectorAll('tbody tr');
                      rows.forEach(row => {
                          const text = row.textContent.toLowerCase();
                          row.style.display = text.includes(searchTerm) ? '' : 'none';
                      });
                  }
              }
          });
      }

      // 表格排序功能
      function initializeTableSort() {
          document.addEventListener('click', function(e) {
              if (e.target.hasAttribute('data-sort')) {
                  const table = e.target.closest('table');
                  const tbody = table.querySelector('tbody');
                  const rows = Array.from(tbody.querySelectorAll('tr'));
                  const column = e.target.dataset.sort;
                  const columnIndex = Array.from(e.target.parentNode.children).indexOf(e.target);
                  
                  // 切換排序方向
                  const isAsc = e.target.classList.contains('sort-asc');
                  
                  // 清除其他列的排序標記
                  table.querySelectorAll('th[data-sort]').forEach(th => {
                      th.classList.remove('sort-asc', 'sort-desc');
                  });
                  
                  // 設置當前列的排序標記
                  e.target.classList.add(isAsc ? 'sort-desc' : 'sort-asc');
                  
                  // 排序行
                  rows.sort((a, b) => {
                      const aVal = a.children[columnIndex].textContent.trim();
                      const bVal = b.children[columnIndex].textContent.trim();
                      
                      // 嘗試數字排序
                      const aNum = parseFloat(aVal.replace(/[^0-9.-]/g, ''));
                      const bNum = parseFloat(bVal.replace(/[^0-9.-]/g, ''));
                      
                      if (!isNaN(aNum) && !isNaN(bNum)) {
                          return isAsc ? bNum - aNum : aNum - bNum;
                      } else {
                          return isAsc ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
                      }
                  });
                  
                  // 重新插入排序後的行
                  rows.forEach(row => tbody.appendChild(row));
              }
          });
      }

      // 匯出功能
      function exportToExcel(data, filename) {
          const ws = XLSX.utils.json_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
          XLSX.writeFile(wb, filename + '.xlsx');
      }

      function exportToCSV(data, filename) {
          const csv = data.map(row => Object.values(row).join(',')).join('\n');
          const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = filename + '.csv';
          link.click();
      }

      // 篩選功能
      function filterTable(table, column, value) {
          const rows = table.querySelectorAll('tbody tr');
          rows.forEach(row => {
              const cellValue = row.querySelector(`td:nth-child(${column})`);
              if (cellValue) {
                  const text = cellValue.textContent.toLowerCase();
                  row.style.display = !value || text.includes(value.toLowerCase()) ? '' : 'none';
              }
          });
      }

      // 批次操作
      function selectAllItems(checkboxSelector) {
          const checkboxes = document.querySelectorAll(checkboxSelector);
          const selectAllCheckbox = document.getElementById('selectAllCheckbox');
          
          checkboxes.forEach(checkbox => {
              checkbox.checked = selectAllCheckbox.checked;
          });
      }

      function getSelectedItems(checkboxSelector) {
          const checkboxes = document.querySelectorAll(checkboxSelector + ':checked');
          return Array.from(checkboxes).map(cb => parseInt(cb.value));
      }

      // 貨幣格式化輸入
      function initializeCurrencyInputs() {
          document.addEventListener('input', function(e) {
              if (e.target.classList.contains('currency-input')) {
                  let value = e.target.value.replace(/[^0-9]/g, '');
                  if (value) {
                      e.target.value = parseInt(value);
                  }
              }
          });
      }

      // 日期範圍選擇器
      function initializeDateRangePicker() {
          const dateInputs = document.querySelectorAll('input[type="date"]');
          dateInputs.forEach(input => {
              if (!input.value) {
                  input.value = new Date().toISOString().split('T')[0];
              }
          });
      }

      // 自動儲存功能
      function enableAutoSave() {
          let autoSaveTimer;
          
          document.addEventListener('input', function(e) {
              if (e.target.form && e.target.form.dataset.autosave === 'true') {
                  clearTimeout(autoSaveTimer);
                  autoSaveTimer = setTimeout(() => {
                      saveFormData(e.target.form);
                  }, 2000);
              }
          });
      }

      function saveFormData(form) {
          const formData = new FormData(form);
          const data = Object.fromEntries(formData);
          localStorage.setItem('autosave_' + form.id, JSON.stringify(data));
          showToast('資料已自動儲存', 'info');
      }

      function loadFormData(form) {
          const savedData = localStorage.getItem('autosave_' + form.id);
          if (savedData) {
              const data = JSON.parse(savedData);
              Object.keys(data).forEach(key => {
                  const input = form.querySelector(`[name="${key}"]`);
                  if (input) {
                      input.value = data[key];
                  }
              });
          }
      }

      // 鍵盤快捷鍵
      function initializeKeyboardShortcuts() {
          document.addEventListener('keydown', function(e) {
              // Ctrl + S 儲存
              if (e.ctrlKey && e.key === 's') {
                  e.preventDefault();
                  const activeForm = document.querySelector('form:focus-within');
                  if (activeForm) {
                      const submitBtn = activeForm.querySelector('button[type="submit"], .btn-primary');
                      if (submitBtn) {
                          submitBtn.click();
                      }
                  }
              }
              
              // Ctrl + N 新增
              if (e.ctrlKey && e.key === 'n') {
                  e.preventDefault();
                  const addBtn = document.querySelector('.btn-primary[onclick*="Add"], .btn-primary[onclick*="show"]');
                  if (addBtn) {
                      addBtn.click();
                  }
              }
              
              // ESC 關閉 Modal
              if (e.key === 'Escape') {
                  const modal = document.querySelector('.modal.show');
                  if (modal) {
                      const closeBtn = modal.querySelector('.btn-close, .btn-secondary');
                      if (closeBtn) {
                          closeBtn.click();
                      }
                  }
              }
          });
      }

      // 響應式表格
      function initializeResponsiveTables() {
          const tables = document.querySelectorAll('.table-responsive table');
          tables.forEach(table => {
              const wrapper = table.parentElement;
              
              // 添加滾動指示器
              const scrollIndicator = document.createElement('div');
              scrollIndicator.className = 'scroll-indicator';
              scrollIndicator.innerHTML = '<i class="fas fa-arrow-right"></i> 可左右滾動查看更多';
              wrapper.appendChild(scrollIndicator);
              
              wrapper.addEventListener('scroll', function() {
                  const isScrollable = wrapper.scrollWidth > wrapper.clientWidth;
                  const isAtEnd = wrapper.scrollLeft >= (wrapper.scrollWidth - wrapper.clientWidth - 10);
                  
                  scrollIndicator.style.display = isScrollable && !isAtEnd ? 'block' : 'none';
              });
          });
      }

      // 資料驗證
      function validateFinancialData(data) {
          const errors = [];
          
          if (!data.amount || data.amount <= 0) {
              errors.push('金額必須大於 0');
          }
          
          if (!data.date) {
              errors.push('日期為必填項目');
          } else {
              const date = new Date(data.date);
              const now = new Date();
              if (date > now) {
                  errors.push('日期不能是未來日期');
              }
          }
          
          if (!data.description || data.description.trim().length < 2) {
              errors.push('說明至少需要 2 個字元');
          }
          
          return errors;
      }

      // 備份和還原
      function backupData() {
          const backup = {
              version: '1.0.0',
              timestamp: new Date().toISOString(),
              data: systemData
          };
          
          const dataStr = JSON.stringify(backup, null, 2);
          const blob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          
          const link = document.createElement('a');
          link.href = url;
          link.download = `財務系統備份_${new Date().toISOString().split('T')[0]}.json`;
          link.click();
          
          URL.revokeObjectURL(url);
          showToast('資料備份完成', 'success');
      }

      function restoreData(file) {
          const reader = new FileReader();
          reader.onload = function(e) {
              try {
                  const backup = JSON.parse(e.target.result);
                  
                  if (backup.version && backup.data) {
                      if (confirm('確定要還原備份資料嗎？這將覆蓋現有資料。')) {
                          systemData = backup.data;
                          showToast('資料還原完成', 'success');
                          loadDashboard(); // 重新載入介面
                      }
                  } else {
                      showToast('備份檔案格式不正確', 'error');
                  }
              } catch (error) {
                  showToast('備份檔案解析失敗', 'error');
              }
          };
          reader.readAsText(file);
      }

      // 系統初始化
      function initializeSystem() {
          // 初始化各種功能
          initializeSearch();
          initializeTableSort();
          initializeCurrencyInputs();
          initializeDateRangePicker();
          enableAutoSave();
          initializeKeyboardShortcuts();
          initializeResponsiveTables();
          
          // 載入儀表板
          loadDashboard();
          
          // 顯示歡迎訊息
          showToast('財務管理系統已啟動', 'success');
          
          console.log('財務管理系統初始化完成');
      }

      // 頁面載入完成後初始化
      $(document).ready(function() {
          initializeSystem();
      });

      // 全域錯誤處理
      window.addEventListener('error', function(e) {
          console.error('系統錯誤:', e.error);
          showToast('系統發生錯誤，請重新整理頁面', 'error');
      });

      // 離開頁面前的確認
      window.addEventListener('beforeunload', function(e) {
          const hasUnsavedChanges = document.querySelector('.is-invalid') || 
                                  document.querySelector('form[data-changed="true"]');
          
          if (hasUnsavedChanges) {
              e.preventDefault();
              e.returnValue = '您有未儲存的變更，確定要離開嗎？';
              return e.returnValue;
          }
      });

      // 服務工作者註冊（PWA 支援）
      if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
              navigator.serviceWorker.register('/sw.js')
                  .then(function(registration) {
                      console.log('ServiceWorker 註冊成功:', registration.scope);
                  })
                  .catch(function(error) {
                      console.log('ServiceWorker 註冊失敗:', error);
                  });
          });
      }

      // 匯出所有功能供外部使用
      window.FinancialSystem = {
          // 資料
          data: systemData,
          
          // 核心功能
          loadDashboard,
          loadMembers,
          loadIncome,
          loadExpenses,
          loadAccounts,
          loadBankAccounts,
          loadReceipts,
          loadReports,
          loadSettings,
          
          // 工具函數
          formatCurrency,
          formatDate,
          showModal,
          showToast,
          validateForm,
          backupData,
          restoreData,
          
          // 初始化
          initialize: initializeSystem
      };

      console.log('財務管理系統載入完成');
  </script>

  <!-- Service Worker for PWA -->
  <script>
      // Service Worker 內容
      const SW_CONTENT = `
          const CACHE_NAME = 'financial-system-v1.0.0';
          const urlsToCache = [
              '/',
              '/css/bootstrap.min.css',
              '/js/bootstrap.bundle.min.js',
              '/js/jquery.min.js',
              '/js/chart.js',
              '/js/xlsx.full.min.js'
          ];

          self.addEventListener('install', function(event) {
              event.waitUntil(
                  caches.open(CACHE_NAME)
                      .then(function(cache) {
                          return cache.addAll(urlsToCache);
                      })
              );
          });

          self.addEventListener('fetch', function(event) {
              event.respondWith(
                  caches.match(event.request)
                      .then(function(response) {
                          if (response) {
                              return response;
                          }
                          return fetch(event.request);
                      }
                  )
              );
          });
      `;

      // 動態創建 Service Worker
      if ('serviceWorker' in navigator) {
          const blob = new Blob([SW_CONTENT], { type: 'application/javascript' });
          const swUrl = URL.createObjectURL(blob);
          
          navigator.serviceWorker.register(swUrl)
              .then(registration => console.log('SW registered'))
              .catch(error => console.log('SW registration failed'));
      }
  </script>

  <!-- PWA Manifest -->
  <script>
      const manifest = {
          "name": "財務管理系統",
          "short_name": "財務系統",
          "description": "完整的財務管理解決方案",
          "start_url": "/",
          "display": "standalone",
          "background_color": "#ffffff",
          "theme_color": "#007bff",
          "icons": [
              {
                  "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMwMDdiZmYiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01aDNWOGg0djRoM2wtNSA1eiIvPgo8L3N2Zz4KPC9zdmc+",
                  "sizes": "192x192",
                  "type": "image/svg+xml"
              }
          ]
      };

      const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
      const manifestUrl = URL.createObjectURL(manifestBlob);
      
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = manifestUrl;
      document.head.appendChild(link);
  </script>
</body>
</html>
