<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣帕金森病友權益促進會 - 財務會計系統</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #17a2b8;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            margin: 0;
            padding: 0;
        }

        /* 側邊欄樣式 */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            transform: translateX(-250px);
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: bold;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .sidebar-menu li {
            margin: 0;
        }

        .sidebar-menu a {
            display: block;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background-color: rgba(255,255,255,0.1);
            border-left-color: white;
            padding-left: 25px;
        }

        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* 主要內容區域 */
        .main-content {
            margin-left: 0;
            padding: 20px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }

        .main-content.sidebar-open {
            margin-left: 250px;
        }

        /* 頂部導航 */
        .top-navbar {
            background: white;
            padding: 15px 20px;
            margin: -20px -20px 20px -20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--primary-color);
            cursor: pointer;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 卡片樣式 */
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
        }

        .card-header h5 {
            margin: 0;
            font-weight: 600;
        }

        /* 統計卡片 */
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #666;
            font-size: 0.9rem;
        }

        .stat-card.income {
            border-left: 4px solid var(--success-color);
        }

        .stat-card.expense {
            border-left: 4px solid var(--danger-color);
        }

        .stat-card.member {
            border-left: 4px solid var(--info-color);
        }

        .stat-card.balance {
            border-left: 4px solid var(--warning-color);
        }

        /* 表格樣式 */
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }

        .table {
            margin: 0;
        }

        .table th {
            background-color: var(--light-color);
            border: none;
            font-weight: 600;
            color: var(--dark-color);
        }

        .table td {
            border: none;
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background-color: rgba(44, 90, 160, 0.05);
        }

        /* 按鈕樣式 */
        .btn {
            border-radius: 6px;
            font-weight: 500;
            padding: 8px 16px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #1e3d6f;
            border-color: #1e3d6f;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.875rem;
        }

        /* 表單樣式 */
        .form-control {
            border-radius: 6px;
            border: 1px solid #ddd;
            padding: 10px 12px;
            transition: border-color 0.2s ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25);
        }

        .form-label {
            font-weight: 500;
            color: var(--dark-color);
            margin-bottom: 8px;
        }

        /* 模態框樣式 */
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .modal-content {
            border-radius: 10px;
            border: none;
        }

        /* 載入動畫 */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 提示訊息 */
        .alert {
            border-radius: 8px;
            border: none;
            padding: 12px 16px;
            margin-bottom: 20px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                transform: translateX(-100%);
            }

            .main-content.sidebar-open {
                margin-left: 0;
            }

            .top-navbar {
                margin: -20px -20px 20px -20px;
            }

            .stat-card {
                margin-bottom: 15px;
            }
        }

        /* 頁面特定樣式 */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .search-bar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* 圖表容器 */
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-container canvas {
            max-height: 400px;
        }

        /* 狀態標籤 */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background-color: #d4edda;
            color: #155724;
        }

        /* 金額顯示 */
        .amount-positive {
            color: var(--success-color);
            font-weight: bold;
        }

        .amount-negative {
            color: var(--danger-color);
            font-weight: bold;
        }

        .amount-neutral {
            color: var(--dark-color);
            font-weight: bold;
        }

        /* 分頁樣式 */
        .pagination {
            justify-content: center;
            margin-top: 20px;
        }

        .page-link {
            color: var(--primary-color);
            border-color: #dee2e6;
        }

        .page-link:hover {
            color: #1e3d6f;
            background-color: #e9ecef;
            border-color: #dee2e6;
        }

        .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- 載入動畫 -->
    <div class="loading" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- 側邊欄 -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4>財務會計系統</h4>
            <small>台灣帕金森病友權益促進會</small>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" data-page="dashboard" class="active"><i class="fas fa-tachometer-alt"></i> 儀表板</a></li>
            <li><a href="#" data-page="members"><i class="fas fa-users"></i> 會員管理</a></li>
            <li><a href="#" data-page="income"><i class="fas fa-arrow-up"></i> 收入管理</a></li>
            <li><a href="#" data-page="expenses"><i class="fas fa-arrow-down"></i> 支出管理</a></li>
            <li><a href="#" data-page="receipts"><i class="fas fa-receipt"></i> 電子收據</a></li>
            <li><a href="#" data-page="accounts"><i class="fas fa-list"></i> 會計科目</a></li>
            <li><a href="#" data-page="bank-accounts"><i class="fas fa-university"></i> 銀行帳戶</a></li>
            <li><a href="#" data-page="reports"><i class="fas fa-chart-bar"></i> 報表分析</a></li>
            <li><a href="#" data-page="settings"><i class="fas fa-cog"></i> 系統設定</a></li>
        </ul>
    </nav>

    <!-- 主要內容區域 -->
    <div class="main-content" id="mainContent">
        <!-- 頂部導航 -->
        <div class="top-navbar">
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="user-info">
                <span>管理員</span>
                <i class="fas fa-user-circle fa-lg"></i>
            </div>
        </div>

        <!-- 儀表板頁面 -->
        <div class="page-content active" id="dashboard-page">
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card member">
                        <div class="icon">
                            <i class="fas fa-users text-info"></i>
                        </div>
                        <div class="number" id="totalMembers">0</div>
                        <div class="label">總會員數</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card income">
                        <div class="icon">
                            <i class="fas fa-arrow-up text-success"></i>
                        </div>
                        <div class="number" id="monthlyIncome">$0</div>
                        <div class="label">本月收入</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card expense">
                        <div class="icon">
                            <i class="fas fa-arrow-down text-danger"></i>
                        </div>
                        <div class="number" id="monthlyExpenses">$0</div>
                        <div class="label">本月支出</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card balance">
                        <div class="icon">
                            <i class="fas fa-wallet text-warning"></i>
                        </div>
                        <div class="number" id="totalBalance">$0</div>
                        <div class="label">帳戶餘額</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="chart-container">
                        <h5>收支趨勢圖</h5>
                        <canvas id="incomeExpenseChart"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>最近交易</h5>
                        </div>
                        <div class="card-body">
                            <div id="recentTransactions">
                                <p class="text-muted">載入中...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 會員管理頁面 -->
        <div class="page-content" id="members-page">
            <div class="search-bar">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="memberSearch" placeholder="搜尋會員姓名、電話...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="memberStatusFilter">
                            <option value="">所有狀態</option>
                            <option value="正常">正常</option>
                            <option value="停權">停權</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="searchMembers()">
                            <i class="fas fa-search"></i> 搜尋
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success" onclick="showAddMemberModal()">
                            <i class="fas fa-plus"></i> 新增會員
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5>會員列表</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>會員編號</th>
                                    <th>姓名</th>
                                    <th>電話</th>
                                    <th>電子郵件</th>
                                    <th>會員狀態</th>
                                    <th>加入日期</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="membersTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">載入中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <nav>
                        <ul class="pagination" id="membersPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- 收入管理頁面 -->
        <div class="page-content" id="income-page">
            <div class="search-bar">
                <div class="row">
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="incomeStartDate">
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="incomeEndDate">
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="incomeAccountFilter">
                            <option value="">所有科目</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="searchIncome()">
                            <i class="fas fa-search"></i> 搜尋
                        </button>
                        <button class="btn btn-success" onclick="showAddIncomeModal()">
                            <i class="fas fa-plus"></i> 新增收入
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5>收入記錄</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>會計科目</th>
                                    <th>金額</th>
                                    <th>付款人</th>
                                    <th>付款方式</th>
                                    <th>收據編號</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="incomeTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">載入中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <nav>
                        <ul class="pagination" id="incomePagination"></ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- 支出管理頁面 -->
        <div class="page-content" id="expenses-page">
            <div class="search-bar">
                <div class="row">
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="expenseStartDate">
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="expenseEndDate">
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="expenseStatusFilter">
                            <option value="">所有狀態</option>
                            <option value="待審核">待審核</option>
                            <option value="已核准">已核准</option>
                            <option value="已拒絕">已拒絕</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="searchExpenses()">
                            <i class="fas fa-search"></i> 搜尋
                        </button>
                        <button class="btn btn-success" onclick="showAddExpenseModal()">
                            <i class="fas fa-plus"></i> 新增支出
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5>支出記錄</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>會計科目</th>
                                    <th>金額</th>
                                    <th>收款人</th>
                                    <th>付款方式</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="expensesTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">載入中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <nav>
                        <ul class="pagination" id="expensesPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- 電子收據頁面 -->
        <div class="page-content" id="receipts-page">
            <div class="search-bar">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="receiptSearch" placeholder="搜尋收據編號...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="receiptStatusFilter">
                            <option value="">所有狀態</option>
                            <option value="已開立">已開立</option>
                            <option value="已發送">已發送</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="searchReceipts()">
                            <i class="fas fa-search"></i> 搜尋
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-info" onclick="batchSendReceipts()">
                            <i class="fas fa-envelope"></i> 批量發送
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5>電子收據列表</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllReceipts"></th>
                                    <th>收據編號</th>
                                    <th>金額</th>
                                    <th>開立日期</th>
                                    <th>收據狀態</th>
                                    <th>郵件狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="receiptsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">載入中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <nav>
                        <ul class="pagination" id="receiptsPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- 會計科目頁面 -->
        <div class="page-content" id="accounts-page">
            <div class="action-buttons">
                <button class="btn btn-success" onclick="showAddAccountModal()">
                    <i class="fas fa-plus"></i> 新增科目
                </button>
                <button class="btn btn-info" onclick="importAccounts()">
                    <i class="fas fa-upload"></i> 匯入科目
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5>會計科目樹狀結構</h5>
                </div>
                <div class="card-body">
                    <div id="accountsTree">
                        <p class="text-muted">載入中...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 銀行帳戶頁面 -->
        <div class="page-content" id="bank-accounts-page">
            <div class="action-buttons">
                <button class="btn btn-success" onclick="showAddBankAccountModal()">
                    <i class="fas fa-plus"></i> 新增帳戶
                </button>
                <button class="btn btn-warning" onclick="reconcileAccounts()">
                    <i class="fas fa-balance-scale"></i> 帳戶對帳
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5>銀行帳戶列表</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>帳戶名稱</th>
                                    <th>銀行名稱</th>
                                    <th>帳戶類型</th>
                                    <th>目前餘額</th>
                                    <th>幣別</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="bankAccountsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">載入中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 報表分析頁面 -->
        <div class="page-content" id="reports-page">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                            <h6>財務報表</h6>
                            <button class="btn btn-primary btn-sm" onclick="generateFinancialReport()">
                                產生報表
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-balance-scale fa-2x text-success mb-2"></i>
                            <h6>資產負債表</h6>
                            <button class="btn btn-success btn-sm" onclick="generateBalanceSheet()">
                                產生報表
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-hand-holding-usd fa-2x text-info mb-2"></i>
                            <h6>現金流量表</h6>
                            <button class="btn btn-info btn-sm" onclick="generateCashFlowReport()">
                                產生報表
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-heart fa-2x text-danger mb-2"></i>
                            <h6>捐款報表</h6>
                            <button class="btn btn-danger btn-sm" onclick="generateDonationReport()">
                                產生報表
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5>報表內容</h5>
                </div>
                <div class="card-body">
                    <div id="reportContent">
                        <p class="text-muted text-center">請選擇上方的報表類型來產生報表</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系統設定頁面 -->
        <div class="page-content" id="settings-page">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>組織基本資訊</h5>
                        </div>
                        <div class="card-body">
                            <form id="organizationForm">
                                <div class="mb-3">
                                    <label class="form-label">組織名稱</label>
                                    <input type="text" class="form-control" id="orgName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">組織地址</label>
                                    <textarea class="form-control" id="orgAddress" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">聯絡電話</label>
                                    <input type="tel" class="form-control" id="orgPhone">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">電子郵件</label>
                                    <input type="email" class="form-control" id="orgEmail">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">統一編號</label>
                                    <input type="text" class="form-control" id="orgTaxId">
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> 儲存設定
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>系統管理</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-info" onclick="createBackup()">
                                    <i class="fas fa-download"></i> 建立系統備份
                                </button>
                                <button class="btn btn-warning" onclick="cleanupSystem()">
                                    <i class="fas fa-broom"></i> 清理系統資料
                                </button>
                                <button class="btn btn-secondary" onclick="checkSystemHealth()">
                                    <i class="fas fa-heartbeat"></i> 系統健康檢查
                                </button>
                                <button class="btn btn-danger" onclick="resetSystem()">
                                    <i class="fas fa-redo"></i> 重置系統設定
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h5>系統狀態</h5>
                        </div>
                        <div class="card-body">
                            <div id="systemStatus">
                                <p class="text-muted">載入中...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增會員模態框 -->
    <div class="modal fade" id="addMemberModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增會員</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addMemberForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">姓名 *</label>
                                    <input type="text" class="form-control" name="姓名" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">電話 *</label>
                                    <input type="tel" class="form-control" name="電話" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">電子郵件</label>
                                    <input type="email" class="form-control" name="電子郵件">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">出生日期</label>
                                    <input type="date" class="form-control" name="出生日期">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">性別</label>
                                    <select class="form-control" name="性別">
                                        <option value="">請選擇</option>
                                        <option value="男">男</option>
                                        <option value="女">女</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">會員類型</label>
                                    <select class="form-control" name="會員類型">
                                        <option value="一般會員">一般會員</option>
                                        <option value="贊助會員">贊助會員</option>
                                        <option value="榮譽會員">榮譽會員</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">地址</label>
                            <textarea class="form-control" name="地址" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">緊急聯絡人</label>
                                    <input type="text" class="form-control" name="緊急聯絡人">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">緊急聯絡電話</label>
                                    <input type="tel" class="form-control" name="緊急聯絡電話">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">加入日期 *</label>
                            <input type="date" class="form-control" name="加入日期" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">備註</label>
                            <textarea class="form-control" name="備註" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addMember()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增收入模態框 -->
    <div class="modal fade" id="addIncomeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增收入記錄</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addIncomeForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">日期 *</label>
                                    <input type="date" class="form-control" name="日期" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">金額 *</label>
                                    <input type="number" class="form-control" name="金額" min="0" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">會計科目 *</label>
                                    <select class="form-control" name="會計科目" id="incomeAccountSelect" required>
                                        <option value="">請選擇會計科目</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">子科目</label>
                                    <input type="text" class="form-control" name="子科目">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">付款人 *</label>
                                    <input type="text" class="form-control" name="付款人" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">付款方式</label>
                                    <select class="form-control" name="付款方式">
                                        <option value="現金">現金</option>
                                        <option value="支票">支票</option>
                                        <option value="銀行轉帳">銀行轉帳</option>
                                        <option value="信用卡">信用卡</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">銀行帳戶</label>
                                    <select class="form-control" name="銀行帳戶" id="incomeBankAccountSelect">
                                        <option value="">請選擇銀行帳戶</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">會員</label>
                                    <select class="form-control" name="會員ID" id="incomeMemberSelect">
                                        <option value="">請選擇會員</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">說明</label>
                            <textarea class="form-control" name="說明" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="自動生成收據" id="autoGenerateReceipt" checked>
                                <label class="form-check-label" for="autoGenerateReceipt">
                                    自動生成電子收據
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addIncome()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增支出模態框 -->
    <div class="modal fade" id="addExpenseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增支出記錄</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addExpenseForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">日期 *</label>
                                    <input type="date" class="form-control" name="日期" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">金額 *</label>
                                    <input type="number" class="form-control" name="金額" min="0" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">會計科目 *</label>
                                    <select class="form-control" name="會計科目" id="expenseAccountSelect" required>
                                        <option value="">請選擇會計科目</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">子科目</label>
                                    <input type="text" class="form-control" name="子科目">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">收款人 *</label>
                                    <input type="text" class="form-control" name="收款人" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">付款方式</label>
                                    <select class="form-control" name="付款方式">
                                        <option value="現金">現金</option>
                                        <option value="支票">支票</option>
                                        <option value="銀行轉帳">銀行轉帳</option>
                                        <option value="信用卡">信用卡</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">銀行帳戶</label>
                                    <select class="form-control" name="銀行帳戶" id="expenseBankAccountSelect">
                                        <option value="">請選擇銀行帳戶</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">核准人</label>
                                    <input type="text" class="form-control" name="核准人">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">說明</label>
                            <textarea class="form-control" name="說明" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addExpense()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增銀行帳戶模態框 -->
    <div class="modal fade" id="addBankAccountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增銀行帳戶</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addBankAccountForm">
                        <div class="mb-3">
                            <label class="form-label">帳戶名稱 *</label>
                            <input type="text" class="form-control" name="帳戶名稱" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">銀行名稱 *</label>
                            <input type="text" class="form-control" name="銀行名稱" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">帳號 *</label>
                            <input type="text" class="form-control" name="帳號" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">帳戶類型 *</label>
                            <select class="form-control" name="帳戶類型" required>
                                <option value="">請選擇</option>
                                <option value="支票帳戶">支票帳戶</option>
                                <option value="儲蓄帳戶">儲蓄帳戶</option>
                                <option value="定期存款">定期存款</option>
                                <option value="外幣帳戶">外幣帳戶</option>
                                <option value="專案帳戶">專案帳戶</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">初始餘額</label>
                            <input type="number" class="form-control" name="目前餘額" min="0" step="0.01" value="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">幣別</label>
                            <select class="form-control" name="幣別">
                                <option value="TWD">新台幣 (TWD)</option>
                                <option value="USD">美元 (USD)</option>
                                <option value="EUR">歐元 (EUR)</option>
                                <option value="JPY">日圓 (JPY)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">說明</label>
                            <textarea class="form-control" name="說明" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="是否啟用" id="bankAccountEnabled" checked>
                                <label class="form-check-label" for="bankAccountEnabled">
                                    啟用此帳戶
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addBankAccount()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // 全域變數
        let currentPage = 'dashboard';
        let currentUser = null;
        let systemSettings = {};
        let chartInstances = {};

        // API 基礎 URL (需要替換為實際的 Google Apps Script URL)
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbzTqUPWP7laCUJmb4eSQUQSWnm3-K045hzJSRNysqeVSDio-EOtJV1oT_jxxt_3maJn/exec';

        // 初始化應用程式
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // 應用程式初始化
        async function initializeApp() {
            try {
                showLoading(true);
                
                // 設定事件監聽器
                setupEventListeners();
                
                // 載入系統設定
                await loadSystemSettings();
                
                // 載入儀表板資料
                await loadDashboardData();
                
                // 初始化圖表
                initializeCharts();
                
                showLoading(false);
            } catch (error) {
                console.error('應用程式初始化失敗:', error);
                showAlert('系統初始化失敗，請重新整理頁面', 'danger');
                showLoading(false);
            }
        }

        // 設定事件監聽器
        function setupEventListeners() {
            // 選單切換
            document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
            
            // 側邊欄選單點擊
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    if (page) {
                        switchPage(page);
                    }
                });
            });

            // 表單提交事件
            document.getElementById('organizationForm').addEventListener('submit', saveOrganizationInfo);
            
            // 搜尋事件
            document.getElementById('memberSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchMembers();
                }
            });

            // 日期設定預設值
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (input.name === '日期' || input.name === '加入日期') {
                    input.value = today;
                }
            });
        }

        // 切換側邊欄
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('sidebar-open');
        }

        // 頁面切換
        function switchPage(pageName) {
            // 隱藏所有頁面
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // 顯示目標頁面
            const targetPage = document.getElementById(pageName + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // 更新選單狀態
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
            
            currentPage = pageName;
            
            // 載入頁面資料
            loadPageData(pageName);
            
            // 在手機版本上關閉側邊欄
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        // 載入頁面資料
        async function loadPageData(pageName) {
            try {
                showLoading(true);
                
                switch (pageName) {
                    case 'dashboard':
                        await loadDashboardData();
                        break;
                    case 'members':
                        await loadMembersData();
                        break;
                    case 'income':
                        await loadIncomeData();
                        await loadAccountOptions('incomeAccountFilter');
                        break;
                    case 'expenses':
                        await loadExpensesData();
                        break;
                    case 'receipts':
                        await loadReceiptsData();
                        break;
                    case 'accounts':
                        await loadAccountsTree();
                        break;
                    case 'bank-accounts':
                        await loadBankAccountsData();
                        break;
                    case 'reports':
                        // 報表頁面按需載入
                        break;
                    case 'settings':
                        await loadSystemSettings();
                        await loadSystemStatus();
                        break;
                }
                
                showLoading(false);
            } catch (error) {
                console.error('載入頁面資料失敗:', error);
                showAlert('載入資料失敗', 'danger');
                showLoading(false);
            }
        }

        // API 呼叫函數
        async function apiCall(action, data = {}) {
            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        data: data
                    })
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API呼叫錯誤:', error);
                throw new Error('網路連線錯誤');
            }
        }

        // 載入儀表板資料
        async function loadDashboardData() {
            try {
                // 載入統計資料
                const [membersResult, incomeResult, expensesResult, bankResult] = await Promise.all([
                    apiCall('getMembers'),
                    apiCall('getIncomeStatistics', { month: new Date().toISOString().slice(0, 7) }),
                    apiCall('getExpensesStatistics', { month: new Date().toISOString().slice(0, 7) }),
                    apiCall('getBankAccounts', { enabled: true })
                ]);

                // 更新統計卡片
                if (membersResult.success) {
                    document.getElementById('totalMembers').textContent = membersResult.data.length;
                }
                
                if (incomeResult.success) {
                    document.getElementById('monthlyIncome').textContent = 
                        formatCurrency(incomeResult.data.totalAmount);
                }
                
                if (expensesResult.success) {
                    document.getElementById('monthlyExpenses').textContent = 
                        formatCurrency(expensesResult.data.totalAmount);
                }
                
                if (bankResult.success) {
                    const totalBalance = bankResult.data.reduce((sum, account) => 
                        sum + (parseFloat(account['目前餘額']) || 0), 0);
                    document.getElementById('totalBalance').textContent = formatCurrency(totalBalance);
                }

                // 載入最近交易
                await loadRecentTransactions();
                
                // 更新收支趨勢圖
                await updateIncomeExpenseChart();
                
            } catch (error) {
                console.error('載入儀表板資料錯誤:', error);
            }
        }

        // 載入最近交易
        async function loadRecentTransactions() {
            try {
                const incomeResult = await apiCall('getIncome', { limit: 5 });
                const expensesResult = await apiCall('getExpenses', { limit: 5 });
                
                const container = document.getElementById('recentTransactions');
                let html = '';
                
                if (incomeResult.success && incomeResult.data.length > 0) {
                    html += '<h6 class="text-success">最近收入</h6>';
                    incomeResult.data.slice(0, 3).forEach(item => {
                        html += `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <small class="text-muted">${formatDate(item['日期'])}</small><br>
                                    <span>${item['付款人']}</span>
                                </div>
                                <span class="text-success">+${formatCurrency(item['金額'])}</span>
                            </div>
                        `;
                    });
                }
                
                if (expensesResult.success && expensesResult.data.length > 0) {
                    html += '<h6 class="text-danger mt-3">最近支出</h6>';
                    expensesResult.data.slice(0, 3).forEach(item => {
                        html += `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <small class="text-muted">${formatDate(item['日期'])}</small><br>
                                    <span>${item['收款人']}</span>
                                </div>
                                <span class="text-danger">-${formatCurrency(item['金額'])}</span>
                            </div>
                        `;
                    });
                }
                
                container.innerHTML = html || '<p class="text-muted">暫無交易記錄</p>';
                
            } catch (error) {
                console.error('載入最近交易錯誤:', error);
            }
        }

        // 載入會員資料
        async function loadMembersData(page = 1) {
            try {
                const result = await apiCall('getMembers', { page: page, limit: 10 });
                
                if (result.success) {
                    displayMembersTable(result.data);
                    updatePagination('membersPagination', result.pagination, loadMembersData);
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                console.error('載入會員資料錯誤:', error);
                showAlert('載入會員資料失敗', 'danger');
            }
        }

        // 顯示會員表格
        function displayMembersTable(members) {
            const tbody = document.getElementById('membersTableBody');
            
            if (members.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">暫無資料</td></tr>';
                return;
            }
            
            let html = '';
            members.forEach(member => {
                html += `
                    <tr>
                        <td>${member['會員編號'] || ''}</td>
                        <td>${member['姓名']}</td>
                        <td>${member['電話']}</td>
                        <td>${member['電子郵件'] || ''}</td>
                        <td>
                            <span class="status-badge ${member['會員狀態'] === '正常' ? 'status-active' : 'status-inactive'}">
                                ${member['會員狀態'] || '正常'}
                            </span>
                        </td>
                        <td>${formatDate(member['加入日期'])}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editMember('${member['ID']}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMember('${member['ID']}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // 載入收入資料
        async function loadIncomeData(page = 1) {
            try {
                const result = await apiCall('getIncome', { page: page, limit: 10 });
                
                if (result.success) {
                    displayIncomeTable(result.data);
                    updatePagination('incomePagination', result.pagination, loadIncomeData);
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                console.error('載入收入資料錯誤:', error);
                showAlert('載入收入資料失敗', 'danger');
            }
        }

        // 顯示收入表格
        function displayIncomeTable(income) {
            const tbody = document.getElementById('incomeTableBody');
            
            if (income.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">暫無資料</td></tr>';
                return;
            }
            
            let html = '';
            income.forEach(item => {
                html += `
                    <tr>
                        <td>${formatDate(item['日期'])}</td>
                        <td>${item['會計科目']}</td>
                        <td class="amount-positive">${formatCurrency(item['金額'])}</td>
                        <td>${item['付款人']}</td>
                        <td>${item['付款方式'] || '現金'}</td>
                        <td>${item['收據編號'] || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editIncome('${item['ID']}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteIncome('${item['ID']}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // 載入支出資料
        async function loadExpensesData(page = 1) {
            try {
                const result = await apiCall('getExpenses', { page: page, limit: 10 });
                
                if (result.success) {
                    displayExpensesTable(result.data);
                    updatePagination('expensesPagination', result.pagination, loadExpensesData);
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                console.error('載入支出資料錯誤:', error);
                showAlert('載入支出資料失敗', 'danger');
            }
        }

        // 顯示支出表格
        function displayExpensesTable(expenses) {
            const tbody = document.getElementById('expensesTableBody');
            
            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">暫無資料</td></tr>';
                return;
            }
            
            let html = '';
            expenses.forEach(item => {
                const statusClass = item['狀態'] === '已核准' ? 'status-approved' : 
                                  item['狀態'] === '待審核' ? 'status-pending' : 'status-inactive';
                
                html += `
                    <tr>
                        <td>${formatDate(item['日期'])}</td>
                        <td>${item['會計科目']}</td>
                        <td class="amount-negative">${formatCurrency(item['金額'])}</td>
                        <td>${item['收款人']}</td>
                        <td>${item['付款方式'] || '現金'}</td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                ${item['狀態'] || '待審核'}
                            </span>
                        </td>
                        <td>
                            ${item['狀態'] === '待審核' ? 
                                `<button class="btn btn-sm btn-outline-success" onclick="approveExpense('${item['ID']}')">
                                    <i class="fas fa-check"></i>
                                </button>` : ''
                            }
                            <button class="btn btn-sm btn-outline-primary" onclick="editExpense('${item['ID']}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteExpense('${item['ID']}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // 載入銀行帳戶資料
        async function loadBankAccountsData() {
            try {
                const result = await apiCall('getBankAccounts');
                
                if (result.success) {
                    displayBankAccountsTable(result.data);
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                console.error('載入銀行帳戶資料錯誤:', error);
                showAlert('載入銀行帳戶資料失敗', 'danger');
            }
        }

        // 顯示銀行帳戶表格
        function displayBankAccountsTable(accounts) {
            const tbody = document.getElementById('bankAccountsTableBody');
            
            if (accounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">暫無資料</td></tr>';
                return;
            }
            
            let html = '';
            accounts.forEach(account => {
                html += `
                    <tr>
                        <td>${account['帳戶名稱']}</td>
                        <td>${account['銀行名稱']}</td>
                        <td>${account['帳戶類型']}</td>
                        <td class="amount-neutral">${formatCurrency(account['目前餘額'])}</td>
                        <td>${account['幣別'] || 'TWD'}</td>
                        <td>
                            <span class="status-badge ${account['是否啟用'] ? 'status-active' : 'status-inactive'}">
                                ${account['是否啟用'] ? '啟用' : '停用'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-warning" onclick="toggleBankAccountStatus('${account['ID']}')">
                                <i class="fas fa-power-off"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="editBankAccount('${account['ID']}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteBankAccount('${account['ID']}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // 載入會計科目選項
        async function loadAccountOptions(selectId) {
            try {
                const result = await apiCall('getAccounts', { enabled: true });
                
                if (result.success) {
                    const select = document.getElementById(selectId);
                    if (select) {
                        let html = '<option value="">請選擇會計科目</option>';
                        result.data.forEach(account => {
                            html += `<option value="${account['ID']}">${account['科目代碼']} - ${account['科目名稱']}</option>`;
                        });
                        select.innerHTML = html;
                    }
                }
            } catch (error) {
                console.error('載入會計科目選項錯誤:', error);
            }
        }

        // 載入銀行帳戶選項
        async function loadBankAccountOptions(selectId) {
            try {
                const result = await apiCall('getBankAccountOptions');
                
                if (result.success) {
                    const select = document.getElementById(selectId);
                    if (select) {
                        let html = '<option value="">請選擇銀行帳戶</option>';
                        result.data.forEach(account => {
                            html += `<option value="${account.value}">${account.label}</option>`;
                        });
                        select.innerHTML = html;
                    }
                }
            } catch (error) {
                console.error('載入銀行帳戶選項錯誤:', error);
            }
        }

        // 載入會員選項
        async function loadMemberOptions(selectId) {
            try {
                const result = await apiCall('getMembers', { status: '正常' });
                
                if (result.success) {
                    const select = document.getElementById(selectId);
                    if (select) {
                        let html = '<option value="">請選擇會員</option>';
                        result.data.forEach(member => {
                            html += `<option value="${member['ID']}">${member['姓名']} (${member['電話']})</option>`;
                        });
                        select.innerHTML = html;
                    }
                }
            } catch (error) {
                console.error('載入會員選項錯誤:', error);
            }
        }

        // 新增會員
        async function addMember() {
            try {
                const form = document.getElementById('addMemberForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                showLoading(true);
                const result = await apiCall('addMember', data);
                showLoading(false);
                
                if (result.success) {
                    showAlert('會員新增成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addMemberModal')).hide();
                    form.reset();
                    if (currentPage === 'members') {
                        await loadMembersData();
                    }
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('新增會員錯誤:', error);
                showAlert('新增會員失敗', 'danger');
            }
        }

        // 新增收入
        async function addIncome() {
            try {
                const form = document.getElementById('addIncomeForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                // 處理checkbox
                data['自動生成收據'] = document.getElementById('autoGenerateReceipt').checked;
                
                showLoading(true);
                const result = await apiCall('addIncome', data);
                showLoading(false);
                
                if (result.success) {
                    showAlert('收入記錄新增成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addIncomeModal')).hide();
                    form.reset();
                    if (currentPage === 'income') {
                        await loadIncomeData();
                    }
                    // 更新儀表板
                    if (currentPage === 'dashboard') {
                        await loadDashboardData();
                    }
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('新增收入錯誤:', error);
                showAlert('新增收入失敗', 'danger');
            }
        }

        // 新增支出
        async function addExpense() {
            try {
                const form = document.getElementById('addExpenseForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                showLoading(true);
                const result = await apiCall('addExpense', data);
                showLoading(false);
                
                if (result.success) {
                    showAlert('支出記錄新增成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addExpenseModal')).hide();
                    form.reset();
                    if (currentPage === 'expenses') {
                        await loadExpensesData();
                    }
                    // 更新儀表板
                    if (currentPage === 'dashboard') {
                        await loadDashboardData();
                    }
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('新增支出錯誤:', error);
                showAlert('新增支出失敗', 'danger');
            }
        }

        // 新增銀行帳戶
        async function addBankAccount() {
            try {
                const form = document.getElementById('addBankAccountForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                // 處理checkbox
                data['是否啟用'] = document.getElementById('bankAccountEnabled').checked;
                
                showLoading(true);
                const result = await apiCall('addBankAccount', data);
                showLoading(false);
                
                if (result.success) {
                    showAlert('銀行帳戶新增成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addBankAccountModal')).hide();
                    form.reset();
                    if (currentPage === 'bank-accounts') {
                        await loadBankAccountsData();
                    }
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('新增銀行帳戶錯誤:', error);
                showAlert('新增銀行帳戶失敗', 'danger');
            }
        }

        // 核准支出
        async function approveExpense(expenseId) {
            if (!confirm('確定要核准這筆支出嗎？')) {
                return;
            }
            
            try {
                showLoading(true);
                const result = await apiCall('approveExpense', { id: expenseId, approver: '管理員' });
                showLoading(false);
                
                if (result.success) {
                    showAlert('支出已核准', 'success');
                    await loadExpensesData();
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('核准支出錯誤:', error);
                showAlert('核准支出失敗', 'danger');
            }
        }

        // 搜尋功能
        async function searchMembers() {
            const search = document.getElementById('memberSearch').value;
            const status = document.getElementById('memberStatusFilter').value;
            
            try {
                showLoading(true);
                const result = await apiCall('getMembers', { search: search, status: status });
                showLoading(false);
                
                if (result.success) {
                    displayMembersTable(result.data);
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('搜尋會員錯誤:', error);
                showAlert('搜尋失敗', 'danger');
            }
        }

        async function searchIncome() {
            const startDate = document.getElementById('incomeStartDate').value;
            const endDate = document.getElementById('incomeEndDate').value;
            const accountId = document.getElementById('incomeAccountFilter').value;
            
            try {
                showLoading(true);
                const result = await apiCall('getIncome', { 
                    startDate: startDate, 
                    endDate: endDate, 
                    accountId: accountId 
                });
                showLoading(false);
                
                if (result.success) {
                    displayIncomeTable(result.data);
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('搜尋收入錯誤:', error);
                showAlert('搜尋失敗', 'danger');
            }
        }

        async function searchExpenses() {
            const startDate = document.getElementById('expenseStartDate').value;
            const endDate = document.getElementById('expenseEndDate').value;
            const status = document.getElementById('expenseStatusFilter').value;
            
            try {
                showLoading(true);
                const result = await apiCall('getExpenses', { 
                    startDate: startDate, 
                    endDate: endDate, 
                    status: status 
                });
                showLoading(false);
                
                if (result.success) {
                    displayExpensesTable(result.data);
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('搜尋支出錯誤:', error);
                showAlert('搜尋失敗', 'danger');
            }
        }

        // 顯示模態框
        function showAddMemberModal() {
            const modal = new bootstrap.Modal(document.getElementById('addMemberModal'));
            modal.show();
        }

        function showAddIncomeModal() {
            // 載入選項
            loadAccountOptions('incomeAccountSelect');
            loadBankAccountOptions('incomeBankAccountSelect');
            loadMemberOptions('incomeMemberSelect');
            
            const modal = new bootstrap.Modal(document.getElementById('addIncomeModal'));
            modal.show();
        }

        function showAddExpenseModal() {
            // 載入選項
            loadAccountOptions('expenseAccountSelect');
            loadBankAccountOptions('expenseBankAccountSelect');
            
            const modal = new bootstrap.Modal(document.getElementById('addExpenseModal'));
            modal.show();
        }

        function showAddBankAccountModal() {
            const modal = new bootstrap.Modal(document.getElementById('addBankAccountModal'));
            modal.show();
        }

        // 工具函數
        function formatCurrency(amount) {
            if (isNaN(amount)) return 'NT$ 0';
            return 'NT$ ' + parseFloat(amount).toLocaleString('zh-TW');
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW');
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        function showAlert(message, type = 'info') {
            // 移除現有的提示
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // 建立新的提示
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // 插入到主要內容區域的頂部
            const mainContent = document.getElementById('mainContent');
            mainContent.insertBefore(alert, mainContent.firstChild.nextSibling);
            
            // 自動消失
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        function updatePagination(containerId, pagination, loadFunction) {
            const container = document.getElementById(containerId);
            if (!container || !pagination) return;
            
            let html = '';
            
            // 上一頁
            if (pagination.hasPreviousPage) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="${loadFunction.name}(${pagination.currentPage - 1})">上一頁</a>
                </li>`;
            }
            
            // 頁碼
            for (let i = 1; i <= pagination.totalPages; i++) {
                if (i === pagination.currentPage) {
                    html += `<li class="page-item active">
                        <span class="page-link">${i}</span>
                    </li>`;
                } else {
                    html += `<li class="page-item">
                        <a class="page-link" href="#" onclick="${loadFunction.name}(${i})">${i}</a>
                    </li>`;
                }
            }
            
            // 下一頁
            if (pagination.hasNextPage) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="${loadFunction.name}(${pagination.currentPage + 1})">下一頁</a>
                </li>`;
            }
            
            container.innerHTML = html;
        }

        // 初始化圖表
        function initializeCharts() {
            // 收支趨勢圖
            const ctx = document.getElementById('incomeExpenseChart');
            if (ctx) {
                chartInstances.incomeExpenseChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '收入',
                            data: [],
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4
                        }, {
                            label: '支出',
                            data: [],
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'NT$ ' + value.toLocaleString();
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });
            }
        }

        // 更新收支趨勢圖
        async function updateIncomeExpenseChart() {
            try {
                const currentYear = new Date().getFullYear();
                const months = [];
                const incomeData = [];
                const expenseData = [];
                
                for (let i = 0; i < 12; i++) {
                    const month = String(i + 1).padStart(2, '0');
                    months.push(`${month}月`);
                    
                    const startDate = `${currentYear}-${month}-01`;
                    const endDate = `${currentYear}-${month}-${new Date(currentYear, i + 1, 0).getDate()}`;
                    
                    const [incomeResult, expenseResult] = await Promise.all([
                        apiCall('getIncomeStatistics', { startDate, endDate }),
                        apiCall('getExpensesStatistics', { startDate, endDate })
                    ]);
                    
                    incomeData.push(incomeResult.success ? incomeResult.data.totalAmount : 0);
                    expenseData.push(expenseResult.success ? expenseResult.data.totalAmount : 0);
                }
                
                if (chartInstances.incomeExpenseChart) {
                    chartInstances.incomeExpenseChart.data.labels = months;
                    chartInstances.incomeExpenseChart.data.datasets[0].data = incomeData;
                    chartInstances.incomeExpenseChart.data.datasets[1].data = expenseData;
                    chartInstances.incomeExpenseChart.update();
                }
            } catch (error) {
                console.error('更新收支趨勢圖錯誤:', error);
            }
        }

        // 載入系統設定
        async function loadSystemSettings() {
            try {
                const result = await apiCall('getOrganizationInfo');
                
                if (result.success) {
                    const data = result.data;
                    document.getElementById('orgName').value = data.name || '';
                    document.getElementById('orgAddress').value = data.address || '';
                    document.getElementById('orgPhone').value = data.phone || '';
                    document.getElementById('orgEmail').value = data.email || '';
                    document.getElementById('orgTaxId').value = data.taxId || '';
                }
            } catch (error) {
                console.error('載入系統設定錯誤:', error);
            }
        }

        // 儲存組織資訊
        async function saveOrganizationInfo(event) {
            event.preventDefault();
            
            try {
                const formData = new FormData(event.target);
                const data = {
                    name: formData.get('orgName'),
                    address: formData.get('orgAddress'),
                    phone: formData.get('orgPhone'),
                    email: formData.get('orgEmail'),
                    taxId: formData.get('orgTaxId')
                };
                
                showLoading(true);
                const result = await apiCall('updateOrganizationInfo', data);
                showLoading(false);
                
                if (result.success) {
                    showAlert('組織資訊更新成功', 'success');
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('儲存組織資訊錯誤:', error);
                showAlert('儲存失敗', 'danger');
            }
        }

        // 載入系統狀態
        async function loadSystemStatus() {
            try {
                const result = await apiCall('getSystemStatus');
                
                if (result.success) {
                    const status = result.data;
                    const container = document.getElementById('systemStatus');
                    
                    let html = `
                        <div class="row">
                            <div class="col-6">
                                <strong>系統版本：</strong><br>
                                <span class="text-muted">${status.systemVersion}</span>
                            </div>
                            <div class="col-6">
                                <strong>運行狀態：</strong><br>
                                <span class="badge bg-success">${status.status === 'running' ? '正常運行' : '異常'}</span>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <strong>會員數量：</strong><br>
                                <span class="text-muted">${status.dataStats['會員資料'] || 0} 人</span>
                            </div>
                            <div class="col-6">
                                <strong>收入記錄：</strong><br>
                                <span class="text-muted">${status.dataStats['收入記錄'] || 0} 筆</span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6">
                                <strong>支出記錄：</strong><br>
                                <span class="text-muted">${status.dataStats['支出記錄'] || 0} 筆</span>
                            </div>
                            <div class="col-6">
                                <strong>銀行帳戶：</strong><br>
                                <span class="text-muted">${status.dataStats['帳戶管理'] || 0} 個</span>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <strong>儲存空間：</strong><br>
                                <span class="text-muted">${status.storage.formattedSize} (${status.storage.fileCount} 個檔案)</span>
                            </div>
                        </div>
                    `;
                    
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('載入系統狀態錯誤:', error);
            }
        }

        // 系統管理功能
        async function createBackup() {
            if (!confirm('確定要建立系統備份嗎？這可能需要幾分鐘時間。')) {
                return;
            }
            
            try {
                showLoading(true);
                const result = await apiCall('createBackup');
                showLoading(false);
                
                if (result.success) {
                    showAlert('系統備份建立成功', 'success');
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('建立備份錯誤:', error);
                showAlert('建立備份失敗', 'danger');
            }
        }

        async function cleanupSystem() {
            if (!confirm('確定要清理系統資料嗎？這將移除過期的檔案和空白記錄。')) {
                return;
            }
            
            try {
                showLoading(true);
                const result = await apiCall('cleanupSystem', {
                    options: {
                        cleanEmptyRecords: true,
                        cleanReceipts: false,
                        cleanDuplicates: false
                    }
                });
                showLoading(false);
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    await loadSystemStatus();
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('清理系統錯誤:', error);
                showAlert('清理系統失敗', 'danger');
            }
        }

        async function checkSystemHealth() {
            try {
                showLoading(true);
                const result = await apiCall('getSystemStatus');
                showLoading(false);
                
                if (result.success) {
                    const status = result.data.overall;
                    const alertType = status === 'healthy' ? 'success' : 
                                     status === 'warning' ? 'warning' : 'danger';
                    const message = status === 'healthy' ? '系統健康狀態良好' :
                                   status === 'warning' ? '系統有警告需要注意' : '系統有錯誤需要處理';
                    
                    showAlert(message, alertType);
                    await loadSystemStatus();
                } else {
                    showAlert('健康檢查失敗', 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('健康檢查錯誤:', error);
                showAlert('健康檢查失敗', 'danger');
            }
        }

        async function resetSystem() {
            if (!confirm('警告：這將重置所有系統設定為預設值，確定要繼續嗎？')) {
                return;
            }
            
            if (!confirm('最後確認：重置後所有自定義設定將遺失，您確定要繼續嗎？')) {
                return;
            }
            
            try {
                showLoading(true);
                const result = await apiCall('resetSettings');
                showLoading(false);
                
                if (result.success) {
                    showAlert('系統設定已重置', 'success');
                    await loadSystemSettings();
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('重置系統錯誤:', error);
                showAlert('重置系統失敗', 'danger');
            }
        }

        // 報表生成功能
        async function generateFinancialReport() {
            try {
                showLoading(true);
                const result = await apiCall('getFinancialReport', {
                    startDate: getFirstDayOfMonth(),
                    endDate: getLastDayOfMonth()
                });
                showLoading(false);
                
                if (result.success) {
                    displayFinancialReport(result.data);
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('生成財務報表錯誤:', error);
                showAlert('生成報表失敗', 'danger');
            }
        }

        function displayFinancialReport(data) {
            const container = document.getElementById('reportContent');
            
            let html = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h5 class="text-success">收入統計</h5>
                        <p class="h4 text-success">${formatCurrency(data.summary.totalIncome)}</p>
                    </div>
                    <div class="col-md-6">
                        <h5 class="text-danger">支出統計</h5>
                        <p class="h4 text-danger">${formatCurrency(data.summary.totalExpenses)}</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <h5>本期淨收入</h5>
                        <p class="h3 ${data.summary.netIncome >= 0 ? 'text-success' : 'text-danger'}">
                            ${formatCurrency(data.summary.netIncome)}
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6>收入明細</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>科目</th>
                                        <th class="text-end">金額</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            Object.entries(data.income.byAccount).forEach(([account, stats]) => {
                html += `
                    <tr>
                        <td>${account}</td>
                        <td class="text-end">${formatCurrency(stats.amount)}</td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>支出明細</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>科目</th>
                                        <th class="text-end">金額</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            Object.entries(data.expenses.byAccount).forEach(([account, stats]) => {
                html += `
                    <tr>
                        <td>${account}</td>
                        <td class="text-end">${formatCurrency(stats.amount)}</td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="exportReport('financial')">
                        <i class="fas fa-download"></i> 匯出報表
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // 工具函數
        function getFirstDayOfMonth() {
            const date = new Date();
            return new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
        }

        function getLastDayOfMonth() {
            const date = new Date();
            return new Date(date.getFullYear(), date.getMonth() + 1, 0).toISOString().split('T')[0];
        }

        // 刪除功能
        async function deleteMember(memberId) {
            if (!confirm('確定要刪除這個會員嗎？此操作無法復原。')) {
                return;
            }
            
            try {
                showLoading(true);
                const result = await apiCall('deleteMember', { id: memberId });
                showLoading(false);
                
                if (result.success) {
                    showAlert('會員刪除成功', 'success');
                    await loadMembersData();
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('刪除會員錯誤:', error);
                showAlert('刪除會員失敗', 'danger');
            }
        }

        async function deleteIncome(incomeId) {
            if (!confirm('確定要刪除這筆收入記錄嗎？此操作無法復原。')) {
                return;
            }
            
            try {
                showLoading(true);
                const result = await apiCall('deleteIncome', { id: incomeId });
                showLoading(false);
                
                if (result.success) {
                    showAlert('收入記錄刪除成功', 'success');
                    await loadIncomeData();
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('刪除收入錯誤:', error);
                showAlert('刪除收入失敗', 'danger');
            }
        }

        async function deleteExpense(expenseId) {
            if (!confirm('確定要刪除這筆支出記錄嗎？此操作無法復原。')) {
                return;
            }
            
            try {
                showLoading(true);
                const result = await apiCall('deleteExpense', { id: expenseId });
                showLoading(false);
                
                if (result.success) {
                    showAlert('支出記錄刪除成功', 'success');
                    await loadExpensesData();
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('刪除支出錯誤:', error);
                showAlert('刪除支出失敗', 'danger');
            }
        }

        async function deleteBankAccount(accountId) {
            if (!confirm('確定要刪除這個銀行帳戶嗎？此操作無法復原。')) {
                return;
            }
            
            try {
                showLoading(true);
                const result = await apiCall('deleteBankAccount', { id: accountId });
                showLoading(false);
                
                if (result.success) {
                    showAlert('銀行帳戶刪除成功', 'success');
                    await loadBankAccountsData();
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('刪除銀行帳戶錯誤:', error);
                showAlert('刪除銀行帳戶失敗', 'danger');
            }
        }

        // 切換銀行帳戶狀態
        async function toggleBankAccountStatus(accountId) {
            try {
                showLoading(true);
                const result = await apiCall('toggleBankAccountStatus', { id: accountId });
                showLoading(false);
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    await loadBankAccountsData();
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                showLoading(false);
                console.error('切換帳戶狀態錯誤:', error);
                showAlert('操作失敗', 'danger');
            }
        }

        // 編輯功能（簡化版，實際應用中需要完整的編輯表單）
        function editMember(memberId) {
            showAlert('編輯功能開發中', 'info');
        }

        function editIncome(incomeId) {
            showAlert('編輯功能開發中', 'info');
        }

        function editExpense(expenseId) {
            showAlert('編輯功能開發中', 'info');
        }

        function editBankAccount(accountId) {
            showAlert('編輯功能開發中', 'info');
        }

        // 其他功能
        function loadReceiptsData() {
            showAlert('電子收據功能開發中', 'info');
        }

        function loadAccountsTree() {
            showAlert('會計科目樹狀結構功能開發中', 'info');
        }

        function searchReceipts() {
            showAlert('搜尋收據功能開發中', 'info');
        }

        function batchSendReceipts() {
            showAlert('批量發送收據功能開發中', 'info');
        }

        function showAddAccountModal() {
            showAlert('新增會計科目功能開發中', 'info');
        }

        function importAccounts() {
            showAlert('匯入會計科目功能開發中', 'info');
        }

        function reconcileAccounts() {
            showAlert('帳戶對帳功能開發中', 'info');
        }

        function generateBalanceSheet() {
            showAlert('資產負債表功能開發中', 'info');
        }

        function generateCashFlowReport() {
            showAlert('現金流量表功能開發中', 'info');
        }

        function generateDonationReport() {
            showAlert('捐款報表功能開發中', 'info');
        }

        function exportReport(type) {
            showAlert('匯出報表功能開發中', 'info');
        }

        // 響應式處理
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('mainContent');
                
                if (sidebar.classList.contains('active')) {
                    mainContent.classList.add('sidebar-open');
                }
            }
        });

        // 防止表單重複提交
        document.addEventListener('submit', function(e) {
            const submitButton = e.target.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                setTimeout(() => {
                    submitButton.disabled = false;
                }, 3000);
            }
        });

        // 自動儲存草稿（可選功能）
        let autoSaveTimer;
        function enableAutoSave(formId) {
            const form = document.getElementById(formId);
            if (!form) return;
            
            const inputs = form.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(() => {
                        // 儲存草稿到localStorage
                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData.entries());
                        localStorage.setItem(`draft_${formId}`, JSON.stringify(data));
                    }, 2000);
                });
            });
        }

        // 載入草稿
        function loadDraft(formId) {
            const draft = localStorage.getItem(`draft_${formId}`);
            if (draft) {
                const data = JSON.parse(draft);
                const form = document.getElementById(formId);
                
                Object.entries(data).forEach(([key, value]) => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = value;
                    }
                });
            }
        }

        // 清除草稿
        function clearDraft(formId) {
            localStorage.removeItem(`draft_${formId}`);
        }

        // 鍵盤快捷鍵
        document.addEventListener('keydown', function(e) {
            // Ctrl+S 儲存
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                const activeForm = document.querySelector('.modal.show form');
                if (activeForm) {
                    const submitButton = activeForm.querySelector('button[onclick*="add"]');
                    if (submitButton) {
                        submitButton.click();
                    }
                }
            }
            
            // Esc 關閉模態框
            if (e.key === 'Escape') {
                const activeModal = document.querySelector('.modal.show');
                if (activeModal) {
                    const modal = bootstrap.Modal.getInstance(activeModal);
                    if (modal) {
                        modal.hide();
                    }
                }
            }
        });

        // 頁面可見性變化處理
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                // 頁面重新可見時，重新載入資料
                if (currentPage === 'dashboard') {
                    loadDashboardData();
                }
            }
        });

        // 網路狀態監控
        window.addEventListener('online', function() {
            showAlert('網路連線已恢復', 'success');
        });

        window.addEventListener('offline', function() {
            showAlert('網路連線中斷，部分功能可能無法使用', 'warning');
        });

        // 初始化完成提示
        console.log('台灣帕金森病友權益促進會財務會計系統前端已載入完成');
        console.log('請確認 API_BASE_URL 設定為正確的 Google Apps Script URL');
    </script>
</body>
</html>
                                    
