<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會 - 財務會計系統</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- DataTables -->
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  
  <style>
      :root {
          --primary-color: #2c5aa0;
          --secondary-color: #f8f9fa;
          --success-color: #28a745;
          --danger-color: #dc3545;
          --warning-color: #ffc107;
          --info-color: #17a2b8;
      }
      
      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          background-color: var(--secondary-color);
      }
      
      .navbar-brand {
          font-weight: bold;
          color: var(--primary-color) !important;
      }
      
      .sidebar {
          min-height: 100vh;
          background-color: var(--primary-color);
          box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      }
      
      .sidebar .nav-link {
          color: rgba(255,255,255,0.8);
          padding: 0.75rem 1rem;
          border-radius: 0.375rem;
          margin: 0.25rem 0;
          transition: all 0.3s ease;
      }
      
      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
          color: white;
          background-color: rgba(255,255,255,0.1);
          transform: translateX(5px);
      }
      
      .sidebar .nav-link i {
          margin-right: 0.5rem;
          width: 20px;
          text-align: center;
      }
      
      .main-content {
          background-color: white;
          min-height: 100vh;
          padding: 0;
      }
      
      .card {
          border: none;
          box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
          transition: box-shadow 0.15s ease-in-out;
      }
      
      .card:hover {
          box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
      }
      
      .card-header {
          background-color: var(--secondary-color);
          border-bottom: 1px solid rgba(0,0,0,0.125);
          font-weight: 600;
      }
      
      .btn-primary {
          background-color: var(--primary-color);
          border-color: var(--primary-color);
      }
      
      .btn-primary:hover {
          background-color: #1e4080;
          border-color: #1e4080;
      }
      
      .table th {
          background-color: var(--secondary-color);
          font-weight: 600;
          border-bottom: 2px solid #dee2e6;
      }
      
      .badge {
          font-size: 0.75em;
      }
      
      .spinner-border {
          width: 2rem;
          height: 2rem;
      }
      
      .toast-container {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 9999;
      }
      
      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9998;
      }
      
      .loading-content {
          background-color: white;
          padding: 2rem;
          border-radius: 0.5rem;
          text-align: center;
      }
      
      @media (max-width: 768px) {
          .sidebar {
              position: fixed;
              top: 0;
              left: -250px;
              width: 250px;
              height: 100vh;
              z-index: 1000;
              transition: left 0.3s ease;
          }
          
          .sidebar.show {
              left: 0;
          }
          
          .main-content {
              margin-left: 0;
          }
      }
  </style>
</head>
<body>
  <!-- 導航列 -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
      <div class="container-fluid">
          <button class="btn btn-outline-primary d-md-none" type="button" id="sidebarToggle">
              <i class="fas fa-bars"></i>
          </button>
          <a class="navbar-brand ms-2" href="#">
              <i class="fas fa-heart text-danger me-2"></i>
              台灣帕金森病友權益促進會
          </a>
          <div class="navbar-nav ms-auto">
              <div class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                      <i class="fas fa-user-circle"></i>
                      <span class="ms-1">系統管理員</span>
                  </a>
                  <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#" onclick="loadPage('settings')">
                          <i class="fas fa-cog me-2"></i>系統設定
                      </a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item" href="#" onclick="logout()">
                          <i class="fas fa-sign-out-alt me-2"></i>登出
                      </a></li>
                  </ul>
              </div>
          </div>
      </div>
  </nav>

  <div class="container-fluid">
      <div class="row">
          <!-- 側邊欄 -->
          <nav class="col-md-3 col-lg-2 sidebar" id="sidebar">
              <div class="position-sticky pt-3">
                  <ul class="nav flex-column">
                      <li class="nav-item">
                          <a class="nav-link active" href="#" data-page="dashboard">
                              <i class="fas fa-tachometer-alt"></i>
                              儀表板
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" data-page="members">
                              <i class="fas fa-users"></i>
                              會員管理
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" data-page="income">
                              <i class="fas fa-money-bill-wave"></i>
                              收入管理
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" data-page="expenses">
                              <i class="fas fa-money-bill-alt"></i>
                              支出管理
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" data-page="accounts">
                              <i class="fas fa-list-alt"></i>
                              會計科目
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" data-page="bank-accounts">
                              <i class="fas fa-university"></i>
                              銀行帳戶
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" data-page="receipts">
                              <i class="fas fa-receipt"></i>
                              電子收據
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" data-page="reports">
                              <i class="fas fa-chart-bar"></i>
                              財務報表
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" data-page="settings">
                              <i class="fas fa-cog"></i>
                              系統設定
                          </a>
                      </li>
                  </ul>
              </div>
          </nav>

          <!-- 主要內容區域 -->
          <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
              <div id="content-area" class="py-4">
                  <!-- 內容將由 JavaScript 動態載入 -->
              </div>
          </main>
      </div>
  </div>

  <!-- Toast 通知容器 -->
  <div class="toast-container"></div>

  <!-- 載入中覆蓋層 -->
  <div class="loading-overlay d-none" id="loadingOverlay">
      <div class="loading-content">
          <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">載入中...</span>
          </div>
          <div class="mt-3">載入中，請稍候...</div>
      </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <script>
      // 全域變數
      const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbzA4IRNq18rxE--VHXRDGdiRUzkzUXNn5G7cMlL-RfCsp4dmtHs9VX2Zeewngbx2Wa5/exec';
      let currentPage = 'dashboard';
      let dataTable = null;

      // 初始化
      $(document).ready(function() {
          initializeApp();
      });

      function initializeApp() {
          setupEventListeners();
          loadPage('dashboard');
      }

      function setupEventListeners() {
          // 側邊欄導航
          $('.sidebar .nav-link').on('click', function(e) {
              e.preventDefault();
              const page = $(this).data('page');
              if (page) {
                  loadPage(page);
                  $('.sidebar .nav-link').removeClass('active');
                  $(this).addClass('active');
              }
          });

          // 手機版側邊欄切換
          $('#sidebarToggle').on('click', function() {
              $('#sidebar').toggleClass('show');
          });

          // 點擊主內容區域時隱藏側邊欄（手機版）
          $('.main-content').on('click', function() {
              if (window.innerWidth < 768) {
                  $('#sidebar').removeClass('show');
              }
          });
      }

      function loadPage(page) {
          currentPage = page;
          showLoading();
          
          switch(page) {
              case 'dashboard':
                  loadDashboard();
                  break;
              case 'members':
                  loadMembers();
                  break;
              case 'income':
                  loadIncome();
                  break;
              case 'expenses':
                  loadExpenses();
                  break;
              case 'accounts':
                  loadAccounts();
                  break;
              case 'bank-accounts':
                  loadBankAccounts();
                  break;
              case 'receipts':
                  loadReceipts();
                  break;
              case 'reports':
                  loadReports();
                  break;
              case 'settings':
                  loadSettings();
                  break;
              default:
                  loadDashboard();
          }
      }

      // 儀表板
      function loadDashboard() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">儀表板</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="refreshDashboard()">
                              <i class="fas fa-sync-alt"></i> 重新整理
                          </button>
                      </div>
                  </div>
              </div>

              <!-- 統計卡片 -->
              <div class="row mb-4">
                  <div class="col-xl-3 col-md-6 mb-4">
                      <div class="card border-left-primary shadow h-100 py-2">
                          <div class="card-body">
                              <div class="row no-gutters align-items-center">
                                  <div class="col mr-2">
                                      <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                          本月收入</div>
                                      <div class="h5 mb-0 font-weight-bold text-gray-800" id="monthlyIncome">載入中...</div>
                                  </div>
                                  <div class="col-auto">
                                      <i class="fas fa-money-bill-wave fa-2x text-success"></i>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="col-xl-3 col-md-6 mb-4">
                      <div class="card border-left-success shadow h-100 py-2">
                          <div class="card-body">
                              <div class="row no-gutters align-items-center">
                                  <div class="col mr-2">
                                      <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                          本月支出</div>
                                      <div class="h5 mb-0 font-weight-bold text-gray-800" id="monthlyExpenses">載入中...</div>
                                  </div>
                                  <div class="col-auto">
                                      <i class="fas fa-money-bill-alt fa-2x text-danger"></i>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="col-xl-3 col-md-6 mb-4">
                      <div class="card border-left-info shadow h-100 py-2">
                          <div class="card-body">
                              <div class="row no-gutters align-items-center">
                                  <div class="col mr-2">
                                      <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                          會員總數</div>
                                      <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalMembers">載入中...</div>
                                  </div>
                                  <div class="col-auto">
                                      <i class="fas fa-users fa-2x text-info"></i>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="col-xl-3 col-md-6 mb-4">
                      <div class="card border-left-warning shadow h-100 py-2">
                          <div class="card-body">
                              <div class="row no-gutters align-items-center">
                                  <div class="col mr-2">
                                      <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                          銀行餘額</div>
                                      <div class="h5 mb-0 font-weight-bold text-gray-800" id="bankBalance">載入中...</div>
                                  </div>
                                  <div class="col-auto">
                                      <i class="fas fa-university fa-2x text-warning"></i>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 圖表區域 -->
              <div class="row">
                  <div class="col-lg-6 mb-4">
                      <div class="card shadow">
                          <div class="card-header py-3">
                              <h6 class="m-0 font-weight-bold text-primary">月度收支趨勢</h6>
                          </div>
                          <div class="card-body">
                              <canvas id="incomeExpenseChart"></canvas>
                          </div>
                      </div>
                  </div>

                  <div class="col-lg-6 mb-4">
                      <div class="card shadow">
                          <div class="card-header py-3">
                              <h6 class="m-0 font-weight-bold text-primary">收入來源分布</h6>
                          </div>
                          <div class="card-body">
                              <canvas id="incomeSourceChart"></canvas>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 最近活動 -->
              <div class="row">
                  <div class="col-lg-12">
                      <div class="card shadow mb-4">
                          <div class="card-header py-3">
                              <h6 class="m-0 font-weight-bold text-primary">最近交易記錄</h6>
                          </div>
                          <div class="card-body">
                              <div class="table-responsive">
                                  <table class="table table-bordered" id="recentTransactions">
                                      <thead>
                                          <tr>
                                              <th>日期</th>
                                              <th>類型</th>
                                              <th>金額</th>
                                              <th>說明</th>
                                              <th>狀態</th>
                                          </tr>
                                      </thead>
                                      <tbody>
                                          <!-- 資料將由 JavaScript 載入 -->
                                      </tbody>
                                  </table>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
          loadDashboardData();
          hideLoading();
      }

      function loadDashboardData() {
          // 載入統計資料
          Promise.all([
              apiRequest('getIncomeStatistics', { period: 'month', date: getCurrentMonth() }),
              apiRequest('getExpensesStatistics', { period: 'month', date: getCurrentMonth() }),
              apiRequest('getMembers', { page: 1, limit: 1 }),
              apiRequest('getBankAccounts', { enabled: true })
          ]).then(results => {
              const [incomeStats, expenseStats, membersData, bankAccounts] = results;

              // 更新統計卡片
              $('#monthlyIncome').text(formatCurrency(incomeStats.data?.totalAmount || 0));
              $('#monthlyExpenses').text(formatCurrency(expenseStats.data?.totalAmount || 0));
              $('#totalMembers').text((membersData.pagination?.total || 0).toLocaleString());
              
              const totalBalance = bankAccounts.data?.reduce((sum, account) => 
                  sum + (parseFloat(account['目前餘額']) || 0), 0) || 0;
              $('#bankBalance').text(formatCurrency(totalBalance));

              // 載入圖表
              loadIncomeExpenseChart();
              loadIncomeSourceChart();
              loadRecentTransactions();
          }).catch(error => {
              console.error('載入儀表板資料失敗:', error);
              showToast('載入儀表板資料失敗', 'error');
          });
      }

      function loadIncomeExpenseChart() {
          const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
          
          // 取得過去6個月的資料
          const months = [];
          const incomeData = [];
          const expenseData = [];
          
          for (let i = 5; i >= 0; i--) {
              const date = new Date();
              date.setMonth(date.getMonth() - i);
              const monthStr = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
              months.push(date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'short' }));
              
              // 這裡應該從 API 取得實際資料
              incomeData.push(Math.random() * 100000);
              expenseData.push(Math.random() * 80000);
          }

          new Chart(ctx, {
              type: 'line',
              data: {
                  labels: months,
                  datasets: [{
                      label: '收入',
                      data: incomeData,
                      borderColor: 'rgb(75, 192, 192)',
                      backgroundColor: 'rgba(75, 192, 192, 0.1)',
                      tension: 0.1
                  }, {
                      label: '支出',
                      data: expenseData,
                      borderColor: 'rgb(255, 99, 132)',
                      backgroundColor: 'rgba(255, 99, 132, 0.1)',
                      tension: 0.1
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      title: {
                          display: true,
                          text: '月度收支趨勢'
                      }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          ticks: {
                              callback: function(value) {
                                  return formatCurrency(value);
                              }
                          }
                      }
                  }
              }
          });
      }

      function loadIncomeSourceChart() {
          const ctx = document.getElementById('incomeSourceChart').getContext('2d');
          
          // 這裡應該從 API 取得實際資料
          const data = {
              labels: ['會費收入', '捐款收入', '活動收入', '其他收入'],
              datasets: [{
                  data: [40, 35, 20, 5],
                  backgroundColor: [
                      '#FF6384',
                      '#36A2EB',
                      '#FFCE56',
                      '#4BC0C0'
                  ]
              }]
          };

          new Chart(ctx, {
              type: 'doughnut',
              data: data,
              options: {
                  responsive: true,
                  plugins: {
                      title: {
                          display: true,
                          text: '收入來源分布'
                      },
                      legend: {
                          position: 'bottom'
                      }
                  }
              }
          });
      }

      function loadRecentTransactions() {
          // 載入最近的交易記錄
          Promise.all([
              apiRequest('getIncome', { page: 1, limit: 5 }),
              apiRequest('getExpenses', { page: 1, limit: 5 })
          ]).then(results => {
              const [incomeData, expenseData] = results;
              const transactions = [];

              // 合併收入和支出資料
              if (incomeData.data) {
                  incomeData.data.forEach(item => {
                      transactions.push({
                          date: item['日期'],
                          type: '收入',
                          amount: parseFloat(item['金額']) || 0,
                          description: item['說明'] || item['會計科目'] || '',
                          status: '已確認'
                      });
                  });
              }

              if (expenseData.data) {
                  expenseData.data.forEach(item => {
                      transactions.push({
                          date: item['日期'],
                          type: '支出',
                          amount: parseFloat(item['金額']) || 0,
                          description: item['說明'] || item['會計科目'] || '',
                          status: item['狀態'] || '未知'
                      });
                  });
              }

              // 按日期排序
              transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

              // 更新表格
              const tbody = $('#recentTransactions tbody');
              tbody.empty();

              transactions.slice(0, 10).forEach(transaction => {
                  const typeClass = transaction.type === '收入' ? 'text-success' : 'text-danger';
                  const statusClass = getStatusClass(transaction.status);
                  
                  tbody.append(`
                      <tr>
                          <td>${formatDate(transaction.date)}</td>
                          <td><span class="${typeClass}">${transaction.type}</span></td>
                          <td class="${typeClass}">${formatCurrency(transaction.amount)}</td>
                          <td>${transaction.description}</td>
                          <td><span class="badge ${statusClass}">${transaction.status}</span></td>
                      </tr>
                  `);
              });
          }).catch(error => {
              console.error('載入最近交易記錄失敗:', error);
          });
      }

      // 會員管理
      function loadMembers() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">會員管理</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-primary" onclick="showAddMemberModal()">
                              <i class="fas fa-plus"></i> 新增會員
                          </button>
                          <button type="button" class="btn btn-outline-secondary" onclick="exportMembers()">
                              <i class="fas fa-download"></i> 匯出
                          </button>
                      </div>
                  </div>
              </div>

              <!-- 搜尋和篩選 -->
              <div class="card mb-4">
                  <div class="card-body">
                      <div class="row">
                          <div class="col-md-4">
                              <label for="memberSearch" class="form-label">搜尋會員</label>
                              <input type="text" class="form-control" id="memberSearch" placeholder="姓名、電話或電子郵件">
                          </div>
                          <div class="col-md-3">
                              <label for="memberTypeFilter" class="form-label">會員類型</label>
                              <select class="form-select" id="memberTypeFilter">
                                  <option value="">全部</option>
                                  <option value="一般會員">一般會員</option>
                                  <option value="贊助會員">贊助會員</option>
                                  <option value="榮譽會員">榮譽會員</option>
                              </select>
                          </div>
                          <div class="col-md-3">
                              <label for="memberStatusFilter" class="form-label">會員狀態</label>
                              <select class="form-select" id="memberStatusFilter">
                                  <option value="">全部</option>
                                  <option value="正常">正常</option>
                                  <option value="到期">到期</option>
                                  <option value="停權">停權</option>
                              </select>
                          </div>
                          <div class="col-md-2 d-flex align-items-end">
                              <button type="button" class="btn btn-outline-primary w-100" onclick="searchMembers()">
                                  <i class="fas fa-search"></i> 搜尋
                              </button>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 會員列表 -->
              <div class="card">
                  <div class="card-header">
                      <h5 class="mb-0">會員列表</h5>
                  </div>
                  <div class="card-body">
                      <div class="table-responsive">
                          <table class="table table-hover" id="membersTable">
                              <thead>
                                  <tr>
                                      <th>會員編號</th>
                                      <th>姓名</th>
                                      <th>電話</th>
                                      <th>電子郵件</th>
                                      <th>會員類型</th>
                                      <th>會員狀態</th>
                                      <th>到期日期</th>
                                      <th>操作</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  <!-- 資料將由 JavaScript 載入 -->
                              </tbody>
                          </table>
                      </div>
                      
                      <!-- 分頁 -->
                      <nav aria-label="會員列表分頁">
                          <ul class="pagination justify-content-center" id="membersPagination">
                              <!-- 分頁將由 JavaScript 生成 -->
                          </ul>
                      </nav>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
          loadMembersData();
          hideLoading();
      }

      function loadMembersData(page = 1, search = '', type = '', status = '') {
          const params = {
              page: page,
              limit: 20,
              search: search,
              type: type,
              status: status
          };

          apiRequest('getMembers', params)
              .then(result => {
                  if (result.success) {
                      updateMembersTable(result.data, result.pagination);
                  } else {
                      showToast('載入會員資料失敗: ' + result.message, 'error');
                  }
              })
              .catch(error => {
                  console.error('載入會員資料失敗:', error);
                  showToast('載入會員資料失敗', 'error');
              });
      }

      function updateMembersTable(members, pagination) {
          const tbody = $('#membersTable tbody');
          tbody.empty();

          if (members.length === 0) {
              tbody.append(`
                  <tr>
                      <td colspan="8" class="text-center text-muted">沒有找到會員資料</td>
                  </tr>
              `);
              return;
          }

          members.forEach(member => {
              const statusClass = getStatusClass(member['會員狀態']);
              const expiryDate = member['到期日期'] ? formatDate(member['到期日期']) : '無期限';
              
              tbody.append(`
                  <tr>
                      <td>${member['會員編號'] || ''}</td>
                      <td>${member['姓名'] || ''}</td>
                      <td>${member['電話'] || ''}</td>
                      <td>${member['電子郵件'] || ''}</td>
                      <td>${member['會員類型'] || ''}</td>
                      <td><span class="badge ${statusClass}">${member['會員狀態'] || ''}</span></td>
                      <td>${expiryDate}</td>
                      <td>
                          <div class="btn-group btn-group-sm">
                              <button class="btn btn-outline-primary" onclick="editMember(${member.ID})" title="編輯">
                                  <i class="fas fa-edit"></i>
                              </button>
                              <button class="btn btn-outline-info" onclick="viewMember(${member.ID})" title="檢視">
                                  <i class="fas fa-eye"></i>
                              </button>
                              <button class="btn btn-outline-danger" onclick="deleteMember(${member.ID})" title="刪除">
                                  <i class="fas fa-trash"></i>
                              </button>
                          </div>
                      </td>
                  </tr>
              `);
          });

          // 更新分頁
          updatePagination('membersPagination', pagination, (page) => {
              const search = $('#memberSearch').val();
              const type = $('#memberTypeFilter').val();
              const status = $('#memberStatusFilter').val();
              loadMembersData(page, search, type, status);
          });
      }

      // 工具函數
      function apiRequest(action, data = {}) {
          return new Promise((resolve, reject) => {
              $.ajax({
                  url: API_BASE_URL,
                  method: 'POST',
                  data: {
                      action: action,
                      ...data
                  },
                  success: function(response) {
                      try {
                          const result = typeof response === 'string' ? JSON.parse(response) : response;
                          resolve(result);
                      } catch (e) {
                          reject(new Error('回應格式錯誤'));
                      }
                  },
                  error: function(xhr, status, error) {
                      reject(new Error('API 請求失敗: ' + error));
                  }
              });
          });
      }

      function showLoading() {
          $('#loadingOverlay').removeClass('d-none');
      }

      function hideLoading() {
          $('#loadingOverlay').addClass('d-none');
      }

      function showToast(message, type = 'info', duration = 5000) {
          const toastId = 'toast_' + Date.now();
          const bgClass = {
              'success': 'bg-success',
              'error': 'bg-danger',
              'warning': 'bg-warning',
              'info': 'bg-info'
          }[type] || 'bg-info';

          const toastHtml = `
              <div class="toast ${bgClass} text-white" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                  <div class="toast-header ${bgClass} text-white">
                      <strong class="me-auto">系統通知</strong>
                      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                  </div>
                  <div class="toast-body">
                      ${message}
                  </div>
              </div>
          `;

          $('.toast-container').append(toastHtml);
          const toast = new bootstrap.Toast(document.getElementById(toastId), {
              delay: duration
          });
          toast.show();

          // 自動移除 DOM 元素
          setTimeout(() => {
              $(`#${toastId}`).remove();
          }, duration + 1000);
      }

      function formatCurrency(amount) {
          return 'NT$ ' + parseFloat(amount).toLocaleString('zh-TW');
      }

      function formatDate(dateString) {
          if (!dateString) return '';
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW');
      }

      function getCurrentMonth() {
          const now = new Date();
          return now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
      }

      function getStatusClass(status) {
          const statusMap = {
              '正常': 'bg-success',
              '已確認': 'bg-success',
              '已核准': 'bg-success',
              '到期': 'bg-warning',
              '待審核': 'bg-warning',
              '停權': 'bg-danger',
              '已拒絕': 'bg-danger',
              '已取消': 'bg-secondary'
          };
          return statusMap[status] || 'bg-secondary';
      }

      function updatePagination(containerId, pagination, callback) {
          const container = $(`#${containerId}`);
          container.empty();

          if (!pagination || pagination.totalPages <= 1) {
              return;
          }

          const { currentPage, totalPages, hasNext, hasPrev } = pagination;

          // 上一頁
          if (hasPrev) {
              container.append(`
                  <li class="page-item">
                      <a class="page-link" href="#" onclick="event.preventDefault(); (${callback})(${currentPage - 1})">上一頁</a>
                  </li>
              `);
          }

          // 頁碼
          const startPage = Math.max(1, currentPage - 2);
          const endPage = Math.min(totalPages, currentPage + 2);

          for (let i = startPage; i <= endPage; i++) {
              const activeClass = i === currentPage ? 'active' : '';
              container.append(`
                  <li class="page-item ${activeClass}">
                      <a class="page-link" href="#" onclick="event.preventDefault(); (${callback})(${i})">${i}</a>
                  </li>
              `);
          }

          // 下一頁
          if (hasNext) {
              container.append(`
                  <li class="page-item">
                      <a class="page-link" href="#" onclick="event.preventDefault(); (${callback})(${currentPage + 1})">下一頁</a>
                  </li>
              `);
          }
        }

      // 收入管理
      function loadIncome() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">收入管理</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-primary" onclick="showAddIncomeModal()">
                              <i class="fas fa-plus"></i> 新增收入
                          </button>
                          <button type="button" class="btn btn-outline-secondary" onclick="exportIncome()">
                              <i class="fas fa-download"></i> 匯出
                          </button>
                      </div>
                  </div>
              </div>

              <div class="card mb-4">
                  <div class="card-body">
                      <div class="row">
                          <div class="col-md-3">
                              <label for="incomeStartDate" class="form-label">開始日期</label>
                              <input type="date" class="form-control" id="incomeStartDate">
                          </div>
                          <div class="col-md-3">
                              <label for="incomeEndDate" class="form-label">結束日期</label>
                              <input type="date" class="form-control" id="incomeEndDate">
                          </div>
                          <div class="col-md-3">
                              <label for="incomeAccountFilter" class="form-label">會計科目</label>
                              <select class="form-select" id="incomeAccountFilter">
                                  <option value="">全部</option>
                              </select>
                          </div>
                          <div class="col-md-3 d-flex align-items-end">
                              <button type="button" class="btn btn-outline-primary w-100" onclick="searchIncome()">
                                  <i class="fas fa-search"></i> 搜尋
                              </button>
                          </div>
                      </div>
                  </div>
              </div>

              <div class="card">
                  <div class="card-header">
                      <h5 class="mb-0">收入記錄</h5>
                  </div>
                  <div class="card-body">
                      <div class="table-responsive">
                          <table class="table table-hover" id="incomeTable">
                              <thead>
                                  <tr>
                                      <th>日期</th>
                                      <th>會計科目</th>
                                      <th>金額</th>
                                      <th>付款人</th>
                                      <th>付款方式</th>
                                      <th>說明</th>
                                      <th>操作</th>
                                  </tr>
                              </thead>
                              <tbody></tbody>
                          </table>
                      </div>
                      <nav aria-label="收入記錄分頁">
                          <ul class="pagination justify-content-center" id="incomePagination"></ul>
                      </nav>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
          loadIncomeAccounts();
          loadIncomeData();
          hideLoading();
      }

      // 支出管理
      function loadExpenses() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">支出管理</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-primary" onclick="showAddExpenseModal()">
                              <i class="fas fa-plus"></i> 新增支出
                          </button>
                          <button type="button" class="btn btn-outline-secondary" onclick="exportExpenses()">
                              <i class="fas fa-download"></i> 匯出
                          </button>
                      </div>
                  </div>
              </div>

              <div class="card mb-4">
                  <div class="card-body">
                      <div class="row">
                          <div class="col-md-2">
                              <label for="expenseStartDate" class="form-label">開始日期</label>
                              <input type="date" class="form-control" id="expenseStartDate">
                          </div>
                          <div class="col-md-2">
                              <label for="expenseEndDate" class="form-label">結束日期</label>
                              <input type="date" class="form-control" id="expenseEndDate">
                          </div>
                          <div class="col-md-2">
                              <label for="expenseAccountFilter" class="form-label">會計科目</label>
                              <select class="form-select" id="expenseAccountFilter">
                                  <option value="">全部</option>
                              </select>
                          </div>
                          <div class="col-md-2">
                              <label for="expenseStatusFilter" class="form-label">狀態</label>
                              <select class="form-select" id="expenseStatusFilter">
                                  <option value="">全部</option>
                                  <option value="待審核">待審核</option>
                                  <option value="已核准">已核准</option>
                                  <option value="已拒絕">已拒絕</option>
                              </select>
                          </div>
                          <div class="col-md-2 d-flex align-items-end">
                              <button type="button" class="btn btn-outline-primary w-100" onclick="searchExpenses()">
                                  <i class="fas fa-search"></i> 搜尋
                              </button>
                          </div>
                      </div>
                  </div>
              </div>

              <div class="card">
                  <div class="card-header">
                      <h5 class="mb-0">支出記錄</h5>
                  </div>
                  <div class="card-body">
                      <div class="table-responsive">
                          <table class="table table-hover" id="expensesTable">
                              <thead>
                                  <tr>
                                      <th>日期</th>
                                      <th>會計科目</th>
                                      <th>金額</th>
                                      <th>收款人</th>
                                      <th>付款方式</th>
                                      <th>狀態</th>
                                      <th>說明</th>
                                      <th>操作</th>
                                  </tr>
                              </thead>
                              <tbody></tbody>
                          </table>
                      </div>
                      <nav aria-label="支出記錄分頁">
                          <ul class="pagination justify-content-center" id="expensesPagination"></ul>
                      </nav>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
          loadExpenseAccounts();
          loadExpensesData();
          hideLoading();
      }

      // 會計科目管理
      function loadAccounts() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">會計科目管理</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-primary" onclick="showAddAccountModal()">
                              <i class="fas fa-plus"></i> 新增科目
                          </button>
                      </div>
                  </div>
              </div>

              <div class="row">
                  <div class="col-md-3">
                      <div class="card">
                          <div class="card-header">
                              <h6 class="mb-0">科目類型</h6>
                          </div>
                          <div class="card-body">
                              <div class="list-group list-group-flush">
                                  <a href="#" class="list-group-item list-group-item-action active" data-type="">
                                      全部科目
                                  </a>
                                  <a href="#" class="list-group-item list-group-item-action" data-type="資產">
                                      資產
                                  </a>
                                  <a href="#" class="list-group-item list-group-item-action" data-type="負債">
                                      負債
                                  </a>
                                  <a href="#" class="list-group-item list-group-item-action" data-type="權益">
                                      權益
                                  </a>
                                  <a href="#" class="list-group-item list-group-item-action" data-type="收入">
                                      收入
                                  </a>
                                  <a href="#" class="list-group-item list-group-item-action" data-type="支出">
                                      支出
                                  </a>
                              </div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-9">
                      <div class="card">
                          <div class="card-header">
                              <h5 class="mb-0">會計科目列表</h5>
                          </div>
                          <div class="card-body">
                              <div class="table-responsive">
                                  <table class="table table-hover" id="accountsTable">
                                      <thead>
                                          <tr>
                                              <th>科目代碼</th>
                                              <th>科目名稱</th>
                                              <th>科目類型</th>
                                              <th>上層科目</th>
                                              <th>狀態</th>
                                              <th>操作</th>
                                          </tr>
                                      </thead>
                                      <tbody></tbody>
                                  </table>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
          loadAccountsData();
          setupAccountTypeFilter();
          hideLoading();
      }

      // 銀行帳戶管理
      function loadBankAccounts() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">銀行帳戶管理</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-primary" onclick="showAddBankAccountModal()">
                              <i class="fas fa-plus"></i> 新增帳戶
                          </button>
                      </div>
                  </div>
              </div>

              <div class="row">
                  <div class="col-md-8">
                      <div class="card">
                          <div class="card-header">
                              <h5 class="mb-0">銀行帳戶列表</h5>
                          </div>
                          <div class="card-body">
                              <div class="table-responsive">
                                  <table class="table table-hover" id="bankAccountsTable">
                                      <thead>
                                          <tr>
                                              <th>帳戶名稱</th>
                                              <th>銀行名稱</th>
                                              <th>帳號</th>
                                              <th>目前餘額</th>
                                              <th>狀態</th>
                                              <th>操作</th>
                                          </tr>
                                      </thead>
                                      <tbody></tbody>
                                  </table>
                              </div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="card">
                          <div class="card-header">
                              <h6 class="mb-0">帳戶餘額總計</h6>
                          </div>
                          <div class="card-body">
                              <h3 class="text-primary" id="totalBalance">載入中...</h3>
                              <small class="text-muted">所有啟用帳戶的餘額總和</small>
                          </div>
                      </div>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
          loadBankAccountsData();
          hideLoading();
      }

      // 電子收據管理
      function loadReceipts() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">電子收據管理</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-primary" onclick="showGenerateReceiptModal()">
                              <i class="fas fa-plus"></i> 產生收據
                          </button>
                          <button type="button" class="btn btn-outline-secondary" onclick="batchSendReceipts()">
                              <i class="fas fa-paper-plane"></i> 批量發送
                          </button>
                      </div>
                  </div>
              </div>

              <div class="card mb-4">
                  <div class="card-body">
                      <div class="row">
                          <div class="col-md-3">
                              <label for="receiptStartDate" class="form-label">開始日期</label>
                              <input type="date" class="form-control" id="receiptStartDate">
                          </div>
                          <div class="col-md-3">
                              <label for="receiptEndDate" class="form-label">結束日期</label>
                              <input type="date" class="form-control" id="receiptEndDate">
                          </div>
                          <div class="col-md-3">
                              <label for="receiptStatusFilter" class="form-label">收據狀態</label>
                              <select class="form-select" id="receiptStatusFilter">
                                  <option value="">全部</option>
                                  <option value="已開立">已開立</option>
                                  <option value="已發送">已發送</option>
                              </select>
                          </div>
                          <div class="col-md-3 d-flex align-items-end">
                              <button type="button" class="btn btn-outline-primary w-100" onclick="searchReceipts()">
                                  <i class="fas fa-search"></i> 搜尋
                              </button>
                          </div>
                      </div>
                  </div>
              </div>

              <div class="card">
                  <div class="card-header">
                      <h5 class="mb-0">電子收據列表</h5>
                  </div>
                  <div class="card-body">
                      <div class="table-responsive">
                          <table class="table table-hover" id="receiptsTable">
                              <thead>
                                  <tr>
                                      <th>
                                          <input type="checkbox" id="selectAllReceipts" onchange="toggleAllReceipts()">
                                      </th>
                                      <th>收據編號</th>
                                      <th>開立日期</th>
                                      <th>付款人</th>
                                      <th>金額</th>
                                      <th>收據狀態</th>
                                      <th>郵件狀態</th>
                                      <th>操作</th>
                                  </tr>
                              </thead>
                              <tbody></tbody>
                          </table>
                      </div>
                      <nav aria-label="收據列表分頁">
                          <ul class="pagination justify-content-center" id="receiptsPagination"></ul>
                      </nav>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
          loadReceiptsData();
          hideLoading();
      }

      // 財務報表
      function loadReports() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">財務報表</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-outline-secondary" onclick="exportReport()">
                              <i class="fas fa-download"></i> 匯出報表
                          </button>
                      </div>
                  </div>
              </div>

              <!-- 報表類型選擇 -->
              <div class="row mb-4">
                  <div class="col-md-12">
                      <div class="card">
                          <div class="card-body">
                              <div class="row">
                                  <div class="col-md-3">
                                      <label for="reportType" class="form-label">報表類型</label>
                                      <select class="form-select" id="reportType" onchange="changeReportType()">
                                          <option value="financial">財務報表</option>
                                          <option value="balance">資產負債表</option>
                                          <option value="cashflow">現金流量表</option>
                                          <option value="donation">捐款報表</option>
                                      </select>
                                  </div>
                                  <div class="col-md-3">
                                      <label for="reportYear" class="form-label">年度</label>
                                      <select class="form-select" id="reportYear" onchange="generateReport()">
                                          <!-- 年度選項將由 JavaScript 生成 -->
                                      </select>
                                  </div>
                                  <div class="col-md-3">
                                      <label for="reportMonth" class="form-label">月份</label>
                                      <select class="form-select" id="reportMonth" onchange="generateReport()">
                                          <option value="">全年</option>
                                          <option value="1">1月</option>
                                          <option value="2">2月</option>
                                          <option value="3">3月</option>
                                          <option value="4">4月</option>
                                          <option value="5">5月</option>
                                          <option value="6">6月</option>
                                          <option value="7">7月</option>
                                          <option value="8">8月</option>
                                          <option value="9">9月</option>
                                          <option value="10">10月</option>
                                          <option value="11">11月</option>
                                          <option value="12">12月</option>
                                      </select>
                                  </div>
                                  <div class="col-md-3 d-flex align-items-end">
                                      <button type="button" class="btn btn-primary w-100" onclick="generateReport()">
                                          <i class="fas fa-chart-line"></i> 產生報表
                                      </button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 報表內容 -->
              <div id="reportContent">
                  <!-- 報表內容將由 JavaScript 動態載入 -->
              </div>
          `;

          $('#content-area').html(html);
          initializeReports();
          hideLoading();
      }

      // 系統設定
      function loadSettings() {
          const html = `
              <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">系統設定</h1>
                  <div class="btn-toolbar mb-2 mb-md-0">
                      <div class="btn-group me-2">
                          <button type="button" class="btn btn-outline-secondary" onclick="checkSystemHealth()">
                              <i class="fas fa-heartbeat"></i> 系統檢查
                          </button>
                          <button type="button" class="btn btn-outline-warning" onclick="createBackup()">
                              <i class="fas fa-save"></i> 建立備份
                          </button>
                      </div>
                  </div>
              </div>

              <div class="row">
                  <div class="col-md-8">
                      <!-- 組織資訊設定 -->
                      <div class="card mb-4">
                          <div class="card-header">
                              <h5 class="mb-0">組織資訊</h5>
                          </div>
                          <div class="card-body">
                              <form id="organizationForm">
                                  <div class="row">
                                      <div class="col-md-6">
                                          <div class="mb-3">
                                              <label for="orgName" class="form-label">組織名稱</label>
                                              <input type="text" class="form-control" id="orgName" value="台灣帕金森病友權益促進會">
                                          </div>
                                      </div>
                                      <div class="col-md-6">
                                          <div class="mb-3">
                                              <label for="orgTaxId" class="form-label">統一編號</label>
                                              <input type="text" class="form-control" id="orgTaxId">
                                          </div>
                                      </div>
                                  </div>
                                  <div class="mb-3">
                                      <label for="orgAddress" class="form-label">地址</label>
                                      <input type="text" class="form-control" id="orgAddress">
                                  </div>
                                  <div class="row">
                                      <div class="col-md-6">
                                          <div class="mb-3">
                                              <label for="orgPhone" class="form-label">電話</label>
                                              <input type="text" class="form-control" id="orgPhone">
                                          </div>
                                      </div>
                                      <div class="col-md-6">
                                          <div class="mb-3">
                                              <label for="orgEmail" class="form-label">電子郵件</label>
                                              <input type="email" class="form-control" id="orgEmail">
                                          </div>
                                      </div>
                                  </div>
                                  <button type="button" class="btn btn-primary" onclick="saveOrganizationInfo()">
                                      <i class="fas fa-save"></i> 儲存設定
                                  </button>
                              </form>
                          </div>
                      </div>

                      <!-- 系統維護 -->
                      <div class="card">
                          <div class="card-header">
                              <h5 class="mb-0">系統維護</h5>
                          </div>
                          <div class="card-body">
                              <div class="row">
                                  <div class="col-md-6">
                                      <h6>資料清理</h6>
                                      <div class="form-check">
                                          <input class="form-check-input" type="checkbox" id="cleanEmptyRecords" checked>
                                          <label class="form-check-label" for="cleanEmptyRecords">
                                              清理空白記錄
                                          </label>
                                      </div>
                                      <div class="form-check">
                                          <input class="form-check-input" type="checkbox" id="cleanDuplicates">
                                          <label class="form-check-label" for="cleanDuplicates">
                                              清理重複記錄
                                          </label>
                                      </div>
                                      <div class="form-check">
                                          <input class="form-check-input" type="checkbox" id="cleanOldReceipts">
                                          <label class="form-check-label" for="cleanOldReceipts">
                                              清理舊收據記錄
                                          </label>
                                      </div>
                                      <button type="button" class="btn btn-warning mt-3" onclick="cleanupSystem()">
                                          <i class="fas fa-broom"></i> 開始清理
                                      </button>
                                  </div>
                                  <div class="col-md-6">
                                      <h6>危險操作</h6>
                                      <p class="text-muted small">以下操作無法復原，請謹慎使用</p>
                                      <button type="button" class="btn btn-outline-danger mb-2" onclick="resetSettings()">
                                          <i class="fas fa-undo"></i> 重置系統設定
                                      </button>
                                      <br>
                                      <button type="button" class="btn btn-outline-dark" onclick="initializeDatabase()">
                                          <i class="fas fa-database"></i> 重新初始化資料庫
                                      </button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="col-md-4">
                      <!-- 系統狀態 -->
                      <div class="card">
                          <div class="card-header">
                              <h5 class="mb-0">系統狀態</h5>
                          </div>
                          <div class="card-body" id="systemStatus">
                              <div class="text-center">
                                  <div class="spinner-border text-primary" role="status">
                                      <span class="visually-hidden">載入中...</span>
                                  </div>
                                  <p class="mt-2">載入系統狀態中...</p>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          `;

          $('#content-area').html(html);
          loadSystemSettings();
          loadSystemStatus();
          hideLoading();
      }

      // 實用函數
      function refreshDashboard() {
          loadDashboard();
      }

      function searchMembers() {
          const search = $('#memberSearch').val();
          const type = $('#memberTypeFilter').val();
          const status = $('#memberStatusFilter').val();
          loadMembersData(1, search, type, status);
      }

      function logout() {
          if (confirm('確定要登出嗎？')) {
              window.location.reload();
          }
      }

      // 初始化年度選項
      function initializeReports() {
          const currentYear = new Date().getFullYear();
          const yearSelect = $('#reportYear');
          
          for (let year = currentYear; year >= currentYear - 5; year--) {
              yearSelect.append(`<option value="${year}">${year}</option>`);
          }
          
          generateReport();
      }

      function generateReport() {
          const reportType = $('#reportType').val();
          const year = $('#reportYear').val();
          const month = $('#reportMonth').val();
          
          showLoading();
          
          switch(reportType) {
              case 'financial':
                  generateFinancialReport(year, month);
                  break;
              case 'balance':
                  generateBalanceSheet();
                  break;
              case 'cashflow':
                  generateCashFlowReport(year, month);
                  break;
              case 'donation':
                  generateDonationReport(year, month);
                  break;
          }
      }

      function generateFinancialReport(year, month) {
          apiRequest('generateFinancialReport', { year: parseInt(year), month: month ? parseInt(month) : null })
              .then(result => {
                  if (result.success) {
                      displayFinancialReport(result.data);
                  } else {
                      showToast('產生財務報表失敗: ' + result.message, 'error');
                  }
              })
              .catch(error => {
                  console.error('產生財務報表失敗:', error);
                  showToast('產生財務報表失敗', 'error');
              })
              .finally(() => {
                  hideLoading();
              });
      }

      function displayFinancialReport(data) {
          const html = `
              <div class="card">
                  <div class="card-header">
                      <h5 class="mb-0">財務報表 - ${data.period.year}年${data.period.month ? data.period.month + '月' : ''}</h5>
                  </div>
                  <div class="card-body">
                      <div class="row mb-4">
                          <div class="col-md-4">
                              <div class="text-center">
                                  <h6 class="text-success">總收入</h6>
                                  <h4 class="text-success">${formatCurrency(data.totalIncome)}</h4>
                              </div>
                          </div>
                          <div class="col-md-4">
                              <div class="text-center">
                                  <h6 class="text-danger">總支出</h6>
                                  <h4 class="text-danger">${formatCurrency(data.totalExpenses)}</h4>
                              </div>
                          </div>
                          <div class="col-md-4">
                              <div class="text-center">
                                  <h6 class="text-primary">淨收益</h6>
                                  <h4 class="text-primary">${formatCurrency(data.netIncome)}</h4>
                              </div>
                          </div>
                      </div>
                      
                      <div class="row">
                          <div class="col-md-6">
                              <h6>收入明細</h6>
                              <table class="table table-sm">
                                  <tbody>
                                      ${data.incomeBreakdown.map(item => `
                                          <tr>
                                              <td>${item.account}</td>
                                              <td class="text-end">${formatCurrency(item.amount)}</td>
                                          </tr>
                                      `).join('')}
                                  </tbody>
                              </table>
                          </div>
                          <div class="col-md-6">
                              <h6>支出明細</h6>
                              <table class="table table-sm">
                                  <tbody>
                                      ${data.expenseBreakdown.map(item => `
                                          <tr>
                                              <td>${item.account}</td>
                                              <td class="text-end">${formatCurrency(item.amount)}</td>
                                          </tr>
                                      `).join('')}
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>
          `;
          
          $('#reportContent').html(html);
      }

      function loadSystemStatus() {
          apiRequest('getSystemStatus')
              .then(result => {
                  if (result.success) {
                      displaySystemStatus(result.data);
                  } else {
                      $('#systemStatus').html('<div class="alert alert-danger">載入系統狀態失敗</div>');
                  }
              })
              .catch(error => {
                  console.error('載入系統狀態失敗:', error);
                  $('#systemStatus').html('<div class="alert alert-danger">載入系統狀態失敗</div>');
              });
      }

      function displaySystemStatus(status) {
          const statusColor = status.overall === 'healthy' ? 'success' : 
                             status.overall === 'warning' ? 'warning' : 'danger';
          
          const html = `
              <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center">
                      <span>系統狀態</span>
                      <span class="badge bg-${statusColor}">${status.status}</span>
                  </div>
              </div>
              
              <div class="mb-3">
                  <small class="text-muted">版本資訊</small>
                  <div>${status.systemVersion}</div>
              </div>
              
              <div class="mb-3">
                  <small class="text-muted">資料統計</small>
                  <div>
                      <div>會員: ${status.dataStats.會員 || 0} 筆</div>
                      <div>收入: ${status.dataStats.收入 || 0} 筆</div>
                      <div>支出: ${status.dataStats.支出 || 0} 筆</div>
                      <div>收據: ${status.dataStats.電子收據 || 0} 筆</div>
                  </div>
              </div>
              
              <div class="mb-3">
                  <small class="text-muted">儲存空間</small>
                  <div>
                      <div>使用量: ${status.storageUsage}</div>
                      <div>檔案大小: ${status.storage.formattedSize}</div>
                  </div>
              </div>
              
              <div class="mb-3">
                  <small class="text-muted">最後更新</small>
                  <div>${formatDate(status.lastUpdate)}</div>
              </div>
          `;
          
          $('#systemStatus').html(html);
      }

      function loadSystemSettings() {
          apiRequest('getSystemSettings')
              .then(result => {
                  if (result.success && result.data) {
                      const settings = result.data;
                      $('#orgName').val(settings['organization.name'] || '');
                      $('#orgTaxId').val(settings['organization.taxId'] || '');
                      $('#orgAddress').val(settings['organization.address'] || '');
                      $('#orgPhone').val(settings['organization.phone'] || '');
                      $('#orgEmail').val(settings['organization.email'] || '');
                  }
              })
              .catch(error => {
                  console.error('載入系統設定失敗:', error);
              });
      }

      function saveOrganizationInfo() {
          const settings = {
              'organization.name': $('#orgName').val(),
              'organization.taxId': $('#orgTaxId').val(),
              'organization.address': $('#orgAddress').val(),
              'organization.phone': $('#orgPhone').val(),
              'organization.email': $('#orgEmail').val()
          };

          showLoading();
          
          apiRequest('updateSystemSettings', { settings: settings })
              .then(result => {
                  if (result.success) {
                      showToast('組織資訊已儲存', 'success');
                  } else {
                      showToast('儲存失敗: ' + result.message, 'error');
                  }
              })
              .catch(error => {
                  console.error('儲存組織資訊失敗:', error);
                  showToast('儲存失敗', 'error');
              })
              .finally(() => {
                  hideLoading();
              });
      }

      function checkSystemHealth() {
          showLoading();
          
          apiRequest('checkSystemHealth')
              .then(result => {
                  if (result.success) {
                      const status = result.data.status;
                      const message = result.message + 
                          (result.data.warnings.length > 0 ? 
                              '\n\n警告：\n' + result.data.warnings.join('\n') : '');
                      
                      showToast(message, status === 'healthy' ? 'success' : 'warning');
                      loadSystemStatus(); // 重新載入系統狀態
                  } else {
                      showToast('系統檢查失敗: ' + result.message, 'error');
                  }
              })
              .catch(error => {
                  console.error('系統檢查失敗:', error);
                  showToast('系統檢查失敗', 'error');
              })
              .finally(() => {
                  hideLoading();
              });
      }

      function createBackup() {
          if (!confirm('確定要建立系統備份嗎？這可能需要一些時間。')) {
              return;
          }

          showLoading();
          
          apiRequest('createBackup')
              .then(result => {
                  if (result.success) {
                      showToast('系統備份建立成功：' + result.data.backupName, 'success');
                  } else {
                      showToast('建立備份失敗: ' + result.message, 'error');
                  }
              })
              .catch(error => {
                  console.error('建立備份失敗:', error);
                  showToast('建立備份失敗', 'error');
              })
              .finally(() => {
                  hideLoading();
              });
      }

      function cleanupSystem() {
          const options = {
              cleanEmptyRecords: $('#cleanEmptyRecords').is(':checked'),
              cleanDuplicates: $('#cleanDuplicates').is(':checked'),
              cleanReceipts: $('#cleanOldReceipts').is(':checked')
          };

          if (!confirm('確定要執行系統清理嗎？此操作無法復原。')) {
              return;
          }

          showLoading();
          
          apiRequest('cleanupSystem', { options: options })
              .then(result => {
                  if (result.success) {
                      showToast(result.message, 'success');
                      loadSystemStatus(); // 重新載入系統狀態
                  } else {
                      showToast('系統清理失敗: ' + result.message, 'error');
                  }
              })
              .catch(error => {
                  console.error('系統清理失敗:', error);
                  showToast('系統清理失敗', 'error');
              })
              .finally(() => {
                  hideLoading();
              });
      }

      function resetSettings() {
          if (!confirm('確定要重置系統設定嗎？這將恢復所有設定為預設值，此操作無法復原。')) {
              return;
          }

          showLoading();
          
          apiRequest('resetSettings')
              .then(result => {
                  if (result.success) {
                      showToast('系統設定已重置', 'success');
                      loadSystemSettings(); // 重新載入設定
                  } else {
                      showToast('重置設定失敗: ' + result.message, 'error');
                  }
              })
              .catch(error => {
                  console.error('重置設定失敗:', error);
                  showToast('重置設定失敗', 'error');
              })
              .finally(() => {
                  hideLoading();
              });
      }

      function initializeDatabase() {
          if (!confirm('確定要重新初始化資料庫嗎？這將清除所有資料並重新建立資料結構，此操作無法復原！')) {
              return;
          }

          if (!confirm('最後確認：此操作將刪除所有現有資料，您確定要繼續嗎？')) {
              return;
          }

          showLoading();
          
          apiRequest('initializeDatabase')
              .then(result => {
                  if (result.success) {
                      showToast('資料庫初始化完成', 'success');
                      setTimeout(() => {
                          window.location.reload();
                      }, 2000);
                  } else {
                      showToast('資料庫初始化失敗: ' + result.message, 'error');
                  }
              })
              .catch(error => {
                  console.error('資料庫初始化失敗:', error);
                  showToast('資料庫初始化失敗', 'error');
              })
              .finally(() => {
                  hideLoading();
              });
      }

      // 載入各種資料的函數（簡化版）
      function loadIncomeData(page = 1) {
          apiRequest('getIncome', { page: page, limit: 20 })
              .then(result => {
                  if (result.success) {
                      updateIncomeTable(result.data, result.pagination);
                  }
              })
              .catch(error => {
                  console.error('載入收入資料失敗:', error);
                  showToast('載入收入資料失敗', 'error');
              });
      }

      function loadExpensesData(page = 1) {
          apiRequest('getExpenses', { page: page, limit: 20 })
              .then(result => {
                  if (result.success) {
                      updateExpensesTable(result.data, result.pagination);
                  }
              })
              .catch(error => {
                  console.error('載入支出資料失敗:', error);
                  showToast('載入支出資料失敗', 'error');
              });
      }

      function loadAccountsData() {
          apiRequest('getAccounts')
              .then(result => {
                  if (result.success) {
                      updateAccountsTable(result.data);
                  }
              })
              .catch(error => {
                  console.error('載入會計科目失敗:', error);
                  showToast('載入會計科目失敗', 'error');
              });
      }

      function loadBankAccountsData() {
          apiRequest('getBankAccounts')
              .then(result => {
                  if (result.success) {
                      updateBankAccountsTable(result.data);
                      updateTotalBalance(result.data);
                  }
              })
              .catch(error => {
                  console.error('載入銀行帳戶失敗:', error);
                  showToast('載入銀行帳戶失敗', 'error');
              });
      }

      function loadReceiptsData(page = 1) {
          apiRequest('getReceipts', { page: page, limit: 20 })
              .then(result => {
                  if (result.success) {
                      updateReceiptsTable(result.data, result.pagination);
                  }
              })
              .catch(error => {
                  console.error('載入收據資料失敗:', error);
                  showToast('載入收據資料失敗', 'error');
              });
      }

      // 更新表格的函數（簡化版）
      function updateIncomeTable(income, pagination) {
          const tbody = $('#incomeTable tbody');
          tbody.empty();

          income.forEach(item => {
              tbody.append(`
                  <tr>
                      <td>${formatDate(item['日期'])}</td>
                      <td>${item['會計科目'] || ''}</td>
                      <td class="text-success">${formatCurrency(item['金額'])}</td>
                      <td>${item['付款人'] || ''}</td>
                      <td>${item['付款方式'] || ''}</td>
                      <td>${item['說明'] || ''}</td>
                      <td>
                          <div class="btn-group btn-group-sm">
                              <button class="btn btn-outline-primary" onclick="editIncome(${item.ID})">
                                  <i class="fas fa-edit"></i>
                              </button>
                              <button class="btn btn-outline-danger" onclick="deleteIncome(${item.ID})">
                                  <i class="fas fa-trash"></i>
                              </button>
                          </div>
                      </td>
                  </tr>
              `);
          });

          updatePagination('incomePagination', pagination, loadIncomeData);
      }

      function updateExpensesTable(expenses, pagination) {
          const tbody = $('#expensesTable tbody');
          tbody.empty();

          expenses.forEach(item => {
              const statusClass = getStatusClass(item['狀態']);
              tbody.append(`
                  <tr>
                      <td>${formatDate(item['日期'])}</td>
                      <td>${item['會計科目'] || ''}</td>
                      <td class="text-danger">${formatCurrency(item['金額'])}</td>
                      <td>${item['收款人'] || ''}</td>
                      <td>${item['付款方式'] || ''}</td>
                      <td><span class="badge ${statusClass}">${item['狀態'] || ''}</span></td>
                      <td>${item['說明'] || ''}</td>
                      <td>
                          <div class="btn-group btn-group-sm">
                              <button class="btn btn-outline-primary" onclick="editExpense(${item.ID})">
                                  <i class="fas fa-edit"></i>
                              </button>
                              <button class="btn btn-outline-danger" onclick="deleteExpense(${item.ID})">
                                  <i class="fas fa-trash"></i>
                              </button>
                          </div>
                      </td>
                  </tr>
              `);
          });

          updatePagination('expensesPagination', pagination, loadExpensesData);
      }

      function updateAccountsTable(accounts) {
          const tbody = $('#accountsTable tbody');
          tbody.empty();

          accounts.forEach(account => {
              const statusClass = account['啟用狀態'] === '啟用' ? 'bg-success' : 'bg-secondary';
              tbody.append(`
                  <tr>
                      <td>${account['科目代碼'] || ''}</td>
                      <td>${account['科目名稱'] || ''}</td>
                      <td>${account['科目類型'] || ''}</td>
                      <td>${account['上層科目'] || ''}</td>
                      <td><span class="badge ${statusClass}">${account['啟用狀態'] || ''}</span></td>
                      <td>
                          <div class="btn-group btn-group-sm">
                              <button class="btn btn-outline-primary" onclick="editAccount(${account.ID})">
                                  <i class="fas fa-edit"></i>
                              </button>
                              <button class="btn btn-outline-danger" onclick="deleteAccount(${account.ID})">
                                  <i class="fas fa-trash"></i>
                              </button>
                          </div>
                      </td>
                  </tr>
              `);
          });
      }

      function updateBankAccountsTable(accounts) {
          const tbody = $('#bankAccountsTable tbody');
          tbody.empty();

          accounts.forEach(account => {
              const statusClass = account['是否啟用'] ? 'bg-success' : 'bg-secondary';
              const statusText = account['是否啟用'] ? '啟用' : '停用';
              
              tbody.append(`
                  <tr>
                      <td>${account['帳戶名稱'] || ''}</td>
                      <td>${account['銀行名稱'] || ''}</td>
                      <td>${account['帳號'] || ''}</td>
                      <td class="text-primary">${formatCurrency(account['目前餘額'])}</td>
                      <td><span class="badge ${statusClass}">${statusText}</span></td>
                      <td>
                          <div class="btn-group btn-group-sm">
                              <button class="btn btn-outline-primary" onclick="editBankAccount(${account.ID})">
                                  <i class="fas fa-edit"></i>
                              </button>
                              <button class="btn btn-outline-danger" onclick="deleteBankAccount(${account.ID})">
                                  <i class="fas fa-trash"></i>
                              </button>
                          </div>
                      </td>
                  </tr>
              `);
          });
      }

      function updateTotalBalance(accounts) {
          const total = accounts
              .filter(account => account['是否啟用'])
              .reduce((sum, account) => sum + (parseFloat(account['目前餘額']) || 0), 0);
          
          $('#totalBalance').text(formatCurrency(total));
      }

      function updateReceiptsTable(receipts, pagination) {
          const tbody = $('#receiptsTable tbody');
          tbody.empty();

          receipts.forEach(receipt => {
              const statusClass = getStatusClass(receipt['收據狀態']);
              const emailStatusClass = getStatusClass(receipt['郵件狀態']);
              
              tbody.append(`
                  <tr>
                      <td>
                          <input type="checkbox" class="receipt-checkbox" value="${receipt.ID}">
                      </td>
                      <td>${receipt['收據編號'] || ''}</td>
                      <td>${formatDate(receipt['開立日期'])}</td>
                      <td>${receipt['付款人'] || ''}</td>
                      <td class="text-success">${formatCurrency(receipt['金額'])}</td>
                      <td><span class="badge ${statusClass}">${receipt['收據狀態'] || ''}</span></td>
                      <td><span class="badge ${emailStatusClass}">${receipt['郵件狀態'] || ''}</span></td>
                      <td>
                          <div class="btn-group btn-group-sm">
                              <button class="btn btn-outline-info" onclick="viewReceipt(${receipt.ID})" title="檢視">
                                  <i class="fas fa-eye"></i>
                              </button>
                              <button class="btn btn-outline-success" onclick="sendReceipt(${receipt.ID})" title="發送">
                                  <i class="fas fa-paper-plane"></i>
                              </button>
                              <button class="btn btn-outline-danger" onclick="deleteReceipt(${receipt.ID})" title="刪除">
                                  <i class="fas fa-trash"></i>
                              </button>
                          </div>
                      </td>
                  </tr>
              `);
          });

          updatePagination('receiptsPagination', pagination, loadReceiptsData);
      }

      // 載入會計科目選項
      function loadIncomeAccounts() {
          apiRequest('getAccounts', { type: '收入' })
              .then(result => {
                  if (result.success) {
                      const select = $('#incomeAccountFilter');
                      select.find('option:not(:first)').remove();
                      result.data.forEach(account => {
                          select.append(`<option value="${account.ID}">${account['科目名稱']}</option>`);
                      });
                  }
              })
              .catch(error => {
                  console.error('載入收入科目失敗:', error);
              });
      }

      function loadExpenseAccounts() {
          apiRequest('getAccounts', { type: '支出' })
              .then(result => {
                  if (result.success) {
                      const select = $('#expenseAccountFilter');
                      select.find('option:not(:first)').remove();
                      result.data.forEach(account => {
                          select.append(`<option value="${account.ID}">${account['科目名稱']}</option>`);
                      });
                  }
              })
              .catch(error => {
                  console.error('載入支出科目失敗:', error);
              });
      }

      // 設定會計科目類型篩選
      function setupAccountTypeFilter() {
          $('.list-group-item').on('click', function(e) {
              e.preventDefault();
              $('.list-group-item').removeClass('active');
              $(this).addClass('active');
              
              const type = $(this).data('type');
              filterAccountsByType(type);
          });
      }

      function filterAccountsByType(type) {
          // 這裡應該根據類型篩選會計科目
          // 為了簡化，直接重新載入所有資料
          loadAccountsData();
      }

      // 搜尋功能
      function searchIncome() {
          const startDate = $('#incomeStartDate').val();
          const endDate = $('#incomeEndDate').val();
          const account = $('#incomeAccountFilter').val();
          
          const params = {
              page: 1,
              limit: 20,
              startDate: startDate,
              endDate: endDate,
              account: account
          };

          apiRequest('getIncome', params)
              .then(result => {
                  if (result.success) {
                      updateIncomeTable(result.data, result.pagination);
                  }
              })
              .catch(error => {
                  console.error('搜尋收入失敗:', error);
                  showToast('搜尋收入失敗', 'error');
              });
      }

      function searchExpenses() {
          const startDate = $('#expenseStartDate').val();
          const endDate = $('#expenseEndDate').val();
          const account = $('#expenseAccountFilter').val();
          const status = $('#expenseStatusFilter').val();
          
          const params = {
              page: 1,
              limit: 20,
              startDate: startDate,
              endDate: endDate,
              account: account,
              status: status
          };

          apiRequest('getExpenses', params)
              .then(result => {
                  if (result.success) {
                      updateExpensesTable(result.data, result.pagination);
                  }
              })
              .catch(error => {
                  console.error('搜尋支出失敗:', error);
                  showToast('搜尋支出失敗', 'error');
              });
      }

      function searchReceipts() {
          const startDate = $('#receiptStartDate').val();
          const endDate = $('#receiptEndDate').val();
          const status = $('#receiptStatusFilter').val();
          
          const params = {
              page: 1,
              limit: 20,
              startDate: startDate,
              endDate: endDate,
              status: status
          };

          apiRequest('getReceipts', params)
              .then(result => {
                  if (result.success) {
                      updateReceiptsTable(result.data, result.pagination);
                  }
              })
              .catch(error => {
                  console.error('搜尋收據失敗:', error);
                  showToast('搜尋收據失敗', 'error');
              });
      }

      // 批次操作
      function toggleAllReceipts() {
          const isChecked = $('#selectAllReceipts').is(':checked');
          $('.receipt-checkbox').prop('checked', isChecked);
      }

      function batchSendReceipts() {
          const selectedIds = $('.receipt-checkbox:checked').map(function() {
              return $(this).val();
          }).get();

          if (selectedIds.length === 0) {
              showToast('請選擇要發送的收據', 'warning');
              return;
          }

          if (!confirm(`確定要發送 ${selectedIds.length} 張收據嗎？`)) {
              return;
          }

          showLoading();

          apiRequest('batchSendReceipts', { receiptIds: selectedIds })
              .then(result => {
                  if (result.success) {
                      showToast(`成功發送 ${result.data.successCount} 張收據`, 'success');
                      loadReceiptsData(); // 重新載入收據列表
                  } else {
                      showToast('批次發送失敗: ' + result.message, 'error');
                  }
              })
              .catch(error => {
                  console.error('批次發送收據失敗:', error);
                  showToast('批次發送收據失敗', 'error');
              })
              .finally(() => {
                  hideLoading();
              });
      }

      // 匯出功能（簡化版）
      function exportMembers() {
          showToast('匯出功能開發中...', 'info');
      }

      function exportIncome() {
          showToast('匯出功能開發中...', 'info');
      }

      function exportExpenses() {
          showToast('匯出功能開發中...', 'info');
      }

      function exportReport() {
          showToast('匯出功能開發中...', 'info');
      }

      // 編輯和刪除功能（簡化版）
      function editMember(id) {
          showToast('編輯功能開發中...', 'info');
      }

      function viewMember(id) {
          showToast('檢視功能開發中...', 'info');
      }

      function deleteMember(id) {
          if (confirm('確定要刪除此會員嗎？')) {
              showToast('刪除功能開發中...', 'info');
          }
      }

      function editIncome(id) {
          showToast('編輯功能開發中...', 'info');
      }

      function deleteIncome(id) {
          if (confirm('確定要刪除此收入記錄嗎？')) {
              showToast('刪除功能開發中...', 'info');
          }
      }

      function editExpense(id) {
          showToast('編輯功能開發中...', 'info');
      }

      function deleteExpense(id) {
          if (confirm('確定要刪除此支出記錄嗎？')) {
              showToast('刪除功能開發中...', 'info');
          }
      }

      function editAccount(id) {
          showToast('編輯功能開發中...', 'info');
      }

      function deleteAccount(id) {
          if (confirm('確定要刪除此會計科目嗎？')) {
              showToast('刪除功能開發中...', 'info');
          }
      }

      function editBankAccount(id) {
          showToast('編輯功能開發中...', 'info');
      }

      function deleteBankAccount(id) {
          if (confirm('確定要刪除此銀行帳戶嗎？')) {
              showToast('刪除功能開發中...', 'info');
          }
      }

      function viewReceipt(id) {
          showToast('檢視功能開發中...', 'info');
      }

      function sendReceipt(id) {
          if (confirm('確定要發送此收據嗎？')) {
              showToast('發送功能開發中...', 'info');
          }
      }

      function deleteReceipt(id) {
          if (confirm('確定要刪除此收據嗎？')) {
              showToast('刪除功能開發中...', 'info');
          }
      }

      // 新增功能（簡化版）
      function showAddMemberModal() {
          showToast('新增會員功能開發中...', 'info');
      }

      function showAddIncomeModal() {
          showToast('新增收入功能開發中...', 'info');
      }

      function showAddExpenseModal() {
          showToast('新增支出功能開發中...', 'info');
      }

      function showAddAccountModal() {
          showToast('新增會計科目功能開發中...', 'info');
      }

      function showAddBankAccountModal() {
          showToast('新增銀行帳戶功能開發中...', 'info');
      }

      function showGenerateReceiptModal() {
          showToast('產生收據功能開發中...', 'info');
      }

      // Chart.js 初始化（如果需要）
      if (typeof Chart === 'undefined') {
          // 動態載入 Chart.js
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
          document.head.appendChild(script);
      }

      // 響應式處理
      $(window).on('resize', function() {
          if (window.innerWidth >= 768) {
              $('#sidebar').removeClass('show');
          }
      });

      // 防止表單意外提交
      $('form').on('submit', function(e) {
          e.preventDefault();
          return false;
      });

      // 數字格式化輸入
      $(document).on('input', 'input[type="number"], .currency-input', function() {
          let value = $(this).val().replace(/[^\d.-]/g, '');
          if (value && !isNaN(value)) {
              $(this).val(parseFloat(value).toFixed(2));
          }
      });

      // 日期輸入預設值
      $(document).on('focus', 'input[type="date"]', function() {
          if (!$(this).val()) {
              $(this).val(new Date().toISOString().split('T')[0]);
          }
      });

      // 表格排序功能（簡化版）
      $(document).on('click', 'th[data-sort]', function() {
          const column = $(this).data('sort');
          const table = $(this).closest('table');
          const tbody = table.find('tbody');
          const rows = tbody.find('tr').toArray();
          
          const isAscending = $(this).hasClass('sort-asc');
          
          // 移除所有排序類別
          table.find('th').removeClass('sort-asc sort-desc');
          
          // 添加新的排序類別
          $(this).addClass(isAscending ? 'sort-desc' : 'sort-asc');
          
          // 簡單的文字排序
          rows.sort((a, b) => {
              const aText = $(a).find('td').eq($(this).index()).text().trim();
              const bText = $(b).find('td').eq($(this).index()).text().trim();
              
              if (isAscending) {
                  return bText.localeCompare(aText);
              } else {
                  return aText.localeCompare(bText);
              }
          });
          
          tbody.empty().append(rows);
      });

      // 鍵盤快捷鍵
      $(document).on('keydown', function(e) {
          // Ctrl + S 儲存
          if (e.ctrlKey && e.key === 's') {
              e.preventDefault();
              const activeForm = $('form:visible').first();
              if (activeForm.length) {
                  const saveButton = activeForm.find('button[onclick*="save"], button[type="submit"]').first();
                  if (saveButton.length) {
                      saveButton.click();
                  }
              }
              return false;
          }
          
          // Ctrl + N 新增
          if (e.ctrlKey && e.key === 'n') {
              e.preventDefault();
              const addButton = $('.btn-primary:contains("新增")').first();
              if (addButton.length) {
                  addButton.click();
              }
              return false;
          }
          
          // ESC 關閉模態框
          if (e.key === 'Escape') {
              $('.modal.show').modal('hide');
              $('.toast').toast('hide');
          }
      });

      // 自動儲存功能（草稿）
      let autoSaveTimeout;
      $(document).on('input', 'input, textarea, select', function() {
          if ($(this).closest('form').hasClass('auto-save')) {
              clearTimeout(autoSaveTimeout);
              autoSaveTimeout = setTimeout(() => {
                  saveDraft($(this).closest('form'));
              }, 2000);
          }
      });

      function saveDraft(form) {
          const formData = form.serialize();
          const formId = form.attr('id') || 'default';
          localStorage.setItem('draft_' + formId, formData);
          console.log('草稿已自動儲存');
      }

      function loadDraft(formId) {
          const draft = localStorage.getItem('draft_' + formId);
          if (draft) {
              const form = $('#' + formId);
              const params = new URLSearchParams(draft);
              params.forEach((value, key) => {
                  form.find(`[name="${key}"]`).val(value);
              });
              return true;
          }
          return false;
      }

      function clearDraft(formId) {
          localStorage.removeItem('draft_' + formId);
      }

      // 網路狀態檢測
      let isOnline = navigator.onLine;
      
      window.addEventListener('online', function() {
          isOnline = true;
          showToast('網路連線已恢復', 'success');
          // 可以在這裡同步離線時的資料
      });

      window.addEventListener('offline', function() {
          isOnline = false;
          showToast('網路連線中斷，部分功能可能無法使用', 'warning');
      });

      // API 請求重試機制
      function apiRequestWithRetry(action, data = {}, maxRetries = 3) {
          return new Promise((resolve, reject) => {
              let retryCount = 0;
              
              function makeRequest() {
                  apiRequest(action, data)
                      .then(resolve)
                      .catch(error => {
                          retryCount++;
                          if (retryCount < maxRetries && isOnline) {
                              console.log(`API 請求失敗，重試第 ${retryCount} 次...`);
                              setTimeout(makeRequest, 1000 * retryCount);
                          } else {
                              reject(error);
                          }
                      });
              }
              
              makeRequest();
          });
      }

      // 資料快取機制
      const dataCache = new Map();
      const CACHE_DURATION = 5 * 60 * 1000; // 5分鐘

      function getCachedData(key) {
          const cached = dataCache.get(key);
          if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
              return cached.data;
          }
          return null;
      }

      function setCachedData(key, data) {
          dataCache.set(key, {
              data: data,
              timestamp: Date.now()
          });
      }

      function clearCache() {
          dataCache.clear();
          console.log('資料快取已清除');
      }

      // 改進的 API 請求函數（帶快取）
      function apiRequestCached(action, data = {}, useCache = true) {
          const cacheKey = action + '_' + JSON.stringify(data);
          
          if (useCache) {
              const cached = getCachedData(cacheKey);
              if (cached) {
                  return Promise.resolve(cached);
              }
          }
          
          return apiRequest(action, data).then(result => {
              if (result.success && useCache) {
                  setCachedData(cacheKey, result);
              }
              return result;
          });
      }

      // 頁面可見性 API - 當頁面重新顯示時重新載入資料
      document.addEventListener('visibilitychange', function() {
          if (!document.hidden && currentPage) {
              // 頁面重新顯示時，清除快取並重新載入當前頁面
              clearCache();
              setTimeout(() => {
                  loadPage(currentPage);
              }, 500);
          }
      });

      // 列印功能
      function printPage() {
          window.print();
      }

      function printTable(tableId) {
          const table = document.getElementById(tableId);
          if (table) {
              const printWindow = window.open('', '_blank');
              printWindow.document.write(`
                  <html>
                      <head>
                          <title>列印報表</title>
                          <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                          <style>
                              @media print {
                                  .btn { display: none !important; }
                                  .no-print { display: none !important; }
                              }
                          </style>
                      </head>
                      <body class="p-3">
                          <h3>台灣帕金森病友權益促進會 - 財務管理系統</h3>
                          <hr>
                          ${table.outerHTML}
                      </body>
                  </html>
              `);
              printWindow.document.close();
              printWindow.print();
              printWindow.close();
          }
      }

      // 匯出為 CSV
      function exportTableToCSV(tableId, filename) {
          const table = document.getElementById(tableId);
          if (!table) return;

          const rows = Array.from(table.querySelectorAll('tr'));
          const csvContent = rows.map(row => {
              const cells = Array.from(row.querySelectorAll('th, td'));
              return cells.map(cell => {
                  let text = cell.textContent.trim();
                  // 處理包含逗號或引號的內容
                  if (text.includes(',') || text.includes('"')) {
                      text = '"' + text.replace(/"/g, '""') + '"';
                  }
                  return text;
              }).join(',');
          }).join('\n');

          // 添加 BOM 以支援中文
          const BOM = '\uFEFF';
          const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
          
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = filename + '.csv';
          link.click();
          
          URL.revokeObjectURL(link.href);
      }

      // 全域錯誤處理
      window.addEventListener('error', function(e) {
          console.error('全域錯誤:', e.error);
          showToast('系統發生未預期的錯誤，請重新整理頁面', 'error');
      });

      window.addEventListener('unhandledrejection', function(e) {
          console.error('未處理的 Promise 拒絕:', e.reason);
          showToast('系統發生錯誤，請稍後再試', 'error');
      });

      // 初始化完成
      console.log('台灣帕金森病友權益促進會財務管理系統已載入完成');
      console.log('系統版本: 1.0.0');
      console.log('最後更新: 2024-12-19');
      
      // 檢查瀏覽器相容性
      if (!window.fetch) {
          showToast('您的瀏覽器版本過舊，部分功能可能無法正常運作，建議更新瀏覽器', 'warning');
      }
      
      // 檢查必要的 API
      if (!window.localStorage) {
          showToast('您的瀏覽器不支援本地儲存，部分功能可能受限', 'warning');
      }

  </script>

  <!-- 自訂樣式 -->
  <style>
      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255, 255, 255, 0.9);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }

      .loading-content {
          text-align: center;
          color: #666;
      }

      .toast-container {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 10000;
      }

      .sidebar .nav-link.active {
          background-color: #0d6efd;
          color: white;
      }

      .border-left-primary {
          border-left: 4px solid #0d6efd !important;
      }

      .border-left-success {
          border-left: 4px solid #198754 !important;
      }

      .border-left-info {
          border-left: 4px solid #0dcaf0 !important;
      }

      .border-left-warning {
          border-left: 4px solid #ffc107 !important;
      }

      .table th[data-sort] {
          cursor: pointer;
          user-select: none;
      }

      .table th[data-sort]:hover {
          background-color: #f8f9fa;
      }

      .table th.sort-asc::after {
          content: ' ↑';
          color: #0d6efd;
      }

      .table th.sort-desc::after {
          content: ' ↓';
          color: #0d6efd;
      }

      @media (max-width: 767.98px) {
          .sidebar {
              transform: translateX(-100%);
              transition: transform 0.3s ease-in-out;
          }

          .sidebar.show {
              transform: translateX(0);
          }

          .main-content {
              margin-left: 0 !important;
          }
      }

      .card {
          box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
          border: 1px solid rgba(0, 0, 0, 0.125);
      }

      .btn-group-sm > .btn, .btn-sm {
          padding: 0.25rem 0.5rem;
          font-size: 0.875rem;
      }

      .text-xs {
          font-size: 0.75rem;
      }

      .font-weight-bold {
          font-weight: 700 !important;
      }

      .text-gray-800 {
          color: #5a5c69 !important;
      }

      .no-gutters {
          margin-right: 0;
          margin-left: 0;
      }

      .no-gutters > .col,
      .no-gutters > [class*="col-"] {
          padding-right: 0;
          padding-left: 0;
      }

      /* 響應式表格改進 */
      @media (max-width: 767.98px) {
          .table-responsive table,
          .table-responsive thead,
          .table-responsive tbody,
          .table-responsive th,
          .table-responsive td,
          .table-responsive tr {
              display: block;
          }

          .table-responsive thead tr {
              position: absolute;
              top: -9999px;
              left: -9999px;
          }

          .table-responsive tr {
              border: 1px solid #ccc;
              margin-bottom: 10px;
              padding: 10px;
          }

          .table-responsive td {
              border: none;
              position: relative;
              padding-left: 50% !important;
              padding-top: 10px;
              padding-bottom: 10px;
          }

          .table-responsive td:before {
              content: attr(data-label) ": ";
              position: absolute;
              left: 6px;
              width: 45%;
              padding-right: 10px;
              white-space: nowrap;
              font-weight: bold;
          }
      }
  </style>

</body>
</html>
