<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會 - 財務管理系統</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
      .sidebar {
          position: fixed;
          top: 0;
          bottom: 0;
          left: 0;
          z-index: 100;
          padding: 48px 0 0;
          box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
      }

      .sidebar-sticky {
          position: relative;
          top: 0;
          height: calc(100vh - 48px);
          padding-top: .5rem;
          overflow-x: hidden;
          overflow-y: auto;
      }

      .main-content {
          margin-left: 240px;
          padding: 20px;
      }

      .navbar-brand {
          padding-top: .75rem;
          padding-bottom: .75rem;
          font-size: 1rem;
          background-color: rgba(0, 0, 0, .25);
          box-shadow: inset -1px 0 0 rgba(0, 0, 0, .25);
      }

      .navbar .form-control {
          padding: .75rem 1rem;
          border-width: 0;
          border-radius: 0;
      }

      .sidebar .nav-link {
          font-weight: 500;
          color: #333;
          padding: 0.75rem 1rem;
          margin: 0.125rem 0;
          border-radius: 0.375rem;
          transition: all 0.15s ease-in-out;
      }

      .sidebar .nav-link:hover {
          background-color: rgba(0, 123, 255, 0.1);
          color: #007bff;
      }

      .sidebar .nav-link.active {
          background-color: #007bff;
          color: white;
      }

      .card {
          box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
          border: 1px solid rgba(0, 0, 0, 0.125);
          transition: box-shadow 0.15s ease-in-out;
      }

      .card:hover {
          box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      }

      .border-left-primary {
          border-left: 4px solid #007bff !important;
      }

      .border-left-success {
          border-left: 4px solid #28a745 !important;
      }

      .border-left-info {
          border-left: 4px solid #17a2b8 !important;
      }

      .border-left-warning {
          border-left: 4px solid #ffc107 !important;
      }

      .text-xs {
          font-size: 0.75rem;
      }

      .font-weight-bold {
          font-weight: 700 !important;
      }

      .text-gray-800 {
          color: #5a5c69 !important;
      }

      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255, 255, 255, 0.9);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }

      .demo-mode-banner {
          background: linear-gradient(45deg, #28a745, #20c997);
          color: white;
          text-align: center;
          padding: 10px;
          font-weight: bold;
      }

      .spinner-border {
          width: 3rem;
          height: 3rem;
      }

      .toast {
          min-width: 300px;
      }

      .toast-header {
          border-bottom: none;
      }

      .is-invalid {
          border-color: #dc3545;
      }

      .is-invalid:focus {
          border-color: #dc3545;
          box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
      }

      th[data-sort] {
          cursor: pointer;
          user-select: none;
          position: relative;
      }

      th[data-sort]:hover {
          background-color: #f8f9fa;
      }

      th[data-sort]::after {
          content: ' ⇅';
          color: #6c757d;
          font-size: 0.8em;
      }

      th.sort-asc::after {
          content: ' ↑';
          color: #007bff;
      }

      th.sort-desc::after {
          content: ' ↓';
          color: #007bff;
      }

      @media (max-width: 767.98px) {
          .sidebar {
              transform: translateX(-100%);
              transition: transform 0.3s ease-in-out;
          }

          .sidebar.show {
              transform: translateX(0);
          }

          .main-content {
              margin-left: 0 !important;
          }

          .table-responsive {
              font-size: 0.875rem;
          }
          
          .btn-group-sm > .btn {
              padding: 0.125rem 0.25rem;
              font-size: 0.75rem;
          }
      }

      @media print {
          .sidebar,
          .navbar,
          .btn,
          .no-print {
              display: none !important;
          }
          
          .main-content {
              margin-left: 0 !important;
          }
          
          .card {
              border: 1px solid #dee2e6 !important;
              box-shadow: none !important;
          }
      }
  </style>
</head>

<body>
  <!-- GAS 連線狀態橫幅 -->
  <div class="demo-mode-banner" id="connectionBanner">
      <i class="fas fa-cloud"></i> 已連接到 Google Sheets 雲端資料庫
  </div>

  <!-- 導航列 -->
  <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
      <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">財務管理系統</a>
      <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
          <span class="navbar-toggler-icon"></span>
      </button>
      <div class="navbar-nav">
          <div class="nav-item text-nowrap">
              <span class="nav-link px-3" id="lastSyncTime">最後同步: --</span>
              <a class="nav-link px-3" href="#" onclick="logout()">登出</a>
          </div>
      </div>
  </nav>

  <div class="container-fluid">
      <div class="row">
          <!-- 側邊欄 -->
          <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
              <div class="position-sticky pt-3">
                  <ul class="nav flex-column">
                      <li class="nav-item">
                          <a class="nav-link active" href="#" onclick="loadPage('dashboard')">
                              <i class="fas fa-tachometer-alt"></i> 儀表板
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('members')">
                              <i class="fas fa-users"></i> 會員管理
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('income')">
                              <i class="fas fa-arrow-up text-success"></i> 收入管理
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('expenses')">
                              <i class="fas fa-arrow-down text-danger"></i> 支出管理
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('accounts')">
                              <i class="fas fa-list"></i> 會計科目
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('bank-accounts')">
                              <i class="fas fa-university"></i> 銀行帳戶
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('receipts')">
                              <i class="fas fa-receipt"></i> 電子收據
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('reports')">
                              <i class="fas fa-chart-bar"></i> 財務報表
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#" onclick="loadPage('settings')">
                              <i class="fas fa-cog"></i> 系統設定
                          </a>
                      </li>
                  </ul>
              </div>
          </nav>

          <!-- 主要內容區域 -->
          <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
              <div id="content-area">
                  <!-- 內容將由 JavaScript 動態載入 -->
              </div>
          </main>
      </div>
  </div>

  <!-- 載入中覆蓋層 -->
  <div class="loading-overlay" id="loadingOverlay">
      <div class="text-center">
          <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">載入中...</span>
          </div>
          <p class="mt-2" id="loadingText">載入中...</p>
      </div>
  </div>

  <!-- Toast 容器 -->
  <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer">
  </div>

  <!-- 新增/編輯模態框 -->
  <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="editModalTitle">編輯項目</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="editModalBody">
                  <!-- 動態內容 -->
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" id="saveBtn" onclick="saveData()">儲存</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
      // 全域變數
      let currentPage = 'dashboard';
      let currentData = {};
      let editingItem = null;
      let editingType = null;
      
      // GAS Web App URL - 請替換為您的 GAS Web App URL
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbwa2Ks4IJ5AWZq0UOrACDL_nyzGkjJuWHU2DJfSeO8F41mx86QbV_GKMDx9VFUQ7ZrI/exec';
      
      // API 呼叫函數
      async function callGAS(action, data = {}) {
          try {
              showLoading(`正在${getActionText(action)}...`);
              
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: new URLSearchParams({
                      action: action,
                      data: JSON.stringify(data)
                  })
              });

              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }

              const result = await response.json();
              
              if (result.success) {
                  updateLastSyncTime();
                  return result.data;
              } else {
                  throw new Error(result.error || '操作失敗');
              }
          } catch (error) {
              console.error('GAS API 呼叫錯誤:', error);
              showToast(`操作失敗: ${error.message}`, 'error');
              updateConnectionStatus(false);
              throw error;
          } finally {
              hideLoading();
          }
      }

      function getActionText(action) {
          const actionTexts = {
              'getDashboardData': '載入儀表板資料',
              'getMembers': '載入會員資料',
              'getIncome': '載入收入資料',
              'getExpenses': '載入支出資料',
              'getAccounts': '載入會計科目',
              'getBankAccounts': '載入銀行帳戶',
              'getReceipts': '載入收據資料',
              'getReports': '產生報表',
              'getSettings': '載入系統設定',
              'addMember': '新增會員',
              'updateMember': '更新會員',
              'deleteMember': '刪除會員',
              'addIncome': '新增收入',
              'updateIncome': '更新收入',
              'deleteIncome': '刪除收入',
              'addExpense': '新增支出',
              'updateExpense': '更新支出',
              'deleteExpense': '刪除支出'
          };
          return actionTexts[action] || '處理資料';
      }

      function updateConnectionStatus(isConnected) {
          const banner = document.getElementById('connectionBanner');
          if (isConnected) {
              banner.className = 'demo-mode-banner';
              banner.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
              banner.innerHTML = '<i class="fas fa-cloud"></i> 已連接到 Google Sheets 雲端資料庫';
          } else {
              banner.style.background = 'linear-gradient(45deg, #dc3545, #fd7e14)';
              banner.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 與雲端資料庫連線中斷';
          }
      }

      function updateLastSyncTime() {
          const now = new Date();
          document.getElementById('lastSyncTime').textContent = 
              `最後同步: ${now.toLocaleTimeString('zh-TW')}`;
      }

      // 初始化應用程式
      $(document).ready(async function() {
          console.log('系統初始化中...');
          showToast('正在連接雲端資料庫...', 'info');
          
          try {
              // 測試 GAS 連線
              await callGAS('testConnection');
              updateConnectionStatus(true);
              showToast('已成功連接到雲端資料庫', 'success');
              loadPage('dashboard');
          } catch (error) {
              updateConnectionStatus(false);
              showToast('無法連接到雲端資料庫，請檢查網路連線', 'error');
              // 載入離線模式或錯誤頁面
              loadOfflineMode();
          }
      });

      // 載入頁面
      async function loadPage(page) {
          showLoading();
          
          // 更新導航狀態
          $('.nav-link').removeClass('active');
          $(`.nav-link[onclick="loadPage('${page}')"]`).addClass('active');
          
          currentPage = page;
          
          try {
              switch(page) {
                  case 'dashboard':
                      await loadDashboard();
                      break;
                  case 'members':
                      await loadMembers();
                      break;
                  case 'income':
                      await loadIncome();
                      break;
                  case 'expenses':
                      await loadExpenses();
                      break;
                  case 'accounts':
                      await loadAccounts();
                      break;
                  case 'bank-accounts':
                      await loadBankAccounts();
                      break;
                  case 'receipts':
                      await loadReceipts();
                      break;
                  case 'reports':
                      await loadReports();
                      break;
                  case 'settings':
                      await loadSettings();
                      break;
                  default:
                      await loadDashboard();
              }
          } catch (error) {
              showToast('載入頁面失敗', 'error');
              console.error('載入頁面錯誤:', error);
          } finally {
              hideLoading();
          }
      }

      // 載入儀表板
      async function loadDashboard() {
          try {
              const data = await callGAS('getDashboardData');
              currentData.dashboard = data;
              
              const html = `
                  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                      <h1 class="h2">儀表板</h1>
                      <div class="btn-toolbar mb-2 mb-md-0">
                          <div class="btn-group me-2">
                              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshDashboard()">
                                  <i class="fas fa-sync-alt"></i> 重新整理
                              </button>
                              <button type="button" class="btn btn-sm btn-outline-primary" onclick="syncAllData()">
                                  <i class="fas fa-cloud-download-alt"></i> 同步資料
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- 統計卡片 -->
                  <div class="row mb-4">
                      <div class="col-xl-3 col-md-6 mb-4">
                          <div class="card border-left-primary shadow h-100 py-2">
                              <div class="card-body">
                                  <div class="row no-gutters align-items-center">
                                      <div class="col mr-2">
                                          <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                              會員總數</div>
                                          <div class="h5 mb-0 font-weight-bold text-gray-800">${data.stats.totalMembers || 0}</div>
                                      </div>
                                      <div class="col-auto">
                                          <i class="fas fa-users fa-2x text-gray-300"></i>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <div class="col-xl-3 col-md-6 mb-4">
                          <div class="card border-left-success shadow h-100 py-2">
                              <div class="card-body">
                                  <div class="row no-gutters align-items-center">
                                      <div class="col mr-2">
                                          <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                              總收入</div>
                                          <div class="h5 mb-0 font-weight-bold text-gray-800">$${formatCurrency(data.stats.totalIncome || 0)}</div>
                                      </div>
                                      <div class="col-auto">
                                          <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <div class="col-xl-3 col-md-6 mb-4">
                          <div class="card border-left-info shadow h-100 py-2">
                              <div class="card-body">
                                  <div class="row no-gutters align-items-center">
                                      <div class="col mr-2">
                                          <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                              總支出</div>
                                          <div class="h5 mb-0 font-weight-bold text-gray-800">$${formatCurrency(data.stats.totalExpenses || 0)}</div>
                                      </div>
                                      <div class="col-auto">
                                          <i class="fas fa-credit-card fa-2x text-gray-300"></i>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <div class="col-xl-3 col-md-6 mb-4">
                          <div class="card border-left-warning shadow h-100 py-2">
                              <div class="card-body">
                                  <div class="row no-gutters align-items-center">
                                      <div class="col mr-2">
                                          <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                              淨收益</div>
                                          <div class="h5 mb-0 font-weight-bold text-gray-800">$${formatCurrency(data.stats.netIncome || 0)}</div>
                                      </div>
                                      <div class="col-auto">
                                          <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- 圖表和最近交易 -->
                  <div class="row">
                      <div class="col-lg-8">
                          <div class="card shadow mb-4">
                              <div class="card-header py-3">
                                  <h6 class="m-0 font-weight-bold text-primary">收入支出趨勢</h6>
                              </div>
                              <div class="card-body">
                                  <canvas id="incomeExpenseChart" width="400" height="200"></canvas>
                              </div>
                          </div>
                      </div>

                      <div class="col-lg-4">
                          <div class="card shadow mb-4">
                              <div class="card-header py-3">
                                  <h6 class="m-0 font-weight-bold text-primary">最近交易</h6>
                              </div>
                              <div class="card-body">
                                  <div class="list-group list-group-flush">
                                      ${(data.recentTransactions || []).map(transaction => `
                                          <div class="list-group-item d-flex justify-content-between align-items-center">
                                              <div>
                                                  <h6 class="mb-1">${transaction.account || ''}</h6>
                                                  <p class="mb-1 text-muted small">${transaction.description || ''}</p>
                                                  <small class="text-muted">${formatDate(transaction.date)}</small>
                                              </div>
                                              <span class="badge ${transaction.amount > 0 ? 'bg-success' : 'bg-danger'} rounded-pill">
                                                  ${transaction.amount > 0 ? '+' : ''}${formatCurrency(Math.abs(transaction.amount))}
                                              </span>
                                          </div>
                                      `).join('')}
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              `;

              $('#content-area').html(html);
              
              // 初始化圖表
              setTimeout(() => {
                  initializeChart(data.monthlyData || []);
              }, 100);
              
          } catch (error) {
              showToast('載入儀表板失敗', 'error');
              console.error('載入儀表板錯誤:', error);
          }
      }

      // 載入會員管理
      async function loadMembers() {
          try {
              const members = await callGAS('getMembers');
              currentData.members = members;

              const html = `
                  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                      <h1 class="h2">會員管理</h1>
                      <div class="btn-toolbar mb-2 mb-md-0">
                          <div class="btn-group me-2">
                              <button type="button" class="btn btn-primary" onclick="showAddMemberModal()">
                                  <i class="fas fa-plus"></i> 新增會員
                              </button>
                              <button type="button" class="btn btn-outline-secondary" onclick="exportToCSV('.table', '會員清單')">
                                  <i class="fas fa-download"></i> 匯出
                              </button>
                          </div>
                      </div>
                  </div>

                  <div class="card">
                      <div class="card-header">
                          <div class="row align-items-center">
                              <div class="col">
                                  <h5 class="mb-0">會員列表 (${members.length} 人)</h5>
                              </div>
                              <div class="col-auto">
                                  <div class="input-group">
                                      <span class="input-group-text"><i class="fas fa-search"></i></span>
                                      <input type="text" class="form-control" placeholder="搜尋會員..." onkeyup="searchTable(this.value, '.table')">
                                  </div>
                              </div>
                          </div>
                      </div>
                      <div class="card-body">
                          <div class="table-responsive">
                              <table class="table table-hover">
                                  <thead>
                                      <tr>
                                          <th data-sort="name">姓名</th>
                                          <th data-sort="phone">電話</th>
                                          <th data-sort="email">電子郵件</th>
                                          <th data-sort="type">會員類型</th>
                                          <th data-sort="status">狀態</th>
                                          <th data-sort="joinDate">加入日期</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      ${members.map(member => `
                                          <tr>
                                              <td>${member.name || ''}</td>
                                              <td>${member.phone || ''}</td>
                                              <td>${member.email || ''}</td>
                                              <td><span class="badge bg-primary">${member.type || ''}</span></td>
                                              <td><span class="badge ${member.status === '正常' ? 'bg-success' : 'bg-warning'}">${member.status || ''}</span></td>
                                              <td>${formatDate(member.joinDate)}</td>
                                              <td>
                                                  <div class="btn-group btn-group-sm">
                                                      <button class="btn btn-outline-info" onclick="viewMember('${member.id}')" title="檢視">
                                                          <i class="fas fa-eye"></i>
                                                      </button>
                                                      <button class="btn btn-outline-primary" onclick="editMember('${member.id}')" title="編輯">
                                                          <i class="fas fa-edit"></i>
                                                      </button>
                                                      <button class="btn btn-outline-danger" onclick="deleteMember('${member.id}')" title="刪除">
                                                          <i class="fas fa-trash"></i>
                                                      </button>
                                                  </div>
                                              </td>
                                          </tr>
                                      `).join('')}
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
                  `;
            $('#content-area').html(html);
            
        } catch (error) {
            showToast('載入會員資料失敗', 'error');
            console.error('載入會員錯誤:', error);
        }
    }

    // 載入收入管理
    async function loadIncome() {
        try {
            const income = await callGAS('getIncome');
            currentData.income = income;

            const html = `
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">收入管理</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-primary" onclick="showAddIncomeModal()">
                                <i class="fas fa-plus"></i> 新增收入
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="exportToCSV('.table', '收入清單')">
                                <i class="fas fa-download"></i> 匯出
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">收入記錄 (${income.length} 筆)</h5>
                            </div>
                            <div class="col-auto">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" placeholder="搜尋收入..." onkeyup="searchTable(this.value, '.table')">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th data-sort="date">日期</th>
                                        <th data-sort="account">會計科目</th>
                                        <th data-sort="amount">金額</th>
                                        <th data-sort="payer">付款人</th>
                                        <th data-sort="method">付款方式</th>
                                        <th>說明</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${income.map(item => `
                                        <tr>
                                            <td>${formatDate(item.date)}</td>
                                            <td>${item.account || ''}</td>
                                            <td class="text-success">$${formatCurrency(item.amount || 0)}</td>
                                            <td>${item.payer || ''}</td>
                                            <td><span class="badge bg-info">${item.method || ''}</span></td>
                                            <td>${item.description || ''}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="editIncome('${item.id}')" title="編輯">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteIncome('${item.id}')" title="刪除">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            $('#content-area').html(html);
            
        } catch (error) {
            showToast('載入收入資料失敗', 'error');
            console.error('載入收入錯誤:', error);
        }
    }

    // 載入支出管理
    async function loadExpenses() {
        try {
            const expenses = await callGAS('getExpenses');
            currentData.expenses = expenses;

            const html = `
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">支出管理</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-primary" onclick="showAddExpenseModal()">
                                <i class="fas fa-plus"></i> 新增支出
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="exportToCSV('.table', '支出清單')">
                                <i class="fas fa-download"></i> 匯出
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">支出記錄 (${expenses.length} 筆)</h5>
                            </div>
                            <div class="col-auto">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" placeholder="搜尋支出..." onkeyup="searchTable(this.value, '.table')">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th data-sort="date">日期</th>
                                        <th data-sort="account">會計科目</th>
                                        <th data-sort="amount">金額</th>
                                        <th data-sort="payee">收款人</th>
                                        <th data-sort="method">付款方式</th>
                                        <th data-sort="status">狀態</th>
                                        <th>說明</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${expenses.map(item => `
                                        <tr>
                                            <td>${formatDate(item.date)}</td>
                                            <td>${item.account || ''}</td>
                                            <td class="text-danger">$${formatCurrency(item.amount || 0)}</td>
                                            <td>${item.payee || ''}</td>
                                            <td><span class="badge bg-info">${item.method || ''}</span></td>
                                            <td><span class="badge ${item.status === '已核准' ? 'bg-success' : 'bg-warning'}">${item.status || ''}</span></td>
                                            <td>${item.description || ''}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="editExpense('${item.id}')" title="編輯">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteExpense('${item.id}')" title="刪除">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            $('#content-area').html(html);
            
        } catch (error) {
            showToast('載入支出資料失敗', 'error');
            console.error('載入支出錯誤:', error);
        }
    }

    // 載入會計科目
    async function loadAccounts() {
        try {
            const accounts = await callGAS('getAccounts');
            currentData.accounts = accounts;

            const html = `
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">會計科目管理</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-primary" onclick="showAddAccountModal()">
                                <i class="fas fa-plus"></i> 新增科目
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">會計科目列表 (${accounts.length} 項)</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th data-sort="code">科目代碼</th>
                                        <th data-sort="name">科目名稱</th>
                                        <th data-sort="type">科目類型</th>
                                        <th data-sort="parent">上層科目</th>
                                        <th data-sort="status">狀態</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${accounts.map(account => `
                                        <tr>
                                            <td><code>${account.code || ''}</code></td>
                                            <td>${account.name || ''}</td>
                                            <td><span class="badge ${account.type === '收入' ? 'bg-success' : 'bg-danger'}">${account.type || ''}</span></td>
                                            <td>${account.parent || '-'}</td>
                                            <td><span class="badge ${account.status === '啟用' ? 'bg-success' : 'bg-secondary'}">${account.status || ''}</span></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="editAccount('${account.id}')" title="編輯">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteAccount('${account.id}')" title="刪除">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            $('#content-area').html(html);
            
        } catch (error) {
            showToast('載入會計科目失敗', 'error');
            console.error('載入會計科目錯誤:', error);
        }
    }

    // 載入銀行帳戶
    async function loadBankAccounts() {
        try {
            const bankAccounts = await callGAS('getBankAccounts');
            currentData.bankAccounts = bankAccounts;

            const totalBalance = bankAccounts
                .filter(account => account.active)
                .reduce((sum, account) => sum + (parseFloat(account.balance) || 0), 0);

            const html = `
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">銀行帳戶管理</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-primary" onclick="showAddBankAccountModal()">
                                <i class="fas fa-plus"></i> 新增帳戶
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card border-left-primary">
                            <div class="card-body">
                                <h5 class="card-title text-primary">總餘額</h5>
                                <h3 class="text-primary">$${formatCurrency(totalBalance)}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">銀行帳戶列表 (${bankAccounts.length} 個)</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th data-sort="name">帳戶名稱</th>
                                        <th data-sort="bank">銀行名稱</th>
                                        <th data-sort="account">帳號</th>
                                        <th data-sort="balance">目前餘額</th>
                                        <th data-sort="active">狀態</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${bankAccounts.map(account => `
                                        <tr>
                                            <td>${account.name || ''}</td>
                                            <td>${account.bank || ''}</td>
                                            <td><code>${account.account || ''}</code></td>
                                            <td class="text-primary">$${formatCurrency(account.balance || 0)}</td>
                                            <td><span class="badge ${account.active ? 'bg-success' : 'bg-secondary'}">${account.active ? '啟用' : '停用'}</span></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="editBankAccount('${account.id}')" title="編輯">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteBankAccount('${account.id}')" title="刪除">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            $('#content-area').html(html);
            
        } catch (error) {
            showToast('載入銀行帳戶失敗', 'error');
            console.error('載入銀行帳戶錯誤:', error);
        }
    }

    // 載入電子收據
    async function loadReceipts() {
        try {
            const receipts = await callGAS('getReceipts');
            currentData.receipts = receipts;

            const html = `
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">電子收據管理</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-primary" onclick="showAddReceiptModal()">
                                <i class="fas fa-plus"></i> 產生收據
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="batchSendReceipts()">
                                <i class="fas fa-paper-plane"></i> 批次發送
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">收據列表 (${receipts.length} 張)</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAll" onchange="toggleAllReceipts()">
                                        </th>
                                        <th data-sort="number">收據編號</th>
                                        <th data-sort="date">開立日期</th>
                                        <th data-sort="payer">付款人</th>
                                        <th data-sort="amount">金額</th>
                                        <th data-sort="status">收據狀態</th>
                                        <th data-sort="emailStatus">郵件狀態</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${receipts.map(receipt => `
                                        <tr>
                                            <td>
                                                <input type="checkbox" class="receipt-checkbox" value="${receipt.id}">
                                            </td>
                                            <td><code>${receipt.number || ''}</code></td>
                                            <td>${formatDate(receipt.date)}</td>
                                            <td>${receipt.payer || ''}</td>
                                            <td class="text-success">$${formatCurrency(receipt.amount || 0)}</td>
                                            <td><span class="badge bg-success">${receipt.status || ''}</span></td>
                                            <td><span class="badge ${receipt.emailStatus === '已發送' ? 'bg-success' : 'bg-warning'}">${receipt.emailStatus || ''}</span></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-info" onclick="viewReceipt('${receipt.id}')" title="檢視">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-outline-success" onclick="sendReceipt('${receipt.id}')" title="發送">
                                                        <i class="fas fa-paper-plane"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteReceipt('${receipt.id}')" title="刪除">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            $('#content-area').html(html);
            
        } catch (error) {
            showToast('載入收據資料失敗', 'error');
            console.error('載入收據錯誤:', error);
        }
    }

    // 載入財務報表
    async function loadReports() {
        try {
            const reportData = await callGAS('getReports');
            currentData.reports = reportData;

            const html = `
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">財務報表</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-outline-secondary" onclick="exportReport()">
                                <i class="fas fa-download"></i> 匯出報表
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="printReport()">
                                <i class="fas fa-print"></i> 列印
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">報表篩選</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label class="form-label">報表類型</label>
                                        <select class="form-select" id="reportType">
                                            <option value="income-statement">損益表</option>
                                            <option value="balance-sheet">資產負債表</option>
                                            <option value="cash-flow">現金流量表</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">開始日期</label>
                                        <input type="date" class="form-control" id="startDate" value="${new Date().getFullYear()}-01-01">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">結束日期</label>
                                        <input type="date" class="form-control" id="endDate" value="${new Date().toISOString().split('T')[0]}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button class="btn btn-primary d-block" onclick="generateReport()">產生報表</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">損益表 - ${new Date().getFullYear()}年度</h5>
                    </div>
                    <div class="card-body" id="reportContent">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="text-center">
                                    <h6 class="text-success">總收入</h6>
                                    <h4 class="text-success">$${formatCurrency(reportData.totalIncome || 0)}</h4>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <h6 class="text-danger">總支出</h6>
                                    <h4 class="text-danger">$${formatCurrency(reportData.totalExpenses || 0)}</h4>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <h6 class="text-primary">淨收益</h6>
                                    <h4 class="text-primary">$${formatCurrency((reportData.totalIncome || 0) - (reportData.totalExpenses || 0))}</h4>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6>收入明細</h6>
                                <table class="table table-sm">
                                    <tbody>
                                        ${(reportData.incomeDetails || []).map(item => `
                                            <tr><td>${item.category}</td><td class="text-end">$${formatCurrency(item.amount)}</td></tr>
                                        `).join('')}
                                        <tr class="table-active"><td><strong>總計</strong></td><td class="text-end"><strong>$${formatCurrency(reportData.totalIncome || 0)}</strong></td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6>支出明細</h6>
                                <table class="table table-sm">
                                    <tbody>
                                        ${(reportData.expenseDetails || []).map(item => `
                                            <tr><td>${item.category}</td><td class="text-end">$${formatCurrency(item.amount)}</td></tr>
                                        `).join('')}
                                        <tr class="table-active"><td><strong>總計</strong></td><td class="text-end"><strong>$${formatCurrency(reportData.totalExpenses || 0)}</strong></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('#content-area').html(html);
            
        } catch (error) {
            showToast('載入報表失敗', 'error');
            console.error('載入報表錯誤:', error);
        }
    }

    // 載入系統設定
    async function loadSettings() {
        try {
            const settings = await callGAS('getSettings');
            currentData.settings = settings;

            const html = `
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">系統設定</h1>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">組織資訊</h5>
                            </div>
                            <div class="card-body">
                                <form id="organizationForm">
                                    <div class="mb-3">
                                        <label class="form-label">組織名稱</label>
                                        <input type="text" class="form-control auto-save" name="organizationName" value="${settings.organizationName || '台灣帕金森病友權益促進會'}">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">統一編號</label>
                                        <input type="text" class="form-control auto-save tax-id-input" name="taxId" value="${settings.taxId || ''}">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">地址</label>
                                        <textarea class="form-control auto-save" rows="2" name="address">${settings.address || ''}</textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">電話</label>
                                                <input type="text" class="form-control auto-save phone-input" name="phone" value="${settings.phone || ''}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">電子郵件</label>
                                                <input type="email" class="form-control auto-save" name="email" value="${settings.email || ''}">
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">儲存設定</button>
                                </form>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">系統維護</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <button class="btn btn-outline-info w-100" onclick="systemHealthCheck()">
                                            <i class="fas fa-check-circle"></i> 系統健康檢查
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <button class="btn btn-outline-secondary w-100" onclick="createBackup()">
                                            <i class="fas fa-database"></i> 建立系統備份
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <button class="btn btn-outline-warning w-100" onclick="cleanupSystem()">
                                            <i class="fas fa-broom"></i> 系統清理
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <button class="btn btn-outline-danger w-100" onclick="confirmReset()">
                                           <i class="fas fa-redo"></i> 重置設定
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">系統狀態</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>系統狀態</span>
                                        <span class="badge bg-success">正常運行</span>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted">版本資訊</small>
                                    <div>財務管理系統 v1.0.0</div>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted">資料統計</small>
                                    <div>
                                        <div>會員: ${(currentData.members || []).length} 筆</div>
                                        <div>收入: ${(currentData.income || []).length} 筆</div>
                                        <div>支出: ${(currentData.expenses || []).length} 筆</div>
                                        <div>收據: ${(currentData.receipts || []).length} 筆</div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted">最後更新</small>
                                    <div>${formatDate(new Date().toISOString().split('T')[0])}</div>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted">Google Sheets 連線</small>
                                    <div id="sheetsStatus">
                                        <span class="badge bg-success">已連接</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('#content-area').html(html);
            
            // 綁定表單提交事件
            $('#organizationForm').on('submit', async function(e) {
                e.preventDefault();
                await saveOrganizationSettings();
            });
            
        } catch (error) {
            showToast('載入系統設定失敗', 'error');
            console.error('載入設定錯誤:', error);
        }
    }

    // 模態框相關函數
    function showAddMemberModal() {
        editingType = 'member';
        editingItem = null;
        
        const modalBody = `
            <form id="memberForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">姓名 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">電話</label>
                            <input type="text" class="form-control phone-input" name="phone">
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">電子郵件</label>
                    <input type="email" class="form-control" name="email">
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">會員類型</label>
                            <select class="form-select" name="type">
                                <option value="一般會員">一般會員</option>
                                <option value="榮譽會員">榮譽會員</option>
                                <option value="贊助會員">贊助會員</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">狀態</label>
                            <select class="form-select" name="status">
                                <option value="正常">正常</option>
                                <option value="暫停">暫停</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">加入日期</label>
                    <input type="date" class="form-control" name="joinDate" value="${new Date().toISOString().split('T')[0]}">
                </div>
            </form>
        `;
        
        $('#editModalTitle').text('新增會員');
        $('#editModalBody').html(modalBody);
        $('#editModal').modal('show');
    }

    function showAddIncomeModal() {
        editingType = 'income';
        editingItem = null;
        
        const modalBody = `
            <form id="incomeForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">日期 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="date" value="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">金額 <span class="text-danger">*</span></label>
                            <input type="number" class="form-control currency-input" name="amount" min="0" step="1" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">會計科目</label>
                            <select class="form-select" name="account">
                                ${(currentData.accounts || [])
                                    .filter(acc => acc.type === '收入')
                                    .map(acc => `<option value="${acc.name}">${acc.name}</option>`)
                                    .join('')}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">付款方式</label>
                            <select class="form-select" name="method">
                                <option value="現金">現金</option>
                                <option value="轉帳">轉帳</option>
                                <option value="支票">支票</option>
                                <option value="信用卡">信用卡</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">付款人</label>
                    <input type="text" class="form-control" name="payer">
                </div>
                <div class="mb-3">
                    <label class="form-label">說明</label>
                    <textarea class="form-control" rows="2" name="description"></textarea>
                </div>
            </form>
        `;
        
        $('#editModalTitle').text('新增收入');
        $('#editModalBody').html(modalBody);
        $('#editModal').modal('show');
    }

    function showAddExpenseModal() {
        editingType = 'expense';
        editingItem = null;
        
        const modalBody = `
            <form id="expenseForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">日期 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="date" value="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">金額 <span class="text-danger">*</span></label>
                            <input type="number" class="form-control currency-input" name="amount" min="0" step="1" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">會計科目</label>
                            <select class="form-select" name="account">
                                ${(currentData.accounts || [])
                                    .filter(acc => acc.type === '支出')
                                    .map(acc => `<option value="${acc.name}">${acc.name}</option>`)
                                    .join('')}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">付款方式</label>
                            <select class="form-select" name="method">
                                <option value="現金">現金</option>
                                <option value="轉帳">轉帳</option>
                                <option value="支票">支票</option>
                                <option value="信用卡">信用卡</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">收款人</label>
                            <input type="text" class="form-control" name="payee">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">狀態</label>
                            <select class="form-select" name="status">
                                <option value="待審核">待審核</option>
                                <option value="已核准">已核准</option>
                                <option value="已拒絕">已拒絕</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">說明</label>
                    <textarea class="form-control" rows="2" name="description"></textarea>
                </div>
            </form>
        `;
        
        $('#editModalTitle').text('新增支出');
        $('#editModalBody').html(modalBody);
        $('#editModal').modal('show');
    }

    // 儲存資料
    async function saveData() {
        try {
            const form = $(`#${editingType}Form`)[0];
            if (!form) return;

            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            let action;
            if (editingItem) {
                data.id = editingItem.id;
                action = `update${editingType.charAt(0).toUpperCase() + editingType.slice(1)}`;
            } else {
                action = `add${editingType.charAt(0).toUpperCase() + editingType.slice(1)}`;
            }

            await callGAS(action, data);
            
            $('#editModal').modal('hide');
            showToast('資料儲存成功', 'success');
            
            // 重新載入當前頁面
            await loadPage(currentPage);
            
        } catch (error) {
            showToast('儲存失敗', 'error');
            console.error('儲存錯誤:', error);
        }
    }

    // 編輯功能
    async function editMember(id) {
        const member = currentData.members.find(m => m.id === id);
        if (!member) return;
        
        editingType = 'member';
        editingItem = member;
        
        const modalBody = `
            <form id="memberForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">姓名 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="name" value="${member.name || ''}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">電話</label>
                            <input type="text" class="form-control phone-input" name="phone" value="${member.phone || ''}">
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">電子郵件</label>
                    <input type="email" class="form-control" name="email" value="${member.email || ''}">
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">會員類型</label>
                            <select class="form-select" name="type">
                                <option value="一般會員" ${member.type === '一般會員' ? 'selected' : ''}>一般會員</option>
                                <option value="榮譽會員" ${member.type === '榮譽會員' ? 'selected' : ''}>榮譽會員</option>
                                <option value="贊助會員" ${member.type === '贊助會員' ? 'selected' : ''}>贊助會員</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">狀態</label>
                            <select class="form-select" name="status">
                                <option value="正常" ${member.status === '正常' ? 'selected' : ''}>正常</option>
                                <option value="暫停" ${member.status === '暫停' ? 'selected' : ''}>暫停</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">加入日期</label>
                    <input type="date" class="form-control" name="joinDate" value="${member.joinDate || ''}">
                </div>
            </form>
        `;
        
        $('#editModalTitle').text('編輯會員');
        $('#editModalBody').html(modalBody);
        $('#editModal').modal('show');
    }

    // 刪除功能
    async function deleteMember(id) {
        if (!confirm('確定要刪除這個會員嗎？此操作無法復原。')) return;
        
        try {
            await callGAS('deleteMember', { id });
            showToast('會員刪除成功', 'success');
            await loadMembers();
        } catch (error) {
            showToast('刪除失敗', 'error');
            console.error('刪除錯誤:', error);
        }
    }

    // 系統維護功能
    async function systemHealthCheck() {
        try {
            showLoading('正在進行系統健康檢查...');
            const result = await callGAS('systemHealthCheck');
            showToast('系統健康檢查完成，一切正常', 'success');
        } catch (error) {
            showToast('系統檢查發現問題', 'warning');
        }
    }

    async function createBackup() {
        try {
            showLoading('正在建立系統備份...');
            const result = await callGAS('createBackup');
            showToast('系統備份建立完成', 'success');
        } catch (error) {
            showToast('備份建立失敗', 'error');
        }
    }

    async function saveOrganizationSettings() {
        try {
            const form = document.getElementById('organizationForm');
            const formData = new FormData(form);
            const settings = {};
            
            for (let [key, value] of formData.entries()) {
                settings[key] = value;
            }

            await callGAS('updateSettings', settings);
            showToast('設定已儲存', 'success');
        } catch (error) {
            showToast('設定儲存失敗', 'error');
        }
    }

    async function syncAllData() {
        try {
            showLoading('正在同步所有資料...');
            await callGAS('syncAllData');
            showToast('資料同步完成', 'success');
            await loadPage(currentPage);
        } catch (error) {
            showToast('資料同步失敗', 'error');
        }
    }

    // 初始化圖表
    function initializeChart(monthlyData) {
        const ctx = document.getElementById('incomeExpenseChart');
        if (!ctx || !monthlyData || monthlyData.length === 0) return;

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlyData.map(item => item.month),
                datasets: [{
                    label: '收入',
                    data: monthlyData.map(item => item.income || 0),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }, {
                    label: '支出',
                    data: monthlyData.map(item => item.expense || 0),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '月度收入支出趨勢'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // 離線模式
    function loadOfflineMode() {
        const html = `
            <div class="text-center py-5">
                <i class="fas fa-cloud-slash fa-5x text-muted mb-4"></i>
                <h3>無法連接到雲端資料庫</h3>
                <p class="text-muted">請檢查網路連線或聯繫系統管理員</p>
                <button class="btn btn-primary" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> 重新連線
                </button>
            </div>
        `;
        $('#content-area').html(html);
    }

    // 工具函數
    function formatCurrency(amount) {
        return new Intl.NumberFormat('zh-TW').format(amount || 0);
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW');
    }

    function showLoading(text = '載入中...') {
        $('#loadingText').text(text);
        $('#loadingOverlay').show();
    }

    function hideLoading() {
        $('#loadingOverlay').hide();
    }

    function showToast(message, type = 'info') {
        const toastId = 'toast-' + Date.now();
        const bgClass = {
            'success': 'bg-success',
            'error': 'bg-danger',
            'warning': 'bg-warning',
            'info': 'bg-info'
        }[type] || 'bg-info';

        const icon = {
            'success': 'fas fa-check-circle',
            'error': 'fas fa-exclamation-triangle',
            'warning': 'fas fa-exclamation-circle',
            'info': 'fas fa-info-circle'
        }[type] || 'fas fa-info-circle';

        const toastHtml = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
                <div class="toast-header ${bgClass} text-white">
                    <i class="${icon} me-2"></i>
                    <strong class="me-auto">系統通知</strong>
                    <small class="text-white-50">${new Date().toLocaleTimeString('zh-TW')}</small>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;

        $('#toastContainer').append(toastHtml);
        const toast = new bootstrap.Toast(document.getElementById(toastId));
        toast.show();

        setTimeout(() => {
            $(`#${toastId}`).remove();
        }, 4000);
    }

    // 搜尋功能
    function searchTable(searchTerm, tableSelector) {
        const table = $(tableSelector);
        const rows = table.find('tbody tr');
        
        if (!searchTerm) {
            rows.show();
            return;
        }
        
        rows.each(function() {
            const row = $(this);
            const text = row.text().toLowerCase();
            if (text.includes(searchTerm.toLowerCase())) {
                row.show();
            } else {
                row.hide();
            }
        });
    }

    // 匯出功能
    function exportToCSV(tableSelector, filename) {
        const table = $(tableSelector);
        const rows = table.find('tr:visible');
        let csvContent = '';
        
        rows.each(function() {
            const row = $(this);
            const cells = row.find('th, td');
            const rowData = [];
            
            cells.each(function() {
                let cellText = $(this).text().trim();
                if ($(this).find('button, .btn').length > 0) {
                    cellText = '';
                }
                rowData.push('"' + cellText.replace(/"/g, '""') + '"');
            });
            
            if (rowData.some(cell => cell !== '""')) {
                csvContent += rowData.join(',') + '\n';
            }
        });
        
        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename + '.csv';
        link.click();
        
        URL.revokeObjectURL(link.href);
        showToast('檔案匯出完成', 'success');
    }

    // 其他功能函數
    function refreshDashboard() {
        loadDashboard();
    }

    function toggleAllReceipts() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.receipt-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
    }

    function confirmReset() {
        if (confirm('確定要重置所有設定嗎？此操作無法復原。')) {
            showToast('設定重置完成', 'warning');
        }
    }

    function logout() {
        if (confirm('確定要登出嗎？')) {
            showToast('已登出系統', 'info');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        }
    }

    // 響應式處理和事件綁定
    $(window).on('resize', function() {
        if (window.innerWidth >= 768) {
            $('#sidebarMenu').removeClass('show');
        }
    });

    $('.navbar-toggler').on('click', function() {
        $('#sidebarMenu').toggleClass('show');
    });

    $(document).on('click', function(e) {
        if (window.innerWidth < 768) {
            if (!$(e.target).closest('#sidebarMenu, .navbar-toggler').length) {
                $('#sidebarMenu').removeClass('show');
            }
        }
    });

    // 表格排序功能
    $(document).on('click', 'th[data-sort]', function() {
        const column = $(this).data('sort');
        const table = $(this).closest('table');
        const tbody = table.find('tbody');
        const rows = tbody.find('tr').toArray();
        
        const isAscending = $(this).hasClass('sort-asc');
        
        table.find('th').removeClass('sort-asc sort-desc');
        $(this).addClass(isAscending ? 'sort-desc' : 'sort-asc');
        
        rows.sort((a, b) => {
            const aText = $(a).find('td').eq($(this).index()).text().trim();
            const bText = $(b).find('td').eq($(this).index()).text().trim();
            
            if (!isNaN(aText.replace(/[$,]/g, '')) && !isNaN(bText.replace(/[$,]/g, ''))) {
                const aNum = parseFloat(aText.replace(/[$,]/g, ''));
                const bNum = parseFloat(bText.replace(/[$,]/g, ''));
                return isAscending ? bNum - aNum : aNum - bNum;
            }
            
            if (isAscending) {
                return bText.localeCompare(aText, 'zh-TW');
            } else {
                return aText.localeCompare(bText, 'zh-TW');
            }
        });
        
        tbody.empty().append(rows);
    });

    // 自動儲存功能
    let autoSaveTimeout;
    $(document).on('input', '.auto-save', function() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(async () => {
            try {
                const fieldName = $(this).attr('name');
                const fieldValue = $(this).val();
                await callGAS('autoSave', { field: fieldName, value: fieldValue });
                console.log('自動儲存:', fieldName, fieldValue);
            } catch (error) {
                console.error('自動儲存失敗:', error);
            }
        }, 2000);
    });

    // 表單驗證
    $(document).on('submit', 'form', function(e) {
        const form = $(this);
        let isValid = true;
        
        form.find('[required]').each(function() {
            if (!$(this).val().trim()) {
                $(this).addClass('is-invalid');
                isValid = false;
            } else {
                $(this).removeClass('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            showToast('請填寫所有必填欄位', 'error');
            return false;
        }
    });

    // 數字和格式化輸入
    $(document).on('input', '.currency-input', function() {
        let value = $(this).val().replace(/[^\d]/g, '');
        if (value) {
            $(this).val(parseInt(value));
        }
    });

    $(document).on('input', '.phone-input', function() {
        let value = $(this).val().replace(/\D/g, '');
        if (value.length >= 4) {
            value = value.replace(/(\d{4})(\d{3})(\d{3})/, '$1-$2-$3');
        }
        $(this).val(value);
    });

    $(document).on('input', '.tax-id-input', function() {
        let value = $(this).val().replace(/\D/g, '');
        if (value.length > 8) {
            value = value.substring(0, 8);
        }
        $(this).val(value);
    });

    // 網路狀態檢測
    window.addEventListener('online', function() {
        updateConnectionStatus(true);
        showToast('網路連線已恢復', 'success');
    });

    window.addEventListener('offline', function() {
        updateConnectionStatus(false);
        showToast('網路連線中斷', 'warning');
    });

    console.log('台灣帕金森病友權益促進會財務管理系統 - GAS整合版');
    console.log('系統版本: 1.0.0');
    console.log('載入完成時間:', new Date().toLocaleString('zh-TW'));
    console.log('請確保已正確設定 GAS_URL 變數');

</script>
</body> 
</html>
