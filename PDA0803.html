<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會 - 管理系統</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%232c3e50'/%3E%3Cpath d='M30 40h40v20H30z' fill='%23fff'/%3E%3Ccircle cx='40' cy='50' r='8' fill='%23e74c3c'/%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%232c3e50'/%3E%3Cpath d='M30 40h40v20H30z' fill='%23fff'/%3E%3Ccircle cx='40' cy='50' r='8' fill='%23e74c3c'/%3E%3C/svg%3E">
  
  <!-- Meta tags for SEO and social sharing -->
  <meta name="description" content="台灣帕金森病友權益促進會管理系統 - 會員管理、財務管理、報表分析">
  <meta name="keywords" content="帕金森,病友會,會員管理,財務管理">
  <meta name="author" content="台灣帕金森病友權益促進會">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://lch2988.github.io/PDA/PDA0803.html">
  <meta property="og:title" content="台灣帕金森病友權益促進會 - 管理系統">
  <meta property="og:description" content="專業的病友會管理系統，提供會員管理、財務管理、報表分析等功能">
  <meta property="og:image" content="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%232c3e50'/%3E%3Cpath d='M30 40h40v20H30z' fill='%23fff'/%3E%3Ccircle cx='40' cy='50' r='8' fill='%23e74c3c'/%3E%3C/svg%3E">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://lch2988.github.io/PDA/PDA0803.html">
  <meta property="twitter:title" content="台灣帕金森病友權益促進會 - 管理系統">
  <meta property="twitter:description" content="專業的病友會管理系統，提供會員管理、財務管理、報表分析等功能">
  
  <!-- Preload critical resources -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  
  <!-- CSS Libraries -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  
  <style>
      :root {
          --primary-color: #2c3e50;
          --secondary-color: #3498db;
          --success-color: #27ae60;
          --warning-color: #f39c12;
          --danger-color: #e74c3c;
          --light-bg: #ecf0f1;
      }

      body {
          font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background-color: #f8f9fa;
          margin: 0;
          padding: 0;
      }

      .navbar {
          background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      .navbar-brand {
          font-weight: bold;
          font-size: 1.3rem;
      }

      .sidebar {
          background: white;
          min-height: calc(100vh - 76px);
          box-shadow: 2px 0 10px rgba(0,0,0,0.1);
          padding: 0;
      }

      .sidebar .nav-link {
          color: var(--primary-color);
          padding: 15px 20px;
          border-bottom: 1px solid #eee;
          transition: all 0.3s ease;
      }

      .sidebar .nav-link:hover {
          background-color: var(--light-bg);
          color: var(--secondary-color);
          transform: translateX(5px);
      }

      .sidebar .nav-link.active {
          background-color: var(--secondary-color);
          color: white;
          border-left: 4px solid var(--primary-color);
      }

      .main-content {
          padding: 30px;
          min-height: calc(100vh - 76px);
      }

      .page-header {
          background: white;
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          margin-bottom: 30px;
      }

      .page-header h2 {
          color: var(--primary-color);
          margin: 0;
          font-weight: 600;
      }

      .stats-card {
          background: white;
          border-radius: 10px;
          padding: 25px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          transition: transform 0.3s ease;
          border-left: 4px solid;
      }

      .stats-card:hover {
          transform: translateY(-5px);
      }

      .stats-card.primary { border-left-color: var(--primary-color); }
      .stats-card.success { border-left-color: var(--success-color); }
      .stats-card.warning { border-left-color: var(--warning-color); }
      .stats-card.danger { border-left-color: var(--danger-color); }

      .stats-card .icon {
          font-size: 2.5rem;
          opacity: 0.7;
      }

      .stats-card .number {
          font-size: 2rem;
          font-weight: bold;
          margin: 10px 0;
      }

      .card {
          border: none;
          border-radius: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          margin-bottom: 30px;
      }

      .card-header {
          background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
          color: white;
          border-radius: 10px 10px 0 0 !important;
          padding: 15px 20px;
      }

      .btn-primary {
          background: var(--secondary-color);
          border-color: var(--secondary-color);
      }

      .btn-primary:hover {
          background: var(--primary-color);
          border-color: var(--primary-color);
      }

      .table {
          background: white;
      }

      .table th {
          background-color: var(--light-bg);
          color: var(--primary-color);
          font-weight: 600;
          border: none;
      }

      .badge {
          font-size: 0.8rem;
          padding: 5px 10px;
      }

      .form-control:focus {
          border-color: var(--secondary-color);
          box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
      }

      .modal-header {
          background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
          color: white;
      }

      .loading {
          display: none;
          text-align: center;
          padding: 50px;
      }

      .spinner-border {
          color: var(--secondary-color);
      }

      .search-box {
          background: white;
          border-radius: 10px;
          padding: 20px;
          margin-bottom: 20px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      .action-buttons .btn {
          margin-right: 5px;
          margin-bottom: 5px;
      }

      /* 錯誤處理樣式 */
      .error-message {
          background: #fee;
          border: 1px solid #fcc;
          color: #c66;
          padding: 10px;
          border-radius: 5px;
          margin: 10px 0;
      }

      .success-message {
          background: #efe;
          border: 1px solid #cfc;
          color: #6c6;
          padding: 10px;
          border-radius: 5px;
          margin: 10px 0;
      }

      /* 載入狀態 */
      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }

      .loading-spinner {
          background: white;
          padding: 30px;
          border-radius: 10px;
          text-align: center;
      }

      @media (max-width: 768px) {
          .sidebar {
              position: fixed;
              left: -250px;
              width: 250px;
              z-index: 1000;
              transition: left 0.3s ease;
          }

          .sidebar.show {
              left: 0;
          }

          .main-content {
              margin-left: 0;
              padding: 20px 15px;
          }

          .stats-card {
              margin-bottom: 20px;
          }
      }

      .page-section {
          display: none;
      }

      .page-section.active {
          display: block;
      }

      .chart-container {
          background: white;
          border-radius: 10px;
          padding: 20px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          margin-bottom: 30px;
      }

      /* 無障礙改善 */
      .btn:focus,
      .form-control:focus,
      .nav-link:focus {
          outline: 2px solid var(--secondary-color);
          outline-offset: 2px;
      }

      /* 列印樣式 */
      @media print {
          .sidebar,
          .navbar,
          .btn,
          .modal {
              display: none !important;
          }
          
          .main-content {
              margin-left: 0;
              padding: 0;
          }
      }
  </style>
</head>
<body>
  <!-- 載入覆蓋層 -->
  <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner">
          <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">載入中...</span>
          </div>
          <div class="mt-3">處理中，請稍候...</div>
      </div>
  </div>

  <!-- 導航列 -->
  <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
          <button class="navbar-toggler d-lg-none" type="button" id="sidebarToggle" aria-label="切換側邊欄">
              <span class="navbar-toggler-icon"></span>
          </button>
          <a class="navbar-brand" href="#" aria-label="回到首頁">
              <i class="fas fa-heartbeat me-2" aria-hidden="true"></i>
              台灣帕金森病友權益促進會
          </a>
          <div class="navbar-nav ms-auto">
              <div class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="fas fa-user-circle me-1" aria-hidden="true"></i>管理員
                  </a>
                  <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2" aria-hidden="true"></i>系統設定</a></li>
                      <li><a class="dropdown-item" href="#"><i class="fas fa-download me-2" aria-hidden="true"></i>資料備份</a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item" href="#"><i class="fas fa-sign-out-alt me-2" aria-hidden="true"></i>登出</a></li>
                  </ul>
              </div>
          </div>
      </div>
  </nav>

  <div class="container-fluid">
      <div class="row">
          <!-- 側邊欄 -->
          <div class="col-lg-2 p-0">
              <div class="sidebar" id="sidebar">
                  <nav class="nav flex-column" role="navigation">
                      <a class="nav-link active" href="#" data-page="dashboard" role="button" aria-current="page">
                          <i class="fas fa-tachometer-alt me-2" aria-hidden="true"></i>儀表板
                      </a>
                      <a class="nav-link" href="#" data-page="members" role="button">
                          <i class="fas fa-users me-2" aria-hidden="true"></i>會員管理
                      </a>
                      <a class="nav-link" href="#" data-page="finance" role="button">
                          <i class="fas fa-money-bill-wave me-2" aria-hidden="true"></i>財務管理
                      </a>
                      <a class="nav-link" href="#" data-page="reports" role="button">
                          <i class="fas fa-chart-bar me-2" aria-hidden="true"></i>報表分析
                      </a>
                      <a class="nav-link" href="#" data-page="settings" role="button">
                          <i class="fas fa-cog me-2" aria-hidden="true"></i>系統設定
                      </a>
                  </nav>
              </div>
          </div>

          <!-- 主要內容區 -->
          <div class="col-lg-10">
              <div class="main-content">
                  <!-- 儀表板頁面 -->
                  <div id="dashboard" class="page-section active">
                      <div class="page-header">
                          <h2><i class="fas fa-tachometer-alt me-2" aria-hidden="true"></i>系統儀表板</h2>
                          <p class="mb-0 text-muted">歡迎使用台灣帕金森病友權益促進會管理系統</p>
                      </div>

                      <!-- 統計卡片 -->
                      <div class="row mb-4">
                          <div class="col-md-3">
                              <div class="stats-card primary">
                                  <div class="d-flex justify-content-between align-items-center">
                                      <div>
                                          <h6 class="text-muted">會員總數</h6>
                                          <div class="number text-primary" id="totalMembers" aria-label="會員總數">0</div>
                                      </div>
                                      <div class="icon text-primary" aria-hidden="true">
                                          <i class="fas fa-users"></i>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <div class="col-md-3">
                              <div class="stats-card success">
                                  <div class="d-flex justify-content-between align-items-center">
                                      <div>
                                          <h6 class="text-muted">有效會員</h6>
                                          <div class="number text-success" id="activeMembers" aria-label="有效會員數">0</div>
                                      </div>
                                      <div class="icon text-success" aria-hidden="true">
                                          <i class="fas fa-user-check"></i>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <div class="col-md-3">
                              <div class="stats-card warning">
                                  <div class="d-flex justify-content-between align-items-center">
                                      <div>
                                          <h6 class="text-muted">本月收入</h6>
                                          <div class="number text-warning" id="monthlyIncome" aria-label="本月收入">$0</div>
                                      </div>
                                      <div class="icon text-warning" aria-hidden="true">
                                          <i class="fas fa-arrow-up"></i>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <div class="col-md-3">
                              <div class="stats-card danger">
                                  <div class="d-flex justify-content-between align-items-center">
                                      <div>
                                          <h6 class="text-muted">當前餘額</h6>
                                          <div class="number text-info" id="currentBalance" aria-label="當前餘額">$0</div>
                                      </div>
                                      <div class="icon text-info" aria-hidden="true">
                                          <i class="fas fa-wallet"></i>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <!-- 快速操作 -->
                      <div class="row">
                          <div class="col-md-6">
                              <div class="card">
                                  <div class="card-header">
                                      <h5 class="mb-0"><i class="fas fa-plus-circle me-2" aria-hidden="true"></i>快速操作</h5>
                                  </div>
                                  <div class="card-body">
                                      <div class="d-grid gap-2">
                                          <button class="btn btn-primary" onclick="showAddMemberModal()" type="button">
                                              <i class="fas fa-user-plus me-2" aria-hidden="true"></i>新增會員
                                          </button>
                                          <button class="btn btn-success" onclick="showAddFeeModal()" type="button">
                                              <i class="fas fa-money-bill me-2" aria-hidden="true"></i>記錄會費
                                          </button>
                                          <button class="btn btn-info" onclick="showAddDonationModal()" type="button">
                                              <i class="fas fa-heart me-2" aria-hidden="true"></i>記錄捐款
                                          </button>
                                          <button class="btn btn-warning" onclick="showAddExpenseModal()" type="button">
                                              <i class="fas fa-receipt me-2" aria-hidden="true"></i>記錄支出
                                          </button>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="card">
                                  <div class="card-header">
                                      <h5 class="mb-0"><i class="fas fa-bell me-2" aria-hidden="true"></i>系統通知</h5>
                                  </div>
                                  <div class="card-body">
                                      <div id="notifications">
                                          <div class="alert alert-info alert-sm">
                                              <i class="fas fa-info-circle me-2" aria-hidden="true"></i>系統運行正常
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- 其他頁面內容保持不變... -->
                  <!-- 為了避免重複，這裡省略其他頁面的HTML -->
              </div>
          </div>
      </div>
  </div>

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
      // 錯誤處理和性能優化
      window.addEventListener('error', function(e) {
          console.error('JavaScript 錯誤:', e.error);
          showError('系統發生錯誤，請重新整理頁面');
      });

      window.addEventListener('unhandledrejection', function(e) {
          console.error('未處理的 Promise 錯誤:', e.reason);
          showError('網路請求失敗，請檢查網路連線');
      });

      // 全域變數
      const GAS_URL = 'YOUR_GAS_WEB_APP_URL'; // 請替換為您的 GAS Web App URL
      let currentMembers = [];
      let currentFinanceRecords = [];

      // 頁面初始化
      document.addEventListener('DOMContentLoaded', function() {
          try {
              initializePage();
              loadDashboardData();
              setupEventListeners();
              updateSystemInfo();
          } catch (error) {
              console.error('頁面初始化失敗:', error);
              showError('頁面載入失敗，請重新整理');
          }
      });

      // 初始化頁面
      function initializePage() {
          // 設定當前日期
          const today = new Date().toISOString().split('T')[0];
          document.querySelectorAll('input[type="date"]').forEach(input => {
              if (!input.value) {
                  input.value = today;
              }
          });

          // 設定年度選項
          const currentYear = new Date().getFullYear();
          document.querySelectorAll('select[name="year"]').forEach(select => {
              for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                  const option = document.createElement('option');
                  option.value = year;
                  option.textContent = year + '年';
                  if (year === currentYear) option.selected = true;
                  select.appendChild(option);
              }
          });
      }

      // 改進的載入狀態管理
      function showLoading(show) {
          const overlay = document.getElementById('loadingOverlay');
          if (show) {
              overlay.style.display = 'flex';
          } else {
              overlay.style.display = 'none';
          }
      }

      // 改進的錯誤處理
      function showError(message) {
          Swal.fire({
              title: '錯誤',
              text: message,
              icon: 'error',
              confirmButtonText: '確定',
              customClass: {
                  confirmButton: 'btn btn-primary'
              }
          });
      }

      function showSuccess(message) {
          Swal.fire({
              title: '成功',
              text: message,
              icon: 'success',
              confirmButtonText: '確定',
              customClass: {
                  confirmButton: 'btn btn-primary'
              }
          });
      }

      // 載入儀表板資料
      async function loadDashboardData() {
          try {
              showLoading(true);
              
              // 模擬 API 呼叫
              const stats = await mockApiCall('getDashboardStats');
              
              document.getElementById('totalMembers').textContent = stats.totalMembers || 0;
              document.getElementById('activeMembers').textContent = stats.activeMembers || 0;
              document.getElementById('monthlyIncome').textContent = '$' + (stats.monthlyIncome || 0).toLocaleString();
              document.getElementById('currentBalance').textContent = '$' + (stats.currentBalance || 0).toLocaleString();

              showLoading(false);
          } catch (error) {
              console.error('載入儀表板資料失敗:', error);
              showError('載入資料失敗');
              showLoading(false);
          }
      }

      // 模擬 API 呼叫
      async function mockApiCall(functionName, data) {
          // 模擬網路延遲
          await new Promise(resolve => setTimeout(resolve, 800));
          
          switch(functionName) {
              case 'getDashboardStats':
                  return {
                      totalMembers: 105,
                      activeMembers: 98,
                      monthlyIncome: 65000,
                      currentBalance: 250000
                  };
              default:
                  return { success: true, message: '操作完成' };
          }
      }

      // 設定事件監聽器
      function setupEventListeners() {
          // 側邊欄導航
          document.querySelectorAll('.sidebar .nav-link').forEach(link => {
              link.addEventListener('click', function(e) {
                  e.preventDefault();
                  const page = this.dataset.page;
                  showPage(page);
                  
                  // 更新導航狀態
                  document.querySelectorAll('.sidebar .nav-link').forEach(l => {
                      l.classList.remove('active');
                      l.removeAttribute('aria-current');
                  });
                  this.classList.add('active');
                  this.setAttribute('aria-current', 'page');
              });
          });

          // 手機版側邊欄切換
          const sidebarToggle = document.getElementById('sidebarToggle');
          if (sidebarToggle) {
              sidebarToggle.addEventListener('click', function() {
                  document.getElementById('sidebar').classList.toggle('show');
              });
          }
      }

      // 顯示頁面
      function showPage(pageId) {
          document.querySelectorAll('.page-section').forEach(section => {
              section.classList.remove('active');
          });
          
          const targetPage = document.getElementById(pageId);
          if (targetPage) {
              targetPage.classList.add('active');
          }
      }

      // Modal 顯示函數
      function showAddMemberModal() {
          showError('此功能需要連接後端系統才能使用');
      }

      function showAddFeeModal() {
          showError('此功能需要連接後端系統才能使用');
      }

      function showAddDonationModal() {
          showError('此功能需要連接後端系統才能使用');
      }

      function showAddExpenseModal() {
          showError('此功能需要連接後端系統才能使用');
      }

      // 更新系統資訊
      function updateSystemInfo() {
          const lastUpdateElement = document.getElementById('lastUpdate');
          if (lastUpdateElement) {
              lastUpdateElement.textContent = new Date().toLocaleString('zh-TW');
          }
      }

      // 鍵盤導航支援
      document.addEventListener('keydown', function(e) {
          // ESC 鍵關閉 modal
          if (e.key === 'Escape') {
              const modals = document.querySelectorAll('.modal.show');
              modals.forEach(modal => {
                  const modalInstance = bootstrap.Modal.getInstance(modal);
                  if (modalInstance) modalInstance.hide();
              });
          }
      });

      // 性能監控
      window.addEventListener('load', function() {
          if ('performance' in window) {
              const loadTime = performance.now();
              console.log(`頁面載入時間: ${loadTime.toFixed(2)}ms`);
          }
      });
  </script>
</body>
</html>
