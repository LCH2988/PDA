<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .active-tab {
      background-color: #059669;
      color: white;
    }
    .loading {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- 載入畫面 -->
  <div id="loading-screen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
    <div class="text-center">
      <div class="loading w-12 h-12 border-4 border-green-200 border-t-green-600 rounded-full mx-auto mb-4"></div>
      <p class="text-gray-600">載入中...</p>
    </div>
  </div>

  <!-- 主要內容 -->
  <div id="main-content" class="hidden">
    <!-- 頂部導航 -->
    <header class="bg-green-600 text-white p-4 shadow-lg">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <i class="fas fa-heartbeat text-2xl mr-3"></i>
          <div>
            <h1 class="text-lg font-bold">台灣帕金森病友權益促進會</h1>
            <p id="welcome-text" class="text-sm opacity-90">歡迎使用</p>
          </div>
        </div>
        <button id="menu-btn" class="text-2xl">
          <i class="fas fa-bars"></i>
        </button>
      </div>
    </header>

    <!-- 底部導航 -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
      <div class="flex">
        <button onclick="showPage('home')" class="nav-btn flex-1 py-3 px-2 text-center">
          <i class="fas fa-home text-xl mb-1"></i>
          <p class="text-xs">首頁</p>
        </button>
        <button onclick="showPage('events')" class="nav-btn flex-1 py-3 px-2 text-center">
          <i class="fas fa-calendar text-xl mb-1"></i>
          <p class="text-xs">活動</p>
        </button>
        <button onclick="showPage('medical')" class="nav-btn flex-1 py-3 px-2 text-center">
          <i class="fas fa-stethoscope text-xl mb-1"></i>
          <p class="text-xs">醫療</p>
        </button>
        <button onclick="showPage('resources')" class="nav-btn flex-1 py-3 px-2 text-center">
          <i class="fas fa-book-open text-xl mb-1"></i>
          <p class="text-xs">資源</p>
        </button>
        <button onclick="showPage('member')" class="nav-btn flex-1 py-3 px-2 text-center">
          <i class="fas fa-user text-xl mb-1"></i>
          <p class="text-xs">會員</p>
        </button>
      </div>
    </nav>

    <!-- 頁面內容 -->
    <main class="pb-20 min-h-screen">
      <!-- 首頁 -->
      <div id="home-page" class="page p-4">
        <!-- 會員狀態卡片 -->
        <div id="member-status-card" class="bg-white rounded-lg shadow-md p-4 mb-6">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-semibold text-gray-800">會員狀態</h3>
              <p id="member-status-text" class="text-gray-600">載入中...</p>
            </div>
            <div class="text-green-600">
              <i class="fas fa-user-circle text-3xl"></i>
            </div>
          </div>
        </div>

        <!-- 快速功能 -->
        <div class="grid grid-cols-2 gap-4 mb-6">
          <button onclick="showPage('events')" class="bg-white rounded-lg shadow-md p-4 text-center hover:shadow-lg transition-shadow">
            <i class="fas fa-calendar-plus text-3xl text-blue-600 mb-2"></i>
            <p class="font-semibold text-gray-800">活動報名</p>
            <p class="text-sm text-gray-600">參與各種活動</p>
          </button>
          
          <button onclick="showPage('medical')" class="bg-white rounded-lg shadow-md p-4 text-center hover:shadow-lg transition-shadow">
            <i class="fas fa-user-md text-3xl text-red-600 mb-2"></i>
            <p class="font-semibold text-gray-800">醫療預約</p>
            <p class="text-sm text-gray-600">預約醫療服務</p>
          </button>
          
          <button onclick="showDonationOptions()" class="bg-white rounded-lg shadow-md p-4 text-center hover:shadow-lg transition-shadow">
            <i class="fas fa-heart text-3xl text-pink-600 mb-2"></i>
            <p class="font-semibold text-gray-800">愛心捐款</p>
            <p class="text-sm text-gray-600">支持病友服務</p>
          </button>
          
          <button onclick="showVolunteerOptions()" class="bg-white rounded-lg shadow-md p-4 text-center hover:shadow-lg transition-shadow">
            <i class="fas fa-hands-helping text-3xl text-orange-600 mb-2"></i>
            <p class="font-semibold text-gray-800">志工服務</p>
            <p class="text-sm text-gray-600">加入志工行列</p>
          </button>
        </div>

        <!-- 最新消息 -->
        <div class="bg-white rounded-lg shadow-md p-4">
          <h3 class="text-lg font-semibold mb-4">
            <i class="fas fa-bullhorn mr-2 text-yellow-600"></i>最新消息
          </h3>
          <div id="news-list" class="space-y-3">
            <!-- 動態載入消息 -->
          </div>
        </div>
      </div>

      <!-- 活動頁面 -->
      <div id="events-page" class="page hidden p-4">
        <div class="mb-4">
          <h2 class="text-xl font-bold mb-4">
            <i class="fas fa-calendar mr-2 text-blue-600"></i>活動報名
          </h2>
          <!-- 活動分類篩選 -->
          <div class="flex space-x-2 mb-4 overflow-x-auto">
            <button onclick="filterEvents('all')" class="category-filter px-4 py-2 rounded-full bg-blue-600 text-white text-sm whitespace-nowrap">
              全部
            </button>
            <button onclick="filterEvents('衛教講座')" class="category-filter px-4 py-2 rounded-full bg-gray-200 text-gray-700 text-sm whitespace-nowrap">
              衛教講座
            </button>
            <button onclick="filterEvents('復健運動')" class="category-filter px-4 py-2 rounded-full bg-gray-200 text-gray-700 text-sm whitespace-nowrap">
              復健運動
            </button>
            <button onclick="filterEvents('聯誼活動')" class="category-filter px-4 py-2 rounded-full bg-gray-200 text-gray-700 text-sm whitespace-nowrap">
              聯誼活動
            </button>
          </div>
        </div>
        <div id="events-list" class="space-y-4">
          <!-- 動態載入活動 -->
        </div>
      </div>

      <!-- 醫療服務頁面 -->
      <div id="medical-page" class="page hidden p-4">
        <!-- 動態載入醫療服務 -->
      </div>

      <!-- 資源中心頁面 -->
      <div id="resources-page" class="page hidden p-4">
        <!-- 動態載入資源 -->
      </div>

      <!-- 會員頁面 -->
      <div id="member-page" class="page hidden p-4">
        <div id="member-info" class="hidden">
          <!-- 已註冊會員資訊 -->
          <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="text-center mb-4">
              <i class="fas fa-user-circle text-6xl text-green-600 mb-2"></i>
              <h3 class="text-xl font-semibold" id="member-name">會員姓名</h3>
              <p class="text-gray-600" id="member-id">會員編號</p>
            </div>
            
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-gray-600">電話：</span>
                <span id="member-phone">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">信箱：</span>
                <span id="member-email">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">加入日期：</span>
                <span id="member-join-date">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">會員狀態：</span>
                <span id="member-status" class="text-green-600 font-semibold">正常</span>
              </div>
            </div>
            
            <button onclick="editMemberInfo()" class="w-full mt-4 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
              <i class="fas fa-edit mr-2"></i>編輯資料
            </button>
          </div>

          <!-- 會員功能 -->
          <div class="grid grid-cols-2 gap-4">
            <button onclick="showMyEvents()" class="bg-white rounded-lg shadow-md p-4 text-center">
              <i class="fas fa-calendar-check text-3xl text-blue-600 mb-2"></i>
              <p class="font-semibold">我的活動</p>
            </button>
            
            <button onclick="showMyDonations()" class="bg-white rounded-lg shadow-md p-4 text-center">
              <i class="fas fa-receipt text-3xl text-green-600 mb-2"></i>
              <p class="font-semibold">捐款記錄</p>
            </button>
            
            <button onclick="showMyMedical()" class="bg-white rounded-lg shadow-md p-4 text-center">
              <i class="fas fa-stethoscope text-3xl text-red-600 mb-2"></i>
              <p class="font-semibold">醫療記錄</p>
            </button>
            
            <button onclick="showMyVolunteer()" class="bg-white rounded-lg shadow-md p-4 text-center">
              <i class="fas fa-hands-helping text-3xl text-orange-600 mb-2"></i>
              <p class="font-semibold">志工記錄</p>
            </button>
          </div>
        </div>

        <!-- 會員註冊表單 -->
        <div id="member-register" class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-xl font-semibold mb-4 text-center">
            <i class="fas fa-user-plus mr-2 text-green-600"></i>會員註冊
          </h3>
          
          <form id="register-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">姓名 *</label>
              <input type="text" name="name" required class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">電話 *</label>
              <input type="tel" name="phone" required class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">信箱 *</label>
              <input type="email" name="email" required class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">生日</label>
              <input type="date" name="birthday" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">地址</label>
              <textarea name="address" rows="2" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">緊急聯絡人</label>
              <input type="text" name="emergencyContact" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">緊急聯絡電話</label>
              <input type="tel" name="emergencyPhone" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">醫療資訊</label>
              <textarea name="medicalInfo" rows="3" placeholder="請填寫相關病史、用藥情況或特殊需求" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
            </div>
            
            <div class="flex items-start">
              <input type="checkbox" id="agree-terms" required class="mt-1 mr-2">
              <label for="agree-terms" class="text-sm text-gray-700">
                我同意遵守會員規範，並同意個人資料用於會務相關用途
              </label>
            </div>
            
            <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold">
              <i class="fas fa-user-plus mr-2"></i>完成註冊
            </button>
          </form>
        </div>
      </div>
    </main>
  </div>

  <!-- 捐款模態框 -->
  <div id="donation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">愛心捐款</h3>
            <button onclick="hideDonationModal()" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">選擇捐款金額</label>
              <div class="grid grid-cols-3 gap-2 mb-3">
                <button onclick="selectDonationAmount(500)" class="donation-amount border-2 border-gray-200 rounded-lg py-2 text-center hover:border-green-500">NT$ 500</button>
                <button onclick="selectDonationAmount(1000)" class="donation-amount border-2 border-gray-200 rounded-lg py-2 text-center hover:border-green-500">NT$ 1,000</button>
                <button onclick="selectDonationAmount(2000)" class="donation-amount border-2 border-gray-200 rounded-lg py-2 text-center hover:border-green-500">NT$ 2,000</button>
              </div>
              <input type="number" id="custom-amount" placeholder="自訂金額" min="100" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">捐款用途</label>
              <select id="donation-purpose" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                <option value="general">一般會務</option>
                <option value="medical">醫療補助</option>
                <option value="activity">活動經費</option>
                <option value="equipment">設備購置</option>
              </select>
            </div>
            
            <button onclick="processDonation()" class="w-full bg-pink-600 text-white py-3 rounded-lg hover:bg-pink-700 font-semibold">
              <i class="fas fa-heart mr-2"></i>立即捐款
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // 全域變數
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzxnN5to1Kugtwk6T8kcWO6osMSopdaozsjdqle8wJW2LxSVCL6psBisPWlOtPv678RTg/exec';
    let liffProfile = null;
    let memberData = null;
    let currentPage = 'home';
    let allEvents = [];

    // LIFF 初始化
    async function initializeLiff() {
      try {
        await liff.init({ liffId: '1656516134-VaGgmaPm' });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        
        // 取得用戶資料
        liffProfile = await liff.getProfile();
        
        // 更新歡迎文字
        document.getElementById('welcome-text').textContent = `歡迎 ${liffProfile.displayName}`;
        
        // 檢查會員狀態
        await checkMemberStatus();
        
        // 載入首頁資料
        await loadHomeData();
        
        // 隱藏載入畫面
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        
      } catch (error) {
        console.error('LIFF 初始化失敗:', error);
        alert('系統初始化失敗，請重新整理頁面');
      }
    }

    // 檢查會員狀態
    async function checkMemberStatus() {
      try {
        const response = await fetch(`${GAS_WEB_APP_URL}?action=getMember&lineId=${liffProfile.userId}`);
        const data = await response.json();
        
        if (data.success && data.member) {
          memberData = data.member;
          updateMemberStatusCard(true);
          showMemberInfo();
        } else {
          updateMemberStatusCard(false);
          showMemberRegister();
        }
      } catch (error) {
        console.error('檢查會員狀態失敗:', error);
        updateMemberStatusCard(false);
      }
    }

    // 更新會員狀態卡片
    function updateMemberStatusCard(isMember) {
      const statusText = document.getElementById('member-status-text');
      if (isMember && memberData) {
        statusText.innerHTML = `<span class="text-green-600 font-semibold">會員 ${memberData.name}</span><br><span class="text-sm">${memberData.id}</span>`;
      } else {
        statusText.innerHTML = `<span class="text-orange-600">尚未註冊會員</span><br><span class="text-sm">點擊會員頁面完成註冊</span>`;
      }
    }

    // 顯示會員資訊
    function showMemberInfo() {
      if (!memberData) return;
      
      document.getElementById('member-name').textContent = memberData.name;
      document.getElementById('member-id').textContent = memberData.id;
      document.getElementById('member-phone').textContent = memberData.phone || '-';
      document.getElementById('member-email').textContent = memberData.email || '-';
      document.getElementById('member-join-date').textContent = memberData.joinDate || '-';
      
      document.getElementById('member-info').classList.remove('hidden');
      document.getElementById('member-register').classList.add('hidden');
    }

    // 顯示會員註冊表單
    function showMemberRegister() {
      document.getElementById('member-info').classList.add('hidden');
      document.getElementById('member-register').classList.remove('hidden');
    }

    // 載入首頁資料
    async function loadHomeData() {
      await loadNews();
    }

    // 載入最新消息
    async function loadNews() {
      const newsList = document.getElementById('news-list');
      
      // 模擬新聞資料
      const news = [
        {
          title: '2024年度會員大會即將召開',
          date: '2024-03-15',
          content: '敬邀所有會員參與年度會員大會，共同討論會務發展方向。'
        },
        {
          title: '新增線上醫療諮詢服務',
          date: '2024-03-10',
          content: '為提供更便利的醫療服務，現已開放線上醫療諮詢預約。'
        },
        {
          title: '春季復健運動班開始報名',
          date: '2024-03-05',
          content: '專業物理治療師指導的復健運動班現正開放報名中。'
        }
      ];

      newsList.innerHTML = news.map(item => `
        <div class="border-l-4 border-green-500 pl-4 py-2">
          <h4 class="font-semibold text-gray-800">${item.title}</h4>
          <p class="text-sm text-gray-600 mt-1">${item.content}</p>
          <p class="text-xs text-gray-400 mt-1">${item.date}</p>
        </div>
      `).join('');
    }

    // 頁面切換
    function showPage(pageName) {
      // 隱藏所有頁面
      document.querySelectorAll('.page').forEach(page => {
        page.classList.add('hidden');
      });
      
      // 顯示指定頁面
      document.getElementById(pageName + '-page').classList.remove('hidden');
      
      // 更新導航狀態
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('text-green-600');
        btn.classList.add('text-gray-600');
      });
      event.target.closest('.nav-btn').classList.remove('text-gray-600');
      event.target.closest('.nav-btn').classList.add('text-green-600');
      
      currentPage = pageName;
      
      // 載入頁面資料
      loadPageData(pageName);
    }

    // 載入頁面資料
    async function loadPageData(pageName) {
      switch (pageName) {
        case 'events':
          await loadEvents();
          break;
        case 'medical':
          await loadMedicalServices();
          break;
        case 'resources':
          await loadResources();
          break;
      }
    }

    // 載入活動列表
    async function loadEvents() {
      try {
        showLoading('events-list');
        
        // 模擬活動資料
        const events = [
          {
            id: 'E2024001',
            title: '帕金森病友春季健走活動',
            description: '邀請病友及家屬一同參與戶外健走活動，促進身心健康，增進彼此交流。活動將有專業復健師陪同指導。',
            date: '2024-04-15',
            time: '09:00',
            location: '大安森林公園',
            category: '聯誼活動',
            maxParticipants: 50,
            currentParticipants: 23,
            fee: 0,
            imageUrl: 'https://via.placeholder.com/400x200?text=健走活動'
          },
          {
            id: 'E2024002',
            title: '帕金森病用藥管理講座',
            description: '由專業藥師講解帕金森病用藥注意事項、副作用管理，以及與其他藥物的交互作用。',
            date: '2024-04-20',
            time: '14:00',
            location: '台北市立聯合醫院',
            category: '衛教講座',
            maxParticipants: 80,
            currentParticipants: 45,
            fee: 0,
            imageUrl: 'https://via.placeholder.com/400x200?text=用藥講座'
          },
          {
            id: 'E2024003',
            title: '居家復健運動指導班',
            description: '物理治療師親自指導適合帕金森病友的居家復健運動，提供個別化運動建議。',
            date: '2024-04-25',
            time: '10:00',
            location: '病友會活動中心',
            category: '復健運動',
            maxParticipants: 30,
            currentParticipants: 18,
            fee: 200,
            imageUrl: 'https://via.placeholder.com/400x200?text=復健運動'
          }
        ];
        
        allEvents = events;
        displayEvents(events);
        
      } catch (error) {
        console.error('載入活動失敗:', error);
        showError('events-list', '載入活動失敗');
      }
    }

    // 顯示活動列表
    function displayEvents(events) {
      const container = document.getElementById('events-list');
      
      if (events.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-calendar-times text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-600">目前沒有開放報名的活動</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = events.map(event => `
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="relative">
            <img src="${event.imageUrl}" alt="${event.title}" class="w-full h-48 object-cover">
            <div class="absolute top-4 right-4">
              <span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm">
                ${event.category}
              </span>
            </div>
          </div>
          
          <div class="p-6">
            <h3 class="text-xl font-bold mb-2">${event.title}</h3>
            <p class="text-gray-600 mb-4 line-clamp-3">${event.description}</p>
            
            <div class="space-y-2 mb-4">
              <div class="flex items-center text-sm text-gray-600">
                <i class="fas fa-calendar mr-2"></i>
                ${event.date} ${event.time}
              </div>
              <div class="flex items-center text-sm text-gray-600">
                <i class="fas fa-map-marker-alt mr-2"></i>
                ${event.location}
              </div>
              <div class="flex items-center text-sm text-gray-600">
                <i class="fas fa-users mr-2"></i>
                ${event.currentParticipants}/${event.maxParticipants} 人
              </div>
              ${event.fee > 0 ? `
                <div class="flex items-center text-sm text-gray-600">
                  <i class="fas fa-dollar-sign mr-2"></i>
                  NT$ ${event.fee}
                </div>
              ` : ''}
            </div>
            
            <div class="flex justify-between items-center">
              <div class="w-full bg-gray-200 rounded-full h-2 mr-4">
                <div class="bg-green-500 h-2 rounded-full" style="width: ${(event.currentParticipants / event.maxParticipants) * 100}%"></div>
              </div>
              <button onclick="registerEvent('${event.id}')" 
                      class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 whitespace-nowrap
                      ${event.currentParticipants >= event.maxParticipants ? 'opacity-50 cursor-not-allowed' : ''}">
                ${event.currentParticipants >= event.maxParticipants ? '已額滿' : '報名'}
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // 活動分類篩選
    function filterEvents(category) {
      // 更新篩選按鈕狀態
      document.querySelectorAll('.category-filter').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
      });
      event.target.classList.remove('bg-gray-200', 'text-gray-700');
      event.target.classList.add('bg-blue-600', 'text-white');
      
      // 篩選活動
      const filteredEvents = category === 'all' 
        ? allEvents 
        : allEvents.filter(event => event.category === category);
      
      displayEvents(filteredEvents);
    }

    // 活動報名
    async function registerEvent(eventId) {
      if (!memberData) {
        alert('請先完成會員註冊');
        showPage('member');
        return;
      }
      
      if (confirm('確定要報名此活動嗎？')) {
        try {
          const response = await fetch(GAS_WEB_APP_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'registerEvent',
              eventId: eventId,
              memberId: memberData.id,
              lineId: liffProfile.userId
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('報名成功！');
            loadEvents(); // 重新載入活動列表
          } else {
            alert('報名失敗：' + result.message);
          }
        } catch (error) {
          console.error('報名失敗:', error);
          alert('報名失敗，請稍後再試');
        }
      }
    }

    // 載入醫療服務
    async function loadMedicalServices() {
      const container = document.getElementById('medical-page');
      
      container.innerHTML = `
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-4">
            <i class="fas fa-stethoscope mr-2 text-red-600"></i>醫療服務
          </h2>
        </div>
        
        <!-- 醫療服務選項 -->
        <div class="grid grid-cols-1 gap-4 mb-6">
          <button onclick="showMedicalBooking('consultation')" class="bg-white rounded-lg shadow-md p-4 text-left hover:shadow-lg transition-shadow">
            <div class="flex items-center">
              <i class="fas fa-user-md text-3xl text-blue-600 mr-4"></i>
              <div>
                <h3 class="font-semibold text-lg">醫療諮詢</h3>
                <p class="text-gray-600 text-sm">預約專業醫師諮詢服務</p>
              </div>
            </div>
          </button>
          
          <button onclick="showMedicalBooking('rehabilitation')" class="bg-white rounded-lg shadow-md p-4 text-left hover:shadow-lg transition-shadow">
            <div class="flex items-center">
              <i class="fas fa-dumbbell text-3xl text-green-600 mr-4"></i>
              <div>
                <h3 class="font-semibold text-lg">復健治療</h3>
                <p class="text-gray-600 text-sm">物理治療與職能治療預約</p>
              </div>
            </div>
          </button>
          
          <button onclick="showMedicalBooking('psychology')" class="bg-white rounded-lg shadow-md p-4 text-left hover:shadow-lg transition-shadow">
            <div class="flex items-center">
              <i class="fas fa-heart text-3xl text-purple-600 mr-4"></i>
              <div>
                <h3 class="font-semibold text-lg">心理諮商</h3>
                <p class="text-gray-600 text-sm">專業心理師諮商服務</p>
              </div>
            </div>
          </button>
          
          <button onclick="showMedicalBooking('nutrition')" class="bg-white rounded-lg shadow-md p-4 text-left hover:shadow-lg transition-shadow">
            <div class="flex items-center">
              <i class="fas fa-apple-alt text-3xl text-orange-600 mr-4"></i>
              <div>
                <h3 class="font-semibold text-lg">營養諮詢</h3>
                <p class="text-gray-600 text-sm">營養師飲食指導服務</p>
              </div>
            </div>
          </button>
        </div>
        
        <!-- 我的預約 -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-lg font-semibold mb-4">
            <i class="fas fa-calendar-check mr-2 text-green-600"></i>我的預約
          </h3>
          <div id="my-appointments">
            <div class="text-center py-4 text-gray-600">
              <i class="fas fa-calendar-times text-3xl mb-2"></i>
              <p>目前沒有預約記錄</p>
            </div>
          </div>
        </div>
      `;
    }

    // 載入資源中心
    async function loadResources() {
      const container = document.getElementById('resources-page');
      
      container.innerHTML = `
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-4">
            <i class="fas fa-book-open mr-2 text-purple-600"></i>資源中心
          </h2>
        </div>
        
        <!-- 資源分類 -->
        <div class="space-y-6">
          <!-- 衛教資料 -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold mb-4">
              <i class="fas fa-graduation-cap mr-2 text-blue-600"></i>衛教資料
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <a href="#" class="block p-4 border rounded-lg hover:bg-gray-50">
                <h4 class="font-semibold">帕金森病基礎知識</h4>
                <p class="text-sm text-gray-600 mt-1">了解帕金森病的症狀、原因與治療方式</p>
              </a>
              <a href="#" class="block p-4 border rounded-lg hover:bg-gray-50">
                <h4 class="font-semibold">用藥指南</h4>
                <p class="text-sm text-gray-600 mt-1">常用藥物介紹與注意事項</p>
              </a>
              <a href="#" class="block p-4 border rounded-lg hover:bg-gray-50">
                <h4 class="font-semibold">飲食營養</h4>
                <p class="text-sm text-gray-600 mt-1">適合帕金森病友的飲食建議</p>
              </a>
              <a href="#" class="block p-4 border rounded-lg hover:bg-gray-50">
                <h4 class="font-semibold">運動復健</h4>
                <p class="text-sm text-gray-600 mt-1">居家運動與復健指導</p>
              </a>
            </div>
          </div>
          
          <!-- 影音資源 -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold mb-4">
              <i class="fas fa-video mr-2 text-red-600"></i>影音資源
            </h3>
            <div class="space-y-4">
              <div class="flex items-center p-4 border rounded-lg">
                <i class="fas fa-play-circle text-3xl text-red-600 mr-4"></i>
                <div>
                  <h4 class="font-semibold">帕金森病友運動示範</h4>
                  <p class="text-sm text-gray-600">專業治療師示範適合的運動動作</p>
                </div>
              </div>
              <div class="flex items-center p-4 border rounded-lg">
                <i class="fas fa-play-circle text-3xl text-red-600 mr-4"></i>
                <div>
                  <h4 class="font-semibold">醫師講座：症狀管理</h4>
                  <p class="text-sm text-gray-600">專科醫師分享症狀管理技巧</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 相關連結 -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold mb-4">
              <i class="fas fa-link mr-2 text-green-600"></i>相關連結
            </h3>
            <div class="space-y-3">
              <a href="#" class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                <span>健保署帕金森病專區</span>
                <i class="fas fa-external-link-alt text-gray-400"></i>
              </a>
              <a href="#" class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                <span>台灣動作障礙學會</span>
                <i class="fas fa-external-link-alt text-gray-400"></i>
              </a>
              <a href="#" class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                <span>國際帕金森病組織</span>
                <i class="fas fa-external-link-alt text-gray-400"></i>
              </a>
            </div>
          </div>
        </div>
      `;
    }

    // 會員註冊表單提交
    document.getElementById('register-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const memberData = Object.fromEntries(formData.entries());
      memberData.lineId = liffProfile.userId;
      memberData.displayName = liffProfile.displayName;
      
      try {
        const response = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'registerMember',
            memberData: memberData
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('會員註冊成功！');
          await checkMemberStatus(); // 重新檢查會員狀態
        } else {
          alert('註冊失敗：' + result.message);
        }
      } catch (error) {
        console.error('註冊失敗:', error);
        alert('註冊失敗，請稍後再試');
      }
    });

    // 顯示捐款選項
    function showDonationOptions() {
      document.getElementById('donation-modal').classList.remove('hidden');
    }

    // 隱藏捐款模態框
    function hideDonationModal() {
      document.getElementById('donation-modal').classList.add('hidden');
      // 重置表單
      document.getElementById('custom-amount').value = '';
      document.querySelectorAll('.donation-amount').forEach(btn => {
        btn.classList.remove('border-green-500', 'bg-green-50');
        btn.classList.add('border-gray-200');
      });
    }

    // 選擇捐款金額
    function selectDonationAmount(amount) {
      // 重置所有按鈕
      document.querySelectorAll('.donation-amount').forEach(btn => {
        btn.classList.remove('border-green-500', 'bg-green-50');
        btn.classList.add('border-gray-200');
      });
      
      // 高亮選中的按鈕
      event.target.classList.remove('border-gray-200');
      event.target.classList.add('border-green-500', 'bg-green-50');
      
      // 清空自訂金額
      document.getElementById('custom-amount').value = '';
    }

    // 處理捐款
    async function processDonation() {
      if (!memberData) {
        alert('請先完成會員註冊');
        hideDonationModal();
        showPage('member');
        return;
      }
      
      // 取得捐款金額
      let amount = document.getElementById('custom-amount').value;
      if (!amount) {
        const selectedBtn = document.querySelector('.donation-amount.border-green-500');
        if (selectedBtn) {
          amount = selectedBtn.textContent.replace(/[^0-9]/g, '');
        }
      }
      
      if (!amount || amount < 100) {
        alert('請選擇或輸入捐款金額（最低 NT$ 100）');
        return;
      }
      
      const purpose = document.getElementById('donation-purpose').value;
      
      try {
        const response = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'processDonation',
            donationData: {
              memberId: memberData.id,
              lineId: liffProfile.userId,
              amount: parseInt(amount),
              purpose: purpose,
              date: new Date().toISOString().split('T')[0]
            }
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`感謝您的愛心捐款 NT$ ${amount}！`);
          hideDonationModal();
        } else {
          alert('捐款處理失敗：' + result.message);
        }
      } catch (error) {
        console.error('捐款處理失敗:', error);
        alert('捐款處理失敗，請稍後再試');
      }
    }

    // 顯示志工選項
    function showVolunteerOptions() {
      if (!memberData) {
        alert('請先完成會員註冊');
        showPage('member');
        return;
      }
      
      // 這裡可以開啟志工申請表單或相關頁面
      alert('志工申請功能開發中，敬請期待！');
    }

    // 工具函數
    function showLoading(containerId) {
      document.getElementById(containerId).innerHTML = `
        <div class="text-center py-8">
          <div class="loading w-8 h-8 border-4 border-gray-200 border-t-green-600 rounded-full mx-auto mb-4"></div>
          <p class="text-gray-600">載入中...</p>
        </div>
      `;
    }

    function showError(containerId, message) {
      document.getElementById(containerId).innerHTML = `
        <div class="text-center py-8">
          <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
          <p class="text-gray-600">${message}</p>
        </div>
      `;
    }

    // 初始化應用程式
    document.addEventListener('DOMContentLoaded', function() {
      initializeLiff();
    });
  </script>
</body>
</html>
