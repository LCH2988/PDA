<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤šç¦æ°£æœƒå“¡ç™»è¨˜</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px;
      }

      .container {
          max-width: 500px;
          margin: 0 auto;
          background: white;
          border-radius: 20px;
          padding: 30px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .header {
          text-align: center;
          margin-bottom: 30px;
      }

      .header h1 {
          color: #667eea;
          font-size: 28px;
          margin-bottom: 10px;
      }

      .header p {
          color: #666;
          font-size: 14px;
      }

      .debug-info {
          background: #f0f0f0;
          padding: 10px;
          border-radius: 8px;
          margin-bottom: 15px;
          font-size: 12px;
          color: #666;
          display: none;
      }

      .user-info {
          background: #f8f9ff;
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 25px;
          border-left: 4px solid #667eea;
      }

      .user-info h3 {
          color: #333;
          font-size: 16px;
          margin-bottom: 12px;
      }

      .user-info-item {
          display: flex;
          align-items: center;
          margin-bottom: 8px;
          font-size: 14px;
          color: #555;
      }

      .user-info-item img {
          width: 50px;
          height: 50px;
          border-radius: 50%;
          margin-right: 12px;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          color: #333;
          font-weight: 600;
          margin-bottom: 8px;
          font-size: 14px;
      }

      .form-group input {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e0e0e0;
          border-radius: 10px;
          font-size: 16px;
          transition: all 0.3s;
      }

      .form-group input:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-group small {
          display: block;
          color: #999;
          font-size: 12px;
          margin-top: 5px;
      }

      .required {
          color: #e74c3c;
      }

      .btn {
          width: 100%;
          padding: 15px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: transform 0.2s, box-shadow 0.2s;
      }

      .btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      }

      .btn:active {
          transform: translateY(0);
      }

      .btn:disabled {
          background: #ccc;
          cursor: not-allowed;
          transform: none;
      }

      .loading {
          text-align: center;
          padding: 40px;
          color: #667eea;
      }

      .loading-spinner {
          border: 3px solid #f3f3f3;
          border-top: 3px solid #667eea;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
          margin: 0 auto 15px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .success-message {
          background: #d4edda;
          border: 1px solid #c3e6cb;
          color: #155724;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          margin-top: 20px;
      }

      .success-message h3 {
          margin-bottom: 10px;
          font-size: 20px;
      }

      .member-number {
          font-size: 32px;
          font-weight: bold;
          color: #667eea;
          margin: 15px 0;
      }

      .error-message {
          background: #f8d7da;
          border: 1px solid #f5c6cb;
          color: #721c24;
          padding: 15px;
          border-radius: 10px;
          margin-top: 15px;
          font-size: 14px;
      }

      .existing-member {
          background: #fff3cd;
          border: 1px solid #ffeaa7;
          color: #856404;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>ğŸ‰ å¤šç¦æ°£æœƒå“¡ç™»è¨˜</h1>
          <p>æ­¡è¿åŠ å…¥å¤šç¦æ°£æœƒå“¡</p>
      </div>

      <div id="debugInfo" class="debug-info"></div>

      <div id="loading" class="loading">
          <div class="loading-spinner"></div>
          <p>æ­£åœ¨è¼‰å…¥ LINE è³‡è¨Š...</p>
      </div>

      <div id="mainContent" style="display: none;">
          <div class="user-info">
              <h3>ğŸ“± æ‚¨çš„ LINE è³‡è¨Š</h3>
              <div class="user-info-item">
                  <img id="userPicture" src="" alt="é ­åƒ">
                  <div>
                      <div><strong id="userName"></strong></div>
                      <div style="font-size: 12px; color: #999;" id="userId"></div>
                  </div>
              </div>
          </div>

          <form id="registrationForm">
              <div class="form-group">
                  <label>å§“å <span class="required">*</span></label>
                  <input type="text" id="memberName" name="memberName" required placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
              </div>

              <div class="form-group">
                  <label>å¤šç‰¹ç‘ ID</label>
                  <input type="text" id="dotterraId" name="dotterraId" placeholder="æœ‰ ID çš„è«‹å¡«å¯«">
                  <small>é¸å¡«é …ç›®ï¼Œå¦‚æœæ‚¨æœ‰å¤šç‰¹ç‘ ID è«‹å¡«å¯«</small>
              </div>

              <button type="submit" class="btn" id="submitBtn">é€å‡ºç™»è¨˜</button>
          </form>

          <div id="successMessage" style="display: none;"></div>
          <div id="errorMessage" style="display: none;"></div>
      </div>
  </div>

  <script>
      // ==========================================
      // è¨­å®šå€åŸŸ - è«‹æ›¿æ›æˆæ‚¨çš„å¯¦éš›å€¼
      // ==========================================
      const LIFF_ID = '2006582696-yEbkwxLM'; // è«‹æ›¿æ›æˆæ‚¨çš„ LIFF ID
      const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzWGE3bMOz188wElQA8eEYxhhkTgqHO-cl7WLW_tDSOr_yNajj4oOWj_658QA6qG_6t3Q/exec'; // è«‹æ›¿æ›æˆæ‚¨çš„ GAS URL

      let lineProfile = null;
      const DEBUG_MODE = true; // é–‹å•Ÿé™¤éŒ¯æ¨¡å¼

      // ==========================================
      // é™¤éŒ¯è¨Šæ¯é¡¯ç¤º
      // ==========================================
      function debugLog(message) {
          if (DEBUG_MODE) {
              console.log(message);
              const debugDiv = document.getElementById('debugInfo');
              debugDiv.style.display = 'block';
              debugDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
          }
      }

      // ==========================================
      // åˆå§‹åŒ– LIFF
      // ==========================================
      async function initializeLiff() {
          try {
              debugLog('é–‹å§‹åˆå§‹åŒ– LIFF...');
              
              await liff.init({ liffId: LIFF_ID });
              debugLog('LIFF åˆå§‹åŒ–æˆåŠŸ');
              
              if (!liff.isLoggedIn()) {
                  debugLog('ä½¿ç”¨è€…æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                  liff.login();
                  return;
              }

              // å–å¾—ä½¿ç”¨è€…è³‡è¨Š
              lineProfile = await liff.getProfile();
              debugLog('å–å¾—ä½¿ç”¨è€…è³‡è¨Š: ' + lineProfile.displayName);
              
              // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
              document.getElementById('userName').textContent = lineProfile.displayName;
              document.getElementById('userId').textContent = `User ID: ${lineProfile.userId.substring(0, 10)}...`;
              document.getElementById('userPicture').src = lineProfile.pictureUrl || 'https://via.placeholder.com/50';

              // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ˜¯æœƒå“¡
              await checkExistingMember();

              // éš±è—è¼‰å…¥ç•«é¢ï¼Œé¡¯ç¤ºä¸»è¦å…§å®¹
              document.getElementById('loading').style.display = 'none';
              document.getElementById('mainContent').style.display = 'block';

          } catch (error) {
              console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
              debugLog('éŒ¯èª¤: ' + error.message);
              document.getElementById('loading').innerHTML = `
                  <p style="color: #e74c3c;">âŒ è¼‰å…¥å¤±æ•—</p>
                  <p style="font-size: 14px;">è«‹ç¢ºèªæ‚¨å·²æ­£ç¢ºè¨­å®š LIFF ID</p>
                  <p style="font-size: 12px; color: #999;">${error.message}</p>
              `;
          }
      }

      // ==========================================
      // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ˜¯æœƒå“¡
      // ==========================================
      async function checkExistingMember() {
          try {
              debugLog('æª¢æŸ¥æœƒå“¡ç‹€æ…‹...');
              const url = `${GAS_API_URL}?lineUserId=${encodeURIComponent(lineProfile.userId)}`;
              debugLog('GET URL: ' + url);
              
              const response = await fetch(url, {
                  method: 'GET',
                  redirect: 'follow'
              });
              
              debugLog('GET å›æ‡‰ç‹€æ…‹: ' + response.status);
              const result = await response.json();
              debugLog('GET å›æ‡‰å…§å®¹: ' + JSON.stringify(result));

              if (result.success && result.data) {
                  // å·²ç¶“æ˜¯æœƒå“¡ï¼Œé¡¯ç¤ºæœƒå“¡è³‡è¨Š
                  showExistingMember(result.data);
              } else {
                  debugLog('æ–°æœƒå“¡ï¼Œé¡¯ç¤ºè¨»å†Šè¡¨å–®');
              }
          } catch (error) {
              debugLog('æª¢æŸ¥æœƒå“¡ç‹€æ…‹å¤±æ•—: ' + error.message);
              console.log('æª¢æŸ¥æœƒå“¡ç‹€æ…‹å¤±æ•—ï¼Œå¯èƒ½æ˜¯æ–°æœƒå“¡:', error);
          }
      }

      // ==========================================
      // é¡¯ç¤ºç¾æœ‰æœƒå“¡è³‡è¨Š
      // ==========================================
      function showExistingMember(memberData) {
          document.getElementById('registrationForm').style.display = 'none';
          const successDiv = document.getElementById('successMessage');
          successDiv.innerHTML = `
              <div class="existing-member">
                  <h3>âœ¨ æ‚¨å·²ç¶“æ˜¯å¤šç¦æ°£æœƒå“¡</h3>
                  <p style="margin-top: 15px;">æ‚¨çš„æœƒå“¡ç·¨è™Ÿç‚ºï¼š</p>
                  <div class="member-number">${memberData.memberNumber}</div>
                  <div style="font-size: 14px; margin-top: 15px; text-align: left; background: white; padding: 15px; border-radius: 8px;">
                      <p><strong>å§“åï¼š</strong>${memberData.memberName}</p>
                      <p><strong>å¤šç‰¹ç‘ IDï¼š</strong>${memberData.dotterraId || 'ç„¡'}</p>
                      <p><strong>ç™»è¨˜æ™‚é–“ï¼š</strong>${new Date(memberData.registrationDate).toLocaleString('zh-TW')}</p>
                  </div>
              </div>
          `;
          successDiv.style.display = 'block';
      }

      // ==========================================
      // è™•ç†è¡¨å–®é€å‡º
      // ==========================================
      document.addEventListener('DOMContentLoaded', function() {
          // åˆå§‹åŒ– LIFF
          initializeLiff();

          // è¡¨å–®é€å‡ºè™•ç†
          document.getElementById('registrationForm').addEventListener('submit', async function(e) {
              e.preventDefault();

              const memberName = document.getElementById('memberName').value.trim();
              const dotterraId = document.getElementById('dotterraId').value.trim();
              const submitBtn = document.getElementById('submitBtn');

              if (!memberName) {
                  showError('è«‹è¼¸å…¥å§“å');
                  return;
              }

              // åœç”¨æŒ‰éˆ•
              submitBtn.disabled = true;
              submitBtn.textContent = 'é€å‡ºä¸­...';

              // æº–å‚™æœƒå“¡è³‡æ–™
              const memberData = {
                  lineUserId: lineProfile.userId,
                  lineDisplayName: lineProfile.displayName,
                  linePictureUrl: lineProfile.pictureUrl,
                  memberName: memberName,
                  dotterraId: dotterraId || 'ç„¡',
                  registrationDate: new Date().toISOString()
              };

              debugLog('æº–å‚™é€å‡ºè³‡æ–™: ' + JSON.stringify(memberData));

              try {
                  // å‘¼å« GAS API
                  debugLog('POST URL: ' + GAS_API_URL);
                  
                  const response = await fetch(GAS_API_URL, {
                      method: 'POST',
                      mode: 'no-cors', // é‡è¦ï¼šä½¿ç”¨ no-cors æ¨¡å¼
                      headers: {
                          'Content-Type': 'application/json',
                      },
                      body: JSON.stringify(memberData),
                      redirect: 'follow'
                  });

                  debugLog('POST å›æ‡‰ç‹€æ…‹: ' + response.status);

                  // å› ç‚ºä½¿ç”¨ no-corsï¼Œç„¡æ³•è®€å–å›æ‡‰å…§å®¹
                  // å‡è¨­æˆåŠŸä¸¦ç”¢ç”Ÿæœƒå“¡ç·¨è™Ÿ
                  const memberNumber = generateTempMemberNumber();
                  
                  debugLog('å‡è¨­è¨»å†ŠæˆåŠŸï¼Œæœƒå“¡ç·¨è™Ÿ: ' + memberNumber);
                  showSuccess(memberNumber);
                  document.getElementById('registrationForm').style.display = 'none';

                  // æç¤ºï¼šå¯¦éš›ä¸Šè³‡æ–™å·²é€å‡ºï¼Œä½†å›  no-cors ç„¡æ³•ç¢ºèª
                  setTimeout(() => {
                      const note = document.createElement('p');
                      note.style.fontSize = '12px';
                      note.style.color = '#666';
                      note.style.marginTop = '10px';
                      note.textContent = 'â€» è³‡æ–™å·²é€å‡ºï¼Œè«‹ç¨å¾Œç¢ºèª Google Sheets';
                      document.getElementById('successMessage').appendChild(note);
                  }, 1000);

              } catch (error) {
                  console.error('ç™»è¨˜å¤±æ•—:', error);
                  debugLog('éŒ¯èª¤: ' + error.message);
                  showError('ç™»è¨˜å¤±æ•—: ' + error.message);
              } finally {
                  submitBtn.disabled = false;
                  submitBtn.textContent = 'é€å‡ºç™»è¨˜';
              }
          });
      });

      // ==========================================
      // ç”¢ç”Ÿè‡¨æ™‚æœƒå“¡ç·¨è™Ÿï¼ˆå‰ç«¯ç”¨ï¼‰
      // ==========================================
      function generateTempMemberNumber() {
          const date = new Date();
          const year = date.getFullYear().toString().slice(-2);
          const month = (date.getMonth() + 1).toString().padStart(2, '0');
          const day = date.getDate().toString().padStart(2, '0');
          const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
          return `DFQ${year}${month}${day}${random}`;
      }

      // ==========================================
      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
      // ==========================================
      function showSuccess(memberNumber) {
          const successDiv = document.getElementById('successMessage');
          successDiv.innerHTML = `
              <div class="success-message">
                  <h3>âœ… ç™»è¨˜æˆåŠŸï¼</h3>
                  <p>æ‚¨çš„å¤šç¦æ°£ç·¨è™Ÿç‚ºï¼š</p>
                  <div class="member-number">${memberNumber}</div>
                  <p style="font-size: 14px; margin-top: 10px;">è«‹å¦¥å–„ä¿ç®¡æ‚¨çš„æœƒå“¡ç·¨è™Ÿ</p>
              </div>
          `;
          successDiv.style.display = 'block';

          // 3 ç§’å¾Œé—œé–‰ LIFF è¦–çª—ï¼ˆå¯é¸ï¼‰
          // setTimeout(() => liff.closeWindow(), 3000);
      }

      // ==========================================
      // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
      // ==========================================
      function showError(message) {
          const errorDiv = document.getElementById('errorMessage');
          errorDiv.innerHTML = `<div class="error-message">âŒ ${message}</div>`;
          errorDiv.style.display = 'block';
          setTimeout(() => {
              errorDiv.style.display = 'none';
          }, 5000);
      }
  </script>
</body>
</html>
