<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤šç¦æ°£æœƒå“¡ç™»è¨˜</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px;
      }

      .container {
          max-width: 500px;
          margin: 0 auto;
          background: white;
          border-radius: 20px;
          padding: 30px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .header {
          text-align: center;
          margin-bottom: 30px;
      }

      .header h1 {
          color: #667eea;
          font-size: 28px;
          margin-bottom: 10px;
      }

      .header p {
          color: #666;
          font-size: 14px;
      }

      .debug-info {
          background: #f0f0f0;
          padding: 10px;
          border-radius: 8px;
          margin-bottom: 15px;
          font-size: 11px;
          color: #666;
          max-height: 200px;
          overflow-y: auto;
          display: none;
      }

      .debug-toggle {
          background: #e0e0e0;
          border: none;
          padding: 5px 10px;
          border-radius: 5px;
          font-size: 11px;
          cursor: pointer;
          margin-bottom: 10px;
      }

      .user-info {
          background: #f8f9ff;
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 25px;
          border-left: 4px solid #667eea;
      }

      .user-info h3 {
          color: #333;
          font-size: 16px;
          margin-bottom: 12px;
      }

      .user-info-item {
          display: flex;
          align-items: center;
          margin-bottom: 8px;
          font-size: 14px;
          color: #555;
      }

      .user-info-item img {
          width: 50px;
          height: 50px;
          border-radius: 50%;
          margin-right: 12px;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          color: #333;
          font-weight: 600;
          margin-bottom: 8px;
          font-size: 14px;
      }

      .form-group input {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e0e0e0;
          border-radius: 10px;
          font-size: 16px;
          transition: all 0.3s;
      }

      .form-group input:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-group small {
          display: block;
          color: #999;
          font-size: 12px;
          margin-top: 5px;
      }

      .required {
          color: #e74c3c;
      }

      .btn {
          width: 100%;
          padding: 15px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: transform 0.2s, box-shadow 0.2s;
      }

      .btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      }

      .btn:active {
          transform: translateY(0);
      }

      .btn:disabled {
          background: #ccc;
          cursor: not-allowed;
          transform: none;
      }

      .loading {
          text-align: center;
          padding: 40px;
          color: #667eea;
      }

      .loading-spinner {
          border: 3px solid #f3f3f3;
          border-top: 3px solid #667eea;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
          margin: 0 auto 15px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .success-message {
          background: #d4edda;
          border: 1px solid #c3e6cb;
          color: #155724;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          margin-top: 20px;
      }

      .success-message h3 {
          margin-bottom: 10px;
          font-size: 20px;
      }

      .member-number {
          font-size: 32px;
          font-weight: bold;
          color: #667eea;
          margin: 15px 0;
          letter-spacing: 2px;
      }

      .error-message {
          background: #f8d7da;
          border: 1px solid #f5c6cb;
          color: #721c24;
          padding: 15px;
          border-radius: 10px;
          margin-top: 15px;
          font-size: 14px;
      }

      .existing-member {
          background: #fff3cd;
          border: 1px solid #ffeaa7;
          color: #856404;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
      }

      .info-box {
          background: #e3f2fd;
          border-left: 4px solid #2196f3;
          padding: 15px;
          border-radius: 8px;
          margin-top: 15px;
          font-size: 13px;
          color: #1565c0;
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>ğŸ‰ å¤šç¦æ°£æœƒå“¡ç™»è¨˜</h1>
          <p>æ­¡è¿åŠ å…¥å¤šç¦æ°£æœƒå“¡</p>
      </div>

      <button class="debug-toggle" onclick="toggleDebug()">ğŸ”§ é¡¯ç¤º/éš±è—é™¤éŒ¯è¨Šæ¯</button>
      <div id="debugInfo" class="debug-info"></div>

      <div id="loading" class="loading">
          <div class="loading-spinner"></div>
          <p>æ­£åœ¨è¼‰å…¥ LINE è³‡è¨Š...</p>
      </div>

      <div id="mainContent" style="display: none;">
          <div class="user-info">
              <h3>ğŸ“± æ‚¨çš„ LINE è³‡è¨Š</h3>
              <div class="user-info-item">
                  <img id="userPicture" src="" alt="é ­åƒ">
                  <div>
                      <div><strong id="userName"></strong></div>
                      <div style="font-size: 12px; color: #999;" id="userId"></div>
                  </div>
              </div>
          </div>

          <form id="registrationForm">
              <div class="form-group">
                  <label>å§“å <span class="required">*</span></label>
                  <input type="text" id="memberName" name="memberName" required placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
              </div>

              <div class="form-group">
                  <label>å¤šç‰¹ç‘ ID</label>
                  <input type="text" id="dotterraId" name="dotterraId" placeholder="æœ‰ ID çš„è«‹å¡«å¯«">
                  <small>é¸å¡«é …ç›®ï¼Œå¦‚æœæ‚¨æœ‰å¤šç‰¹ç‘ ID è«‹å¡«å¯«</small>
              </div>

              <button type="submit" class="btn" id="submitBtn">é€å‡ºç™»è¨˜</button>
          </form>

          <div id="successMessage" style="display: none;"></div>
          <div id="errorMessage" style="display: none;"></div>
      </div>
  </div>

  <script>
      // ==========================================
      // è¨­å®šå€åŸŸ - è«‹æ›¿æ›æˆæ‚¨çš„å¯¦éš›å€¼
      // ==========================================
      const LIFF_ID = '2007877215-R1vZM90q'; // è«‹æ›¿æ›æˆæ‚¨çš„ LIFF ID
      const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzsVBkHh6ZXnjHXpRSrhp-uxQDT5U0HUvAlRL9lhvFCUwaZWwf5lh9lEKkAxKxsvE5qGA/exec'; // è«‹æ›¿æ›æˆæ‚¨çš„ GAS URL

      let lineProfile = null;
      const DEBUG_MODE = false; // é–‹å•Ÿé™¤éŒ¯æ¨¡å¼

      // ==========================================
      // é™¤éŒ¯è¨Šæ¯é¡¯ç¤º
      // ==========================================
      function debugLog(message) {
          if (DEBUG_MODE) {
              console.log(message);
              const debugDiv = document.getElementById('debugInfo');
              const time = new Date().toLocaleTimeString();
              debugDiv.innerHTML += `<div><strong>${time}:</strong> ${message}</div>`;
              debugDiv.scrollTop = debugDiv.scrollHeight;
          }
      }

      function toggleDebug() {
          const debugDiv = document.getElementById('debugInfo');
          debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
      }

      // ==========================================
      // åˆå§‹åŒ– LIFF
      // ==========================================
      async function initializeLiff() {
          try {
              debugLog('ğŸš€ é–‹å§‹åˆå§‹åŒ– LIFF...');
              debugLog('LIFF ID: ' + LIFF_ID);
              
              await liff.init({ liffId: LIFF_ID });
              debugLog('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ');
              
              if (!liff.isLoggedIn()) {
                  debugLog('âš ï¸ ä½¿ç”¨è€…æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                  liff.login();
                  return;
              }

              // å–å¾—ä½¿ç”¨è€…è³‡è¨Š
              lineProfile = await liff.getProfile();
              debugLog('âœ… å–å¾—ä½¿ç”¨è€…è³‡è¨Š: ' + lineProfile.displayName);
              debugLog('User ID: ' + lineProfile.userId);
              
              // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
              document.getElementById('userName').textContent = lineProfile.displayName;
              document.getElementById('userId').textContent = `User ID: ${lineProfile.userId.substring(0, 15)}...`;
              document.getElementById('userPicture').src = lineProfile.pictureUrl || 'https://via.placeholder.com/50';

              // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ˜¯æœƒå“¡
              await checkExistingMember();

              // éš±è—è¼‰å…¥ç•«é¢ï¼Œé¡¯ç¤ºä¸»è¦å…§å®¹
              document.getElementById('loading').style.display = 'none';
              document.getElementById('mainContent').style.display = 'block';

          } catch (error) {
              console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
              debugLog('âŒ éŒ¯èª¤: ' + error.message);
              document.getElementById('loading').innerHTML = `
                  <p style="color: #e74c3c;">âŒ è¼‰å…¥å¤±æ•—</p>
                  <p style="font-size: 14px;">è«‹ç¢ºèªæ‚¨å·²æ­£ç¢ºè¨­å®š LIFF ID</p>
                  <p style="font-size: 12px; color: #999;">${error.message}</p>
              `;
          }
      }

      // ==========================================
      // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ˜¯æœƒå“¡
      // ==========================================
      async function checkExistingMember() {
          try {
              debugLog('ğŸ” æª¢æŸ¥æœƒå“¡ç‹€æ…‹...');
              const url = `${GAS_API_URL}?lineUserId=${encodeURIComponent(lineProfile.userId)}`;
              debugLog('GET URL: ' + url);
              
              const response = await fetch(url, {
                  method: 'GET',
                  redirect: 'follow'
              });
              
              debugLog('GET å›æ‡‰ç‹€æ…‹: ' + response.status);
              
              const responseText = await response.text();
              debugLog('GET å›æ‡‰å…§å®¹: ' + responseText);
              
              const result = JSON.parse(responseText);

              if (result.success && result.data) {
                  debugLog('âœ… æ‰¾åˆ°ç¾æœ‰æœƒå“¡è³‡æ–™');
                  // å·²ç¶“æ˜¯æœƒå“¡ï¼Œé¡¯ç¤ºæœƒå“¡è³‡è¨Š
                  showExistingMember(result.data);
              } else {
                  debugLog('â„¹ï¸ æ–°æœƒå“¡ï¼Œé¡¯ç¤ºè¨»å†Šè¡¨å–®');
              }
          } catch (error) {
              debugLog('âš ï¸ æª¢æŸ¥æœƒå“¡ç‹€æ…‹å¤±æ•—: ' + error.message);
              console.log('æª¢æŸ¥æœƒå“¡ç‹€æ…‹å¤±æ•—ï¼Œå¯èƒ½æ˜¯æ–°æœƒå“¡:', error);
          }
      }

      // ==========================================
      // é¡¯ç¤ºç¾æœ‰æœƒå“¡è³‡è¨Š
      // ==========================================
      function showExistingMember(memberData) {
          debugLog('ğŸ“‹ é¡¯ç¤ºç¾æœ‰æœƒå“¡è³‡è¨Š');
          document.getElementById('registrationForm').style.display = 'none';
          const successDiv = document.getElementById('successMessage');
          successDiv.innerHTML = `
              <div class="existing-member">
                  <h3>âœ¨ æ‚¨å·²ç¶“æ˜¯å¤šç¦æ°£æœƒå“¡</h3>
                  <p style="margin-top: 15px;">æ‚¨çš„æœƒå“¡ç·¨è™Ÿç‚ºï¼š</p>
                  <div class="member-number">${memberData.memberNumber}</div>
                  <div style="font-size: 14px; margin-top: 15px; text-align: left; background: white; padding: 15px; border-radius: 8px;">
                      <p><strong>å§“åï¼š</strong>${memberData.memberName}</p>
                      <p><strong>å¤šç‰¹ç‘ IDï¼š</strong>${memberData.dotterraId || 'ç„¡'}</p>
                      <p><strong>ç™»è¨˜æ™‚é–“ï¼š</strong>${new Date(memberData.registrationDate).toLocaleString('zh-TW')}</p>
                  </div>
              </div>
          `;
          successDiv.style.display = 'block';
      }

      // ==========================================
      // è™•ç†è¡¨å–®é€å‡º
      // ==========================================
      document.addEventListener('DOMContentLoaded', function() {
          // åˆå§‹åŒ– LIFF
          initializeLiff();

          // è¡¨å–®é€å‡ºè™•ç†
          document.getElementById('registrationForm').addEventListener('submit', async function(e) {
              e.preventDefault();

              const memberName = document.getElementById('memberName').value.trim();
              const dotterraId = document.getElementById('dotterraId').value.trim();
              const submitBtn = document.getElementById('submitBtn');

              if (!memberName) {
                  showError('è«‹è¼¸å…¥å§“å');
                  return;
              }

              // åœç”¨æŒ‰éˆ•
              submitBtn.disabled = true;
              submitBtn.textContent = 'é€å‡ºä¸­...';
              debugLog('ğŸ“¤ æº–å‚™é€å‡ºæœƒå“¡è³‡æ–™...');

              // æº–å‚™æœƒå“¡è³‡æ–™
              const memberData = {
                  lineUserId: lineProfile.userId,
                  lineDisplayName: lineProfile.displayName,
                  linePictureUrl: lineProfile.pictureUrl,
                  memberName: memberName,
                  dotterraId: dotterraId || 'ç„¡',
                  registrationDate: new Date().toISOString()
              };

              debugLog('è³‡æ–™å…§å®¹: ' + JSON.stringify(memberData, null, 2));

              try {
                  // å‘¼å« GAS API
                  debugLog('POST URL: ' + GAS_API_URL);
                  
                  const response = await fetch(GAS_API_URL, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                      },
                      body: JSON.stringify(memberData),
                      redirect: 'follow'
                  });

                  debugLog('POST å›æ‡‰ç‹€æ…‹: ' + response.status);
                  
                  const responseText = await response.text();
                  debugLog('POST å›æ‡‰å…§å®¹: ' + responseText);

                  let result;
                  try {
                      result = JSON.parse(responseText);
                  } catch (parseError) {
                      debugLog('âŒ JSON è§£æå¤±æ•—: ' + parseError.message);
                      throw new Error('ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤');
                  }

                  if (result.success) {
                      if (result.isExisting) {
                          // å·²ç¶“æ˜¯æœƒå“¡
                          debugLog('âš ï¸ ä½¿ç”¨è€…å·²ç¶“æ˜¯æœƒå“¡');
                          showError('æ‚¨å·²ç¶“æ˜¯æœƒå“¡äº†ï¼Œæœƒå“¡ç·¨è™Ÿï¼š' + result.memberNumber);
                      } else {
                          // è¨»å†ŠæˆåŠŸ
                          debugLog('âœ… è¨»å†ŠæˆåŠŸï¼æœƒå“¡ç·¨è™Ÿ: ' + result.memberNumber);
                          showSuccess(result.memberNumber);
                          document.getElementById('registrationForm').style.display = 'none';
                      }
                  } else {
                      debugLog('âŒ è¨»å†Šå¤±æ•—: ' + result.message);
                      showError(result.message || 'ç™»è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                  }

              } catch (error) {
                  console.error('ç™»è¨˜å¤±æ•—:', error);
                  debugLog('âŒ ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                  showError('ç™»è¨˜å¤±æ•—: ' + error.message + '\n\nè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦');
              } finally {
                  submitBtn.disabled = false;
                  submitBtn.textContent = 'é€å‡ºç™»è¨˜';
              }
          });
      });

      // ==========================================
      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
      // ==========================================
      function showSuccess(memberNumber) {
          const successDiv = document.getElementById('successMessage');
          successDiv.innerHTML = `
              <div class="success-message">
                  <h3>âœ… ç™»è¨˜æˆåŠŸï¼</h3>
                  <p>æ‚¨çš„å¤šç¦æ°£ç·¨è™Ÿç‚ºï¼š</p>
                  <div class="member-number">${memberNumber}</div>
                  <p style="font-size: 14px; margin-top: 10px;">è«‹å¦¥å–„ä¿ç®¡æ‚¨çš„æœƒå“¡ç·¨è™Ÿ</p>
                  <div class="info-box">
                      ğŸ’¡ æ‚¨å¯ä»¥éš¨æ™‚é€éæ­¤é é¢æŸ¥è©¢æ‚¨çš„æœƒå“¡ç·¨è™Ÿ
                  </div>
              </div>
          `;
          successDiv.style.display = 'block';

          // 5 ç§’å¾Œé—œé–‰ LIFF è¦–çª—ï¼ˆå¯é¸ï¼‰
          // setTimeout(() => {
          //     debugLog('é—œé–‰ LIFF è¦–çª—');
          //     liff.closeWindow();
          // }, 5000);
      }

      // ==========================================
      // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
      // ==========================================
      function showError(message) {
          const errorDiv = document.getElementById('errorMessage');
          errorDiv.innerHTML = `<div class="error-message">âŒ ${message}</div>`;
          errorDiv.style.display = 'block';
          
          // æ²å‹•åˆ°éŒ¯èª¤è¨Šæ¯
          errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          setTimeout(() => {
              errorDiv.style.display = 'none';
          }, 8000);
      }
  </script>
</body>
</html>
