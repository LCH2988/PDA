
<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ± v2.2</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="theme-color" content="#667eea">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
<style>
:root {
--primary:#667eea;
--grad:linear-gradient(135deg,#667eea,#764ba2);
--success:#48bb78;
--warn:#ed8936;
--error:#f56565;
--bg:#f4f6fb;
--card:#ffffff;
--radius:16px;
--shadow:0 4px 14px rgba(0,0,0,.08);
--text:#2d3748;
--text-light:#718096;
font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans TC',sans-serif;
}
body { margin:0; background:var(--bg); color:var(--text); }
header {
background:var(--grad); color:#fff; padding:24px 16px;
text-align:center; position:sticky; top:0; z-index:10;
}
h1 { margin:0; font-size:22px; letter-spacing:1px; }
.container { max-width:1100px; margin:0 auto; padding:16px; }
.tabs { display:flex; gap:8px; flex-wrap:wrap; margin:16px 0; }
.tab-btn {
flex:1 1 140px; background:#fff; border:2px solid #e2e8f0;
border-radius:10px; padding:10px 12px; text-align:center;
cursor:pointer; font-size:14px; font-weight:600;
transition:.25s; user-select:none;
}
.tab-btn.active {
background:var(--grad); color:#fff; border-color:var(--primary);
box-shadow:0 4px 14px rgba(102,126,234,.35);
}
.tab-btn:hover:not(.active){ border-color:var(--primary); }
.panel { display:none; animation:fade .4s ease; }
.panel.active { display:block; }
@keyframes fade {
from { opacity:0; transform:translateY(12px); }
to { opacity:1; transform:translateY(0); }
}
.card {
background:var(--card); border-radius:var(--radius);
box-shadow:var(--shadow); padding:20px; margin-bottom:18px;
position:relative;
}
.grid { display:grid; gap:16px; }
@media (min-width:700px){
.grid.cols-2{ grid-template-columns:repeat(2,1fr); }
.grid.cols-3{ grid-template-columns:repeat(3,1fr); }
.grid.cols-4{ grid-template-columns:repeat(4,1fr); }
}
.stat {
text-align:center; padding:18px 12px; border-radius:14px;
background:#fff; box-shadow:var(--shadow); position:relative;
overflow:hidden;
}
.stat:before {
content:''; position:absolute; top:0; left:0; height:4px; width:100%;
background:var(--grad);
}
.stat .num { font-size:30px; font-weight:700; color:var(--primary); margin:8px 0 4px; }
.stat .label { font-size:13px; color:var(--text-light); letter-spacing:1px; }
label { font-size:13px; font-weight:600; margin-bottom:4px; display:block; color:var(--text-light); }
input, select, textarea {
width:100%; padding:12px 14px; font-size:15px;
border:2px solid #e2e8f0; border-radius:10px; background:#fff;
transition:.25s;
}
input:focus,select:focus,textarea:focus {
outline:none; border-color:var(--primary);
box-shadow:0 0 0 3px rgba(102,126,234,.15);
}
textarea { resize:vertical; min-height:120px; }
.actions { display:flex; gap:10px; flex-wrap:wrap; }
.btn {
background:var(--grad); color:#fff; padding:12px 22px;
border:none; border-radius:10px; font-size:14px; font-weight:600;
cursor:pointer; display:inline-flex; align-items:center; gap:6px;
box-shadow:0 4px 14px rgba(102,126,234,.35); transition:.25s;
position:relative; overflow:hidden;
}
.btn:hover { transform:translateY(-2px); }
.btn:active { transform:translateY(0); }
.btn.secondary { background:#4a5568; box-shadow:0 4px 12px rgba(74,85,104,.4); }
.btn.danger { background:linear-gradient(135deg,#fc8181,#f56565); box-shadow:0 4px 12px rgba(245,101,101,.4); }
.btn.disabled, .btn:disabled { opacity:.55; cursor:not-allowed; transform:none; }
.btn.loading .text { opacity:0; }
.btn.loading:after {
content:''; width:20px; height:20px; border:3px solid rgba(255,255,255,.4);
border-top:3px solid #fff; border-radius:50%; animation:spin 1s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }
.inline { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.badge {
display:inline-block; padding:4px 10px; font-size:11px; border-radius:999px;
background:#edf2f7; color:#4a5568; font-weight:600; letter-spacing:.5px; margin-right:4px;
}
.badge.green { background:rgba(72,187,120,.15); color:var(--success); }
.badge.red { background:rgba(245,101,101,.15); color:var(--error); }
.badge.orange { background:rgba(237,137,54,.15); color:var(--warn); }
.flex { display:flex; }
.space-between { justify-content:space-between; }
.mt { margin-top:18px; }
.mb { margin-bottom:18px; }
.hidden { display:none !important; }
.separator { height:1px; background:#e2e8f0; margin:20px 0; }
.list-item {
background:#fff; border-radius:14px; padding:16px 18px; box-shadow:var(--shadow);
margin-bottom:14px; border-left:5px solid var(--primary); position:relative;
}
.list-item.full { border-left-color:var(--error); }
.list-item h4 { margin:0 0 6px; font-size:16px; }
.meta { font-size:12px; color:var(--text-light); display:flex; gap:12px; flex-wrap:wrap; }
.meta span { display:inline-flex; align-items:center; gap:4px; }
.notice {
padding:15px 18px; border-radius:12px; font-size:14px; line-height:1.5;
background:#fffaf0; color:#744210; border:1px solid #fbd38d; margin-bottom:16px;
}
.notice.error { background:#fff5f5; color:#742a2a; border-color:#feb2b2; }
.notice.success { background:#f0fff4; color:#22543d; border-color:#9ae6b4; }
.notice.info { background:#ebf8ff; color:#2b6cb0; border-color:#90cdf4; }
.empty {
text-align:center; padding:50px 20px; color:var(--text-light); font-size:14px;
}
.empty .icon { font-size:42px; margin-bottom:8px; }
.pagination { display:flex; gap:6px; flex-wrap:wrap; margin-top:10px; }
.pagination button {
padding:8px 14px; border:2px solid #e2e8f0; background:#fff; font-weight:600;
border-radius:8px; cursor:pointer; transition:.2s;
}
.pagination button.active,.pagination button:hover { background:var(--grad); color:#fff; border-color:var(--primary); }
.notification {
position:fixed; top:20px; right:20px; background:#2d3748; color:#fff;
padding:14px 20px; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.25);
transform:translateY(-25px); opacity:0; transition:.35s; z-index:999;
max-width:360px; display:flex; gap:12px; align-items:flex-start;
}
.notification.show { transform:translateY(0); opacity:1; }
.notification.success { background:var(--success); }
.notification.error { background:var(--error); }
.notification.warn { background:var(--warn); }
.notification button {
background:rgba(255,255,255,.15); color:#fff; border:none;
width:26px; height:26px; border-radius:50%; cursor:pointer;
font-weight:700; font-size:14px; line-height:1;
}
.progress { width:100%; height:8px; background:#e2e8f0; border-radius:4px; overflow:hidden; }
.progress > div { height:100%; background:var(--grad); width:0; transition:width .5s; }
.search-bar { position:relative; }
.search-bar input { padding-left:38px; }
.search-bar .icon {
position:absolute; top:50%; left:12px; transform:translateY(-50%);
font-size:16px; opacity:.55;
}
.inline-info { font-size:12px; color:var(--text-light); margin-top:4px; }
footer { text-align:center; padding:40px 0 60px; font-size:12px; color:#94a3b8; }
@media (max-width:640px){
h1 { font-size:20px; }
.tab-btn { flex:1 1 calc(50% - 8px); }
.stat .num { font-size:24px; }
.list-item { padding:14px 14px; }
}
</style>
</head>
<body>
<header>
<h1>ğŸ¥ å¸•é‡‘æ£®ç—…å‹æœƒ ç®¡ç†ç³»çµ± v2.2</h1>
<div style="margin-top:6px;font-size:12px;opacity:.85;">æœƒå“¡ / æ´»å‹• / ææ¬¾ / æ”¯å‡º / å›é¥‹ / çµ±è¨ˆ</div>
</header>
<div class="container">

<!-- ä½¿ç”¨è€…è³‡è¨Š -->
<div id="user-info" class="card hidden">
  <h3 style="margin-top:0">ğŸ‘¤ å€‹äººè³‡è¨Š</h3>
  <div id="user-details" style="font-size:14px;"></div>
</div>

<!-- åˆ†é é¸å–® -->
<div class="tabs" id="tabs">
  <div class="tab-btn active" data-tab="profile">å€‹äººè³‡æ–™</div>
  <div class="tab-btn" data-tab="activities">æ´»å‹•</div>
  <div class="tab-btn" data-tab="donations">ææ¬¾</div>
  <div class="tab-btn" data-tab="finance">æ”¯å‡º / è²¡å‹™</div>
  <div class="tab-btn" data-tab="feedback">å›é¥‹</div>
  <div class="tab-btn admin-only hidden" data-tab="admin">ç®¡ç†</div>
</div>

<!-- å€‹äººè³‡æ–™ -->
<div class="panel active" id="panel-profile">
  <div class="card">
    <h3 style="margin-top:0">ğŸ“ æœƒå“¡è¨»å†Š / æ›´æ–°</h3>
    <div class="grid cols-2">
      <div>
        <label for="realName">çœŸå¯¦å§“å *</label>
        <input id="realName" type="text" autocomplete="name" placeholder="è«‹è¼¸å…¥å§“å">
      </div>
      <div>
        <label for="memberType">æœƒå“¡é¡åˆ¥ *</label>
        <select id="memberType">
          <option value="">è«‹é¸æ“‡</option>
          <option value="patient">ç—…å‹</option>
          <option value="family">å®¶å±¬</option>
          <option value="volunteer">å¿—å·¥</option>
          <option value="medical">é†«è­·äººå“¡</option>
          <option value="supporter">æ”¯æŒè€…</option>
        </select>
      </div>
    </div>
    <div class="actions mt">
      <button class="btn" id="btn-register"><span class="text">è¨»å†Š / æ›´æ–°</span></button>
    </div>
    <div class="separator"></div>
    <h4>ğŸ“ è¯çµ¡è³‡è¨Š</h4>
    <div class="grid cols-2">
      <div>
        <label for="phone">é›»è©±</label>
        <input id="phone" type="tel" placeholder="ä¾‹ï¼š0912345678">
      </div>
      <div>
        <label for="email">é›»å­éƒµä»¶</label>
        <input id="email" type="email" autocomplete="email">
      </div>
      <div>
        <label for="address">åœ°å€</label>
        <input id="address" type="text">
      </div>
      <div>
        <label for="birthday">ç”Ÿæ—¥</label>
        <input id="birthday" type="date">
      </div>
    </div>
    <div class="actions mt">
      <button class="btn secondary" id="btn-update-contact"><span class="text">æ›´æ–°è¯çµ¡è³‡è¨Š</span></button>
    </div>
  </div>
</div>

<!-- æ´»å‹• -->
<div class="panel" id="panel-activities">
  <div class="grid cols-2 mb">
    <div class="stat"><div class="num" id="stat-activity-total">0</div><div class="label">å¯å ±åæ´»å‹•</div></div>
    <div class="stat"><div class="num" id="stat-my-registrations">0</div><div class="label">æˆ‘çš„å ±å</div></div>
  </div>

  <div class="card">
    <div class="flex space-between" style="align-items:center;">
      <h3 style="margin:0">ğŸ“… å¯å ±åæ´»å‹•</h3>
      <div class="search-bar" style="width:230px;">
        <span class="icon">ğŸ”</span>
        <input id="activity-search" type="text" placeholder="æœå°‹æ´»å‹•â€¦">
      </div>
    </div>
    <div id="activity-list" style="margin-top:14px;"></div>
    <div class="pagination" id="activity-pagination"></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">ğŸ—‚ æˆ‘çš„æ´»å‹•å ±å</h3>
    <div id="my-activity-list"></div>
  </div>
</div>

<!-- ææ¬¾ -->
<div class="panel" id="panel-donations">
  <div class="grid cols-2 mb">
    <div class="stat"><div class="num" id="stat-donation-count">0</div><div class="label">ææ¬¾ç­†æ•¸</div></div>
    <div class="stat"><div class="num" id="stat-donation-total">0</div><div class="label">ææ¬¾ç¸½é¡</div></div>
  </div>
  <div class="card">
    <h3 style="margin-top:0">ğŸ’ æ–°å¢ææ¬¾</h3>
    <div class="grid cols-2">
      <div>
        <label for="donation-amount">é‡‘é¡ *</label>
        <input id="donation-amount" type="number" min="1" placeholder="è‡³å°‘ 1">
      </div>
      <div>
        <label for="donor-name">ææ¬¾äººå§“å (å¯ç•™ç©º)</label>
        <input id="donor-name" type="text">
      </div>
    </div>
    <div>
      <label for="donation-notes">å‚™è¨»</label>
      <textarea id="donation-notes" placeholder="ææ¬¾ç”¨é€” / å‚™è¨»"></textarea>
    </div>
    <div class="actions mt">
      <button class="btn" id="btn-add-donation"><span class="text">æ–°å¢ææ¬¾è¨˜éŒ„</span></button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">ğŸ“Š æˆ‘çš„ææ¬¾è¨˜éŒ„</h3>
    <div id="donation-list"></div>
  </div>
</div>

<!-- æ”¯å‡º / è²¡å‹™ -->
<div class="panel" id="panel-finance">
  <div class="card admin-only hidden" id="accounts-card">
    <h3 style="margin-top:0">ğŸ’³ å¸³æˆ¶é¤˜é¡</h3>
    <div id="account-list"></div>
  </div>

  <div class="card admin-only hidden" id="budget-card">
    <h3 style="margin-top:0">ğŸ“ˆ æœ¬æœˆé ç®—ä½¿ç”¨ç‹€æ³</h3>
    <div class="progress"><div id="budget-progress"></div></div>
    <div id="budget-detail" style="font-size:14px; margin-top:10px;"></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">ğŸ’¸ æ”¯å‡ºç”³è«‹</h3>
    <div class="grid cols-2">
      <div>
        <label for="expense-category">æ”¯å‡ºé¡åˆ¥ *</label>
        <select id="expense-category">
          <option value="activity">æ´»å‹•æ”¯å‡º</option>
          <option value="office">è¾¦å…¬è²»ç”¨</option>
          <option value="marketing">å®£å‚³è²»ç”¨</option>
          <option value="equipment">è¨­å‚™è²»ç”¨</option>
          <option value="welfare">ç¦åˆ©æ”¯å‡º</option>
          <option value="medical">é†«ç™‚æ”¯æ´</option>
          <option value="volunteer">å¿—å·¥è²»ç”¨</option>
          <option value="other">å…¶ä»–æ”¯å‡º</option>
        </select>
      </div>
      <div>
        <label for="expense-amount">é‡‘é¡ *</label>
        <input id="expense-amount" type="number" min="1" placeholder="è«‹è¼¸å…¥é‡‘é¡">
      </div>
    </div>
    <div>
      <label for="expense-description">èªªæ˜ *</label>
      <textarea id="expense-description" placeholder="è«‹è©³ç´°å¡«å¯«ç”¨é€”"></textarea>
    </div>
    <div class="actions mt">
      <button class="btn" id="btn-submit-expense"><span class="text">æäº¤æ”¯å‡ºç”³è«‹</span></button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">ğŸ—‚ æˆ‘çš„æ”¯å‡ºç”³è«‹</h3>
    <div id="my-expense-list"></div>
  </div>
</div>

<!-- å›é¥‹ -->
<div class="panel" id="panel-feedback">
  <div class="card">
    <h3 style="margin-top:0">ğŸ“ æ´»å‹•å›é¥‹</h3>
    <div class="grid cols-2">
      <div>
        <label for="feedback-activity">æ´»å‹• *</label>
        <select id="feedback-activity">
          <option value="">è«‹é¸æ“‡æ´»å‹•</option>
        </select>
      </div>
      <div>
        <label for="feedback-rating">è©•åˆ† (1~5) *</label>
        <select id="feedback-rating">
          <option value="">è«‹é¸æ“‡</option>
          <option value="1">1 - å¾ˆä¸æ»¿æ„</option>
          <option value="2">2 - ä¸æ»¿æ„</option>
          <option value="3">3 - ä¸€èˆ¬</option>
          <option value="4">4 - æ»¿æ„</option>
          <option value="5">5 - éå¸¸æ»¿æ„</option>
        </select>
      </div>
    </div>
    <div>
      <label for="feedback-comment">æ„è¦‹ / å»ºè­°</label>
      <textarea id="feedback-comment" placeholder="åˆ†äº«æ‚¨çš„å¿ƒå¾— (é¸å¡«)"></textarea>
    </div>
    <div class="actions mt">
      <button class="btn" id="btn-submit-feedback"><span class="text">æäº¤å›é¥‹</span></button>
    </div>
  </div>
  <div class="card">
    <h3 style="margin-top:0">ğŸ“Š æˆ‘çš„å›é¥‹è¨˜éŒ„</h3>
    <div id="my-feedback-list"></div>
  </div>
</div>

<!-- ç®¡ç† -->
<div class="panel" id="panel-admin">
  <div class="grid cols-4 mb">
    <div class="stat"><div class="num" id="stat-total-members">0</div><div class="label">ç¸½æœƒå“¡</div></div>
    <div class="stat"><div class="num" id="stat-registered-members">0</div><div class="label">å·²è¨»å†Š</div></div>
    <div class="stat"><div class="num" id="stat-active-activities">0</div><div class="label">é–‹æ”¾æ´»å‹•</div></div>
    <div class="stat"><div class="num" id="stat-total-registrations">0</div><div class="label">æœ‰æ•ˆå ±å</div></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">ğŸ¯ å»ºç«‹æ´»å‹•</h3>
    <div class="grid cols-2">
      <div>
        <label for="new-activity-name">åç¨± *</label>
        <input id="new-activity-name" type="text">
      </div>
      <div>
        <label for="new-activity-date">æ—¥æœŸæ™‚é–“ *</label>
        <input id="new-activity-date" type="datetime-local">
      </div>
      <div>
        <label for="new-activity-location">åœ°é»</label>
        <input id="new-activity-location" type="text">
      </div>
      <div>
        <label for="new-activity-max">æœ€å¤§äººæ•¸ (ç©º=ä¸é™)</label>
        <input id="new-activity-max" type="number" min="1">
      </div>
      <div>
        <label for="new-activity-fee">è²»ç”¨ (0=å…è²»)</label>
        <input id="new-activity-fee" type="number" min="0" value="0">
      </div>
    </div>
    <div>
      <label for="new-activity-desc">æè¿° *</label>
      <textarea id="new-activity-desc"></textarea>
    </div>
    <div class="actions mt">
      <button class="btn" id="btn-create-activity"><span class="text">å»ºç«‹æ´»å‹•</span></button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">ğŸ‘¥ æœƒå“¡æœå°‹</h3>
    <div class="grid cols-3">
      <div>
        <label for="member-search">é—œéµå­—</label>
        <input id="member-search" type="text" placeholder="å§“å / LINE ID">
      </div>
      <div>
        <label for="member-type-filter">æœƒå“¡é¡åˆ¥</label>
          <select id="member-type-filter">
            <option value="">å…¨éƒ¨</option>
            <option value="patient">ç—…å‹</option>
            <option value="family">å®¶å±¬</option>
            <option value="volunteer">å¿—å·¥</option>
            <option value="medical">é†«è­·</option>
            <option value="supporter">æ”¯æŒè€…</option>
          </select>
      </div>
      <div class="actions" style="align-items:flex-end;">
        <button class="btn secondary" id="btn-search-members"><span class="text">æœå°‹</span></button>
      </div>
    </div>
    <div id="member-result" class="mt"></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">ğŸ’¸ æ”¯å‡ºå¯©æ ¸</h3>
    <div id="pending-expense-list"></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">ğŸ“Š æœˆå ±è¡¨</h3>
    <div class="grid cols-3">
      <div>
        <label for="report-year">å¹´ä»½ *</label>
        <input id="report-year" type="number" min="2023" max="2035" value="2024">
      </div>
      <div>
        <label for="report-month">æœˆä»½ *</label>
        <select id="report-month">
          <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option>
          <option value="4">4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option>
          <option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option>
          <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
        </select>
      </div>
      <div class="actions" style="align-items:flex-end;">
        <button class="btn" id="btn-generate-report"><span class="text">ç”¢ç”Ÿå ±è¡¨</span></button>
      </div>
    </div>
    <div id="report-result" class="mt"></div>
  </div>
</div>

</div>
<footer>
å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ± v2.2 Â© 2024
</footer>

<!-- é€šçŸ¥å®¹å™¨ -->
<div id="notify-root"></div>

<script>
/* ==============================
 åŸºæœ¬è¨­å®š
============================== */
const APP = {
LIFF_ID: '1656516134-VaGgmaPm', // TODO: æ›¿æ›ç‚ºå¯¦éš› LIFF ID
API_URL: 'https://script.google.com/macros/s/AKfycbxK1v7_RsApBs6-J2a8GEZlJTFI5pqWqjBJJXpAGtT2pxh-_JZbX424AFyuyQpJU7buUg/exec',
RETRIES: 3,
RETRY_DELAY: 800,
PAGE_SIZE: 6
};

let currentUser = null;
let isAdmin = false;
let cachedActivities = [];
let cachedMyActivities = [];
let filteredActivities = [];
let currentActivityPage = 1;

/* ==============================
 å·¥å…·æ–¹æ³•
============================== */
function fmtDate(d){
if (!d) return '';
const dt = (d instanceof Date)? d : new Date(d);
if (isNaN(dt.getTime())) return '';
return dt.toLocaleDateString('zh-TW', { year:'numeric', month:'2-digit', day:'2-digit' });
}
function fmtDateTime(d){
if (!d) return '';
const dt = (d instanceof Date)? d : new Date(d);
if (isNaN(dt.getTime())) return '';
return dt.toLocaleString('zh-TW', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
}
function numberFormat(n){ return (n||0).toLocaleString('zh-TW'); }
function setLoading(btn, loading){
if (!btn) return;
if (loading){
  btn.classList.add('loading');
  btn.disabled = true;
} else {
  btn.classList.remove('loading');
  btn.disabled = false;
}
}
function showNotification(msg, type='info', duration=4000){
const root = document.getElementById('notify-root');
const el = document.createElement('div');
el.className = `notification ${type==='success'?'success': type==='error'?'error': type==='warn'?'warn':''}`;
el.innerHTML = `<div style="flex:1;">${msg}</div><button aria-label="close">&times;</button>`;
el.querySelector('button').onclick = ()=> { el.classList.remove('show'); setTimeout(()=>el.remove(),300); };
root.appendChild(el);
requestAnimationFrame(()=> el.classList.add('show'));
if (duration>0){
  setTimeout(()=> {
    el.classList.remove('show');
    setTimeout(()=>el.remove(),350);
  }, duration);
}
}
function debounce(fn, delay){
let t; return (...args)=>{
  clearTimeout(t); t=setTimeout(()=>fn(...args), delay);
};
}

/* ==============================
 API å‘¼å«å±¤ (é¿å… CORS preflight)
============================== */
async function callAPI(action, data={}){
const payload = {
  action,
  apiKey: APP.API_KEY,
  ts: Date.now(),
  nonce: Math.random().toString(36).slice(2),
  ...data
};
for (let attempt=1; attempt<=APP.RETRIES; attempt++){
  try {
    // ä½¿ç”¨ text/plain æ¸›å°‘ preflight
    const resp = await fetch(APP.API_URL, {
      method: 'POST',
      headers: {
        'Content-Type':'text/plain;charset=utf-8'
      },
      body: JSON.stringify(payload)
    });
    if (!resp.ok){
      throw new Error(`HTTP ${resp.status}`);
    }
    const json = await resp.json();
    if (!json.success) {
      // 4xx/5xx éŒ¯èª¤
      return json;
    }
    return json;
  } catch (e){
    if (attempt === APP.RETRIES) {
      return { success:false, message: e.message || 'API å‘¼å«å¤±æ•—', statusCode: 500 };
    }
    await new Promise(r=> setTimeout(r, APP.RETRY_DELAY * attempt));
  }
}
}

/* ==============================
 LIFF åˆå§‹åŒ–
============================== */
async function initApp(){
try {
  showNotification('åˆå§‹åŒ–ä¸­...', 'info', 1800);
  await liff.init({ liffId: APP.LIFF_ID });
  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }
  const profile = await liff.getProfile();
  await callAPI('createUserIfNotExist', { lineId: profile.userId, lineName: profile.displayName });
  await loadUserInfo();
  showNotification('è¼‰å…¥å®Œæˆ', 'success', 1500);
  bindEvents();
  // é è¼‰
  loadActivities();
  loadMyActivities();
  loadDonations();
  loadMyExpenses();
  loadMyFeedback();
} catch (e){
  console.error(e);
  showNotification('åˆå§‹åŒ–å¤±æ•—ï¼š'+ e.message, 'error', 6000);
}
}

/* ==============================
 ä½¿ç”¨è€…
============================== */
async function loadUserInfo(){
const profile = await liff.getProfile();
const res = await callAPI('getUserInfo',{ lineId: profile.userId });
if (!res.success){
  showNotification('ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡æ–™', 'error');
  return;
}
currentUser = res.data;
isAdmin = !!currentUser.isAdmin;
renderUserInfo();
updateAdminVisibility();
}
function renderUserInfo(){
const box = document.getElementById('user-info');
const d = document.getElementById('user-details');
if (!currentUser){ box.classList.add('hidden'); return; }
const map = {
  patient: 'ç—…å‹',
  family: 'å®¶å±¬',
  volunteer: 'å¿—å·¥',
  medical: 'é†«è­·äººå“¡',
  supporter: 'æ”¯æŒè€…'
};
d.innerHTML = `
  <div class="grid cols-2" style="gap:10px; font-size:13px;">
    <div><b>å§“åï¼š</b>${currentUser.realName||'<span style="color:#999">æœªè¨­å®š</span>'}</div>
    <div><b>LINE åç¨±ï¼š</b>${currentUser.lineName||''}</div>
    <div><b>ç‹€æ…‹ï¼š</b>${ currentUser.status === 'å·²è¨»å†Š'
      ? '<span class="badge green">å·²è¨»å†Š</span>' : '<span class="badge red">æœªè¨»å†Š</span>' }</div>
    <div><b>æœƒå“¡é¡åˆ¥ï¼š</b>${ map[currentUser.memberType] || currentUser.memberType || '<span style="color:#999">æœªè¨­å®š</span>'}</div>
    <div><b>äº’å‹•æ¬¡æ•¸ï¼š</b>${currentUser.messageCount||0}</div>
    <div><b>æœ€å¾Œäº’å‹•ï¼š</b>${ fmtDate(currentUser.lastActive) || '' }</div>
    ${ isAdmin ? '<div><b>æ¬Šé™ï¼š</b><span class="badge">ç®¡ç†å“¡</span></div>' : '' }
  </div>
`;
box.classList.remove('hidden');

// å¡«å¯«æ¬„ä½
if (currentUser.realName) document.getElementById('realName').value = currentUser.realName;
if (currentUser.memberType) document.getElementById('memberType').value = currentUser.memberType;
document.getElementById('phone').value = currentUser.phone||'';
document.getElementById('email').value = currentUser.email||'';
document.getElementById('address').value = currentUser.address||'';
if (currentUser.birthday) {
  const dt = new Date(currentUser.birthday);
  if (!isNaN(dt.getTime())){
    document.getElementById('birthday').value = dt.toISOString().slice(0,10);
  }
}
}
function updateAdminVisibility(){
const adminEls = document.querySelectorAll('.admin-only');
adminEls.forEach(el=> {
  if (isAdmin) el.classList.remove('hidden'); else el.classList.add('hidden');
});
}

/* ==============================
 æœƒå“¡è¨»å†Š / æ›´æ–°
============================== */
async function registerOrUpdate(){
if (!currentUser) return;
const name = document.getElementById('realName').value.trim();
const type = document.getElementById('memberType').value;
if (!name || !type) {
  showNotification('è«‹å¡«å¯«å§“åèˆ‡é¡åˆ¥', 'warn');
  return;
}
const btn = document.getElementById('btn-register');
setLoading(btn,true);
const res = await callAPI('register',{
  lineId: currentUser.lineId,
  realName: name,
  memberType: type
});
setLoading(btn,false);
if (res.success){
  showNotification('è¨»å†Š / æ›´æ–°æˆåŠŸ','success');
  await loadUserInfo();
} else {
  showNotification('è¨»å†Šå¤±æ•—ï¼š'+res.message,'error');
}
}
async function updateContact(){
if (!currentUser) return;
const phone = document.getElementById('phone').value.trim();
const email = document.getElementById('email').value.trim();
const address = document.getElementById('address').value.trim();
const birthday = document.getElementById('birthday').value;
const btn = document.getElementById('btn-update-contact');
setLoading(btn,true);
const res = await callAPI('updateUserContact',{
  targetLineId: currentUser.lineId,
  phone, email, address, birthday
});
setLoading(btn,false);
if (res.success){
  showNotification('è¯çµ¡è³‡è¨Šå·²æ›´æ–°','success');
  await loadUserInfo();
} else {
  showNotification('æ›´æ–°å¤±æ•—ï¼š'+res.message,'error');
}
}

/* ==============================
 æ´»å‹•
============================== */
async function loadActivities(){
const res = await callAPI('getActivities');
if (!res.success){
  document.getElementById('activity-list').innerHTML = `<div class="notice error">è¼‰å…¥æ´»å‹•å¤±æ•—ï¼š${res.message}</div>`;
  return;
}
cachedActivities = res.data || [];
filteredActivities = cachedActivities.slice();
currentActivityPage = 1;
document.getElementById('stat-activity-total').textContent = cachedActivities.length;
renderActivities();
}
function renderActivities(){
const listEl = document.getElementById('activity-list');
if (!filteredActivities.length){
  listEl.innerHTML = `<div class="empty"><div class="icon">ğŸ¯</div>ç›®å‰æ²’æœ‰æ´»å‹•</div>`;
  document.getElementById('activity-pagination').innerHTML='';
  return;
}
const totalPages = Math.ceil(filteredActivities.length / APP.PAGE_SIZE);
if (currentActivityPage > totalPages) currentActivityPage = totalPages;
const start = (currentActivityPage-1)*APP.PAGE_SIZE;
const pageItems = filteredActivities.slice(start, start+APP.PAGE_SIZE);
listEl.innerHTML = pageItems.map(a=>{
  const max = a.maxParticipants || 'ä¸é™';
  const cur = a.currentParticipants || 0;
  const full = a.maxParticipants && cur >= a.maxParticipants;
  return `<div class="list-item ${full?'full':''}">
    <h4>${a.name}</h4>
    <div class="meta">
      <span>ğŸ“… ${ fmtDateTime(a.date) || 'å¾…å®š' }</span>
      <span>ğŸ“ ${ a.location || 'å¾…å®š' }</span>
      <span>ğŸ‘¥ ${cur}/${max}</span>
      <span>${ a.fee ? 'ğŸ’° NT$ '+numberFormat(a.fee) : 'ğŸ†“ å…è²»'}</span>
    </div>
    <div style="margin-top:8px;font-size:13px;line-height:1.5;">${ a.description || '' }</div>
    <div class="actions" style="margin-top:12px;">
      ${ full
        ? '<span class="badge red">å·²é¡æ»¿</span>'
        : `<button class="btn" data-act-register="${a.id}"><span class="text">å ±å</span></button>` }
    </div>
  </div>`;
}).join('');
renderPagination('activity-pagination', totalPages, currentActivityPage, p=>{
  currentActivityPage = p; renderActivities();
});
// ç¶å®šå ±åæŒ‰éˆ•
listEl.querySelectorAll('[data-act-register]').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    const id = btn.getAttribute('data-act-register');
    const target = cachedActivities.find(x=>x.id===id);
    if (target) registerActivity(target);
  });
});
}
function renderPagination(id, totalPages, current, onChange){
const el = document.getElementById(id);
if (totalPages <=1 ){ el.innerHTML=''; return; }
let html='';
for (let i=1;i<=totalPages;i++){
  html += `<button class="${ i===current?'active':'' }" data-page="${i}">${i}</button>`;
}
el.innerHTML = html;
el.querySelectorAll('button').forEach(b=>{
  b.addEventListener('click', ()=> {
    const p = +b.getAttribute('data-page');
    onChange(p);
  });
});
}
const searchActivities = debounce(()=>{
const kw = document.getElementById('activity-search').value.trim().toLowerCase();
if (!kw){
  filteredActivities = cachedActivities.slice();
} else {
  filteredActivities = cachedActivities.filter(a =>
    (a.name && a.name.toLowerCase().includes(kw)) ||
    (a.description && a.description.toLowerCase().includes(kw)) ||
    (a.location && a.location.toLowerCase().includes(kw))
  );
}
currentActivityPage=1;
renderActivities();
}, 300);

async function registerActivity(activity){
if (!currentUser || currentUser.status!=='å·²è¨»å†Š'){
  showNotification('è«‹å…ˆå®Œæˆè¨»å†Š','warn');
  switchTab('profile');
  return;
}
if (!confirm(`ç¢ºèªå ±åæ´»å‹•ã€Œ${activity.name}ã€?`)) return;
const res = await callAPI('registerActivity',{
  lineId: currentUser.lineId,
  activityId: activity.id,
  participantName: currentUser.realName || currentUser.lineName
});
if (res.success){
  showNotification('å ±åæˆåŠŸ','success');
  await Promise.all([loadActivities(), loadMyActivities()]);
} else {
  showNotification('å ±åå¤±æ•—ï¼š'+res.message,'error');
}
}
async function loadMyActivities(){
if (!currentUser) return;
const res = await callAPI('getUserActivities',{ lineId: currentUser.lineId });
const box = document.getElementById('my-activity-list');
if (!res.success){
  box.innerHTML = `<div class="notice error">${res.message}</div>`;
  return;
}
cachedMyActivities = res.data||[];
document.getElementById('stat-my-registrations').textContent = cachedMyActivities.length;
if (!cachedMyActivities.length){
  box.innerHTML = `<div class="empty"><div class="icon">ğŸ“‹</div>å°šç„¡å ±åè¨˜éŒ„</div>`;
  return;
}
box.innerHTML = cachedMyActivities.map(r=>{
  return `<div class="list-item">
    <h4>${r.activityName}</h4>
    <div class="meta">
      <span>ğŸ“… ${ fmtDateTime(r.date) }</span>
      <span>ğŸ“ ${ r.location || 'å¾…å®š' }</span>
      <span>ğŸ‘¤ ${ r.participantName }</span>
      <span>ğŸ“ å ±åï¼š${ fmtDate(r.registerDate) }</span>
    </div>
    <div style="margin-top:4px;">
      ç‹€æ…‹ï¼š${
        r.status==='å·²å ±å' ? '<span class="badge green">å·²å ±å</span>' :
        r.status==='å·²å–æ¶ˆ' ? '<span class="badge red">å·²å–æ¶ˆ</span>' :
        `<span class="badge orange">${r.status||'æœªçŸ¥'}</span>`
      }
    </div>
    ${ r.status==='å·²å ±å'
      ? `<div class="actions" style="margin-top:8px;">
           <button class="btn danger" data-cancel="${r.id}"><span class="text">å–æ¶ˆå ±å</span></button>
         </div>` : ''
    }
  </div>`;
}).join('');
// for feedback selection
buildFeedbackActivityOptions();

box.querySelectorAll('[data-cancel]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const id = btn.getAttribute('data-cancel');
    cancelRegistration(id);
  });
});
}
async function cancelRegistration(regId){
if (!confirm('ç¢ºå®šå–æ¶ˆæ­¤å ±å?')) return;
const res = await callAPI('cancelActivity',{ lineId: currentUser.lineId, registrationId: regId });
if (res.success){
  showNotification('å·²å–æ¶ˆ','success');
  await Promise.all([loadActivities(), loadMyActivities()]);
} else {
  showNotification('å–æ¶ˆå¤±æ•—ï¼š'+res.message,'error');
}
}

/* ==============================
 ææ¬¾
============================== */
async function addDonation(){
if (!currentUser) return;
const amt = parseFloat(document.getElementById('donation-amount').value);
if (!amt || amt<=0){
  showNotification('é‡‘é¡éœ€ > 0','warn'); return;
}
const donorName = document.getElementById('donor-name').value.trim();
const notes = document.getElementById('donation-notes').value.trim();
const btn = document.getElementById('btn-add-donation');
setLoading(btn,true);
const res = await callAPI('addDonation',{
  lineId: currentUser.lineId,
  amount: amt,
  donorName,
  notes
});
setLoading(btn,false);
if (res.success){
  showNotification('ææ¬¾æˆåŠŸ','success');
  document.getElementById('donation-amount').value='';
  document.getElementById('donor-name').value='';
  document.getElementById('donation-notes').value='';
  loadDonations();
} else {
  showNotification('ææ¬¾å¤±æ•—ï¼š'+res.message,'error');
}
}
async function loadDonations(){
if (!currentUser) return;
const box = document.getElementById('donation-list');
const res = await callAPI('getDonations',{ lineId: currentUser.lineId });
if (!res.success){
  box.innerHTML = `<div class="notice error">${res.message}</div>`;
  return;
}
const arr = res.data||[];
document.getElementById('stat-donation-count').textContent = arr.length;
const total = arr.reduce((s,d)=> s + (parseFloat(d.amount)||0), 0);
document.getElementById('stat-donation-total').textContent = 'NT$ ' + numberFormat(total);
if (!arr.length){
  box.innerHTML = `<div class="empty"><div class="icon">ğŸ’°</div>å°šç„¡ææ¬¾è¨˜éŒ„</div>`;
  return;
}
box.innerHTML = arr.map(d=>`
  <div class="list-item">
    <h4>ææ¬¾ NT$ ${ numberFormat(d.amount) }</h4>
    <div class="meta">
      <span>ğŸ•’ ${ fmtDateTime(d.date) }</span>
      <span>ğŸ™ ${ d.donorName || 'åŒ¿å' }</span>
    </div>
    ${ d.notes ? `<div style="margin-top:6px;font-size:13px;">å‚™è¨»ï¼š${d.notes}</div>`:''}
  </div>
`).join('');
}

/* ==============================
 æ”¯å‡º
============================== */
async function submitExpense(){
if (!currentUser) return;
const category = document.getElementById('expense-category').value;
const amount = parseFloat(document.getElementById('expense-amount').value);
const desc = document.getElementById('expense-description').value.trim();
if (!category || !amount || amount<=0 || !desc){
  showNotification('è«‹å®Œæ•´å¡«å¯«æ”¯å‡ºè³‡è¨Š','warn'); return;
}
const btn = document.getElementById('btn-submit-expense');
setLoading(btn,true);
const res = await callAPI('submitExpense',{
  lineId: currentUser.lineId,
  category,
  amount,
  description: desc
});
setLoading(btn,false);
if (res.success){
  showNotification('æ”¯å‡ºç”³è«‹å·²æäº¤','success');
  document.getElementById('expense-amount').value='';
  document.getElementById('expense-description').value='';
  loadMyExpenses();
} else {
  showNotification('æäº¤å¤±æ•—ï¼š'+res.message,'error');
}
}
async function loadMyExpenses(){
if (!currentUser) return;
const box = document.getElementById('my-expense-list');
const res = await callAPI('getMyExpenses',{ lineId: currentUser.lineId });
if (!res.success){
  box.innerHTML = `<div class="notice error">${res.message}</div>`;
  return;
}
const arr = res.data||[];
if (!arr.length){
  box.innerHTML = `<div class="empty"><div class="icon">ğŸ“‹</div>å°šç„¡æ”¯å‡ºç”³è«‹</div>`;
  return;
}
box.innerHTML = arr.map(e=>{
  const statusClass =
    e.status==='å·²æ ¸å‡†' ? 'green' :
    e.status==='å·²æ‹’çµ•' ? 'red' :
    'orange';
  return `<div class="list-item">
    <h4>${ e.category } - NT$ ${ numberFormat(e.amount) }</h4>
    <div class="meta">
      <span>ğŸ•’ ç”³è«‹ï¼š${ fmtDateTime(e.submitDate) }</span>
      ${ e.approvedDate ? `<span>ğŸ” å¯©æ ¸ï¼š${ fmtDateTime(e.approvedDate) }</span>`:''}
    </div>
    <div style="margin-top:4px;">ç‹€æ…‹ï¼š<span class="badge ${statusClass}">${e.status}</span></div>
    ${ e.description ? `<div style="margin-top:4px;font-size:13px;">èªªæ˜ï¼š${e.description}</div>`:''}
    ${ e.notes ? `<div style="margin-top:4px;font-size:13px;">å¯©æ ¸å‚™è¨»ï¼š${e.notes}</div>`:''}
  </div>`;
}).join('');
}

/* ==============================
 å›é¥‹
============================== */
function buildFeedbackActivityOptions(){
const select = document.getElementById('feedback-activity');
const active = cachedMyActivities.filter(a=> a.status==='å·²å ±å');
select.innerHTML = '<option value="">è«‹é¸æ“‡æ´»å‹•</option>' + active.map(a=> `<option value="${a.activityId}">${a.activityName}</option>`).join('');
}
async function submitFeedback(){
if (!currentUser) return;
const activityId = document.getElementById('feedback-activity').value;
const rating = parseInt(document.getElementById('feedback-rating').value, 10);
const comment = document.getElementById('feedback-comment').value.trim();
if (!activityId || !rating){
  showNotification('è«‹é¸æ“‡æ´»å‹•èˆ‡è©•åˆ†','warn'); return;
}
const btn = document.getElementById('btn-submit-feedback');
setLoading(btn,true);
const res = await callAPI('submitFeedback',{
  lineId: currentUser.lineId,
  activityId,
  rating,
  comment
});
setLoading(btn,false);
if (res.success){
  showNotification('å›é¥‹å·²æäº¤','success');
  document.getElementById('feedback-activity').value='';
  document.getElementById('feedback-rating').value='';
  document.getElementById('feedback-comment').value='';
  loadMyFeedback();
} else {
  showNotification('æäº¤å¤±æ•—ï¼š'+res.message,'error');
}
}
async function loadMyFeedback(){
if (!currentUser) return;
const box = document.getElementById('my-feedback-list');
const res = await callAPI('getMyFeedback',{ lineId: currentUser.lineId });
if (!res.success){
  box.innerHTML = `<div class="notice error">${res.message}</div>`;
  return;
}
const arr = res.data||[];
if (!arr.length){
  box.innerHTML = `<div class="empty"><div class="icon">ğŸ“</div>å°šç„¡å›é¥‹</div>`;
  return;
}
box.innerHTML = arr.map(f=>{
  const stars = 'â­'.repeat(f.rating) + 'â˜†'.repeat(5-f.rating);
  return `<div class="list-item">
    <h4>${f.activityName}</h4>
    <div class="meta">
      <span>è©•åˆ†ï¼š${stars} (${f.rating}/5)</span>
      <span>æ—¥æœŸï¼š${ fmtDate(f.submitDate) }</span>
    </div>
    ${ f.comment ? `<div style="margin-top:6px;font-size:13px;">${f.comment}</div>`:''}
  </div>`;
}).join('');
}

/* ==============================
 ç®¡ç†
============================== */
async function loadSystemStats(){
if (!isAdmin || !currentUser) return;
const res = await callAPI('getSystemStats',{ operatorLineId: currentUser.lineId });
if (res.success){
  const d = res.data;
  document.getElementById('stat-total-members').textContent = d.totalMembers;
  document.getElementById('stat-registered-members').textContent = d.registeredMembers;
  document.getElementById('stat-active-activities').textContent = d.activeActivities;
  document.getElementById('stat-total-registrations').textContent = d.totalRegistrations;
}
}
async function createActivity(){
if (!isAdmin || !currentUser) return;
const name = document.getElementById('new-activity-name').value.trim();
const desc = document.getElementById('new-activity-desc').value.trim();
const date = document.getElementById('new-activity-date').value;
const loc = document.getElementById('new-activity-location').value.trim();
const max = document.getElementById('new-activity-max').value;
const fee = document.getElementById('new-activity-fee').value;
if (!name || !desc || !date){
  showNotification('è«‹å¡«å¯«åç¨± / æè¿° / æ—¥æœŸ','warn');
  return;
}
const btn = document.getElementById('btn-create-activity');
setLoading(btn,true);
const res = await callAPI('createActivity',{
  operatorLineId: currentUser.lineId,
  name, description: desc, date, location: loc,
  maxParticipants: max? parseInt(max,10): '',
  fee: fee? parseFloat(fee): 0
});
setLoading(btn,false);
if (res.success){
  showNotification('å»ºç«‹æ´»å‹•æˆåŠŸ','success');
  ['new-activity-name','new-activity-desc','new-activity-date','new-activity-location','new-activity-max','new-activity-fee'].forEach(id=> document.getElementById(id).value='');
  loadActivities();
  loadSystemStats();
} else {
  showNotification('å»ºç«‹å¤±æ•—ï¼š'+res.message,'error');
}
}
async function searchMembers(){
if (!isAdmin || !currentUser) return;
const kw = document.getElementById('member-search').value.trim();
const type = document.getElementById('member-type-filter').value;
const box = document.getElementById('member-result');
box.innerHTML = '<div class="notice info">æœå°‹ä¸­...</div>';
const res = await callAPI('searchMembers',{
  operatorLineId: currentUser.lineId,
  searchTerm: kw,
  memberType: type
});
if (!res.success){
  box.innerHTML = `<div class="notice error">${res.message}</div>`;
  return;
}
const arr = res.data||[];
if (!arr.length){
  box.innerHTML = `<div class="empty"><div class="icon">ğŸ‘¥</div>ç„¡ç¬¦åˆçµæœ</div>`;
  return;
}
box.innerHTML = arr.map(m=>{
  return `<div class="list-item">
    <h4>${m.realName || '(æœªè¨­å®š)'}</h4>
    <div class="meta">
      <span>LINE: ${m.lineName}</span>
      <span>ç‹€æ…‹: ${ m.status==='å·²è¨»å†Š' ? 'âœ…' : 'â³' }</span>
      <span>äº’å‹•: ${m.messageCount||0}</span>
    </div>
    <div style="margin-top:4px;font-size:13px;">
      ${ m.email ? 'âœ‰ '+m.email+' ' : '' }
      ${ m.phone ? 'ğŸ“ '+m.phone : '' }
    </div>
    <div style="margin-top:4px;font-size:12px;color:#666;">
      æœ€å¾Œæ´»å‹•ï¼š${ fmtDate(m.lastActive) || '-' }
    </div>
  </div>`;
}).join('');
}
async function loadPendingExpenses(){
if (!isAdmin || !currentUser) return;
const box = document.getElementById('pending-expense-list');
const res = await callAPI('getPendingExpenses',{ operatorLineId: currentUser.lineId });
if (!res.success){
  box.innerHTML = `<div class="notice error">${res.message}</div>`;
  return;
}
const arr = res.data||[];
if (!arr.length){
  box.innerHTML = `<div class="empty"><div class="icon">âœ…</div>ç„¡å¾…å¯©æ ¸é …ç›®</div>`;
  return;
}
box.innerHTML = arr.map(e=>{
  return `<div class="list-item">
    <h4>${e.applicantName} - ${e.category}</h4>
    <div class="meta">
      <span>é‡‘é¡: NT$ ${ numberFormat(e.amount) }</span>
      <span>æ—¥æœŸ: ${ fmtDateTime(e.submitDate) }</span>
    </div>
    <div style="margin-top:6px;font-size:13px;">${ e.description || '' }</div>
    <div class="actions" style="margin-top:10px;">
      <button class="btn" data-approve="${e.id}"><span class="text">æ ¸å‡†</span></button>
      <button class="btn danger" data-reject="${e.id}"><span class="text">æ‹’çµ•</span></button>
    </div>
  </div>`;
}).join('');
box.querySelectorAll('[data-approve]').forEach(b=>{
  b.addEventListener('click', ()=> approveExpense(b.getAttribute('data-approve'), true));
});
box.querySelectorAll('[data-reject]').forEach(b=>{
  b.addEventListener('click', ()=> approveExpense(b.getAttribute('data-reject'), false));
});
}
async function approveExpense(id, approved){
const notes = approved ? '' : prompt('æ‹’çµ•åŸå›  (å¯ç•™ç©º)ï¼š','');
const res = await callAPI('approveExpense',{
  operatorLineId: currentUser.lineId,
  expenseId: id,
  approved,
  notes
});
if (res.success){
  showNotification(approved?'å·²æ ¸å‡†':'å·²æ‹’çµ•','success');
  loadPendingExpenses();
  loadMyExpenses();
} else {
  showNotification('æ“ä½œå¤±æ•—ï¼š'+res.message,'error');
}
}
async function generateReport(){
if (!isAdmin || !currentUser) return;
const y = document.getElementById('report-year').value;
const m = document.getElementById('report-month').value;
const box = document.getElementById('report-result');
box.innerHTML = '<div class="notice info">ç”¢ç”Ÿä¸­...</div>';
const res = await callAPI('generateReport',{
  operatorLineId: currentUser.lineId,
  year: parseInt(y,10),
  month: parseInt(m,10)
});
if (!res.success){
  box.innerHTML = `<div class="notice error">${res.message}</div>`;
  return;
}
const d = res.data;
const cb = d.categoryBreakdown || {};
const cbHtml = Object.keys(cb).length
  ? `<div class="grid cols-2" style="margin-top:10px;">${ Object.entries(cb).map(([k,v])=>`
      <div style="background:#f7fafc;padding:10px 12px;border-radius:8px;font-size:13px;">
        <b>${k}</b><br>NT$ ${ numberFormat(v) }
      </div>`).join('') }</div>`
  : '<div style="font-size:13px;color:#666;margin-top:6px;">ç„¡æ”¯å‡ºåˆ†é¡è³‡æ–™</div>';
box.innerHTML = `
  <div class="card" style="margin:0;">
    <h4 style="margin-top:0;">ğŸ“Š ${d.period} å ±è¡¨</h4>
    <div class="grid cols-4" style="margin:10px 0;">
      <div class="stat"><div class="num">NT$ ${ numberFormat(d.totalIncome) }</div><div class="label">ç¸½æ”¶å…¥</div></div>
      <div class="stat"><div class="num">NT$ ${ numberFormat(d.totalExpense) }</div><div class="label">ç¸½æ”¯å‡º</div></div>
      <div class="stat"><div class="num">NT$ ${ numberFormat(d.balance) }</div><div class="label">çµé¤˜</div></div>
      <div class="stat"><div class="num">${ d.donationCount||0 }</div><div class="label">ææ¬¾ç­†æ•¸</div></div>
    </div>
    <h5 style="margin:14px 0 6px;">æ”¯å‡ºåˆ†é¡</h5>
    ${ cbHtml }
  </div>
`;
}
async function loadAccountsAndBudget(){
if (!isAdmin || !currentUser) return;
// å¸³æˆ¶
const accRes = await callAPI('getAccounts',{ operatorLineId: currentUser.lineId });
const accBox = document.getElementById('account-list');
if (accRes.success){
  const arr = accRes.data||[];
  accBox.innerHTML = arr.map(a=>`
    <div class="list-item">
      <h4>${a.name}</h4>
      <div class="meta">
        <span>é¡å‹: ${a.type}</span>
        <span>é¤˜é¡: NT$ ${ numberFormat(a.balance) }</span>
      </div>
    </div>
  `).join('');
} else {
  accBox.innerHTML = `<div class="notice error">${accRes.message}</div>`;
}
// é ç®—
const bdRes = await callAPI('getBudgetStatus',{ operatorLineId: currentUser.lineId });
const prog = document.getElementById('budget-progress');
const detail = document.getElementById('budget-detail');
if (bdRes.success){
  const d = bdRes.data;
  prog.style.width = d.budgetUsed + '%';
  detail.innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;">
      <div>æœˆé ç®—ï¼š<b>NT$ ${numberFormat(d.monthlyBudget)}</b></div>
      <div>å·²ä½¿ç”¨ï¼š<b>NT$ ${numberFormat(d.monthlyExpense)}</b></div>
      <div>ä½¿ç”¨ç‡ï¼š<b>${d.budgetUsed}%</b></div>
      <div>å‰©é¤˜ï¼š<b>NT$ ${numberFormat(d.remainingBudget)}</b></div>
    </div>
  `;
} else {
  detail.innerHTML = `<div class="notice error">${bdRes.message}</div>`;
}
}

/* ==============================
 åˆ†é åˆ‡æ›
============================== */
function switchTab(tab){
document.querySelectorAll('.tab-btn').forEach(t=>{
  t.classList.toggle('active', t.dataset.tab===tab);
});
document.querySelectorAll('.panel').forEach(p=>{
  p.classList.toggle('active', p.id === 'panel-'+tab);
});
// Lazy load
if (tab==='activities'){ loadActivities(); loadMyActivities(); }
if (tab==='donations'){ loadDonations(); }
if (tab==='finance'){ loadMyExpenses(); if(isAdmin) loadAccountsAndBudget(); }
if (tab==='feedback'){ loadMyActivities(); loadMyFeedback(); }
if (tab==='admin'){ if(isAdmin){ loadSystemStats(); loadPendingExpenses(); } }
}

/* ==============================
 ç¶å®šäº‹ä»¶
============================== */
function bindEvents(){
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=> switchTab(btn.dataset.tab));
});

document.getElementById('activity-search').addEventListener('input', searchActivities);

document.getElementById('btn-register').addEventListener('click', registerOrUpdate);
document.getElementById('btn-update-contact').addEventListener('click', updateContact);
document.getElementById('btn-add-donation').addEventListener('click', addDonation);
document.getElementById('btn-submit-expense').addEventListener('click', submitExpense);
document.getElementById('btn-submit-feedback').addEventListener('click', submitFeedback);
document.getElementById('btn-create-activity').addEventListener('click', createActivity);
document.getElementById('btn-search-members').addEventListener('click', searchMembers);
document.getElementById('btn-generate-report').addEventListener('click', generateReport);
}

/* ==============================
 å•Ÿå‹•
============================== */
document.addEventListener('DOMContentLoaded', initApp);

</script>
</body>
</html>
