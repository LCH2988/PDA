<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>帕金森病友會管理系統 v2.0</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
<style>
  :root {
      --primary-color: #667eea;
      --secondary-color: #764ba2;
      --success-color: #48bb78;
      --warning-color: #ed8936;
      --error-color: #f56565;
      --info-color: #4299e1;
      --bg-color: #f7fafc;
      --card-bg: rgba(255, 255, 255, 0.95);
      --text-primary: #2d3748;
      --text-secondary: #718096;
      --border-color: #e2e8f0;
      --shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 8px 32px rgba(0, 0, 0, 0.15);
  }

  * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
  }
  
  body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.6;
  }
  
  .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
  }
  
  /* Header */
  .header {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
  }
  
  .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
  }
  
  .header h1 {
      color: var(--text-primary);
      font-size: 28px;
      margin-bottom: 10px;
      font-weight: 700;
  }
  
  .header .subtitle {
      color: var(--text-secondary);
      font-size: 16px;
  }
  
  .header .version {
      position: absolute;
      top: 15px;
      right: 20px;
      background: var(--primary-color);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
  }
  
  /* User Info Card */
  .user-info {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      display: none;
  }
  
  .user-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
      margin: 0 auto 15px;
  }
  
  .user-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
  }
  
  .user-detail-item {
      display: flex;
      align-items: center;
      gap: 10px;
  }
  
  .user-detail-item .icon {
      width: 20px;
      text-align: center;
  }
  
  /* Navigation Tabs */
  .tabs {
      display: flex;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 5px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
  }
  
  .tabs::-webkit-scrollbar {
      display: none;
  }
  
  .tab {
      flex: 1;
      padding: 12px 16px;
      text-align: center;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      min-width: 100px;
      font-size: 14px;
      font-weight: 500;
  }
  
  .tab.active {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }
  
  .tab:hover:not(.active) {
      background: rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
  }
  
  /* Tab Content */
  .tab-content {
      display: none;
      animation: fadeInUp 0.5s ease-out;
  }
  
  .tab-content.active {
      display: block;
  }
  
  @keyframes fadeInUp {
      from {
          opacity: 0;
          transform: translateY(20px);
      }
      to {
          opacity: 1;
          transform: translateY(0);
      }
  }
  
  /* Cards Grid */
  .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
  }
  
  /* Activity Cards */
  .activity-card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
  }
  
  .activity-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
  }
  
  .activity-card-image {
      height: 180px;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 48px;
  }
  
  .activity-card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
  }
  
  .activity-status-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      backdrop-filter: blur(10px);
  }
  
  .status-registration_open {
      background: rgba(72, 187, 120, 0.9);
      color: white;
  }
  
  .status-published {
      background: rgba(66, 153, 225, 0.9);
      color: white;
  }
  
  .status-completed {
      background: rgba(113, 128, 150, 0.9);
      color: white;
  }
  
  .activity-card-content {
      padding: 20px;
  }
  
  .activity-card-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-primary);
      line-height: 1.4;
  }
  
  .activity-card-description {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 15px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
  }
  
  .activity-card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
      font-size: 13px;
      color: var(--text-secondary);
  }
  
  .activity-card-meta .meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
  }
  
  .activity-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
  }
  
  .activity-participants {
      font-size: 13px;
      color: var(--text-secondary);
  }
  
  .activity-fee {
      font-weight: 700;
      color: var(--primary-color);
      font-size: 16px;
  }
  
  /* Finance Dashboard */
  .finance-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
  }
  
  .finance-card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
  }
  
  .finance-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-color);
  }
  
  .finance-card.income::before {
      background: var(--success-color);
  }
  
  .finance-card.expense::before {
      background: var(--error-color);
  }
  
  .finance-card.budget::before {
      background: var(--warning-color);
  }
  
  .finance-card-title {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
  }
  
  .finance-card-amount {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
  }
  
  .finance-card-change {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 600;
  }
  
  .change-positive {
      background: rgba(72, 187, 120, 0.1);
      color: var(--success-color);
  }
  
  .change-negative {
      background: rgba(245, 101, 101, 0.1);
      color: var(--error-color);
  }
  
  /* Forms */
  .form-container {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
  }
  
  .form-group {
      margin-bottom: 20px;
  }
  
  .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
  }
  
  .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
  }
  
  .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .form-textarea {
      resize: vertical;
      min-height: 100px;
  }
  
  .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
  }
  
  /* Buttons */
  .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-width: 120px;
  }
  
  .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
  }
  
  .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }
  
  .btn-success {
      background: var(--success-color);
      color: white;
  }
  
  .btn-success:hover {
      background: #38a169;
      transform: translateY(-2px);
  }
  
  .btn-warning {
      background: var(--warning-color);
      color: white;
  }
  
  .btn-danger {
      background: var(--error-color);
      color: white;
  }
  
  .btn-outline {
      background: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
  }
  
  .btn-outline:hover {
      background: var(--primary-color);
      color: white;
  }
  
  .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
  }
  
  /* Loading States */
  .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
  }
  
  .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }
  
  /* Messages */
  .message {
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
  }
  
  .message-success {
      background: rgba(72, 187, 120, 0.1);
      color: var(--success-color);
      border: 1px solid rgba(72, 187, 120, 0.3);
  }
  
  .message-error {
      background: rgba(245, 101, 101, 0.1);
      color: var(--error-color);
      border: 1px solid rgba(245, 101, 101, 0.3);
  }
  
  .message-warning {
      background: rgba(237, 137, 54, 0.1);
      color: var(--warning-color);
      border: 1px solid rgba(237, 137, 54, 0.3);
  }
  
  .message-info {
      background: rgba(66, 153, 225, 0.1);
      color: var(--info-color);
      border: 1px solid rgba(66, 153, 225, 0.3);
  }
  
  /* Admin Dashboard */
  .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
  }
  
  .stat-card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
  }
  
  .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary-color);
  }
  
  .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      margin: 0 auto 15px;
  }
  
  .stat-number {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 5px;
  }
  
  .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
  }
  
  /* Tables */
  .table-container {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
  }
  
  .table {
      width: 100%;
      border-collapse: collapse;
  }
  
  .table th,
  .table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
  }
  
  .table th {
      background: rgba(102, 126, 234, 0.1);
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
  }
  
  .table tr:hover {
      background: rgba(102, 126, 234, 0.05);
  }
  
  /* Responsive Design */
  @media (max-width: 768px) {
      .container {
          padding: 15px;
      }
      
      .header {
          padding: 20px;
      }
      
      .header h1 {
          font-size: 24px;
      }
      
      .cards-grid {
          grid-template-columns: 1fr;
      }
      
      .finance-dashboard {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
      
      .form-row {
          grid-template-columns: 1fr;
      }
      
      .tabs {
          flex-wrap: wrap;
      }
      
      .tab {
          flex: none;
          min-width: 80px;
      }
  }
  
  /* Utility Classes */
  .text-center { text-align: center; }
  .text-right { text-align: right; }
  .mb-10 { margin-bottom: 10px; }
  .mb-20 { margin-bottom: 20px; }
  .mt-20 { margin-top: 20px; }
  .hidden { display: none; }
  .flex { display: flex; }
  .flex-center { display: flex; align-items: center; justify-content: center; }
  .gap-10 { gap: 10px; }
  .gap-20 { gap: 20px; }
</style>
</head>
<body>
  <div class="container">
      <!-- Header -->
      <div class="header">
          <div class="version">v2.0</div>
          <h1>🌟 帕金森病友會</h1>
          <p class="subtitle">整合管理系統 - 讓關懷更有溫度</p>
      </div>

      <!-- User Info -->
      <div class="user-info" id="userInfo">
          <div class="user-avatar" id="userAvatar">👤</div>
          <div class="user-details" id="userDetails">
              <!-- 動態載入使用者資訊 -->
          </div>
      </div>

      <!-- Navigation Tabs -->
      <div class="tabs">
          <div class="tab active" onclick="switchTab('activities')">🎯 活動中心</div>
          <div class="tab" onclick="switchTab('profile')">👤 個人資料</div>
          <div class="tab" onclick="switchTab('finance')">💰 財務管理</div>
          <div class="tab" onclick="switchTab('admin')" id="adminTab" style="display: none;">⚙️ 系統管理</div>
      </div>

      <!-- Activities Tab -->
      <div class="tab-content active" id="activities">
          <div class="flex gap-20 mb-20">
              <select class="form-select" id="activityStatusFilter" onchange="filterActivities()">
                  <option value="">所有狀態</option>
                  <option value="registration_open">開放報名</option>
                  <option value="published">已發布</option>
                  <option value="completed">已完成</option>
              </select>
              <select class="form-select" id="activityCategoryFilter" onchange="filterActivities()">
                  <option value="">所有類別</option>
                  <option value="健康講座">健康講座</option>
                  <option value="復健活動">復健活動</option>
                  <option value="社交聚會">社交聚會</option>
                  <option value="志工服務">志工服務</option>
              </select>
              <button class="btn btn-primary" onclick="showCreateActivityForm()" id="createActivityBtn" style="display: none;">
                  ➕ 新增活動
              </button>
          </div>
          
          <div class="cards-grid" id="activitiesGrid">
              <!-- 動態載入活動卡片 -->
          </div>
          
          <div class="text-center mt-20">
              <button class="btn btn-outline" id="loadMoreBtn" onclick="loadMoreActivities()">載入更多</button>
          </div>
      </div>

      <!-- Profile Tab -->
      <div class="tab-content" id="profile">
          <div class="form-container">
              <h2 class="mb-20">📝 個人資料管理</h2>
              <form id="profileForm">
                  <div class="form-row">
                      <div class="form-group">
                          <label class="form-label">真實姓名 *</label>
                          <input type="text" class="form-input" id="realName" required>
                      </div>
                      <div class="form-group">
                          <label class="form-label">會員類別</label>
                          <select class="form-select" id="memberType">
                              <option value="patient">病友</option>
                              <option value="family">家屬</option>
                              <option value="volunteer">志工</option>
                              <option value="supporter">支持者</option>
                          </select>
                      </div>
                  </div>
                  
                  <div class="form-row">
                      <div class="form-group">
                          <label class="form-label">聯絡電話</label>
                          <input type="tel" class="form-input" id="phone">
                      </div>
                      <div class="form-group">
                          <label class="form-label">電子郵件</label>
                          <input type="email" class="form-input" id="email">
                      </div>
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">聯絡地址</label>
                      <input type="text" class="form-input" id="address">
                  </div>
                  
                  <div class="form-row">
                      <div class="form-group">
                          <label class="form-label">生日</label>
                          <input type="date" class="form-input" id="birthday">
                      </div>
                      <div class="form-group">
                          <label class="form-label">緊急聯絡人</label>
                          <input type="text" class="form-input" id="emergencyContact">
                      </div>
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">緊急聯絡電話</label>
                      <input type="tel" class="form-input" id="emergencyPhone">
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">醫療資訊備註</label>
                      <textarea class="form-textarea" id="medicalInfo" placeholder="請填寫相關醫療資訊、用藥情況或特殊需求..."></textarea>
                  </div>
                  
                  <div class="flex gap-20">
                      <button type="submit" class="btn btn-primary">💾 儲存資料</button>
                      <button type="button" class="btn btn-outline" onclick="loadUserProfile()">🔄 重新載入</button>
                  </div>
              </form>
          </div>
      </div>

      <!-- Finance Tab -->
      <div class="tab-content" id="finance">
          <div class="finance-dashboard" id="financeDashboard">
              <!-- 動態載入財務儀表板 -->
          </div>
          
          <div class="tabs mb-20">
              <div class="tab active" onclick="switchFinanceTab('overview')">📊 總覽</div>
              <div class="tab" onclick="switchFinanceTab('income')">💰 收入</div>
              <div class="tab" onclick="switchFinanceTab('expense')">💸 支出</div>
              <div class="tab" onclick="switchFinanceTab('budget')">📈 預算</div>
              <div class="tab" onclick="switchFinanceTab('reports')">📋 報表</div>
          </div>
          
          <div id="financeContent">
              <!-- 動態載入財務內容 -->
          </div>
      </div>

      <!-- Admin Tab -->
      <div class="tab-content" id="admin">
          <div class="admin-stats" id="adminStats">
              <!-- 動態載入管理統計 -->
          </div>
          
          <div class="tabs mb-20">
              <div class="tab active" onclick="switchAdminTab('dashboard')">📊 儀表板</div>
              <div class="tab" onclick="switchAdminTab('members')">👥 會員管理</div>
              <div class="tab" onclick="switchAdminTab('activities')">🎯 活動管理</div>
              <div class="tab" onclick="switchAdminTab('finance')">💰 財務管理</div>
              <div class="tab" onclick="switchAdminTab('system')">⚙️ 系統設定</div>
          </div>
          
          <div id="adminContent">
              <!-- 動態載入管理內容 -->
          </div>
      </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading hidden" id="loading">
      <div class="loading-spinner"></div>
  </div>

<script>
// 全域變數
let currentUser = null;
let activities = [];
let currentActivityPage = 0;
let hasMoreActivities = true;
let currentTab = 'activities';
let currentFinanceTab = 'overview';
let currentAdminTab = 'dashboard';

// LIFF 設定
const LIFF_ID = '1656516134-VaGgmaPm';
const API_URL = 'https://script.google.com/macros/s/AKfycbwJ1qzghSUX1RWVwR2D0VtVb6ApVzoR_vqbfWXOIrcvHh7eHrSCnliSYV4Pq_bOgjdO/exec';

// 初始化
document.addEventListener('DOMContentLoaded', function() {
  initializeLIFF();
});

async function initializeLIFF() {
  try {
      await liff.init({ liffId: LIFF_ID });
      
      if (liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          await initializeUser(profile);
      } else {
          liff.login();
      }
  } catch (error) {
      console.error('LIFF initialization failed:', error);
      showMessage('系統初始化失敗，請重新整理頁面', 'error');
  }
}

async function initializeUser(profile) {
  showLoading(true);
  
  try {
      // 建立或更新使用者
      const createResult = await apiCall('createUserIfNotExist', {
          lineId: profile.userId,
          lineName: profile.displayName
      });
      
      if (createResult.success) {
          currentUser = createResult.user;
          updateUserInterface();
          await loadInitialData();
      }
  } catch (error) {
      console.error('User initialization failed:', error);
      showMessage('使用者初始化失敗', 'error');
  } finally {
      showLoading(false);
  }
}

function updateUserInterface() {
  if (!currentUser) return;
  
  // 更新使用者資訊卡片
  const userInfo = document.getElementById('userInfo');
  const userAvatar = document.getElementById('userAvatar');
  const userDetails = document.getElementById('userDetails');
  
  userInfo.style.display = 'block';
  userAvatar.textContent = currentUser.realName ? currentUser.realName.charAt(0) : '👤';
  
  userDetails.innerHTML = `
      <div class="user-detail-item">
          <span class="icon">👤</span>
          <span>${currentUser.realName || currentUser.lineName || '未設定'}</span>
      </div>
      <div class="user-detail-item">
          <span class="icon">🏷️</span>
          <span>${getRoleDisplayName(currentUser.role)}</span>
      </div>
      <div class="user-detail-item">
          <span class="icon">📅</span>
          <span>加入時間：${formatDate(currentUser.joinDate)}</span>
      </div>
      <div class="user-detail-item">
          <span class="icon">💬</span>
          <span>互動次數：${currentUser.messageCount || 0}</span>
      </div>
  `;
  
  // 顯示管理員選項
  if (hasPermission('manage_users')) {
      document.getElementById('adminTab').style.display = 'block';
      document.getElementById('createActivityBtn').style.display = 'block';
  }
}

async function loadInitialData() {
  await Promise.all([
      loadActivities(),
      loadUserProfile()
  ]);
}

// 活動管理
async function loadActivities(reset = false) {
  if (reset) {
      currentActivityPage = 0;
      activities = [];
      hasMoreActivities = true;
  }
  
  if (!hasMoreActivities) return;
  
  showLoading(true);
  
  try {
      const params = {
          limit: 12,
          offset: currentActivityPage * 12,
          status: document.getElementById('activityStatusFilter').value,
          category: document.getElementById('activityCategoryFilter').value
      };
      
      const result = await apiCall('getActivitiesForCards', { params });
      
      if (result.success) {
          if (reset) {
              activities = result.activities;
          } else {
              activities = activities.concat(result.activities);
          }
          
          hasMoreActivities = result.hasMore;
          currentActivityPage++;
          
          renderActivities();
          updateLoadMoreButton();
      }
  } catch (error) {
      console.error('Failed to load activities:', error);
      showMessage('載入活動失敗', 'error');
  } finally {
      showLoading(false);
  }
}

function renderActivities() {
  const grid = document.getElementById('activitiesGrid');
  
  if (currentActivityPage === 1) {
      grid.innerHTML = '';
  }
  
  activities.forEach(activity => {
      if (grid.querySelector(`[data-activity-id="${activity.id}"]`)) return;
      
      const card = createActivityCard(activity);
      grid.appendChild(card);
  });
}

function createActivityCard(activity) {
  const card = document.createElement('div');
  card.className = 'activity-card';
  card.setAttribute('data-activity-id', activity.id);
  card.onclick = () => showActivityDetail(activity);
  
  const statusClass = `status-${activity.status}`;
  const statusText = getStatusDisplayName(activity.status);
  
  card.innerHTML = `
      <div class="activity-card-image">
          ${activity.imageUrl ? `<img src="${activity.imageUrl}" alt="${activity.name}">` : '🎯'}
          <div class="activity-status-badge ${statusClass}">${statusText}</div>
      </div>
      <div class="activity-card-content">
          <h3 class="activity-card-title">${activity.name}</h3>
          <p class="activity-card-description">${activity.description || '暫無描述'}</p>
          <div class="activity-card-meta">
              <div class="meta-item">
                  <span>📅</span>
                  <span>${formatDate(activity.startDate)}</span>
              </div>
              <div class="meta-item">
                  <span>📍</span>
                  <span>${activity.location || '待定'}</span>
              </div>
              <div class="meta-item">
                  <span>👥</span>
                  <span>${activity.currentParticipants}/${activity.maxParticipants || '∞'}</span>
              </div>
          </div>
          <div class="activity-card-footer">
              <div class="activity-participants">
                  ${activity.isRegistrationOpen ? '🟢 開放報名' : '🔴 報名截止'}
              </div>
              <div class="activity-fee">
                  ${activity.fee ? `NT$ ${activity.fee}` : '免費'}
              </div>
          </div>
      </div>
  `;
  
  return card;
}

function filterActivities() {
  loadActivities(true);
}

function updateLoadMoreButton() {
  const btn = document.getElementById('loadMoreBtn');
  btn.style.display = hasMoreActivities ? 'block' : 'none';
}

function loadMoreActivities() {
  loadActivities(false);
}

// 個人資料管理
async function loadUserProfile() {
  if (!currentUser) return;
  
  const form = document.getElementById('profileForm');
  const fields = ['realName', 'memberType', 'phone', 'email', 'address', 'birthday', 'emergencyContact', 'emergencyPhone', 'medicalInfo'];
  
  fields.forEach(field => {
      const element = document.getElementById(field);
      if (element && currentUser[field]) {
          element.value = currentUser[field];
      }
  });
}

document.getElementById('profileForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  if (!currentUser) return;
  
  showLoading(true);
  
  try {
      const formData = new FormData(this);
      const userData = {};
      
      ['realName', 'memberType', 'phone', 'email', 'address', 'birthday', 'emergencyContact', 'emergencyPhone', 'medicalInfo'].forEach(field => {
          const element = document.getElementById(field);
          if (element) userData[field] = element.value;
      });
      
      const result = await apiCall('registerUser', {
          lineId: currentUser.lineId,
          userData
      });
      
      if (result.success) {
          currentUser = result.user;
          updateUserInterface();
          showMessage('個人資料更新成功！', 'success');
      } else {
          showMessage(result.message || '更新失敗', 'error');
      }
  } catch (error) {
      console.error('Profile update failed:', error);
      showMessage('更新個人資料失敗', 'error');
  } finally {
      showLoading(false);
  }
});

// 財務管理
async function loadFinanceDashboard() {
  if (!hasPermission('read_finance')) {
      document.getElementById('financeDashboard').innerHTML = '<div class="message message-warning">您沒有財務資料檢視權限</div>';
      return;
  }
  
  showLoading(true);
  
  try {
      const result = await apiCall('generateFinancialReport', {
          operatorLineId: currentUser.lineId,
          params: {
              startDate: new Date(new Date().getFullYear(), 0, 1).toISOString(),
              endDate: new Date().toISOString(),
              type: 'summary'
          }
      });
      
      if (result.success) {
          renderFinanceDashboard(result.report);
      }
  } catch (error) {
      console.error('Failed to load finance dashboard:', error);
      showMessage('載入財務資料失敗', 'error');
  } finally {
      showLoading(false);
  }
}

function renderFinanceDashboard(report) {
  const dashboard = document.getElementById('financeDashboard');
  
  dashboard.innerHTML = `
      <div class="finance-card income">
          <div class="finance-card-title">本年度收入</div>
          <div class="finance-card-amount">NT$ ${formatNumber(report.income.total)}</div>
          <div class="finance-card-change change-positive">+12.5%</div>
      </div>
      <div class="finance-card expense">
          <div class="finance-card-title">本年度支出</div>
          <div class="finance-card-amount">NT$ ${formatNumber(report.expense.total)}</div>
          <div class="finance-card-change change-negative">+8.3%</div>
      </div>
      <div class="finance-card">
          <div class="finance-card-title">淨收入</div>
          <div class="finance-card-amount">NT$ ${formatNumber(report.netIncome)}</div>
          <div class="finance-card-change ${report.netIncome >= 0 ? 'change-positive' : 'change-negative'}">
              ${report.netIncome >= 0 ? '+' : ''}${((report.netIncome / Math.abs(report.income.total)) * 100).toFixed(1)}%
          </div>
      </div>
      <div class="finance-card budget">
          <div class="finance-card-title">帳戶餘額</div>
          <div class="finance-card-amount">NT$ ${formatNumber(getTotalAccountBalance(report.accounts))}</div>
          <div class="finance-card-change change-positive">穩定</div>
      </div>
  `;
}

// 管理員功能
async function loadAdminDashboard() {
  if (!hasPermission('manage_users')) {
      document.getElementById('adminStats').innerHTML = '<div class="message message-warning">您沒有管理權限</div>';
      return;
  }
  
  showLoading(true);
  
  try {
      const result = await apiCall('getAdminDashboard', {
          operatorLineId: currentUser.lineId
      });
      
      if (result.success) {
          renderAdminStats(result.dashboard);
      }
  } catch (error) {
      console.error('Failed to load admin dashboard:', error);
      showMessage('載入管理面板失敗', 'error');
  } finally {
      showLoading(false);
  }
}

function renderAdminStats(dashboard) {
  const stats = document.getElementById('adminStats');
  
  stats.innerHTML = `
      <div class="stat-card">
          <div class="stat-icon">👥</div>
          <div class="stat-number">${dashboard.members.total}</div>
          <div class="stat-label">總會員數</div>
      </div>
      <div class="stat-card">
          <div class="stat-icon">✅</div>
          <div class="stat-number">${dashboard.members.registered}</div>
          <div class="stat-label">已註冊</div>
      </div>
      <div class="stat-card">
          <div class="stat-icon">🎯</div>
          <div class="stat-number">${dashboard.activities.total}</div>
          <div class="stat-label">總活動數</div>
      </div>
      <div class="stat-card">
          <div class="stat-icon">📅</div>
          <div class="stat-number">${dashboard.activities.upcoming}</div>
          <div class="stat-label">即將開始</div>
      </div>
      <div class="stat-card">
          <div class="stat-icon">💰</div>
          <div class="stat-number">NT$ ${formatNumber(dashboard.finance.thisYear.income)}</div>
          <div class="stat-label">年度收入</div>
      </div>
      <div class="stat-card">
          <div class="stat-icon">💸</div>
          <div class="stat-number">NT$ ${formatNumber(dashboard.finance.thisYear.expense)}</div>
          <div class="stat-label">年度支出</div>
      </div>
  `;
}

// 標籤切換
function switchTab(tabName) {
  // 更新標籤狀態
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  event.target.classList.add('active');
  
  // 更新內容顯示
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  
  currentTab = tabName;
  
  // 載入對應資料
  switch (tabName) {
      case 'activities':
          if (activities.length === 0) loadActivities(true);
          break;
      case 'finance':
          loadFinanceDashboard();
          break;
      case 'admin':
          loadAdminDashboard();
          break;
  }
}

function switchFinanceTab(tabName) {
  currentFinanceTab = tabName;
  // 實作財務子標籤切換邏輯
}

function switchAdminTab(tabName) {
  currentAdminTab = tabName;
  // 實作管理子標籤切換邏輯
}

// 工具函式
function hasPermission(permission) {
  return currentUser && currentUser.permissions && currentUser.permissions.includes(permission);
}

function getRoleDisplayName(role) {
  const roleNames = {
      'guest': '訪客',
      'member': '一般會員',
      'volunteer': '志工',
      'vip': 'VIP會員',
      'admin': '管理員',
      'super_admin': '超級管理員'
  };
  return roleNames[role] || '未知';
}

function getStatusDisplayName(status) {
  const statusNames = {
      'draft': '草稿',
      'published': '已發布',
      'registration_open': '開放報名',
      'registration_closed': '報名截止',
      'in_progress': '進行中',
      'completed': '已完成',
      'cancelled': '已取消'
  };
  return statusNames[status] || status;
}

function formatDate(dateStr) {
  if (!dateStr) return '未設定';
  const date = new Date(dateStr);
  return date.toLocaleDateString('zh-TW', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
  });
}

function formatNumber(num) {
  return new Intl.NumberFormat('zh-TW').format(num || 0);
}

function getTotalAccountBalance(accounts) {
  return accounts.reduce((total, account) => total + (account.balance || 0), 0);
}

function showLoading(show) {
  const loading = document.getElementById('loading');
  loading.classList.toggle('hidden', !show);
}

function showMessage(message, type = 'info') {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message message-${type}`;
  messageDiv.innerHTML = `
      <span>${getMessageIcon(type)}</span>
      <span>${message}</span>
  `;
  
  document.querySelector('.container').insertBefore(messageDiv, document.querySelector('.container').firstChild);
  
  setTimeout(() => {
      messageDiv.remove();
  }, 5000);
}

function getMessageIcon(type) {
  const icons = {
      'success': '✅',
      'error': '❌',
      'warning': '⚠️',
      'info': 'ℹ️'
  };
  return icons[type] || 'ℹ️';
}

// API 呼叫
async function apiCall(action, data = {}) {
  const payload = {
      action,
      ...data,
      timestamp: Date.now()
  };
  
  // 簽章 (簡化版)
  payload.signature = CryptoJS.HmacSHA256(JSON.stringify(payload), 'your-secret-key').toString();
  
  const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
          'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
  });
  
  if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
  }
  
  return await response.json();
}

// 活動詳情模態框
function showActivityDetail(activity) {
  // 實作活動詳情顯示邏輯
  console.log('Show activity detail:', activity);
}

// 建立活動表單
function showCreateActivityForm() {
  if (!hasPermission('manage_activities')) {
      showMessage('您沒有建立活動的權限', 'warning');
      return;
  }
  
  // 實作建立活動表單邏輯
  console.log('Show create activity form');
}
</script>
</body>
</html>
