<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="theme-color" content="#667eea">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
<style>
:root {
--primary: #4a90e2;
--primary-light: #e3f2fd;
--success: #4caf50;
--warn: #ff9800;
--error: #f44336;
--bg: #f5f7fa;
--card: #ffffff;
--text: #333333;
--text-light: #666666;
--border: #e0e0e0;
--shadow: 0 4px 12px rgba(0,0,0,0.1);
--radius: 20px;
}

* {
box-sizing: border-box;
}

body {
margin: 0;
padding: 0;
background: var(--bg);
color: var(--text);
font-family: 'Microsoft JhengHei', 'PingFang TC', 'Noto Sans TC', sans-serif;
font-size: 18px;
line-height: 1.6;
}

/* é ‚éƒ¨å°èˆª */
.header {
background: linear-gradient(135deg, var(--primary), #667eea);
color: white;
padding: 20px 16px;
text-align: center;
position: sticky;
top: 0;
z-index: 100;
box-shadow: var(--shadow);
}

.header h1 {
margin: 0;
font-size: 24px;
font-weight: 700;
}

.header .subtitle {
margin-top: 8px;
font-size: 16px;
opacity: 0.9;
}

/* å®¹å™¨ */
.container {
max-width: 480px;
margin: 0 auto;
padding: 16px;
min-height: calc(100vh - 120px);
}

/* å¤§å‹æŒ‰éˆ•å¼é¸å–® */
.main-menu {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 16px;
margin: 20px 0;
}

.menu-card {
background: var(--card);
border-radius: var(--radius);
padding: 24px 16px;
text-align: center;
box-shadow: var(--shadow);
cursor: pointer;
transition: all 0.3s ease;
border: 3px solid transparent;
min-height: 120px;
display: flex;
flex-direction: column;
justify-content: center;
}

.menu-card:hover {
transform: translateY(-4px);
box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.menu-card.active {
border-color: var(--primary);
background: var(--primary-light);
}

.menu-card .icon {
font-size: 36px;
margin-bottom: 8px;
display: block;
}

.menu-card .title {
font-size: 18px;
font-weight: 600;
color: var(--text);
}

/* å…§å®¹é¢æ¿ */
.panel {
display: none;
animation: fadeIn 0.4s ease;
}

.panel.active {
display: block;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}

/* å¡ç‰‡æ¨£å¼ */
.card {
background: var(--card);
border-radius: var(--radius);
padding: 24px;
margin-bottom: 20px;
box-shadow: var(--shadow);
}

.card-header {
display: flex;
align-items: center;
margin-bottom: 20px;
padding-bottom: 16px;
border-bottom: 2px solid var(--border);
}

.card-header .icon {
font-size: 28px;
margin-right: 12px;
}

.card-header h3 {
margin: 0;
font-size: 20px;
font-weight: 600;
}

/* è¡¨å–®å…ƒç´  */
.form-group {
margin-bottom: 20px;
}

.form-label {
display: block;
font-size: 16px;
font-weight: 600;
margin-bottom: 8px;
color: var(--text);
}

.form-label.required::after {
content: " *";
color: var(--error);
}

.form-input, .form-select, .form-textarea {
width: 100%;
padding: 16px;
font-size: 18px;
border: 2px solid var(--border);
border-radius: 12px;
background: white;
transition: all 0.3s ease;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
}

.form-textarea {
min-height: 100px;
resize: vertical;
}

/* å¤§å‹æŒ‰éˆ• */
.btn {
background: var(--primary);
color: white;
border: none;
border-radius: 12px;
padding: 16px 24px;
font-size: 18px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 8px;
min-height: 56px;
width: 100%;
margin-bottom: 12px;
}

.btn:hover {
transform: translateY(-2px);
box-shadow: 0 6px 16px rgba(74, 144, 226, 0.3);
}

.btn:active {
transform: translateY(0);
}

.btn.btn-success {
background: var(--success);
}

.btn.btn-warning {
background: var(--warn);
}

.btn.btn-danger {
background: var(--error);
}

.btn.btn-outline {
background: white;
color: var(--primary);
border: 2px solid var(--primary);
}

.btn.btn-outline:hover {
background: var(--primary);
color: white;
}

.btn:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none;
}

/* çµ±è¨ˆå¡ç‰‡ */
.stats-grid {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 16px;
margin-bottom: 24px;
}

.stat-card {
background: white;
border-radius: var(--radius);
padding: 20px;
text-align: center;
box-shadow: var(--shadow);
border-left: 5px solid var(--primary);
}

.stat-number {
font-size: 32px;
font-weight: 700;
color: var(--primary);
margin-bottom: 4px;
}

.stat-label {
font-size: 14px;
color: var(--text-light);
font-weight: 500;
}

/* åˆ—è¡¨é …ç›® */
.list-item {
background: white;
border-radius: var(--radius);
padding: 20px;
margin-bottom: 16px;
box-shadow: var(--shadow);
border-left: 5px solid var(--primary);
}

.list-item-header {
display: flex;
justify-content: space-between;
align-items: flex-start;
margin-bottom: 12px;
}

.list-item-title {
font-size: 18px;
font-weight: 600;
margin: 0;
}

.list-item-meta {
display: flex;
flex-wrap: wrap;
gap: 12px;
margin-bottom: 12px;
font-size: 14px;
color: var(--text-light);
}

.list-item-meta span {
display: flex;
align-items: center;
gap: 4px;
}

.list-item-content {
font-size: 16px;
line-height: 1.5;
margin-bottom: 16px;
}

.list-item-actions {
display: flex;
gap: 8px;
flex-wrap: wrap;
}

.list-item-actions .btn {
flex: 1;
min-width: 120px;
margin-bottom: 0;
}

/* å¾½ç«  */
.badge {
display: inline-flex;
align-items: center;
padding: 6px 12px;
border-radius: 20px;
font-size: 14px;
font-weight: 600;
background: var(--border);
color: var(--text);
}

.badge.success {
background: rgba(76, 175, 80, 0.1);
color: var(--success);
}

.badge.warning {
background: rgba(255, 152, 0, 0.1);
color: var(--warn);
}

.badge.error {
background: rgba(244, 67, 54, 0.1);
color: var(--error);
}

.badge.primary {
background: rgba(74, 144, 226, 0.1);
color: var(--primary);
}

/* é€šçŸ¥ */
.notification {
position: fixed;
top: 20px;
left: 50%;
transform: translateX(-50%);
background: var(--text);
color: white;
padding: 16px 24px;
border-radius: 12px;
box-shadow: 0 8px 24px rgba(0,0,0,0.3);
z-index: 1000;
font-size: 16px;
max-width: 90%;
opacity: 0;
transition: all 0.3s ease;
}

.notification.show {
opacity: 1;
}

.notification.success {
background: var(--success);
}

.notification.error {
background: var(--error);
}

.notification.warning {
background: var(--warn);
}

/* ç©ºç‹€æ…‹ */
.empty-state {
text-align: center;
padding: 40px 20px;
color: var(--text-light);
}

.empty-state .icon {
font-size: 48px;
margin-bottom: 16px;
opacity: 0.5;
}

.empty-state .message {
font-size: 16px;
}

/* è¼‰å…¥ç‹€æ…‹ */
.loading {
text-align: center;
padding: 40px;
color: var(--text-light);
}

.loading::after {
content: '';
display: inline-block;
width: 24px;
height: 24px;
border: 3px solid var(--border);
border-top: 3px solid var(--primary);
border-radius: 50%;
animation: spin 1s linear infinite;
margin-left: 8px;
}

@keyframes spin {
to { transform: rotate(360deg); }
}

/* åˆ†é  */
.pagination {
display: flex;
justify-content: center;
gap: 8px;
margin: 20px 0;
}

.pagination button {
padding: 12px 16px;
border: 2px solid var(--border);
background: white;
border-radius: 8px;
font-size: 16px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
}

.pagination button.active,
.pagination button:hover {
background: var(--primary);
color: white;
border-color: var(--primary);
}

/* æœå°‹æ¡† */
.search-box {
position: relative;
margin-bottom: 20px;
}

.search-box input {
padding-left: 48px;
}

.search-box .search-icon {
position: absolute;
left: 16px;
top: 50%;
transform: translateY(-50%);
font-size: 20px;
color: var(--text-light);
}

/* å›åˆ°é ‚éƒ¨æŒ‰éˆ• */
.back-to-top {
position: fixed;
bottom: 20px;
right: 20px;
width: 56px;
height: 56px;
background: var(--primary);
color: white;
border: none;
border-radius: 50%;
font-size: 20px;
cursor: pointer;
box-shadow: var(--shadow);
transition: all 0.3s ease;
opacity: 0;
transform: translateY(20px);
}

.back-to-top.show {
opacity: 1;
transform: translateY(0);
}

.back-to-top:hover {
transform: translateY(-4px);
box-shadow: 0 8px 20px rgba(74, 144, 226, 0.4);
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 360px) {
.container {
  padding: 12px;
}

.main-menu {
  grid-template-columns: 1fr;
}

.stats-grid {
  grid-template-columns: 1fr;
}

.menu-card {
  min-height: 100px;
  padding: 20px 12px;
}

.menu-card .icon {
  font-size: 32px;
}

.card {
  padding: 20px;
}
}

/* éš±è—å…ƒç´  */
.hidden {
display: none !important;
}

/* ç®¡ç†å“¡å°ˆç”¨æ¨£å¼ */
.admin-only {
display: none;
}

.admin-only.show {
display: block;
}

/* è¡¨æ ¼æ¨£å¼ */
.table-container {
overflow-x: auto;
margin: 16px 0;
}

.simple-table {
width: 100%;
border-collapse: collapse;
background: white;
border-radius: var(--radius);
overflow: hidden;
box-shadow: var(--shadow);
}

.simple-table th,
.simple-table td {
padding: 16px 12px;
text-align: left;
border-bottom: 1px solid var(--border);
font-size: 16px;
}

.simple-table th {
background: var(--primary-light);
font-weight: 600;
color: var(--text);
}

.simple-table tr:hover td {
background: rgba(74, 144, 226, 0.05);
}

/* å¿«é€Ÿæ“ä½œæŒ‰éˆ• */
.quick-actions {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
gap: 12px;
margin: 20px 0;
}

.quick-action-btn {
background: white;
border: 2px solid var(--border);
border-radius: 12px;
padding: 16px 12px;
text-align: center;
cursor: pointer;
transition: all 0.3s ease;
font-size: 14px;
font-weight: 600;
}

.quick-action-btn:hover {
border-color: var(--primary);
background: var(--primary-light);
}

.quick-action-btn .icon {
font-size: 24px;
margin-bottom: 8px;
display: block;
}
</style>
</head>
<body>

<!-- é ‚éƒ¨å°èˆª -->
<div class="header">
<h1>ğŸ¥ å¸•é‡‘æ£®ç—…å‹æœƒ</h1>
<div class="subtitle">ç®¡ç†ç³»çµ±</div>
</div>

<div class="container">
<!-- ä½¿ç”¨è€…è³‡è¨Šå¡ç‰‡ -->
<div id="user-info-card" class="card hidden">
  <div class="card-header">
    <span class="icon">ğŸ‘¤</span>
    <h3>å€‹äººè³‡è¨Š</h3>
  </div>
  <div id="user-details"></div>
</div>

<!-- ä¸»é¸å–® -->
<div class="main-menu" id="main-menu">
  <div class="menu-card active" data-tab="profile">
    <span class="icon">ğŸ“</span>
    <div class="title">å€‹äººè³‡æ–™</div>
  </div>
  <div class="menu-card" data-tab="activities">
    <span class="icon">ğŸ“…</span>
    <div class="title">æ´»å‹•å ±å</div>
  </div>
  <div class="menu-card" data-tab="donations">
    <span class="icon">ğŸ’</span>
    <div class="title">æ„›å¿ƒææ¬¾</div>
  </div>
  <div class="menu-card" data-tab="finance">
    <span class="icon">ğŸ’°</span>
    <div class="title">è²¡å‹™æ”¯å‡º</div>
  </div>
  <div class="menu-card" data-tab="feedback">
    <span class="icon">ğŸ“</span>
    <div class="title">æ´»å‹•å›é¥‹</div>
  </div>
  <div class="menu-card admin-only" data-tab="admin">
    <span class="icon">âš™ï¸</span>
    <div class="title">ç³»çµ±ç®¡ç†</div>
  </div>
</div>

<!-- å€‹äººè³‡æ–™é¢æ¿ -->
<div class="panel active" id="panel-profile">
  <div class="card">
    <div class="card-header">
      <span class="icon">ğŸ“</span>
      <h3>æœƒå“¡è¨»å†Š</h3>
    </div>
    
    <div class="form-group">
      <label class="form-label required">çœŸå¯¦å§“å</label>
      <input type="text" class="form-input" id="realName" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
    </div>
    
    <div class="form-group">
      <label class="form-label required">æœƒå“¡é¡åˆ¥</label>
      <select class="form-select" id="memberType">
        <option value="">è«‹é¸æ“‡æœƒå“¡é¡åˆ¥</option>
        <option value="patient">ğŸ¥ ç—…å‹</option>
        <option value="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶å±¬</option>
        <option value="volunteer">ğŸ™‹â€â™€ï¸ å¿—å·¥</option>
        <option value="medical">ğŸ‘©â€âš•ï¸ é†«è­·äººå“¡</option>
        <option value="supporter">ğŸ¤ æ”¯æŒè€…</option>
      </select>
    </div>
    
    <button class="btn" id="btn-register">
      <span>âœ… è¨»å†Š / æ›´æ–°è³‡æ–™</span>
    </button>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="icon">ğŸ“</span>
      <h3>è¯çµ¡è³‡è¨Š</h3>
    </div>
    
    <div class="form-group">
      <label class="form-label">é›»è©±è™Ÿç¢¼</label>
      <input type="tel" class="form-input" id="phone" placeholder="ä¾‹ï¼š0912345678">
    </div>
    
    <div class="form-group">
      <label class="form-label">é›»å­éƒµä»¶</label>
      <input type="email" class="form-input" id="email" placeholder="ä¾‹ï¼šexample@email.com">
    </div>
    
    <div class="form-group">
      <label class="form-label">å±…ä½åœ°å€</label>
      <input type="text" class="form-input" id="address" placeholder="è«‹è¼¸å…¥åœ°å€">
    </div>
    
    <div class="form-group">
      <label class="form-label">ç”Ÿæ—¥</label>
      <input type="date" class="form-input" id="birthday">
    </div>
    
    <button class="btn btn-success" id="btn-update-contact">
      <span>ğŸ’¾ æ›´æ–°è¯çµ¡è³‡è¨Š</span>
    </button>
  </div>
</div>

<!-- æ´»å‹•é¢æ¿ -->
<div class="panel" id="panel-activities">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number" id="stat-activity-total">0</div>
      <div class="stat-label">å¯å ±åæ´»å‹•</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="stat-my-registrations">0</div>
      <div class="stat-label">æˆ‘çš„å ±å</div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="icon">ğŸ“…</span>
      <h3>å¯å ±åæ´»å‹•</h3>
    </div>
    
    <div class="search-box">
      <input type="text" class="form-input" id="activity-search" placeholder="æœå°‹æ´»å‹•åç¨±...">
      <span class="search-icon">ğŸ”</span>
    </div>
    
    <div id="activity-list"></div>
    <div class="pagination" id="activity-pagination"></div>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="icon">ğŸ“‹</span>
      <h3>æˆ‘çš„å ±åè¨˜éŒ„</h3>
    </div>
    <div id="my-activity-list"></div>
  </div>
</div>

<!-- ææ¬¾é¢æ¿ -->
<div class="panel" id="panel-donations">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number" id="stat-donation-count">0</div>
      <div class="stat-label">ææ¬¾ç­†æ•¸</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="stat-donation-total">0</div>
      <div class="stat-label">ææ¬¾ç¸½é¡</div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="icon">ğŸ’</span>
      <h3>æ„›å¿ƒææ¬¾</h3>
    </div>
    
    <div class="form-group">
      <label class="form-label required">ææ¬¾é‡‘é¡</label>
      <select class="form-select" id="donation-amount-select">
        <option value="">è«‹é¸æ“‡ææ¬¾é‡‘é¡</option>
        <option value="100">ğŸ’° 100 å…ƒ</option>
        <option value="300">ğŸ’° 300 å…ƒ</option>
        <option value="500">ğŸ’° 500 å…ƒ</option>
        <option value="1000">ğŸ’° 1,000 å…ƒ</option>
        <option value="2000">ğŸ’° 2,000 å…ƒ</option>
        <option value="5000">ğŸ’° 5,000 å…ƒ</option>
        <option value="custom">âœï¸ å…¶ä»–é‡‘é¡</option>
      </select>
    </div>
    
    <div class="form-group hidden" id="custom-amount-group">
      <label class="form-label">è‡ªè¨‚é‡‘é¡</label>
      <input type="number" class="form-input" id="donation-amount" min="1" placeholder="è«‹è¼¸å…¥é‡‘é¡">
    </div>
    
    <div class="form-group">
      <label class="form-label">ææ¬¾äººå§“å</label>
      <input type="text" class="form-input" id="donor-name" placeholder="å¯ç•™ç©ºï¼ˆåŒ¿åææ¬¾ï¼‰">
    </div>
    
    <div class="form-group">
      <label class="form-label">ææ¬¾ç”¨é€”</label>
      <select class="form-select" id="donation-purpose">
        <option value="">è«‹é¸æ“‡ç”¨é€”ï¼ˆå¯ç•™ç©ºï¼‰</option>
        <option value="ä¸€èˆ¬ææ¬¾">ğŸ’ ä¸€èˆ¬ææ¬¾</option>
        <option value="æ´»å‹•ç¶“è²»">ğŸ¯ æ´»å‹•ç¶“è²»</option>
        <option value="é†«ç™‚æ”¯æ´">ğŸ¥ é†«ç™‚æ”¯æ´</option>
        <option value="è¨­å‚™è³¼ç½®">ğŸ”§ è¨­å‚™è³¼ç½®</option>
        <option value="æ€¥é›£æ•‘åŠ©">ğŸ†˜ æ€¥é›£æ•‘åŠ©</option>
      </select>
    </div>
    
    <button class="btn" id="btn-add-donation">
      <span>ğŸ’ ç¢ºèªææ¬¾</span>
    </button>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="icon">ğŸ“Š</span>
      <h3>æˆ‘çš„ææ¬¾è¨˜éŒ„</h3>
    </div>
    <div id="donation-list"></div>
  </div>
</div>

<!-- è²¡å‹™é¢æ¿ -->
<div class="panel" id="panel-finance">
  <div class="card">
    <div class="card-header">
      <span class="icon">ğŸ’¸</span>
      <h3>æ”¯å‡ºç”³è«‹</h3>
    </div>
    
    <div class="form-group">
      <label class="form-label required">æ”¯å‡ºé¡åˆ¥</label>
      <select class="form-select" id="expense-category">
        <option value="">è«‹é¸æ“‡æ”¯å‡ºé¡åˆ¥</option>
        <option value="activity">ğŸ¯ æ´»å‹•æ”¯å‡º</option>
        <option value="office">ğŸ¢ è¾¦å…¬è²»ç”¨</option>
        <option value="marketing">ğŸ“¢ å®£å‚³è²»ç”¨</option>
        <option value="equipment">ğŸ”§ è¨­å‚™è²»ç”¨</option>
        <option value="welfare">ğŸ ç¦åˆ©æ”¯å‡º</option>
        <option value="medical">ğŸ¥ é†«ç™‚æ”¯æ´</option>
        <option value="volunteer">ğŸ™‹â€â™€ï¸ å¿—å·¥è²»ç”¨</option>
        <option value="other">ğŸ“ å…¶ä»–æ”¯å‡º</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label required">ç”³è«‹é‡‘é¡</label>
      <select class="form-select" id="expense-amount-select">
        <option value="">è«‹é¸æ“‡é‡‘é¡ç¯„åœ</option>
        <option value="500">ğŸ’° 500 å…ƒä»¥ä¸‹</option>
        <option value="1000">ğŸ’° 1,000 å…ƒä»¥ä¸‹</option>
        <option value="3000">ğŸ’° 3,000 å…ƒä»¥ä¸‹</option>
        <option value="5000">ğŸ’° 5,000 å…ƒä»¥ä¸‹</option>
        <option value="10000">ğŸ’° 10,000 å…ƒä»¥ä¸‹</option>
        <option value="custom">âœï¸ å…¶ä»–é‡‘é¡</option>
      </select>
    </div>
    
    <div class="form-group hidden" id="custom-expense-group">
      <label class="form-label">ç¢ºåˆ‡é‡‘é¡</label>
      <input type="number" class="form-input" id="expense-amount" min="1" placeholder="è«‹è¼¸å…¥ç¢ºåˆ‡é‡‘é¡">
    </div>
    
    <div class="form-group">
      <label class="form-label required">ç”¨é€”èªªæ˜</label>
      <textarea class="form-textarea" id="expense-description" placeholder="è«‹è©³ç´°èªªæ˜æ”¯å‡ºç”¨é€”..."></textarea>
    </div>
    
    <button class="btn" id="btn-submit-expense">
      <span>ğŸ“¤ æäº¤ç”³è«‹</span>
    </button>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="icon">ğŸ“‹</span>
      <h3>æˆ‘çš„ç”³è«‹è¨˜éŒ„</h3>
    </div>
    <div id="my-expense-list"></div>
  </div>
</div>

<!-- å›é¥‹é¢æ¿ -->
<div class="panel" id="panel-feedback">
  <div class="card">
    <div class="card-header">
      <span class="icon">ğŸ“</span>
      <h3>æ´»å‹•å›é¥‹</h3>
    </div>
    
    <div class="form-group">
      <label class="form-label required">é¸æ“‡æ´»å‹•</label>
      <select class="form-select" id="feedback-activity">
        <option value="">è«‹é¸æ“‡è¦è©•åƒ¹çš„æ´»å‹•</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label required">æ•´é«”è©•åˆ†</label>
      <select class="form-select" id="feedback-rating">
        <option value="">è«‹é¸æ“‡è©•åˆ†</option>
        <option value="5">â­â­â­â­â­ éå¸¸æ»¿æ„</option>
        <option value="3">â­â­â­ æ™®é€š</option>
        <option value="2">â­â­ ä¸æ»¿æ„</option>
        <option value="1">â­ éå¸¸ä¸æ»¿æ„</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label">æ„è¦‹å»ºè­°</label>
      <textarea class="form-textarea" id="feedback-comment" placeholder="è«‹åˆ†äº«æ‚¨çš„å¿ƒå¾—èˆ‡å»ºè­°ï¼ˆé¸å¡«ï¼‰..."></textarea>
    </div>
    
    <button class="btn" id="btn-submit-feedback">
      <span>ğŸ“¤ æäº¤å›é¥‹</span>
    </button>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="icon">ğŸ“Š</span>
      <h3>æˆ‘çš„å›é¥‹è¨˜éŒ„</h3>
    </div>
    <div id="my-feedback-list"></div>
  </div>
</div>

<!-- ç®¡ç†é¢æ¿ -->
<div class="panel" id="panel-admin">
  <div class="quick-actions admin-only">
    <div class="quick-action-btn" data-admin-tab="overview">
      <span class="icon">ğŸ“Š</span>
      <div>ç³»çµ±ç¸½è¦½</div>
    </div>
    <div class="quick-action-btn" data-admin-tab="members">
      <span class="icon">ğŸ‘¥</span>
      <div>æœƒå“¡ç®¡ç†</div>
    </div>
    <div class="quick-action-btn" data-admin-tab="activities">
      <span class="icon">ğŸ“…</span>
      <div>æ´»å‹•ç®¡ç†</div>
    </div>
    <div class="quick-action-btn" data-admin-tab="finance">
      <span class="icon">ğŸ’°</span>
      <div>è²¡å‹™ç®¡ç†</div>
    </div>
    <div class="quick-action-btn" data-admin-tab="audit">
      <span class="icon">âœ…</span>
      <div>æ”¯å‡ºå¯©æ ¸</div>
    </div>
    <div class="quick-action-btn" data-admin-tab="reports">
      <span class="icon">ğŸ“ˆ</span>
      <div>å ±è¡¨æŸ¥è©¢</div>
    </div>
  </div>

  <!-- ç³»çµ±ç¸½è¦½ -->
  <div class="admin-panel hidden" id="admin-overview">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="stat-total-members">0</div>
        <div class="stat-label">ç¸½æœƒå“¡æ•¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-active-activities">0</div>
        <div class="stat-label">é€²è¡Œä¸­æ´»å‹•</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-total-registrations">0</div>
        <div class="stat-label">æ´»å‹•å ±åæ•¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-registered-members">0</div>
        <div class="stat-label">å·²è¨»å†Šæœƒå“¡</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="icon">ğŸ¯</span>
        <h3>å»ºç«‹æ–°æ´»å‹•</h3>
      </div>
      
      <div class="form-group">
        <label class="form-label required">æ´»å‹•åç¨±</label>
        <input type="text" class="form-input" id="new-activity-name" placeholder="è«‹è¼¸å…¥æ´»å‹•åç¨±">
      </div>
      
      <div class="form-group">
        <label class="form-label required">æ´»å‹•æ—¥æœŸ</label>
        <input type="datetime-local" class="form-input" id="new-activity-date">
      </div>
      
      <div class="form-group">
        <label class="form-label">æ´»å‹•åœ°é»</label>
        <input type="text" class="form-input" id="new-activity-location" placeholder="è«‹è¼¸å…¥æ´»å‹•åœ°é»">
      </div>
      
      <div class="form-group">
        <label class="form-label">äººæ•¸é™åˆ¶</label>
        <select class="form-select" id="new-activity-max-select">
          <option value="">ä¸é™åˆ¶äººæ•¸</option>
          <option value="10">ğŸ‘¥ 10 äºº</option>
          <option value="20">ğŸ‘¥ 20 äºº</option>
          <option value="30">ğŸ‘¥ 30 äºº</option>
          <option value="50">ğŸ‘¥ 50 äºº</option>
          <option value="custom">âœï¸ è‡ªè¨‚äººæ•¸</option>
        </select>
      </div>
      
      <div class="form-group hidden" id="custom-max-group">
        <label class="form-label">è‡ªè¨‚äººæ•¸</label>
        <input type="number" class="form-input" id="new-activity-max" min="1" placeholder="è«‹è¼¸å…¥äººæ•¸é™åˆ¶">
      </div>
      
      <div class="form-group">
        <label class="form-label">æ´»å‹•è²»ç”¨</label>
        <select class="form-select" id="new-activity-fee-select">
          <option value="0">ğŸ†“ å…è²»æ´»å‹•</option>
          <option value="100">ğŸ’° 100 å…ƒ</option>
          <option value="200">ğŸ’° 200 å…ƒ</option>
          <option value="300">ğŸ’° 300 å…ƒ</option>
          <option value="500">ğŸ’° 500 å…ƒ</option>
          <option value="custom">âœï¸ å…¶ä»–é‡‘é¡</option>
        </select>
      </div>
      
      <div class="form-group hidden" id="custom-fee-group">
        <label class="form-label">è‡ªè¨‚è²»ç”¨</label>
        <input type="number" class="form-input" id="new-activity-fee" min="0" placeholder="è«‹è¼¸å…¥æ´»å‹•è²»ç”¨">
      </div>
      
      <div class="form-group">
        <label class="form-label required">æ´»å‹•æè¿°</label>
        <textarea class="form-textarea" id="new-activity-desc" placeholder="è«‹è©³ç´°æè¿°æ´»å‹•å…§å®¹..."></textarea>
      </div>
      
      <button class="btn" id="btn-create-activity">
        <span>ğŸ¯ å»ºç«‹æ´»å‹•</span>
      </button>
    </div>
  </div>

  <!-- å…¶ä»–ç®¡ç†é¢æ¿æš«æ™‚éš±è—ï¼Œä¿æŒåŸæœ‰åŠŸèƒ½ -->
  <div class="admin-panel hidden" id="admin-members">
    <div class="card">
      <div class="card-header">
        <span class="icon">ğŸ‘¥</span>
        <h3>æœƒå“¡ç®¡ç†</h3>
      </div>
      <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <div class="admin-panel hidden" id="admin-activities">
    <div class="card">
      <div class="card-header">
        <span class="icon">ğŸ“…</span>
        <h3>æ´»å‹•ç®¡ç†</h3>
      </div>
      <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <div class="admin-panel hidden" id="admin-finance">
    <div class="card">
      <div class="card-header">
        <span class="icon">ğŸ’°</span>
        <h3>è²¡å‹™ç®¡ç†</h3>
      </div>
      <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <div class="admin-panel hidden" id="admin-audit">
    <div class="card">
      <div class="card-header">
        <span class="icon">âœ…</span>
        <h3>æ”¯å‡ºå¯©æ ¸</h3>
      </div>
      <div id="pending-expense-list"></div>
    </div>
  </div>

  <div class="admin-panel hidden" id="admin-reports">
    <div class="card">
      <div class="card-header">
        <span class="icon">ğŸ“ˆ</span>
        <h3>æœˆå ±è¡¨æŸ¥è©¢</h3>
      </div>
      
      <div class="form-group">
        <label class="form-label required">æŸ¥è©¢å¹´ä»½</label>
        <select class="form-select" id="report-year">
          <option value="2024">2024å¹´</option>
          <option value="2023">2023å¹´</option>
          <option value="2025">2025å¹´</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label required">æŸ¥è©¢æœˆä»½</label>
        <select class="form-select" id="report-month">
          <option value="1">1æœˆ</option>
          <option value="2">2æœˆ</option>
          <option value="3">3æœˆ</option>
          <option value="4">4æœˆ</option>
          <option value="5">5æœˆ</option>
          <option value="6">6æœˆ</option>
          <option value="7">7æœˆ</option>
          <option value="8">8æœˆ</option>
          <option value="9">9æœˆ</option>
          <option value="10">10æœˆ</option>
          <option value="11">11æœˆ</option>
          <option value="12">12æœˆ</option>
        </select>
      </div>
      
      <button class="btn" id="btn-generate-report">
        <span>ğŸ“Š ç”¢ç”Ÿå ±è¡¨</span>
      </button>
      
      <div id="report-result"></div>
    </div>
  </div>
</div>
</div>

<!-- å›åˆ°é ‚éƒ¨æŒ‰éˆ• -->
<button class="back-to-top" id="back-to-top">â†‘</button>

<!-- é€šçŸ¥å®¹å™¨ -->
<div id="notification-container"></div>

<script>
/* ==============================
 åŸºæœ¬è¨­å®šèˆ‡è®Šæ•¸
============================== */
const APP = {
LIFF_ID: '1656516134-VaGgmaPm',
API_URL: 'https://script.google.com/macros/s/AKfycbzV6k9FCn0BwF3yKVns5N_C3KePPqxW-jzLDAZO1mO5gB3oqlgpAbZzR1jCwr0J2czopQ/exec',
API_KEY: 'AAbb8520258185202581',
RETRIES: 3,
RETRY_DELAY: 800,
PAGE_SIZE: 5
};

let currentUser = null;
let isAdmin = false;
let currentTab = 'profile';
let currentAdminTab = 'overview';

/* ==============================
 å·¥å…·å‡½æ•¸
============================== */
function formatDate(date) {
if (!date) return '';
const d = new Date(date);
if (isNaN(d.getTime())) return '';
return d.toLocaleDateString('zh-TW');
}

function formatDateTime(date) {
if (!date) return '';
const d = new Date(date);
if (isNaN(d.getTime())) return '';
return d.toLocaleString('zh-TW');
}

function formatNumber(num) {
return (num || 0).toLocaleString('zh-TW');
}

function showNotification(message, type = 'info', duration = 4000) {
const container = document.getElementById('notification-container');
const notification = document.createElement('div');
notification.className = `notification ${type}`;
notification.textContent = message;

container.appendChild(notification);

// é¡¯ç¤ºå‹•ç•«
setTimeout(() => notification.classList.add('show'), 100);

// è‡ªå‹•éš±è—
if (duration > 0) {
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => notification.remove(), 300);
  }, duration);
}
}

function setButtonLoading(button, loading) {
if (!button) return;

if (loading) {
  button.disabled = true;
  button.classList.add('loading');
} else {
  button.disabled = false;
  button.classList.remove('loading');
}
}

/* ==============================
 API å‘¼å«
============================== */
async function callAPI(action, data = {}) {
const payload = {
  action,
  apiKey: APP.API_KEY,
  timestamp: Date.now(),
  ...data
};

for (let attempt = 1; attempt <= APP.RETRIES; attempt++) {
  try {
    const response = await fetch(APP.API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const result = await response.json();
    return result;
  } catch (error) {
    if (attempt === APP.RETRIES) {
      return { 
        success: false, 
        message: `API å‘¼å«å¤±æ•—: ${error.message}` 
      };
    }
    await new Promise(resolve => setTimeout(resolve, APP.RETRY_DELAY * attempt));
  }
}
}

/* ==============================
 LIFF åˆå§‹åŒ–
============================== */
async function initializeApp() {
try {
  showNotification('ç³»çµ±åˆå§‹åŒ–ä¸­...', 'info', 2000);
  
  await liff.init({ liffId: APP.LIFF_ID });
  
  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  const profile = await liff.getProfile();
  
  // å»ºç«‹æˆ–æ›´æ–°ä½¿ç”¨è€…
  await callAPI('createUserIfNotExist', {
    lineId: profile.userId,
    lineName: profile.displayName
  });

  await loadUserInfo();
  setupEventListeners();
  
  showNotification('è¼‰å…¥å®Œæˆï¼', 'success', 2000);
  
} catch (error) {
  console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
  showNotification('åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error', 6000);
}
}

/* ==============================
 ä½¿ç”¨è€…è³‡è¨Š
============================== */
async function loadUserInfo() {
try {
  const profile = await liff.getProfile();
  const result = await callAPI('getUserInfo', { lineId: profile.userId });
  
  if (!result.success) {
    showNotification('ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™', 'error');
    return;
  }

  currentUser = result.data;
  isAdmin = !!currentUser.isAdmin;
  
  renderUserInfo();
  updateAdminVisibility();
  
  // é è¼‰è³‡æ–™
  loadActivitiesData();
  loadDonationsData();
  
  if (isAdmin) {
    loadSystemStats();
  }
  
} catch (error) {
  console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨ŠéŒ¯èª¤:', error);
  showNotification('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—', 'error');
}
}

function renderUserInfo() {
const card = document.getElementById('user-info-card');
const details = document.getElementById('user-details');

if (!currentUser) {
  card.classList.add('hidden');
  return;
}

const memberTypeMap = {
  patient: 'ğŸ¥ ç—…å‹',
  family: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶å±¬',
  volunteer: 'ğŸ™‹â€â™€ï¸ å¿—å·¥',
  medical: 'ğŸ‘©â€âš•ï¸ é†«è­·äººå“¡',
  supporter: 'ğŸ¤ æ”¯æŒè€…'
};

details.innerHTML = `
  <div class="list-item">
    <div class="list-item-meta">
      <span><strong>å§“åï¼š</strong>${currentUser.realName || 'æœªè¨­å®š'}</span>
      <span><strong>LINE åç¨±ï¼š</strong>${currentUser.lineName || ''}</span>
      <span><strong>æœƒå“¡é¡åˆ¥ï¼š</strong>${memberTypeMap[currentUser.memberType] || 'æœªè¨­å®š'}</span>
      <span><strong>è¨»å†Šç‹€æ…‹ï¼š</strong>
        <span class="badge ${currentUser.status === 'å·²è¨»å†Š' ? 'success' : 'warning'}">
          ${currentUser.status || 'æœªè¨»å†Š'}
        </span>
      </span>
      ${isAdmin ? '<span><strong>æ¬Šé™ï¼š</strong><span class="badge primary">ç®¡ç†å“¡</span></span>' : ''}
    </div>
  </div>
`;

// å¡«å…¥è¡¨å–®é è¨­å€¼
if (currentUser.realName) {
  document.getElementById('realName').value = currentUser.realName;
}
if (currentUser.memberType) {
  document.getElementById('memberType').value = currentUser.memberType;
}
if (currentUser.phone) {
  document.getElementById('phone').value = currentUser.phone;
}
if (currentUser.email) {
  document.getElementById('email').value = currentUser.email;
}
if (currentUser.address) {
  document.getElementById('address').value = currentUser.address;
}
if (currentUser.birthday) {
  const date = new Date(currentUser.birthday);
  if (!isNaN(date.getTime())) {
    document.getElementById('birthday').value = date.toISOString().split('T')[0];
  }
}

card.classList.remove('hidden');
}

function updateAdminVisibility() {
const adminElements = document.querySelectorAll('.admin-only');
adminElements.forEach(element => {
  if (isAdmin) {
    element.classList.add('show');
  } else {
    element.classList.remove('show');
  }
});
}

/* ==============================
 åˆ†é åˆ‡æ›
============================== */
function switchTab(tabName) {
// æ›´æ–°é¸å–®ç‹€æ…‹
document.querySelectorAll('.menu-card').forEach(card => {
  card.classList.toggle('active', card.dataset.tab === tabName);
});

// æ›´æ–°é¢æ¿é¡¯ç¤º
document.querySelectorAll('.panel').forEach(panel => {
  panel.classList.toggle('active', panel.id === `panel-${tabName}`);
});

currentTab = tabName;

// è¼‰å…¥å°æ‡‰è³‡æ–™
switch (tabName) {
  case 'activities':
    loadActivitiesData();
    break;
  case 'donations':
    loadDonationsData();
    break;
  case 'finance':
    loadExpensesData();
    break;
  case 'feedback':
    loadFeedbackData();
    break;
  case 'admin':
    if (isAdmin) {
      switchAdminTab('overview');
    }
    break;
}
}

function switchAdminTab(tabName) {
// æ›´æ–°ç®¡ç†é¸å–®ç‹€æ…‹
document.querySelectorAll('.quick-action-btn').forEach(btn => {
  btn.classList.toggle('active', btn.dataset.adminTab === tabName);
});

// æ›´æ–°ç®¡ç†é¢æ¿é¡¯ç¤º
document.querySelectorAll('.admin-panel').forEach(panel => {
  panel.classList.toggle('hidden', panel.id !== `admin-${tabName}`);
});

currentAdminTab = tabName;

// è¼‰å…¥å°æ‡‰è³‡æ–™
switch (tabName) {
  case 'overview':
    loadSystemStats();
    break;
  case 'audit':
    loadPendingExpenses();
    break;
}
}

/* ==============================
 æœƒå“¡è¨»å†Šèˆ‡æ›´æ–°
============================== */
async function registerMember() {
if (!currentUser) return;

const realName = document.getElementById('realName').value.trim();
const memberType = document.getElementById('memberType').value;

if (!realName || !memberType) {
  showNotification('è«‹å¡«å¯«å®Œæ•´çš„å§“åå’Œæœƒå“¡é¡åˆ¥', 'warning');
  return;
}

const button = document.getElementById('btn-register');
setButtonLoading(button, true);

try {
  const result = await callAPI('register', {
    lineId: currentUser.lineId,
    realName,
    memberType
  });

  if (result.success) {
    showNotification('è¨»å†ŠæˆåŠŸï¼', 'success');
    await loadUserInfo();
  } else {
    showNotification(result.message || 'è¨»å†Šå¤±æ•—', 'error');
  }
} catch (error) {
  showNotification('è¨»å†Šéç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
} finally {
  setButtonLoading(button, false);
}
}

async function updateContact() {
if (!currentUser) return;

const phone = document.getElementById('phone').value.trim();
const email = document.getElementById('email').value.trim();
const address = document.getElementById('address').value.trim();
const birthday = document.getElementById('birthday').value;

const button = document.getElementById('btn-update-contact');
setButtonLoading(button, true);

try {
  const result = await callAPI('updateUserContact', {
    targetLineId: currentUser.lineId,
    phone,
    email,
    address,
    birthday
  });

  if (result.success) {
    showNotification('è¯çµ¡è³‡è¨Šæ›´æ–°æˆåŠŸï¼', 'success');
    await loadUserInfo();
  } else {
    showNotification(result.message || 'æ›´æ–°å¤±æ•—', 'error');
  }
} catch (error) {
  showNotification('æ›´æ–°éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
} finally {
  setButtonLoading(button, false);
}
}

/* ==============================
 æ´»å‹•ç›¸é—œåŠŸèƒ½
============================== */
async function loadActivitiesData() {
try {
  // è¼‰å…¥å¯å ±åæ´»å‹•
  const activitiesResult = await callAPI('getActivities');
  if (activitiesResult.success) {
    renderActivitiesList(activitiesResult.data || []);
    document.getElementById('stat-activity-total').textContent = (activitiesResult.data || []).length;
  }

  // è¼‰å…¥æˆ‘çš„å ±å
  if (currentUser) {
    const myActivitiesResult = await callAPI('getUserActivities', { 
      lineId: currentUser.lineId 
    });
    if (myActivitiesResult.success) {
      renderMyActivitiesList(myActivitiesResult.data || []);
      document.getElementById('stat-my-registrations').textContent = (myActivitiesResult.data || []).length;
      updateFeedbackActivityOptions(myActivitiesResult.data || []);
    }
  }
} catch (error) {
  console.error('è¼‰å…¥æ´»å‹•è³‡æ–™éŒ¯èª¤:', error);
}
}

function renderActivitiesList(activities) {
const container = document.getElementById('activity-list');

if (!activities.length) {
  container.innerHTML = `
    <div class="empty-state">
      <div class="icon">ğŸ“…</div>
      <div class="message">ç›®å‰æ²’æœ‰å¯å ±åçš„æ´»å‹•</div>
    </div>
  `;
  return;
}

container.innerHTML = activities.map(activity => {
  const currentCount = activity.currentParticipants || 0;
  const maxCount = activity.maxParticipants || 'ä¸é™';
  const isFull = activity.maxParticipants && currentCount >= activity.maxParticipants;
  
  return `
    <div class="list-item">
      <div class="list-item-header">
        <h4 class="list-item-title">${activity.name}</h4>
        ${isFull ? '<span class="badge error">å·²é¡æ»¿</span>' : '<span class="badge success">å¯å ±å</span>'}
      </div>
      <div class="list-item-meta">
        <span>ğŸ“… ${formatDateTime(activity.date) || 'å¾…å®š'}</span>
        <span>ğŸ“ ${activity.location || 'å¾…å®š'}</span>
        <span>ğŸ‘¥ ${currentCount}/${maxCount}</span>
        <span>${activity.fee ? `ğŸ’° NT$ ${formatNumber(activity.fee)}` : 'ğŸ†“ å…è²»'}</span>
      </div>
      <div class="list-item-content">
        ${activity.description || ''}
      </div>
      <div class="list-item-actions">
        ${!isFull ? `
          <button class="btn" onclick="registerForActivity('${activity.id}', '${activity.name}')">
            <span>âœ… ç«‹å³å ±å</span>
          </button>
        ` : `
          <button class="btn" disabled>
            <span>âŒ å·²é¡æ»¿</span>
          </button>
        `}
      </div>
    </div>
  `;
}).join('');
}

function renderMyActivitiesList(activities) {
const container = document.getElementById('my-activity-list');

if (!activities.length) {
  container.innerHTML = `
    <div class="empty-state">
      <div class="icon">ğŸ“‹</div>
      <div class="message">æ‚¨é‚„æ²’æœ‰å ±åä»»ä½•æ´»å‹•</div>
    </div>
  `;
  return;
}

container.innerHTML = activities.map(activity => `
  <div class="list-item">
    <div class="list-item-header">
      <h4 class="list-item-title">${activity.activityName}</h4>
      <span class="badge ${activity.status === 'å·²å ±å' ? 'success' : 'error'}">
        ${activity.status}
      </span>
    </div>
    <div class="list-item-meta">
      <span>ğŸ“… ${formatDateTime(activity.date)}</span>
      <span>ğŸ“ ${activity.location || 'å¾…å®š'}</span>
      <span>ğŸ‘¤ ${activity.participantName}</span>
      <span>ğŸ“ ${formatDate(activity.registerDate)}</span>
    </div>
    ${activity.status === 'å·²å ±å' ? `
      <div class="list-item-actions">
        <button class="btn btn-danger" onclick="cancelRegistration('${activity.id}')">
          <span>âŒ å–æ¶ˆå ±å</span>
        </button>
      </div>
    ` : ''}
  </div>
`).join('');
}

async function registerForActivity(activityId, activityName) {
if (!currentUser || currentUser.status !== 'å·²è¨»å†Š') {
  showNotification('è«‹å…ˆå®Œæˆæœƒå“¡è¨»å†Š', 'warning');
  switchTab('profile');
  return;
}

if (!confirm(`ç¢ºèªè¦å ±åã€Œ${activityName}ã€å—ï¼Ÿ`)) {
  return;
}

try {
  const result = await callAPI('registerActivity', {
    lineId: currentUser.lineId,
    activityId,
    participantName: currentUser.realName || currentUser.lineName
  });

  if (result.success) {
    showNotification('å ±åæˆåŠŸï¼', 'success');
    loadActivitiesData();
  } else {
    showNotification(result.message || 'å ±åå¤±æ•—', 'error');
  }
} catch (error) {
  showNotification('å ±åéç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
}
}

async function cancelRegistration(registrationId) {
if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™å€‹å ±åå—ï¼Ÿ')) {
  return;
}

try {
  const result = await callAPI('cancelActivity', {
    lineId: currentUser.lineId,
    registrationId
  });

  if (result.success) {
    showNotification('å·²å–æ¶ˆå ±å', 'success');
    loadActivitiesData();
  } else {
    showNotification(result.message || 'å–æ¶ˆå¤±æ•—', 'error');
  }
} catch (error) {
  showNotification('å–æ¶ˆéç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
}
}

/* ==============================
 ææ¬¾åŠŸèƒ½
============================== */
async function loadDonationsData() {
if (!currentUser) return;

try {
  const result = await callAPI('getDonations', { lineId: currentUser.lineId });
  
  if (result.success) {
    const donations = result.data || [];
    renderDonationsList(donations);
    
    // æ›´æ–°çµ±è¨ˆ
    document.getElementById('stat-donation-count').textContent = donations.length;
    const total = donations.reduce((sum, donation) => sum + (parseFloat(donation.amount) || 0), 0);
    document.getElementById('stat-donation-total').textContent = `NT$ ${formatNumber(total)}`;
  }
} catch (error) {
  console.error('è¼‰å…¥ææ¬¾è³‡æ–™éŒ¯èª¤:', error);
}
}

function renderDonationsList(donations) {
const container = document.getElementById('donation-list');

if (!donations.length) {
  container.innerHTML = `
    <div class="empty-state">
      <div class="icon">ğŸ’</div>
      <div class="message">æ‚¨é‚„æ²’æœ‰ææ¬¾è¨˜éŒ„</div>
    </div>
  `;
  return;
}

container.innerHTML = donations.map(donation => `
  <div class="list-item">
    <div class="list-item-header">
      <h4 class="list-item-title">ææ¬¾ NT$ ${formatNumber(donation.amount)}</h4>
      <span class="badge success">å·²å®Œæˆ</span>
    </div>
    <div class="list-item-meta">
      <span>ğŸ•’ ${formatDateTime(donation.date)}</span>
      <span>ğŸ™ ${donation.donorName || 'åŒ¿å'}</span>
    </div>
    ${donation.notes ? `
      <div class="list-item-content">
        ç”¨é€”ï¼š${donation.notes}
      </div>
    ` : ''}
  </div>
`).join('');
}

async function addDonation() {
if (!currentUser)
 return;

  const amountSelect = document.getElementById('donation-amount-select').value;
  const customAmount = document.getElementById('donation-amount').value;
  const donorName = document.getElementById('donor-name').value.trim();
  const purpose = document.getElementById('donation-purpose').value;

  let amount;
  if (amountSelect === 'custom') {
    amount = parseFloat(customAmount);
  } else {
    amount = parseFloat(amountSelect);
  }

  if (!amount || amount <= 0) {
    showNotification('è«‹é¸æ“‡æˆ–è¼¸å…¥æœ‰æ•ˆçš„ææ¬¾é‡‘é¡', 'warning');
    return;
  }

  const button = document.getElementById('btn-add-donation');
  setButtonLoading(button, true);

  try {
    const result = await callAPI('addDonation', {
      lineId: currentUser.lineId,
      amount,
      donorName,
      notes: purpose
    });

    if (result.success) {
      showNotification('ææ¬¾æˆåŠŸï¼Œæ„Ÿè¬æ‚¨çš„æ„›å¿ƒï¼', 'success');
      
      // æ¸…ç©ºè¡¨å–®
      document.getElementById('donation-amount-select').value = '';
      document.getElementById('donation-amount').value = '';
      document.getElementById('donor-name').value = '';
      document.getElementById('donation-purpose').value = '';
      document.getElementById('custom-amount-group').classList.add('hidden');
      
      loadDonationsData();
    } else {
      showNotification(result.message || 'ææ¬¾å¤±æ•—', 'error');
    }
  } catch (error) {
    showNotification('ææ¬¾éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
  } finally {
    setButtonLoading(button, false);
  }
}

/* ==============================
 æ”¯å‡ºç”³è«‹åŠŸèƒ½
============================== */
async function loadExpensesData() {
  if (!currentUser) return;

  try {
    const result = await callAPI('getMyExpenses', { lineId: currentUser.lineId });
    
    if (result.success) {
      renderExpensesList(result.data || []);
    }
  } catch (error) {
    console.error('è¼‰å…¥æ”¯å‡ºè³‡æ–™éŒ¯èª¤:', error);
  }
}

function renderExpensesList(expenses) {
  const container = document.getElementById('my-expense-list');
  
  if (!expenses.length) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ’¸</div>
        <div class="message">æ‚¨é‚„æ²’æœ‰æ”¯å‡ºç”³è«‹è¨˜éŒ„</div>
      </div>
    `;
    return;
  }

  container.innerHTML = expenses.map(expense => {
    const statusClass = expense.status === 'å·²æ ¸å‡†' ? 'success' : 
                       expense.status === 'å·²æ‹’çµ•' ? 'error' : 'warning';
    
    return `
      <div class="list-item">
        <div class="list-item-header">
          <h4 class="list-item-title">${expense.category} - NT$ ${formatNumber(expense.amount)}</h4>
          <span class="badge ${statusClass}">${expense.status}</span>
        </div>
        <div class="list-item-meta">
          <span>ğŸ•’ ç”³è«‹ï¼š${formatDateTime(expense.submitDate)}</span>
          ${expense.approvedDate ? `<span>ğŸ” å¯©æ ¸ï¼š${formatDateTime(expense.approvedDate)}</span>` : ''}
        </div>
        <div class="list-item-content">
          ${expense.description}
        </div>
        ${expense.notes ? `
          <div class="list-item-content">
            <strong>å¯©æ ¸å‚™è¨»ï¼š</strong>${expense.notes}
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
}

async function submitExpense() {
  if (!currentUser) return;

  const category = document.getElementById('expense-category').value;
  const amountSelect = document.getElementById('expense-amount-select').value;
  const customAmount = document.getElementById('expense-amount').value;
  const description = document.getElementById('expense-description').value.trim();

  if (!category || !description) {
    showNotification('è«‹å¡«å¯«å®Œæ•´çš„æ”¯å‡ºè³‡è¨Š', 'warning');
    return;
  }

  let amount;
  if (amountSelect === 'custom') {
    amount = parseFloat(customAmount);
  } else {
    amount = parseFloat(amountSelect);
  }

  if (!amount || amount <= 0) {
    showNotification('è«‹é¸æ“‡æˆ–è¼¸å…¥æœ‰æ•ˆçš„ç”³è«‹é‡‘é¡', 'warning');
    return;
  }

  const button = document.getElementById('btn-submit-expense');
  setButtonLoading(button, true);

  try {
    const result = await callAPI('submitExpense', {
      lineId: currentUser.lineId,
      category,
      amount,
      description
    });

    if (result.success) {
      showNotification('æ”¯å‡ºç”³è«‹å·²æäº¤', 'success');
      
      // æ¸…ç©ºè¡¨å–®
      document.getElementById('expense-category').value = '';
      document.getElementById('expense-amount-select').value = '';
      document.getElementById('expense-amount').value = '';
      document.getElementById('expense-description').value = '';
      document.getElementById('custom-expense-group').classList.add('hidden');
      
      loadExpensesData();
    } else {
      showNotification(result.message || 'ç”³è«‹å¤±æ•—', 'error');
    }
  } catch (error) {
    showNotification('ç”³è«‹éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
  } finally {
    setButtonLoading(button, false);
  }
}

/* ==============================
 å›é¥‹åŠŸèƒ½
============================== */
async function loadFeedbackData() {
  if (!currentUser) return;

  try {
    const result = await callAPI('getMyFeedback', { lineId: currentUser.lineId });
    
    if (result.success) {
      renderFeedbackList(result.data || []);
    }
  } catch (error) {
    console.error('è¼‰å…¥å›é¥‹è³‡æ–™éŒ¯èª¤:', error);
  }
}

function renderFeedbackList(feedbacks) {
  const container = document.getElementById('my-feedback-list');
  
  if (!feedbacks.length) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ“</div>
        <div class="message">æ‚¨é‚„æ²’æœ‰æäº¤ä»»ä½•å›é¥‹</div>
      </div>
    `;
    return;
  }

  container.innerHTML = feedbacks.map(feedback => {
    const stars = 'â­'.repeat(feedback.rating) + 'â˜†'.repeat(5 - feedback.rating);
    
    return `
      <div class="list-item">
        <div class="list-item-header">
          <h4 class="list-item-title">${feedback.activityName}</h4>
          <span class="badge primary">${stars}</span>
        </div>
        <div class="list-item-meta">
          <span>è©•åˆ†ï¼š${feedback.rating}/5</span>
          <span>æ—¥æœŸï¼š${formatDate(feedback.submitDate)}</span>
        </div>
        ${feedback.comment ? `
          <div class="list-item-content">
            ${feedback.comment}
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
}

function updateFeedbackActivityOptions(activities) {
  const select = document.getElementById('feedback-activity');
  const attendedActivities = activities.filter(activity => activity.status === 'å·²å ±å');
  
  select.innerHTML = '<option value="">è«‹é¸æ“‡è¦è©•åƒ¹çš„æ´»å‹•</option>' + 
    attendedActivities.map(activity => 
      `<option value="${activity.activityId}">${activity.activityName}</option>`
    ).join('');
}

async function submitFeedback() {
  if (!currentUser) return;

  const activityId = document.getElementById('feedback-activity').value;
  const rating = parseInt(document.getElementById('feedback-rating').value);
  const comment = document.getElementById('feedback-comment').value.trim();

  if (!activityId || !rating) {
    showNotification('è«‹é¸æ“‡æ´»å‹•å’Œè©•åˆ†', 'warning');
    return;
  }

  const button = document.getElementById('btn-submit-feedback');
  setButtonLoading(button, true);

  try {
    const result = await callAPI('submitFeedback', {
      lineId: currentUser.lineId,
      activityId,
      rating,
      comment
    });

    if (result.success) {
      showNotification('å›é¥‹å·²æäº¤ï¼Œè¬è¬æ‚¨çš„æ„è¦‹ï¼', 'success');
      
      // æ¸…ç©ºè¡¨å–®
      document.getElementById('feedback-activity').value = '';
      document.getElementById('feedback-rating').value = '';
      document.getElementById('feedback-comment').value = '';
      
      loadFeedbackData();
    } else {
      showNotification(result.message || 'æäº¤å¤±æ•—', 'error');
    }
  } catch (error) {
    showNotification('æäº¤éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
  } finally {
    setButtonLoading(button, false);
  }
}

/* ==============================
 ç®¡ç†åŠŸèƒ½
============================== */
async function loadSystemStats() {
  if (!isAdmin || !currentUser) return;

  try {
    const result = await callAPI('getSystemStats', { 
      operatorLineId: currentUser.lineId 
    });
    
    if (result.success) {
      const stats = result.data;
      document.getElementById('stat-total-members').textContent = stats.totalMembers || 0;
      document.getElementById('stat-registered-members').textContent = stats.registeredMembers || 0;
      document.getElementById('stat-active-activities').textContent = stats.activeActivities || 0;
      document.getElementById('stat-total-registrations').textContent = stats.totalRegistrations || 0;
    }
  } catch (error) {
    console.error('è¼‰å…¥ç³»çµ±çµ±è¨ˆéŒ¯èª¤:', error);
  }
}

async function createActivity() {
  if (!isAdmin || !currentUser) return;

  const name = document.getElementById('new-activity-name').value.trim();
  const date = document.getElementById('new-activity-date').value;
  const location = document.getElementById('new-activity-location').value.trim();
  const description = document.getElementById('new-activity-desc').value.trim();
  
  const maxSelect = document.getElementById('new-activity-max-select').value;
  const customMax = document.getElementById('new-activity-max').value;
  const feeSelect = document.getElementById('new-activity-fee-select').value;
  const customFee = document.getElementById('new-activity-fee').value;

  if (!name || !date || !description) {
    showNotification('è«‹å¡«å¯«æ´»å‹•åç¨±ã€æ—¥æœŸå’Œæè¿°', 'warning');
    return;
  }

  let maxParticipants = null;
  if (maxSelect === 'custom') {
    maxParticipants = parseInt(customMax) || null;
  } else if (maxSelect) {
    maxParticipants = parseInt(maxSelect);
  }

  let fee = 0;
  if (feeSelect === 'custom') {
    fee = parseFloat(customFee) || 0;
  } else {
    fee = parseFloat(feeSelect) || 0;
  }

  const button = document.getElementById('btn-create-activity');
  setButtonLoading(button, true);

  try {
    const result = await callAPI('createActivity', {
      operatorLineId: currentUser.lineId,
      name,
      date,
      location,
      description,
      maxParticipants,
      fee
    });

    if (result.success) {
      showNotification('æ´»å‹•å»ºç«‹æˆåŠŸï¼', 'success');
      
      // æ¸…ç©ºè¡¨å–®
      document.getElementById('new-activity-name').value = '';
      document.getElementById('new-activity-date').value = '';
      document.getElementById('new-activity-location').value = '';
      document.getElementById('new-activity-desc').value = '';
      document.getElementById('new-activity-max-select').value = '';
      document.getElementById('new-activity-max').value = '';
      document.getElementById('new-activity-fee-select').value = '0';
      document.getElementById('new-activity-fee').value = '';
      document.getElementById('custom-max-group').classList.add('hidden');
      document.getElementById('custom-fee-group').classList.add('hidden');
      
      loadSystemStats();
      if (currentTab === 'activities') {
        loadActivitiesData();
      }
    } else {
      showNotification(result.message || 'å»ºç«‹å¤±æ•—', 'error');
    }
  } catch (error) {
    showNotification('å»ºç«‹éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
  } finally {
    setButtonLoading(button, false);
  }
}

async function loadPendingExpenses() {
  if (!isAdmin || !currentUser) return;

  try {
    const result = await callAPI('getPendingExpenses', { 
      operatorLineId: currentUser.lineId 
    });
    
    if (result.success) {
      renderPendingExpenses(result.data || []);
    }
  } catch (error) {
    console.error('è¼‰å…¥å¾…å¯©æ ¸æ”¯å‡ºéŒ¯èª¤:', error);
  }
}

function renderPendingExpenses(expenses) {
  const container = document.getElementById('pending-expense-list');
  
  if (!expenses.length) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">âœ…</div>
        <div class="message">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„æ”¯å‡ºç”³è«‹</div>
      </div>
    `;
    return;
  }

  container.innerHTML = expenses.map(expense => `
    <div class="list-item">
      <div class="list-item-header">
        <h4 class="list-item-title">${expense.applicantName} - ${expense.category}</h4>
        <span class="badge warning">å¾…å¯©æ ¸</span>
      </div>
      <div class="list-item-meta">
        <span>ğŸ’° NT$ ${formatNumber(expense.amount)}</span>
        <span>ğŸ•’ ${formatDateTime(expense.submitDate)}</span>
      </div>
      <div class="list-item-content">
        ${expense.description}
      </div>
      <div class="list-item-actions">
        <button class="btn btn-success" onclick="approveExpense('${expense.id}', true)">
          <span>âœ… æ ¸å‡†</span>
        </button>
        <button class="btn btn-danger" onclick="approveExpense('${expense.id}', false)">
          <span>âŒ æ‹’çµ•</span>
        </button>
      </div>
    </div>
  `).join('');
}

async function approveExpense(expenseId, approved) {
  let notes = '';
  if (!approved) {
    notes = prompt('è«‹è¼¸å…¥æ‹’çµ•åŸå› ï¼ˆå¯ç•™ç©ºï¼‰ï¼š') || '';
  }

  try {
    const result = await callAPI('approveExpense', {
      operatorLineId: currentUser.lineId,
      expenseId,
      approved,
      notes
    });

    if (result.success) {
      showNotification(approved ? 'å·²æ ¸å‡†ç”³è«‹' : 'å·²æ‹’çµ•ç”³è«‹', 'success');
      loadPendingExpenses();
    } else {
      showNotification(result.message || 'æ“ä½œå¤±æ•—', 'error');
    }
  } catch (error) {
    showNotification('æ“ä½œéç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
  }
}

async function generateReport() {
  if (!isAdmin || !currentUser) return;

  const year = parseInt(document.getElementById('report-year').value);
  const month = parseInt(document.getElementById('report-month').value);

  const button = document.getElementById('btn-generate-report');
  setButtonLoading(button, true);

  try {
    const result = await callAPI('generateReport', {
      operatorLineId: currentUser.lineId,
      year,
      month
    });

    if (result.success) {
      renderReport(result.data);
      showNotification('å ±è¡¨ç”¢ç”ŸæˆåŠŸ', 'success');
    } else {
      showNotification(result.message || 'å ±è¡¨ç”¢ç”Ÿå¤±æ•—', 'error');
    }
  } catch (error) {
    showNotification('å ±è¡¨ç”¢ç”Ÿéç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
  } finally {
    setButtonLoading(button, false);
  }
}

function renderReport(data) {
  const container = document.getElementById('report-result');
  
  container.innerHTML = `
    <div class="card" style="margin-top: 20px;">
      <div class="card-header">
        <span class="icon">ğŸ“Š</span>
        <h3>${data.period} è²¡å‹™å ±è¡¨</h3>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number">NT$ ${formatNumber(data.totalIncome)}</div>
          <div class="stat-label">ç¸½æ”¶å…¥</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">NT$ ${formatNumber(data.totalExpense)}</div>
          <div class="stat-label">ç¸½æ”¯å‡º</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">NT$ ${formatNumber(data.balance)}</div>
          <div class="stat-label">çµé¤˜</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${data.donationCount || 0}</div>
          <div class="stat-label">ææ¬¾ç­†æ•¸</div>
        </div>
      </div>
    </div>
  `;
}

/* ==============================
 äº‹ä»¶ç›£è½å™¨è¨­å®š
============================== */
function setupEventListeners() {
  // ä¸»é¸å–®åˆ‡æ›
  document.querySelectorAll('.menu-card').forEach(card => {
    card.addEventListener('click', () => {
      switchTab(card.dataset.tab);
    });
  });

  // ç®¡ç†é¸å–®åˆ‡æ›
  document.querySelectorAll('.quick-action-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      switchAdminTab(btn.dataset.adminTab);
    });
  });

  // è¡¨å–®æäº¤æŒ‰éˆ•
  document.getElementById('btn-register').addEventListener('click', registerMember);
  document.getElementById('btn-update-contact').addEventListener('click', updateContact);
  document.getElementById('btn-add-donation').addEventListener('click', addDonation);
  document.getElementById('btn-submit-expense').addEventListener('click', submitExpense);
  document.getElementById('btn-submit-feedback').addEventListener('click', submitFeedback);
  document.getElementById('btn-create-activity').addEventListener('click', createActivity);
  document.getElementById('btn-generate-report').addEventListener('click', generateReport);

  // å‹•æ…‹é¡¯ç¤ºè‡ªè¨‚è¼¸å…¥æ¡†
  document.getElementById('donation-amount-select').addEventListener('change', function() {
    const customGroup = document.getElementById('custom-amount-group');
    if (this.value === 'custom') {
      customGroup.classList.remove('hidden');
    } else {
      customGroup.classList.add('hidden');
    }
  });

  document.getElementById('expense-amount-select').addEventListener('change', function() {
    const customGroup = document.getElementById('custom-expense-group');
    if (this.value === 'custom') {
      customGroup.classList.remove('hidden');
    } else {
      customGroup.classList.add('hidden');
    }
  });

  document.getElementById('new-activity-max-select').addEventListener('change', function() {
    const customGroup = document.getElementById('custom-max-group');
    if (this.value === 'custom') {
      customGroup.classList.remove('hidden');
    } else {
      customGroup.classList.add('hidden');
    }
  });

  document.getElementById('new-activity-fee-select').addEventListener('change', function() {
    const customGroup = document.getElementById('custom-fee-group');
    if (this.value === 'custom') {
      customGroup.classList.remove('hidden');
    } else {
      customGroup.classList.add('hidden');
    }
  });

  // æœå°‹åŠŸèƒ½
  document.getElementById('activity-search').addEventListener('input', debounce(searchActivities, 300));

  // å›åˆ°é ‚éƒ¨æŒ‰éˆ•
  const backToTopBtn = document.getElementById('back-to-top');
  window.addEventListener('scroll', () => {
    if (window.pageYOffset > 300) {
      backToTopBtn.classList.add('show');
    } else {
      backToTopBtn.classList.remove('show');
    }
  });

  backToTopBtn.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function searchActivities() {
  // æœå°‹åŠŸèƒ½å¯¦ä½œ
  const keyword = document.getElementById('activity-search').value.toLowerCase();
  // é€™è£¡å¯ä»¥åŠ å…¥æœå°‹é‚è¼¯
}

/* ==============================
 æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•
============================== */
document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
