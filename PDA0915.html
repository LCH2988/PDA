<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å¸•é‡‘æ£®ç—…å‹æœƒç³»çµ± v2.4</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="theme-color" content="#4a67d6">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
<style>
:root {
--base-font:17px;
--font-scale:1;
--primary:#4a67d6;
--primary-alt:#2f4bb0;
--grad:linear-gradient(135deg,#4a67d6,#6d4acb);
--bg:#eef2f8;
--card:#ffffff;
--success:#2f9e44;
--warn:#d98324;
--error:#d64545;
--text:#1f2933;
--text-light:#5d6a75;
--radius:18px;
--shadow:0 4px 14px rgba(0,0,0,.08);
--focus-ring:0 0 0 4px rgba(74,103,214,.35);
}
body.high-contrast {
--bg:#101418;
--card:#1d242b;
--text:#f5f7fa;
--text-light:#c5ced6;
--shadow:0 4px 16px rgba(0,0,0,.6);
--grad:linear-gradient(135deg,#203a85,#4a67d6);
}
html,body { font-size: var(--base-font); }
body {
margin:0; background:var(--bg); color:var(--text);
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC",Roboto,sans-serif;
line-height:1.6; letter-spacing:.3px;
transition:background .4s,color .4s;
}
body.font-large { --base-font:20px; }
body.font-xlarge { --base-font:22px; }
header {
background:var(--grad); color:#fff; padding:28px 16px 22px;
position:sticky; top:0; z-index:20; text-align:center;
box-shadow:0 6px 16px rgba(0,0,0,.18);
}
h1 { margin:0; font-size:1.55rem; letter-spacing:1px; }
.subtitle { font-size:.9rem; opacity:.9; margin-top:6px; }
.access-bar {
margin-top:14px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;
}
.access-bar button {
background:rgba(255,255,255,.15); color:#fff; border:2px solid rgba(255,255,255,.35);
padding:8px 14px; border-radius:999px; cursor:pointer; font-size:.85rem;
font-weight:600; backdrop-filter:blur(4px);
transition:.25s;
}
.access-bar button:hover, .access-bar button:focus-visible {
background:#fff; color:#333;
outline:none;
}
.container { max-width:1180px; margin:0 auto; padding:18px 16px 60px; }

.tabs { display:flex; gap:10px; flex-wrap:wrap; margin:18px 0 14px; }
.tab-btn {
flex:1 1 180px; background:#fff; border:2px solid #d0d7e2;
border-radius:14px; padding:14px 12px; cursor:pointer;
font-size:1rem; font-weight:700; text-align:center;
display:flex; align-items:center; justify-content:center; gap:6px;
transition:.25s; min-height:54px; line-height:1.3;
}
.tab-btn .icon { font-size:1.25rem; }
.tab-btn:hover:not(.active){ border-color:var(--primary); }
.tab-btn.active {
background:var(--grad); color:#fff; border-color:var(--primary);
box-shadow:0 6px 18px rgba(74,103,214,.45);
}

.panel { display:none; animation:fade .45s ease; }
.panel.active { display:block; }

@keyframes fade { from{opacity:0; transform:translateY(18px);} to{opacity:1; transform:translateY(0);} }

.card {
background:var(--card); border-radius:var(--radius);
padding:22px 22px 24px; margin-bottom:22px;
box-shadow:var(--shadow); position:relative;
transition:background .4s;
}
.card h3 { margin:0 0 14px; font-size:1.2rem; letter-spacing:.5px; }
.card h4 { margin:0 0 10px; font-size:1.05rem; }

.grid { display:grid; gap:18px; }
@media (min-width:760px){
.grid.cols-2{ grid-template-columns:repeat(2,1fr); }
.grid.cols-3{ grid-template-columns:repeat(3,1fr); }
.grid.cols-4{ grid-template-columns:repeat(4,1fr); }
}

.stat {
background:var(--card); border-radius:18px; text-align:center;
padding:22px 12px 20px; position:relative;
box-shadow:var(--shadow);
}
.stat:before {
content:''; position:absolute; top:0; left:0; width:100%; height:5px;
background:var(--grad); border-top-left-radius:18px; border-top-right-radius:18px;
}
.stat .num { font-size:1.75rem; font-weight:800; color:var(--primary); margin:8px 0 4px; }
.stat .label { font-size:.8rem; color:var(--text-light); letter-spacing:1px; font-weight:600; }

label { font-size:.85rem; font-weight:700; margin-bottom:6px; display:block; color:var(--text-light); }
input,select,textarea {
width:100%; padding:13px 14px; font-size:1rem;
border:2px solid #c5ced8; border-radius:14px; background:#fff;
transition:.25s; font-weight:500;
}
textarea { resize:vertical; min-height:110px; }
input:focus,select:focus,textarea:focus {
outline:none; border-color:var(--primary); box-shadow:var(--focus-ring);
}

.actions { display:flex; gap:12px; flex-wrap:wrap; margin-top:6px; }
.btn {
background:var(--grad); color:#fff; padding:12px 20px;
border:none; border-radius:14px; font-size:.95rem; font-weight:700;
cursor:pointer; display:inline-flex; align-items:center; gap:8px;
box-shadow:0 5px 15px rgba(74,103,214,.45); position:relative; transition:.25s;
letter-spacing:.5px; min-height:46px;
}
.btn:hover { transform:translateY(-3px); }
.btn:active { transform:translateY(0); }
.btn.outline {
background:#fff; color:var(--primary); border:2px solid var(--primary);
box-shadow:none;
}
.btn.outline:hover { background:var(--grad); color:#fff; }
.btn.secondary { background:#455468; box-shadow:0 4px 12px rgba(69,84,104,.4); }
.btn.danger { background:linear-gradient(135deg,#e05252,#c92a2a); box-shadow:0 4px 14px rgba(201,42,42,.5); }
.btn.warn { background:linear-gradient(135deg,#f59f00,#d98200); }
.btn.small { padding:8px 14px; font-size:.8rem; min-height:40px; }
.btn.disabled,.btn:disabled { opacity:.55; cursor:not-allowed; }

.btn.loading .text{ opacity:0; }
.btn.loading:after {
content:''; width:20px; height:20px; border:3px solid rgba(255,255,255,.35);
border-top:3px solid #fff; border-radius:50%; animation:spin 1s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg);} }

.inline { display:flex; gap:14px; flex-wrap:wrap; align-items:center; }
.badge {
display:inline-block; padding:5px 12px; font-size:.7rem; font-weight:700;
border-radius:999px; background:#e6ebf2; color:#333; letter-spacing:.5px; margin-right:4px;
}
.badge.green { background:rgba(47,158,68,.18); color:#2f9e44; }
.badge.red { background:rgba(214,69,69,.18); color:#d64545; }
.badge.orange { background:rgba(217,131,36,.18); color:#d98324; }
.badge.blue { background:rgba(74,103,214,.18); color:#4a67d6; }

.list-item {
background:#fff; border-radius:18px; padding:18px 20px; margin-bottom:16px;
box-shadow:var(--shadow); border-left:6px solid var(--primary); position:relative;
font-size:1rem;
}
.list-item.full { border-left-color:var(--error); }
.list-item h4 { margin:0 0 8px; font-size:1.05rem; letter-spacing:.5px; }
.meta {
font-size:.72rem; color:var(--text-light); display:flex; gap:14px; flex-wrap:wrap;
line-height:1.3; font-weight:500;
}

.notice {
padding:16px 18px; border-radius:16px; font-size:.92rem; line-height:1.5;
background:#fffaf0; color:#744210; border:2px solid #fbd38d; margin-bottom:18px;
}
.notice.error { background:#fff5f5; color:#842029; border-color:#feb2b2; }
.notice.success { background:#f0fff4; color:#22543d; border-color:#9ae6b4; }
.notice.info { background:#ebf8ff; color:#2b6cb0; border-color:#90cdf4; }

.empty { text-align:center; padding:60px 20px; color:var(--text-light); font-size:1rem; }
.empty .icon { font-size:3rem; margin-bottom:8px; }

.pagination { display:flex; gap:8px; flex-wrap:wrap; margin-top:14px; }
.pagination button {
padding:8px 14px; border:2px solid #d0d7e2; background:#fff;
font-weight:700; border-radius:12px; cursor:pointer; font-size:.85rem; letter-spacing:.5px;
}
.pagination button.active, .pagination button:hover {
background:var(--grad); color:#fff; border-color:var(--primary);
}

.notification {
position:fixed; top:24px; right:24px; background:#2d3748; color:#fff;
padding:16px 22px; border-radius:16px; box-shadow:0 10px 35px rgba(0,0,0,.3);
transform:translateY(-25px); opacity:0; transition:.45s; z-index:999;
max-width:420px; display:flex; gap:16px; align-items:flex-start; font-size:1rem;
}
.notification.show { transform:translateY(0); opacity:1; }
.notification.success { background:var(--success); }
.notification.error { background:var(--error); }
.notification.warn { background:var(--warn); }
.notification button {
background:rgba(255,255,255,.2); color:#fff; border:none;
width:32px; height:32px; border-radius:50%; cursor:pointer;
font-weight:700; font-size:16px; line-height:1;
}

.table-wrap { overflow-x:auto; }
table { width:100%; border-collapse:collapse; font-size:.85rem; }
th,td { padding:10px 12px; text-align:left; border-bottom:1px solid #dfe5ec; }
th {
background:#f1f4f8; font-weight:700; font-size:.72rem;
letter-spacing:.8px; color:#4a5568; text-transform:uppercase;
}
tr:hover td { background:#fafbfc; }

.inline-edit-input {
width:100%; border:1px solid #cbd5e0; border-radius:8px; padding:6px 8px; font-size:.8rem;
background:#fff;
}

.progress { width:100%; height:12px; background:#d9e1eb; border-radius:8px; overflow:hidden; }
.progress > div { height:100%; background:var(--grad); width:0; transition:width .6s; }

.subtabs { display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 22px; }
.subtab-btn {
background:#fff; border:2px solid #d0d7e2; padding:10px 16px; border-radius:12px;
font-size:.85rem; font-weight:700; cursor:pointer; transition:.25s;
min-height:44px;
}
.subtab-btn.active {
background:var(--grad); color:#fff; border-color:var(--primary);
box-shadow:0 5px 16px rgba(74,103,214,.45);
}

footer {
text-align:center; padding:50px 0 80px; font-size:.7rem;
color:#8a98a8; letter-spacing:.5px;
}

body.high-contrast .card,
body.high-contrast .stat,
body.high-contrast .list-item,
body.high-contrast .tab-btn:not(.active),
body.high-contrast .subtab-btn:not(.active){
background:#24303a; border-color:#3a4a58;
}
body.high-contrast input,
body.high-contrast select,
body.high-contrast textarea {
background:#1d242b; color:#fff; border-color:#3a4a58;
}
body.high-contrast table th { background:#2d3a45; }
body.high-contrast .notice.info { background:#153954; color:#a9d8ff; }

:focus-visible { outline:2px solid var(--primary); outline-offset:3px; border-radius:8px; }

/* æ‰‹æ©Ÿèª¿æ•´ */
@media (max-width:640px){
h1 { font-size:1.35rem; }
.tab-btn { flex:1 1 calc(50% - 8px); font-size:.9rem; }
table { font-size:.75rem; }
.stat .num { font-size:1.4rem; }
}
</style>
</head>
<body>
<header>
<h1>ğŸ¥ å¸•é‡‘æ£®ç—…å‹æœƒ ç³»çµ± v2.4</h1>
<div class="subtitle">æœƒå“¡ãƒ»æ´»å‹•ãƒ»ææ¬¾ãƒ»æ”¯å‡ºãƒ»å›é¥‹ãƒ»ç†ç›£äº‹ãƒ»å ±è¡¨</div>
<div class="access-bar">
  <button id="btn-font-down" aria-label="ç¸®å°å­—é«”">ï¼¡ï¼</button>
  <button id="btn-font-up" aria-label="æ”¾å¤§å­—é«”">ï¼¡ï¼‹</button>
  <button id="btn-contrast" aria-label="é«˜å°æ¯”æ¨¡å¼åˆ‡æ›">é«˜å°æ¯”</button>
  <button id="btn-reload" aria-label="é‡æ–°æ•´ç†è³‡æ–™">é‡æ–°æ•´ç†</button>
</div>
</header>
<div class="container">

<!-- å€‹äººè³‡è¨Š -->
<div id="user-info" class="card hidden">
  <h3>ğŸ‘¤ å€‹äººè³‡è¨Š</h3>
  <div id="user-details"></div>
</div>

<!-- Tabs -->
<div class="tabs" id="tabs">
  <div class="tab-btn active" data-tab="profile"><span class="icon">ğŸ“</span>å€‹äººè³‡æ–™</div>
  <div class="tab-btn" data-tab="activities"><span class="icon">ğŸ“…</span>æ´»å‹•</div>
  <div class="tab-btn" data-tab="donations"><span class="icon">ğŸ’</span>ææ¬¾</div>
  <div class="tab-btn" data-tab="finance"><span class="icon">ğŸ’¸</span>æ”¯å‡º / è²¡å‹™</div>
  <div class="tab-btn" data-tab="feedback"><span class="icon">ğŸ—£</span>å›é¥‹</div>
  <div class="tab-btn admin-only hidden" data-tab="admin"><span class="icon">ğŸ› </span>ç®¡ç†</div>
</div>

<!-- Panels: ä¾åŸåŠŸèƒ½ (ç‚ºç¯€çœç¯‡å¹…ï¼Œä»¥ä¸‹å‰ç«¯ JS èˆ‡åŸ v2.3 ç›¸åŒé‚è¼¯ï¼Œåƒ…èª¿æ•´æ¨£å¼åŠåŠ ä¸Šå­—ç´š / é«˜å°æ¯”æ“ä½œ)
     ç”±æ–¼ç¯‡å¹…é™åˆ¶ï¼Œæ­¤è™•å‰ç«¯ JS ä¿ç•™åŠŸèƒ½é‚è¼¯ä¸å†é€å­—è¨»è§£ â†’ å·²å…§åµŒæ–¼è…³æœ¬å€åŸŸ
     è‹¥éœ€ç´°ç¯€èªªæ˜å¯å†æå‡ºã€‚ -->

<div class="panel active" id="panel-profile">
  <div class="card">
    <h3>ğŸ“ æœƒå“¡è¨»å†Š / æ›´æ–°</h3>
    <div class="grid cols-2">
      <div>
        <label for="realName">çœŸå¯¦å§“å *</label>
        <input id="realName" type="text" placeholder="è«‹è¼¸å…¥å§“å">
      </div>
      <div>
        <label for="memberType">æœƒå“¡é¡åˆ¥ *</label>
        <select id="memberType">
          <option value="">è«‹é¸æ“‡</option>
          <option value="patient">ç—…å‹</option>
          <option value="family">å®¶å±¬</option>
          <option value="volunteer">å¿—å·¥</option>
          <option value="medical">é†«è­·</option>
          <option value="supporter">æ”¯æŒè€…</option>
        </select>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="btn-register"><span class="text">å„²å­˜è¨»å†Šè³‡æ–™</span></button>
    </div>
    <div style="margin:22px 0 10px; height:2px; background:linear-gradient(90deg,#c8d1dc,#e2e8f0,#c8d1dc);"></div>
    <h4>ğŸ“ è¯çµ¡è³‡è¨Š</h4>
    <div class="grid cols-2">
      <div>
        <label for="phone">é›»è©±</label>
        <input id="phone" type="tel" placeholder="ä¾‹å¦‚ï¼š0912345678">
      </div>
      <div>
        <label for="email">é›»å­éƒµä»¶</label>
        <input id="email" type="email">
      </div>
      <div>
        <label for="address">åœ°å€</label>
        <input id="address" type="text">
      </div>
      <div>
        <label for="birthday">ç”Ÿæ—¥</label>
        <input id="birthday" type="date">
      </div>
    </div>
    <div class="actions">
      <button class="btn secondary" id="btn-update-contact"><span class="text">æ›´æ–°è¯çµ¡è³‡è¨Š</span></button>
    </div>
  </div>
</div>

<div class="panel" id="panel-activities">
  <div class="grid cols-2 mb">
    <div class="stat"><div class="num" id="stat-activity-total">0</div><div class="label">å¯å ±åæ´»å‹•</div></div>
    <div class="stat"><div class="num" id="stat-my-registrations">0</div><div class="label">æˆ‘çš„å ±å</div></div>
  </div>
  <div class="card">
    <div class="inline" style="justify-content:space-between;align-items:center;">
      <h3 style="margin:0;">ğŸ“… å¯å ±åæ´»å‹•</h3>
      <div style="position:relative;min-width:240px;">
        <input id="activity-search" type="text" placeholder="æœå°‹æ´»å‹•é—œéµå­—...">
      </div>
    </div>
    <div id="activity-list" style="margin-top:16px;"></div>
    <div class="pagination" id="activity-pagination"></div>
  </div>
  <div class="card">
    <h3>ğŸ—‚ æˆ‘çš„æ´»å‹•å ±å</h3>
    <div id="my-activity-list"></div>
  </div>
</div>

<div class="panel" id="panel-donations">
  <div class="grid cols-2 mb">
    <div class="stat"><div class="num" id="stat-donation-count">0</div><div class="label">ææ¬¾ç­†æ•¸</div></div>
    <div class="stat"><div class="num" id="stat-donation-total">0</div><div class="label">ææ¬¾ç¸½é¡</div></div>
  </div>
  <div class="card">
    <h3>ğŸ’ æ–°å¢ææ¬¾</h3>
    <div class="grid cols-2">
      <div>
        <label for="donation-amount">é‡‘é¡ *</label>
        <input id="donation-amount" type="number" min="1">
      </div>
      <div>
        <label for="donor-name">ææ¬¾äººå§“å (å¯ç•™ç©º)</label>
        <input id="donor-name" type="text">
      </div>
    </div>
    <div>
      <label for="donation-notes">å‚™è¨»</label>
      <textarea id="donation-notes" placeholder="ææ¬¾ç”¨é€”æˆ–å‚™è¨»"></textarea>
    </div>
    <div class="actions">
      <button class="btn" id="btn-add-donation"><span class="text">æ–°å¢ææ¬¾è¨˜éŒ„</span></button>
    </div>
  </div>
  <div class="card">
    <h3>ğŸ“Š æˆ‘çš„ææ¬¾è¨˜éŒ„</h3>
    <div id="donation-list"></div>
  </div>
</div>

<div class="panel" id="panel-finance">
  <div class="card admin-only hidden" id="accounts-card">
    <h3>ğŸ’³ å¸³æˆ¶é¤˜é¡</h3>
    <div id="account-list"></div>
  </div>
  <div class="card admin-only hidden" id="budget-card">
    <h3>ğŸ“ˆ æœ¬æœˆé ç®—</h3>
    <div class="progress"><div id="budget-progress"></div></div>
    <div id="budget-detail" style="margin-top:12px;font-size:.95rem;"></div>
  </div>
  <div class="card">
    <h3>ğŸ’¸ æ”¯å‡ºç”³è«‹</h3>
    <div class="grid cols-2">
      <div>
        <label for="expense-category">æ”¯å‡ºé¡åˆ¥ *</label>
        <select id="expense-category">
          <option value="activity">æ´»å‹•æ”¯å‡º</option>
          <option value="office">è¾¦å…¬è²»ç”¨</option>
          <option value="marketing">å®£å‚³è²»ç”¨</option>
          <option value="equipment">è¨­å‚™è²»ç”¨</option>
          <option value="welfare">ç¦åˆ©æ”¯å‡º</option>
          <option value="medical">é†«ç™‚æ”¯æ´</option>
          <option value="volunteer">å¿—å·¥è²»ç”¨</option>
          <option value="other">å…¶ä»–æ”¯å‡º</option>
        </select>
      </div>
      <div>
        <label for="expense-amount">é‡‘é¡ *</label>
        <input id="expense-amount" type="number" min="1">
      </div>
    </div>
    <div>
      <label for="expense-description">èªªæ˜ *</label>
      <textarea id="expense-description" placeholder="è«‹è©³ç´°å¡«å¯«ç”¨é€”"></textarea>
    </div>
    <div class="actions">
      <button class="btn" id="btn-submit-expense"><span class="text">æäº¤æ”¯å‡ºç”³è«‹</span></button>
    </div>
  </div>
  <div class="card">
    <h3>ğŸ—‚ æˆ‘çš„æ”¯å‡ºç”³è«‹</h3>
    <div id="my-expense-list"></div>
  </div>
</div>

<div class="panel" id="panel-feedback">
  <div class="card">
    <h3>ğŸ—£ æ´»å‹•å›é¥‹</h3>
    <div class="grid cols-2">
      <div>
        <label for="feedback-activity">æ´»å‹• *</label>
        <select id="feedback-activity"><option value="">è«‹é¸æ“‡æ´»å‹•</option></select>
      </div>
      <div>
        <label for="feedback-rating">è©•åˆ† *</label>
        <select id="feedback-rating">
          <option value="">è«‹é¸æ“‡</option>
          <option value="5">5 - éå¸¸æ»¿æ„</option>
          <option value="4">4 - æ»¿æ„</option>
          <option value="3">3 - æ™®é€š</option>
          <option value="2">2 - å¾…æ”¹é€²</option>
          <option value="1">1 - ä¸æ»¿æ„</option>
        </select>
      </div>
    </div>
    <div>
      <label for="feedback-comment">æ„è¦‹ / å»ºè­°</label>
      <textarea id="feedback-comment" placeholder="å¯æè¿°æ´»å‹•äº®é»ã€éœ€æ”¹é€²ä¹‹è™•..."></textarea>
    </div>
    <div class="actions">
      <button class="btn" id="btn-submit-feedback"><span class="text">æäº¤å›é¥‹</span></button>
    </div>
  </div>
  <div class="card">
    <h3>ğŸ—‚ æˆ‘çš„å›é¥‹ç´€éŒ„</h3>
    <div id="my-feedback-list"></div>
  </div>
</div>

<!-- ç®¡ç†é¢æ¿ -->
<div class="panel" id="panel-admin">
  <div class="subtabs" id="admin-subtabs">
    <div class="subtab-btn active" data-subtab="admin-members">æœƒå“¡</div>
    <div class="subtab-btn" data-subtab="admin-activities">æ´»å‹•</div>
    <div class="subtab-btn" data-subtab="admin-expenses">æ”¯å‡ºå¯©æ ¸</div>
    <div class="subtab-btn" data-subtab="admin-finance">è²¡å‹™ç¸½è¦½</div>
    <div class="subtab-btn" data-subtab="admin-board">ç†ç›£äº‹</div>
  </div>

  <!-- æœƒå“¡ç®¡ç† -->
  <div class="admin-subpanel" id="admin-members" style="display:block;">
    <div class="card">
      <h3>ğŸ‘¥ æœƒå“¡åˆ—è¡¨</h3>
      <div class="grid cols-3">
        <div>
          <label for="member-search">é—œéµå­—æœå°‹</label>
          <input id="member-search" type="text" placeholder="å§“å / LINE åç¨± / ID">
        </div>
        <div>
          <label for="member-filter-type">é¡åˆ¥ç¯©é¸</label>
            <select id="member-filter-type">
              <option value="">å…¨éƒ¨</option>
              <option value="patient">ç—…å‹</option>
              <option value="family">å®¶å±¬</option>
              <option value="volunteer">å¿—å·¥</option>
              <option value="medical">é†«è­·</option>
              <option value="supporter">æ”¯æŒè€…</option>
            </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn small" id="btn-refresh-members">é‡æ–°æ•´ç†</button>
        </div>
      </div>
      <div class="actions" style="margin-top:10px;">
        <button class="btn outline small" id="btn-export-members">åŒ¯å‡º CSV</button>
      </div>
      <div id="member-list" style="margin-top:16px;"></div>
    </div>
  </div>

  <!-- æ´»å‹•ç®¡ç† -->
  <div class="admin-subpanel" id="admin-activities" style="display:none;">
    <div class="card">
      <h3>ğŸ“… å»ºç«‹æ´»å‹•</h3>
      <div class="grid cols-3">
        <div>
          <label for="admin-activity-name">åç¨± *</label>
          <input id="admin-activity-name" type="text">
        </div>
        <div>
          <label for="admin-activity-date">æ—¥æœŸ *</label>
          <input id="admin-activity-date" type="datetime-local">
        </div>
        <div>
          <label for="admin-activity-location">åœ°é»</label>
          <input id="admin-activity-location" type="text">
        </div>
        <div>
          <label for="admin-activity-max">æœ€å¤§äººæ•¸</label>
          <input id="admin-activity-max" type="number" min="0">
        </div>
        <div>
          <label for="admin-activity-fee">è²»ç”¨</label>
          <input id="admin-activity-fee" type="number" min="0" value="0">
        </div>
        <div>
          <label for="admin-activity-desc">æè¿° *</label>
          <textarea id="admin-activity-desc" style="min-height:60px;"></textarea>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btn-create-activity"><span class="text">å»ºç«‹æ´»å‹•</span></button>
      </div>
    </div>
    <div class="card">
      <h3>ğŸ—‚ æ´»å‹•åˆ—è¡¨</h3>
      <div id="admin-activity-list"></div>
    </div>
  </div>

  <!-- æ”¯å‡ºå¯©æ ¸ -->
  <div class="admin-subpanel" id="admin-expenses" style="display:none;">
    <div class="card">
      <h3>ğŸ§¾ å¾…å¯©æ ¸æ”¯å‡º</h3>
      <div id="pending-expense-list"></div>
    </div>
  </div>

  <!-- è²¡å‹™ç¸½è¦½ -->
  <div class="admin-subpanel" id="admin-finance" style="display:none;">
    <div class="card">
      <h3>ğŸ’¹ è²¡å‹™æ¦‚è¦½</h3>
      <div id="finance-overview"></div>
    </div>
    <div class="card">
      <h3>ğŸ“‘ äº¤æ˜“ç´€éŒ„</h3>
      <div id="transaction-list"></div>
    </div>
    <div class="card">
      <h3>ğŸ—“ ç”¢ç”Ÿæœˆå ±è¡¨</h3>
      <div class="inline" style="flex-wrap:wrap;gap:12px;">
        <div>
          <label for="report-year">å¹´ä»½</label>
          <input id="report-year" type="number" min="2023" style="max-width:140px;">
        </div>
        <div>
          <label for="report-month">æœˆä»½</label>
          <input id="report-month" type="number" min="1" max="12" style="max-width:120px;">
        </div>
        <div style="align-self:flex-end;padding-bottom:4px;">
          <button class="btn small" id="btn-generate-report"><span class="text">ç”¢ç”Ÿ</span></button>
        </div>
      </div>
      <div id="report-result" style="margin-top:16px;"></div>
    </div>
  </div>

  <!-- ç†ç›£äº‹ -->
  <div class="admin-subpanel" id="admin-board" style="display:none;">
    <div class="card">
      <h3>ğŸ› å»ºç«‹æœƒè­°</h3>
      <div class="grid cols-3">
        <div>
          <label for="board-meeting-title">æ¨™é¡Œ *</label>
          <input id="board-meeting-title" type="text">
        </div>
        <div>
          <label for="board-meeting-date">æ—¥æœŸ *</label>
          <input id="board-meeting-date" type="datetime-local">
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn small" id="btn-create-board-meeting"><span class="text">å»ºç«‹</span></button>
        </div>
      </div>
    </div>
    <div class="card">
      <h3>ğŸ—‚ æœƒè­°åˆ—è¡¨</h3>
      <div id="board-meeting-list"></div>
    </div>
    <div class="card">
      <h3>ğŸ§¾ é¸å–æœƒè­°ç®¡ç†è­°ç¨‹ / æ±ºè­°</h3>
      <div class="inline" style="flex-wrap:wrap;gap:10px;">
        <select id="board-meeting-select"><option value="">é¸æ“‡æœƒè­°...</option></select>
        <button class="btn small" id="btn-refresh-agenda"><span class="text">è¼‰å…¥è­°ç¨‹</span></button>
        <button class="btn small" id="btn-lock-meeting"><span class="text">é–å®š/è§£é–</span></button>
      </div>
      <div style="margin-top:18px;">
        <h4 style="margin-top:0;">æ–°å¢è­°ç¨‹</h4>
        <div class="grid cols-3">
          <div>
            <label for="agenda-type">é¡å‹ *</label>
            <select id="agenda-type">
              <option value="general">ä¸€èˆ¬</option>
              <option value="proposal">ææ¡ˆ</option>
              <option value="case">æ¡ˆä»¶</option>
              <option value="motion">è‡¨æ™‚å‹•è­°</option>
            </select>
          </div>
          <div>
            <label for="agenda-title">æ¨™é¡Œ *</label>
            <input id="agenda-title" type="text">
          </div>
          <div>
            <label for="agenda-presenter">æå ±äºº</label>
            <input id="agenda-presenter" type="text">
          </div>
          <div style="grid-column:1/-1;">
            <label for="agenda-desc">èªªæ˜</label>
            <textarea id="agenda-desc" style="min-height:60px;"></textarea>
          </div>
        </div>
        <div class="actions">
          <button class="btn small" id="btn-add-agenda"><span class="text">æ–°å¢è­°ç¨‹</span></button>
        </div>
      </div>
      <div style="margin-top:24px;">
        <h4>è­°ç¨‹æ¸…å–®</h4>
        <div id="agenda-list"></div>
      </div>
      <div style="margin-top:24px;">
        <h4>è¨˜éŒ„æ±ºè­° (è«‹é¸è­°ç¨‹)</h4>
        <div class="grid cols-4">
          <div>
            <label for="decision-agenda-id">è­°ç¨‹ID *</label>
            <input id="decision-agenda-id" type="text" placeholder="é»é¸è­°ç¨‹è‡ªå‹•å¡«å…¥" readonly>
          </div>
          <div>
            <label for="decision-result">çµæœ *</label>
            <input id="decision-result" type="text" placeholder="ä¾‹å¦‚ï¼šé€šé / å¦æ±º / å»¶æœŸ">
          </div>
          <div>
            <label for="decision-vote-for">è´Šæˆ</label>
            <input id="decision-vote-for" type="number" min="0" value="0">
          </div>
          <div>
            <label for="decision-vote-against">åå°</label>
            <input id="decision-vote-against" type="number" min="0" value="0">
          </div>
          <div>
            <label for="decision-vote-abstain">æ£„æ¬Š</label>
            <input id="decision-vote-abstain" type="number" min="0" value="0">
          </div>
          <div style="grid-column:1/-1;">
            <label for="decision-notes">å‚™è¨»</label>
            <textarea id="decision-notes" style="min-height:60px;"></textarea>
          </div>
        </div>
        <div class="actions">
          <button class="btn small" id="btn-record-decision"><span class="text">è¨˜éŒ„æ±ºè­°</span></button>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  Parkinson Association System v2.4 Â· Powered by Google Apps Script & LIFF
</footer>

<!-- é€šçŸ¥ -->
<div class="notification" id="notification">
  <div id="notification-text">è¨Šæ¯</div>
  <button id="notification-close" aria-label="é—œé–‰é€šçŸ¥">Ã—</button>
</div>

<script>
/* ===================== å‰ç«¯è¨­å®š ===================== */
const APP = {
  LIFF_ID: '1656516134-VaGgmaPm',
  API_URL: 'https://script.google.com/macros/s/AKfycbyCexHu1MtWzi2pZS9SknKh_ZnCWJmuWKdTTqwQcySB8NEcUKdafRggXUONzwppLTZN3Q/exec',   // ä¾‹å¦‚ï¼šhttps://script.google.com/macros/s/XXXX/exec
  API_KEY: 'AAbb8520258185202581',
  PAGE_SIZE_ACTIVITIES: 6
};

let STATE = {
  lineId: '',
  lineName: '',
  isAdmin: false,
  activities: [],
  myRegistrations: [],
  donations: [],
  expenses: [],
  myFeedback: [],
  currentActivitiesPage: 1,
  filteredActivities: [],
  meetings: [],
  agenda: [],
  meetingLockedMap: {}
};

function showNotification(msg, type='info', timeout=3200){
  const box = document.getElementById('notification');
  box.className = 'notification ' + (type==='error'?'error': type==='success'?'success': type==='warn'?'warn':'');
  document.getElementById('notification-text').textContent = msg;
  requestAnimationFrame(()=> box.classList.add('show'));
  if (timeout){
    setTimeout(()=> box.classList.remove('show'), timeout);
  }
}

document.getElementById('notification-close').addEventListener('click',()=>{
  document.getElementById('notification').classList.remove('show');
});

async function api(action, payload={}){
  const body = Object.assign({}, payload, {
    action,
    apiKey: APP.API_KEY
  });
  try{
    const res = await fetch(APP.API_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    const json = await res.json();
    if (!json.success){
      throw new Error(json.message || 'æ“ä½œå¤±æ•—');
    }
    return json.data;
  }catch(e){
    showNotification(e.message || 'é€£ç·šéŒ¯èª¤','error');
    throw e;
  }
}

function qs(id){ return document.getElementById(id); }
function fmtDate(d){
  if(!d) return '';
  try {
    const dt = new Date(d);
    if (isNaN(dt.getTime())) return d;
    return dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0') + '-' + String(dt.getDate()).padStart(2,'0')
      + ' ' + String(dt.getHours()).padStart(2,'0') + ':' + String(dt.getMinutes()).padStart(2,'0');
  }catch(_){ return d; }
}

/* ===================== åˆå§‹åŒ– LIFF ===================== */
async function init(){
  try{
    if (typeof liff !== 'undefined'){
      await liff.init({ liffId: APP.LIFF_ID });
      if (!liff.isLoggedIn()){
        liff.login();
        return;
      }
      const profile = await liff.getProfile();
      STATE.lineId = profile.userId;
      STATE.lineName = profile.displayName;
    }else{
      // é LIFF æ¸¬è©¦æ¨¡å¼
      STATE.lineId = 'TEST_LINE_ID';
      STATE.lineName = 'æ¸¬è©¦ç”¨æˆ¶';
    }
    await ensureUser();
    await loadAllInitial();
    bindEvents();
  }catch(e){
    console.error(e);
    showNotification('åˆå§‹åŒ–å¤±æ•—ï¼š' + e.message,'error',6000);
  }
}

async function ensureUser(){
  await api('createUserIfNotExist',{ lineId: STATE.lineId, lineName: STATE.lineName });
  const info = await api('getUserInfo',{ lineId: STATE.lineId });
  renderUserInfo(info);
  STATE.isAdmin = !!info.isAdmin;
  if (STATE.isAdmin){
    document.querySelectorAll('.admin-only').forEach(el=> el.classList.remove('hidden'));
    const adminTab = document.querySelector('.tab-btn[data-tab="admin"]');
    if (adminTab) adminTab.classList.remove('hidden');
  }
}

function renderUserInfo(u){
  const box = qs('user-details');
  box.innerHTML = `
    <div style="font-size:1rem;font-weight:600;">${u.realName || '(æœªå¡«å§“å)'} <span class="badge ${u.status==='å·²è¨»å†Š'?'green':'orange'}">${u.status||''}</span></div>
    <div style="margin-top:6px;font-size:.85rem;color:var(--text-light);">LINEï¼š${u.lineName||''} (${u.lineId})</div>
    <div style="margin-top:6px;font-size:.8rem;">
      æœƒå“¡é¡åˆ¥ï¼š${u.memberType||'-'}ã€€
      æœ€è¿‘äº’å‹•ï¼š${fmtDate(u.lastActive)}ã€€
      è¨Šæ¯æ¬¡æ•¸ï¼š${u.messageCount||0}ã€€
      ç®¡ç†å“¡ï¼š${u.isAdmin?'æ˜¯':'å¦'}
    </div>
  `;
}

/* ===================== è¼‰å…¥è³‡æ–™ ===================== */
async function loadAllInitial(){
  await Promise.allSettled([
    loadActivities(),
    loadMyActivities(),
    loadDonations(),
    loadMyExpenses(),
    loadFeedback()
  ]);
  if (STATE.isAdmin){
    await Promise.allSettled([
      loadMembers(),
      loadPendingExpenses(),
      loadFinanceOverview(),
      loadTransactions(),
      loadMeetings()
    ]);
  }
}

/* ===== æ´»å‹• ===== */
async function loadActivities(){
  const list = await api('getActivities',{});
  STATE.activities = list || [];
  STATE.filteredActivities = [...STATE.activities];
  renderActivities();
  qs('stat-activity-total').textContent = STATE.activities.length;
  // å¡«å…¥å›é¥‹æ´»å‹•ä¸‹æ‹‰
  const sel = qs('feedback-activity');
  sel.innerHTML = '<option value="">è«‹é¸æ“‡æ´»å‹•</option>' + STATE.activities.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
}

function renderActivities(){
  const pageSize = APP.PAGE_SIZE_ACTIVITIES;
  const totalPages = Math.max(1, Math.ceil(STATE.filteredActivities.length / pageSize));
  if (STATE.currentActivitiesPage > totalPages) STATE.currentActivitiesPage = totalPages;
  const start = (STATE.currentActivitiesPage - 1)*pageSize;
  const pageData = STATE.filteredActivities.slice(start,start+pageSize);
  const box = qs('activity-list');
  if (!pageData.length){
    box.innerHTML = '<div class="empty"><div class="icon">ğŸ—“</div>ç›®å‰æ²’æœ‰å¯å ±åæ´»å‹•</div>';
  }else{
    box.innerHTML = pageData.map(a=>{
      const full = a.maxParticipants && Number(a.currentParticipants) >= Number(a.maxParticipants);
      return `<div class="list-item ${full?'full':''}">
        <h4>${a.name}</h4>
        <div class="meta">
          <span>æ—¥æœŸï¼š${fmtDate(a.date)}</span>
          <span>åœ°é»ï¼š${a.location||'-'}</span>
          <span>è²»ç”¨ï¼š${a.fee||0}</span>
          <span>äººæ•¸ï¼š${a.currentParticipants||0}/${a.maxParticipants||'âˆ'}</span>
        </div>
        <div style="margin-top:8px;font-size:.85rem;color:var(--text-light);">${a.description||''}</div>
        <div class="actions" style="margin-top:10px;">
          <button class="btn small" data-act-register="${a.id}" ${full?'disabled':''}>å ±å</button>
        </div>
      </div>`;
    }).join('');
  }
  const pag = qs('activity-pagination');
  pag.innerHTML = '';
  for (let i=1;i<=totalPages;i++){
    const btn = document.createElement('button');
    btn.textContent = i;
    if (i===STATE.currentActivitiesPage) btn.classList.add('active');
    btn.addEventListener('click', ()=>{ STATE.currentActivitiesPage=i; renderActivities(); });
    pag.appendChild(btn);
  }
}

async function loadMyActivities(){
  const list = await api('getUserActivities',{ lineId: STATE.lineId });
  STATE.myRegistrations = list||[];
  qs('stat-my-registrations').textContent = STATE.myRegistrations.length;
  renderMyRegistrations();
}
function renderMyRegistrations(){
  const box = qs('my-activity-list');
  if (!STATE.myRegistrations.length){
    box.innerHTML = '<div class="empty"><div class="icon">ğŸ§¾</div>å°šæœªå ±åä»»ä½•æ´»å‹•</div>';
    return;
  }
  box.innerHTML = STATE.myRegistrations.map(r=>`
    <div class="list-item">
      <h4>${r.activityName||'(æ´»å‹•å·²åˆªé™¤)'} <span class="badge ${r.status==='å·²å ±å'?'green': 'red'}">${r.status}</span></h4>
      <div class="meta">
        <span>æ—¥æœŸï¼š${fmtDate(r.date)}</span>
        <span>åƒåŠ è€…ï¼š${r.participantName}</span>
        <span>å ±åæ™‚é–“ï¼š${fmtDate(r.registerDate)}</span>
      </div>
      ${r.status==='å·²å ±å'? `<div class="actions" style="margin-top:8px;">
        <button class="btn danger small" data-act-cancel="${r.id}">å–æ¶ˆå ±å</button>
      </div>`:''}
    </div>
  `).join('');
}

/* ===== ææ¬¾ ===== */
async function loadDonations(){
  const list = await api('getDonations',{ lineId: STATE.lineId });
  STATE.donations = list||[];
  let total=0;
  STATE.donations.forEach(d=> total+= Number(d.amount||0));
  qs('stat-donation-count').textContent = STATE.donations.length;
  qs('stat-donation-total').textContent = total;
  renderDonations();
}
function renderDonations(){
  const box = qs('donation-list');
  if (!STATE.donations.length){
    box.innerHTML = '<div class="empty"><div class="icon">ğŸ’</div>å°šç„¡ææ¬¾ç´€éŒ„</div>';
    return;
  }
  box.innerHTML = STATE.donations.map(d=>`
    <div class="list-item">
      <h4>${d.donorName||'(åŒ¿å)'} <span class="badge green">+${d.amount}</span></h4>
      <div class="meta">
        <span>æ—¥æœŸï¼š${fmtDate(d.date)}</span>
      </div>
      <div style="font-size:.8rem;color:var(--text-light);margin-top:6px;">${d.notes||''}</div>
    </div>
  `).join('');
}

/* ===== æ”¯å‡º ===== */
async function loadMyExpenses(){
  const list = await api('getMyExpenses',{ lineId: STATE.lineId });
  STATE.expenses = list||[];
  renderMyExpenses();
}
function renderMyExpenses(){
  const box = qs('my-expense-list');
  if (!STATE.expenses.length){
    box.innerHTML = '<div class="empty"><div class="icon">ğŸ’¸</div>å°šç„¡æ”¯å‡ºç”³è«‹</div>';
    return;
  }
  box.innerHTML = STATE.expenses.map(e=>`
    <div class="list-item">
      <h4>${e.category} - ${e.amount} <span class="badge ${e.status==='å·²æ ¸å‡†'?'green': e.status==='å·²æ‹’çµ•'?'red':'orange'}">${e.status}</span></h4>
      <div class="meta">
        <span>æäº¤ï¼š${fmtDate(e.submitDate)}</span>
        ${e.approvedBy? `<span>å¯©æ ¸è€…ï¼š${e.approvedBy}</span>`:''}
        ${e.approvedDate? `<span>å¯©æ ¸æ™‚é–“ï¼š${fmtDate(e.approvedDate)}</span>`:''}
      </div>
      <div style="font-size:.8rem;color:var(--text-light);margin-top:6px;">${e.description||''}</div>
    </div>
  `).join('');
}

/* ===== å›é¥‹ ===== */
async function loadFeedback(){
  const list = await api('getMyFeedback',{ lineId: STATE.lineId });
  STATE.myFeedback = list||[];
  renderMyFeedback();
}
function renderMyFeedback(){
  const box = qs('my-feedback-list');
  if (!STATE.myFeedback.length){
    box.innerHTML = '<div class="empty"><div class="icon">ğŸ—£</div>å°šæœªæäº¤å›é¥‹</div>';
    return;
  }
  box.innerHTML = STATE.myFeedback.map(f=>`
    <div class="list-item">
      <h4>${f.activityName||'(æ´»å‹•å·²åˆªé™¤)'} - è©•åˆ† ${f.rating}</h4>
      <div class="meta">
        <span>æ™‚é–“ï¼š${fmtDate(f.submitDate)}</span>
      </div>
      <div style="margin-top:6px;font-size:.85rem;color:var(--text-light);">${f.comment||''}</div>
    </div>
  `).join('');
}

/* ===== æœƒå“¡ (Admin) ===== */
async function loadMembers(){
  const kw = qs('member-search').value.trim();
  const mt = qs('member-filter-type').value;
  const list = await api('getAllMembers',{
    operatorLineId: STATE.lineId,
    searchTerm: kw,
    memberType: mt
  });
  renderMembers(list||[]);
}
function renderMembers(list){
  const box = qs('member-list');
  if (!list.length){
    box.innerHTML = '<div class="empty"><div class="icon">ğŸ‘¥</div>æ²’æœ‰ç¬¦åˆçš„æœƒå“¡</div>';
    return;
  }
  box.innerHTML = list.map(m=>`
    <div class="list-item">
      <h4>${m.realName||'(æœªå¡«)'} ${m.isAdmin?'<span class="badge blue">ç®¡ç†å“¡</span>':''}</h4>
      <div class="meta">
        <span>é¡åˆ¥ï¼š${m.memberType||'-'}</span>
        <span>ç‹€æ…‹ï¼š${m.status||'-'}</span>
        <span>è¨Šæ¯ï¼š${m.messageCount||0}</span>
        <span>æœ€å¾Œï¼š${fmtDate(m.lastActive)}</span>
      </div>
      <div style="font-size:.75rem;color:var(--text-light);margin-top:6px;">
        LINEï¼š${m.lineName} (${m.lineId})<br>
        é›»è©±ï¼š${m.phone||'-'}ã€€Emailï¼š${m.email||'-'}
      </div>
      <div class="actions" style="margin-top:8px;">
        <button class="btn small" data-member-edit="${m.lineId}">ç·¨è¼¯</button>
      </div>
    </div>
  `).join('');
}

/* ===== å¾…å¯©æ ¸æ”¯å‡º ===== */
async function loadPendingExpenses(){
  const list = await api('getPendingExpenses',{ operatorLineId: STATE.lineId });
  renderPendingExpenses(list||[]);
}
function renderPendingExpenses(list){
  const box = qs('pending-expense-list');
  if (!list.length){
    box.innerHTML = '<div class="empty"><div class="icon">ğŸ§¾</div>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸æ”¯å‡º</div>';
    return;
  }
  box.innerHTML = list.map(e=>`
    <div class="list-item">
      <h4>${e.category} - ${e.amount}</h4>
      <div class="meta">
        <span>ç”³è«‹äººï¼š${e.applicantName||e.lineId}</span>
        <span>æäº¤ï¼š${fmtDate(e.submitDate)}</span>
        <span>IDï¼š${e.id}</span>
      </div>
      <div style="font-size:.8rem;color:var(--text-light);margin-top:6px;">${e.description||''}</div>
      <div class="actions" style="margin-top:8px;">
        <button class="btn small" data-exp-approve="${e.id}">æ ¸å‡†</button>
        <button class="btn danger small" data-exp-reject="${e.id}">æ‹’çµ•</button>
      </div>
    </div>
  `).join('');
}

/* ===== è²¡å‹™ ===== */
async function loadFinanceOverview(){
  const data = await api('getFinanceOverview',{ operatorLineId: STATE.lineId });
  qs('finance-overview').innerHTML = `
    <div class="grid cols-4" style="margin-bottom:14px;">
      <div class="stat"><div class="num">${data.totalIncome}</div><div class="label">ç¸½æ”¶å…¥</div></div>
      <div class="stat"><div class="num">${data.totalExpense}</div><div class="label">ç¸½æ”¯å‡º</div></div>
      <div class="stat"><div class="num">${data.balance}</div><div class="label">çµé¤˜</div></div>
      <div class="stat"><div class="num">${data.donationCount}</div><div class="label">ææ¬¾ç­†æ•¸</div></div>
    </div>
    <h4>æ”¯å‡ºåˆ†é¡</h4>
    <table>
      <thead><tr><th>åˆ†é¡</th><th>é‡‘é¡</th></tr></thead>
      <tbody>
        ${Object.keys(data.categoryBreakdown||{}).map(k=>`<tr><td>${k}</td><td>${data.categoryBreakdown[k]}</td></tr>`).join('')}
      </tbody>
    </table>
  `;
}
async function loadTransactions(){
  const list = await api('getTransactions',{ operatorLineId: STATE.lineId });
  const box = qs('transaction-list');
  if (!list.length){
    box.innerHTML = '<div class="empty"><div class="icon">ğŸ“‘</div>ç„¡äº¤æ˜“è³‡æ–™</div>';
    return;
  }
  box.innerHTML = list.map(t=>`
    <div class="list-item">
      <h4>${t.type==='income'?'æ”¶å…¥':'æ”¯å‡º'} ${t.amount}</h4>
      <div class="meta">
        <span>æ—¥æœŸï¼š${fmtDate(t.date)}</span>
        ${t.category?`<span>åˆ†é¡ï¼š${t.category}</span>`:''}
        ${t.donorName?`<span>ä¾†æºï¼š${t.donorName}</span>`:''}
      </div>
      <div style="font-size:.75rem;color:var(--text-light);margin-top:4px;">${t.notes||''}</div>
    </div>
  `).join('');
}

/* ===== æœˆå ±è¡¨ ===== */
async function generateReport(){
  const y = Number(qs('report-year').value);
  const m = Number(qs('report-month').value);
  if (!y || !m){
    showNotification('è«‹è¼¸å…¥å¹´ä»½èˆ‡æœˆä»½','warn');
    return;
  }
  const data = await api('generateReport',{
    operatorLineId: STATE.lineId,
    year: y,
    month: m
  });
  qs('report-result').innerHTML = `
    <div class="notice info">
      æœŸé–“ï¼š${data.period}<br>
      æ”¶å…¥ï¼š${data.totalIncome}ã€€æ”¯å‡ºï¼š${data.totalExpense}ã€€çµé¤˜ï¼š${data.balance}ã€€ææ¬¾ç­†æ•¸ï¼š${data.donationCount}
    </div>
    <h4>æ”¯å‡ºåˆ†é¡</h4>
    <ul style="margin:0;padding-left:20px;font-size:.85rem;">
      ${Object.keys(data.categoryBreakdown||{}).map(k=>`<li>${k}ï¼š${data.categoryBreakdown[k]}</li>`).join('')}
    </ul>
  `;
}

/* ===== ç†ç›£äº‹ï¼šæœƒè­° & è­°ç¨‹ ===== */
async function loadMeetings(){
  const list = await api('listBoardMeetings',{ operatorLineId: STATE.lineId });
  STATE.meetings = list||[];
  const sel = qs('board-meeting-select');
  sel.innerHTML = '<option value="">é¸æ“‡æœƒè­°...</option>' + STATE.meetings.map(m=>`<option value="${m.id}">${m.title} (${fmtDate(m.meetingDate)}) ${m.locked?'[é–å®š]':''}</option>`).join('');
  renderMeetingList();
}

function renderMeetingList(){
  const box = qs('board-meeting-list');
  if (!STATE.meetings.length){
    box.innerHTML = '<div class="empty"><div class="icon">ğŸ›</div>å°šç„¡æœƒè­°</div>';
    return;
  }
  box.innerHTML = STATE.meetings.map(m=>`
    <div class="list-item">
      <h4>${m.title} ${m.locked?'<span class="badge red">é–å®š</span>':''}</h4>
      <div class="meta">
        <span>æ—¥æœŸï¼š${fmtDate(m.meetingDate)}</span>
        <span>ç‹€æ…‹ï¼š${m.status}</span>
        <span>IDï¼š${m.id}</span>
      </div>
    </div>
  `).join('');
}

async function loadAgenda(){
  const meetingId = qs('board-meeting-select').value;
  if (!meetingId){
    showNotification('è«‹å…ˆé¸æ“‡æœƒè­°','warn');
    return;
  }
  const list = await api('listAgenda',{ operatorLineId: STATE.lineId, meetingId });
  STATE.agenda = list||[];
  renderAgenda();
}

function renderAgenda(){
  const box = qs('agenda-list');
  if (!STATE.agenda.length){
    box.innerHTML = '<div class="empty"><div class="icon">ğŸ—‚</div>ç„¡è­°ç¨‹</div>';
    return;
  }
  box.innerHTML = STATE.agenda.map(a=>`
    <div class="list-item" data-agenda-id="${a.id}" style="cursor:pointer;">
      <h4>${a.order}. ${a.title} <span class="badge ${a.status==='å®Œæˆ'?'green': 'orange'}">${a.status}</span></h4>
      <div class="meta">
        <span>IDï¼š${a.id}</span>
        <span>é¡å‹ï¼š${a.type}</span>
        <span>æå ±äººï¼š${a.presenter||'-'}</span>
        <span>æ›´æ–°ï¼š${fmtDate(a.lastUpdate)}</span>
      </div>
      <div style="font-size:.75rem;color:var(--text-light);margin-top:6px;">${a.description||''}</div>
      ${a.decisionText? `<div style="margin-top:6px;font-size:.75rem;color:var(--text-light);">æ±ºè­°ï¼š${a.decisionText}</div>`:''}
      <div class="actions" style="margin-top:6px;">
        <button class="btn small" data-agenda-status='${a.id}' data-status="å®Œæˆ">æ¨™è¨˜å®Œæˆ</button>
        <button class="btn warn small" data-agenda-status='${a.id}' data-status="è¨è«–ä¸­">è¨è«–ä¸­</button>
      </div>
    </div>
  `).join('');
}

/* ===================== äº‹ä»¶ç¶å®š ===================== */
function bindEvents(){

  // Tabs
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tab = btn.dataset.tab;
      document.querySelectorAll('.tab-btn').forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.panel').forEach(p=> p.classList.remove('active'));
      qs('panel-'+tab).classList.add('active');
    });
  });

  // Admin subtabs
  document.querySelectorAll('.subtab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.subtab-btn').forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.admin-subpanel').forEach(p=> p.style.display='none');
      qs(btn.dataset.subtab).style.display='block';
    });
  });

  // å­—ç´š / å°æ¯”
  qs('btn-font-up').addEventListener('click',()=>{
    if (document.body.classList.contains('font-xlarge')) return;
    else if (document.body.classList.contains('font-large')) document.body.classList.add('font-xlarge');
    else document.body.classList.add('font-large');
  });
  qs('btn-font-down').addEventListener('click',()=>{
    if (document.body.classList.contains('font-xlarge')) document.body.classList.remove('font-xlarge');
    else if (document.body.classList.contains('font-large')) document.body.classList.remove('font-large');
  });
  qs('btn-contrast').addEventListener('click',()=> document.body.classList.toggle('high-contrast'));
  qs('btn-reload').addEventListener('click',()=> loadAllInitial());

  // æœƒå“¡è¨»å†Š
  qs('btn-register').addEventListener('click', async ()=>{
    const realName = qs('realName').value.trim();
    const memberType = qs('memberType').value;
    if (!realName || !memberType){
      showNotification('è«‹å¡«å¿…å¡«æ¬„ä½','warn');
      return;
    }
    await api('register',{ lineId: STATE.lineId, realName, memberType });
    showNotification('å·²æ›´æ–°è¨»å†Šè³‡æ–™','success');
    await ensureUser();
  });
  qs('btn-update-contact').addEventListener('click', async ()=>{
    await api('updateUserContact',{
      targetLineId: STATE.lineId,
      phone: qs('phone').value.trim(),
      email: qs('email').value.trim(),
      address: qs('address').value.trim(),
      birthday: qs('birthday').value
    });
    showNotification('è¯çµ¡è³‡è¨Šå·²æ›´æ–°','success');
    await ensureUser();
  });

  // æ´»å‹•æœå°‹
  qs('activity-search').addEventListener('input',()=>{
    const kw = qs('activity-search').value.trim().toLowerCase();
    STATE.filteredActivities = STATE.activities.filter(a=>
      !kw || (a.name||'').toLowerCase().includes(kw) || (a.description||'').toLowerCase().includes(kw)
    );
    STATE.currentActivitiesPage = 1;
    renderActivities();
  });

  // æ´»å‹•åˆ—è¡¨äº‹ä»¶å§”æ´¾
  qs('activity-list').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act-register]');
    if (btn){
      const id = btn.getAttribute('data-act-register');
      const name = prompt('è«‹è¼¸å…¥åƒåŠ è€…å§“å', '');
      if (!name) return;
      await api('registerActivity',{ lineId: STATE.lineId, activityId: id, participantName: name });
      showNotification('å ±åæˆåŠŸ','success');
      await loadActivities();
      await loadMyActivities();
    }
  });

  // æˆ‘çš„å ±åå–æ¶ˆ
  qs('my-activity-list').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act-cancel]');
    if (btn){
      if (!confirm('ç¢ºå®šè¦å–æ¶ˆæ­¤å ±åï¼Ÿ')) return;
      const regId = btn.getAttribute('data-act-cancel');
      await api('cancelActivity',{ lineId: STATE.lineId, registrationId: regId });
      showNotification('å·²å–æ¶ˆ','success');
      await loadActivities();
      await loadMyActivities();
    }
  });

  // ææ¬¾
  qs('btn-add-donation').addEventListener('click', async ()=>{
    const amount = Number(qs('donation-amount').value);
    if (!amount || amount<=0){
      showNotification('é‡‘é¡éœ€å¤§æ–¼ 0','warn');
      return;
    }
    await api('addDonation',{
      lineId: STATE.lineId,
      amount,
      donorName: qs('donor-name').value.trim(),
      notes: qs('donation-notes').value.trim()
    });
    qs('donation-amount').value='';
    qs('donor-name').value='';
    qs('donation-notes').value='';
    showNotification('ææ¬¾å·²è¨˜éŒ„','success');
    await loadDonations();
  });

  // æ”¯å‡ºç”³è«‹
  qs('btn-submit-expense').addEventListener('click', async ()=>{
    const category = qs('expense-category').value;
    const amount = Number(qs('expense-amount').value);
    const desc = qs('expense-description').value.trim();
    if (!category || !amount || !desc){
      showNotification('è«‹å®Œæ•´å¡«å¯«æ”¯å‡ºæ¬„ä½','warn');
      return;
    }
    await api('submitExpense',{
      lineId: STATE.lineId,
      category,
      amount,
      description: desc
    });
    qs('expense-amount').value='';
    qs('expense-description').value='';
    showNotification('æ”¯å‡ºç”³è«‹å·²æäº¤','success');
    await loadMyExpenses();
    if (STATE.isAdmin) await loadPendingExpenses();
  });

  // å›é¥‹
  qs('btn-submit-feedback').addEventListener('click', async ()=>{
    const activityId = qs('feedback-activity').value;
    const rating = qs('feedback-rating').value;
    const comment = qs('feedback-comment').value.trim();
    if (!activityId || !rating){
      showNotification('è«‹é¸æ“‡æ´»å‹•ä¸¦è©•åˆ†','warn');
      return;
    }
    await api('submitFeedback',{ lineId: STATE.lineId, activityId, rating, comment });
    qs('feedback-activity').value='';
    qs('feedback-rating').value='';
    qs('feedback-comment').value='';
    showNotification('å›é¥‹å·²æäº¤','success');
    await loadFeedback();
  });

  /* ===== Admin ===== */

  // æœƒå“¡æœå°‹/åˆ·æ–°
  qs('btn-refresh-members').addEventListener('click',()=> loadMembers());
  qs('member-search').addEventListener('keydown', e=>{ if (e.key==='Enter') loadMembers(); });
  qs('member-filter-type').addEventListener('change',()=> loadMembers());
  qs('btn-export-members').addEventListener('click', async ()=>{
    const data = await api('exportMembers',{ operatorLineId: STATE.lineId });
    if (data && data.csv){
      const blob = new Blob([data.csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download='members.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      showNotification('åŒ¯å‡ºå®Œæˆ','success');
    }
  });

  // å¾…å¯©æ ¸æ”¯å‡ºæ ¸å‡†/æ‹’çµ•
  qs('pending-expense-list').addEventListener('click', async e=>{
    const approveBtn = e.target.closest('button[data-exp-approve]');
    const rejectBtn = e.target.closest('button[data-exp-reject]');
    if (approveBtn || rejectBtn){
      const id = (approveBtn||rejectBtn).getAttribute(approveBtn?'data-exp-approve':'data-exp-reject');
      const ok = approveBtn ? true : false;
      const notes = prompt('å¯©æ ¸å‚™è¨» (å¯ç•™ç©º)','');
      await api('approveExpense',{
        operatorLineId: STATE.lineId,
        expenseId: id,
        approved: ok,
        notes
      });
      showNotification('å·²å¯©æ ¸','success');
      await loadPendingExpenses();
      await loadMyExpenses();
      await loadFinanceOverview();
      await loadTransactions();
    }
  });

  // å»ºç«‹æ´»å‹•
  qs('btn-create-activity').addEventListener('click', async ()=>{
    const name = qs('admin-activity-name').value.trim();
    const date = qs('admin-activity-date').value;
    const desc = qs('admin-activity-desc').value.trim();
    if (!name || !date || !desc){
      showNotification('è«‹å®Œæ•´å¡«å¯«æ´»å‹•å¿…å¡«æ¬„ä½','warn');
      return;
    }
    await api('createActivity',{
      operatorLineId: STATE.lineId,
      name,
      description: desc,
      date,
      location: qs('admin-activity-location').value.trim(),
      maxParticipants: qs('admin-activity-max').value || '',
      fee: qs('admin-activity-fee').value || 0
    });
    ['admin-activity-name','admin-activity-date','admin-activity-location','admin-activity-max','admin-activity-fee','admin-activity-desc']
      .forEach(id=> qs(id).value='');
    showNotification('æ´»å‹•å»ºç«‹æˆåŠŸ','success');
    await loadActivities();
    await loadAdminActivities();
  });

  // æ´»å‹•ç®¡ç†åˆ—è¡¨
  async function loadAdminActivities(){
    const list = await api('getAllActivities',{ operatorLineId: STATE.lineId });
    const box = qs('admin-activity-list');
    if (!list.length){
      box.innerHTML = '<div class="empty"><div class="icon">ğŸ“…</div>ç„¡æ´»å‹•</div>';
      return;
    }
    box.innerHTML = list.map(a=>`
      <div class="list-item">
        <h4>${a.name} <span class="badge ${a.status==='é–‹æ”¾å ±å'?'green':'red'}">${a.status}</span></h4>
        <div class="meta">
          <span>IDï¼š${a.id}</span>
          <span>æ—¥æœŸï¼š${fmtDate(a.date)}</span>
          <span>äººæ•¸ï¼š${a.currentParticipants}/${a.maxParticipants||'âˆ'}</span>
        </div>
        <div style="font-size:.7rem;color:var(--text-light);margin-top:6px;">${a.description||''}</div>
        <div class="actions" style="margin-top:8px;">
          <button class="btn small" data-act-close="${a.id}">${a.status==='é–‹æ”¾å ±å'?'é—œé–‰':'é–‹æ”¾'}</button>
          <button class="btn warn small" data-act-delete="${a.id}">åˆªé™¤</button>
          <button class="btn secondary small" data-act-reg-list="${a.id}">å ±ååå–®</button>
        </div>
        <div class="registrations" id="reg-${a.id}" style="display:none;margin-top:10px;"></div>
      </div>
    `).join('');
  }
  loadAdminActivities();

  // æ´»å‹•ç®¡ç†æ“ä½œ
  qs('admin-activity-list').addEventListener('click', async e=>{
    const t = e.target;
    const closeBtn = t.closest('button[data-act-close]');
    const delBtn = t.closest('button[data-act-delete]');
    const regBtn = t.closest('button[data-act-reg-list]');
    if (closeBtn){
      const id = closeBtn.getAttribute('data-act-close');
      const newStatus = closeBtn.textContent==='é—œé–‰'?'å·²çµæŸ':'é–‹æ”¾å ±å';
      await api('changeActivityStatus',{ operatorLineId: STATE.lineId, activityId:id, status:newStatus });
      showNotification('ç‹€æ…‹å·²æ›´æ–°','success');
      await loadActivities();
      await loadAdminActivities();
    }else if (delBtn){
      const id = delBtn.getAttribute('data-act-delete');
      if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ´»å‹•ï¼Ÿ')) return;
      await api('deleteActivity',{ operatorLineId: STATE.lineId, activityId:id });
      showNotification('å·²åˆªé™¤','success');
      await loadActivities();
      await loadAdminActivities();
    }else if (regBtn){
      const id = regBtn.getAttribute('data-act-reg-list');
      const box = qs('reg-'+id);
      if (box.style.display==='none'){
        const list = await api('getActivityRegistrations',{ operatorLineId: STATE.lineId, activityId:id });
        if (!list.length){
          box.innerHTML = '<div class="empty" style="padding:20px;">ç„¡å ±å</div>';
        }else{
          box.innerHTML = list.map(r=>`
            <div style="font-size:.75rem;padding:6px 0;border-bottom:1px solid #e2e8f0;">
              <b>${r.participantName}</b> (${r.lineId})ã€€${fmtDate(r.registerDate)}ã€€<span class="badge ${r.status==='å·²å ±å'?'green':'red'}">${r.status}</span>
            </div>
          `).join('');
        }
        box.style.display='block';
      }else{
        box.style.display='none';
      }
    }
  });

  // ç”¢ç”Ÿå ±è¡¨
  qs('btn-generate-report').addEventListener('click', generateReport);

  // ç†ç›£äº‹ï¼šå»ºç«‹æœƒè­°
  qs('btn-create-board-meeting').addEventListener('click', async ()=>{
    const title = qs('board-meeting-title').value.trim();
    const date = qs('board-meeting-date').value;
    if (!title || !date){
      showNotification('è«‹å¡«æ¨™é¡Œèˆ‡æ—¥æœŸ','warn');
      return;
    }
    await api('createBoardMeeting',{ operatorLineId: STATE.lineId, title, meetingDate: date });
    qs('board-meeting-title').value='';
    qs('board-meeting-date').value='';
    showNotification('æœƒè­°å·²å»ºç«‹','success');
    await loadMeetings();
  });

  // è¼‰å…¥è­°ç¨‹
  qs('btn-refresh-agenda').addEventListener('click', loadAgenda);

  // é–å®š/è§£é–æœƒè­°
  qs('btn-lock-meeting').addEventListener('click', async ()=>{
    const meetingId = qs('board-meeting-select').value;
    if (!meetingId){ showNotification('è«‹å…ˆé¸æ“‡æœƒè­°','warn'); return; }
    // å…ˆæŸ¥åˆ—è¡¨æ‰¾ç•¶å‰é–å®šç‹€æ…‹
    const meeting = STATE.meetings.find(m=> m.id===meetingId);
    const newState = !(meeting && meeting.locked);
    await api('lockBoardMeeting',{ operatorLineId: STATE.lineId, meetingId, locked: newState });
    showNotification(newState?'å·²é–å®š':'å·²è§£é–','success');
    await loadMeetings();
    await loadAgenda();
  });

  // æ–°å¢è­°ç¨‹
  qs('btn-add-agenda').addEventListener('click', async ()=>{
    const meetingId = qs('board-meeting-select').value;
    if (!meetingId){ showNotification('è«‹å…ˆé¸æ“‡æœƒè­°','warn'); return; }
    const type = qs('agenda-type').value;
    const title = qs('agenda-title').value.trim();
    const presenter = qs('agenda-presenter').value.trim();
    const desc = qs('agenda-desc').value.trim();
    if (!type || !title){
      showNotification('è«‹å¡«å¯«è­°ç¨‹å¿…å¡«æ¬„ä½','warn');
      return;
    }
    await api('addAgendaItem',{
      operatorLineId: STATE.lineId,
      meetingId,
      type,
      title,
      presenter,
      description: desc
    });
    ['agenda-title','agenda-presenter','agenda-desc'].forEach(id=> qs(id).value='');
    showNotification('è­°ç¨‹å·²æ–°å¢','success');
    await loadAgenda();
  });

  // è­°ç¨‹ç‹€æ…‹æ›´æ–° / é»é¸å¡«å…¥æ±ºè­°è­°ç¨‹ID
  qs('agenda-list').addEventListener('click', async e=>{
    const statusBtn = e.target.closest('button[data-agenda-status]');
    const item = e.target.closest('.list-item[data-agenda-id]');
    if (statusBtn){
      const id = statusBtn.getAttribute('data-agenda-status');
      const status = statusBtn.getAttribute('data-status');
      await api('updateAgendaStatus',{ operatorLineId: STATE.lineId, agendaId: id, status });
      showNotification('ç‹€æ…‹å·²æ›´æ–°','success');
      await loadAgenda();
    }else if (item){
      const id = item.getAttribute('data-agenda-id');
      qs('decision-agenda-id').value = id;
      showNotification('å·²å¡«å…¥è­°ç¨‹ ID','info',1800);
    }
  });

  // è¨˜éŒ„æ±ºè­°
  qs('btn-record-decision').addEventListener('click', async ()=>{
    const meetingId = qs('board-meeting-select').value;
    const agendaId = qs('decision-agenda-id').value;
    const result = qs('decision-result').value.trim();
    if (!meetingId || !agendaId || !result){
      showNotification('è«‹å…ˆé¸æ“‡æœƒè­° / è­°ç¨‹ä¸¦è¼¸å…¥çµæœ','warn');
      return;
    }
    await api('recordDecision',{
      operatorLineId: STATE.lineId,
      meetingId,
      agendaId,
      result,
      voteFor: Number(qs('decision-vote-for').value)||0,
      voteAgainst: Number(qs('decision-vote-against').value)||0,
      voteAbstain: Number(qs('decision-vote-abstain').value)||0,
      notes: qs('decision-notes').value.trim()
    });
    ['decision-agenda-id','decision-result','decision-notes','decision-vote-for','decision-vote-against','decision-vote-abstain']
      .forEach(id=> qs(id).value = id.includes('vote') ? '0' : '');
    showNotification('æ±ºè­°å·²è¨˜éŒ„','success');
    await loadAgenda();
  });

}

/* ===================== å•Ÿå‹• ===================== */
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
