<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>帕金森病友會管理系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .navbar { background:linear-gradient(135deg,#00B900,#009700); }
    .navbar .nav-link, .navbar-brand { color:#fff !important; }
    .page { display:none; }
    .page.active { display:block; animation:fade .3s; }
    @keyframes fade { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
    .stats-card { background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 10px rgba(0,0,0,.05); }
    .stats-card h3 { margin:0;font-weight:600; }
    .badge-status { font-size:.75rem; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">帕金森病友會</a>
      <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="nav" class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="#" data-page="dashboard">首頁</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-page="profile">個人資料</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-page="activities">活動</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-page="volunteer">志工</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-page="finance">財務</a></li>
          <li class="nav-item d-none" id="adminNav"><a class="nav-link" href="#" data-page="admin">管理</a></li>
        </ul>
        <span class="navbar-text" id="navUser">載入中...</span>
      </div>
    </div>
  </nav>

  <div class="container py-3">
    <div id="alerts"></div>

    <div id="dashboard" class="page active">
      <h4 class="mb-3">儀表板</h4>
      <div class="row g-3">
        <div class="col-6 col-md-3">
          <div class="stats-card text-center">
            <h3 id="statActivities">0</h3>
            <small>開放活動</small>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stats-card text-center">
            <h3 id="statMyRegs">0</h3>
            <small>我的報名</small>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stats-card text-center">
            <h3 id="statVolHours">0</h3>
            <small>志工時數</small>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stats-card text-center">
            <h3 id="statDonations">0</h3>
            <small>捐款次數</small>
          </div>
        </div>
      </div>
      <hr>
      <h5>最新活動</h5>
      <div id="recentActivities">載入中...</div>
    </div>

    <div id="profile" class="page">
      <h4>個人資料</h4>
      <form id="profileForm" class="mt-3">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">LINE 名稱</label>
            <input type="text" id="lineName" class="form-control" disabled>
          </div>
          <div class="col-md-6">
            <label class="form-label">真實姓名 *</label>
            <input type="text" id="realName" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">電話</label>
            <input type="tel" id="phone" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="email" id="email" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">生日</label>
            <input type="date" id="birthday" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">會員類別</label>
            <select id="memberType" class="form-select">
              <option value="病友">病友</option>
              <option value="家屬">家屬</option>
              <option value="志工">志工</option>
              <option value="醫護">醫護人員</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">地址</label>
            <textarea id="address" class="form-control" rows="2"></textarea>
          </div>
          <div class="col-12">
            <button class="btn btn-primary">儲存</button>
          </div>
        </div>
      </form>
      <div class="mt-4">
        <h6>統計</h6>
        <ul class="list-group small" id="profileStats"></ul>
      </div>
    </div>

    <div id="activities" class="page">
      <h4>活動列表</h4>
      <div class="d-flex gap-2 my-2">
        <select id="filterStatus" class="form-select form-select-sm" style="max-width:150px;">
          <option value="">全部狀態</option>
          <option value="開放報名">開放報名</option>
          <option value="已結束">已結束</option>
        </select>
        <input type="date" id="filterDate" class="form-control form-control-sm" style="max-width:170px;">
        <input type="text" id="filterSearch" placeholder="搜尋..." class="form-control form-control-sm">
        <button class="btn btn-sm btn-outline-primary" id="btnFilterAct">篩選</button>
      </div>
      <div id="activityList">載入中...</div>
      <hr>
      <h5>我的報名</h5>
      <div id="myRegistrations">載入中...</div>
    </div>

    <div id="volunteer" class="page">
      <h4>志工服務</h4>
      <h6 class="mt-3">志工需求</h6>
      <div id="volNeeds">載入中...</div>
      <hr>
      <h6>我的志工紀錄</h6>
      <div id="volRecords">載入中...</div>
    </div>

    <div id="finance" class="page">
      <h4>財務</h4>
      <div class="mb-3">
        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#donationModal">新增捐款</button>
        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#expenseModal">申請支出</button>
      </div>
      <h6>我的捐款</h6>
      <div id="donationList">載入中...</div>
      <hr>
      <h6>我的支出</h6>
      <div id="expenseList">載入中...</div>
      <div id="financeOverview" class="mt-4 d-none">
        <h6>財務概覽（管理員）</h6>
        <div class="row g-3 text-center">
          <div class="col-6 col-md-3"><div class="stats-card"><h3 id="finIncome">0</h3><small>總收入</small></div></div>
          <div class="col-6 col-md-3"><div class="stats-card"><h3 id="finExpense">0</h3><small>總支出</small></div></div>
          <div class="col-6 col-md-3"><div class="stats-card"><h3 id="finBalance">0</h3><small>餘額</small></div></div>
          <div class="col-6 col-md-3"><div class="stats-card"><h3 id="finDonCount">0</h3><small>捐款筆數</small></div></div>
        </div>
      </div>
    </div>

    <div id="admin" class="page">
      <h4>管理功能（示意）</h4>
      <p class="text-muted">可延伸加入會員管理、活動維護、財務審核等。</p>
    </div>
  </div>

  <!-- 捐款 Modal -->
  <div class="modal fade" id="donationModal" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="donationForm">
        <div class="modal-header">
          <h5 class="modal-title">新增捐款</h5>
          <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">金額 *</label>
            <input type="number" min="1" id="donAmount" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">方式</label>
            <select id="donMethod" class="form-select">
              <option value="現金">現金</option>
              <option value="轉帳">轉帳</option>
              <option value="信用卡">信用卡</option>
              <option value="其他">其他</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">日期</label>
            <input type="date" id="donDate" class="form-control">
          </div>
          <div class="mb-2">
            <label class="form-label">備註</label>
            <textarea id="donNote" rows="2" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
          <button class="btn btn-primary" type="submit">送出</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 支出 Modal -->
  <div class="modal fade" id="expenseModal" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="expenseForm">
        <div class="modal-header">
          <h5 class="modal-title">支出申請</h5>
          <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
        </div>
          <div class="modal-body">
            <div class="mb-2">
              <label class="form-label">項目 *</label>
              <input type="text" id="expItem" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">金額 *</label>
              <input type="number" min="1" id="expAmount" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">類別</label>
              <select id="expCategory" class="form-select">
                <option value="活動費用">活動費用</option>
                <option value="交通費">交通費</option>
                <option value="餐飲費">餐飲費</option>
                <option value="設備費">設備費</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">支出日期</label>
              <input type="date" id="expDate" class="form-control">
            </div>
            <div class="mb-2">
              <label class="form-label">說明</label>
              <textarea id="expDesc" class="form-control" rows="2"></textarea>
            </div>
          </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
          <button class="btn btn-primary" type="submit">送出</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const LIFF_ID = '1656516134-VaGgmaPm';
    const API_URL = 'https://script.google.com/macros/s/AKfycbwIF9TSfD2d4NhTg0S-AfWuuwSLl0mZqUpI51rxYWvPdGhSZBbTE6gAo39Y040vd1hbeg/exec';
    const API_KEY = 'AAbb8520258185202581';

    let currentUser = null;

    function alertBox(msg,type='success',timeout=3000){
      const id='a'+Date.now();
      const html = \`<div id="\${id}" class="alert alert-\${type} py-2 small">\${msg}</div>\`;
      document.getElementById('alerts').insertAdjacentHTML('beforeend', html);
      if (timeout){
        setTimeout(()=>{ const el=document.getElementById(id); el && el.remove(); }, timeout);
      }
    }

    async function callAPI(action, payload={}){
      const body = { action, apiKey: API_KEY, ...payload };
      const res = await fetch(API_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(body)
      });
      const json = await res.json();
      if (!json.success) throw new Error(json.message||'失敗');
      return json.data;
    }

    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    async function initLIFF(){
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      const profile = await liff.getProfile();
      await callAPI('register',{
        lineId: profile.userId,
        lineName: profile.displayName,
        realName: profile.displayName
      });
      await loadProfile();
      await loadDashboard();
      bindNav();
      alertBox('載入完成','success',1500);
    }

    function bindNav(){
      document.querySelectorAll('[data-page]').forEach(a=>{
        a.addEventListener('click', async e=>{
          e.preventDefault();
          const page = a.getAttribute('data-page');
          showPage(page);
          switch(page){
            case 'dashboard': loadDashboard(); break;
            case 'profile': loadProfile(); break;
            case 'activities': loadActivities(); break;
            case 'volunteer': loadVolunteer(); break;
            case 'finance': loadFinance(); break;
          }
        });
      });
      document.getElementById('btnFilterAct').addEventListener('click', loadActivities);
      document.getElementById('profileForm').addEventListener('submit', submitProfile);
      document.getElementById('donationForm').addEventListener('submit', submitDonation);
      document.getElementById('expenseForm').addEventListener('submit', submitExpense);
    }

    async function loadProfile(){
      const profile = await liff.getProfile();
      const data = await callAPI('getProfile',{ lineId: profile.userId });
      currentUser = data;
      document.getElementById('navUser').textContent = (data.realName || data.lineName)+' ('+(data.memberType||'會員')+')';
      if (data.isAdmin) document.getElementById('adminNav').classList.remove('d-none');
      // 填表單
      lineName.value = data.lineName || '';
      realName.value = data.realName || '';
      phone.value = data.phone || '';
      email.value = data.email || '';
      birthday.value = data.birthday || '';
      memberType.value = data.memberType || '病友';
      address.value = data.address || '';
      // 統計
      const statsUl = document.getElementById('profileStats');
      statsUl.innerHTML = `
        <li class="list-group-item">狀態：${data.status||'-'}</li>
        <li class="list-group-item">註冊日期：${fmtDate(data.registerDate)}</li>
        <li class="list-group-item">志工時數：${data.volunteerHours||0}</li>
        <li class="list-group-item">參加活動次數：${data.activityCount||0}</li>
        <li class="list-group-item">最後活動：${fmtDate(data.lastActive)}</li>
      `;
    }

    async function submitProfile(e){
      e.preventDefault();
      const profile = await liff.getProfile();
      await callAPI('updateProfile',{
        lineId: profile.userId,
        realName: realName.value,
        phone: phone.value,
        email: email.value,
        birthday: birthday.value,
        memberType: memberType.value,
        address: address.value
      });
      alertBox('已更新個人資料');
      loadProfile();
    }

    async function loadDashboard(){
      const profile = await liff.getProfile();
      const [acts, regs, vols, dons] = await Promise.all([
        callAPI('getActivities',{}),
        callAPI('getMyRegistrations',{ lineId: profile.userId }),
        callAPI('getMyVolunteerRecords',{ lineId: profile.userId }),
        callAPI('getDonations',{ lineId: profile.userId })
      ]);
      statActivities.textContent = acts.filter(a=>a.status==='開放報名').length;
      statMyRegs.textContent = regs.filter(r=>r.status==='已報名').length;
      statVolHours.textContent = vols.filter(v=>v.status==='已核准').reduce((s,v)=>s+(v.hours||0),0);
      statDonations.textContent = dons.length;
      // 最新活動
      const recent = acts.slice(0,5).map(a=>
        `<div class="border-bottom py-2">
          <strong>${a.name}</strong>
          <div class="small text-muted">
            ${fmtDate(a.activityDate)} | ${a.location||''}
          </div>
        </div>`
      ).join('') || '<div class="text-muted small">目前無活動</div>';
      recentActivities.innerHTML = recent;
    }

    async function loadActivities(){
      const status = filterStatus.value;
      const date = filterDate.value;
      const search = filterSearch.value;
      const acts = await callAPI('getActivities',{ status, date, search });
      activityList.innerHTML = acts.length? acts.map(a=>{
        const full = a.maxParticipants && a.currentCount>=a.maxParticipants;
        return `
          <div class="card mb-2">
            <div class="card-body d-flex justify-content-between align-items-start">
              <div>
                <h6 class="mb-1">${a.name}</h6>
                <div class="small text-muted">${fmtDate(a.activityDate)} | ${a.location||'-'}</div>
                <div class="small">人數：${a.currentCount}/${a.maxParticipants||'∞'} 費用：$${a.fee||0}</div>
              </div>
              <div class="text-end">
                <span class="badge bg-${a.status==='開放報名'?'success':(a.status==='已結束'?'secondary':'warning')} badge-status">${a.status}</span><br>
                ${a.status==='開放報名' && !full ? `<button class="btn btn-sm btn-primary mt-2" onclick="regActivity('${a.id}')">報名</button>`: full?'<div class="text-danger small mt-2">額滿</div>':''}
              </div>
            </div>
          </div>`;
      }).join('') : '<div class="text-muted small">查無活動</div>';
      loadMyRegistrations();
    }

    async function regActivity(id){
      const profile = await liff.getProfile();
      try{
        await callAPI('registerActivity',{ lineId: profile.userId, activityId:id, participantName: currentUser.realName || currentUser.lineName });
        alertBox('報名成功');
        loadActivities();
      }catch(e){ alertBox(e.message,'danger'); }
    }

    async function loadMyRegistrations(){
      const profile = await liff.getProfile();
      const regs = await callAPI('getMyRegistrations',{ lineId: profile.userId });
      myRegistrations.innerHTML = regs.length ? `
        <table class="table table-sm table-striped">
          <thead><tr><th>活動</th><th>日期</th><th>狀態</th><th></th></tr></thead>
          <tbody>
            ${regs.map(r=>`
              <tr>
                <td>${r.activityName}</td>
                <td>${fmtDate(r.activityDate)}</td>
                <td><span class="badge bg-${r.status==='已報名'?'success':(r.status==='已取消'?'secondary':'warning')}">${r.status}</span></td>
                <td>${r.status==='已報名'?`<button class="btn btn-sm btn-outline-danger" onclick="cancelReg('${r.id}')">取消</button>`:''}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      ` : '<div class="text-muted small">尚未報名</div>';
    }

    async function cancelReg(id){
      if (!confirm('確定取消？')) return;
      const profile = await liff.getProfile();
      try{
        await callAPI('cancelActivity',{ lineId: profile.userId, registrationId: id });
        alertBox('已取消');
        loadActivities();
      }catch(e){ alertBox(e.message,'danger'); }
    }

    async function loadVolunteer(){
      const profile = await liff.getProfile();
      const [needs, recs] = await Promise.all([
        callAPI('getVolunteerNeeds',{}),
        callAPI('getMyVolunteerRecords',{ lineId: profile.userId })
      ]);
      volNeeds.innerHTML = needs.length ? needs.map(n=>`
        <div class="border-bottom py-2">
          <strong>${n.activityName}</strong> <span class="small text-muted">${fmtDate(n.activityDate)}</span><br>
          <small>${n.description||''}</small><br>
          <button class="btn btn-sm btn-outline-primary mt-1" onclick="volunteer('${n.activityId}')">我要服務</button>
        </div>
      `).join('') : '<div class="text-muted small">無志工需求</div>';

      volRecords.innerHTML = recs.length? `
        <table class="table table-sm">
          <thead><tr><th>活動</th><th>時數</th><th>狀態</th><th>日期</th></tr></thead>
          <tbody>
            ${recs.map(r=>`
              <tr>
                <td>${r.activityName}</td>
                <td>${r.hours}</td>
                <td>${r.status}</td>
                <td>${fmtDate(r.serviceDate)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>` : '<div class="text-muted small">尚無紀錄</div>';
    }

    async function volunteer(activityId){
      const hours = prompt('請輸入預估服務時數(可為小數)');
      if (!hours) return;
      const profile = await liff.getProfile();
      try{
        await callAPI('registerVolunteer',{ lineId: profile.userId, activityId, hours: parseFloat(hours) });
        alertBox('志工登記成功(待審核)');
        loadVolunteer();
      }catch(e){ alertBox(e.message,'danger'); }
    }

    async function loadFinance(){
      const profile = await liff.getProfile();
      const [dons, exps] = await Promise.all([
        callAPI('getDonations',{ lineId: profile.userId }),
        callAPI('getMyExpenses',{ lineId: profile.userId })
      ]);
      donationList.innerHTML = dons.length? `
        <table class="table table-sm">
          <thead><tr><th>日期</th><th>金額</th><th>方式</th><th>收據</th></tr></thead>
          <tbody>
            ${dons.map(d=>`
              <tr>
                <td>${fmtDate(d.donationDate)}</td>
                <td>${d.amount}</td>
                <td>${d.method}</td>
                <td>${d.receiptUrl? `<a href="${d.receiptUrl}" target="_blank">查看</a>`:'-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>` : '<div class="text-muted small">無捐款</div>';

      expenseList.innerHTML = exps.length? `
        <table class="table table-sm">
          <thead><tr><th>日期</th><th>項目</th><th>金額</th><th>狀態</th></tr></thead>
          <tbody>
            ${exps.map(e=>`
              <tr>
                <td>${fmtDate(e.submitDate)}</td>
                <td>${e.item||''}</td>
                <td>${e.amount}</td>
                <td>${e.status}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>` : '<div class="text-muted small">無支出申請</div>';

      if (currentUser && currentUser.isAdmin){
        const overview = await callAPI('getFinanceOverview',{ operatorLineId: profile.userId });
        finIncome.textContent = overview.totalIncome;
        finExpense.textContent = overview.totalExpense;
        finBalance.textContent = overview.balance;
        finDonCount.textContent = overview.donationCount;
        financeOverview.classList.remove('d-none');
      }
    }

    async function submitDonation(e){
      e.preventDefault();
      const profile = await liff.getProfile();
      try{
        await callAPI('addDonation',{
          lineId: profile.userId,
          amount: parseInt(donAmount.value),
          method: donMethod.value,
          donationDate: donDate.value,
          note: donNote.value
        });
        alertBox('捐款已記錄');
        document.getElementById('donationForm').reset();
        bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
        loadFinance();
      }catch(err){ alertBox(err.message,'danger'); }
    }

    async function submitExpense(e){
      e.preventDefault();
      const profile = await liff.getProfile();
      try{
        await callAPI('submitExpense',{
          lineId: profile.userId,
          item: expItem.value,
          amount: parseInt(expAmount.value),
          category: expCategory.value,
          description: expDesc.value,
          expenseDate: expDate.value
        });
        alertBox('支出申請已提交');
        document.getElementById('expenseForm').reset();
        bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
        loadFinance();
      }catch(err){ alertBox(err.message,'danger'); }
    }

    function fmtDate(d){
      if (!d) return '-';
      const dt = new Date(d);
      if (isNaN(dt)) return '-';
      return dt.getFullYear()+'/'+(dt.getMonth()+1).toString().padStart(2,'0')+'/'+dt.getDate().toString().padStart(2,'0');
    }

    window.addEventListener('load', ()=>{
      initLIFF().catch(err=>{
        console.error(err);
        alertBox('LIFF 初始化失敗: '+err.message,'danger',8000);
      });
    });
  </script>
</body>
</html>
