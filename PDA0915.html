<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>帕金森病友會管理系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- 若要使用 LINE LIFF，請在下面加上你自己的 LIFF SDK 與 LIFF ID -->
  <!-- <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script> -->
  <style>
    :root {
      --bg:#f6f7fb;
      --card:#ffffff;
      --primary:#2563eb;
      --primary-hover:#1d4ed8;
      --danger:#dc2626;
      --warn:#d97706;
      --success:#059669;
      --border:#e2e8f0;
      --text:#1f2937;
      --muted:#64748b;
      --radius:10px;
    }
    * { box-sizing:border-box; }
    body {
      margin:0; font-family:system-ui,-apple-system,"PingFang TC","Noto Sans TC",Arial;
      background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
    }
    header {
      background:var(--primary); color:#fff; padding:14px 18px; display:flex; align-items:center; gap:12px;
      position:sticky; top:0; z-index:50;
    }
    header h1 { font-size:18px; margin:0; flex:1; letter-spacing:.5px; }
    header .profile { display:flex; align-items:center; gap:8px; }
    header .profile img { width:36px; height:36px; border-radius:50%; object-fit:cover; }
    header button {
      background:#ffffff22; color:#fff; border:1px solid #ffffff55; padding:6px 12px;
      border-radius:6px; cursor:pointer; font-size:13px;
    }
    header button:hover { background:#ffffff33; }
    main { max-width:1180px; margin:16px auto 60px; padding:0 14px; }
    .tabs {
      display:flex; gap:6px; flex-wrap:wrap; margin-bottom:14px;
    }
    .tabs button {
      background:var(--card); border:1px solid var(--border); padding:10px 16px; cursor:pointer;
      border-radius: var(--radius); font-size:14px; font-weight:500; color:var(--muted);
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .tabs button.active {
      background:var(--primary); color:#fff; border-color:var(--primary);
      box-shadow:0 4px 12px -2px rgba(37,99,235,.4);
    }
    .grid {
      display:grid; gap:16px;
    }
    @media (min-width:900px){
      .grid.cols-2 { grid-template-columns:1fr 1fr; }
      .grid.cols-3 { grid-template-columns:repeat(3,1fr); }
    }
    .card {
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      padding:16px 18px; box-shadow:0 2px 4px rgba(0,0,0,.04);
      position:relative; overflow:hidden;
    }
    .card h2, .card h3 {
      margin:0 0 12px; font-size:16px; letter-spacing:.5px; display:flex; align-items:center; gap:6px;
    }
    .badge {
      display:inline-block; background:var(--primary); color:#fff; padding:2px 8px; border-radius:20px;
      font-size:12px; line-height:18px; vertical-align:middle;
    }
    .status {
      padding:2px 8px; font-size:12px; border-radius:14px; background:#e2e8f0; color:#334155;
      display:inline-block;
    }
    .status.open { background:#dbeafe; color:#1d4ed8; }
    .status.closed { background:#fee2e2; color:#b91c1c; }
    .status.draft { background:#fef9c3; color:#854d0e; }
    .status.done { background:#dcfce7; color:#166534; }
    form { display:flex; flex-direction:column; gap:10px; }
    label { font-size:13px; font-weight:600; color:var(--muted); display:flex; flex-direction:column; gap:4px; }
    input[type=text], input[type=number], input[type=date], input[type=datetime-local], select, textarea {
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:6px;
      background:#fff; font:inherit; resize:vertical; min-height:42px;
    }
    textarea { min-height:80px; }
    button.btn {
      background:var(--primary); border:none; color:#fff; padding:10px 18px; border-radius:6px;
      cursor:pointer; font-size:14px; display:inline-flex; align-items:center; gap:6px; font-weight:500;
    }
    button.btn:hover { background:var(--primary-hover); }
    button.btn.secondary {
      background:#fff; border:1px solid var(--border); color:var(--text);
    }
    button.btn.secondary:hover { background:#f1f5f9; }
    button.btn.danger { background:var(--danger); }
    button.btn.danger:hover { background:#b91c1c; }
    table {
      width:100%; border-collapse:collapse; font-size:13px;
    }
    table th, table td {
      text-align:left; padding:8px 10px; border-bottom:1px solid var(--border);
      vertical-align:top;
    }
    table th { background:#f1f5f9; font-weight:600; font-size:12px; text-transform:uppercase; letter-spacing:.5px; }
    table tr:last-child td { border-bottom:none; }
    .empty {
      text-align:center; padding:32px 12px; font-size:14px; color:var(--muted);
    }
    .toolbar {
      display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; align-items:center;
    }
    .flex { display:flex; }
    .gap-8 { gap:8px; }
    .gap-12 { gap:12px; }
    .w-100 { width:100%; }
    .mt-8 { margin-top:8px; }
    .mt-12 { margin-top:12px; }
    .mt-16 { margin-top:16px; }
    .mb-0 { margin-bottom:0; }
    .hidden { display:none !important; }
    .right { margin-left:auto; }
    .chip {
      background:#e2e8f0; padding:4px 10px; border-radius:20px; font-size:12px;
    }
    .flex-row { display:flex; flex-direction:row; }
    .flex-col { display:flex; flex-direction:column; }
    .justify-between { justify-content:space-between; }
    .align-center { align-items:center; }
    .scroll-x { overflow-x:auto; }
    .small { font-size:12px; line-height:1.4; color:var(--muted); }
    .note { font-size:12px; color:var(--muted); margin-top:4px; }
    .inline { display:inline; }
    .danger-text { color:var(--danger); }
    .success-text { color:var(--success); }
    .warn-text { color:var(--warn); }
    .loading-bar {
      position:fixed; top:0; left:0; height:3px; background:linear-gradient(90deg,var(--primary),#60a5fa);
      width:0%; z-index:200; transition:width .35s ease;
    }
    .toast-container {
      position:fixed; bottom:16px; right:16px; display:flex; flex-direction:column; gap:12px;
      z-index:300;
    }
    .toast {
      background:#1e293b; color:#fff; padding:12px 16px; border-radius:8px; font-size:14px;
      box-shadow:0 4px 14px -2px rgba(0,0,0,.4); animation:fadeIn .25s ease;
      max-width:320px; display:flex; gap:10px;
    }
    .toast.success { background:#166534; }
    .toast.error { background:#b91c1c; }
    .toast.warn { background:#92400e; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0);} }
    .code-block {
      background:#0f172a; color:#e2e8f0; font-family:ui-monospace,Consolas,monospace;
      font-size:12px; padding:10px 12px; border-radius:6px; overflow:auto; max-height:240px;
    }
    .filter-box {
      background:#fff; border:1px solid var(--border); padding:10px 12px; border-radius:6px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .pill-tabs { display:flex; gap:6px; flex-wrap:wrap; }
    .pill-tabs button {
      background:#fff; border:1px solid var(--border); padding:6px 12px; border-radius:999px;
      font-size:12px; cursor:pointer; color:var(--muted);
    }
    .pill-tabs button.active {
      background:var(--primary); color:#fff; border-color:var(--primary);
    }
    .footer {
      text-align:center; font-size:12px; padding:32px 0 64px; color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="loading-bar" id="globalLoading"></div>
  <header>
    <h1>帕金森病友會管理系統</h1>
    <div class="profile" id="profileBox">
      <!-- 由 JS 動態填入 -->
    </div>
    <button id="btnReload">重新整理</button>
  </header>
  <main>
    <div class="tabs" id="mainTabs"></div>
    <div id="viewContainer"></div>
    <div class="footer">前端版本 v2.5 (示例) ｜ 請勿在正式環境暴露 API Key</div>
  </main>
  <div class="toast-container" id="toastContainer"></div>

  <script type="module">
    /************************************************************
     * config.js
     ************************************************************/
    const CONFIG = {
      API_ENDPOINT: 'https://script.google.com/macros/s/你的DEPLOYMENT_ID/exec',
      API_KEY: 'AAbb8520258185202581',
      // 如果後端啟用 STRICT_SIGN=true，前端就無法安全計算 HMAC（除非放行端不使用密鑰或改成 server-side proxy）
      STRICT_SIGN: true,//false,
      // LIFF 使用（若需要）
      LIFF_ID: '1656516134-VaGgmaPm'',   // '200xxxxxxxxx-xxxxxxx' (可留空改用假資料)
      USE_LIFF: false,
      // 自動重新整理間隔 (毫秒) 針對部分列表
      AUTO_REFRESH_INTERVAL: 0
    };

    /************************************************************
     * state.js
     ************************************************************/
    const State = {
      profile: null,
      userInfo: null,
      isAdmin: false,
      activeTab: 'dashboard',
      tabs: [],
      cache: new Map(),
      lastFetch: {},
      setProfile(p) { this.profile = p; renderProfile(); },
      setUserInfo(u) {
        this.userInfo = u;
        this.isAdmin = !!(u && (u.isAdmin === true || u.isAdmin === '是' || u.isAdmin === 'TRUE'));
        buildTabs(); // 重新根據 admin 與否建構分頁
      }
    };

    /************************************************************
     * ui/toast.js
     ************************************************************/
    function showToast(message, type='info', timeout=3800) {
      const box = document.getElementById('toastContainer');
      const div = document.createElement('div');
      div.className = 'toast ' + (type==='success'?'success': type==='error'?'error': type==='warn'?'warn':'');
      div.textContent = message;
      box.appendChild(div);
      setTimeout(()=> {
        div.style.opacity=0;
        setTimeout(()=> div.remove(), 300);
      }, timeout);
    }

    /************************************************************
     * ui/loading.js
     ************************************************************/
    let activeLoadingCount = 0;
    function startLoading(){
      activeLoadingCount++;
      const bar = document.getElementById('globalLoading');
      bar.style.transition='none';
      requestAnimationFrame(()=>{
        bar.style.width='0%';
        bar.style.transition='width .35s ease';
        requestAnimationFrame(()=> bar.style.width='80%');
      });
    }
    function stopLoading(){
      activeLoadingCount = Math.max(0, activeLoadingCount-1);
      if (activeLoadingCount === 0){
        const bar = document.getElementById('globalLoading');
          bar.style.width='100%';
          setTimeout(()=> {
            bar.style.width='0%';
          }, 350);
      }
    }

    /************************************************************
     * api/core.js
     ************************************************************/
    async function callApi(action, payload = {}) {
      startLoading();
      try {
        const body = {
          action,
          apiKey: CONFIG.API_KEY,
          ...payload
        };
        if (CONFIG.STRICT_SIGN) {
          // 僅示例：前端不應放密鑰計算 HMAC，應改 server 轉發。此處純教學。
          body.ts = Date.now().toString();
          body.nonce = crypto.randomUUID().replace(/-/g,'').slice(0,12);
          // WARNING: 這裡如果用 API_KEY 產 HMAC 就等於把秘密公開。正式請在中繼伺服器做。
          body.sign = await hmacSHA256(`${body.action}|${body.ts}|${body.nonce}|${CONFIG.API_KEY}`, CONFIG.API_KEY);
        }
        const resp = await fetch(CONFIG.API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        let json;
        try { json = await resp.json(); }
        catch(e){ throw new Error('回傳非 JSON: ' + await resp.text()); }
        if (!json.success) {
          throw new Error(json.message || 'API失敗');
        }
        return json.data;
      } finally {
        stopLoading();
      }
    }

    async function hmacSHA256(message, secret){
      // 教學示例；實務將 secret 放前端不安全
      const enc = new TextEncoder();
      const key = await crypto.subtle.importKey(
        'raw', enc.encode(secret), {name:'HMAC', hash:'SHA-256'}, false, ['sign']
      );
      const signature = await crypto.subtle.sign('HMAC', key, enc.encode(message));
      const bytes = new Uint8Array(signature);
      return Array.from(bytes).map(b=>('0'+b.toString(16)).slice(-2)).join('');
    }

    /************************************************************
     * api/wrappers.js
     * （對後端 ACTION_ROUTER 的輕量封裝）
     ************************************************************/
    const API = {
      createUserIfNotExist: (lineId, lineName) => callApi('createUserIfNotExist',{ lineId, lineName }),
      getUserInfo: (lineId) => callApi('getUserInfo',{ lineId }),
      register: (lineId, realName, memberType) => callApi('register',{ lineId, realName, memberType }),

      // 活動
      getActivities: () => callApi('getActivities'),
      getUserActivities: (lineId) => callApi('getUserActivities',{ lineId }),
      registerActivity: (lineId, activityId, participantName) => callApi('registerActivity',{ lineId, activityId, participantName }),
      cancelActivity: (lineId, registrationId) => callApi('cancelActivity',{ lineId, registrationId }),
      createActivity: (operatorLineId, name, description, date, location, maxParticipants, fee) =>
        callApi('createActivity',{ operatorLineId, name, description, date, location, maxParticipants, fee }),
      getAllActivities: (operatorLineId) => callApi('getAllActivities',{ operatorLineId }),
      updateActivity: (operatorLineId, activityId, patch) => callApi('updateActivity',{ operatorLineId, activityId, ...patch }),
      changeActivityStatus: (operatorLineId, activityId, status) => callApi('changeActivityStatus',{ operatorLineId, activityId, status }),
      deleteActivity: (operatorLineId, activityId) => callApi('deleteActivity',{ operatorLineId, activityId }),
      getActivityRegistrations: (operatorLineId, activityId) => callApi('getActivityRegistrations',{ operatorLineId, activityId }),

      // 捐款 / 支出 / 財務
      addDonation: (lineId, amount, donorName, notes) => callApi('addDonation',{ lineId, amount, donorName, notes }),
      getDonations: (lineId) => callApi('getDonations',{ lineId }),
      submitExpense: (lineId, category, amount, description) => callApi('submitExpense',{ lineId, category, amount, description }),
      getMyExpenses: (lineId) => callApi('getMyExpenses',{ lineId }),
      approveExpense: (operatorLineId, expenseId, approved, notes) => callApi('approveExpense',{ operatorLineId, expenseId, approved, notes }),
      getPendingExpenses: (operatorLineId) => callApi('getPendingExpenses',{ operatorLineId }),
      getFinanceOverview: (operatorLineId) => callApi('getFinanceOverview',{ operatorLineId }),
      getTransactions: (operatorLineId) => callApi('getTransactions',{ operatorLineId }),
      getAccounts: (operatorLineId) => callApi('getAccounts',{ operatorLineId }),
      getBudgetStatus: (operatorLineId) => callApi('getBudgetStatus',{ operatorLineId }),

      // 回饋
      submitFeedback: (lineId, activityId, rating, comment) => callApi('submitFeedback',{ lineId, activityId, rating, comment }),
      getMyFeedback: (lineId) => callApi('getMyFeedback',{ lineId }),

      // 會員
      getAllMembers: (operatorLineId, searchTerm, memberType) => callApi('getAllMembers',{ operatorLineId, searchTerm, memberType }),
      updateMember: (operatorLineId, targetLineId, patch) => callApi('updateMember',{ operatorLineId, targetLineId, ...patch }),
      exportMembers: (operatorLineId) => callApi('exportMembers',{ operatorLineId }),
      searchMembers: (operatorLineId, searchTerm, memberType) => callApi('searchMembers',{ operatorLineId, searchTerm, memberType }),

      // 統計 / 報表
      getSystemStats: (operatorLineId) => callApi('getSystemStats',{ operatorLineId }),
      generateReport: (operatorLineId, year, month) => callApi('generateReport',{ operatorLineId, year, month }),

      // 理監事：會議
      createBoardMeeting: (operatorLineId, title, meetingDate) => callApi('createBoardMeeting',{ operatorLineId, title, meetingDate }),
      listBoardMeetings: (operatorLineId, status) => callApi('listBoardMeetings',{ operatorLineId, status }),
      updateBoardMeeting: (operatorLineId, meetingId, patch) => callApi('updateBoardMeeting',{ operatorLineId, meetingId, ...patch }),
      finalizeBoardMeeting: (operatorLineId, meetingId, finalMinutesText) => callApi('finalizeBoardMeeting',{ operatorLineId, meetingId, finalMinutesText }),
      lockBoardMeeting: (operatorLineId, meetingId, locked) => callApi('lockBoardMeeting',{ operatorLineId, meetingId, locked }),

      // 議程
      addAgendaItem: (operatorLineId, meetingId, type, refId, title, description, presenter) =>
        callApi('addAgendaItem',{ operatorLineId, meetingId, type, refId, title, description, presenter }),
      listAgenda: (operatorLineId, meetingId) => callApi('listAgenda',{ operatorLineId, meetingId }),
      updateAgendaStatus: (operatorLineId, agendaId, status, decisionText) =>
        callApi('updateAgendaStatus',{ operatorLineId, agendaId, status, decisionText }),
      recordDecision: (operatorLineId, meetingId, agendaId, result, voteFor, voteAgainst, voteAbstain, notes) =>
        callApi('recordDecision',{ operatorLineId, meetingId, agendaId, result, voteFor, voteAgainst, voteAbstain, notes }),

      // 出席
      checkInMeeting: (lineId, meetingId, role) => callApi('checkInMeeting',{ lineId, meetingId, role }),
      listAttendance: (operatorLineId, meetingId) => callApi('listAttendance',{ operatorLineId, meetingId }),

      // 提案
      submitProposal: (lineId, title, content, category) => callApi('submitProposal',{ lineId, title, content, category }),
      listProposals: (operatorLineId, lineId, status) => callApi('listProposals',{ operatorLineId, lineId, status }),
      reviewProposal: (operatorLineId, proposalId, approve, comment) => callApi('reviewProposal',{ operatorLineId, proposalId, approve, comment }),
      linkProposalToMeeting: (operatorLineId, proposalId, meetingId) => callApi('linkProposalToMeeting',{ operatorLineId, proposalId, meetingId }),

      // 案件
      submitCase: (lineId, title, summary, type) => callApi('submitCase',{ lineId, title, summary, type }),
      listCases: (operatorLineId, status) => callApi('listCases',{ operatorLineId, status }),
      reviewCase: (operatorLineId, caseId, decision, comment) => callApi('reviewCase',{ operatorLineId, caseId, decision, comment }),
      linkCaseToMeeting: (operatorLineId, caseId, meetingId) => callApi('linkCaseToMeeting',{ operatorLineId, caseId, meetingId }),

      // 臨時動議
      submitMotion: (lineId, title, reason, meetingId) => callApi('submitMotion',{ lineId, title, reason, meetingId }),
      listMotions: (operatorLineId, meetingId, status) => callApi('listMotions',{ operatorLineId, meetingId, status }),
      decideMotion: (operatorLineId, motionId, status, decisionText) => callApi('decideMotion',{ operatorLineId, motionId, status, decisionText })
    };

    /************************************************************
     * 初始化：LIFF / 模擬 Profile
     ************************************************************/
    async function initApp(){
      try{
        if (CONFIG.USE_LIFF && CONFIG.LIFF_ID) {
          await liff.init({ liffId: CONFIG.LIFF_ID });
          if (!liff.isLoggedIn()) liff.login();
          const pf = await liff.getProfile();
          State.setProfile({
            lineId: pf.userId,
            displayName: pf.displayName,
            pictureUrl: pf.pictureUrl
          });
        } else {
          // 模擬
          State.setProfile({
            lineId: 'U-DEMO-USER-001',
            displayName: '測試使用者',
            pictureUrl: 'https://placekitten.com/200/200'
          });
        }
        // 建立/同步使用者
        await API.createUserIfNotExist(State.profile.lineId, State.profile.displayName);
        const info = await API.getUserInfo(State.profile.lineId);
        State.setUserInfo(info);
        setActiveTab('dashboard');
      } catch(e){
        console.error(e);
        showToast('初始化失敗: ' + e.message,'error');
      }
    }

    /************************************************************
     * 分頁 (Tabs)
     ************************************************************/
    function buildTabs(){
      const base = [
        { id:'dashboard', label:'總覽' },
        { id:'myActivities', label:'活動' },
        { id:'myDonations', label:'捐款' },
        { id:'myExpenses', label:'支出' },
        { id:'myFeedback', label:'回饋' },
        { id:'myBoard', label:'理監事' } // 若非 admin 顯示精簡版
      ];
      if (State.isAdmin){
        base.push({ id:'adminMembers', label:'會員管理' });
        base.push({ id:'adminActivities', label:'活動管理' });
        base.push({ id:'finance', label:'財務' });
        base.push({ id:'boardAdmin', label:'理監事管理' });
      }
      State.tabs = base;
      renderTabs();
    }

    function renderTabs(){
      const wrap = document.getElementById('mainTabs');
      wrap.innerHTML='';
      State.tabs.forEach(t=>{
        const btn=document.createElement('button');
        btn.textContent=t.label;
        btn.className = (State.activeTab===t.id?'active':'');
        btn.onclick=()=> setActiveTab(t.id);
        wrap.appendChild(btn);
      });
    }

    function setActiveTab(id){
      State.activeTab=id;
      renderTabs();
      renderView();
    }

    /************************************************************
     * 視圖容器
     ************************************************************/
    function renderView(){
      const el = document.getElementById('viewContainer');
      switch(State.activeTab){
        case 'dashboard': return renderDashboard(el);
        case 'myActivities': return renderMyActivities(el);
        case 'myDonations': return renderMyDonations(el);
          case 'myExpenses': return renderMyExpenses(el);
        case 'myFeedback': return renderMyFeedback(el);
        case 'myBoard': return renderMyBoard(el);
        case 'adminMembers': return renderAdminMembers(el);
        case 'adminActivities': return renderAdminActivities(el);
        case 'finance': return renderFinance(el);
        case 'boardAdmin': return renderBoardAdmin(el);
        default:
          el.innerHTML='<div class="card">未知的分頁</div>';
      }
    }

    /************************************************************
     * 共用小工具
     ************************************************************/
    function fmtDate(d){
      if (!d) return '';
      try {
        const dt = new Date(d);
        if (isNaN(dt)) return d;
        return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0');
      }catch(e){ return d; }
    }
    function esc(str){
      if (str===null || str===undefined) return '';
      return String(str).replace(/[&<>"']/g, c=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[c]);
    }
    function renderProfile(){
      const box=document.getElementById('profileBox');
      if (!State.profile) {
        box.innerHTML='<span>未登入</span>';
        return;
      }
      box.innerHTML = `
        <img src="${esc(State.profile.pictureUrl||'')}" alt="pf"/>
        <div style="display:flex; flex-direction:column;">
          <strong style="font-size:13px">${esc(State.profile.displayName)}</strong>
          <span style="font-size:11px; color:#e2e8f0;">${State.isAdmin?'管理員':'一般會員'}</span>
        </div>
      `;
    }

    /************************************************************
     * 視圖：Dashboard
     ************************************************************/
    async function renderDashboard(root){
      root.innerHTML = '<div class="card"><h2>載入中...</h2></div>';
      try{
        let stats=null;
        if (State.isAdmin){
          stats = await API.getSystemStats(State.profile.lineId);
        }
        const user= State.userInfo;
        root.innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <h2>個人資訊</h2>
              <p><strong>LINE名稱：</strong>${esc(user.lineName||'')}</p>
              <p><strong>真實姓名：</strong>${esc(user.realName||'(未填)')}</p>
              <p><strong>會員類別：</strong>${esc(user.memberType||'(未填)')}</p>
              <p><strong>狀態：</strong><span class="status ${user.status==='已註冊'?'open':'closed'}">${esc(user.status||'')}</span></p>
              <button class="btn mt-12" id="btnEditProfile">更新基本資料</button>
            </div>
            <div class="card">
              <h2>快速操作</h2>
              <div class="pill-tabs" id="quickOps"></div>
              <div id="quickArea" class="mt-12 small muted"></div>
            </div>
            <div class="card">
              <h2>活動概況</h2>
              <div id="dashActivities">讀取中...</div>
            </div>
            <div class="card">
              <h2>我的捐款</h2>
              <div id="dashDonations">讀取中...</div>
            </div>
            ${State.isAdmin ? `
            <div class="card">
              <h2>系統統計</h2>
              ${stats?`
                <p>會員總數：${stats.totalMembers}</p>
                <p>已註冊會員：${stats.registeredMembers}</p>
                <p>開放報名活動：${stats.activeActivities}</p>
                <p>有效報名總數：${stats.totalRegistrations}</p>
              `:'<p>無法取得統計</p>'}
            </div>
            <div class="card">
              <h2>管理提醒</h2>
              <ul style="margin:0; padding-left:16px; font-size:13px; line-height:1.6;">
                <li>活動報名人數是否超過？</li>
                <li>待審核支出是否處理？</li>
                <li>理監事會議議程是否補齊？</li>
              </ul>
            </div>
            `:''}
          </div>
        `;
        bindDashboard();
        loadDashboardSubsections();
      }catch(e){
        root.innerHTML = '<div class="card"><h2>載入失敗</h2><p>'+esc(e.message)+'</p></div>';
      }
    }

    function bindDashboard(){
      document.getElementById('btnEditProfile').onclick = ()=> openEditProfileDialog();
      const ops = [
        { id:'regActivity', label:'報名活動', tip:'瀏覽開放中的活動並快速報名' },
        { id:'donate', label:'捐款', tip:'快速新增一筆捐款記錄' },
        { id:'expense', label:'支出申請', tip:'提出一個支出申請' },
        { id:'feedback', label:'活動回饋', tip:'回饋你參與的活動' }
      ];
      const box = document.getElementById('quickOps');
      ops.forEach(o=>{
        const b=document.createElement('button');
        b.textContent=o.label;
        b.onclick=()=> quickOperation(o.id);
        box.appendChild(b);
      });
    }

    async function loadDashboardSubsections(){
      // 活動
      try {
        const acts = await API.getUserActivities(State.profile.lineId);
        const area = document.getElementById('dashActivities');
        if (!acts.length) area.innerHTML='<div class="empty">尚未報名任何活動</div>';
        else {
          area.innerHTML = '<ul style="list-style:none; padding:0; margin:0;">'+ acts.slice(0,5).map(a=>`
            <li style="padding:6px 0; border-bottom:1px solid var(--border); font-size:13px;">
              <strong>${esc(a.activityName||'(未命名)')}</strong>
              <div class="small">${fmtDate(a.date)} ｜ 狀態：${esc(a.status||'')}</div>
            </li>
          `).join('') + '</ul>';
        }
      }catch(e){ document.getElementById('dashActivities').innerHTML='<span class="danger-text">'+esc(e.message)+'</span>'; }

      // 捐款
      try{
        const dons = await API.getDonations(State.profile.lineId);
        const area = document.getElementById('dashDonations');
        if (!dons.length) area.innerHTML='<div class="empty">尚無捐款紀錄</div>';
        else {
          const sum = dons.reduce((s,d)=> s + Number(d.amount||0), 0);
          area.innerHTML = `
            <p style="margin:4px 0;">總筆數：${dons.length}</p>
            <p style="margin:4px 0;">累計金額：<strong>${sum}</strong></p>
            <div class="small muted">(顯示最近 5 筆)</div>
            <ul style="list-style:none; padding:0; margin:6px 0 0;">
              ${dons.slice(0,5).map(d=>`
                <li style="padding:4px 0; border-bottom:1px solid var(--border);">
                  ${fmtDate(d.date)} - ${Number(d.amount)} 元
                </li>
              `).join('')}
            </ul>
          `;
        }
      }catch(e){ document.getElementById('dashDonations').innerHTML='<span class="danger-text">'+esc(e.message)+'</span>'; }
    }

    function quickOperation(id){
      switch(id){
        case 'regActivity': setActiveTab('myActivities'); break;
        case 'donate': openDonationDialog(); break;
        case 'expense': openExpenseDialog(); break;
        case 'feedback': openFeedbackDialog(); break;
      }
    }

    /************************************************************
     * 視圖：我的活動
     ************************************************************/
    async function renderMyActivities(root){
      root.innerHTML = '<div class="card"><h2>載入活動...</h2></div>';
      try{
        const [available, myRegs] = await Promise.all([
          API.getActivities(),
          API.getUserActivities(State.profile.lineId)
        ]);
        root.innerHTML = `
          <div class="card">
            <h2>開放活動</h2>
            ${available.length? `
              <div class="scroll-x">
                <table>
                  <thead><tr>
                    <th>名稱</th><th>日期</th><th>地點</th><th>名額</th><th>費用</th><th></th>
                  </tr></thead>
                  <tbody>
                    ${available.map(a=>{
                      const full = a.maxParticipants && a.currentParticipants>=a.maxParticipants;
                      return `
                        <tr>
                          <td>${esc(a.name)}</td>
                          <td>${fmtDate(a.date)}</td>
                          <td>${esc(a.location||'')}</td>
                          <td>${a.currentParticipants||0}/${a.maxParticipants||'-'}</td>
                          <td>${a.fee||0}</td>
                          <td>
                            <button class="btn secondary" data-act="${a.id}" ${full?'disabled':''}>
                              ${full?'額滿':'報名'}
                            </button>
                          </td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            `:'<div class="empty">目前沒有開放報名的活動</div>'}
          </div>
          <div class="card mt-16">
            <h2>我的報名</h2>
            ${myRegs.length? `
              <div class="scroll-x">
                <table>
                  <thead><tr><th>活動</th><th>日期</th><th>狀態</th><th>參與名稱</th><th>報名日</th><th></th></tr></thead>
                  <tbody>
                    ${myRegs.map(r=>`
                      <tr>
                        <td>${esc(r.activityName||'(已刪除)')}</td>
                        <td>${fmtDate(r.date)}</td>
                        <td><span class="status ${r.status==='已報名'?'open':'closed'}">${esc(r.status)}</span></td>
                        <td>${esc(r.participantName||'')}</td>
                        <td>${fmtDate(r.registerDate)}</td>
                        <td>
                          ${r.status==='已報名'?`<button class="btn danger btnCancelReg" data-reg="${r.id}">取消</button>`:''}
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `:'<div class="empty">尚未報名任何活動</div>'}
          </div>
        `;
        root.querySelectorAll('button[data-act]').forEach(btn=>{
          btn.onclick=()=> openRegisterActivityDialog(btn.getAttribute('data-act'));
        });
        root.querySelectorAll('.btnCancelReg').forEach(btn=>{
          btn.onclick=()=> cancelRegistration(btn.getAttribute('data-reg'));
        });
      }catch(e){
        root.innerHTML='<div class="card"><h2>載入失敗</h2><p>'+esc(e.message)+'</p></div>';
      }
    }

    async function openRegisterActivityDialog(activityId){
      const participantName = prompt('請輸入報名顯示姓名：','');
      if (!participantName) return;
      try{
        await API.registerActivity(State.profile.lineId, activityId, participantName);
        showToast('報名成功','success');
        renderView();
      }catch(e){ showToast(e.message,'error'); }
    }

    async function cancelRegistration(regId){
      if (!confirm('確定要取消？')) return;
      try{
        await API.cancelActivity(State.profile.lineId, regId);
        showToast('已取消','success');
        renderView();
      }catch(e){ showToast(e.message,'error'); }
    }

    /************************************************************
     * 視圖：捐款
     ************************************************************/
    async function renderMyDonations(root){
      root.innerHTML='<div class="card"><h2>載入捐款...</h2></div>';
      try {
        const dons = await API.getDonations(State.profile.lineId);
        const total = dons.reduce((s,d)=> s + Number(d.amount||0), 0);
        root.innerHTML = `
          <div class="card">
            <h2>我的捐款</h2>
            <div class="toolbar">
              <button class="btn" id="btnAddDonation">新增捐款</button>
              <div class="chip">累計金額：${total}</div>
              <div class="chip">筆數：${dons.length}</div>
            </div>
            ${dons.length?`
            <div class="scroll-x">
              <table>
                <thead><tr><th>日期</th><th>金額</th><th>備註</th></tr></thead>
                <tbody>
                ${dons.map(d=>`
                  <tr>
                    <td>${fmtDate(d.date)}</td>
                    <td>${d.amount}</td>
                    <td>${esc(d.notes||'')}</td>
                  </tr>
                `).join('')}
                </tbody>
              </table>
            </div>`:'<div class="empty">尚無捐款紀錄</div>'}
          </div>
        `;
        document.getElementById('btnAddDonation').onclick=()=> openDonationDialog();
      }catch(e){
        root.innerHTML='<div class="card"><h2>載入失敗</h2><p>'+esc(e.message)+'</p></div>';
      }
    }

    async function openDonationDialog(){
      const amount = prompt('請輸入捐款金額：','');
      if (!amount) return;
      const notes = prompt('備註（可留空）：','');
      try{
        await API.addDonation(State.profile.lineId, amount, State.userInfo.realName||State.profile.displayName, notes||'');
        showToast('捐款已紀錄','success');
        if (State.activeTab==='myDonations' || State.activeTab==='dashboard') renderView();
      }catch(e){ showToast(e.message,'error'); }
    }

    /************************************************************
     * 視圖：支出
     ************************************************************/
    async function renderMyExpenses(root){
      root.innerHTML='<div class="card"><h2>載入支出...</h2></div>';
      try{
        const list = await API.getMyExpenses(State.profile.lineId);
        root.innerHTML = `
          <div class="card">
            <h2>我的支出申請</h2>
            <div class="toolbar">
              <button class="btn" id="btnAddExpense">提出申請</button>
              <div class="chip">總申請：${list.length}</div>
            </div>
            ${list.length?`
              <div class="scroll-x">
                <table>
                  <thead><tr><th>日期</th><th>類別</th><th>金額</th><th>說明</th><th>狀態</th><th>審核者</th></tr></thead>
                  <tbody>
                    ${list.map(r=>`
                      <tr>
                        <td>${fmtDate(r.submitDate)}</td>
                        <td>${esc(r.category)}</td>
                        <td>${r.amount}</td>
                        <td>${esc(r.description||'')}</td>
                        <td><span class="status ${r.status==='待審核'?'draft': (r.status==='已核准'?'open':'closed')}">${esc(r.status)}</span></td>
                        <td>${esc(r.approvedBy||'')}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `:'<div class="empty">尚無支出申請</div>'}
          </div>
        `;
        document.getElementById('btnAddExpense').onclick=()=> openExpenseDialog();
      }catch(e){
        root.innerHTML='<div class="card"><h2>載入失敗</h2><p>'+esc(e.message)+'</p></div>';
      }
    }

    async function openExpenseDialog(){
      const category = prompt('支出類別：','');
      if (!category) return;
      const amount = prompt('金額：','');
      if (!amount) return;
      const desc = prompt('支出說明：','');
      if (!desc) return;
      try{
        await API.submitExpense(State.profile.lineId, category, amount, desc);
        showToast('支出已提交','success');
        if (State.activeTab==='myExpenses') renderView();
      }catch(e){ showToast(e.message,'error'); }
    }

    /************************************************************
     * 視圖：回饋
     ************************************************************/
    async function renderMyFeedback(root){
      root.innerHTML='<div class="card"><h2>載入回饋...</h2></div>';
      try{
        const list = await API.getMyFeedback(State.profile.lineId);
        root.innerHTML = `
          <div class="card">
            <h2>活動回饋</h2>
            <div class="toolbar">
              <button class="btn" id="btnAddFeedback">新增回饋</button>
              <div class="chip">總筆數：${list.length}</div>
            </div>
            ${list.length?`
              <div class="scroll-x">
                <table>
                  <thead><tr><th>活動</th><th>評分</th><th>意見</th><th>日期</th></tr></thead>
                  <tbody>
                    ${list.map(f=>`
                      <tr>
                        <td>${esc(f.activityName||'')}</td>
                        <td>${f.rating}</td>
                        <td>${esc(f.comment||'')}</td>
                        <td>${fmtDate(f.submitDate)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `:'<div class="empty">尚無回饋</div>'}
          </div>
        `;
        document.getElementById('btnAddFeedback').onclick=()=> openFeedbackDialog();
      }catch(e){
        root.innerHTML='<div class="card"><h2>載入失敗</h2><p>'+esc(e.message)+'</p></div>';
      }
    }

    async function openFeedbackDialog(){
      const activityId = prompt('請輸入活動ID（需已參加）：','');
      if (!activityId) return;
      const rating = prompt('評分(1-5)：','5');
      if (!rating) return;
      const comment = prompt('意見：','');
      try{
        await API.submitFeedback(State.profile.lineId, activityId, rating, comment||'');
        showToast('回饋已提交','success');
        if (State.activeTab==='myFeedback') renderView();
      }catch(e){ showToast(e.message,'error'); }
    }

    /************************************************************
     * 視圖：理監事（一般會員簡版）
     ************************************************************/
    async function renderMyBoard(root){
      root.innerHTML=`
        <div class="card">
          <h2>理監事互動</h2>
          <p>你可以在這裡提交提案、案件或臨時動議，或查看自己提交的項目。</p>
          <div class="toolbar">
            <button class="btn" id="btnSubmitProposal">提案</button>
            <button class="btn" id="btnSubmitCase">案件</button>
            <button class="btn" id="btnSubmitMotion">臨時動議</button>
          </div>
          <div id="myBoardLists" class="mt-16">載入中...</div>
        </div>
      `;
      document.getElementById('btnSubmitProposal').onclick=()=> submitProposalDialog();
      document.getElementById('btnSubmitCase').onclick=()=> submitCaseDialog();
      document.getElementById('btnSubmitMotion').onclick=()=> submitMotionDialog();
      try{
        const [proposals, cases, motions] = await Promise.all([
          API.listProposals('', State.profile.lineId, ''),
          (State.isAdmin? API.listCases(State.profile.lineId,'') : Promise.resolve([])), // 會員不顯示全部案件，只顯示自己提交的，可用另一 API (未實作)
          API.listMotions(State.profile.lineId,'','') // 這裡 operatorLineId= lineId 但後端需要 admin? -> 後端目前 listMotions 需要 adminLineId; 若非 admin 會失敗
        ]).catch(e=>{
          // 如果後端設計不允許非管理員列出 motions/cases，就顯示空
          return [[],[],[]];
        });
        const wrap = document.getElementById('myBoardLists');
        wrap.innerHTML = `
          <h3>我的提案</h3>
          ${proposals.length? tableHTML(['標題','分類','狀態','提交時間'],
            proposals.map(p=>[p.title,p.category,p.status,fmtDate(p.submitDate)]))
            :'<div class="empty">尚無提案</div>'}
          <h3 style="margin-top:20px;">（示例）我的案件 / 動議顯示</h3>
          <div class="small muted">若非管理員且後端限制讀取，可能為空</div>
        `;
      }catch(e){
        document.getElementById('myBoardLists').innerHTML='<div class="danger-text">'+esc(e.message)+'</div>';
      }
    }

    function tableHTML(headers, rows){
      return `
        <div class="scroll-x">
          <table>
            <thead><tr>${headers.map(h=>'<th>'+esc(h)+'</th>').join('')}</tr></thead>
            <tbody>
              ${rows.map(r=>'<tr>'+r.map(c=>'<td>'+esc(c)+'</td>').join('')+'</tr>').join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    async function submitProposalDialog(){
      const title = prompt('提案標題：','');
      if (!title) return;
      const content = prompt('內容：','');
      if (!content) return;
      const category = prompt('分類：','一般');
      try{
        await API.submitProposal(State.profile.lineId, title, content, category||'一般');
        showToast('提案已提交','success');
        if (State.activeTab==='myBoard') renderView();
      }catch(e){ showToast(e.message,'error'); }
    }
    async function submitCaseDialog(){
      const title = prompt('案件標題：','');
      if (!title) return;
      const summary = prompt('摘要：','');
      const type = prompt('類型：','一般');
      try{
        await API.submitCase(State.profile.lineId, title, summary||'', type||'一般');
        showToast('案件已提交','success');
        if (State.activeTab==='myBoard') renderView();
      }catch(e){ showToast(e.message,'error'); }
    }
    async function submitMotionDialog(){
      const title = prompt('臨時動議標題：','');
      if (!title) return;
      const reason = prompt('理由：','');
      const meetingId = prompt('要關聯的會議ID（可留空）：','');
      try{
        await API.submitMotion(State.profile.lineId, title, reason||'', meetingId||'');
        showToast('臨時動議已提交','success');
        if (State.activeTab==='myBoard') renderView();
      }catch(e){ showToast(e.message,'error'); }
    }

    /************************************************************
     * 視圖：會員管理 (Admin)
     ************************************************************/
    async function renderAdminMembers(root){
      if (!State.isAdmin) return root.innerHTML='<div class="card">無權限</div>';
      root.innerHTML = '<div class="card"><h2>載入會員...</h2></div>';
      try{
        const list = await API.getAllMembers(State.profile.lineId,'','');
        root.innerHTML = `
          <div class="card">
            <h2>會員列表</h2>
            <div class="filter-box">
              <input type="text" id="memberSearch" placeholder="搜尋關鍵字 (姓名/LINE)"/>
              <select id="memberTypeFilter">
                <option value="">全部類別</option>
                <option value="一般">一般</option>
                <option value="理監事">理監事</option>
              </select>
              <button class="btn secondary" id="btnMemberFilter">篩選</button>
              <button class="btn" id="btnExportMembers">匯出CSV</button>
            </div>
            <div class="scroll-x mt-12">
              <table>
                <thead>
                  <tr><th>LINE ID</th><th>名稱</th><th>真實姓名</th><th>類別</th><th>狀態</th><th>管理員</th><th>操作</th></tr>
                </thead>
                <tbody id="memberBody">
                  ${renderMemberRows(list)}
                </tbody>
              </table>
            </div>
          </div>
        `;
        document.getElementById('btnMemberFilter').onclick=()=> filterMembers();
        document.getElementById('btnExportMembers').onclick=()=> exportMembersCSV();
        root.querySelectorAll('.btnEditMember').forEach(btn=>{
          btn.onclick=()=> editMemberDialog(btn.dataset.id);
        });
      }catch(e){
        root.innerHTML='<div class="card"><h2>載入失敗</h2><p>'+esc(e.message)+'</p></div>';
      }
    }

    function renderMemberRows(list){
      return list.map(m=>`
        <tr>
          <td>${esc(m.lineId)}</td>
          <td>${esc(m.lineName)}</td>
          <td>${esc(m.realName||'')}</td>
          <td>${esc(m.memberType||'')}</td>
          <td>${esc(m.status||'')}</td>
          <td>${m.isAdmin?'是':'否'}</td>
          <td><button class="btn secondary btnEditMember" data-id="${m.lineId}">編輯</button></td>
        </tr>
      `).join('');
    }

    async function filterMembers(){
      const q = document.getElementById('memberSearch').value.trim();
      const mt = document.getElementById('memberTypeFilter').value;
      try{
        const list = await API.getAllMembers(State.profile.lineId, q, mt);
        document.getElementById('memberBody').innerHTML=renderMemberRows(list);
        document.querySelectorAll('.btnEditMember').forEach(btn=>{
          btn.onclick=()=> editMemberDialog(btn.dataset.id);
        });
      }catch(e){ showToast(e.message,'error'); }
    }

    async function exportMembersCSV(){
      try{
        const result = await API.exportMembers(State.profile.lineId);
        const blob = new Blob([result.csv],{ type:'text/csv;charset=utf-8;' });
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url; a.download='members.csv'; a.click();
        URL.revokeObjectURL(url);
      }catch(e){ showToast(e.message,'error'); }
    }

    async function editMemberDialog(lineId){
      try{
        const info = await API.getUserInfo(lineId);
        const realName = prompt('真實姓名：', info.realName||'');
        if (realName===null) return;
        const memberType = prompt('會員類別(一般/理監事)：', info.memberType||'一般');
        if (memberType===null) return;
        const isAdminStr = prompt('是否管理員(是/否)：', info.isAdmin?'是':'否');
        const isAdminFlag = (isAdminStr==='是');
        await API.updateMember(State.profile.lineId, lineId, {
          realName,
          memberType,
          isAdmin: isAdminFlag
        });
        showToast('已更新','success');
        if (State.activeTab==='adminMembers') renderView();
      }catch(e){ showToast(e.message,'error'); }
    }

    /************************************************************
     * 視圖：活動管理 (Admin)
     ************************************************************/
    async function renderAdminActivities(root){
      if (!State.isAdmin) return root.innerHTML='<div class="card">無權限</div>';
      root.innerHTML='<div class="card"><h2>載入活動...</h2></div>';
      try{
        const list = await API.getAllActivities(State.profile.lineId);
        root.innerHTML = `
          <div class="card">
            <h2>活動管理</h2>
            <div class="toolbar">
              <button class="btn" id="btnCreateActivity">新增活動</button>
            </div>
            ${list.length?`
              <div class="scroll-x">
                <table>
                  <thead><tr><th>名稱</th><th>日期</th><th>地點</th><th>人數</th><th>狀態</th><th>操作</th></tr></thead>
                  <tbody>
                    ${list.map(a=>`
                      <tr>
                        <td>${esc(a.name)}</td>
                        <td>${fmtDate(a.date)}</td>
                        <td>${esc(a.location||'')}</td>
                        <td>${a.currentParticipants||0}/${a.maxParticipants||'-'}</td>
                        <td><span class="status ${a.status==='開放報名'?'open':'closed'}">${a.status}</span></td>
                        <td>
                          <button class="btn secondary btnEditAct" data-id="${a.id}">編輯</button>
                          <button class="btn secondary btnRegList" data-id="${a.id}">報名</button>
                          <button class="btn danger btnDelAct" data-id="${a.id}">刪除</button>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `:'<div class="empty">尚無活動</div>'}
          </div>
          <div class="card mt-16" id="activityRegistrations" style="display:none;"></div>
        `;
        document.getElementById('btnCreateActivity').onclick=()=> createActivityDialog();
        root.querySelectorAll('.btnEditAct').forEach(btn=>{
          btn.onclick=()=> editActivityDialog(btn.dataset.id);
        });
        root.querySelectorAll('.btnDelAct').forEach(btn=>{
          btn.onclick=()=> deleteActivity(btn.dataset.id);
        });
        root.querySelectorAll('.btnRegList').forEach(btn=>{
          btn.onclick=()=> loadActivityRegistrations(btn.dataset.id);
        });
      }catch(e){
        root.innerHTML='<div class="card"><h2>載入失敗</h2><p>'+esc(e.message)+'</p></div>';
      }
    }

    async function createActivityDialog(){
      const name=prompt('活動名稱：','');
      if (!name) return;
      const date=prompt('活動日期 (YYYY-MM-DD)：','');
      if (!date) return;
      const desc=prompt('描述：','');
      const location=prompt('地點：','');
      const max=prompt('最大人數 (可留空)：','');
      const fee=prompt('費用 (數字,可0)：','0');
      try{
        await API.createActivity(State.profile.lineId, name, desc||'', date, location||'', max||'', fee||0);
        showToast('活動已建立','success');
        if (State.activeTab==='adminActivities') renderView();
      }catch(e){ showToast(e.message,'error'); }
    }

    async function editActivityDialog(actId){
      // 讀取現有資料（簡化：從列表抓，或呼叫 getAllActivities 做 filter）
      try{
        const list = await API.getAllActivities(State.profile.lineId);
        const act = list.find(a=>a.id===actId);
        if (!act) return showToast('找不到活動','error');
        const name = prompt('名稱：', act.name);
        if (name===null) return;
        const date = prompt('日期：', fmtDate(act.date));
        if (date===null) return;
        const location = prompt('地點：', act.location||'');
          if (location===null) return;
        const max = prompt('最大人數(留空=不限)：', act.maxParticipants||'');
        if (max===null) return;
        const fee = prompt('費用：', act.fee||0);
        if (fee===null) return;
        const desc = prompt('描述：', act.description||'');
        await API.updateActivity(State.profile.lineId, actId, {
          name, date, location, maxParticipants:max||'', fee:fee||0, description:desc
        });
        showToast('已更新','success');
        renderView();
      }catch(e){ showToast(e.message,'error'); }
    }

    async function deleteActivity(id){
      if (!confirm('確定刪除活動？')) return;
      try{
        await API.deleteActivity(State.profile.lineId, id);
        showToast('活動已刪除','success');
        renderView();
      }catch(e){ showToast(e.message,'error'); }
    }

    async function loadActivityRegistrations(id){
      try{
        const regs = await API.getActivityRegistrations(State.profile.lineId, id);
        const panel = document.getElementById('activityRegistrations');
        panel.style.display='block';
        panel.innerHTML=`
          <h2>報名名單</h2>
          ${regs.length?tableHTML(['參與者','報名日','狀態'], regs.map(r=>[r.participantName, fmtDate(r.registerDate), r.status]))
          :'<div class="empty">尚無報名</div>'}
        `;
        panel.scrollIntoView({behavior:'smooth', block:'start'});
      }catch(e){ showToast(e.message,'error'); }
    }

    /************************************************************
     * 視圖：財務 (Admin)
     ************************************************************/
    async function renderFinance(root){
      if (!State.isAdmin) return root.innerHTML='<div class="card">無權限</div>';
      root.innerHTML='<div class="card"><h2>載入財務...</h2></div>';
      try{
        const [overview, pending, budget, trans] = await Promise.all([
          API.getFinanceOverview(State.profile.lineId),
          API.getPendingExpenses(State.profile.lineId),
          API.getBudgetStatus(State.profile.lineId),
          API.getTransactions(State.profile.lineId)
        ]);
        root.innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <h2>財務概覽</h2>
              <p>總收入：${overview.totalIncome}</p>
              <p>總支出：${overview.totalExpense}</p>
              <p>結餘：<strong>${overview.balance}</strong></p>
              <div class="small">捐款筆數：${overview.donationCount}</div>
            </div>
            <div class="card">
              <h2>預算狀況</h2>
              <p>本月預算：${budget.monthlyBudget}</p>
              <p>已使用：${budget.monthlyExpense}</p>
              <p>剩餘：${budget.remainingBudget}</p>
              <p>使用率：${budget.budgetUsed}%</p>
            </div>
            <div class="card">
              <h2>待審支出</h2>
              ${pending.length?tableHTML(['申請者','類別','金額','日期','操作'],
                pending.map(p=>[
                  p.applicantName||p.lineId, p.category, p.amount, fmtDate(p.submitDate),
                  '<button class="btn secondary btnApproveExp" data-id="'+p.id+'">核准</button>'+
                  '<button class="btn danger btnRejectExp" style="margin-left:4px;" data-id="'+p.id+'">拒絕</button>'
                ])):'<div class="empty">目前無待審核</div>'}
            </div>
            <div class="card">
              <h2>交易紀錄 (前20筆)</h2>
              ${trans.length?tableHTML(['日期','類型','金額','分類/說明'],
                trans.slice(0,20).map(t=>[
                  fmtDate(t.date),
                  t.type==='income'?'收入':'支出',
                  t.amount,
                  esc(t.category||t.notes||'')
                ])):'<div class="empty">尚無交易</div>'}
            </div>
          </div>
        `;
        root.querySelectorAll('.btnApproveExp').forEach(btn=>{
          btn.onclick=()=> reviewExpense(btn.dataset.id,true);
        });
        root.querySelectorAll('.btnRejectExp').forEach(btn=>{
          btn.onclick=()=> reviewExpense(btn.dataset.id,false);
        });
      }catch(e){
        root.innerHTML='<div class="card"><h2>載入失敗</h2><p>'+esc(e.message)+'</p></div>';
      }
    }

    async function reviewExpense(expenseId, approve){
      const notes = approve? prompt('核准備註(可留空)：','') : prompt('拒絕原因：','');
      try{
        await API.approveExpense(State.profile.lineId, expenseId, approve, notes||'');
        showToast(approve?'已核准':'已拒絕','success');
        if (State.activeTab==='finance') renderView();
      }catch(e){ showToast(e.message,'error'); }
    }

    /************************************************************
     * 視圖：理監事管理 (Admin)
     ************************************************************/
    async function renderBoardAdmin(root){
      if (!State.isAdmin) return root.innerHTML='<div class="card">無權限</div>';
      root.innerHTML='<div class="card"><h2>載入理監事...</h2></div>';
      try{
        const meetings = await API.listBoardMeetings(State.profile.lineId,'');
        root.innerHTML = `
          <div class="card">
            <h2>會議列表</h2>
            <div class="toolbar">
              <button class="btn" id="btnCreateMeeting">新會議</button>
            </div>
            ${meetings.length?tableHTML(['標題','日期','狀態','鎖定','操作'],
              meetings.map(m=>[
                m.title, fmtDate(m.meetingDate), m.status, m.locked?'是':'否',
                `
                  <button class="btn secondary btnAgenda" data-id="${m.id}">議程</button>
                  <button class="btn secondary btnLock" data-id="${m.id}">${m.locked?'解鎖':'鎖定'}</button>
                `
              ]))
              :'<div class="empty">尚無會議</div>'}
          </div>
          <div class="card mt-16" id="boardAgendaPanel" style="display:none;"></div>
        `;
        document.getElementById('btnCreateMeeting').onclick=()=> createMeetingDialog();
        root.querySelectorAll('.btnAgenda').forEach(btn=>{
          btn.onclick=()=> loadAgendaPanel(btn.dataset.id);
        });
        root.querySelectorAll('.btnLock').forEach(btn=>{
          btn.onclick=()=> toggleMeetingLock(btn.dataset.id);
        });
      }catch(e){
        root.innerHTML='<div class="card"><h2>載入失敗</h2><p>'+esc(e.message)+'</p></div>';
      }
    }

    async function createMeetingDialog(){
      const title=prompt('會議標題：','');
      if (!title) return;
      const date=prompt('會議日期 (YYYY-MM-DD)：','');
      if (!date) return;
      try{
        await API.createBoardMeeting(State.profile.lineId, title, date);
        showToast('會議已建立','success');
        if (State.activeTab==='boardAdmin') renderView();
      }catch(e){ showToast(e.message,'error'); }
    }

    async function toggleMeetingLock(meetingId){
      try{
        const meetings = await API.listBoardMeetings(State.profile.lineId,'');
        const m = meetings.find(x=>x.id===meetingId);
        if (!m) return;
        const locked = !m.locked;
        await API.lockBoardMeeting(State.profile.lineId, meetingId, locked);
        showToast(locked?'已鎖定':'已解鎖','success');
        if (State.activeTab==='boardAdmin') renderView();
      }catch(e){ showToast(e.message,'error'); }
    }

    async function loadAgendaPanel(meetingId){
      const panel=document.getElementById('boardAgendaPanel');
      panel.style.display='block';
      panel.innerHTML='<h2>議程載入中...</h2>';
      try{
        const agendas=await API.listAgenda(State.profile.lineId, meetingId);
        panel.innerHTML=`
          <h2>議程 - 會議ID: ${meetingId}</h2>
          <div class="toolbar">
            <button class="btn" id="btnAddAgenda">新增議程</button>
            <button class="btn secondary" id="btnDecision">新增決議</button>
          </div>
          ${agendas.length? tableHTML(['排序','標題','類型','狀態','決議','操作'],
            agendas.map(a=>[
              a.order, a.title, a.type, a.status, a.decisionText||'',
              `<button class="btn secondary btnAgendaStatus" data-id="${a.id}">狀態</button>`
            ]))
          :'<div class="empty">尚無議程</div>'}
        `;
        document.getElementById('btnAddAgenda').onclick=()=> addAgendaDialog(meetingId);
        document.getElementById('btnDecision').onclick=()=> recordDecisionDialog(meetingId);
        panel.querySelectorAll('.btnAgendaStatus').forEach(btn=>{
          btn.onclick=()=> updateAgendaStatusDialog(btn.dataset.id);
        });
        panel.scrollIntoView({behavior:'smooth', block:'start'});
      }catch(e){
        panel.innerHTML='<div class="danger-text">'+esc(e.message)+'</div>';
      }
    }

    async function addAgendaDialog(meetingId){
      const type=prompt('類型(一般/提案/案件/動議)：','一般');
      if (!type) return;
      const title=prompt('議程標題：','');
      if (!title) return;
      const description=prompt('說明：','');
      const presenter=prompt('提報人：','');
      try{
        await API.addAgendaItem(State.profile.lineId, meetingId, type, '', title, description||'', presenter||'');
        showToast('議程已新增','success');
        loadAgendaPanel(meetingId);
      }catch(e){ showToast(e.message,'error'); }
    }

    async function updateAgendaStatusDialog(agendaId){
      const status=prompt('新狀態(待討論/討論中/完成)：','完成');
      if (!status) return;
      const decision = prompt('決議文字(可留空)：','');
      try{
        await API.updateAgendaStatus(State.profile.lineId, agendaId, status, decision||'');
        showToast('狀態已更新','success');
        // 找出當前會議ID 無直接方法→ 重新載入boardAdmin
        if (State.activeTab==='boardAdmin') renderView();
      }catch(e){ showToast(e.message,'error'); }
    }

    async function recordDecisionDialog(meetingId){
      const agendaId = prompt('對應議程ID：','');
      if (!agendaId) return;
      const result = prompt('決議結果：','通過');
      if (!result) return;
      const voteFor = prompt('贊成票(數字)：','0');
      const voteAgainst = prompt('反對票：','0');
      const voteAbstain = prompt('棄權票：','0');
      const notes = prompt('備註：','');
      try{
        await API.recordDecision(State.profile.lineId, meetingId, agendaId, result, voteFor||0, voteAgainst||0, voteAbstain||0, notes||'');
        showToast('決議已記錄','success');
        loadAgendaPanel(meetingId);
      }catch(e){ showToast(e.message,'error'); }
    }

    /************************************************************
     * 基本資料編輯
     ************************************************************/
    async function openEditProfileDialog(){
      const realName = prompt('真實姓名：', State.userInfo.realName||'');
      if (realName===null) return;
      const memberType = prompt('會員類別 (一般/理監事)：', State.userInfo.memberType||'一般');
      if (memberType===null) return;
      try{
        await API.register(State.profile.lineId, realName, memberType);
        showToast('已更新','success');
        const info = await API.getUserInfo(State.profile.lineId);
        State.setUserInfo(info);
        if (State.activeTab==='dashboard') renderView();
      }catch(e){ showToast(e.message,'error'); }
    }

    /************************************************************
     * 事件
     ************************************************************/
    document.getElementById('btnReload').onclick=()=> {
      renderView();
      showToast('重新整理完成','success',1500);
    };

    // 啟動
    initApp();
  </script>
</body>
</html>
