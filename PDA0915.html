<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>帕金森病友會管理系統</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
/* (保留原樣式，可再調整) */
body{background:#f8f9fa;}
.hidden{display:none!important;}
.navbar{background:linear-gradient(135deg,#00B900,#009000);}
.navbar-brand{color:#fff!important;font-weight:bold;}
.stats-card{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;padding:22px;text-align:center;}
.stats-number{font-size:2rem;font-weight:bold;}
.card{border:none;border-radius:16px;box-shadow:0 4px 14px rgba(0,0,0,0.08);margin-bottom:20px;}
.card-header{border-radius:16px 16px 0 0!important;font-weight:600;background:linear-gradient(135deg,#007bff,#0056b3);color:#fff;}
.badge{border-radius:12px;}
.bg-success,.bg-warning,.bg-danger,.bg-secondary{padding:6px 10px;}
.fade-in{animation:fade .4s ease;}
@keyframes fade{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:none;}}
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand"><i class="fas fa-heart"></i> 帕金森病友會</a>
    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navMenu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div id="navMenu" class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showPage('dashboard')"><i class="fas fa-home"></i> 首頁</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showPage('profile')"><i class="fas fa-user"></i> 個人資料</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showPage('activities')"><i class="fas fa-calendar"></i> 活動</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showPage('volunteer')"><i class="fas fa-hands-helping"></i> 志工</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showPage('finance')"><i class="fas fa-coins"></i> 財務</a></li>
        <li class="nav-item" id="adminNav" style="display:none;"><a class="nav-link text-white" href="#" onclick="showPage('admin')"><i class="fas fa-cog"></i> 管理</a></li>
        <li class="nav-item" id="boardNav" style="display:none;"><a class="nav-link text-white" href="#" onclick="showPage('board')"><i class="fas fa-gavel"></i> 理監事</a></li>
      </ul>
      <span class="navbar-text text-white" id="userInfo">載入中...</span>
    </div>
  </div>
</nav>

<div class="container-fluid py-3">
  <!-- Alerts -->
  <div id="errorAlert" class="alert alert-danger hidden"><span id="errorMessage"></span></div>
  <div id="successAlert" class="alert alert-success hidden"><span id="successMessage"></span></div>

  <!-- Dashboard -->
  <div id="dashboardPage" class="page-content">
    <h3 class="mb-4"><i class="fas fa-home"></i> 首頁</h3>
    <div class="row g-3 mb-3">
      <div class="col-md-3 col-6">
        <div class="stats-card">
          <div class="stats-number" id="totalActivities">0</div>
          <div>進行中活動</div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="stats-card">
          <div class="stats-number" id="myRegistrations">0</div>
          <div>我的報名</div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="stats-card">
          <div class="stats-number" id="volunteerHours">0</div>
          <div>志工時數</div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="stats-card">
          <div class="stats-number" id="totalDonations">0</div>
          <div>捐款次數</div>
        </div>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header"><i class="fas fa-calendar"></i> 最新活動</div>
          <div class="card-body" id="recentActivities">載入中...</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header"><i class="fas fa-bullhorn"></i> 系統公告</div>
          <div class="card-body">
            <p><i class="fas fa-info-circle text-primary"></i> 歡迎使用系統</p>
            <p><i class="fas fa-heart text-danger"></i> 感謝您的參與</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile -->
  <div id="profilePage" class="page-content hidden">
    <h3 class="mb-4"><i class="fas fa-user"></i> 個人資料</h3>
    <form id="profileForm" class="card p-3">
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">LINE名稱</label>
          <input type="text" id="lineName" class="form-control" readonly>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">真實姓名 *</label>
            <input type="text" id="realName" class="form-control" required>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">電話</label>
          <input type="text" id="phone" class="form-control">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Email</label>
          <input type="email" id="email" class="form-control">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">生日</label>
          <input type="date" id="birthday" class="form-control">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">會員類型</label>
          <select id="memberType" class="form-select">
            <option value="病友">病友</option>
            <option value="家屬">家屬</option>
            <option value="志工">志工</option>
            <option value="醫護">醫護人員</option>
            <option value="一般">一般</option>
          </select>
        </div>
        <div class="col-md-8 mb-3">
          <label class="form-label">地址</label>
          <input type="text" id="address" class="form-control">
        </div>
      </div>
      <button class="btn btn-primary"><i class="fas fa-save"></i> 儲存</button>
    </form>
    <div class="card mt-3 p-3">
      <h6>會員資訊</h6>
      <p>狀態：<span id="memberStatus" class="badge bg-success">-</span></p>
      <p>註冊日期：<span id="registerDate">-</span></p>
      <p>志工時數：<span id="profileVolunteerHours">0</span></p>
      <p>參與活動：<span id="activityCount">0</span></p>
      <p>最後活動：<span id="lastActive">-</span></p>
    </div>
  </div>

  <!-- Activities -->
  <div id="activitiesPage" class="page-content hidden">
    <h3 class="mb-4"><i class="fas fa-calendar"></i> 活動</h3>
    <div id="activitiesList">載入中...</div>
    <div class="card mt-4">
      <div class="card-header"><i class="fas fa-list"></i> 我的報名</div>
      <div class="card-body" id="myRegistrationsList">載入中...</div>
    </div>
  </div>

  <!-- Volunteer -->
  <div id="volunteerPage" class="page-content hidden">
    <h3 class="mb-4"><i class="fas fa-hands-helping"></i> 志工</h3>
    <div class="card mb-3">
      <div class="card-header">志工需求</div>
      <div class="card-body" id="volunteerNeedsList">載入中...</div>
    </div>
    <div class="card">
      <div class="card-header">我的志工紀錄</div>
      <div class="card-body" id="myVolunteerRecords">載入中...</div>
    </div>
  </div>

  <!-- Finance -->
  <div id="financePage" class="page-content hidden">
    <h3 class="mb-4"><i class="fas fa-coins"></i> 財務</h3>
    <div class="row">
      <div class="col-md-6 mb-3">
        <div class="card">
          <div class="card-header">
            我的捐款
            <button class="btn btn-sm btn-light float-end" onclick="showDonationModal()"><i class="fas fa-plus"></i></button>
          </div>
          <div class="card-body" id="myDonationsList">載入中...</div>
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <div class="card">
          <div class="card-header">
            我的支出申請
            <button class="btn btn-sm btn-light float-end" onclick="showExpenseModal()"><i class="fas fa-plus"></i></button>
          </div>
          <div class="card-body" id="myExpensesList">載入中...</div>
        </div>
      </div>
    </div>
    <div id="financeOverview" class="card" style="display:none;">
      <div class="card-header">財務概覽</div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-md-3"><h5 id="totalIncome">$0</h5><small>總收入</small></div>
            <div class="col-md-3"><h5 id="totalExpense">$0</h5><small>總支出</small></div>
            <div class="col-md-3"><h5 id="currentBalance">$0</h5><small>餘額</small></div>
            <div class="col-md-3"><h5 id="donationCount">0</h5><small>捐款筆數</small></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Placeholder -->
  <div id="adminPage" class="page-content hidden">
    <h3><i class="fas fa-cog"></i> 管理功能(示意)</h3>
    <p>可擴充：會員管理/活動管理/財務管理/系統設定。</p>
    <div id="adminContent"></div>
  </div>

  <!-- Board Placeholder -->
  <div id="boardPage" class="page-content hidden">
    <h3><i class="fas fa-gavel"></i> 理監事專區(示意)</h3>
    <p>可擴充：會議、提案、案件、動議管理。</p>
    <div id="boardContent"></div>
  </div>
</div>

<!-- Donation Modal -->
<div class="modal fade" id="donationModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="donationForm">
        <div class="modal-header"><h5 class="modal-title">新增捐款</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">金額 *</label>
          <input type="number" id="donationAmount" class="form-control mb-2" required min="1">
          <label class="form-label">方式</label>
          <select id="donationMethod" class="form-select mb-2">
            <option value="現金">現金</option>
            <option value="轉帳">轉帳</option>
            <option value="信用卡">信用卡</option>
          </select>
          <label class="form-label">日期</label>
          <input type="date" id="donationDate" class="form-control mb-2">
          <label class="form-label">備註</label>
          <textarea id="donationNote" class="form-control" rows="2"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
          <button class="btn btn-primary" type="submit"><i class="fas fa-save"></i> 送出</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Expense Modal -->
<div class="modal fade" id="expenseModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="expenseForm">
        <div class="modal-header"><h5 class="modal-title">支出申請</h5>
          <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">項目 *</label>
          <input type="text" id="expenseItem" class="form-control mb-2" required>
          <label class="form-label">金額 *</label>
          <input type="number" id="expenseAmount" class="form-control mb-2" required min="1">
          <label class="form-label">類別 *</label>
          <select id="expenseCategory" class="form-select mb-2">
            <option value="活動費用">活動費用</option>
            <option value="交通費">交通費</option>
            <option value="辦公用品">辦公用品</option>
            <option value="其他">其他</option>
          </select>
          <label class="form-label">日期</label>
          <input type="date" id="expenseDate" class="form-control mb-2">
          <label class="form-label">說明</label>
          <textarea id="expenseDescription" class="form-control" rows="2"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
          <button class="btn btn-primary" type="submit"><i class="fas fa-paper-plane"></i> 送出</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ============ 前端設定 ============
const LIFF_ID = '1656516134-VaGgmaPm';
const API_URL = 'https://script.google.com/macros/s/AKfycbyHpq99T9JXjBzulOz6SUQqRCJkHTM3_mLV3oFb8m1w-ARokp_r3r_kEzVchMhu1Ku8fQ/exec'; // e.g. https://script.google.com/macros/s/.../exec
const API_KEY = 'AAbb8520258185202581'; // 若後端 STRICT_SIGN=true 必須送

let currentUser = null;
let currentPage = 'dashboard';

// ------------- API Helper -------------
async function callAPI(action, data={}){
  const payload = {
    action,
    apiKey: API_KEY,
    ...data
  };
  const res = await fetch(API_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const json = await res.json();
  if(!json.success) throw new Error(json.message||'API失敗');
  return json.data;
}

// ------------- LIFF 初始化 -------------
async function initialize(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){
      liff.login();
      return;
    }
    const profile = await liff.getProfile();
    await callAPI('register',{
      lineId: profile.userId,
      lineName: profile.displayName,
      realName: profile.displayName
    });
    await loadProfile();
    await loadDashboard();
  }catch(e){
    showError('初始化失敗: '+e.message);
  }
}

// ------------- Profile -------------
async function loadProfile(){
  const profile = await liff.getProfile();
  const data = await callAPI('getProfile',{ lineId: profile.userId });
  currentUser = data;
  document.getElementById('userInfo').textContent =
    (data.realName||data.lineName) + ' (' + (data.memberType||'一般') + ')';
  if(data.isAdmin) document.getElementById('adminNav').style.display='block';
  if(data.isBoardMember) document.getElementById('boardNav').style.display='block';

  // 填表
  document.getElementById('lineName').value = data.lineName||'';
  document.getElementById('realName').value = data.realName||'';
  document.getElementById('phone').value = data.phone||'';
  document.getElementById('email').value = data.email||'';
  document.getElementById('birthday').value = data.birthday||'';
  document.getElementById('memberType').value = data.memberType||'一般';
  document.getElementById('address').value = data.address||'';
  document.getElementById('memberStatus').textContent = data.status||'-';
  document.getElementById('registerDate').textContent = formatDate(data.registerDate);
  document.getElementById('profileVolunteerHours').textContent = data.volunteerHours||0;
  document.getElementById('activityCount').textContent = data.activityCount||0;
  document.getElementById('lastActive').textContent = formatDate(data.lastActive);
}

document.getElementById('profileForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    const profile = await liff.getProfile();
    await callAPI('updateProfile',{
      lineId: profile.userId,
      realName: document.getElementById('realName').value,
      phone: document.getElementById('phone').value,
      email: document.getElementById('email').value,
      birthday: document.getElementById('birthday').value,
      memberType: document.getElementById('memberType').value,
      address: document.getElementById('address').value
    });
    showSuccess('更新成功');
    loadProfile();
  }catch(err){
    showError(err.message);
  }
});

// ------------- Dashboard -------------
async function loadDashboard(){
  const profile = await liff.getProfile();
  const [activities, regs, volunteers, donations] = await Promise.all([
    callAPI('getActivities',{ lineId: profile.userId }),
    callAPI('getMyRegistrations',{ lineId: profile.userId }),
    callAPI('getMyVolunteerRecords',{ lineId: profile.userId }),
    callAPI('getDonations',{ lineId: profile.userId })
  ]);
  document.getElementById('totalActivities').textContent =
    activities.filter(a=>a.status==='開放報名').length;
  document.getElementById('myRegistrations').textContent =
    regs.filter(r=>r.status==='已報名').length;
  document.getElementById('volunteerHours').textContent =
    volunteers.filter(v=>v.status==='已核准').reduce((s,v)=>s+(v.hours||0),0);
  document.getElementById('totalDonations').textContent = donations.length;

  loadRecentActivities(activities.slice(0,5));
}

function loadRecentActivities(list){
  const c = document.getElementById('recentActivities');
  if(!list || list.length===0){
    c.innerHTML='<p class="text-muted">暫無活動</p>';return;
  }
  c.innerHTML = list.map(a=>`
    <div class="border-bottom pb-2 mb-2">
      <strong>${a.name}</strong><br>
      <small class="text-muted"><i class="fas fa-calendar"></i> ${formatDate(a.activityDate)} / ${a.location||''}</small>
      <div><span class="badge ${statusClass(a.status)}">${a.status}</span></div>
    </div>
  `).join('');
}

// ------------- Activities -------------
async function loadActivities(){
  const profile = await liff.getProfile();
  const activities = await callAPI('getActivities',{ lineId: profile.userId });
  const regs = await callAPI('getMyRegistrations',{ lineId: profile.userId });
  renderActivities(activities);
  renderRegistrations(regs);
}

function renderActivities(list){
  const c = document.getElementById('activitiesList');
  if(!list || !list.length){
    c.innerHTML='<p class="text-muted">沒有活動</p>'; return;
  }
  c.innerHTML = list.map(a=>{
    const full = a.maxParticipants && a.currentCount>=a.maxParticipants;
    return `
      <div class="card mb-2 fade-in">
        <div class="card-body d-flex justify-content-between align-items-start">
          <div style="max-width:70%;">
            <h6>${a.name}</h6>
            <small class="text-muted"><i class="fas fa-calendar"></i> ${formatDate(a.activityDate)} / ${a.location||''}</small><br>
            <small class="text-muted">人數: ${a.currentCount}/${a.maxParticipants||'-'}  費用:${a.fee||0}</small>
          </div>
          <div class="text-end">
            <span class="badge ${statusClass(a.status)} mb-2">${a.status}</span><br>
            ${
              a.status==='開放報名' && !full
              ? `<button class="btn btn-sm btn-primary" onclick="registerActivity('${a.id}')"><i class="fas fa-plus"></i> 報名</button>`
              : (full ? '<span class="text-danger small">已額滿</span>' : '')
            }
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function renderRegistrations(regs){
  const c = document.getElementById('myRegistrationsList');
  if(!regs || !regs.length){
    c.innerHTML='<p class="text-muted">尚無報名</p>'; return;
  }
  c.innerHTML = `
    <div class="table-responsive">
      <table class="table table-sm">
        <thead><tr><th>活動</th><th>日期</th><th>狀態</th><th>操作</th></tr></thead>
        <tbody>
          ${
            regs.map(r=>`
              <tr>
                <td>${r.activityName}</td>
                <td>${formatDate(r.activityDate)}</td>
                <td><span class="badge ${statusClass(r.status)}">${r.status}</span></td>
                <td>
                  ${
                    r.status==='已報名'
                      ? `<button class="btn btn-sm btn-outline-danger" onclick="cancelRegistration('${r.id}')"><i class="fas fa-times"></i></button>`
                      : '-'
                  }
                </td>
              </tr>
            `).join('')
          }
        </tbody>
      </table>
    </div>
  `;
}

async function registerActivity(activityId){
  try{
    const profile = await liff.getProfile();
    await callAPI('registerActivity',{ lineId: profile.userId, activityId });
    showSuccess('報名成功');
    loadActivities();
  }catch(e){
    showError(e.message);
  }
}
async function cancelRegistration(regId){
  if(!confirm('確認取消?')) return;
  try{
    const profile = await liff.getProfile();
    await callAPI('cancelActivity',{ lineId: profile.userId, registrationId: regId });
    showSuccess('已取消');
    loadActivities();
  }catch(e){ showError(e.message); }
}

// ------------- Volunteer -------------
async function loadVolunteer(){
  const profile = await liff.getProfile();
  const [needs, records] = await Promise.all([
    callAPI('getVolunteerNeeds',{ lineId: profile.userId }),
    callAPI('getMyVolunteerRecords',{ lineId: profile.userId })
  ]);
  renderVolunteerNeeds(needs);
  renderVolunteerRecords(records);
}

function renderVolunteerNeeds(needs){
  const c = document.getElementById('volunteerNeedsList');
  if(!needs||!needs.length){
    c.innerHTML='<p class="text-muted">無需求</p>'; return;
  }
  c.innerHTML = needs.map(n=>`
    <div class="border-bottom pb-2 mb-2">
      <strong>${n.activityName}</strong> (${formatDate(n.activityDate)})<br>
      <small class="text-muted">${n.role||''} / 需求 ${n.currentCount}/${n.requiredCount}</small><br>
      <button class="btn btn-sm btn-primary mt-1" onclick="registerVolunteer('${n.activityId}','${n.role||'志工'}')">
        <i class="fas fa-hand-paper"></i> 服務
      </button>
    </div>
  `).join('');
}

function renderVolunteerRecords(records){
  const c = document.getElementById('myVolunteerRecords');
  if(!records||!records.length){
    c.innerHTML='<p class="text-muted">尚無紀錄</p>'; return;
  }
  c.innerHTML = `
    <div class="table-responsive">
      <table class="table table-sm">
        <thead><tr><th>活動</th><th>時數</th><th>狀態</th><th>日期</th></tr></thead>
        <tbody>
          ${
            records.map(r=>`
              <tr>
                <td>${r.activityName}</td>
                <td>${r.hours}</td>
                <td><span class="badge ${statusClass(r.status)}">${r.status}</span></td>
                <td>${formatDate(r.serviceDate)}</td>
              </tr>`).join('')
          }
        </tbody>
      </table>
    </div>
  `;
}

async function registerVolunteer(activityId, role){
  try{
    const profile = await liff.getProfile();
    await callAPI('registerVolunteer',{
      lineId: profile.userId,
      activityId,
      role: role||'志工',
      hours: 1
    });
    showSuccess('已提交，待審核');
    loadVolunteer();
  }catch(e){ showError(e.message); }
}

// ------------- Finance -------------
async function loadFinance(){
  const profile = await liff.getProfile();
  const [donations, expenses] = await Promise.all([
    callAPI('getDonations',{ lineId: profile.userId }),
    callAPI('getMyExpenses',{ lineId: profile.userId })
  ]);
  renderDonations(donations);
  renderExpenses(expenses);
  if(currentUser && currentUser.isAdmin){
    const overview = await callAPI('getFinanceOverview',{ operatorLineId: profile.userId });
    renderFinanceOverview(overview);
  }
}

function renderDonations(list){
  const c = document.getElementById('myDonationsList');
  if(!list||!list.length){ c.innerHTML='<p class="text-muted">尚無捐款</p>'; return; }
  c.innerHTML = `
    <div class="table-responsive">
      <table class="table table-sm">
        <thead><tr><th>日期</th><th>金額</th><th>方式</th><th>收據</th></tr></thead>
        <tbody>
          ${
            list.map(d=>`
              <tr>
                <td>${formatDate(d.donationDate)}</td>
                <td>$${d.amount}</td>
                <td>${d.method}</td>
                <td>${d.receiptId ? '<span class="badge bg-success">已開立</span>' : '-'}</td>
              </tr>`).join('')
          }
        </tbody>
      </table>
    </div>
  `;
}

function renderExpenses(list){
  const c = document.getElementById('myExpensesList');
  if(!list||!list.length){ c.innerHTML='<p class="text-muted">尚無支出</p>'; return; }
  c.innerHTML=`
    <div class="table-responsive">
      <table class="table table-sm">
        <thead><tr><th>日期</th><th>項目</th><th>金額</th><th>狀態</th></tr></thead>
        <tbody>
          ${
            list.map(e=>`
              <tr>
                <td>${formatDate(e.expenseDate)}</td>
                <td>${e.item}</td>
                <td>$${e.amount}</td>
                <td><span class="badge ${statusClass(e.status)}">${e.status}</span></td>
              </tr>`).join('')
          }
        </tbody>
      </table>
    </div>
  `;
}

function renderFinanceOverview(o){
  if(!o) return;
  document.getElementById('totalIncome').textContent='$'+o.totalIncome;
  document.getElementById('totalExpense').textContent='$'+o.totalExpense;
  document.getElementById('currentBalance').textContent='$'+o.balance;
  document.getElementById('donationCount').textContent=o.donationCount;
  document.getElementById('financeOverview').style.display='block';
}

// Donation modal
function showDonationModal(){
  document.getElementById('donationDate').value=new Date().toISOString().split('T')[0];
  new bootstrap.Modal(document.getElementById('donationModal')).show();
}
document.getElementById('donationForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    const profile = await liff.getProfile();
    await callAPI('addDonation',{
      lineId: profile.userId,
      amount: parseInt(document.getElementById('donationAmount').value),
      method: document.getElementById('donationMethod').value,
      donationDate: document.getElementById('donationDate').value,
      note: document.getElementById('donationNote').value
    });
    showSuccess('捐款成功');
    bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
    loadFinance();
  }catch(e){ showError(e.message); }
});

// Expense modal
function showExpenseModal(){
  document.getElementById('expenseDate').value=new Date().toISOString().split('T')[0];
  new bootstrap.Modal(document.getElementById('expenseModal')).show();
}
document.getElementById('expenseForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    const profile = await liff.getProfile();
    await callAPI('submitExpense',{
      lineId: profile.userId,
      item: document.getElementById('expenseItem').value,
      amount: parseInt(document.getElementById('expenseAmount').value),
      category: document.getElementById('expenseCategory').value,
      expenseDate: document.getElementById('expenseDate').value,
      description: document.getElementById('expenseDescription').value
    });
    showSuccess('申請成功');
    bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
    loadFinance();
  }catch(e){ showError(e.message); }
});

// ------------- Page Switch -------------
function showPage(p){
  document.querySelectorAll('.page-content').forEach(el=>el.classList.add('hidden'));
  const pageEl = document.getElementById(p+'Page');
  if(pageEl) pageEl.classList.remove('hidden');
  currentPage=p;
  if(p==='activities') loadActivities();
  else if(p==='volunteer') loadVolunteer();
  else if(p==='finance') loadFinance();
  else if(p==='profile') loadProfile();
  else if(p==='dashboard') loadDashboard();
}

// ------------- Utils -------------
function formatDate(d){
  if(!d) return '-';
  try{
    const date = new Date(d);
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
  }catch(e){ return d; }
}
function statusClass(s){
  if(['已註冊','開放報名','已核准','已完成'].includes(s)) return 'bg-success';
  if(['待審核','報名截止'].includes(s)) return 'bg-warning';
  if(['已取消','已拒絕','已結束'].includes(s)) return 'bg-danger';
  return 'bg-secondary';
}
function showError(msg){
  const a=document.getElementById('errorAlert');
  document.getElementById('errorMessage').textContent=msg;
  a.classList.remove('hidden');
  setTimeout(()=>a.classList.add('hidden'),4000);
}
function showSuccess(msg){
  const a=document.getElementById('successAlert');
  document.getElementById('successMessage').textContent=msg;
  a.classList.remove('hidden');
  setTimeout(()=>a.classList.add('hidden'),3000);
}

// ------------- Start -------------
window.addEventListener('load', ()=> initialize());
</script>
</body>
</html>
