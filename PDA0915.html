<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ± - å®Œæ•´ç‰ˆ</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
<style>
  /* å‰é¢çš„ CSS æ¨£å¼ä¿æŒä¸è®Š */
  :root {
    --primary-color: #667eea;
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-color: #48bb78;
    --warning-color: #ed8936;
    --error-color: #f56565;
    --text-color: #2d3748;
    --text-light: #718096;
    --bg-white: rgba(255, 255, 255, 0.95);
    --shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    --border-radius: 15px;
  }

  * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
  }
  
  body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--primary-gradient);
      min-height: 100vh;
      color: var(--text-color);
      line-height: 1.6;
  }
  
  .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
  }
  
  .header {
      background: var(--bg-white);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
  }
  
  .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-gradient);
  }
  
  .header h1 {
      color: var(--text-color);
      font-size: 28px;
      margin-bottom: 10px;
      font-weight: 700;
  }
  
  .header .subtitle {
      color: var(--text-light);
      font-size: 16px;
  }
  
  .user-info {
      background: var(--bg-white);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      transition: transform 0.2s ease;
  }
  
  .user-info:hover {
      transform: translateY(-2px);
  }
  
  .tabs {
      display: flex;
      background: var(--bg-white);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 8px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
  }
  
  .tabs::-webkit-scrollbar {
      display: none;
  }
  
  .tab {
      flex: 1;
      padding: 14px 18px;
      text-align: center;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      min-width: 100px;
      font-size: 14px;
      font-weight: 500;
      position: relative;
  }
  
  .tab.active {
      background: var(--primary-gradient);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      transform: translateY(-1px);
  }
  
  .tab:hover:not(.active) {
      background: rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
  }
  
  .tab-content {
      display: none;
      background: var(--bg-white);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 30px;
      box-shadow: var(--shadow);
      animation: fadeIn 0.5s ease;
  }
  
  .tab-content.active {
      display: block;
  }
  
  @keyframes fadeIn {
      from {
          opacity: 0;
          transform: translateY(20px);
      }
      to {
          opacity: 1;
          transform: translateY(0);
      }
  }
  
  .form-group {
      margin-bottom: 24px;
      position: relative;
  }
  
  .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-color);
      font-size: 14px;
  }
  
  .form-group input,
  .form-group select,
  .form-group textarea {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: white;
      font-family: inherit;
  }
  
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
  }
  
  .form-group.error input,
  .form-group.error select,
  .form-group.error textarea {
      border-color: var(--error-color);
      background: rgba(245, 101, 101, 0.05);
  }
  
  .validation-message {
      color: var(--error-color);
      font-size: 12px;
      margin-top: 5px;
      display: none;
      animation: slideDown 0.3s ease;
  }
  
  .form-group.error .validation-message {
      display: block;
  }
  
  @keyframes slideDown {
      from {
          opacity: 0;
          transform: translateY(-10px);
      }
      to {
          opacity: 1;
          transform: translateY(0);
      }
  }
  
  .btn {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 120px;
      text-decoration: none;
  }
  
  .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }
  
  .btn:active {
      transform: translateY(0);
  }
  
  .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
  }
  
  .btn.loading {
      pointer-events: none;
  }
  
  .btn.loading .btn-text {
      opacity: 0;
  }
  
  .btn.loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }
  
  .btn-secondary {
      background: #718096;
      box-shadow: 0 4px 12px rgba(113, 128, 150, 0.3);
  }
  
  .btn-danger {
      background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
      box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
  }
  
  .btn-small {
      padding: 8px 16px;
      font-size: 14px;
      min-width: 80px;
  }
  
  .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-left: 4px solid var(--primary-color);
      transition: all 0.3s ease;
      position: relative;
  }
  
  .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }
  
  .card h4 {
      color: var(--text-color);
      margin-bottom: 12px;
      font-size: 18px;
  }
  
  .card p {
      color: var(--text-light);
      margin-bottom: 8px;
  }
  
  .status {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
  }
  
  .status.registered {
      background: rgba(72, 187, 120, 0.1);
      color: var(--success-color);
      border: 1px solid rgba(72, 187, 120, 0.2);
  }
  
  .status.unregistered {
      background: rgba(245, 101, 101, 0.1);
      color: var(--error-color);
      border: 1px solid rgba(245, 101, 101, 0.2);
  }
  
  .status.approved {
      background: rgba(72, 187, 120, 0.1);
      color: var(--success-color);
      border: 1px solid rgba(72, 187, 120, 0.2);
  }
  
  .status.pending {
      background: rgba(237, 137, 54, 0.1);
      color: var(--warning-color);
      border: 1px solid rgba(237, 137, 54, 0.2);
  }
  
  .status.rejected {
      background: rgba(245, 101, 101, 0.1);
      color: var(--error-color);
      border: 1px solid rgba(245, 101, 101, 0.2);
  }
  
  .loading-container {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-light);
  }
  
  .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
  }
  
  .alert {
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border-left: 4px solid;
      animation: slideIn 0.3s ease;
  }
  
  @keyframes slideIn {
      from {
          opacity: 0;
          transform: translateX(-20px);
      }
      to {
          opacity: 1;
          transform: translateX(0);
      }
  }
  
  .alert.error {
      background: rgba(245, 101, 101, 0.1);
      color: #742a2a;
      border-color: var(--error-color);
  }
  
  .alert.success {
      background: rgba(72, 187, 120, 0.1);
      color: #22543d;
      border-color: var(--success-color);
  }
  
  .alert.warning {
      background: rgba(237, 137, 54, 0.1);
      color: #7b341e;
      border-color: var(--warning-color);
  }
  
  .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
  }
  
  .stat-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
  }
  
  .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-gradient);
  }
  
  .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }
  
  .stat-card .number {
      font-size: 36px;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 8px;
      line-height: 1;
  }
  
  .stat-card .label {
      color: var(--text-light);
      font-size: 14px;
      font-weight: 500;
  }
  
  .activity-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 20px;
      background: white;
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border-left: 4px solid var(--primary-color);
  }
  
  .activity-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }
  
  .activity-info h4 {
      color: var(--text-color);
      margin-bottom: 8px;
      font-size: 18px;
  }
  
  .activity-info p {
      color: var(--text-light);
      font-size: 14px;
      margin-bottom: 4px;
  }
  
  .activity-meta {
      display: flex;
      gap: 16px;
      margin-top: 12px;
  }
  
  .activity-meta span {
      background: rgba(102, 126, 234, 0.1);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      color: var(--primary-color);
      font-weight: 500;
  }
  
  .participants {
      background: #edf2f7;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: var(--text-color);
      font-weight: 500;
      margin-bottom: 8px;
  }
  
  .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
  }
  
  .quick-btn {
      background: var(--bg-white);
      border: 2px solid #e2e8f0;
      padding: 20px 16px;
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      color: var(--text-color);
      text-decoration: none;
      display: block;
  }
  
  .quick-btn:hover {
      border-color: var(--primary-color);
      background: white;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
  }
  
  .quick-btn .icon {
      font-size: 28px;
      margin-bottom: 8px;
      display: block;
  }
  
  .search-container {
      position: relative;
      margin-bottom: 24px;
  }
  
  .search-input {
      padding-right: 50px;
      background: white;
  }
  
  .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
      font-size: 18px;
  }
  
  .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 24px;
      flex-wrap: wrap;
  }
  
  .pagination button {
      padding: 10px 16px;
      border: 2px solid #e2e8f0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      min-width: 44px;
  }
  
  .pagination button:hover {
      background: rgba(102, 126, 234, 0.1);
      border-color: var(--primary-color);
  }
  
  .pagination button.active {
      background: var(--primary-gradient);
      color: white;
      border-color: var(--primary-color);
  }
  
  .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
  }
  
  .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 400px;
      backdrop-filter: blur(10px);
  }
  
  .notification.show {
      transform: translateX(0);
  }
  
  .notification.success {
      background: rgba(72, 187, 120, 0.95);
      color: white;
      border-left: 4px solid var(--success-color);
  }
  
  .notification.error {
      background: rgba(245, 101, 101, 0.95);
      color: white;
      border-left: 4px solid var(--error-color);
  }
  
  .notification.warning {
      background: rgba(237, 137, 54, 0.95);
      color: white;
      border-left: 4px solid var(--warning-color);
  }
  
  .notification-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
  }
  
  .notification-close {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      font-size: 20px;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s ease;
  }
  
  .notification-close:hover {
      background: rgba(255, 255, 255, 0.2);
  }
  
  .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-light);
  }
  
  .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
  }
  
  .empty-state h3 {
      margin-bottom: 8px;
      color: var(--text-color);
  }
  
  .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin: 12px 0;
  }
  
  .progress-fill {
      height: 100%;
      background: var(--primary-gradient);
      transition: width 0.3s ease;
      border-radius: 4px;
  }
  
  /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
  @media (max-width: 768px) {
      .container {
          padding: 12px;
      }
      
      .header {
          padding: 24px 20px;
      }
      
      .header h1 {
          font-size: 24px;
      }
      
      .tab {
          font-size: 13px;
          padding: 12px 14px;
          min-width: 90px;
      }
      
      .activity-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 16px;
      }
      
      .quick-actions {
          grid-template-columns: repeat(2, 1fr);
      }
      
      .grid {
          grid-template-columns: 1fr;
      }
      
      .notification {
          right: 12px;
          left: 12px;
          transform: translateY(-100px);
          max-width: none;
      }
      
      .notification.show {
          transform: translateY(0);
      }
      
      .btn {
          padding: 14px 24px;
          font-size: 15px;
      }
      
      .form-group input,
      .form-group select,
      .form-group textarea {
          padding: 12px 16px;
          font-size: 16px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
      }
  }
  
  @media (max-width: 480px) {
      .tabs {
          padding: 4px;
      }
      
      .tab {
          font-size: 12px;
          padding: 10px 8px;
          min-width: 70px;
      }
      
      .quick-btn {
          padding: 16px 12px;
      }
      
      .quick-btn .icon {
          font-size: 24px;
      }
      
      .stat-card .number {
          font-size: 28px;
      }
      
      .pagination {
          gap: 4px;
      }
      
      .pagination button {
          padding: 8px 12px;
          min-width: 36px;
      }
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
      <h1>ğŸ¥ å¸•é‡‘æ£®ç—…å‹æœƒ</h1>
      <p class="subtitle">æœƒå“¡ç®¡ç†ç³»çµ± - å®Œæ•´ç‰ˆ v2.1</p>
  </div>

  <div id="user-info" class="user-info" style="display: none;">
      <h3>ğŸ‘¤ å€‹äººè³‡è¨Š</h3>
      <div id="user-details"></div>
  </div>

  <div class="quick-actions">
      <div class="quick-btn" onclick="showTab('profile')" tabindex="0" role="button" aria-label="å€‹äººæª”æ¡ˆ">
          <span class="icon">ğŸ‘¤</span>
          å€‹äººæª”æ¡ˆ
      </div>
      <div class="quick-btn" onclick="showTab('activities')" tabindex="0" role="button" aria-label="æ´»å‹•å ±å">
          <span class="icon">ğŸ¯</span>
          æ´»å‹•å ±å
      </div>
      <div class="quick-btn" onclick="showTab('donations')" tabindex="0" role="button" aria-label="ææ¬¾è¨˜éŒ„">
          <span class="icon">ğŸ’°</span>
          ææ¬¾è¨˜éŒ„
      </div>
      <div class="quick-btn" onclick="showTab('finance')" tabindex="0" role="button" aria-label="è²¡å‹™ç®¡ç†">
          <span class="icon">ğŸ“Š</span>
          è²¡å‹™ç®¡ç†
      </div>
  </div>

  <div class="tabs" role="tablist">
      <div class="tab active" onclick="showTab('profile')" role="tab" aria-selected="true" tabindex="0">å€‹äººæª”æ¡ˆ</div>
      <div class="tab" onclick="showTab('activities')" role="tab" aria-selected="false" tabindex="0">æ´»å‹•ç®¡ç†</div>
      <div class="tab" onclick="showTab('donations')" role="tab" aria-selected="false" tabindex="0">ææ¬¾è¨˜éŒ„</div>
      <div class="tab" onclick="showTab('finance')" role="tab" aria-selected="false" tabindex="0">è²¡å‹™ç®¡ç†</div>
      <div class="tab" onclick="showTab('feedback')" role="tab" aria-selected="false" tabindex="0">æ´»å‹•å›é¥‹</div>
      <div class="tab admin-only" onclick="showTab('admin')" role="tab" aria-selected="false" tabindex="0" style="display: none;">ç®¡ç†åŠŸèƒ½</div>
  </div>

  <!-- å€‹äººæª”æ¡ˆé é¢ -->
  <div id="profile-tab" class="tab-content active" role="tabpanel">
      <h3>ğŸ“ æœƒå“¡è¨»å†Š / å€‹äººè³‡æ–™</h3>
      
      <div id="registration-form">
          <div class="form-group">
              <label for="realName">çœŸå¯¦å§“å *</label>
              <input type="text" id="realName" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å" required aria-describedby="realName-error">
              <div class="validation-message" id="realName-error">è«‹è¼¸å…¥æœ‰æ•ˆçš„å§“å</div>
          </div>
          
          <div class="form-group">
              <label for="memberType">æœƒå“¡é¡åˆ¥ *</label>
              <select id="memberType" required aria-describedby="memberType-error">
                  <option value="">è«‹é¸æ“‡æœƒå“¡é¡åˆ¥</option>
                  <option value="patient">ç—…å‹</option>
                  <option value="family">å®¶å±¬</option>
                  <option value="volunteer">å¿—å·¥</option>
                  <option value="medical">é†«è­·äººå“¡</option>
                  <option value="supporter">æ”¯æŒè€…</option>
              </select>
              <div class="validation-message" id="memberType-error">è«‹é¸æ“‡æœƒå“¡é¡åˆ¥</div>
          </div>
          
          <button class="btn" onclick="registerUser()" id="register-btn">
              <span class="btn-text">è¨»å†Šæœƒå“¡</span>
          </button>
      </div>

      <div id="contact-form" style="display: none;">
          <h4>ğŸ“ è¯çµ¡è³‡è¨Šæ›´æ–°</h4>
          <div class="form-group">
              <label for="phone">é›»è©±</label>
              <input type="tel" id="phone" placeholder="ä¾‹ï¼š0912345678" pattern="[0-9]{10}">
              <div class="validation-message">è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼</div>
          </div>
          
          <div class="form-group">
              <label for="email">é›»å­éƒµä»¶</label>
              <input type="email" id="email" placeholder="ä¾‹ï¼šuser@example.com">
              <div class="validation-message">è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€</div>
          </div>
          
          <div class="form-group">
              <label for="address">åœ°å€</label>
              <input type="text" id="address" placeholder="è«‹è¼¸å…¥åœ°å€">
          </div>
          
          <div class="form-group">
              <label for="birthday">ç”Ÿæ—¥</label>
              <input type="date" id="birthday">
          </div>
          
          <button class="btn" onclick="updateContact()" id="update-btn">
              <span class="btn-text">æ›´æ–°è¯çµ¡è³‡è¨Š</span>
          </button>
      </div>
  </div>

  <!-- æ´»å‹•ç®¡ç†é é¢ -->
  <div id="activities-tab" class="tab-content" role="tabpanel">
      <h3>ğŸ¯ æ´»å‹•å ±åç®¡ç†</h3>
      
      <div class="grid">
          <div class="stat-card">
              <div class="number" id="total-activities">0</div>
              <div class="label">å¯å ±åæ´»å‹•</div>
          </div>
          <div class="stat-card">
                <div class="number" id="my-registrations">0</div>
                <div class="label">æˆ‘çš„å ±å</div>
            </div>
        </div>

        <div class="search-container">
            <input type="text" class="form-control search-input" id="activity-search" placeholder="æœå°‹æ´»å‹•...">
            <span class="search-icon">ğŸ”</span>
        </div>

        <h4>ğŸ“… å¯å ±åæ´»å‹•</h4>
        <div id="activities-list" class="loading-container">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
        </div>
        <div id="activities-pagination" class="pagination"></div>

        <h4>ğŸ“‹ æˆ‘çš„æ´»å‹•å ±å</h4>
        <div id="my-activities-list" class="loading-container">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- ææ¬¾è¨˜éŒ„é é¢ -->
    <div id="donations-tab" class="tab-content" role="tabpanel">
        <h3>ğŸ’° ææ¬¾è¨˜éŒ„</h3>
        
        <div class="grid">
            <div class="stat-card">
                <div class="number" id="total-donations">0</div>
                <div class="label">ææ¬¾ç­†æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="number" id="total-amount">NT$ 0</div>
                <div class="label">ææ¬¾ç¸½é¡</div>
            </div>
        </div>

        <h4>ğŸ’ æ–°å¢ææ¬¾è¨˜éŒ„</h4>
        <div class="form-group">
            <label for="donation-amount">ææ¬¾é‡‘é¡</label>
            <input type="number" id="donation-amount" placeholder="è«‹è¼¸å…¥ææ¬¾é‡‘é¡" min="1">
        </div>
        
        <div class="form-group">
            <label for="donor-name">ææ¬¾äººå§“å</label>
            <input type="text" id="donor-name" placeholder="è«‹è¼¸å…¥ææ¬¾äººå§“å">
        </div>
        
        <div class="form-group">
            <label for="donation-notes">å‚™è¨»</label>
            <textarea id="donation-notes" placeholder="ææ¬¾ç”¨é€”æˆ–å‚™è¨»" rows="3"></textarea>
        </div>
        
        <button class="btn" onclick="addDonation()" id="donation-btn">
            <span class="btn-text">æ–°å¢ææ¬¾è¨˜éŒ„</span>
        </button>

        <h4>ğŸ“Š æˆ‘çš„ææ¬¾è¨˜éŒ„</h4>
        <div id="donations-list" class="loading-container">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- è²¡å‹™ç®¡ç†é é¢ -->
    <div id="finance-tab" class="tab-content" role="tabpanel">
        <h3>ğŸ“Š è²¡å‹™ç®¡ç†</h3>
        
        <h4>ğŸ’³ å¸³æˆ¶é¤˜é¡</h4>
        <div id="accounts-list" class="loading-container">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
        </div>

        <h4>ğŸ“ˆ é ç®—ä½¿ç”¨ç‹€æ³</h4>
        <div id="budget-status" class="loading-container">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
        </div>

        <h4>ğŸ’¸ æ”¯å‡ºç”³è«‹</h4>
        <div class="form-group">
            <label for="expense-category">æ”¯å‡ºé¡åˆ¥</label>
            <select id="expense-category">
                <option value="activity">æ´»å‹•æ”¯å‡º</option>
                <option value="office">è¾¦å…¬è²»ç”¨</option>
                <option value="marketing">å®£å‚³è²»ç”¨</option>
                <option value="equipment">è¨­å‚™è²»ç”¨</option>
                <option value="welfare">ç¦åˆ©æ”¯å‡º</option>
                <option value="medical">é†«ç™‚æ”¯æ´</option>
                <option value="volunteer">å¿—å·¥è²»ç”¨</option>
                <option value="other">å…¶ä»–æ”¯å‡º</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="expense-amount">é‡‘é¡</label>
            <input type="number" id="expense-amount" placeholder="è«‹è¼¸å…¥é‡‘é¡" min="0">
        </div>
        
        <div class="form-group">
            <label for="expense-description">èªªæ˜</label>
            <textarea id="expense-description" placeholder="è«‹è©³ç´°èªªæ˜æ”¯å‡ºç”¨é€”" rows="3"></textarea>
        </div>
        
        <button class="btn" onclick="submitExpense()" id="expense-btn">
            <span class="btn-text">æäº¤æ”¯å‡ºç”³è«‹</span>
        </button>

        <h4>ğŸ“‹ æˆ‘çš„æ”¯å‡ºç”³è«‹</h4>
        <div id="my-expenses" class="loading-container">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- æ´»å‹•å›é¥‹é é¢ -->
    <div id="feedback-tab" class="tab-content" role="tabpanel">
        <h3>ğŸ“ æ´»å‹•å›é¥‹</h3>
        
        <div class="form-group">
            <label for="feedback-activity">é¸æ“‡æ´»å‹•</label>
            <select id="feedback-activity">
                <option value="">è«‹é¸æ“‡å·²åƒèˆ‡çš„æ´»å‹•</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="feedback-rating">è©•åˆ† (1-5åˆ†)</label>
            <select id="feedback-rating">
                <option value="">è«‹é¸æ“‡è©•åˆ†</option>
                <option value="1">1åˆ† - å¾ˆä¸æ»¿æ„</option>
                <option value="2">2åˆ† - ä¸æ»¿æ„</option>
                <option value="3">3åˆ† - æ™®é€š</option>
                <option value="4">4åˆ† - æ»¿æ„</option>
                <option value="5">5åˆ† - éå¸¸æ»¿æ„</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="feedback-comment">æ„è¦‹èˆ‡å»ºè­°</label>
            <textarea id="feedback-comment" placeholder="è«‹åˆ†äº«æ‚¨çš„åƒèˆ‡å¿ƒå¾—èˆ‡å»ºè­°" rows="4"></textarea>
        </div>
        
        <button class="btn" onclick="submitFeedback()" id="feedback-btn">
            <span class="btn-text">æäº¤å›é¥‹</span>
        </button>

        <h4>ğŸ“Š æˆ‘çš„å›é¥‹è¨˜éŒ„</h4>
        <div id="my-feedback" class="loading-container">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- ç®¡ç†åŠŸèƒ½é é¢ -->
    <div id="admin-tab" class="tab-content" role="tabpanel">
        <h3>ğŸ”§ ç®¡ç†åŠŸèƒ½</h3>
        
        <div class="grid">
            <div class="stat-card">
                <div class="number" id="total-members">0</div>
                <div class="label">ç¸½æœƒå“¡æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="number" id="registered-members">0</div>
                <div class="label">å·²è¨»å†Šæœƒå“¡</div>
            </div>
            <div class="stat-card">
                <div class="number" id="active-activities">0</div>
                <div class="label">é€²è¡Œä¸­æ´»å‹•</div>
            </div>
            <div class="stat-card">
                <div class="number" id="total-registrations">0</div>
                <div class="label">ç¸½å ±åæ•¸</div>
            </div>
        </div>

        <h4>ğŸ¯ æ´»å‹•å»ºç«‹</h4>
        <div class="form-group">
            <label for="activity-name">æ´»å‹•åç¨±</label>
            <input type="text" id="activity-name" placeholder="è«‹è¼¸å…¥æ´»å‹•åç¨±">
        </div>
        
        <div class="form-group">
            <label for="activity-description">æ´»å‹•æè¿°</label>
            <textarea id="activity-description" placeholder="è«‹æè¿°æ´»å‹•å…§å®¹" rows="3"></textarea>
        </div>
        
        <div class="form-group">
            <label for="activity-date">æ´»å‹•æ—¥æœŸ</label>
            <input type="datetime-local" id="activity-date">
        </div>
        
        <div class="form-group">
            <label for="activity-location">æ´»å‹•åœ°é»</label>
            <input type="text" id="activity-location" placeholder="è«‹è¼¸å…¥æ´»å‹•åœ°é»">
        </div>
        
        <div class="form-group">
            <label for="activity-max-participants">æœ€å¤§äººæ•¸</label>
            <input type="number" id="activity-max-participants" placeholder="ä¸é™åˆ¶è«‹ç•™ç©º" min="1">
        </div>
        
        <div class="form-group">
            <label for="activity-fee">æ´»å‹•è²»ç”¨</label>
            <input type="number" id="activity-fee" placeholder="å…è²»è«‹è¼¸å…¥0" min="0">
        </div>
        
        <button class="btn" onclick="createActivity()" id="create-activity-btn">
            <span class="btn-text">å»ºç«‹æ´»å‹•</span>
        </button>

        <h4>ğŸ‘¥ æœƒå“¡ç®¡ç†</h4>
        <div class="form-group">
            <input type="text" id="member-search" placeholder="æœå°‹æœƒå“¡ï¼ˆå§“åæˆ–LINE IDï¼‰">
        </div>
        <div class="form-group">
            <select id="member-type-filter">
                <option value="">æ‰€æœ‰æœƒå“¡é¡åˆ¥</option>
                <option value="patient">ç—…å‹</option>
                <option value="family">å®¶å±¬</option>
                <option value="volunteer">å¿—å·¥</option>
                <option value="medical">é†«è­·äººå“¡</option>
                <option value="supporter">æ”¯æŒè€…</option>
            </select>
        </div>
        <button class="btn btn-secondary" onclick="searchMembers()">æœå°‹æœƒå“¡</button>
        
        <div id="members-list" class="loading-container">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
        </div>

        <h4>ğŸ’¸ æ”¯å‡ºå¯©æ ¸</h4>
        <div id="pending-expenses" class="loading-container">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
        </div>

        <h4>ğŸ“Š è²¡å‹™å ±è¡¨</h4>
        <div class="form-group">
            <label for="report-year">å¹´ä»½</label>
            <input type="number" id="report-year" value="2024" min="2020" max="2030">
        </div>
        <div class="form-group">
            <label for="report-month">æœˆä»½</label>
            <select id="report-month">
                <option value="1">1æœˆ</option>
                <option value="2">2æœˆ</option>
                <option value="3">3æœˆ</option>
                <option value="4">4æœˆ</option>
                <option value="5">5æœˆ</option>
                <option value="6">6æœˆ</option>
                <option value="7">7æœˆ</option>
                <option value="8">8æœˆ</option>
                <option value="9">9æœˆ</option>
                <option value="10">10æœˆ</option>
                <option value="11">11æœˆ</option>
                <option value="12">12æœˆ</option>
            </select>
        </div>
        <button class="btn" onclick="generateReport()">ç”¢ç”Ÿå ±è¡¨</button>
        
        <div id="finance-report"></div>
    </div>
</div>

<script>
  // ç³»çµ±é…ç½®
  const CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycbwvZ2ziqZsEDBUd3dbq6YDgb3tPMQElgsudw-y8rT8dFEXx2QFtLudxnBs6LD-T0poAJw/exec',
      API_KEY: 'AAbb8520258185202581',
      STRICT_SIGN: false,
      RETRY_ATTEMPTS: 3,
      RETRY_DELAY: 1000
  };

  // å…¨åŸŸè®Šæ•¸
  let currentUser = null;
  let isAdmin = false;
  let currentPage = 1;
  let itemsPerPage = 10;
  let allActivities = [];
  let myActivities = [];

  // LIFF åˆå§‹åŒ–
  async function initializeLiff() {
      try {
          showNotification('æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...', 'info', 2000);
          
          await liff.init({ liffId: CONFIG.LIFF_ID });
          
          if (!liff.isLoggedIn()) {
              liff.login();
              return;
          }

          const profile = await liff.getProfile();
          await createUserIfNotExist(profile.userId, profile.displayName);
          await loadUserInfo();
          
          showNotification('ç³»çµ±åˆå§‹åŒ–æˆåŠŸï¼', 'success');
      } catch (error) {
          console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
          showNotification('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
      }
  }

  // API å‘¼å«å‡½å¼ï¼ˆå«é‡è©¦æ©Ÿåˆ¶ï¼‰
  async function callAPI(action, data = {}) {
      for (let attempt = 1; attempt <= CONFIG.RETRY_ATTEMPTS; attempt++) {
          try {
              const payload = {
                  action,
                  ...data,
                  apiKey: CONFIG.API_KEY,
                  ts: Date.now(),
                  nonce: Math.random().toString(36).substring(2)
              };

              if (CONFIG.STRICT_SIGN) {
                  const baseString = `${action}|${payload.ts}|${payload.nonce}|${CONFIG.API_KEY}`;
                  const signature = CryptoJS.HmacSHA256(baseString, CONFIG.API_KEY).toString();
                  payload.sign = signature;
              }

              const response = await fetch(CONFIG.API_BASE_URL, {
                  method: 'POST',
                  headers: { 
                      'Content-Type': 'application/json',
                      'Cache-Control': 'no-cache'
                  },
                  body: JSON.stringify(payload)
              });

              if (!response.ok) {
                  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }

              const result = await response.json();
              
              if (result.success === false && result.statusCode >= 500) {
                  throw new Error(result.message || 'Server error');
              }
              
              return result;
              
          } catch (error) {
              console.error(`API å‘¼å«å¤±æ•— (å˜—è©¦ ${attempt}/${CONFIG.RETRY_ATTEMPTS}):`, error);
              
              if (attempt === CONFIG.RETRY_ATTEMPTS) {
                  throw new Error(`API å‘¼å«å¤±æ•—: ${error.message}`);
              }
              
              await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * attempt));
          }
      }
  }

  // å»ºç«‹ä½¿ç”¨è€…ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  async function createUserIfNotExist(lineId, lineName) {
      try {
          await callAPI('createUserIfNotExist', { lineId, lineName });
      } catch (error) {
          console.error('å»ºç«‹ä½¿ç”¨è€…å¤±æ•—:', error);
          throw error;
      }
  }

  // è¡¨å–®é©—è­‰
  function validateForm(containerId) {
      const container = containerId ? document.getElementById(containerId) : document;
      const inputs = container.querySelectorAll('input[required], select[required]');
      let isValid = true;

      inputs.forEach(input => {
          const formGroup = input.closest('.form-group');
          const errorMessage = formGroup.querySelector('.validation-message');
          
          // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤ç‹€æ…‹
          formGroup.classList.remove('error');
          if (errorMessage) errorMessage.style.display = 'none';
          
          // æª¢æŸ¥å¿…å¡«æ¬„ä½
          if (!input.value.trim()) {
              formGroup.classList.add('error');
              if (errorMessage) {
                  errorMessage.textContent = 'æ­¤æ¬„ä½ç‚ºå¿…å¡«';
                  errorMessage.style.display = 'block';
              }
              isValid = false;
              return;
          }
          
          // ç‰¹å®šæ¬„ä½é©—è­‰
          if (input.type === 'email' && !isValidEmail(input.value)) {
              formGroup.classList.add('error');
              if (errorMessage) {
                  errorMessage.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€';
                  errorMessage.style.display = 'block';
              }
              isValid = false;
          }
          
          if (input.type === 'tel' && !isValidPhone(input.value)) {
              formGroup.classList.add('error');
              if (errorMessage) {
                  errorMessage.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼';
                  errorMessage.style.display = 'block';
              }
              isValid = false;
          }
          
          if (input.type === 'number' && input.hasAttribute('min')) {
              const min = parseFloat(input.getAttribute('min'));
              if (parseFloat(input.value) < min) {
                  formGroup.classList.add('error');
                  if (errorMessage) {
                      errorMessage.textContent = `æ•¸å€¼ä¸èƒ½å°æ–¼ ${min}`;
                      errorMessage.style.display = 'block';
                  }
                  isValid = false;
              }
          }
      });

      return isValid;
  }

  function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
  }

  function isValidPhone(phone) {
      const phoneRegex = /^[0-9]{10}$/;
      return phoneRegex.test(phone.replace(/\D/g, ''));
  }

  // æŒ‰éˆ•è¼‰å…¥ç‹€æ…‹
  function setButtonLoading(buttonId, loading = true) {
      const button = document.getElementById(buttonId);
      if (!button) return;

      if (loading) {
          button.classList.add('loading');
          button.disabled = true;
      } else {
          button.classList.remove('loading');
          button.disabled = false;
      }
  }

  // é€šçŸ¥ç³»çµ±
  function showNotification(message, type = 'info', duration = 4000) {
      // ç§»é™¤ç¾æœ‰é€šçŸ¥
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
          existingNotification.remove();
      }
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
          <div class="notification-content">
              <span>${message}</span>
              <button class="notification-close" onclick="this.parentElement.parentElement.remove()" aria-label="é—œé–‰é€šçŸ¥">&times;</button>
          </div>
      `;
      
      document.body.appendChild(notification);
      
      // é¡¯ç¤ºå‹•ç•«
      setTimeout(() => notification.classList.add('show'), 100);
      
      // è‡ªå‹•éš±è—
      if (duration > 0) {
          setTimeout(() => {
              notification.classList.remove('show');
              setTimeout(() => notification.remove(), 300);
          }, duration);
      }
  }

  // æœƒå“¡è¨»å†Š
  async function registerUser() {
      if (!validateForm('registration-form')) {
          showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
          return;
      }

      const realName = document.getElementById('realName').value.trim();
      const memberType = document.getElementById('memberType').value;

      setButtonLoading('register-btn', true);

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('register', {
              lineId: profile.userId,
              realName,
              memberType
          });

          if (result.success) {
              showNotification('è¨»å†ŠæˆåŠŸï¼æ­¡è¿åŠ å…¥å¸•é‡‘æ£®ç—…å‹æœƒ', 'success');
              await loadUserInfo();
          } else {
              showNotification(`è¨»å†Šå¤±æ•—ï¼š${result.message}`, 'error');
          }
      } catch (error) {
          console.error('è¨»å†Šå¤±æ•—:', error);
          showNotification('è¨»å†Šéç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      } finally {
          setButtonLoading('register-btn', false);
      }
  }

  // æ›´æ–°è¯çµ¡è³‡è¨Š
  async function updateContact() {
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const address = document.getElementById('address').value.trim();
      const birthday = document.getElementById('birthday').value;

      // é©—è­‰æ ¼å¼
      if (phone && !isValidPhone(phone)) {
          showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼', 'error');
          return;
      }

      if (email && !isValidEmail(email)) {
          showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€', 'error');
          return;
      }

      setButtonLoading('update-btn', true);

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('updateUserContact', {
              operatorLineId: profile.userId,
              targetLineId: profile.userId,
              phone,
              email,
              address,
              birthday
          });

          if (result.success) {
              showNotification('è¯çµ¡è³‡è¨Šæ›´æ–°æˆåŠŸï¼', 'success');
              await loadUserInfo();
          } else {
              showNotification(`æ›´æ–°å¤±æ•—ï¼š${result.message}`, 'error');
          }
      } catch (error) {
          console.error('æ›´æ–°è¯çµ¡è³‡è¨Šå¤±æ•—:', error);
          showNotification('æ›´æ–°éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      } finally {
          setButtonLoading('update-btn', false);
      }
  }

  // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
  async function loadUserInfo() {
      try {
          const profile = await liff.getProfile();
          const result = await callAPI('getUserInfo', { lineId: profile.userId });
          
          if (result.success === false) {
              showNotification('ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š', 'error');
              return;
          }

          currentUser = result;
          isAdmin = result.isAdmin || false;
          
          updateUserInfoDisplay();
          updateUIBasedOnUserStatus();
          
      } catch (error) {
          console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—:', error);
          showNotification('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—', 'error');
      }
  }

  function updateUserInfoDisplay() {
      if (!currentUser) return;

      const userInfoDiv = document.getElementById('user-info');
      const userDetailsDiv = document.getElementById('user-details');
      
      const memberTypeMap = {
          'patient': 'ç—…å‹',
          'family': 'å®¶å±¬',
          'volunteer': 'å¿—å·¥',
          'medical': 'é†«è­·äººå“¡',
          'supporter': 'æ”¯æŒè€…'
      };
      
      userDetailsDiv.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
              <div><strong>å§“å:</strong> ${currentUser.realName || 'æœªè¨­å®š'}</div>
              <div><strong>LINE åç¨±:</strong> ${currentUser.lineName || 'æœªçŸ¥'}</div>
              <div><strong>ç‹€æ…‹:</strong> <span class="status ${currentUser.status === 'å·²è¨»å†Š' ? 'registered' : 'unregistered'}">${currentUser.status}</span></div>
              <div><strong>æœƒå“¡é¡åˆ¥:</strong> ${memberTypeMap[currentUser.memberType] || currentUser.memberType || 'æœªè¨­å®š'}</div>
              <div><strong>äº’å‹•æ¬¡æ•¸:</strong> ${currentUser.messageCount || 0} æ¬¡</div>
              ${isAdmin ? '<div><strong>æ¬Šé™:</strong> <span class="status approved">ç®¡ç†å“¡</span></div>' : ''}
          </div>
      `;
      
      userInfoDiv.style.display = 'block';
  }

  function updateUIBasedOnUserStatus() {
      const registrationForm = document.getElementById('registration-form');
      const contactForm = document.getElementById('contact-form');
      const adminTab = document.querySelector('.admin-only');

      if (currentUser && currentUser.status === 'å·²è¨»å†Š') {
          registrationForm.style.display = 'none';
          contactForm.style.display = 'block';
          
          // å¡«å…¥ç¾æœ‰è¯çµ¡è³‡è¨Š
          document.getElementById('phone').value = currentUser.phone || '';
          document.getElementById('email').value = currentUser.email || '';
          document.getElementById('address').value = currentUser.address || '';
          document.getElementById('birthday').value = currentUser.birthday || '';
      } else {
          registrationForm.style.display = 'block';
          contactForm.style.display = 'none';
      }

      if (isAdmin) {
          adminTab.style.display = 'block';
      }
  }

  // åˆ†é åˆ‡æ›
  function showTab(tabName) {
      // æ›´æ–° ARIA å±¬æ€§å’Œæ¨£å¼
      document.querySelectorAll('.tab').forEach(tab => {
          tab.setAttribute('aria-selected', 'false');
          tab.classList.remove('active');
      });
      
      document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
      });
      
      const targetContent = document.getElementById(`${tabName}-tab`);
      const targetTab = document.querySelector(`.tab[onclick="showTab('${tabName}')"]`);
      
      if (targetContent && targetTab) {
          targetContent.classList.add('active');
          targetTab.classList.add('active');
          targetTab.setAttribute('aria-selected', 'true');
      }
      
      // è¼‰å…¥åˆ†é è³‡æ–™
      loadTabData(tabName);
  }

  async function loadTabData(tabName) {
      try {
          switch (tabName) {
              case 'activities':
                  await Promise.all([loadActivities(), loadMyActivities()]);
                  break;
              case 'donations':
                  await loadDonations();
                  break;
              case 'finance':
                  await loadFinanceData();
                  break;
              case 'feedback':
                  await loadFeedbackData();
                  break;
              case 'admin':
                  if (isAdmin) {
                      await loadAdminData();
                  }
                  break;
          }
      } catch (error) {
          console.error(`è¼‰å…¥ ${tabName} è³‡æ–™å¤±æ•—:`, error);
          showNotification(`è¼‰å…¥ ${tabName} è³‡æ–™å¤±æ•—`, 'error');
      }
  }

  // è¼‰å…¥æ´»å‹•åˆ—è¡¨
  async function loadActivities() {
      try {
          const result = await callAPI('getActivities');
          const activitiesList = document.getElementById('activities-list');
          
          if (!result || !Array.isArray(result) || result.length === 0) {
              activitiesList.innerHTML = `
                  <div class="empty-state">
                      <div class="icon">ğŸ¯</div>
                      <h3>ç›®å‰æ²’æœ‰é–‹æ”¾çš„æ´»å‹•</h3>
                      <p>è«‹ç¨å¾Œå†ä¾†æŸ¥çœ‹æœ€æ–°æ´»å‹•è³‡è¨Š</p>
                  </div>
              `;
              document.getElementById('total-activities').textContent = '0';
              return;
          }

          allActivities = result;
          document.getElementById('total-activities').textContent = result.length;
          renderActivities(result);
          
      } catch (error) {
          console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', error);
          document.getElementById('activities-list').innerHTML = `
              <div class="alert error">
                  <strong>è¼‰å…¥å¤±æ•—</strong><br>
                  ç„¡æ³•è¼‰å…¥æ´»å‹•è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦
              </div>
          `;
      }
  }

  function renderActivities(activities, page = 1) {
      const activitiesList = document.getElementById('activities-list');
      const startIndex = (page - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedActivities = activities.slice(startIndex, endIndex);

      if (paginatedActivities.length === 0) {
          activitiesList.innerHTML = `
              <div class="empty-state">
                  <div class="icon">ğŸ”</div>
                  <h3>æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æ´»å‹•</h3>
                  <p>è«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶</p>
              </div>
          `;
          return;
      }

      let html = '';
      paginatedActivities.forEach(activity => {
          const dateStr = activity.date ? new Date(activity.date).toLocaleDateString('zh-TW', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              weekday: 'short'
          }) : 'å¾…å®š';
          
          const participantsText = `${activity.currentParticipants || 0}/${activity.maxParticipants || 'ä¸é™'}`;
          const isFull = activity.maxParticipants && (activity.currentParticipants || 0) >= activity.maxParticipants;
          
          html += `
              <div class="activity-item">
                  <div class="activity-info">
activity.name}</h4>
                      <p>ğŸ“… ${dateStr} | ğŸ“ ${activity.location || 'å¾…å®š'}</p>
                      <p>${activity.description || ''}</p>
                      <div class="activity-meta">
                          ${activity.fee ? `<span>ğŸ’° NT$ ${activity.fee}</span>` : '<span>ğŸ†“ å…è²»</span>'}
                          <span>ğŸ‘¥ ${participantsText}</span>
                      </div>
                  </div>
                  <div style="text-align: right;">
                      ${!isFull ? 
                          `<button class="btn btn-small" onclick="registerActivity('${activity.id}', '${activity.name}')">å ±ååƒåŠ </button>` : 
                          '<span class="status rejected">å·²é¡æ»¿</span>'
                      }
                  </div>
              </div>
          `;
      });

      activitiesList.innerHTML = html;
      renderPagination('activities-pagination', activities.length, page, (newPage) => renderActivities(activities, newPage));
  }

  // æ´»å‹•å ±å
  async function registerActivity(activityId, activityName) {
      if (!currentUser || currentUser.status !== 'å·²è¨»å†Š') {
          showNotification('è«‹å…ˆå®Œæˆæœƒå“¡è¨»å†Šæ‰èƒ½å ±åæ´»å‹•', 'warning');
          showTab('profile');
          return;
      }

      if (!confirm(`ç¢ºå®šè¦å ±åã€Œ${activityName}ã€å—ï¼Ÿ`)) {
          return;
      }

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('registerActivity', {
              lineId: profile.userId,
              activityId: activityId,
              participantName: currentUser.realName
          });

          if (result.success) {
              showNotification('æ´»å‹•å ±åæˆåŠŸï¼', 'success');
              await Promise.all([loadActivities(), loadMyActivities()]);
          } else {
              showNotification(`å ±åå¤±æ•—ï¼š${result.message}`, 'error');
          }
      } catch (error) {
          console.error('æ´»å‹•å ±åå¤±æ•—:', error);
          showNotification('å ±åéç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      }
  }

  // è¼‰å…¥æˆ‘çš„æ´»å‹•
  async function loadMyActivities() {
      try {
          const profile = await liff.getProfile();
          const result = await callAPI('getUserActivities', { lineId: profile.userId });
          const myActivitiesList = document.getElementById('my-activities-list');
          
          if (!result || !Array.isArray(result) || result.length === 0) {
              myActivitiesList.innerHTML = `
                  <div class="empty-state">
                      <div class="icon">ğŸ“‹</div>
                      <h3>æ‚¨ç›®å‰æ²’æœ‰å ±åä»»ä½•æ´»å‹•</h3>
                      <p>å¿«å»å ±åæ„Ÿèˆˆè¶£çš„æ´»å‹•å§ï¼</p>
                  </div>
              `;
              document.getElementById('my-registrations').textContent = '0';
              return;
          }

          myActivities = result;
          document.getElementById('my-registrations').textContent = result.length;

          let html = '';
          result.forEach(registration => {
              const dateStr = registration.date ? new Date(registration.date).toLocaleDateString('zh-TW', {
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  weekday: 'short'
              }) : 'å¾…å®š';
              
              const statusClass = registration.status === 'å·²å ±å' ? 'registered' : 
                                registration.status === 'å·²å–æ¶ˆ' ? 'rejected' : 'pending';
              
              html += `
                  <div class="card">
                      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                          <div>
                              <h4>${registration.activityName}</h4>
                              <p>ğŸ“… ${dateStr}</p>
                              <p>ğŸ“ ${registration.location || 'å¾…å®š'}</p>
                              <p>ğŸ‘¤ åƒèˆ‡è€…ï¼š${registration.participantName}</p>
                              <p>ğŸ“ å ±åæ—¥æœŸï¼š${new Date(registration.registerDate).toLocaleDateString('zh-TW')}</p>
                          </div>
                          <div style="text-align: right;">
                              <span class="status ${statusClass}">${registration.status}</span>
                              ${registration.status === 'å·²å ±å' ? 
                                  `<br><button class="btn btn-danger btn-small" style="margin-top: 10px;" onclick="cancelActivity('${registration.id}', '${registration.activityName}')">å–æ¶ˆå ±å</button>` : 
                                  ''
                              }
                          </div>
                      </div>
                  </div>
              `;
          });

          myActivitiesList.innerHTML = html;
          loadActivitiesForFeedback(result);
          
      } catch (error) {
          console.error('è¼‰å…¥æˆ‘çš„æ´»å‹•å¤±æ•—:', error);
          document.getElementById('my-activities-list').innerHTML = `
              <div class="alert error">
                  è¼‰å…¥æˆ‘çš„æ´»å‹•å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦
              </div>
          `;
      }
  }

  // å–æ¶ˆæ´»å‹•å ±å
  async function cancelActivity(registrationId, activityName) {
      if (!confirm(`ç¢ºå®šè¦å–æ¶ˆã€Œ${activityName}ã€çš„å ±åå—ï¼Ÿ`)) {
          return;
      }

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('cancelActivity', {
              lineId: profile.userId,
              registrationId: registrationId
          });

          if (result.success) {
              showNotification('å·²æˆåŠŸå–æ¶ˆå ±å', 'success');
              await Promise.all([loadActivities(), loadMyActivities()]);
          } else {
              showNotification(`å–æ¶ˆå¤±æ•—ï¼š${result.message}`, 'error');
          }
      } catch (error) {
          console.error('å–æ¶ˆå ±åå¤±æ•—:', error);
          showNotification('å–æ¶ˆéç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      }
  }

  // è¼‰å…¥å›é¥‹é¸é …
  function loadActivitiesForFeedback(activities) {
      const select = document.getElementById('feedback-activity');
      select.innerHTML = '<option value="">è«‹é¸æ“‡å·²åƒèˆ‡çš„æ´»å‹•</option>';
      
      activities.filter(activity => activity.status === 'å·²å ±å').forEach(activity => {
          const option = document.createElement('option');
          option.value = activity.activityId;
          option.textContent = activity.activityName;
          select.appendChild(option);
      });
  }

  // æœå°‹æ´»å‹•
  function setupSearch() {
      const searchInput = document.getElementById('activity-search');
      if (searchInput) {
          searchInput.addEventListener('input', debounce(searchActivities, 300));
      }
  }

  function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
          const later = () => {
              clearTimeout(timeout);
              func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
      };
  }

  function searchActivities() {
      const searchTerm = document.getElementById('activity-search').value.toLowerCase();
      if (!allActivities) return;
      
      const filteredActivities = allActivities.filter(activity => 
          activity.name.toLowerCase().includes(searchTerm) ||
          (activity.description && activity.description.toLowerCase().includes(searchTerm)) ||
          (activity.location && activity.location.toLowerCase().includes(searchTerm))
      );
      
      renderActivities(filteredActivities);
  }

  // åˆ†é åŠŸèƒ½
  function renderPagination(containerId, totalItems, currentPage, onPageChange) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const totalPages = Math.ceil(totalItems / itemsPerPage);
      if (totalPages <= 1) {
          container.innerHTML = '';
          return;
      }

      let html = '';
      
      // ä¸Šä¸€é 
      if (currentPage > 1) {
          html += `<button onclick="window.currentPageCallback && window.currentPageCallback(${currentPage - 1})">ä¸Šä¸€é </button>`;
      }
      
      // é ç¢¼
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);
      
      if (startPage > 1) {
          html += `<button onclick="window.currentPageCallback && window.currentPageCallback(1)">1</button>`;
          if (startPage > 2) html += '<span>...</span>';
      }
      
      for (let i = startPage; i <= endPage; i++) {
          if (i === currentPage) {
              html += `<button class="active">${i}</button>`;
          } else {
              html += `<button onclick="window.currentPageCallback && window.currentPageCallback(${i})">${i}</button>`;
          }
      }
      
      if (endPage < totalPages) {
          if (endPage < totalPages - 1) html += '<span>...</span>';
          html += `<button onclick="window.currentPageCallback && window.currentPageCallback(${totalPages})">${totalPages}</button>`;
      }
      
      // ä¸‹ä¸€é 
      if (currentPage < totalPages) {
          html += `<button onclick="window.currentPageCallback && window.currentPageCallback(${currentPage + 1})">ä¸‹ä¸€é </button>`;
      }

      container.innerHTML = html;
      window.currentPageCallback = onPageChange;
  }

  // ææ¬¾åŠŸèƒ½
  async function addDonation() {
      if (!validateForm()) {
          showNotification('è«‹å¡«å¯«å¿…è¦è³‡è¨Š', 'error');
          return;
      }

      const amount = document.getElementById('donation-amount').value;
      const donorName = document.getElementById('donor-name').value.trim();
      const notes = document.getElementById('donation-notes').value.trim();

      if (!amount || amount <= 0) {
          showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„ææ¬¾é‡‘é¡', 'error');
          return;
      }

      setButtonLoading('donation-btn', true);

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('addDonation', {
              lineId: profile.userId,
              amount: parseFloat(amount),
              donorName,
              notes
          });

          if (result.success) {
              showNotification('ææ¬¾è¨˜éŒ„æ–°å¢æˆåŠŸï¼', 'success');
              document.getElementById('donation-amount').value = '';
              document.getElementById('donor-name').value = '';
              document.getElementById('donation-notes').value = '';
              await loadDonations();
          } else {
              showNotification(`æ–°å¢å¤±æ•—ï¼š${result.message}`, 'error');
          }
      } catch (error) {
          console.error('æ–°å¢ææ¬¾è¨˜éŒ„å¤±æ•—:', error);
          showNotification('æ–°å¢éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      } finally {
          setButtonLoading('donation-btn', false);
      }
  }

  async function loadDonations() {
      try {
          const profile = await liff.getProfile();
          const result = await callAPI('getDonations', { lineId: profile.userId });
          const donationsList = document.getElementById('donations-list');
          
          if (!result || !Array.isArray(result) || result.length === 0) {
              donationsList.innerHTML = `
                  <div class="empty-state">
                      <div class="icon">ğŸ’°</div>
                      <h3>æ‚¨ç›®å‰æ²’æœ‰ææ¬¾è¨˜éŒ„</h3>
                      <p>æ„Ÿè¬æ‚¨å°ç—…å‹æœƒçš„æ”¯æŒ</p>
                  </div>
              `;
              document.getElementById('total-donations').textContent = '0';
              document.getElementById('total-amount').textContent = 'NT$ 0';
              return;
          }

          document.getElementById('total-donations').textContent = result.length;
          const totalAmount = result.reduce((sum, donation) => sum + (donation.amount || 0), 0);
          document.getElementById('total-amount').textContent = `NT$ ${totalAmount.toLocaleString()}`;

          let html = '';
          result.forEach(donation => {
              html += `
                  <div class="card">
                      <h4>ğŸ’ ææ¬¾è¨˜éŒ„</h4>
                      <p><strong>é‡‘é¡ï¼š</strong>NT$ ${(donation.amount || 0).toLocaleString()}</p>
                      <p><strong>ææ¬¾äººï¼š</strong>${donation.donorName || 'åŒ¿å'}</p>
                      <p><strong>æ—¥æœŸï¼š</strong>${new Date(donation.date).toLocaleDateString('zh-TW')}</p>
                      ${donation.notes ? `<p><strong>å‚™è¨»ï¼š</strong>${donation.notes}</p>` : ''}
                  </div>
              `;
          });

          donationsList.innerHTML = html;
          
      } catch (error) {
          console.error('è¼‰å…¥ææ¬¾è¨˜éŒ„å¤±æ•—:', error);
          document.getElementById('donations-list').innerHTML = `
              <div class="alert error">è¼‰å…¥ææ¬¾è¨˜éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>
          `;
      }
  }

  // è²¡å‹™ç®¡ç†åŠŸèƒ½
  async function loadFinanceData() {
      await Promise.all([loadAccounts(), loadBudgetStatus(), loadMyExpenses()]);
  }

  async function loadAccounts() {
      try {
          const profile = await liff.getProfile();
          const result = await callAPI('getAccounts', { operatorLineId: profile.userId });
          const accountsList = document.getElementById('accounts-list');
          
          if (!result || !Array.isArray(result) || result.length === 0) {
              accountsList.innerHTML = `
                  <div class="alert warning">
                      ç›®å‰æ²’æœ‰å¸³æˆ¶è³‡æ–™æˆ–æ‚¨æ²’æœ‰æŸ¥çœ‹æ¬Šé™
                  </div>
              `;
              return;
          }

          let html = '';
          result.forEach(account => {
              html += `
                  <div class="card">
                      <h4>ğŸ’³ ${account.name}</h4>
                      <p><strong>é¡å‹ï¼š</strong>${account.type}</p>
                      <p><strong>é¤˜é¡ï¼š</strong>NT$ ${(account.balance || 0).toLocaleString()}</p>
                  </div>
              `;
          });

          accountsList.innerHTML = html;
          
      } catch (error) {
          console.error('è¼‰å…¥å¸³æˆ¶è³‡æ–™å¤±æ•—:', error);
          document.getElementById('accounts-list').innerHTML = `
              <div class="alert error">è¼‰å…¥å¸³æˆ¶è³‡æ–™å¤±æ•—</div>
          `;
      }
  }

  async function loadBudgetStatus() {
      try {
          const profile = await liff.getProfile();
          const result = await callAPI('getBudgetStatus', { operatorLineId: profile.userId });
          const budgetStatus = document.getElementById('budget-status');
          
          if (!result) {
              budgetStatus.innerHTML = `
                  <div class="alert warning">ç„¡æ³•è¼‰å…¥é ç®—è³‡æ–™æˆ–æ‚¨æ²’æœ‰æŸ¥çœ‹æ¬Šé™</div>
              `;
              return;
          }

          const usedPercentage = result.budgetUsed || 0;
          const progressColor = usedPercentage > 90 ? '#f56565' : 
                               usedPercentage > 70 ? '#ed8936' : '#48bb78';

          budgetStatus.innerHTML = `
              <div class="card">
                  <h4>ğŸ“ˆ æœ¬æœˆé ç®—ä½¿ç”¨ç‹€æ³</h4>
                  <div class="progress-bar">
                      <div class="progress-fill" style="width: ${usedPercentage}%; background: ${progressColor}"></div>
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                      <div><strong>æœˆé ç®—ï¼š</strong>NT$ ${(result.monthlyBudget || 0).toLocaleString()}</div>
                      <div><strong>å·²ä½¿ç”¨ï¼š</strong>NT$ ${(result.monthlyExpense || 0).toLocaleString()}</div>
                      <div><strong>ä½¿ç”¨ç‡ï¼š</strong>${usedPercentage}%</div>
                      <div><strong>å‰©é¤˜ï¼š</strong>NT$ ${(result.remainingBudget || 0).toLocaleString()}</div>
                  </div>
              </div>
          `;
          
      } catch (error) {
          console.error('è¼‰å…¥é ç®—ç‹€æ³å¤±æ•—:', error);
          document.getElementById('budget-status').innerHTML = `
              <div class="alert error">è¼‰å…¥é ç®—ç‹€æ³å¤±æ•—</div>
          `;
      }
  }

  async function submitExpense() {
      if (!validateForm()) {
          showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦è³‡è¨Š', 'error');
          return;
      }

      const category = document.getElementById('expense-category').value;
      const amount = document.getElementById('expense-amount').value;
      const description = document.getElementById('expense-description').value.trim();

      if (!amount || amount <= 0) {
          showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡', 'error');
          return;
      }

      if (!description) {
          showNotification('è«‹å¡«å¯«æ”¯å‡ºèªªæ˜', 'error');
          return;
      }

      setButtonLoading('expense-btn', true);

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('submitExpense', {
              lineId: profile.userId,
              category,
              amount: parseFloat(amount),
              description
          });

          if (result.success) {
              showNotification('æ”¯å‡ºç”³è«‹æäº¤æˆåŠŸï¼', 'success');
              document.getElementById('expense-category').value = 'activity';
              document.getElementById('expense-amount').value = '';
              document.getElementById('expense-description').value = '';
              await loadMyExpenses();
          } else {
              showNotification(`æäº¤å¤±æ•—ï¼š${result.message}`, 'error');
          }
      } catch (error) {
          console.error('æäº¤æ”¯å‡ºç”³è«‹å¤±æ•—:', error);
          showNotification('æäº¤éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      } finally {
          setButtonLoading('expense-btn', false);
      }
  }

  async function loadMyExpenses() {
      try {
          const profile = await liff.getProfile();
          const result = await callAPI('getMyExpenses', { lineId: profile.userId });
          const myExpenses = document.getElementById('my-expenses');
          
          if (!result || !Array.isArray(result) || result.length === 0) {
              myExpenses.innerHTML = `
                  <div class="empty-state">
                      <div class="icon">ğŸ“‹</div>
                      <h3>æ‚¨ç›®å‰æ²’æœ‰æ”¯å‡ºç”³è«‹è¨˜éŒ„</h3>
                      <p>æœ‰éœ€è¦å ±éŠ·çš„æ”¯å‡ºå¯ä»¥åœ¨ä¸Šæ–¹æäº¤ç”³è«‹</p>
                  </div>
              `;
              return;
          }

          let html = '';
          result.forEach(expense => {
              const statusClass = expense.status === 'å·²æ ¸å‡†' ? 'approved' : 
                                expense.status === 'å·²æ‹’çµ•' ? 'rejected' : 'pending';
              
              html += `
                  <div class="card">
                      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                          <div>
                              <h4>${expense.category} - NT$ ${(expense.amount || 0).toLocaleString()}</h4>
                              <p><strong>èªªæ˜ï¼š</strong>${expense.description}</p>
                              <p><strong>ç”³è«‹æ—¥æœŸï¼š</strong>${new Date(expense.submitDate).toLocaleDateString('zh-TW')}</p>
                              ${expense.approvedDate ? `<p><strong>å¯©æ ¸æ—¥æœŸï¼š</strong>${new Date(expense.approvedDate).toLocaleDateString('zh-TW')}</p>` : ''}
                              ${expense.notes ? `<p><strong>å¯©æ ¸å‚™è¨»ï¼š</strong>${expense.notes}</p>` : ''}
                          </div>
                          <span class="status ${statusClass}">${expense.status}</span>
                      </div>
                  </div>
              `;
          });

          myExpenses.innerHTML = html;
          
      } catch (error) {
          console.error('è¼‰å…¥æˆ‘çš„æ”¯å‡ºç”³è«‹å¤±æ•—:', error);
          document.getElementById('my-expenses').innerHTML = `
              <div class="alert error">è¼‰å…¥æ”¯å‡ºç”³è«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>
          `;
      }
  }

  // å›é¥‹åŠŸèƒ½
  async function submitFeedback() {
      if (!validateForm()) {
          showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦è³‡è¨Š', 'error');
          return;
      }

      const activityId = document.getElementById('feedback-activity').value;
      const rating = document.getElementById('feedback-rating').value;
      const comment = document.getElementById('feedback-comment').value.trim();

      if (!activityId) {
          showNotification('è«‹é¸æ“‡æ´»å‹•', 'error');
          return;
      }

      if (!rating) {
          showNotification('è«‹é¸æ“‡è©•åˆ†', 'error');
          return;
      }

      setButtonLoading('feedback-btn', true);

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('submitFeedback', {
              lineId: profile.userId,
              activityId,
              rating: parseInt(rating),
              comment
          });

          if (result.success) {
              showNotification('å›é¥‹æäº¤æˆåŠŸï¼æ„Ÿè¬æ‚¨çš„æ„è¦‹', 'success');
              document.getElementById('feedback-activity').value = '';
              document.getElementById('feedback-rating').value = '';
              document.getElementById('feedback-comment').value = '';
              await loadMyFeedback();
          } else {
              showNotification(`æäº¤å¤±æ•—ï¼š${result.message}`, 'error');
          }
      } catch (error) {
          console.error('æäº¤å›é¥‹å¤±æ•—:', error);
          showNotification('æäº¤éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      } finally {
          setButtonLoading('feedback-btn', false);
      }
  }

  async function loadFeedbackData() {
      await loadMyFeedback();
  }

  async function loadMyFeedback() {
      try {
          const profile = await liff.getProfile();
          const result = await callAPI('getMyFeedback', { lineId: profile.userId });
          const myFeedback = document.getElementById('my-feedback');
          
          if (!result || !Array.isArray(result) || result.length === 0) {
              myFeedback.innerHTML = `
                  <div class="empty-state">
                      <div class="icon">ğŸ“</div>
                      <h3>æ‚¨ç›®å‰æ²’æœ‰å›é¥‹è¨˜éŒ„</h3>
                      <p>åƒèˆ‡æ´»å‹•å¾Œæ­¡è¿åˆ†äº«æ‚¨çš„å¿ƒå¾—</p>
                  </div>
              `;
              return;
          }

          let html = '';
          result.forEach(feedback => {
              const stars = 'â­'.repeat(feedback.rating) + 'â˜†'.repeat(5 - feedback.rating);
              
              html += `
                  <div class="card">
                      <h4>${feedback.activityName}</h4>
                      <p><strong>è©•åˆ†ï¼š</strong>${stars} (${feedback.rating}/5)</p>
                      <p><strong>æäº¤æ—¥æœŸï¼š</strong>${new Date(feedback.submitDate).toLocaleDateString('zh-TW')}</p>
                      ${feedback.comment ? `<p><strong>æ„è¦‹ï¼š</strong>${feedback.comment}</p>` : ''}
                  </div>
              `;
          });

          myFeedback.innerHTML = html;
          
      } catch (error) {
          console.error('è¼‰å…¥æˆ‘çš„å›é¥‹å¤±æ•—:', error);
          document.getElementById('my-feedback').innerHTML = `
              <div class="alert error">è¼‰å…¥å›é¥‹è¨˜éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>
          `;
      }
  }

  // ç®¡ç†åŠŸèƒ½
  async function loadAdminData() {
      await Promise.all([loadSystemStats(), loadPendingExpenses()]);
  }

  async function loadSystemStats() {
      try {
          const profile = await liff.getProfile();
          const result = await callAPI('getSystemStats', { operatorLineId: profile.userId });
          
          if (result.success) {
              document.getElementById('total-members').textContent = result.totalMembers || 0;
              document.getElementById('registered-members').textContent = result.registeredMembers || 0;
              document.getElementById('active-activities').textContent = result.activeActivities || 0;
              document.getElementById('total-registrations').textContent = result.totalRegistrations || 0;
          }
      } catch (error) {
          console.error('è¼‰å…¥ç³»çµ±çµ±è¨ˆå¤±æ•—:', error);
      }
  }

  async function createActivity() {
      if (!validateForm()) {
          showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦è³‡è¨Š', 'error');
          return;
      }

      const name = document.getElementById('activity-name').value.trim();
      const description = document.getElementById('activity-description').value.trim();
      const date = document.getElementById('activity-date').value;
      const location = document.getElementById('activity-location').value.trim();
      const maxParticipants = document.getElementById('activity-max-participants').value;
      const fee = document.getElementById('activity-fee').value;

      if (!name || !description) {
          showNotification('æ´»å‹•åç¨±å’Œæè¿°ç‚ºå¿…å¡«é …ç›®', 'error');
          return;
      }

      setButtonLoading('create-activity-btn', true);

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('createActivity', {
              operatorLineId: profile.userId,
              name,
              description,
              date,
              location,
              maxParticipants: maxParticipants ? parseInt(maxParticipants) : null,
              fee: fee ? parseFloat(fee) : 0
          });

          if (result.success) {
              showNotification('æ´»å‹•å»ºç«‹æˆåŠŸï¼', 'success');
              // æ¸…ç©ºè¡¨å–®
              ['activity-name', 'activity-description', 'activity-date', 'activity-location', 'activity-max-participants', 'activity-fee'].forEach(id => {
                  document.getElementById(id).value = '';
              });
              await loadSystemStats();
          } else {
              showNotification(`å»ºç«‹å¤±æ•—ï¼š${result.message}`, 'error');
          }
      } catch (error) {
          console.error('å»ºç«‹æ´»å‹•å¤±æ•—:', error);
          showNotification('å»ºç«‹éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      } finally {
          setButtonLoading('create-activity-btn', false);
      }
  }

  async function searchMembers() {
      const searchTerm = document.getElementById('member-search').value.trim();
      const memberType = document.getElementById('member-type-filter').value;

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('searchMembers', {
              operatorLineId: profile.userId,
              searchTerm,
              memberType
          });

          const membersList = document.getElementById('members-list');
          
          if (!result || !Array.isArray(result) || result.length === 0) {
              membersList.innerHTML = `
                  <div class="empty-state">
                      <div class="icon">ğŸ‘¥</div>
                      <h3>æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æœƒå“¡</h3>
                      <p>è«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶</p>
                  </div>
              `;
              return;
          }

          let html = '';
          result.forEach(member => {
              const memberTypeMap = {
                  'patient': 'ç—…å‹',
                  'family': 'å®¶å±¬', 
                  'volunteer': 'å¿—å·¥',
                  'medical': 'é†«è­·äººå“¡',
                  'supporter': 'æ”¯æŒè€…'
              };
              
              html += `
                  <div class="card">
                      <h4>${member.realName || 'æœªè¨­å®š'}</h4>
                      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                          <p><strong>LINEåç¨±ï¼š</strong>${member.lineName}</p>
                          <p><strong>æœƒå“¡é¡åˆ¥ï¼š</strong>${memberTypeMap[member.memberType] || member.memberType || 'æœªè¨­å®š'}</p>
                          <p><strong>ç‹€æ…‹ï¼š</strong><span class="status ${member.status === 'å·²è¨»å†Š' ? 'registered' : 'unregistered'}">${member.status}</span></p>
                          <p><strong>é›»è©±ï¼š</strong>${member.phone || 'æœªæä¾›'}</p>
                          <p><strong>é›»å­éƒµä»¶ï¼š</strong>${member.email || 'æœªæä¾›'}</p>
                          <p><strong>è¨»å†Šæ—¥æœŸï¼š</strong>${member.registerDate ? new Date(member.registerDate).toLocaleDateString('zh-TW') : 'æœªè¨»å†Š'}</p>
                          <p><strong>äº’å‹•æ¬¡æ•¸ï¼š</strong>${member.messageCount || 0}</p>
                          <p><strong>æœ€å¾Œæ´»å‹•ï¼š</strong>${member.lastActive ? new Date(member.lastActive).toLocaleDateString('zh-TW') : 'ç„¡è¨˜éŒ„'}</p>
                      </div>
                  </div>
              `;
          });

          membersList.innerHTML = html;
          
      } catch (error) {
          console.error('æœå°‹æœƒå“¡å¤±æ•—:', error);
          document.getElementById('members-list').innerHTML = `
              <div class="alert error">æœå°‹æœƒå“¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>
          `;
      }
  }

  async function loadPendingExpenses() {
      try {
          const profile = await liff.getProfile();
          const result = await callAPI('getPendingExpenses', { operatorLineId: profile.userId });
          const pendingExpenses = document.getElementById('pending-expenses');
          
          if (!result || !Array.isArray(result) || result.length === 0) {
              pendingExpenses.innerHTML = `
                  <div class="empty-state">
                      <div class="icon">âœ…</div>
                      <h3>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„æ”¯å‡ºç”³è«‹</h3>
                      <p>æ‰€æœ‰ç”³è«‹éƒ½å·²è™•ç†å®Œæˆ</p>
                  </div>
              `;
              return;
          }

          let html = '';
          result.forEach(expense => {
              html += `
                  <div class="card">
                      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                          <div style="flex: 1;">
                              <h4>${expense.applicantName} - ${expense.category}</h4>
                              <p><strong>é‡‘é¡ï¼š</strong>NT$ ${(expense.amount || 0).toLocaleString()}</p>
                              <p><strong>èªªæ˜ï¼š</strong>${expense.description}</p>
                              <p><strong>ç”³è«‹æ—¥æœŸï¼š</strong>${new Date(expense.submitDate).toLocaleDateString('zh-TW')}</p>
                          </div>
                          <div style="display: flex; gap: 8px; flex-direction: column;">
                              <button class="btn btn-small" onclick="approveExpense('${expense.id}')">æ ¸å‡†</button>
                              <button class="btn btn-danger btn-small" onclick="rejectExpense('${expense.id}')">æ‹’çµ•</button>
                          </div>
                      </div>
                  </div>
              `;
          });

          pendingExpenses.innerHTML = html;
          
      } catch (error) {
          console.error('è¼‰å…¥å¾…å¯©æ ¸æ”¯å‡ºå¤±æ•—:', error);
          document.getElementById('pending-expenses').innerHTML = `
              <div class="alert error">è¼‰å…¥å¾…å¯©æ ¸æ”¯å‡ºå¤±æ•—</div>
          `;
      }
  }

  async function approveExpense(expenseId) {
      if (!confirm('ç¢ºå®šè¦æ ¸å‡†é€™ç­†æ”¯å‡ºç”³è«‹å—ï¼Ÿ')) {
          return;
      }

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('approveExpense', {
              operatorLineId: profile.userId,
              expenseId: expenseId
          });

          if (result.success) {
              showNotification('æ”¯å‡ºç”³è«‹å·²æ ¸å‡†', 'success');
              await loadPendingExpenses();
          } else {
              showNotification(`æ ¸å‡†å¤±æ•—ï¼š${result.message}`, 'error');
          }
      } catch (error) {
          console.error('æ ¸å‡†æ”¯å‡ºå¤±æ•—:', error);
          showNotification('æ ¸å‡†éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
      }
  }

  async function rejectExpense(expenseId) {
      const reason = prompt('è«‹è¼¸å…¥æ‹’çµ•åŸå› ï¼š');
      if (!reason) return;

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('rejectExpense', {
              operatorLineId: profile.userId,
              expenseId: expenseId,
              reason: reason
          });

          if (result.success) {
              showNotification('æ”¯å‡ºç”³è«‹å·²æ‹’çµ•', 'success');
              await loadPendingExpenses();
          } else {
              showNotification(`æ‹’çµ•å¤±æ•—ï¼š${result.message}`, 'error');
          }
      } catch (error) {
          console.error('æ‹’çµ•æ”¯å‡ºå¤±æ•—:', error);
          showNotification('æ‹’çµ•éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
      }
  }

  async function generateReport() {
      const year = document.getElementById('report-year').value;
      const month = document.getElementById('report-month').value;

      if (!year || !month) {
          showNotification('è«‹é¸æ“‡å¹´ä»½å’Œæœˆä»½', 'error');
          return;
      }

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('generateFinanceReport', {
              operatorLineId: profile.userId,
              year: parseInt(year),
              month: parseInt(month)
          });

          const reportDiv = document.getElementById('finance-report');
          
          if (!result || result.success === false) {
              reportDiv.innerHTML = `
                  <div class="alert error">
                      ç„¡æ³•ç”¢ç”Ÿå ±è¡¨ï¼š${result?.message || 'æœªçŸ¥éŒ¯èª¤'}
                  </div>
              `;
              return;
          }

          const report = result;
          reportDiv.innerHTML = `
              <div class="card">
                  <h4>ğŸ“Š ${year}å¹´${month}æœˆè²¡å‹™å ±è¡¨</h4>
                  <div class="grid">
                      <div class="stat-card">
                          <div class="number">NT$ ${(report.totalIncome || 0).toLocaleString()}</div>
                          <div class="label">ç¸½æ”¶å…¥</div>
                      </div>
                      <div class="stat-card">
                          <div class="number">NT$ ${(report.totalExpense || 0).toLocaleString()}</div>
                          <div class="label">ç¸½æ”¯å‡º</div>
                      </div>
                      <div class="stat-card">
                          <div class="number">NT$ ${((report.totalIncome || 0) - (report.totalExpense || 0)).toLocaleString()}</div>
                          <div class="label">æ·¨æ”¶å…¥</div>
                      </div>
                      <div class="stat-card">
                          <div class="number">${report.donationCount || 0}</div>
                          <div class="label">ææ¬¾ç­†æ•¸</div>
                      </div>
                  </div>
                  
                  ${report.categoryBreakdown ? `
                      <h5>æ”¯å‡ºåˆ†é¡æ˜ç´°</h5>
                      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                          ${Object.entries(report.categoryBreakdown).map(([category, amount]) => `
                              <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                                  <strong>${category}ï¼š</strong><br>
                                  NT$ ${amount.toLocaleString()}
                              </div>
                          `).join('')}
                      </div>
                  ` : ''}
              </div>
          `;
          
      } catch (error) {
          console.error('ç”¢ç”Ÿå ±è¡¨å¤±æ•—:', error);
          document.getElementById('finance-report').innerHTML = `
              <div class="alert error">ç”¢ç”Ÿå ±è¡¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>
          `;
      }
  }

  // éµç›¤å°èˆªæ”¯æ´
  function setupKeyboardNavigation() {
      document.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
              const target = e.target;
              if (target.classList.contains('tab') || target.classList.contains('quick-btn')) {
                  e.preventDefault();
                  target.click();
              }
          }
      });
  }

  // è‡ªå‹•å„²å­˜è¡¨å–®è³‡æ–™
  function setupAutoSave() {
      const formInputs = document.querySelectorAll('input, select, textarea');
      formInputs.forEach(input => {
          input.addEventListener('input', debounce(() => {
              if (input.id && input.value) {
                  localStorage.setItem(`form_${input.id}`, input.value);
              }
          }, 1000));
      });
  }

  function restoreFormData() {
      const formInputs = document.querySelectorAll('input, select, textarea');
      formInputs.forEach(input => {
          if (input.id) {
              const savedValue = localStorage.getItem(`form_${input.id}`);
              if (savedValue && !input.value) {
                  input.value = savedValue;
              }
          }
      });
  }

  function clearFormData() {
      Object.keys(localStorage).forEach(key => {
          if (key.startsWith('form_')) {
              localStorage.removeItem(key);
          }
      });
  }

  // é›¢ç·šæ”¯æ´
  function setupOfflineSupport() {
      window.addEventListener('online', () => {
          showNotification('ç¶²è·¯é€£ç·šå·²æ¢å¾©', 'success', 2000);
          // é‡æ–°è¼‰å…¥ç•¶å‰é é¢è³‡æ–™
          const activeTab = document.querySelector('.tab.active');
          if (activeTab) {
              const tabName = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
              loadTabData(tabName);
          }
      });

      window.addEventListener('offline', () => {
          showNotification('ç¶²è·¯é€£ç·šä¸­æ–·ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨', 'warning', 5000);
      });
  }

  // æ•ˆèƒ½ç›£æ§
  function setupPerformanceMonitoring() {
      // ç›£æ§ API å›æ‡‰æ™‚é–“
      const originalCallAPI = window.callAPI;
      window.callAPI = async function(...args) {
          const startTime = performance.now();
          try {
              const result = await originalCallAPI.apply(this, args);
              const endTime = performance.now();
              const duration = endTime - startTime;
              
              if (duration > 5000) {
                  console.warn(`API å‘¼å« ${args[0]} è€—æ™‚ ${duration.toFixed(2)}ms`);
              }
              
              return result;
          } catch (error) {
              const endTime = performance.now();
              const duration = endTime - startTime;
              console.error(`API å‘¼å« ${args[0]} å¤±æ•—ï¼Œè€—æ™‚ ${duration.toFixed(2)}ms:`, error);
              throw error;
          }
      };
  }

  // éŒ¯èª¤è™•ç†å’Œå›å ±
  function setupErrorHandling() {
      window.addEventListener('error', (e) => {
          console.error('å…¨åŸŸéŒ¯èª¤:', e.error);
          showNotification('ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
      });

      window.addEventListener('unhandledrejection', (e) => {
          console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', e.reason);
          showNotification('æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      });
  }

  // åˆå§‹åŒ–ç³»çµ±
  document.addEventListener('DOMContentLoaded', async () => {
      try {
          // é¡¯ç¤ºè¼‰å…¥ç•«é¢
          showNotification('æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...', 'info', 2000);
          
          // è¨­ç½®å„ç¨®åŠŸèƒ½
          setupKeyboardNavigation();
          setupAutoSave();
          setupOfflineSupport();
          setupPerformanceMonitoring();
          setupErrorHandling();
          setupSearch();
          
          // æ¢å¾©è¡¨å–®è³‡æ–™
          restoreFormData();
          
          // åˆå§‹åŒ– LIFF
          await initializeLiff();
          
          // è¼‰å…¥é è¨­é é¢è³‡æ–™
          await loadTabData('profile');
          
          showNotification('ç³»çµ±è¼‰å…¥å®Œæˆï¼', 'success', 2000);
          
      } catch (error) {
          console.error('ç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error);
          showNotification('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
      }
  });

  // é é¢å¸è¼‰æ™‚æ¸…ç†
  window.addEventListener('beforeunload', () => {
      // æ¸…ç†å®šæ™‚å™¨
      if (window.currentPageCallback) {
          window.currentPageCallback = null;
      }
      
      // å¯é¸ï¼šæ¸…ç†è¡¨å–®è³‡æ–™
      // clearFormData();
  });

  // å°å‡ºå…¨åŸŸå‡½æ•¸ä¾› HTML ä½¿ç”¨
  window.showTab = showTab;
  window.registerUser = registerUser;
  window.updateContact = updateContact;
  window.registerActivity = registerActivity;
  window.cancelActivity = cancelActivity;
  window.addDonation = addDonation;
  window.submitExpense = submitExpense;
  window.submitFeedback = submitFeedback;
  window.createActivity = createActivity;
  window.searchMembers = searchMembers;
  window.approveExpense = approveExpense;
  window.rejectExpense = rejectExpense;
  window.generateReport = generateReport;
</script>

</body>
</html>


