<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>帕金森病友會管理系統 - 精簡測試版</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .navbar { background:linear-gradient(135deg,#00B900,#008d00); }
    .navbar .nav-link,.navbar-brand { color:#fff !important; }
    .page { display:none; }
    .page.active { display:block; animation:fade .25s; }
    @keyframes fade { from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:translateY(0);} }
    .card-stat { border:none; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.06); padding:18px; background:#fff; text-align:center; }
    .card-stat h3 { margin:0; font-weight:600; font-size:1.8rem; }
    #alerts .alert { padding:6px 10px; margin-bottom:6px; }
    footer { font-size:.75rem; color:#666; text-align:center; margin-top:40px; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">病友會系統</a>
      <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
      <div id="nav" class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="#" data-page="dashboard">首頁</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-page="profile">個人資料</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-page="activities">活動</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-page="volunteer">志工</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-page="finance">財務</a></li>
          <li class="nav-item d-none" id="adminNav"><a class="nav-link" href="#" data-page="admin">管理</a></li>
        </ul>
        <span class="navbar-text" id="navUser">載入中...</span>
      </div>
    </div>
  </nav>

  <div class="container py-3">
    <div id="alerts"></div>

    <!-- Dashboard -->
    <div id="dashboard" class="page active">
      <h4 class="mb-3">儀表板</h4>
      <div class="row g-3">
        <div class="col-6 col-md-3"><div class="card-stat"><h3 id="statActivities">0</h3><div>開放活動</div></div></div>
        <div class="col-6 col-md-3"><div class="card-stat"><h3 id="statRegs">0</h3><div>我的報名</div></div></div>
        <div class="col-6 col-md-3"><div class="card-stat"><h3 id="statVol">0</h3><div>志工時數</div></div></div>
          <div class="col-6 col-md-3"><div class="card-stat"><h3 id="statDon">0</h3><div>捐款次數</div></div></div>
      </div>
      <hr>
      <h6 class="mt-3">最新活動</h6>
      <div id="recentActs" class="small text-muted">載入中...</div>
    </div>

    <!-- Profile -->
    <div id="profile" class="page">
      <h4>個人資料</h4>
      <form id="profileForm" class="mt-3">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">LINE 名稱</label>
            <input type="text" id="lineName" class="form-control" disabled>
          </div>
          <div class="col-md-6">
            <label class="form-label">真實姓名 *</label>
            <input type="text" id="realName" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">電話</label>
            <input type="text" id="phone" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="email" id="email" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">生日</label>
            <input type="date" id="birthday" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">會員類別</label>
            <select id="memberType" class="form-select">
              <option value="病友">病友</option>
              <option value="家屬">家屬</option>
              <option value="志工">志工</option>
              <option value="醫護">醫護人員</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">地址</label>
            <textarea id="address" rows="2" class="form-control"></textarea>
          </div>
          <div class="col-12">
            <button class="btn btn-primary btn-sm">儲存</button>
          </div>
        </div>
      </form>
      <div class="mt-4">
        <h6>統計</h6>
        <ul id="profileStats" class="list-group small"></ul>
      </div>
    </div>

    <!-- Activities -->
    <div id="activities" class="page">
      <h4>活動</h4>
      <div class="d-flex gap-2 my-2">
        <select id="fltStatus" class="form-select form-select-sm" style="max-width:150px;">
          <option value="">全部</option>
          <option value="開放報名">開放報名</option>
          <option value="已結束">已結束</option>
        </select>
        <input type="date" id="fltDate" class="form-control form-control-sm" style="max-width:170px;">
        <input type="text" id="fltSearch" class="form-control form-control-sm" placeholder="搜尋">
        <button class="btn btn-sm btn-outline-primary" id="btnActFilter">篩選</button>
      </div>
      <div id="actList" class="small">載入中...</div>
      <hr>
      <h6>我的報名</h6>
      <div id="myRegs" class="small">載入中...</div>
    </div>

    <!-- Volunteer -->
    <div id="volunteer" class="page">
      <h4>志工</h4>
      <h6 class="mt-3">需求</h6>
      <div id="volNeeds" class="small">載入中...</div>
      <hr>
      <h6>我的紀錄</h6>
      <div id="volRecords" class="small">載入中...</div>
    </div>

    <!-- Finance -->
    <div id="finance" class="page">
      <h4>財務</h4>
      <div class="mb-2">
        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#donModal">新增捐款</button>
        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#expModal">支出申請</button>
      </div>
      <h6>捐款</h6>
      <div id="donList" class="small">載入中...</div>
      <hr>
      <h6>支出</h6>
      <div id="expList" class="small">載入中...</div>
      <div id="finOverview" class="mt-4 d-none">
        <h6>財務概覽（管理員）</h6>
        <div class="row g-3 text-center">
          <div class="col-6 col-md-3"><div class="card-stat"><h3 id="finIncome">0</h3><div>總收入</div></div></div>
          <div class="col-6 col-md-3"><div class="card-stat"><h3 id="finExpense">0</h3><div>總支出</div></div></div>
          <div class="col-6 col-md-3"><div class="card-stat"><h3 id="finBalance">0</h3><div>餘額</div></div></div>
          <div class="col-6 col-md-3"><div class="card-stat"><h3 id="finDonCount">0</h3><div>捐款筆數</div></div></div>
        </div>
      </div>
    </div>

    <!-- Admin (預留) -->
    <div id="admin" class="page">
      <h4>管理專區</h4>
      <p class="text-muted small">此區可擴充：會員審核 / 活動維護 / 審批等。</p>
    </div>

    <footer>版本：簡化測試版 | 若此頁正常則表示語法問題已排除</footer>
  </div>

  <!-- 捐款 Modal -->
  <div class="modal fade" id="donModal" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="donForm">
        <div class="modal-header">
          <h5 class="modal-title">新增捐款</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">金額 *</label>
          <input type="number" id="donAmount" class="form-control mb-2" required min="1">
          <label class="form-label">方式</label>
          <select id="donMethod" class="form-select mb-2">
            <option value="現金">現金</option>
            <option value="轉帳">轉帳</option>
            <option value="信用卡">信用卡</option>
            <option value="其他">其他</option>
          </select>
          <label class="form-label">日期</label>
          <input type="date" id="donDate" class="form-control mb-2">
          <label class="form-label">備註</label>
          <textarea id="donNote" rows="2" class="form-control"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal" type="button">取消</button>
          <button class="btn btn-primary btn-sm" type="submit">送出</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 支出 Modal -->
  <div class="modal fade" id="expModal" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="expForm">
        <div class="modal-header">
          <h5 class="modal-title">支出申請</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">項目 *</label>
          <input type="text" id="expItem" class="form-control mb-2" required>
          <label class="form-label">金額 *</label>
          <input type="number" id="expAmount" class="form-control mb-2" required min="1">
          <label class="form-label">類別</label>
          <select id="expCategory" class="form-select mb-2">
            <option value="活動費用">活動費用</option>
            <option value="交通費">交通費</option>
            <option value="餐飲費">餐飲費</option>
            <option value="設備費">設備費</option>
            <option value="其他">其他</option>
          </select>
          <label class="form-label">日期</label>
          <input type="date" id="expDate" class="form-control mb-2">
          <label class="form-label">說明</label>
          <textarea id="expDesc" rows="2" class="form-control"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal" type="button">取消</button>
          <button class="btn btn-primary btn-sm" type="submit">送出</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const LIFF_ID = '1656516134-VaGgmaPm';
    const API_URL = 'https://script.google.com/macros/s/AKfycbxqVdsisMAulqGwM8FauBwxrXB9L3cuhMQgmgcEuAHbEtBtRfk65UUbvMtIIeIUnPaEFA/exec';
    const API_KEY = 'AAbb8520258185202581';

    let currentUser = null;

    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
    function alertBox(msg,type='success',ms=2500){
      const box=document.createElement('div');
      box.className='alert alert-'+type+' small';
      box.textContent=msg;
      document.getElementById('alerts').appendChild(box);
      if (ms) setTimeout(()=>box.remove(),ms);
    }
    async function callAPI(action, data={}){
      const body={ action, apiKey:API_KEY, ...data };
      const res=await fetch(API_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
      const json=await res.json();
      if(!json.success) throw new Error(json.message||'失敗');
      return json.data;
    }
    function fmt(d){
      if(!d) return '-';
      const dt=new Date(d); if(isNaN(dt)) return '-';
      return dt.getFullYear()+'/'+String(dt.getMonth()+1).padStart(2,'0')+'/'+String(dt.getDate()).padStart(2,'0');
    }

    async function init(){
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      const profile=await liff.getProfile();
      await callAPI('register',{ lineId:profile.userId, lineName:profile.displayName, realName:profile.displayName });
      await loadProfile();
      await loadDashboard();
      bindEvents();
    }

    function bindEvents(){
      document.querySelectorAll('[data-page]').forEach(a=>{
        a.addEventListener('click',e=>{
          e.preventDefault();
          showPage(a.dataset.page);
          if(a.dataset.page==='dashboard') loadDashboard();
          if(a.dataset.page==='profile') loadProfile();
          if(a.dataset.page==='activities') loadActivities();
          if(a.dataset.page==='volunteer') loadVolunteer();
          if(a.dataset.page==='finance') loadFinance();
        });
      });
      document.getElementById('profileForm').addEventListener('submit', submitProfile);
      document.getElementById('btnActFilter').addEventListener('click', loadActivities);
      document.getElementById('donForm').addEventListener('submit', submitDonation);
      document.getElementById('expForm').addEventListener('submit', submitExpense);
    }

    async function loadProfile(){
      const p=await liff.getProfile();
      const data=await callAPI('getProfile',{ lineId:p.userId });
      currentUser=data;
      document.getElementById('navUser').textContent=(data.realName||data.lineName)+' ('+(data.memberType||'會員')+')';
      if(data.isAdmin) document.getElementById('adminNav').classList.remove('d-none');
      lineName.value=data.lineName||'';
      realName.value=data.realName||'';
      phone.value=data.phone||'';
      email.value=data.email||'';
      birthday.value=data.birthday||'';
      memberType.value=data.memberType||'病友';
      address.value=data.address||'';
      const stats=[
        '狀態：'+(data.status||'-'),
        '註冊：'+fmt(data.registerDate),
        '志工時數：'+(data.volunteerHours||0),
        '活動次數：'+(data.activityCount||0),
        '最後活動：'+fmt(data.lastActive)
      ];
      profileStats.innerHTML=stats.map(s=>'<li class="list-group-item">'+s+'</li>').join('');
    }

    async function submitProfile(e){
      e.preventDefault();
      const p = await liff.getProfile();
      await callAPI('updateProfile',{
        lineId:p.userId,
        realName:realName.value,
        phone:phone.value,
        email:email.value,
        birthday:birthday.value,
        memberType:memberType.value,
        address:address.value
      });
      alertBox('已更新');
      loadProfile();
    }

    async function loadDashboard(){
      const p=await liff.getProfile();
      const [acts, regs, vols, dons] = await Promise.all([
        callAPI('getActivities',{}),
        callAPI('getMyRegistrations',{ lineId:p.userId }),
        callAPI('getMyVolunteerRecords',{ lineId:p.userId }),
        callAPI('getDonations',{ lineId:p.userId })
      ]);
      statActivities.textContent=acts.filter(a=>a.status==='開放報名').length;
      statRegs.textContent=regs.filter(r=>r.status==='已報名').length;
      statVol.textContent=vols.filter(v=>v.status==='已核准').reduce((s,v)=>s+(v.hours||0),0);
      statDon.textContent=dons.length;
      recentActs.innerHTML = acts.slice(0,5).map(a=>(
        '<div>'+a.name+' <span class="text-muted">'+fmt(a.activityDate)+'</span></div>'
      )).join('') || '暫無活動';
    }

    async function loadActivities(){
      const status=fltStatus.value;
      const date=fltDate.value;
      const search=fltSearch.value;
      const acts = await callAPI('getActivities',{ status, date, search });
      if(!acts.length){
        actList.textContent='無符合活動';
      }else{
        actList.innerHTML = acts.map(a=>{
          const full = a.maxParticipants && a.currentCount>=a.maxParticipants;
          let btn='';
          if(a.status==='開放報名' && !full){
            btn = '<button class="btn btn-sm btn-primary" data-act="'+a.id+'">報名</button>';
          }else if(full){
            btn='<span class="text-danger">額滿</span>';
          }
          return '<div class="border p-2 mb-1">'+
            '<div><strong>'+a.name+'</strong> <span class="text-muted small">'+fmt(a.activityDate)+'</span></div>'+
            '<div class="small">地點：'+(a.location||'-')+' | 人數：'+(a.currentCount)+'/'+(a.maxParticipants||'∞')+'</div>'+
            '<div>'+btn+'</div>'+
          '</div>';
        }).join('');
        // 綁定報名按鈕
        actList.querySelectorAll('button[data-act]').forEach(b=>{
          b.addEventListener('click',()=>registerActivity(b.getAttribute('data-act')));
        });
      }
      loadMyRegistrations();
    }

    async function registerActivity(id){
      const p=await liff.getProfile();
      try{
        await callAPI('registerActivity',{ lineId:p.userId, activityId:id, participantName: currentUser.realName||currentUser.lineName });
        alertBox('報名成功');
        loadActivities();
      }catch(e){ alertBox(e.message,'danger'); }
    }

    async function loadMyRegistrations(){
      const p=await liff.getProfile();
      const regs=await callAPI('getMyRegistrations',{ lineId:p.userId });
      if(!regs.length){
        myRegs.textContent='尚未報名';
      }else{
        myRegs.innerHTML = '<table class="table table-sm"><thead><tr><th>活動</th><th>日期</th><th>狀態</th><th></th></tr></thead><tbody>'+
          regs.map(r=>{
            let cancelBtn = r.status==='已報名' ? '<button class="btn btn-sm btn-outline-danger" data-reg="'+r.id+'">取消</button>' : '';
            return '<tr><td>'+r.activityName+'</td><td>'+fmt(r.activityDate)+'</td><td>'+r.status+'</td><td>'+cancelBtn+'</td></tr>';
          }).join('')+
        '</tbody></table>';
        myRegs.querySelectorAll('button[data-reg]').forEach(b=>{
          b.addEventListener('click',()=>cancelReg(b.getAttribute('data-reg')));
        });
      }
    }

    async function cancelReg(id){
      if(!confirm('確認取消報名？')) return;
      const p=await liff.getProfile();
      try{
        await callAPI('cancelActivity',{ lineId:p.userId, registrationId:id });
        alertBox('已取消');
        loadActivities();
      }catch(e){ alertBox(e.message,'danger'); }
    }

    async function loadVolunteer(){
      const p=await liff.getProfile();
      const [needs,recs] = await Promise.all([
        callAPI('getVolunteerNeeds',{}),
        callAPI('getMyVolunteerRecords',{ lineId:p.userId })
      ]);
      volNeeds.innerHTML = needs.length ? needs.map(n=>{
        return '<div class="border p-2 mb-1">'+
          '<div><strong>'+n.activityName+'</strong> <span class="text-muted small">'+fmt(n.activityDate)+'</span></div>'+
          '<div class="small">'+(n.description||'')+'</div>'+
          '<button class="btn btn-sm btn-outline-primary mt-1" data-vol="'+n.activityId+'">報名志工</button>'+
        '</div>';
      }).join('') : '無志工需求';
      volNeeds.querySelectorAll('button[data-vol]').forEach(b=>{
        b.addEventListener('click',()=>registerVolunteer(b.getAttribute('data-vol')));
      });

      volRecords.innerHTML = recs.length ? '<table class="table table-sm"><thead><tr><th>活動</th><th>時數</th><th>狀態</th><th>日期</th></tr></thead><tbody>'+
        recs.map(r=>'<tr><td>'+r.activityName+'</td><td>'+r.hours+'</td><td>'+r.status+'</td><td>'+fmt(r.serviceDate)+'</td></tr>').join('')+
        '</tbody></table>' : '尚無紀錄';
    }

    async function registerVolunteer(actId){
      const hours = prompt('請輸入預估服務時數');
      if(!hours) return;
      const p=await liff.getProfile();
      try{
        await callAPI('registerVolunteer',{ lineId:p.userId, activityId:actId, hours: parseFloat(hours) });
        alertBox('志工已登記(待審核)');
        loadVolunteer();
      }catch(e){ alertBox(e.message,'danger'); }
    }

    async function loadFinance(){
      const p=await liff.getProfile();
      const [dons, exps] = await Promise.all([
        callAPI('getDonations',{ lineId:p.userId }),
        callAPI('getMyExpenses',{ lineId:p.userId })
      ]);
      donList.innerHTML = dons.length ? '<table class="table table-sm"><thead><tr><th>日期</th><th>金額</th><th>方式</th></tr></thead><tbody>'+
        dons.map(d=>'<tr><td>'+fmt(d.donationDate)+'</td><td>'+d.amount+'</td><td>'+d.method+'</td></tr>').join('')+
        '</tbody></table>' : '無捐款';
      expList.innerHTML = exps.length ? '<table class="table table-sm"><thead><tr><th>日期</th><th>項目</th><th>金額</th><th>狀態</th></tr></thead><tbody>'+
        exps.map(e=>'<tr><td>'+fmt(e.submitDate)+'</td><td>'+e.item+'</td><td>'+e.amount+'</td><td>'+e.status+'</td></tr>').join('')+
        '</tbody></table>' : '無支出';

      if(currentUser && currentUser.isAdmin){
        const ov = await callAPI('getFinanceOverview',{ operatorLineId:p.userId });
        finIncome.textContent=ov.totalIncome;
        finExpense.textContent=ov.totalExpense;
        finBalance.textContent=ov.balance;
        finDonCount.textContent=ov.donationCount;
        finOverview.classList.remove('d-none');
      }
    }

    async function submitDonation(e){
      e.preventDefault();
      const p=await liff.getProfile();
      try{
        await callAPI('addDonation',{
          lineId:p.userId,
          amount: parseInt(donAmount.value),
          method: donMethod.value,
          donationDate: donDate.value,
          note: donNote.value
        });
        alertBox('捐款已記錄');
        donForm.reset();
        bootstrap.Modal.getInstance(document.getElementById('donModal')).hide();
        loadFinance();
      }catch(err){ alertBox(err.message,'danger'); }
    }

    async function submitExpense(e){
      e.preventDefault();
      const p=await liff.getProfile();
      try{
        await callAPI('submitExpense',{
          lineId:p.userId,
          item: expItem.value,
          amount: parseInt(expAmount.value),
          category: expCategory.value,
          description: expDesc.value,
          expenseDate: expDate.value
        });
          alertBox('支出申請已送出');
        expForm.reset();
        bootstrap.Modal.getInstance(document.getElementById('expModal')).hide();
        loadFinance();
      }catch(err){ alertBox(err.message,'danger'); }
    }

    window.addEventListener('load', ()=>{
      init().catch(err=>{
        console.error(err);
        alertBox('初始化失敗: '+err.message,'danger',6000);
      });
    });
  </script>
</body>
</html>
