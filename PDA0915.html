<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>帕金森病友會管理系統 v2.3</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="theme-color" content="#667eea">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
<style>
:root {
  --primary:#667eea;
  --grad:linear-gradient(135deg,#667eea,#764ba2);
  --success:#48bb78;
  --warn:#ed8936;
  --error:#f56565;
  --bg:#f4f6fb;
  --card:#ffffff;
  --radius:16px;
  --shadow:0 4px 14px rgba(0,0,0,.08);
  --text:#2d3748;
  --text-light:#718096;
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans TC',sans-serif;
}
body { margin:0; background:var(--bg); color:var(--text); }
header {
  background:var(--grad); color:#fff; padding:24px 16px;
  text-align:center; position:sticky; top:0; z-index:10;
}
h1 { margin:0; font-size:22px; letter-spacing:1px; }
.container { max-width:1200px; margin:0 auto; padding:16px; }
.tabs { display:flex; gap:8px; flex-wrap:wrap; margin:16px 0; }
.tab-btn {
  flex:1 1 140px; background:#fff; border:2px solid #e2e8f0;
  border-radius:10px; padding:10px 12px; text-align:center;
  cursor:pointer; font-size:14px; font-weight:600;
  transition:.25s; user-select:none;
}
.tab-btn.active {
  background:var(--grad); color:#fff; border-color:var(--primary);
  box-shadow:0 4px 14px rgba(102,126,234,.35);
}
.tab-btn:hover:not(.active){ border-color:var(--primary); }
.panel { display:none; animation:fade .4s ease; }
.panel.active { display:block; }
@keyframes fade {
  from { opacity:0; transform:translateY(12px); }
  to { opacity:1; transform:translateY(0); }
}
.card {
  background:var(--card); border-radius:var(--radius);
  box-shadow:var(--shadow); padding:20px; margin-bottom:18px;
  position:relative;
}
.grid { display:grid; gap:16px; }
@media (min-width:700px){
  .grid.cols-2{ grid-template-columns:repeat(2,1fr); }
  .grid.cols-3{ grid-template-columns:repeat(3,1fr); }
  .grid.cols-4{ grid-template-columns:repeat(4,1fr); }
}
.stat {
  text-align:center; padding:18px 12px; border-radius:14px;
  background:#fff; box-shadow:var(--shadow); position:relative;
  overflow:hidden;
}
.stat:before {
  content:''; position:absolute; top:0; left:0; height:4px; width:100%;
  background:var(--grad);
}
.stat .num { font-size:30px; font-weight:700; color:var(--primary); margin:8px 0 4px; }
.stat .label { font-size:13px; color:var(--text-light); letter-spacing:1px; }
label { font-size:13px; font-weight:600; margin-bottom:4px; display:block; color:var(--text-light); }
input, select, textarea {
  width:100%; padding:10px 12px; font-size:14px;
  border:2px solid #e2e8f0; border-radius:10px; background:#fff;
  transition:.25s;
}
input:focus,select:focus,textarea:focus {
  outline:none; border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(102,126,234,.15);
}
textarea { resize:vertical; min-height:100px; }
.actions { display:flex; gap:10px; flex-wrap:wrap; }
.btn {
  background:var(--grad); color:#fff; padding:10px 18px;
  border:none; border-radius:10px; font-size:13px; font-weight:600;
  cursor:pointer; display:inline-flex; align-items:center; gap:6px;
  box-shadow:0 4px 14px rgba(102,126,234,.35); transition:.25s;
  position:relative; overflow:hidden;
}
.btn.small { padding:6px 10px; font-size:12px; }
.btn.outline {
  background:#fff; color:var(--primary);
  border:2px solid var(--primary); box-shadow:none;
}
.btn.outline:hover { background:var(--grad); color:#fff; }
.btn:hover { transform:translateY(-2px); }
.btn:active { transform:translateY(0); }
.btn.secondary { background:#4a5568; box-shadow:0 4px 12px rgba(74,85,104,.4); }
.btn.danger { background:linear-gradient(135deg,#fc8181,#f56565); box-shadow:0 4px 12px rgba(245,101,101,.4); }
.btn.warn { background:linear-gradient(135deg,#ed8936,#dd6b20); }
.btn.disabled, .btn:disabled { opacity:.55; cursor:not-allowed; transform:none; }
.btn.loading .text { opacity:0; }
.btn.loading:after {
  content:''; width:18px; height:18px; border:3px solid rgba(255,255,255,.4);
  border-top:3px solid #fff; border-radius:50%; animation:spin 1s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }
.inline { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.badge {
  display:inline-block; padding:4px 10px; font-size:11px; border-radius:999px;
  background:#edf2f7; color:#4a5568; font-weight:600; letter-spacing:.5px; margin-right:4px;
}
.badge.green { background:rgba(72,187,120,.15); color:var(--success); }
.badge.red { background:rgba(245,101,101,.15); color:var(--error); }
.badge.orange { background:rgba(237,137,54,.15); color:var(--warn); }
.badge.blue { background:rgba(102,126,234,.15); color:var(--primary); }
.flex { display:flex; }
.space-between { justify-content:space-between; }
.mt { margin-top:18px; }
.mb { margin-bottom:18px; }
.hidden { display:none !important; }
.separator { height:1px; background:#e2e8f0; margin:20px 0; }
.list-item {
  background:#fff; border-radius:14px; padding:14px 16px; box-shadow:var(--shadow);
  margin-bottom:14px; border-left:5px solid var(--primary); position:relative;
}
.list-item.full { border-left-color:var(--error); }
.list-item h4 { margin:0 0 6px; font-size:15px; }
.meta { font-size:11.5px; color:var(--text-light); display:flex; gap:10px; flex-wrap:wrap; line-height:1.3; }
.meta span { display:inline-flex; align-items:center; gap:4px; }
.notice {
  padding:14px 16px; border-radius:12px; font-size:13px; line-height:1.5;
  background:#fffaf0; color:#744210; border:1px solid #fbd38d; margin-bottom:16px;
}
.notice.error { background:#fff5f5; color:#742a2a; border-color:#feb2b2; }
.notice.success { background:#f0fff4; color:#22543d; border-color:#9ae6b4; }
.notice.info { background:#ebf8ff; color:#2b6cb0; border-color:#90cdf4; }
.empty {
  text-align:center; padding:50px 20px; color:var(--text-light); font-size:14px;
}
.empty .icon { font-size:42px; margin-bottom:8px; }
.pagination { display:flex; gap:6px; flex-wrap:wrap; margin-top:10px; }
.pagination button {
  padding:6px 12px; border:2px solid #e2e8f0; background:#fff; font-weight:600;
  border-radius:8px; cursor:pointer; transition:.2s; font-size:12px;
}
.pagination button.active,.pagination button:hover { background:var(--grad); color:#fff; border-color:var(--primary); }
.notification {
  position:fixed; top:20px; right:20px; background:#2d3748; color:#fff;
  padding:14px 20px; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.25);
  transform:translateY(-25px); opacity:0; transition:.35s; z-index:999;
  max-width:360px; display:flex; gap:12px; align-items:flex-start;
}
.notification.show { transform:translateY(0); opacity:1; }
.notification.success { background:var(--success); }
.notification.error { background:var(--error); }
.notification.warn { background:var(--warn); }
.notification button {
  background:rgba(255,255,255,.15); color:#fff; border:none;
  width:26px; height:26px; border-radius:50%; cursor:pointer;
  font-weight:700; font-size:14px; line-height:1;
}
.progress { width:100%; height:8px; background:#e2e8f0; border-radius:4px; overflow:hidden; }
.progress > div { height:100%; background:var(--grad); width:0; transition:width .5s; }
.search-bar { position:relative; }
.search-bar input { padding-left:38px; }
.search-bar .icon {
  position:absolute; top:50%; left:12px; transform:translateY(-50%);
  font-size:16px; opacity:.55;
}
footer { text-align:center; padding:40px 0 60px; font-size:12px; color:#94a3b8; }

/* Admin 子頁籤 */
.subtabs { display:flex; gap:6px; flex-wrap:wrap; margin:8px 0 18px; }
.subtab-btn {
  background:#fff; border:2px solid #e2e8f0; padding:6px 12px; border-radius:8px;
  font-size:12px; font-weight:600; cursor:pointer; transition:.2s;
}
.subtab-btn.active { background:var(--grad); color:#fff; border-color:var(--primary); }
.table-wrap { overflow-x:auto; }
table { width:100%; border-collapse:collapse; font-size:12.5px; }
th, td { padding:8px 10px; text-align:left; border-bottom:1px solid #e2e8f0; vertical-align:top; }
th { background:#f8fafc; font-weight:600; font-size:11px; letter-spacing:.5px; color:#4a5568; text-transform:uppercase; }
tr:hover td { background:#fdfdfd; }
.inline-edit-input {
  width:100%; border:1px solid #cbd5e0; border-radius:6px; padding:4px 6px; font-size:12px;
}
.tag {
  display:inline-block; background:#edf2f7; color:#4a5568; padding:2px 6px; border-radius:6px; font-size:11px; margin:2px 4px 2px 0;
}
.tag.income { background:rgba(72,187,120,.15); color:var(--success); }
.tag.expense { background:rgba(245,101,101,.15); color:var(--error); }
.trend-bar { height:6px; background:#e2e8f0; border-radius:4px; position:relative; overflow:hidden; }
.trend-bar span { position:absolute; top:0; left:0; height:100%; background:var(--grad); }

@media (max-width:640px){
  h1 { font-size:20px; }
  .tab-btn { flex:1 1 calc(50% - 8px); }
  .stat .num { font-size:24px; }
  .list-item { padding:14px 14px; }
  th,td { padding:6px 8px; }
}
</style>
</head>
<body>
<header>
  <h1>🏥 帕金森病友會 管理系統 v2.3</h1>
  <div style="margin-top:6px;font-size:12px;opacity:.85;">會員 / 活動 / 捐款 / 支出 / 回饋 / 管理報表</div>
</header>
<div class="container">

  <!-- 使用者資訊 -->
  <div id="user-info" class="card hidden">
    <h3 style="margin-top:0">👤 個人資訊</h3>
    <div id="user-details" style="font-size:14px;"></div>
  </div>

  <!-- 分頁選單 -->
  <div class="tabs" id="tabs">
    <div class="tab-btn active" data-tab="profile">個人資料</div>
    <div class="tab-btn" data-tab="activities">活動</div>
    <div class="tab-btn" data-tab="donations">捐款</div>
    <div class="tab-btn" data-tab="finance">支出 / 財務</div>
    <div class="tab-btn" data-tab="feedback">回饋</div>
    <div class="tab-btn admin-only hidden" data-tab="admin">管理</div>
  </div>

  <!-- 個人資料 -->
  <div class="panel active" id="panel-profile">
    <div class="card">
      <h3 style="margin-top:0">📝 會員註冊 / 更新</h3>
      <div class="grid cols-2">
        <div>
          <label for="realName">真實姓名 *</label>
          <input id="realName" type="text" autocomplete="name" placeholder="請輸入姓名">
        </div>
        <div>
          <label for="memberType">會員類別 *</label>
          <select id="memberType">
            <option value="">請選擇</option>
            <option value="patient">病友</option>
            <option value="family">家屬</option>
            <option value="volunteer">志工</option>
            <option value="medical">醫護人員</option>
            <option value="supporter">支持者</option>
          </select>
        </div>
      </div>
      <div class="actions mt">
        <button class="btn" id="btn-register"><span class="text">註冊 / 更新</span></button>
      </div>
      <div class="separator"></div>
      <h4>📞 聯絡資訊</h4>
      <div class="grid cols-2">
        <div>
          <label for="phone">電話</label>
          <input id="phone" type="tel" placeholder="例：0912345678">
        </div>
        <div>
          <label for="email">電子郵件</label>
          <input id="email" type="email" autocomplete="email">
        </div>
        <div>
          <label for="address">地址</label>
          <input id="address" type="text">
        </div>
        <div>
          <label for="birthday">生日</label>
          <input id="birthday" type="date">
        </div>
      </div>
      <div class="actions mt">
        <button class="btn secondary" id="btn-update-contact"><span class="text">更新聯絡資訊</span></button>
      </div>
    </div>
  </div>

  <!-- 活動 -->
  <div class="panel" id="panel-activities">
    <div class="grid cols-2 mb">
      <div class="stat"><div class="num" id="stat-activity-total">0</div><div class="label">可報名活動</div></div>
      <div class="stat"><div class="num" id="stat-my-registrations">0</div><div class="label">我的報名</div></div>
    </div>

    <div class="card">
      <div class="flex space-between" style="align-items:center;">
        <h3 style="margin:0">📅 可報名活動</h3>
        <div class="search-bar" style="width:230px;">
          <span class="icon">🔍</span>
          <input id="activity-search" type="text" placeholder="搜尋活動…">
        </div>
      </div>
      <div id="activity-list" style="margin-top:14px;"></div>
      <div class="pagination" id="activity-pagination"></div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">🗂 我的活動報名</h3>
      <div id="my-activity-list"></div>
    </div>
  </div>

  <!-- 捐款 -->
  <div class="panel" id="panel-donations">
    <div class="grid cols-2 mb">
      <div class="stat"><div class="num" id="stat-donation-count">0</div><div class="label">捐款筆數</div></div>
      <div class="stat"><div class="num" id="stat-donation-total">0</div><div class="label">捐款總額</div></div>
    </div>
    <div class="card">
      <h3 style="margin-top:0">💝 新增捐款</h3>
      <div class="grid cols-2">
        <div>
          <label for="donation-amount">金額 *</label>
          <input id="donation-amount" type="number" min="1" placeholder="至少 1">
        </div>
        <div>
          <label for="donor-name">捐款人姓名 (可留空)</label>
          <input id="donor-name" type="text">
        </div>
      </div>
      <div>
        <label for="donation-notes">備註</label>
        <textarea id="donation-notes" placeholder="捐款用途 / 備註"></textarea>
      </div>
      <div class="actions mt">
        <button class="btn" id="btn-add-donation"><span class="text">新增捐款記錄</span></button>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">📊 我的捐款記錄</h3>
      <div id="donation-list"></div>
    </div>
  </div>

  <!-- 支出 / 財務 -->
  <div class="panel" id="panel-finance">
    <div class="card admin-only hidden" id="accounts-card">
      <h3 style="margin-top:0">💳 帳戶餘額</h3>
      <div id="account-list"></div>
    </div>

    <div class="card admin-only hidden" id="budget-card">
      <h3 style="margin-top:0">📈 本月預算使用狀況</h3>
      <div class="progress"><div id="budget-progress"></div></div>
      <div id="budget-detail" style="font-size:14px; margin-top:10px;"></div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">💸 支出申請</h3>
      <div class="grid cols-2">
        <div>
          <label for="expense-category">支出類別 *</label>
          <select id="expense-category">
            <option value="activity">活動支出</option>
            <option value="office">辦公費用</option>
            <option value="marketing">宣傳費用</option>
            <option value="equipment">設備費用</option>
            <option value="welfare">福利支出</option>
            <option value="medical">醫療支援</option>
            <option value="volunteer">志工費用</option>
            <option value="other">其他支出</option>
          </select>
        </div>
        <div>
          <label for="expense-amount">金額 *</label>
          <input id="expense-amount" type="number" min="1" placeholder="請輸入金額">
        </div>
      </div>
      <div>
        <label for="expense-description">說明 *</label>
        <textarea id="expense-description" placeholder="請詳細填寫用途"></textarea>
      </div>
      <div class="actions mt">
        <button class="btn" id="btn-submit-expense"><span class="text">提交支出申請</span></button>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">🗂 我的支出申請</h3>
      <div id="my-expense-list"></div>
    </div>
  </div>

  <!-- 回饋 -->
  <div class="panel" id="panel-feedback">
    <div class="card">
      <h3 style="margin-top:0">📝 活動回饋</h3>
      <div class="grid cols-2">
        <div>
          <label for="feedback-activity">活動 *</label>
          <select id="feedback-activity">
            <option value="">請選擇活動</option>
          </select>
        </div>
        <div>
          <label for="feedback-rating">評分 (1~5) *</label>
          <select id="feedback-rating">
            <option value="">請選擇</option>
            <option value="1">1 - 很不滿意</option>
            <option value="2">2 - 不滿意</option>
            <option value="3">3 - 一般</option>
            <option value="4">4 - 滿意</option>
            <option value="5">5 - 非常滿意</option>
          </select>
        </div>
      </div>
      <div>
        <label for="feedback-comment">意見 / 建議</label>
        <textarea id="feedback-comment" placeholder="分享您的心得 (選填)"></textarea>
      </div>
      <div class="actions mt">
        <button class="btn" id="btn-submit-feedback"><span class="text">提交回饋</span></button>
      </div>
    </div>
    <div class="card">
      <h3 style="margin-top:0">📊 我的回饋記錄</h3>
      <div id="my-feedback-list"></div>
    </div>
  </div>

  <!-- 管理 -->
  <div class="panel" id="panel-admin">
    <!-- 子頁籤 -->
    <div class="subtabs admin-only" id="admin-subtabs">
      <button class="subtab-btn active" data-subtab="overview">總覽</button>
      <button class="subtab-btn" data-subtab="members">會員管理</button>
      <button class="subtab-btn" data-subtab="activities">活動管理</button>
      <button class="subtab-btn" data-subtab="finance">財務管理</button>
      <button class="subtab-btn" data-subtab="audit">支出審核</button>
      <button class="subtab-btn" data-subtab="reports">報表</button>
      <button class="subtab-btn" data-subtab="board">理監事</button>
    </div>

    <!-- 總覽 -->
    <div class="admin-subpanel" id="admin-overview">
      <div class="grid cols-4 mb">
        <div class="stat"><div class="num" id="stat-total-members">0</div><div class="label">總會員</div></div>
          <div class="stat"><div class="num" id="stat-registered-members">0</div><div class="label">已註冊</div></div>
        <div class="stat"><div class="num" id="stat-active-activities">0</div><div class="label">開放活動</div></div>
        <div class="stat"><div class="num" id="stat-total-registrations">0</div><div class="label">有效報名</div></div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">🎯 建立活動</h3>
        <div class="grid cols-2">
          <div>
            <label for="new-activity-name">名稱 *</label>
            <input id="new-activity-name" type="text">
          </div>
          <div>
            <label for="new-activity-date">日期時間 *</label>
            <input id="new-activity-date" type="datetime-local">
          </div>
          <div>
            <label for="new-activity-location">地點</label>
            <input id="new-activity-location" type="text">
          </div>
          <div>
            <label for="new-activity-max">最大人數 (空=不限)</label>
            <input id="new-activity-max" type="number" min="1">
          </div>
          <div>
            <label for="new-activity-fee">費用 (0=免費)</label>
            <input id="new-activity-fee" type="number" min="0" value="0">
          </div>
        </div>
        <div>
          <label for="new-activity-desc">描述 *</label>
          <textarea id="new-activity-desc"></textarea>
        </div>
        <div class="actions mt">
          <button class="btn" id="btn-create-activity"><span class="text">建立活動</span></button>
        </div>
      </div>
    </div>

    <!-- 會員管理 -->
    <div class="admin-subpanel hidden" id="admin-members">
      <div class="card">
        <h3 style="margin-top:0">👥 會員搜尋 / 管理</h3>
        <div class="grid cols-3">
          <div>
            <label for="member-search">關鍵字</label>
            <input id="member-search" type="text" placeholder="姓名 / LINE 名稱 / ID">
          </div>
          <div>
            <label for="member-type-filter">會員類別</label>
            <select id="member-type-filter">
              <option value="">全部</option>
              <option value="patient">病友</option>
              <option value="family">家屬</option>
              <option value="volunteer">志工</option>
              <option value="medical">醫護</option>
              <option value="supporter">支持者</option>
            </select>
          </div>
          <div class="actions" style="align-items:flex-end;">
            <button class="btn secondary" id="btn-search-members"><span class="text">搜尋</span></button>
            <button class="btn outline" id="btn-export-members"><span class="text">匯出 CSV</span></button>
          </div>
        </div>
        <div id="member-result" class="mt"></div>
        <div class="pagination" id="member-pagination"></div>
      </div>
    </div>

    <!-- 活動管理 -->
    <div class="admin-subpanel hidden" id="admin-activities">
      <div class="card">
        <h3 style="margin-top:0">📋 活動管理</h3>
        <div class="inline" style="gap:8px;">
          <div class="search-bar" style="flex:1; min-width:220px;">
            <span class="icon">🔍</span>
            <input id="admin-activity-search" type="text" placeholder="搜尋名稱 / 地點 / 描述">
          </div>
          <select id="admin-activity-status-filter" style="max-width:160px;">
            <option value="">全部狀態</option>
            <option value="開放報名">開放報名</option>
            <option value="已結束">已結束</option>
            <option value="已關閉">已關閉</option>
          </select>
          <button class="btn outline small" id="btn-refresh-activities"><span class="text">重新整理</span></button>
        </div>
        <div id="admin-activity-list" class="mt"></div>
        <div class="pagination" id="admin-activity-pagination"></div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">🧾 活動報名名單</h3>
        <div class="inline" style="gap:8px;">
          <input id="reg-activity-id" type="text" placeholder="輸入活動 ID 以載入報名">
          <button class="btn secondary small" id="btn-load-registrations"><span class="text">載入</span></button>
          <button class="btn outline small" id="btn-export-registrations"><span class="text">匯出名單</span></button>
        </div>
        <div id="registration-result" class="mt"></div>
      </div>
    </div>

    <!-- 財務管理 -->
    <div class="admin-subpanel hidden" id="admin-finance">
      <div class="grid cols-4 mb">
        <div class="stat"><div class="num" id="fin-total-income">0</div><div class="label">總收入</div></div>
        <div class="stat"><div class="num" id="fin-total-expense">0</div><div class="label">總支出</div></div>
        <div class="stat"><div class="num" id="fin-balance">0</div><div class="label">結餘</div></div>
        <div class="stat"><div class="num" id="fin-donation-count">0</div><div class="label">捐款筆數</div></div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">📊 財務分類分佈</h3>
        <div id="finance-category-breakdown"></div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">🗂 交易清單 (捐款 + 已核准支出)</h3>
        <div class="inline" style="gap:8px;">
          <input id="transaction-search" type="text" placeholder="搜尋 (備註 / 類別)">
          <select id="transaction-type-filter" style="max-width:140px;">
            <option value="">全部</option>
            <option value="income">收入</option>
            <option value="expense">支出</option>
          </select>
          <button class="btn outline small" id="btn-refresh-transactions"><span class="text">更新</span></button>
        </div>
        <div id="transaction-list" class="mt"></div>
        <div class="pagination" id="transaction-pagination"></div>
      </div>
    </div>

    <!-- 支出審核 -->
    <div class="admin-subpanel hidden" id="admin-audit">
      <div class="card">
        <h3 style="margin-top:0">💸 支出審核</h3>
        <div id="pending-expense-list"></div>
      </div>
    </div>
    
    <!-- 理監事審查模組 -->
    <div class="admin-subpanel hidden" id="admin-board">
      <div class="card">
        <h3 style="margin-top:0">🗓 建立會議</h3>
        <div class="grid cols-2">
          <div>
            <label>標題 *</label>
            <input id="board-meeting-title" type="text">
          </div>
          <div>
            <label>日期時間 *</label>
            <input id="board-meeting-date" type="datetime-local">
          </div>
        </div>
        <div class="actions mt">
          <button class="btn" id="btn-create-board-meeting"><span class="text">建立會議</span></button>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">📋 會議列表</h3>
        <div id="board-meeting-list"></div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">🧾 議程 / 決議</h3>
        <div class="inline" style="gap:8px;">
          <input id="agenda-meeting-id" placeholder="會議ID">
          <button class="btn small outline" id="btn-load-agenda"><span class="text">載入議程</span></button>
        </div>
        <div id="agenda-list" style="margin-top:10px;"></div>
      </div>
    </div>


    <!-- 報表 -->
    <div class="admin-subpanel hidden" id="admin-reports">
      <div class="card">
        <h3 style="margin-top:0">📊 月報表</h3>
        <div class="grid cols-3">
          <div>
            <label for="report-year">年份 *</label>
            <input id="report-year" type="number" min="2023" max="2035" value="2024">
          </div>
          <div>
            <label for="report-month">月份 *</label>
            <select id="report-month">
              <option value="1">1月</option><option value="2">2月</option><option value="3">3月</option>
              <option value="4">4月</option><option value="5">5月</option><option value="6">6月</option>
              <option value="7">7月</option><option value="8">8月</option><option value="9">9月</option>
              <option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
            </select>
          </div>
          <div class="actions" style="align-items:flex-end;">
            <button class="btn" id="btn-generate-report"><span class="text">產生報表</span></button>
          </div>
        </div>
        <div id="report-result" class="mt"></div>
      </div>
    </div>
  </div>

</div>
<footer>
  帕金森病友會管理系統 v2.3 © 2024
</footer>

<!-- 通知容器 -->
<div id="notify-root"></div>

<script>
/* ==============================
 基本設定
============================== */
const APP = {
  LIFF_ID: '1656516134-VaGgmaPm', // TODO: 替換為實際 LIFF ID
  API_URL: 'https://script.google.com/macros/s/AKfycbxW9vu3Hm5nhXs9mA-KbEr77hfL-LyXJrPXouNYRWscyjjm9Phsyw9QEGGz_u3dJlan5g/exec',
  API_KEY: 'AAbb8520258185202581',
  RETRIES: 3,
  RETRY_DELAY: 800,
  PAGE_SIZE: 6,
  ADMIN_PAGE_SIZE: 12,
  TRANSACTION_PAGE_SIZE: 12
};

let currentUser = null;
let isAdmin = false;
let cachedActivities = [];
let cachedMyActivities = [];
let filteredActivities = [];
let currentActivityPage = 1;

/* Admin 相關快取 */
let adminMembersCache = [];
let filteredMembers = [];
let currentMemberPage = 1;

let adminActivitiesCache = [];
let filteredAdminActivities = [];
let currentAdminActivityPage = 1;

let transactionCache = [];
let filteredTransactions = [];
let currentTransactionPage = 1;

/* ==============================
 工具方法
============================== */
function fmtDate(d){
  if (!d) return '';
  const dt = (d instanceof Date)? d : new Date(d);
  if (isNaN(dt.getTime())) return '';
  return dt.toLocaleDateString('zh-TW', { year:'numeric', month:'2-digit', day:'2-digit' });
}
function fmtDateTime(d){
  if (!d) return '';
  const dt = (d instanceof Date)? d : new Date(d);
  if (isNaN(dt.getTime())) return '';
  return dt.toLocaleString('zh-TW', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
}
function numberFormat(n){ return (n||0).toLocaleString('zh-TW'); }
function setLoading(btn, loading){
  if (!btn) return;
  if (loading){
    btn.classList.add('loading');
    btn.disabled = true;
  } else {
    btn.classList.remove('loading');
    btn.disabled = false;
  }
}
function showNotification(msg, type='info', duration=4000){
  const root = document.getElementById('notify-root');
  const el = document.createElement('div');
  el.className = `notification ${type==='success'?'success': type==='error'?'error': type==='warn'?'warn':''}`;
  el.innerHTML = `<div style="flex:1;">${msg}</div><button aria-label="close">&times;</button>`;
  el.querySelector('button').onclick = ()=> { el.classList.remove('show'); setTimeout(()=>el.remove(),300); };
  root.appendChild(el);
  requestAnimationFrame(()=> el.classList.add('show'));
  if (duration>0){
    setTimeout(()=> {
      el.classList.remove('show');
      setTimeout(()=>el.remove(),350);
    }, duration);
  }
}
function debounce(fn, delay){
  let t; return (...args)=>{
    clearTimeout(t); t=setTimeout(()=>fn(...args), delay);
  };
}

/* ==============================
 API 呼叫層
============================== */
async function callAPI(action, data={}){
  const payload = {
    action,
    apiKey: APP.API_KEY,
    ts: Date.now(),
    nonce: Math.random().toString(36).slice(2),
    ...data
  };
  for (let attempt=1; attempt<=APP.RETRIES; attempt++){
    try {
      const resp = await fetch(APP.API_URL, {
        method: 'POST',
        headers: { 'Content-Type':'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });
      if (!resp.ok){
        throw new Error(`HTTP ${resp.status}`);
      }
      const json = await resp.json();
      return json;
    } catch (e){
      if (attempt === APP.RETRIES) {
        return { success:false, message: e.message || 'API 呼叫失敗', statusCode: 500 };
      }
      await new Promise(r=> setTimeout(r, APP.RETRY_DELAY * attempt));
    }
  }
}

/* ==============================
 LIFF 初始化
============================== */
async function initApp(){
  try {
    showNotification('初始化中...', 'info', 1800);
    await liff.init({ liffId: APP.LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    const profile = await liff.getProfile();
    await callAPI('createUserIfNotExist', { lineId: profile.userId, lineName: profile.displayName });
    await loadUserInfo();
    showNotification('載入完成', 'success', 1200);
    bindEvents();
    // 預載
    loadActivities();
    loadMyActivities();
    loadDonations();
    loadMyExpenses();
    loadMyFeedback();
  } catch (e){
    console.error(e);
    showNotification('初始化失敗：'+ e.message, 'error', 6000);
  }
}

/* ==============================
 使用者
============================== */
async function loadUserInfo(){
  const profile = await liff.getProfile();
  const res = await callAPI('getUserInfo',{ lineId: profile.userId });
  if (!res.success){
    showNotification('無法取得使用者資料', 'error');
    return;
  }
  currentUser = res.data;
  isAdmin = !!currentUser.isAdmin;
  renderUserInfo();
  updateAdminVisibility();
  if (isAdmin) {
    loadSystemStats();
  }
}
function renderUserInfo(){
  const box = document.getElementById('user-info');
  const d = document.getElementById('user-details');
  if (!currentUser){ box.classList.add('hidden'); return; }
  const map = {
    patient: '病友',
    family: '家屬',
    volunteer: '志工',
    medical: '醫護人員',
    supporter: '支持者'
  };
  d.innerHTML = `
    <div class="grid cols-2" style="gap:10px; font-size:13px;">
      <div><b>姓名：</b>${currentUser.realName||'<span style="color:#999">未設定</span>'}</div>
      <div><b>LINE 名稱：</b>${currentUser.lineName||''}</div>
      <div><b>狀態：</b>${ currentUser.status === '已註冊'
        ? '<span class="badge green">已註冊</span>' : '<span class="badge red">未註冊</span>' }</div>
      <div><b>會員類別：</b>${ map[currentUser.memberType] || currentUser.memberType || '<span style="color:#999">未設定</span>'}</div>
      <div><b>互動次數：</b>${currentUser.messageCount||0}</div>
      <div><b>最後互動：</b>${ fmtDate(currentUser.lastActive) || '' }</div>
      ${ isAdmin ? '<div><b>權限：</b><span class="badge blue">管理員</span></div>' : '' }
    </div>
  `;
  box.classList.remove('hidden');

  if (currentUser.realName) document.getElementById('realName').value = currentUser.realName;
  if (currentUser.memberType) document.getElementById('memberType').value = currentUser.memberType;
  document.getElementById('phone').value = currentUser.phone||'';
  document.getElementById('email').value = currentUser.email||'';
  document.getElementById('address').value = currentUser.address||'';
  if (currentUser.birthday) {
    const dt = new Date(currentUser.birthday);
    if (!isNaN(dt.getTime())){
      document.getElementById('birthday').value = dt.toISOString().slice(0,10);
    }
  }
}
function updateAdminVisibility(){
  const adminEls = document.querySelectorAll('.admin-only');
  adminEls.forEach(el=> {
    if (isAdmin) el.classList.remove('hidden'); else el.classList.add('hidden');
  });
}

/* ==============================
 會員註冊 / 更新
============================== */
async function registerOrUpdate(){
  if (!currentUser) return;
  const name = document.getElementById('realName').value.trim();
  const type = document.getElementById('memberType').value;
  if (!name || !type) {
    showNotification('請填寫姓名與類別', 'warn');
    return;
  }
  const btn = document.getElementById('btn-register');
  setLoading(btn,true);
  const res = await callAPI('register',{
    lineId: currentUser.lineId,
    realName: name,
    memberType: type
  });
  setLoading(btn,false);
  if (res.success){
    showNotification('註冊 / 更新成功','success');
    await loadUserInfo();
  } else {
    showNotification('註冊失敗：'+res.message,'error');
  }
}
async function updateContact(){
  if (!currentUser) return;
  const phone = document.getElementById('phone').value.trim();
  const email = document.getElementById('email').value.trim();
  const address = document.getElementById('address').value.trim();
  const birthday = document.getElementById('birthday').value;
  const btn = document.getElementById('btn-update-contact');
  setLoading(btn,true);
  const res = await callAPI('updateUserContact',{
    targetLineId: currentUser.lineId,
    phone, email, address, birthday
  });
  setLoading(btn,false);
  if (res.success){
    showNotification('聯絡資訊已更新','success');
    await loadUserInfo();
  } else {
    showNotification('更新失敗：'+res.message,'error');
  }
}

/* ==============================
 活動 (使用者)
============================== */
async function loadActivities(){
  const res = await callAPI('getActivities');
  if (!res.success){
    document.getElementById('activity-list').innerHTML = `<div class="notice error">載入活動失敗：${res.message}</div>`;
    return;
  }
  cachedActivities = res.data || [];
  filteredActivities = cachedActivities.slice();
  currentActivityPage = 1;
  document.getElementById('stat-activity-total').textContent = cachedActivities.length;
  renderActivities();
}
function renderActivities(){
  const listEl = document.getElementById('activity-list');
  if (!filteredActivities.length){
    listEl.innerHTML = `<div class="empty"><div class="icon">🎯</div>目前沒有活動</div>`;
    document.getElementById('activity-pagination').innerHTML='';
    return;
  }
  const totalPages = Math.ceil(filteredActivities.length / APP.PAGE_SIZE);
  if (currentActivityPage > totalPages) currentActivityPage = totalPages;
  const start = (currentActivityPage-1)*APP.PAGE_SIZE;
  const pageItems = filteredActivities.slice(start, start+APP.PAGE_SIZE);
  listEl.innerHTML = pageItems.map(a=>{
    const max = a.maxParticipants || '不限';
    const cur = a.currentParticipants || 0;
    const full = a.maxParticipants && cur >= a.maxParticipants;
    return `<div class="list-item ${full?'full':''}">
      <h4>${a.name}</h4>
      <div class="meta">
        <span>📅 ${ fmtDateTime(a.date) || '待定' }</span>
        <span>📍 ${ a.location || '待定' }</span>
        <span>👥 ${cur}/${max}</span>
        <span>${ a.fee ? '💰 NT$ '+numberFormat(a.fee) : '🆓 免費'}</span>
      </div>
      <div style="margin-top:8px;font-size:13px;line-height:1.5;">${ a.description || '' }</div>
      <div class="actions" style="margin-top:12px;">
        ${ full
          ? '<span class="badge red">已額滿</span>'
          : `<button class="btn small" data-act-register="${a.id}"><span class="text">報名</span></button>` }
      </div>
    </div>`;
  }).join('');
  renderPagination('activity-pagination', totalPages, currentActivityPage, p=>{
    currentActivityPage = p; renderActivities();
  });
  listEl.querySelectorAll('[data-act-register]').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      const id = btn.getAttribute('data-act-register');
      const target = cachedActivities.find(x=>x.id===id);
      if (target) registerActivity(target);
    });
  });
}
function renderPagination(id, totalPages, current, onChange){
  const el = document.getElementById(id);
  if (totalPages <=1 ){ el.innerHTML=''; return; }
  let html='';
  for (let i=1;i<=totalPages;i++){
    html += `<button class="${ i===current?'active':'' }" data-page="${i}">${i}</button>`;
  }
  el.innerHTML = html;
  el.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', ()=> {
      const p = +b.getAttribute('data-page');
      onChange(p);
    });
  });
}
const searchActivities = debounce(()=>{
  const kw = document.getElementById('activity-search').value.trim().toLowerCase();
  if (!kw){
    filteredActivities = cachedActivities.slice();
  } else {
    filteredActivities = cachedActivities.filter(a =>
      (a.name && a.name.toLowerCase().includes(kw)) ||
      (a.description && a.description.toLowerCase().includes(kw)) ||
      (a.location && a.location.toLowerCase().includes(kw))
    );
  }
  currentActivityPage=1;
  renderActivities();
}, 300);

async function registerActivity(activity){
  if (!currentUser || currentUser.status!=='已註冊'){
    showNotification('請先完成註冊','warn');
    switchTab('profile');
    return;
  }
  if (!confirm(`確認報名活動「${activity.name}」?`)) return;
  const res = await callAPI('registerActivity',{
    lineId: currentUser.lineId,
    activityId: activity.id,
    participantName: currentUser.realName || currentUser.lineName
  });
  if (res.success){
    showNotification('報名成功','success');
    await Promise.all([loadActivities(), loadMyActivities()]);
  } else {
    showNotification('報名失敗：'+res.message,'error');
  }
}
async function loadMyActivities(){
  if (!currentUser) return;
  const res = await callAPI('getUserActivities',{ lineId: currentUser.lineId });
  const box = document.getElementById('my-activity-list');
  if (!res.success){
    box.innerHTML = `<div class="notice error">${res.message}</div>`;
    return;
  }
  cachedMyActivities = res.data||[];
  document.getElementById('stat-my-registrations').textContent = cachedMyActivities.length;
  if (!cachedMyActivities.length){
    box.innerHTML = `<div class="empty"><div class="icon">📋</div>尚無報名記錄</div>`;
    return;
  }
  box.innerHTML = cachedMyActivities.map(r=>{
    return `<div class="list-item">
      <h4>${r.activityName}</h4>
      <div class="meta">
        <span>📅 ${ fmtDateTime(r.date) }</span>
        <span>📍 ${ r.location || '待定' }</span>
        <span>👤 ${ r.participantName }</span>
        <span>📝 報名：${ fmtDate(r.registerDate) }</span>
      </div>
      <div style="margin-top:4px;">
        狀態：${
          r.status==='已報名' ? '<span class="badge green">已報名</span>' :
          r.status==='已取消' ? '<span class="badge red">已取消</span>' :
          `<span class="badge orange">${r.status||'未知'}</span>`
        }
      </div>
      ${ r.status==='已報名'
        ? `<div class="actions" style="margin-top:8px;">
             <button class="btn danger small" data-cancel="${r.id}"><span class="text">取消報名</span></button>
           </div>` : ''
      }
    </div>`;
  }).join('');
  buildFeedbackActivityOptions();
  box.querySelectorAll('[data-cancel]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-cancel');
      cancelRegistration(id);
    });
  });
}
async function cancelRegistration(regId){
  if (!confirm('確定取消此報名?')) return;
  const res = await callAPI('cancelActivity',{ lineId: currentUser.lineId, registrationId: regId });
  if (res.success){
    showNotification('已取消','success');
    await Promise.all([loadActivities(), loadMyActivities()]);
  } else {
    showNotification('取消失敗：'+res.message,'error');
  }
}

/* ==============================
 捐款
============================== */
async function addDonation(){
  if (!currentUser) return;
  const amt = parseFloat(document.getElementById('donation-amount').value);
  if (!amt || amt<=0){
    showNotification('金額需 > 0','warn'); return;
  }
  const donorName = document.getElementById('donor-name').value.trim();
  const notes = document.getElementById('donation-notes').value.trim();
  const btn = document.getElementById('btn-add-donation');
  setLoading(btn,true);
  const res = await callAPI('addDonation',{
    lineId: currentUser.lineId,
    amount: amt,
    donorName,
    notes
  });
  setLoading(btn,false);
  if (res.success){
    showNotification('捐款成功','success');
    document.getElementById('donation-amount').value='';
    document.getElementById('donor-name').value='';
    document.getElementById('donation-notes').value='';
    loadDonations();
  } else {
    showNotification('捐款失敗：'+res.message,'error');
  }
}
async function loadDonations(){
  if (!currentUser) return;
  const box = document.getElementById('donation-list');
  const res = await callAPI('getDonations',{ lineId: currentUser.lineId });
  if (!res.success){
    box.innerHTML = `<div class="notice error">${res.message}</div>`;
    return;
  }
  const arr = res.data||[];
  document.getElementById('stat-donation-count').textContent = arr.length;
  const total = arr.reduce((s,d)=> s + (parseFloat(d.amount)||0), 0);
  document.getElementById('stat-donation-total').textContent = 'NT$ ' + numberFormat(total);
  if (!arr.length){
    box.innerHTML = `<div class="empty"><div class="icon">💰</div>尚無捐款記錄</div>`;
    return;
  }
  box.innerHTML = arr.map(d=>`
    <div class="list-item">
      <h4>捐款 NT$ ${ numberFormat(d.amount) }</h4>
      <div class="meta">
        <span>🕒 ${ fmtDateTime(d.date) }</span>
        <span>🙍 ${ d.donorName || '匿名' }</span>
      </div>
      ${ d.notes ? `<div style="margin-top:6px;font-size:13px;">備註：${d.notes}</div>`:''}
    </div>
  `).join('');
}

/* ==============================
 支出
============================== */
async function submitExpense(){
  if (!currentUser) return;
  const category = document.getElementById('expense-category').value;
  const amount = parseFloat(document.getElementById('expense-amount').value);
  const desc = document.getElementById('expense-description').value.trim();
  if (!category || !amount || amount<=0 || !desc){
    showNotification('請完整填寫支出資訊','warn'); return;
  }
  const btn = document.getElementById('btn-submit-expense');
  setLoading(btn,true);
  const res = await callAPI('submitExpense',{
    lineId: currentUser.lineId,
    category,
    amount,
    description: desc
  });
  setLoading(btn,false);
  if (res.success){
    showNotification('支出申請已提交','success');
    document.getElementById('expense-amount').value='';
    document.getElementById('expense-description').value='';
    loadMyExpenses();
  } else {
    showNotification('提交失敗：'+res.message,'error');
  }
}
async function loadMyExpenses(){
  if (!currentUser) return;
  const box = document.getElementById('my-expense-list');
  const res = await callAPI('getMyExpenses',{ lineId: currentUser.lineId });
  if (!res.success){
    box.innerHTML = `<div class="notice error">${res.message}</div>`;
    return;
  }
  const arr = res.data||[];
  if (!arr.length){
    box.innerHTML = `<div class="empty"><div class="icon">📋</div>尚無支出申請</div>`;
    return;
  }
  box.innerHTML = arr.map(e=>{
    const statusClass =
      e.status==='已核准' ? 'green' :
      e.status==='已拒絕' ? 'red' :
      'orange';
    return `<div class="list-item">
      <h4>${ e.category } - NT$ ${ numberFormat(e.amount) }</h4>
      <div class="meta">
        <span>🕒 申請：${ fmtDateTime(e.submitDate) }</span>
        ${ e.approvedDate ? `<span>🔍 審核：${ fmtDateTime(e.approvedDate) }</span>`:''}
      </div>
      <div style="margin-top:4px;">狀態：<span class="badge ${statusClass}">${e.status}</span></div>
      ${ e.description ? `<div style="margin-top:4px;font-size:13px;">說明：${e.description}</div>`:''}
      ${ e.notes ? `<div style="margin-top:4px;font-size:13px;">審核備註：${e.notes}</div>`:''}
    </div>`;
  }).join('');
}

/* ==============================
 回饋
============================== */
function buildFeedbackActivityOptions(){
  const select = document.getElementById('feedback-activity');
  const active = cachedMyActivities.filter(a=> a.status==='已報名');
  select.innerHTML = '<option value="">請選擇活動</option>' + active.map(a=> `<option value="${a.activityId}">${a.activityName}</option>`).join('');
}
async function submitFeedback(){
  if (!currentUser) return;
  const activityId = document.getElementById('feedback-activity').value;
  const rating = parseInt(document.getElementById('feedback-rating').value, 10);
  const comment = document.getElementById('feedback-comment').value.trim();
  if (!activityId || !rating){
    showNotification('請選擇活動與評分','warn'); return;
  }
  const btn = document.getElementById('btn-submit-feedback');
  setLoading(btn,true);
  const res = await callAPI('submitFeedback',{
    lineId: currentUser.lineId,
    activityId,
    rating,
    comment
  });
  setLoading(btn,false);
  if (res.success){
    showNotification('回饋已提交','success');
    document.getElementById('feedback-activity').value='';
    document.getElementById('feedback-rating').value='';
    document.getElementById('feedback-comment').value='';
    loadMyFeedback();
  } else {
    showNotification('提交失敗：'+res.message,'error');
  }
}
async function loadMyFeedback(){
  if (!currentUser) return;
  const box = document.getElementById('my-feedback-list');
  const res = await callAPI('getMyFeedback',{ lineId: currentUser.lineId });
  if (!res.success){
    box.innerHTML = `<div class="notice error">${res.message}</div>`;
    return;
  }
  const arr = res.data||[];
  if (!arr.length){
    box.innerHTML = `<div class="empty"><div class="icon">📝</div>尚無回饋</div>`;
    return;
  }
  box.innerHTML = arr.map(f=>{
    const stars = '⭐'.repeat(f.rating) + '☆'.repeat(5-f.rating);
    return `<div class="list-item">
      <h4>${f.activityName}</h4>
      <div class="meta">
        <span>評分：${stars} (${f.rating}/5)</span>
        <span>日期：${ fmtDate(f.submitDate) }</span>
      </div>
      ${ f.comment ? `<div style="margin-top:6px;font-size:13px;">${f.comment}</div>`:''}
    </div>`;
  }).join('');
}

/* ==============================
 管理 - 總覽統計
============================== */
async function loadSystemStats(){
  if (!isAdmin || !currentUser) return;
  const res = await callAPI('getSystemStats',{ operatorLineId: currentUser.lineId });
  if (res.success){
    const d = res.data;
    document.getElementById('stat-total-members').textContent = d.totalMembers;
    document.getElementById('stat-registered-members').textContent = d.registeredMembers;
    document.getElementById('stat-active-activities').textContent = d.activeActivities;
    document.getElementById('stat-total-registrations').textContent = d.totalRegistrations;
  }
}

/* ==============================
 管理 - 會員管理
============================== */
async function searchMembers(pageReset=true){
  if (!isAdmin || !currentUser) return;
  if (pageReset) currentMemberPage = 1;
  const kw = document.getElementById('member-search').value.trim();
  const type = document.getElementById('member-type-filter').value;
  const box = document.getElementById('member-result');
  box.innerHTML = '<div class="notice info">搜尋中...</div>';
  const res = await callAPI('getAllMembers',{
    operatorLineId: currentUser.lineId,
    searchTerm: kw,
    memberType: type
  });
  if (!res.success){
    box.innerHTML = `<div class="notice error">${res.message}</div>`;
    return;
  }
  adminMembersCache = res.data||[];
  filteredMembers = adminMembersCache.slice();
  renderMemberTable();
}
function renderMemberTable(){
  const box = document.getElementById('member-result');
  if (!filteredMembers.length){
    box.innerHTML = '<div class="empty"><div class="icon">👥</div>無符合結果</div>';
    document.getElementById('member-pagination').innerHTML='';
    return;
  }
  const totalPages = Math.ceil(filteredMembers.length / APP.ADMIN_PAGE_SIZE);
  if (currentMemberPage > totalPages) currentMemberPage = totalPages;
  const start = (currentMemberPage-1)*APP.ADMIN_PAGE_SIZE;
  const pageItems = filteredMembers.slice(start, start+APP.ADMIN_PAGE_SIZE);
  box.innerHTML = `
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>姓名</th><th>LINE</th><th>類別</th><th>狀態</th>
            <th>聯絡</th><th>互動</th><th>管理員</th><th>操作</th>
          </tr>
        </thead>
        <tbody>
          ${pageItems.map(m=>{
            return `<tr data-line-id="${m.lineId}">
              <td><input class="inline-edit-input" data-field="realName" value="${m.realName||''}" placeholder="姓名"></td>
              <td style="min-width:110px;">${m.lineName||''}<br><small style="color:#666">${m.lineId.slice(0,8)}...</small></td>
              <td>
                <select class="inline-edit-input" data-field="memberType">
                  <option value="">(空)</option>
                  <option value="patient" ${m.memberType==='patient'?'selected':''}>病友</option>
                  <option value="family" ${m.memberType==='family'?'selected':''}>家屬</option>
                  <option value="volunteer" ${m.memberType==='volunteer'?'selected':''}>志工</option>
                  <option value="medical" ${m.memberType==='medical'?'selected':''}>醫護</option>
                  <option value="supporter" ${m.memberType==='supporter'?'selected':''}>支持者</option>
                </select>
              </td>
              <td>
                <select class="inline-edit-input" data-field="status">
                  <option value="未註冊" ${m.status==='未註冊'?'selected':''}>未註冊</option>
                  <option value="已註冊" ${m.status==='已註冊'?'selected':''}>已註冊</option>
                  <option value="停用" ${m.status==='停用'?'selected':''}>停用</option>
                </select>
              </td>
              <td style="min-width:150px; font-size:11px;">
                ${ m.email ? '✉ '+m.email+'<br>' : '' }
                ${ m.phone ? '📞 '+m.phone : '' }
              </td>
              <td>${m.messageCount||0}</td>
              <td>
                <select class="inline-edit-input" data-field="isAdmin">
                  <option value="false" ${!m.isAdmin?'selected':''}>否</option>
                  <option value="true" ${m.isAdmin?'selected':''}>是</option>
                </select>
              </td>
              <td>
                <button class="btn small outline" data-save="${m.lineId}"><span class="text">儲存</span></button>
              </td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
  renderPagination('member-pagination', totalPages, currentMemberPage, p=>{
    currentMemberPage = p; renderMemberTable();
  });
  box.querySelectorAll('[data-save]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const lineId = btn.getAttribute('data-save');
      saveMemberRow(lineId, btn);
    });
  });
}
async function saveMemberRow(lineId, btn){
  const row = document.querySelector(`tr[data-line-id="${lineId}"]`);
  if (!row) return;
  const payload = {
    realName: row.querySelector('[data-field="realName"]').value.trim(),
    memberType: row.querySelector('[data-field="memberType"]').value,
    status: row.querySelector('[data-field="status"]').value,
    isAdmin: row.querySelector('[data-field="isAdmin"]').value === 'true'
  };
  setLoading(btn,true);
  const res = await callAPI('updateMember',{
    operatorLineId: currentUser.lineId,
    targetLineId: lineId,
    ...payload
  });
  setLoading(btn,false);
  if (res.success){
    showNotification('更新成功','success');
    searchMembers(false);
  } else {
    showNotification('更新失敗: '+res.message,'error');
  }
}
async function exportMembers(){
  if (!isAdmin) return;
  const res = await callAPI('exportMembers',{ operatorLineId: currentUser.lineId });
  if (!res.success){
    showNotification('匯出失敗: '+res.message,'error');
    return;
  }
  const csv = res.data && res.data.csv;
  if (!csv){
    showNotification('無資料','warn');
    return;
  }
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `members_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ==============================
 管理 - 活動管理
============================== */
async function loadAllActivities(){
  if (!isAdmin) return;
  const res = await callAPI('getAllActivities',{ operatorLineId: currentUser.lineId });
  if (!res.success){
    document.getElementById('admin-activity-list').innerHTML = `<div class="notice error">${res.message}</div>`;
    return;
  }
  adminActivitiesCache = res.data||[];
  filterAdminActivities();
}
function filterAdminActivities(){
  const kw = document.getElementById('admin-activity-search').value.trim().toLowerCase();
  const statusFilter = document.getElementById('admin-activity-status-filter').value;
  filteredAdminActivities = adminActivitiesCache.filter(a=>{
    let ok = true;
    if (kw){
      ok = (a.name && a.name.toLowerCase().includes(kw)) ||
           (a.description && a.description.toLowerCase().includes(kw)) ||
           (a.location && a.location.toLowerCase().includes(kw));
    }
    if (ok && statusFilter){
      ok = a.status === statusFilter;
    }
    return ok;
  });
  currentAdminActivityPage = 1;
  renderAdminActivityList();
}
function renderAdminActivityList(){
  const box = document.getElementById('admin-activity-list');
  if (!filteredAdminActivities.length){
    box.innerHTML = '<div class="empty"><div class="icon">📁</div>無活動資料</div>';
    document.getElementById('admin-activity-pagination').innerHTML='';
    return;
  }
  const totalPages = Math.ceil(filteredAdminActivities.length / APP.ADMIN_PAGE_SIZE);
  if (currentAdminActivityPage > totalPages) currentAdminActivityPage = totalPages;
  const start = (currentAdminActivityPage-1)*APP.ADMIN_PAGE_SIZE;
  const pageItems = filteredAdminActivities.slice(start, start+APP.ADMIN_PAGE_SIZE);
  box.innerHTML = pageItems.map(a=>{
    return `<div class="list-item">
      <h4>${a.name} <span class="badge ${a.status==='開放報名'?'green': (a.status==='已結束'?'blue':'red')}">${a.status}</span></h4>
      <div class="meta">
        <span>ID: ${a.id}</span>
        <span>📅 ${fmtDateTime(a.date) || '待定'}</span>
        <span>📍 ${a.location||'-'}</span>
        <span>👥 ${a.currentParticipants||0}/${a.maxParticipants||'不限'}</span>
        <span>${a.fee? '💰 NT$ '+numberFormat(a.fee):'🆓 免費'}</span>
      </div>
      <div style="margin-top:6px;font-size:12.5px;">${a.description||''}</div>
      <div class="actions" style="margin-top:8px;">
        <button class="btn small outline" data-edit-act="${a.id}"><span class="text">編輯</span></button>
        <button class="btn small" data-toggle-status="${a.id}"><span class="text">${a.status==='開放報名'?'關閉':'重新開放'}</span></button>
        <button class="btn danger small" data-delete-act="${a.id}"><span class="text">刪除</span></button>
      </div>
      <div id="edit-panel-${a.id}" class="hidden" style="margin-top:10px; padding:10px; border:1px dashed #cbd5e0; border-radius:10px;">
        <div class="grid cols-2">
          <div>
            <label>名稱</label>
            <input data-field="name" value="${a.name||''}">
          </div>
          <div>
            <label>日期時間</label>
            <input data-field="date" type="datetime-local" value="${ a.date ? new Date(a.date).toISOString().slice(0,16):''}">
          </div>
          <div>
            <label>地點</label>
            <input data-field="location" value="${a.location||''}">
          </div>
          <div>
            <label>最大人數</label>
            <input data-field="maxParticipants" type="number" min="0" value="${a.maxParticipants||''}">
          </div>
          <div>
            <label>費用</label>
            <input data-field="fee" type="number" min="0" value="${a.fee||0}">
          </div>
        </div>
          <div style="margin-top:8px;">
            <label>描述</label>
            <textarea data-field="description">${a.description||''}</textarea>
          </div>
        <div class="actions mt">
          <button class="btn small" data-save-edit="${a.id}"><span class="text">儲存變更</span></button>
          <button class="btn secondary small" data-cancel-edit="${a.id}"><span class="text">取消</span></button>
        </div>
      </div>
    </div>`;
  }).join('');
  renderPagination('admin-activity-pagination', totalPages, currentAdminActivityPage, p=>{
    currentAdminActivityPage = p; renderAdminActivityList();
  });
  box.querySelectorAll('[data-edit-act]').forEach(b=>{
    b.addEventListener('click',()=>{
      const id = b.getAttribute('data-edit-act');
      document.getElementById('edit-panel-'+id).classList.toggle('hidden');
    });
  });
  box.querySelectorAll('[data-cancel-edit]').forEach(b=>{
    b.addEventListener('click',()=>{
      const id = b.getAttribute('data-cancel-edit');
      document.getElementById('edit-panel-'+id).classList.add('hidden');
    });
  });
  box.querySelectorAll('[data-save-edit]').forEach(b=>{
    b.addEventListener('click',()=> saveActivityEdit(b.getAttribute('data-save-edit'), b));
  });
  box.querySelectorAll('[data-toggle-status]').forEach(b=>{
    b.addEventListener('click',()=> toggleActivityStatus(b.getAttribute('data-toggle-status')));
  });
  box.querySelectorAll('[data-delete-act]').forEach(b=>{
    b.addEventListener('click',()=> deleteActivity(b.getAttribute('data-delete-act')));
  });
}
async function saveActivityEdit(id, btn){
  const panel = document.getElementById('edit-panel-'+id);
  if (!panel) return;
  const getVal = sel => panel.querySelector(`[data-field="${sel}"]`)?.value || '';
  const payload = {
    name: getVal('name').trim(),
    date: getVal('date'),
    location: getVal('location').trim(),
    maxParticipants: getVal('maxParticipants'),
    fee: getVal('fee'),
    description: panel.querySelector('[data-field="description"]').value.trim()
  };
  if (!payload.name){
    showNotification('名稱不可空白','warn'); return;
  }
  setLoading(btn,true);
  const res = await callAPI('updateActivity',{
    operatorLineId: currentUser.lineId,
    activityId: id,
    ...payload
  });
  setLoading(btn,false);
  if (res.success){
    showNotification('活動已更新','success');
    await loadAllActivities();
    loadActivities();
  } else {
    showNotification('更新失敗:'+res.message,'error');
  }
}
async function toggleActivityStatus(id){
  const act = adminActivitiesCache.find(a=>a.id===id);
  if (!act) return;
  const to = act.status==='開放報名' ? '已關閉' : '開放報名';
  if (!confirm(`確認將活動狀態改為「${to}」?`)) return;
  const res = await callAPI('changeActivityStatus',{
    operatorLineId: currentUser.lineId,
    activityId: id,
    status: to
  });
  if (res.success){
    showNotification('狀態已更新','success');
    await loadAllActivities();
    loadActivities();
  } else {
    showNotification('操作失敗:'+res.message,'error');
  }
}
async function deleteActivity(id){
  if (!confirm('確認刪除此活動？此操作無法恢復。')) return;
  const res = await callAPI('deleteActivity',{
    operatorLineId: currentUser.lineId,
    activityId: id
  });
  if (res.success){
    showNotification('活動已刪除','success');
    await loadAllActivities();
    loadActivities();
  } else {
    showNotification('刪除失敗:'+res.message,'error');
  }
}
async function loadRegistrations(){
  const actId = document.getElementById('reg-activity-id').value.trim();
  const box = document.getElementById('registration-result');
  if (!actId){
    showNotification('請輸入活動 ID','warn'); return;
  }
  box.innerHTML = '<div class="notice info">載入中...</div>';
  const res = await callAPI('getActivityRegistrations',{
    operatorLineId: currentUser.lineId,
    activityId: actId
  });
  if (!res.success){
    box.innerHTML = `<div class="notice error">${res.message}</div>`;
    return;
  }
  const arr = res.data||[];
  if (!arr.length){
    box.innerHTML = '<div class="empty"><div class="icon">🧾</div>無報名資料</div>';
    return;
  }
  box.innerHTML = `
    <div class="table-wrap">
      <table>
        <thead><tr><th>報名ID</th><th>姓名</th><th>狀態</th><th>報名時間</th></tr></thead>
        <tbody>
          ${arr.map(r=> `<tr>
            <td>${r.id}</td>
            <td>${r.participantName}</td>
            <td>${r.status}</td>
            <td>${fmtDateTime(r.registerDate)}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>
  `;
}
function exportRegistrations(){
  const actId = document.getElementById('reg-activity-id').value.trim();
  if (!actId){
    showNotification('請輸入活動 ID','warn'); return;
  }
  callAPI('getActivityRegistrations',{
    operatorLineId: currentUser.lineId,
    activityId: actId
  }).then(res=>{
    if (!res.success){
      showNotification('匯出失敗:'+res.message,'error'); return;
    }
    const arr = res.data || [];
    if (!arr.length){
      showNotification('無報名資料','warn'); return;
    }
    const header = ['報名ID','姓名','狀態','報名時間'];
    const rows = arr.map(r=> [
      r.id,
      r.participantName,
      r.status,
      fmtDateTime(r.registerDate)
    ]);
    const csv = [header].concat(rows).map(line=> line.map(v=> `"${(v||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url;
    a.download=`activity_${actId}_registrations.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });
}

/* ==============================
 管理 - 財務管理
============================== */
async function loadFinanceOverview(){
  if (!isAdmin) return;
  const res = await callAPI('getFinanceOverview',{ operatorLineId: currentUser.lineId });
  if (!res.success){
    showNotification('財務概覽取得失敗:'+res.message,'error');
    return;
  }
  const d = res.data;
  document.getElementById('fin-total-income').textContent = 'NT$ '+numberFormat(d.totalIncome);
  document.getElementById('fin-total-expense').textContent = 'NT$ '+numberFormat(d.totalExpense);
  document.getElementById('fin-balance').textContent = 'NT$ '+numberFormat(d.balance);
  document.getElementById('fin-donation-count').textContent = d.donationCount||0;

  const catBox = document.getElementById('finance-category-breakdown');
  const cb = d.categoryBreakdown || {};
  if (!Object.keys(cb).length){
    catBox.innerHTML = '<div style="font-size:12px;color:#666;">尚無分類資料</div>';
  } else {
    catBox.innerHTML = Object.entries(cb).map(([k,v])=>`
      <div style="background:#fff;padding:10px 12px;border-radius:10px;margin:6px 0;box-shadow:var(--shadow);">
        <div style="font-size:13px;font-weight:600;">${k}</div>
        <div class="trend-bar" style="margin-top:6px;">
          <span style="width:${Math.min(100,(v/d.totalExpense)*100||0)}%"></span>
        </div>
        <div style="font-size:12px;color:#555;margin-top:4px;">NT$ ${numberFormat(v)}</div>
      </div>
    `).join('');
  }
}

async function loadTransactions(){
  if (!isAdmin) return;
  const res = await callAPI('getTransactions',{ operatorLineId: currentUser.lineId });
  if (!res.success){
    document.getElementById('transaction-list').innerHTML = `<div class="notice error">${res.message}</div>`;
    return;
  }
  transactionCache = res.data||[];
  filterTransactions();
}
function filterTransactions(){
  const kw = document.getElementById('transaction-search').value.trim().toLowerCase();
  const type = document.getElementById('transaction-type-filter').value;
  filteredTransactions = transactionCache.filter(t=>{
    let ok = true;
    if (kw){
      ok = (t.notes && t.notes.toLowerCase().includes(kw)) ||
           (t.category && t.category.toLowerCase().includes(kw)) ||
           (t.donorName && t.donorName.toLowerCase().includes(kw));
    }
    if (ok && type){
      ok = t.type === type;
    }
    return ok;
  });
  currentTransactionPage = 1;
  renderTransactions();
}
function renderTransactions(){
  const box = document.getElementById('transaction-list');
  if (!filteredTransactions.length){
    box.innerHTML = '<div class="empty"><div class="icon">💼</div>無交易資料</div>';
    document.getElementById('transaction-pagination').innerHTML='';
    return;
  }
  const totalPages = Math.ceil(filteredTransactions.length / APP.TRANSACTION_PAGE_SIZE);
  if (currentTransactionPage > totalPages) currentTransactionPage = totalPages;
  const start = (currentTransactionPage-1)*APP.TRANSACTION_PAGE_SIZE;
  const pageItems = filteredTransactions.slice(start, start+APP.TRANSACTION_PAGE_SIZE);
  box.innerHTML = pageItems.map(t=>{
    return `<div class="list-item">
      <h4>${ t.type==='income' ? '收入' : '支出' } - NT$ ${ numberFormat(Math.abs(t.amount)) }
        <span class="badge ${t.type==='income'?'green':'red'}">${t.type==='income'?'收入':'支出'}</span>
        ${ t.category ? `<span class="badge">${t.category}</span>`:''}
      </h4>
      <div class="meta">
        <span>🕒 ${fmtDateTime(t.date)}</span>
        ${ t.type==='income' && t.donorName ? `<span>🙍 ${t.donorName||'匿名'}</span>`:''}
      </div>
      ${ t.notes ? `<div style="margin-top:6px;font-size:12.5px;">${t.notes}</div>`:''}
    </div>`;
  }).join('');
  renderPagination('transaction-pagination', totalPages, currentTransactionPage, p=>{
    currentTransactionPage = p; renderTransactions();
  });
}

/* ==============================
 支出審核 (管理員)
============================== */
async function loadPendingExpenses(){
  if (!isAdmin || !currentUser) return;
  const box = document.getElementById('pending-expense-list');
  const res = await callAPI('getPendingExpenses',{ operatorLineId: currentUser.lineId });
  if (!res.success){
    box.innerHTML = `<div class="notice error">${res.message}</div>`;
    return;
  }
  const arr = res.data||[];
  if (!arr.length){
    box.innerHTML = `<div class="empty"><div class="icon">✅</div>無待審核項目</div>`;
    return;
  }
  box.innerHTML = arr.map(e=>{
    return `<div class="list-item">
      <h4>${e.applicantName} - ${e.category}</h4>
      <div class="meta">
        <span>金額: NT$ ${ numberFormat(e.amount) }</span>
        <span>日期: ${ fmtDateTime(e.submitDate) }</span>
      </div>
      <div style="margin-top:6px;font-size:13px;">${ e.description || '' }</div>
      <div class="actions" style="margin-top:10px;">
        <button class="btn small" data-approve="${e.id}"><span class="text">核准</span></button>
        <button class="btn danger small" data-reject="${e.id}"><span class="text">拒絕</span></button>
      </div>
    </div>`;
  }).join('');
  box.querySelectorAll('[data-approve]').forEach(b=>{
    b.addEventListener('click', ()=> approveExpense(b.getAttribute('data-approve'), true));
  });
  box.querySelectorAll('[data-reject]').forEach(b=>{
    b.addEventListener('click', ()=> approveExpense(b.getAttribute('data-reject'), false));
  });
}
async function approveExpense(id, approved){
  const notes = approved ? '' : prompt('拒絕原因 (可留空)：','');
  const res = await callAPI('approveExpense',{
    operatorLineId: currentUser.lineId,
    expenseId: id,
    approved,
    notes
  });
  if (res.success){
    showNotification(approved?'已核准':'已拒絕','success');
    loadPendingExpenses();
    loadMyExpenses();
    loadFinanceOverview();
    loadTransactions();
  } else {
    showNotification('操作失敗：'+res.message,'error');
  }
}

/* ==============================
 報表 (已存在)
============================== */
async function generateReport(){
  if (!isAdmin || !currentUser) return;
  const y = document.getElementById('report-year').value;
  const m = document.getElementById('report-month').value;
  const box = document.getElementById('report-result');
  box.innerHTML = '<div class="notice info">產生中...</div>';
  const res = await callAPI('generateReport',{
    operatorLineId: currentUser.lineId,
    year: parseInt(y,10),
    month: parseInt(m,10)
  });
  if (!res.success){
    box.innerHTML = `<div class="notice error">${res.message}</div>`;
    return;
  }
  const d = res.data;
  const cb = d.categoryBreakdown || {};
  const cbHtml = Object.keys(cb).length
    ? `<div class="grid cols-2" style="margin-top:10px;">${ Object.entries(cb).map(([k,v])=>`
        <div style="background:#f7fafc;padding:10px 12px;border-radius:8px;font-size:13px;">
          <b>${k}</b><br>NT$ ${ numberFormat(v) }
        </div>`).join('') }</div>`
    : '<div style="font-size:13px;color:#666;margin-top:6px;">無支出分類資料</div>';
  box.innerHTML = `
    <div class="card" style="margin:0;">
      <h4 style="margin-top:0;">📊 ${d.period} 報表</h4>
      <div class="grid cols-4" style="margin:10px 0;">
        <div class="stat"><div class="num">NT$ ${ numberFormat(d.totalIncome) }</div><div class="label">總收入</div></div>
        <div class="stat"><div class="num">NT$ ${ numberFormat(d.totalExpense) }</div><div class="label">總支出</div></div>
        <div class="stat"><div class="num">NT$ ${ numberFormat(d.balance) }</div><div class="label">結餘</div></div>
        <div class="stat"><div class="num">${ d.donationCount||0 }</div><div class="label">捐款筆數</div></div>
      </div>
      <h5 style="margin:14px 0 6px;">支出分類</h5>
      ${ cbHtml }
    </div>
  `;
}

/* ==============================
 帳戶 / 預算 (原有)
============================== */
async function loadAccountsAndBudget(){
  if (!isAdmin || !currentUser) return;
  const accRes = await callAPI('getAccounts',{ operatorLineId: currentUser.lineId });
  const accBox = document.getElementById('account-list');
  if (accRes.success){
    const arr = accRes.data||[];
    accBox.innerHTML = arr.map(a=>`
      <div class="list-item">
        <h4>${a.name}</h4>
        <div class="meta">
          <span>類型: ${a.type}</span>
          <span>餘額: NT$ ${ numberFormat(a.balance) }</span>
        </div>
      </div>
    `).join('');
  } else {
    accBox.innerHTML = `<div class="notice error">${accRes.message}</div>`;
  }
  const bdRes = await callAPI('getBudgetStatus',{ operatorLineId: currentUser.lineId });
  const prog = document.getElementById('budget-progress');
  const detail = document.getElementById('budget-detail');
  if (bdRes.success){
    const d = bdRes.data;
    prog.style.width = d.budgetUsed + '%';
    detail.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;">
        <div>月預算：<b>NT$ ${numberFormat(d.monthlyBudget)}</b></div>
        <div>已使用：<b>NT$ ${numberFormat(d.monthlyExpense)}</b></div>
        <div>使用率：<b>${d.budgetUsed}%</b></div>
        <div>剩餘：<b>NT$ ${numberFormat(d.remainingBudget)}</b></div>
      </div>
    `;
  } else {
    detail.innerHTML = `<div class="notice error">${bdRes.message}</div>`;
  }
}

/* ==============================
 分頁切換
============================== */
function switchTab(tab){
  document.querySelectorAll('.tab-btn').forEach(t=>{
    t.classList.toggle('active', t.dataset.tab===tab);
  });
  document.querySelectorAll('.panel').forEach(p=>{
    p.classList.toggle('active', p.id === 'panel-'+tab);
  });
  if (tab==='activities'){ loadActivities(); loadMyActivities(); }
  if (tab==='donations'){ loadDonations(); }
  if (tab==='finance'){ loadMyExpenses(); if(isAdmin){ loadAccountsAndBudget(); } }
  if (tab==='feedback'){ loadMyActivities(); loadMyFeedback(); }
  if (tab==='admin' && isAdmin){
    // 預設總覽
    switchAdminSubTab('overview');
  }
}

function switchAdminSubTab(sub){
  document.querySelectorAll('#admin-subtabs .subtab-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.subtab===sub);
  });
  document.querySelectorAll('.admin-subpanel').forEach(p=>{
    p.classList.toggle('hidden', p.id !== 'admin-'+sub);
  });
  // Lazy per sub
  if (sub==='overview'){ loadSystemStats(); }
  if (sub==='members'){ searchMembers(); }
  if (sub==='activities'){ loadAllActivities(); }
  if (sub==='finance'){ loadFinanceOverview(); loadTransactions(); }
  if (sub==='audit'){ loadPendingExpenses(); }
  if (sub==='reports'){ /* nothing extra */ }
  if (sub==='board'){ loadBoardMeetings(); }
}

/* ==============================
 綁定事件
============================== */
function bindEvents(){
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> switchTab(btn.dataset.tab));
  });

  document.getElementById('activity-search').addEventListener('input', searchActivities);

  document.getElementById('btn-register').addEventListener('click', registerOrUpdate);
  document.getElementById('btn-update-contact').addEventListener('click', updateContact);
  document.getElementById('btn-add-donation').addEventListener('click', addDonation);
  document.getElementById('btn-submit-expense').addEventListener('click', submitExpense);
  document.getElementById('btn-submit-feedback').addEventListener('click', submitFeedback);
  document.getElementById('btn-create-activity').addEventListener('click', createActivity);
  document.getElementById('btn-generate-report').addEventListener('click', generateReport);

  // Admin subtabs
  document.querySelectorAll('#admin-subtabs .subtab-btn').forEach(b=>{
    b.addEventListener('click', ()=> switchAdminSubTab(b.dataset.subtab));
  });

  // Admin Members
  document.getElementById('btn-search-members').addEventListener('click', ()=> searchMembers(true));
  document.getElementById('btn-export-members').addEventListener('click', exportMembers);

  // Admin Activities
  document.getElementById('admin-activity-search').addEventListener('input', debounce(filterAdminActivities,300));
  document.getElementById('admin-activity-status-filter').addEventListener('change', filterAdminActivities);
  document.getElementById('btn-refresh-activities').addEventListener('click', loadAllActivities);
  document.getElementById('btn-load-registrations').addEventListener('click', loadRegistrations);
  document.getElementById('btn-export-registrations').addEventListener('click', exportRegistrations);

  // Finance transactions
  document.getElementById('transaction-search').addEventListener('input', debounce(filterTransactions,300));
  document.getElementById('transaction-type-filter').addEventListener('change', filterTransactions);
  document.getElementById('btn-refresh-transactions').addEventListener('click', loadTransactions);

  document.getElementById('btn-create-board-meeting')?.addEventListener('click', createBoardMeeting);
  document.getElementById('btn-load-agenda')?.addEventListener('click', loadAgendaItems);
}

/* ==============================
 建立活動 (原有)
============================== */
async function createActivity(){
  if (!isAdmin || !currentUser) return;
  const name = document.getElementById('new-activity-name').value.trim();
  const desc = document.getElementById('new-activity-desc').value.trim();
  const date = document.getElementById('new-activity-date').value;
  const loc = document.getElementById('new-activity-location').value.trim();
  const max = document.getElementById('new-activity-max').value;
  const fee = document.getElementById('new-activity-fee').value;
  if (!name || !desc || !date){
    showNotification('請填寫名稱 / 描述 / 日期','warn');
    return;
  }
  const btn = document.getElementById('btn-create-activity');
  setLoading(btn,true);
  const res = await callAPI('createActivity',{
    operatorLineId: currentUser.lineId,
    name, description: desc, date, location: loc,
    maxParticipants: max? parseInt(max,10): '',
    fee: fee? parseFloat(fee): 0
  });
  setLoading(btn,false);
  if (res.success){
    showNotification('建立活動成功','success');
    ['new-activity-name','new-activity-desc','new-activity-date','new-activity-location','new-activity-max','new-activity-fee'].forEach(id=> document.getElementById(id).value='');
    loadActivities();
    loadSystemStats();
    loadAllActivities();
  } else {
    showNotification('建立失敗：'+res.message,'error');
  }
}


/* ==============================
 理監事 平台
============================== */
async function createBoardMeeting(){
  const title = document.getElementById('board-meeting-title').value.trim();
  const date = document.getElementById('board-meeting-date').value;
  if (!title || !date){ showNotification('請填寫標題與日期','warn'); return; }
  const res = await callAPI('createBoardMeeting',{ operatorLineId: currentUser.lineId, title, meetingDate: date });
  if (res.success){
    showNotification('會議建立成功','success');
    document.getElementById('board-meeting-title').value='';
    document.getElementById('board-meeting-date').value='';
    loadBoardMeetings();
  } else showNotification(res.message,'error');
}
async function loadBoardMeetings(){
  const res = await callAPI('listBoardMeetings',{ operatorLineId: currentUser.lineId });
  const box = document.getElementById('board-meeting-list');
  if (!res.success){ box.innerHTML = '<div class="notice error">'+res.message+'</div>'; return; }
  const arr = res.data||[];
  if (!arr.length){ box.innerHTML='<div class="empty"><div class="icon">🗓</div>尚無會議</div>'; return; }
  box.innerHTML = arr.map(m=>`
    <div class="list-item">
      <h4>${m.title} <span class="badge">${m.status}</span></h4>
      <div class="meta">
        <span>ID: ${m.id}</span>
        <span>📅 ${fmtDateTime(m.meetingDate)}</span>
        <span>${m.locked?'🔒 已鎖定':''}</span>
      </div>
      <div class="actions" style="margin-top:6px;">
        <button class="btn small outline" data-board-load="${m.id}"><span class="text">載入議程</span></button>
      </div>
    </div>
  `).join('');
  box.querySelectorAll('[data-board-load]').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.getElementById('agenda-meeting-id').value = b.getAttribute('data-board-load');
      loadAgendaItems();
    });
  });
}
async function loadAgendaItems(){
  const mid = document.getElementById('agenda-meeting-id').value.trim();
  const box = document.getElementById('agenda-list');
  if (!mid){ showNotification('請輸入會議ID','warn'); return; }
  const res = await callAPI('listAgenda',{ operatorLineId: currentUser.lineId, meetingId: mid });
  if (!res.success){ box.innerHTML='<div class="notice error">'+res.message+'</div>'; return; }
  const arr = res.data||[];
  if (!arr.length){ box.innerHTML='<div class="empty"><div class="icon">📑</div>尚無議程</div>'; return;}
  box.innerHTML = arr.map(a=>`
    <div class="list-item">
      <h4>${a.order}. ${a.title} <span class="badge">${a.status}</span></h4>
      <div class="meta">
        <span>類型:${a.type}</span>
        <span>提出:${a.presenter||'-'}</span>
        <span>ID:${a.id}</span>
      </div>
      <div style="margin-top:6px;font-size:12.5px;">${a.description||''}</div>
    </div>
  `).join('');
}


/* ==============================
 啟動
============================== */
document.addEventListener('DOMContentLoaded', initApp);

</script>
</body>
</html>
