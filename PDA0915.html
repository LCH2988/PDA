<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>帕金森病友會管理系統前端 v3.0</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="帕金森病友會管理系統 - 活動 / 會員 / 捐款 / 支出 / 理監事" />
  <style>
    :root {
      --bg:#f5f7fb;
      --bg-alt:#eef2f7;
      --card:#ffffff;
      --primary:#2563eb;
      --primary-hover:#1d4ed8;
      --danger:#dc2626;
      --danger-hover:#b91c1c;
      --warn:#d97706;
      --success:#059669;
      --border:#e2e8f0;
      --border-strong:#cbd5e1;
      --text:#1f2937;
      --muted:#64748b;
      --radius:12px;
      --radius-sm:6px;
      --shadow-sm:0 1px 2px rgba(0,0,0,.06);
      --shadow:0 4px 12px -2px rgba(0,0,0,.08);
      --shadow-lg:0 8px 28px -6px rgba(0,0,0,.18);
      font-family:system-ui,-apple-system,"PingFang TC","Noto Sans TC","Segoe UI",Roboto,Arial,sans-serif;
    }
    * { box-sizing:border-box; }
    body {
      margin:0; background:linear-gradient(142deg,#f5f8fc 0%,#edf3fa 40%,#e6eef7 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }
    body.loading { cursor:progress; }
    header {
      position:sticky; top:0; z-index:60; backdrop-filter:blur(14px);
      background:rgba(255,255,255,.85); border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:14px; padding:10px 20px;
    }
    header h1 {
      font-size:18px; font-weight:600; margin:0;
      background:linear-gradient(90deg,#2563eb,#6366f1);
      -webkit-background-clip:text; color:transparent;
      letter-spacing:.5px;
    }
    #globalLoading {
      position:fixed; top:0; left:0; height:3px; width:0%;
      background:linear-gradient(90deg,#2563eb,#60a5fa,#6366f1);
      box-shadow:0 0 8px #3b82f6aa; z-index:100; transition:width .4s ease;
    }
    main { max-width:1320px; margin:20px auto 80px; padding:0 20px; }
    .tabs {
      display:flex; gap:8px; flex-wrap:wrap; margin:4px 0 18px;
    }
    .tab-btn {
      background:#ffffff; border:1px solid var(--border); padding:10px 18px;
      font-size:14px; font-weight:500; cursor:pointer; border-radius: var(--radius-sm);
      color:var(--muted); display:flex; align-items:center; gap:6px;
      position:relative; overflow:hidden; transition:.24s;
    }
    .tab-btn::after {
      content:""; position:absolute; left:0; bottom:0; height:2px; width:0;
      background:linear-gradient(90deg,var(--primary),#6366f1);
      transition:.35s;
    }
    .tab-btn:hover { color:var(--primary); border-color:var(--primary); }
    .tab-btn.active {
      background:var(--primary); color:#fff; border-color:var(--primary); box-shadow:var(--shadow);
    }
    .tab-btn.active::after { width:100%; background:#fff; opacity:.7; }
    .view-stack { position:relative; min-height:200px; }
    .card {
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); padding:20px 22px; box-shadow:var(--shadow-sm);
      position:relative; overflow:hidden;
    }
    .card + .card { margin-top:20px; }
    .card h2, .card h3 {
      margin:0 0 14px; font-size:17px; font-weight:600; letter-spacing:.5px;
      display:flex; align-items:center; gap:8px;
    }
    .subtle {
      font-size:12px; text-transform:uppercase; letter-spacing:1px;
      font-weight:600; color:var(--muted); margin-bottom:4px;
    }
    .grid { display:grid; gap:22px; }
    @media (min-width:900px){ .grid.cols-2 { grid-template-columns:1fr 1fr; } .grid.cols-3 { grid-template-columns:repeat(3,1fr);} }
    .status {
      font-size:11px; font-weight:600; padding:4px 10px; border-radius:999px;
      display:inline-flex; align-items:center; letter-spacing:.5px;
      background:#e2e8f0; color:#334155; box-shadow:inset 0 0 0 1px #cbd5e1;
    }
    .status.open { background:#dbeafe; color:#1d4ed8; }
    .status.closed { background:#fee2e2; color:#b91c1c; }
    .status.draft { background:#fef9c3; color:#854d0e; }
    .status.done { background:#dcfce7; color:#166534; }
    .badge {
      background:linear-gradient(90deg,#2563eb,#6366f1);
      color:#fff; padding:4px 10px; border-radius:20px; font-size:12px;
      font-weight:500; letter-spacing:.5px;
    }
    .toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:0 0 14px; }
    button {
      font:inherit;
    }
    .btn {
      --btn-bg:#fff; --btn-color:#1f2937; --btn-border:#cbd5e1;
      background:var(--btn-bg); color:var(--btn-color);
      border:1px solid var(--btn-border); padding:10px 16px;
      border-radius:8px; cursor:pointer; font-size:14px; font-weight:500;
      display:inline-flex; align-items:center; gap:6px;
      transition:.25s;
    }
    .btn:hover { filter:brightness(.95); }
    .btn.primary { --btn-bg:var(--primary); --btn-color:#fff; --btn-border:var(--primary); box-shadow:var(--shadow-sm); }
    .btn.primary:hover { background:var(--primary-hover); }
    .btn.danger { --btn-bg:var(--danger); --btn-color:#fff; --btn-border:var(--danger); }
    .btn.danger:hover { background:var(--danger-hover); }
    .btn.outline {
      --btn-bg:#fff; --btn-color:var(--primary); --btn-border:var(--primary);
      background:#fff;
    }
    .btn.ghost {
      --btn-bg:transparent; --btn-color:var(--muted); --btn-border:transparent;
    }
    .btn.small { padding:6px 12px; font-size:12px; border-radius:6px; }
    .divider { height:1px; background:var(--border); margin:18px 0; }
    table {
      width:100%; border-collapse:collapse; font-size:13px; line-height:1.4;
      background:#fff; border:1px solid var(--border); border-radius:12px; overflow:hidden;
    }
    table thead th {
      background:#f1f5f9; text-align:left; padding:10px 12px; font-weight:600;
      letter-spacing:.5px; font-size:11px; text-transform:uppercase; border-bottom:1px solid var(--border);
    }
    table tbody td {
      padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:top;
    }
    table tbody tr:last-child td { border-bottom:none; }
    table tbody tr:hover { background:#f8fafc; }
    .scroll-x { overflow-x:auto; }
    .empty {
      text-align:center; padding:42px 12px; font-size:14px; color:var(--muted); font-weight:500;
    }
    .chip {
      padding:4px 10px; font-size:12px; border-radius:999px;
      background:#f1f5f9; color:#475569; font-weight:500;
    }
    .chip.primary { background:#dbeafe; color:#1d4ed8; }
    .chip.success { background:#dcfce7; color:#166534; }
    .chip.danger { background:#fee2e2; color:#b91c1c; }
    .flex { display:flex; }
    .flex-col { display:flex; flex-direction:column; }
    .gap-6 { gap:6px; }
    .gap-10 { gap:10px; }
    .gap-14 { gap:14px; }
    .mt-10 { margin-top:10px; }
    .mt-16 { margin-top:16px; }
    .mt-24 { margin-top:24px; }
    .mb-0 { margin-bottom:0; }
    .right { margin-left:auto; }
    .small { font-size:12px; color:var(--muted); line-height:1.4; }
    .mono { font-family:ui-monospace,Consolas,monospace; }
    .warn-text { color:var(--warn); font-weight:500; }
    .danger-text { color:var(--danger); font-weight:500; }
    .success-text { color:var(--success); font-weight:500; }
    /* Toast */
    .toast-container {
      position:fixed; bottom:18px; right:18px;
      display:flex; flex-direction:column; gap:12px; z-index:300;
    }
    .toast {
      background:#1e293b; color:#fff; padding:12px 16px; border-radius:10px;
      font-size:14px; font-weight:500; box-shadow:var(--shadow-lg);
      display:flex; gap:10px; align-items:flex-start; max-width:360px;
      animation:fadeIn .25s ease;
    }
    .toast.success { background:#166534; }
    .toast.error { background:#b91c1c; }
    .toast.warn { background:#92400e; }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(6px); }
      to { opacity:1; transform:translateY(0); }
    }
    /* Modal */
    .modal-overlay {
      position:fixed; inset:0; background:rgba(15,23,42,.48);
      backdrop-filter:blur(8px);
      display:flex; align-items:flex-start; justify-content:center;
      padding:80px 20px 60px; z-index:400; overflow:auto;
      animation:overlayIn .25s ease;
    }
    @keyframes overlayIn { from { opacity:0; } to { opacity:1; } }
    .modal {
      background:#fff; width:100%; max-width:560px; border-radius:20px;
      border:1px solid var(--border); box-shadow:var(--shadow-lg);
      display:flex; flex-direction:column; overflow:hidden;
      animation:modalIn .3s cubic-bezier(.4,.8,.3,1);
    }
    @keyframes modalIn { from { opacity:0; transform:translateY(14px) scale(.96);} to { opacity:1; transform:translateY(0) scale(1);} }
    .modal-header {
      padding:18px 22px; border-bottom:1px solid var(--border);
      display:flex; gap:12px; align-items:center;
    }
    .modal-header h3 { margin:0; font-size:16px; font-weight:600; letter-spacing:.5px; }
    .modal-body { padding:20px 22px; display:flex; flex-direction:column; gap:16px; }
    .modal-footer {
      padding:16px 22px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end;
    }
    .form-grid { display:grid; gap:14px; }
    @media (min-width:640px){ .form-grid.cols-2 { grid-template-columns:1fr 1fr; } }
    label.form-field {
      font-size:12px; font-weight:600; letter-spacing:.5px; color:var(--muted);
      display:flex; flex-direction:column; gap:6px;
    }
    input[type=text], input[type=number], input[type=date], input[type=datetime-local], select, textarea {
      width:100%; padding:10px 12px; border:1px solid var(--border);
      background:#fff; border-radius:8px; font:inherit; resize:vertical; min-height:44px;
      transition:.2s;
    }
    textarea { min-height:120px; line-height:1.5; }
    input:focus, select:focus, textarea:focus {
      outline:none; border-color:var(--primary); box-shadow:0 0 0 3px #3b82f620;
    }
    .helper { font-size:11px; color:var(--muted); }
    .skeleton {
      background:linear-gradient(92deg,#f1f5f9 0%,#e2e8f0 50%,#f1f5f9 100%);
      background-size:200% 100%; animation:skeleton 1.2s infinite;
      border-radius:6px; height:14px; width:100%;
    }
    @keyframes skeleton {
      0% { background-position:0% 50%; }
      100% { background-position:-200% 50%; }
    }
    .footer {
      text-align:center; font-size:11px; padding:40px 0 80px;
      color:var(--muted); letter-spacing:.5px;
    }
    a { color:var(--primary); text-decoration:none; }
    a:hover { text-decoration:underline; }
    .tagline {
      font-size:12px; color:var(--muted); margin-left:6px; font-weight:400;
    }
    .soft { color:var(--muted); font-weight:400; }
    .fill-space { flex:1; }
    .pill-group { display:flex; flex-wrap:wrap; gap:6px; }
    .pill {
      background:#fff; border:1px solid var(--border); padding:6px 12px;
      border-radius:999px; font-size:12px; font-weight:500; cursor:pointer; color:var(--muted);
    }
    .pill.active { background:var(--primary); color:#fff; border-color:var(--primary); }
    .alert {
      padding:14px 16px; border:1px solid var(--border-strong); border-radius:10px;
      background:#f8fafc; font-size:13px; line-height:1.5; display:flex; gap:14px;
    }
    .alert.warn { background:#fffbeb; border-color:#fcd34d; }
    .alert.error { background:#fef2f2; border-color:#fca5a5; }
    .alert.success { background:#ecfdf5; border-color:#6ee7b7; }
    code.inline {
      background:#0f172a; color:#e2e8f0; padding:2px 6px; border-radius:6px;
      font-size:12px; font-family:ui-monospace,Consolas,monospace;
    }
  </style>
  <!-- 若需 LIFF: <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script> -->
</head>
<body>
  <div id="globalLoading"></div>
  <header>
    <h1>病友會管理 <span class="tagline">v3.0 Frontend</span></h1>
    <div id="networkBadge" class="chip small" style="display:none;">離線</div>
    <div class="fill-space"></div>
    <div id="profileBox" class="flex gap-10" style="align-items:center;"></div>
    <button class="btn small outline" id="btnReload">重新整理</button>
  </header>
  <main>
    <div class="tabs" id="mainTabs"></div>
    <div class="view-stack" id="viewContainer"></div>
    <div class="footer">
      前端示例 v3.0 ｜ 僅供內部測試 ｜ 請勿在公開前端硬編碼 API Key<br />
      建議以中繼伺服器完成簽章 / 權杖交換流程
    </div>
  </main>
  <div id="modalRoot"></div>
  <div class="toast-container" id="toastContainer"></div>

  <!-- ========================= 模組：config.js ========================= -->
  <script type="module" data-file="config.js">
    export const CONFIG = {
      API_ENDPOINT: 'https://script.google.com/macros/s/AKfycbyCexHu1MtWzi2pZS9SknKh_ZnCWJmuWKdTTqwQcySB8NEcUKdafRggXUONzwppLTZN3Q/exec', // TODO: 換成後端部署網址
      API_KEY: 'AAbb8520258185202581',
      STRICT_SIGN: false,      // 若後端開啟嚴格簽章 (STRICT_SIGN=true) 不建議在前端直接算 HMAC
      USE_LIFF: false,
      LIFF_ID: '1656516134-VaGgmaPm',
      DEMO_FALLBACK_PROFILE: {
        lineId: 'U-DEMO-USER-001',
        displayName: '測試使用者',
        pictureUrl: 'https://placekitten.com/200/200'
      },
      AUTO_REFRESH: 0,         // ms；0=停用自動刷新
      BUILD_VERSION: '3.0.0'
    };
  </script>

  <!-- ========================= 模組：state.js ========================= -->
  <script type="module" data-file="state.js">
    import { CONFIG } from './config.js';

    export const State = {
      profile: null,
      userInfo: null,
      isAdmin: false,
      activeTab: 'dashboard',
      tabs: [],
      cache: new Map(),
      listeners: new Set(),

      setProfile(p){ this.profile=p; this.emit('profile'); },
      setUserInfo(u){
        this.userInfo=u;
          this.isAdmin = !!(u && (u.isAdmin===true || u.isAdmin==='TRUE' || u.isAdmin==='是'));
        this.emit('userInfo');
      },
      setActiveTab(id){
        this.activeTab=id;
        this.emit('tab');
      },
      setTabs(list){
        this.tabs=list; this.emit('tabs');
      },
      emit(ev){ this.listeners.forEach(fn=> fn(ev)); },
      on(fn){ this.listeners.add(fn); return ()=> this.listeners.delete(fn); }
    };

    export function buildTabs(){
      const base = [
        { id:'dashboard', label:'總覽' },
        { id:'activities', label:'活動' },
        { id:'donations', label:'捐款' },
        { id:'expenses', label:'支出' },
        { id:'feedback', label:'回饋' },
        { id:'board-lite', label:'理監事(會員)' }
      ];
      if (State.isAdmin){
        base.push(
          { id:'admin-members', label:'會員管理' },
          { id:'admin-activities', label:'活動管理' },
          { id:'finance', label:'財務' },
          { id:'board-admin', label:'理監事管理' }
        );
      }
      State.setTabs(base);
    }

    // 簡單事件：離線/上線
    window.addEventListener('online', ()=> document.getElementById('networkBadge').style.display='none');
    window.addEventListener('offline', ()=>{
      const b=document.getElementById('networkBadge');
      b.textContent='離線'; b.style.display='inline-flex';
    });
  </script>

  <!-- ========================= 模組：ui/toast.js ========================= -->
  <script type="module" data-file="ui/toast.js">
    export function showToast(message, type='info', timeout=3800){
      const box=document.getElementById('toastContainer');
      const div=document.createElement('div');
      div.className='toast '+(type==='success'?'success': type==='error'?'error': type==='warn'?'warn':'');
      div.textContent=message;
      box.appendChild(div);
      setTimeout(()=>{
        div.style.opacity=0;
        div.style.transform='translateY(-4px)';
        setTimeout(()=> div.remove(), 340);
      }, timeout);
    }
  </script>

  <!-- ========================= 模組：ui/loading.js ========================= -->
  <script type="module" data-file="ui/loading.js">
    let active = 0;
    export function startLoading(){
      active++;
      document.body.classList.add('loading');
      const bar=document.getElementById('globalLoading');
      if (active===1){
        bar.style.transition='none';
        bar.style.width='0%';
        requestAnimationFrame(()=>{
          bar.style.transition='width .4s ease';
          bar.style.width='70%';
        });
      } else {
        // push forward
        if (parseInt(bar.style.width) < 70) bar.style.width='70%';
      }
    }
    export function stopLoading(){
      active=Math.max(0, active-1);
      if (active===0){
        const bar=document.getElementById('globalLoading');
        bar.style.width='100%';
        setTimeout(()=>{
          bar.style.width='0%';
          document.body.classList.remove('loading');
        }, 400);
      }
    }
  </script>

  <!-- ========================= 模組：ui/modal.js ========================= -->
  <script type="module" data-file="ui/modal.js">
    import { esc } from '../utils/format.js';

    export function openModal({ title, body, actions=[], size='md', dismissible=true }){
      const root=document.getElementById('modalRoot');
      const overlay=document.createElement('div');
      overlay.className='modal-overlay';
      overlay.tabIndex=-1;

      const modal=document.createElement('div');
      modal.className='modal';
      if (size==='lg') modal.style.maxWidth='820px';
      else if (size==='sm') modal.style.maxWidth='420px';

      const header=document.createElement('div');
      header.className='modal-header';
      header.innerHTML=`<h3>${esc(title||'對話框')}</h3>`;
      if (dismissible){
        const closeBtn=document.createElement('button');
        closeBtn.className='btn ghost small';
        closeBtn.textContent='關閉';
        closeBtn.style.marginLeft='auto';
        closeBtn.onclick=()=> close();
        header.appendChild(closeBtn);
      }

      const bodyDiv=document.createElement('div');
      bodyDiv.className='modal-body';
      if (typeof body==='string') bodyDiv.innerHTML=body;
      else bodyDiv.appendChild(body);

      const footer=document.createElement('div');
      footer.className='modal-footer';
      actions.forEach(a=>{
        const btn=document.createElement('button');
          btn.className='btn ' + (a.variant||'primary');
        btn.textContent=a.label;
        btn.onclick= async ()=>{
          if (a.onClick){
            const ret = await a.onClick(close);
            if (ret!==false && !a.persistent) close();
          } else {
            close();
          }
        };
        footer.appendChild(btn);
      });
      if (!actions.length) footer.style.display='none';

      modal.appendChild(header);
      modal.appendChild(bodyDiv);
      modal.appendChild(footer);
      overlay.appendChild(modal);
      root.appendChild(overlay);

      function close(){
        overlay.style.opacity=0;
        overlay.style.transition='opacity .25s ease';
        setTimeout(()=> overlay.remove(), 250);
      }
      if (dismissible){
        overlay.addEventListener('click', e=>{
          if (e.target===overlay) close();
        });
        window.addEventListener('keydown', function escClose(ev){
          if (ev.key==='Escape'){
            close(); window.removeEventListener('keydown', escClose);
          }
        });
      }
      return { close, root:overlay, modal };
    }
  </script>

  <!-- ========================= 模組：utils/format.js ========================= -->
  <script type="module" data-file="utils/format.js">
    export function esc(v){
      if (v===null || v===undefined) return '';
      return String(v).replace(/[&<>"']/g, c=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[c]);
    }
    export function fmtDate(d){
      if (!d) return '';
      const dt = new Date(d);
      if (isNaN(dt)) return d;
      return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0');
    }
    export function fmtDateTime(d){
      if (!d) return '';
      const dt=new Date(d);
      if (isNaN(dt)) return d;
      const ds=fmtDate(dt);
      return ds+' '+String(dt.getHours()).padStart(2,'0')+':'+String(dt.getMinutes()).padStart(2,'0');
    }
    export function sum(arr, field){
      return arr.reduce((s,x)=> s + Number(field? x[field]||0: x||0),0);
    }
  </script>

  <!-- ========================= 模組：api/core.js ========================= -->
  <script type="module" data-file="api/core.js">
    import { CONFIG } from '../config.js';
    import { startLoading, stopLoading } from '../ui/loading.js';

    async function hmacSHA256(message, secret){
      const enc=new TextEncoder();
      const key=await crypto.subtle.importKey('raw', enc.encode(secret), {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
      const sig=await crypto.subtle.sign('HMAC', key, enc.encode(message));
      return Array.from(new Uint8Array(sig)).map(b=>('0'+b.toString(16)).slice(-2)).join('');
    }

    export async function callApi(action, payload={}){
      startLoading();
      try {
        const body = { action, apiKey: CONFIG.API_KEY, ...payload };
        if (CONFIG.STRICT_SIGN){
          body.ts=Date.now().toString();
          body.nonce=crypto.randomUUID().replace(/-/g,'').slice(0,12);
          // 生產環境切勿在前端放 secret → 需後端 Proxy
          body.sign=await hmacSHA256(`${body.action}|${body.ts}|${body.nonce}|${CONFIG.API_KEY}`, CONFIG.API_KEY);
        }
        const res = await fetch(CONFIG.API_ENDPOINT,{
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        let json;
        try { json=await res.json(); } catch(e){
          throw new Error('回傳非 JSON: '+await res.text());
        }
        if (!json.success){
          throw new Error(json.message || 'API 失敗');
        }
        return json.data;
      } finally {
        stopLoading();
      }
    }
  </script>

  <!-- ========================= 模組：api/wrappers.js ========================= -->
  <script type="module" data-file="api/wrappers.js">
    import { callApi } from './core.js';

    export const API = {
      // User
      createUserIfNotExist: (lineId,lineName)=> callApi('createUserIfNotExist',{ lineId, lineName }),
      getUserInfo: (lineId)=> callApi('getUserInfo',{ lineId }),
      register: (lineId, realName, memberType)=> callApi('register',{ lineId, realName, memberType }),
      updateUserContact: (targetLineId, patch)=> callApi('updateUserContact',{ targetLineId, ...patch }),

      // Activities
      getActivities: ()=> callApi('getActivities'),
      getUserActivities: (lineId)=> callApi('getUserActivities',{ lineId }),
      registerActivity: (lineId, activityId, participantName)=> callApi('registerActivity',{ lineId, activityId, participantName }),
      cancelActivity: (lineId, registrationId)=> callApi('cancelActivity',{ lineId, registrationId }),
      getAllActivities: (operatorLineId)=> callApi('getAllActivities',{ operatorLineId }),
      createActivity: (operatorLineId, name, description, date, location, maxParticipants, fee)=> callApi('createActivity',{ operatorLineId, name, description, date, location, maxParticipants, fee }),
      updateActivity: (operatorLineId, activityId, patch)=> callApi('updateActivity',{ operatorLineId, activityId, ...patch }),
      changeActivityStatus: (operatorLineId, activityId, status)=> callApi('changeActivityStatus',{ operatorLineId, activityId, status }),
      deleteActivity: (operatorLineId, activityId)=> callApi('deleteActivity',{ operatorLineId, activityId }),
      getActivityRegistrations: (operatorLineId, activityId)=> callApi('getActivityRegistrations',{ operatorLineId, activityId }),

      // Donation
      addDonation: (lineId, amount, donorName, notes)=> callApi('addDonation',{ lineId, amount, donorName, notes }),
      getDonations: (lineId)=> callApi('getDonations',{ lineId }),

      // Expenses / Finance
      submitExpense: (lineId, category, amount, description)=> callApi('submitExpense',{ lineId, category, amount, description }),
      getMyExpenses: (lineId)=> callApi('getMyExpenses',{ lineId }),
      getPendingExpenses: (operatorLineId)=> callApi('getPendingExpenses',{ operatorLineId }),
      approveExpense: (operatorLineId, expenseId, approved, notes)=> callApi('approveExpense',{ operatorLineId, expenseId, approved, notes }),
      getFinanceOverview: (operatorLineId)=> callApi('getFinanceOverview',{ operatorLineId }),
      getTransactions: (operatorLineId)=> callApi('getTransactions',{ operatorLineId }),
      getAccounts: (operatorLineId)=> callApi('getAccounts',{ operatorLineId }),
      getBudgetStatus: (operatorLineId)=> callApi('getBudgetStatus',{ operatorLineId }),

      // Feedback
      submitFeedback: (lineId, activityId, rating, comment)=> callApi('submitFeedback',{ lineId, activityId, rating, comment }),
      getMyFeedback: (lineId)=> callApi('getMyFeedback',{ lineId }),

      // Members / Admin
      getAllMembers: (operatorLineId, searchTerm, memberType)=> callApi('getAllMembers',{ operatorLineId, searchTerm, memberType }),
      updateMember: (operatorLineId, targetLineId, patch)=> callApi('updateMember',{ operatorLineId, targetLineId, ...patch }),
      exportMembers: (operatorLineId)=> callApi('exportMembers',{ operatorLineId }),
      searchMembers: (operatorLineId, searchTerm, memberType)=> callApi('searchMembers',{ operatorLineId, searchTerm, memberType }),

      // Stats
      getSystemStats: (operatorLineId)=> callApi('getSystemStats',{ operatorLineId }),
      generateReport: (operatorLineId, year, month)=> callApi('generateReport',{ operatorLineId, year, month }),

      // Board
      createBoardMeeting: (operatorLineId, title, meetingDate)=> callApi('createBoardMeeting',{ operatorLineId, title, meetingDate }),
      listBoardMeetings: (operatorLineId, status)=> callApi('listBoardMeetings',{ operatorLineId, status }),
      updateBoardMeeting: (operatorLineId, meetingId, patch)=> callApi('updateBoardMeeting',{ operatorLineId, meetingId, ...patch }),
      finalizeBoardMeeting: (operatorLineId, meetingId, finalMinutesText)=> callApi('finalizeBoardMeeting',{ operatorLineId, meetingId, finalMinutesText }),
      lockBoardMeeting: (operatorLineId, meetingId, locked)=> callApi('lockBoardMeeting',{ operatorLineId, meetingId, locked }),

      addAgendaItem: (operatorLineId, meetingId, type, refId, title, description, presenter)=> callApi('addAgendaItem',{ operatorLineId, meetingId, type, refId, title, description, presenter }),
      listAgenda: (operatorLineId, meetingId)=> callApi('listAgenda',{ operatorLineId, meetingId }),
      updateAgendaStatus: (operatorLineId, agendaId, status, decisionText)=> callApi('updateAgendaStatus',{ operatorLineId, agendaId, status, decisionText }),
      recordDecision: (operatorLineId, meetingId, agendaId, result, voteFor, voteAgainst, voteAbstain, notes)=> callApi('recordDecision',{ operatorLineId, meetingId, agendaId, result, voteFor, voteAgainst, voteAbstain, notes }),

      checkInMeeting: (lineId, meetingId, role)=> callApi('checkInMeeting',{ lineId, meetingId, role }),
      listAttendance: (operatorLineId, meetingId)=> callApi('listAttendance',{ operatorLineId, meetingId }),

      submitProposal: (lineId, title, content, category)=> callApi('submitProposal',{ lineId, title, content, category }),
      listProposals: (operatorLineId, lineId, status)=> callApi('listProposals',{ operatorLineId, lineId, status }),
      reviewProposal: (operatorLineId, proposalId, approve, comment)=> callApi('reviewProposal',{ operatorLineId, proposalId, approve, comment }),
      linkProposalToMeeting: (operatorLineId, proposalId, meetingId)=> callApi('linkProposalToMeeting',{ operatorLineId, proposalId, meetingId }),

      submitCase: (lineId, title, summary, type)=> callApi('submitCase',{ lineId, title, summary, type }),
      listCases: (operatorLineId, status)=> callApi('listCases',{ operatorLineId, status }),
      reviewCase: (operatorLineId, caseId, decision, comment)=> callApi('reviewCase',{ operatorLineId, caseId, decision, comment }),
      linkCaseToMeeting: (operatorLineId, caseId, meetingId)=> callApi('linkCaseToMeeting',{ operatorLineId, caseId, meetingId }),

      submitMotion: (lineId, title, reason, meetingId)=> callApi('submitMotion',{ lineId, title, reason, meetingId }),
      listMotions: (operatorLineId, meetingId, status)=> callApi('listMotions',{ operatorLineId, meetingId, status }),
      decideMotion: (operatorLineId, motionId, status, decisionText)=> callApi('decideMotion',{ operatorLineId, motionId, status, decisionText })
    };
  </script>

  <!-- ========================= 模組：views/common/table.js ========================= -->
  <script type="module" data-file="views/common/table.js">
    import { esc } from '../../utils/format.js';

    export function tableHTML(headers, rows){
      return `
        <div class="scroll-x">
          <table>
            <thead><tr>${headers.map(h=>'<th>'+esc(h)+'</th>').join('')}</tr></thead>
            <tbody>
              ${rows.map(r=>'<tr>'+r.map(c=>'<td>'+(c===undefined||c===null?'': (typeof c==='string'? c: c.toString()))+'</td>').join('')+'</tr>').join('')}
            </tbody>
          </table>
        </div>
      `;
    }
  </script>

  <!-- ========================= 模組：views/dashboard.js ========================= -->
  <script type="module" data-file="views/dashboard.js">
    import { State } from '../state.js';
    import { API } from '../api/wrappers.js';
    import { esc, fmtDate } from '../utils/format.js';
    import { showToast } from '../ui/toast.js';
    import { openModal } from '../ui/modal.js';
    import { tableHTML } from './common/table.js';

    export async function renderDashboard(root){
      root.innerHTML = skeletonLayout();
      try{
        const user = State.userInfo;
        const promises=[];
        if (State.isAdmin) promises.push(API.getSystemStats(State.profile.lineId));
        else promises.push(Promise.resolve(null));
        promises.push(API.getUserActivities(State.profile.lineId));
        promises.push(API.getDonations(State.profile.lineId));
        const [stats, myActs, dons] = await Promise.all(promises);

        root.innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <h2>個人資訊</h2>
              <p><strong>LINE 名稱：</strong>${esc(user.lineName||'')}</p>
              <p><strong>真實姓名：</strong>${esc(user.realName||'(未填)')}</p>
              <p><strong>會員類別：</strong>${esc(user.memberType||'(未填)')}</p>
              <p><strong>狀態：</strong>
                <span class="status ${user.status==='已註冊'?'open':'closed'}">${esc(user.status||'')}</span>
              </p>
              <div class="mt-16">
                <button class="btn primary small" id="btnEditProfile">更新資料</button>
              </div>
            </div>
            <div class="card">
              <h2>快捷操作</h2>
              <div class="pill-group">
                <button class="pill" data-op="register">報名活動</button>
                <button class="pill" data-op="donate">捐款</button>
                <button class="pill" data-op="expense">支出申請</button>
                <button class="pill" data-op="feedback">活動回饋</button>
              </div>
              <div class="small mt-16">點選上方快速進入對應功能。</div>
            </div>
            <div class="card">
              <h2>近期活動</h2>
              ${myActs.length ?
                tableHTML(['活動','日期','狀態'],
                  myActs.slice(0,5).map(a=>[esc(a.activityName||'(已刪除)'), fmtDate(a.date), a.status]))
                : '<div class="empty">尚未報名活動</div>'}
            </div>
            <div class="card">
              <h2>捐款摘要</h2>
              ${
                dons.length ?
                  `<p>累計金額：<strong>${dons.reduce((s,d)=> s+Number(d.amount||0),0)}</strong></p>
                   <div class="divider"></div>
                   ${tableHTML(['日期','金額','備註'],
                     dons.slice(0,5).map(d=>[fmtDate(d.date), d.amount, esc(d.notes||'')]))}`
                : '<div class="empty">尚無捐款紀錄</div>'
              }
            </div>
            ${
              State.isAdmin ? `
              <div class="card">
                <h2>系統統計</h2>
                ${stats ?
                  `<p>會員總數：${stats.totalMembers}</p>
                   <p>已註冊會員：${stats.registeredMembers}</p>
                   <p>開放活動：${stats.activeActivities}</p>
                   <p>有效報名：${stats.totalRegistrations}</p>`
                  : '<div class="empty">無法取得統計</div>'}
              </div>
              <div class="card">
                <h2>管理提醒</h2>
                <ul style="margin:0; padding-left:20px; line-height:1.7; font-size:14px;">
                  <li>檢查是否有待審支出</li>
                  <li>確保即將舉辦之會議議程完整</li>
                  <li>檢視活動是否額滿或需要關閉</li>
                </ul>
              </div>
              ` : ''
            }
          </div>
        `;
        root.querySelector('#btnEditProfile').onclick = ()=> editProfileDialog();
        root.querySelectorAll('.pill').forEach(p=>{
          p.onclick=()=> quickOp(p.dataset.op);
        });
      }catch(e){
        root.innerHTML = `<div class="card"><h2>載入失敗</h2><p class="danger-text">${esc(e.message)}</p></div>`;
      }
    }

    function skeletonLayout(){
      return `
        <div class="grid cols-2">
          ${Array.from({length:6}).map(()=>`
            <div class="card">
              <div class="skeleton" style="height:20px; width:40%; margin-bottom:20px;"></div>
              ${Array.from({length:5}).map(()=>'<div class="skeleton" style="width:100%;"></div>').join('<div style="height:8px;"></div>')}
            </div>`).join('')}
        </div>
      `;
    }

    function quickOp(id){
      const tabMap = {
        register: 'activities',
        donate: 'donations',
        expense: 'expenses',
        feedback: 'feedback'
      };
      if (tabMap[id]) State.setActiveTab(tabMap[id]);
    }

    function editProfileDialog(){
      const user = State.userInfo;
      const body=document.createElement('div');
      body.innerHTML=`
        <div class="form-grid">
          <label class="form-field">
            真實姓名
            <input type="text" id="inpRealName" value="${esc(user.realName||'')}"/>
          </label>
          <label class="form-field">
            會員類別
            <select id="selType">
              <option value="">(未設定)</option>
              <option value="一般" ${user.memberType==='一般'?'selected':''}>一般</option>
              <option value="理監事" ${user.memberType==='理監事'?'selected':''}>理監事</option>
            </select>
          </label>
        </div>
        <div class="helper">更新將同步後端使用者資訊。</div>
      `;
      openModal({
        title:'更新個人資料',
        body,
        actions:[
          { label:'取消', variant:'ghost' },
          { label:'儲存', variant:'primary', onClick: async (close)=>{
            const realName = body.querySelector('#inpRealName').value.trim();
            const memberType = body.querySelector('#selType').value || '一般';
            if (!realName){ alert('請輸入真實姓名'); return false; }
            await API.register(State.profile.lineId, realName, memberType);
            const fresh = await API.getUserInfo(State.profile.lineId);
            State.setUserInfo(fresh);
            showToast('已更新','success');
            close();
          }}
        ]
      });
    }
  </script>

  <!-- ========================= 模組：views/activities.js ========================= -->
  <script type="module" data-file="views/activities.js">
    import { API } from '../api/wrappers.js';
    import { State } from '../state.js';
    import { esc, fmtDate } from '../utils/format.js';
    import { showToast } from '../ui/toast.js';
    import { openModal } from '../ui/modal.js';
    import { tableHTML } from './common/table.js';

    export async function renderActivities(root){
      root.innerHTML='<div class="card"><h2>載入活動...</h2></div>';
      try{
        const [available, regs] = await Promise.all([
          API.getActivities(),
          API.getUserActivities(State.profile.lineId)
        ]);
        root.innerHTML = `
          <div class="card">
            <h2>開放活動</h2>
            ${
              available.length ?
                tableHTML(['名稱','日期','地點','名額','費用',''],
                  available.map(a=>{
                    const slot = a.maxParticipants ? `${a.currentParticipants||0}/${a.maxParticipants}` : '-';
                    const full = a.maxParticipants && a.currentParticipants>=a.maxParticipants;
                    return [
                      esc(a.name),
                      fmtDate(a.date),
                      esc(a.location||''),
                      slot,
                      a.fee||0,
                      `<button class="btn small outline btnRegAct" data-id="${a.id}" ${full?'disabled':''}>${full?'額滿':'報名'}</button>`
                    ];
                  }))
              : '<div class="empty">沒有開放中的活動</div>'
            }
          </div>
          <div class="card mt-24">
            <h2>我的報名</h2>
            ${
              regs.length ?
                tableHTML(['活動','日期','狀態','姓名','報名日',''],
                  regs.map(r=>[
                    esc(r.activityName||'(已刪除)'),
                    fmtDate(r.date),
                    `<span class="status ${r.status==='已報名'?'open':'closed'}">${esc(r.status)}</span>`,
                    esc(r.participantName||''),
                    fmtDate(r.registerDate),
                    r.status==='已報名'? `<button class="btn small danger btnCancelReg" data-id="${r.id}">取消</button>`:''
                  ]))
              : '<div class="empty">尚未報名任何活動</div>'
            }
          </div>
        `;
        root.querySelectorAll('.btnRegAct').forEach(b=>{
          b.onclick=()=> registerDialog(b.dataset.id);
        });
        root.querySelectorAll('.btnCancelReg').forEach(b=>{
          b.onclick=()=> cancelRegistration(b.dataset.id);
        });
      }catch(e){
        root.innerHTML = `<div class="card"><h2>載入失敗</h2><p class="danger-text">${esc(e.message)}</p></div>`;
      }
    }

    function registerDialog(activityId){
      const body=document.createElement('div');
      body.innerHTML=`
        <label class="form-field">
          報名顯示姓名
          <input type="text" id="regName" placeholder="輸入姓名"/>
        </label>
      `;
      openModal({
        title:'報名活動',
        body,
        actions:[
          { label:'取消', variant:'ghost' },
          { label:'送出', variant:'primary', onClick: async (close)=>{
            const name=body.querySelector('#regName').value.trim();
            if (!name){ alert('請輸入姓名'); return false; }
            await API.registerActivity(State.profile.lineId, activityId, name);
            showToast('報名成功','success');
            close();
            if (State.activeTab==='activities') State.emit('tab'); // 重新渲染
          }}
        ]
      });
    }

    async function cancelRegistration(regId){
      if (!confirm('確定要取消報名？')) return;
      try{
        await API.cancelActivity(State.profile.lineId, regId);
        showToast('已取消','success');
        if (State.activeTab==='activities') State.emit('tab');
      }catch(e){ showToast(e.message,'error'); }
    }
  </script>

  <!-- ========================= 模組：views/donations.js ========================= -->
  <script type="module" data-file="views/donations.js">
    import { API } from '../api/wrappers.js';
    import { State } from '../state.js';
    import { esc, fmtDate } from '../utils/format.js';
    import { showToast } from '../ui/toast.js';
    import { openModal } from '../ui/modal.js';
    import { tableHTML } from './common/table.js';

    export async function renderDonations(root){
      root.innerHTML='<div class="card"><h2>載入捐款...</h2></div>';
      try{
        const dons = await API.getDonations(State.profile.lineId);
        const total = dons.reduce((s,d)=> s+Number(d.amount||0),0);
        root.innerHTML=`
          <div class="card">
            <h2>我的捐款</h2>
            <div class="toolbar">
              <button class="btn primary small" id="btnAddDonation">新增捐款</button>
              <div class="chip primary">累計金額：${total}</div>
              <div class="chip">筆數：${dons.length}</div>
            </div>
            ${
              dons.length ?
                tableHTML(['日期','金額','備註'],
                  dons.map(d=>[fmtDate(d.date), d.amount, esc(d.notes||'')]))
              : '<div class="empty">尚無捐款紀錄</div>'
            }
          </div>
        `;
        document.getElementById('btnAddDonation').onclick=()=> donationDialog();
      }catch(e){
        root.innerHTML=`<div class="card"><h2>載入失敗</h2><p class="danger-text">${esc(e.message)}</p></div>`;
      }
    }

    function donationDialog(){
      const body=document.createElement('div');
      body.innerHTML=`
        <div class="form-grid">
          <label class="form-field">
            金額
            <input type="number" id="donAmt" min="1" placeholder="輸入金額"/>
          </label>
          <label class="form-field">
            捐款人（顯示）
            <input type="text" id="donName" value="${esc(State.userInfo.realName||State.userInfo.lineName||'')}"/>
          </label>
        </div>
        <label class="form-field">
          備註
          <textarea id="donNotes" placeholder="(可留空)"></textarea>
        </label>
      `;
      openModal({
        title:'新增捐款',
        body,
        actions:[
          { label:'取消', variant:'ghost' },
          { label:'提交', variant:'primary', onClick: async (close)=>{
            const amount=body.querySelector('#donAmt').value;
            const name=body.querySelector('#donName').value.trim();
            const notes=body.querySelector('#donNotes').value.trim();
            if (!amount || Number(amount)<=0){ alert('請輸入金額'); return false; }
            await API.addDonation(State.profile.lineId, amount, name||'', notes);
            showToast('捐款已紀錄','success');
            close();
            if (State.activeTab==='donations') State.emit('tab');
          }}
        ]
      });
    }
  </script>

  <!-- ========================= 模組：views/expenses.js ========================= -->
  <script type="module" data-file="views/expenses.js">
    import { API } from '../api/wrappers.js';
    import { State } from '../state.js';
    import { esc, fmtDate } from '../utils/format.js';
    import { showToast } from '../ui/toast.js';
    import { openModal } from '../ui/modal.js';
    import { tableHTML } from './common/table.js';

    export async function renderExpenses(root){
      root.innerHTML='<div class="card"><h2>載入支出申請...</h2></div>';
      try{
        const list = await API.getMyExpenses(State.profile.lineId);
        root.innerHTML = `
          <div class="card">
            <h2>我的支出申請</h2>
            <div class="toolbar">
              <button class="btn primary small" id="btnNewExpense">新申請</button>
              <div class="chip">總筆數：${list.length}</div>
            </div>
            ${
              list.length ?
                tableHTML(['日期','類別','金額','說明','狀態','審核者'],
                  list.map(r=>[
                    fmtDate(r.submitDate),
                    esc(r.category),
                    r.amount,
                    esc(r.description||''),
                    `<span class="status ${
                      r.status==='待審核'?'draft': (r.status==='已核准'?'open':'closed')
                    }">${esc(r.status)}</span>`,
                    esc(r.approvedBy||'')
                  ]))
              : '<div class="empty">尚無支出申請</div>'
            }
          </div>
        `;
        document.getElementById('btnNewExpense').onclick=()=> expenseDialog();
      }catch(e){
        root.innerHTML=`<div class="card"><h2>載入失敗</h2><p class="danger-text">${esc(e.message)}</p></div>`;
      }
    }

    function expenseDialog(){
      const body=document.createElement('div');
      body.innerHTML=`
        <div class="form-grid cols-2">
          <label class="form-field">
            類別
            <input type="text" id="expCat" placeholder="交通 / 餐費 / 其他" />
          </label>
          <label class="form-field">
            金額
            <input type="number" id="expAmt" min="1" />
          </label>
        </div>
        <label class="form-field">
          說明
          <textarea id="expDesc" placeholder="支出用途說明"></textarea>
        </label>
        <div class="alert warn small">
          此示例未包含上傳憑證功能，可後續擴充（Google Drive）。
        </div>
      `;
      openModal({
        title:'提出支出申請',
        body,
        actions:[
          { label:'取消', variant:'ghost' },
          { label:'送出', variant:'primary', onClick: async (close)=>{
            const cat=body.querySelector('#expCat').value.trim();
            const amt=body.querySelector('#expAmt').value;
            const desc=body.querySelector('#expDesc').value.trim();
            if (!cat || !amt || !desc){ alert('請完整填寫'); return false; }
            await API.submitExpense(State.profile.lineId, cat, amt, desc);
            showToast('已提交','success');
            close();
            if (State.activeTab==='expenses') State.emit('tab');
          }}
        ]
      });
    }
  </script>

  <!-- ========================= 模組：views/feedback.js ========================= -->
  <script type="module" data-file="views/feedback.js">
    import { API } from '../api/wrappers.js';
    import { State } from '../state.js';
    import { esc, fmtDate } from '../utils/format.js';
    import { openModal } from '../ui/modal.js';
    import { showToast } from '../ui/toast.js';
    import { tableHTML } from './common/table.js';

    export async function renderFeedback(root){
      root.innerHTML='<div class="card"><h2>載入回饋...</h2></div>';
      try{
        const list = await API.getMyFeedback(State.profile.lineId);
        root.innerHTML=`
          <div class="card">
            <h2>活動回饋</h2>
            <div class="toolbar">
              <button class="btn primary small" id="btnFeedback">新增回饋</button>
              <div class="chip">總筆數：${list.length}</div>
            </div>
            ${
              list.length ?
                tableHTML(['活動','評分','意見','日期'],
                  list.map(f=>[
                    esc(f.activityName||''), f.rating, esc(f.comment||''), fmtDate(f.submitDate)
                  ]))
              : '<div class="empty">尚無回饋</div>'
            }
          </div>
        `;
        document.getElementById('btnFeedback').onclick=()=> feedbackDialog();
      }catch(e){
        root.innerHTML=`<div class="card"><h2>載入失敗</h2><p class="danger-text">${esc(e.message)}</p></div>`;
      }
    }

    function feedbackDialog(){
      const body=document.createElement('div');
      body.innerHTML=`
        <label class="form-field">
          活動 ID
          <input type="text" id="fbAct" placeholder="請輸入你已參加的活動ID"/>
        </label>
        <label class="form-field">
          評分 (1-5)
          <input type="number" id="fbRating" min="1" max="5" value="5"/>
        </label>
        <label class="form-field">
          意見
          <textarea id="fbComment" placeholder="可留空"></textarea>
        </label>
      `;
      openModal({
        title:'新增活動回饋',
        body,
        actions:[
          { label:'取消', variant:'ghost' },
          { label:'提交', variant:'primary', onClick: async (close)=>{
            const act=body.querySelector('#fbAct').value.trim();
            const rating=body.querySelector('#fbRating').value;
            const comment=body.querySelector('#fbComment').value.trim();
            if (!act || !rating){ alert('請填寫活動 ID 與評分'); return false; }
            await API.submitFeedback(State.profile.lineId, act, rating, comment);
            showToast('回饋已提交','success');
            close();
            if (State.activeTab==='feedback') State.emit('tab');
          }}
        ]
      });
    }
  </script>

  <!-- ========================= 模組：views/board-lite.js ========================= -->
  <script type="module" data-file="views/board-lite.js">
    import { API } from '../api/wrappers.js';
    import { State } from '../state.js';
    import { esc, fmtDate } from '../utils/format.js';
    import { showToast } from '../ui/toast.js';
    import { openModal } from '../ui/modal.js';
    import { tableHTML } from './common/table.js';

    export async function renderBoardLite(root){
      root.innerHTML='<div class="card"><h2>載入中...</h2></div>';
      try{
        // 簡版：僅提案 (後端對 motions/list 需 admin，故此處忽略)
        const proposals = await API.listProposals('', State.profile.lineId, '');
        root.innerHTML=`
          <div class="card">
            <h2>理監事互動（會員）</h2>
            <div class="toolbar">
              <button class="btn small primary" id="btnProposal">提案</button>
              <button class="btn small outline" id="btnCase">案件</button>
              <button class="btn small outline" id="btnMotion">臨時動議</button>
            </div>
            <h3 style="margin-top:10px;">我的提案</h3>
            ${
              proposals.length ?
                tableHTML(['標題','分類','狀態','提交時間'],
                  proposals.map(p=>[esc(p.title), esc(p.category), esc(p.status), fmtDate(p.submitDate)]))
              : '<div class="empty">尚無提案</div>'
            }
            <div class="alert mt-16 small">
              若需查看議程與會議內容，請洽管理員或等待進一步授權功能。
            </div>
          </div>
        `;
        document.getElementById('btnProposal').onclick=()=> proposalDialog();
        document.getElementById('btnCase').onclick=()=> caseDialog();
        document.getElementById('btnMotion').onclick=()=> motionDialog();
      }catch(e){
        root.innerHTML=`<div class="card"><h2>載入失敗</h2><p class="danger-text">${esc(e.message)}</p></div>`;
      }
    }

    function proposalDialog(){
      const body=document.createElement('div');
      body.innerHTML=`
        <label class="form-field">
          標題
          <input type="text" id="ppTitle" />
        </label>
        <label class="form-field">
          內容
          <textarea id="ppContent"></textarea>
        </label>
        <label class="form-field">
          分類
          <input type="text" id="ppCat" value="一般" />
        </label>
      `;
      openModal({
        title:'提交提案',
        body,
        actions:[
          { label:'取消', variant:'ghost' },
          { label:'送出', variant:'primary', onClick: async (close)=>{
            const title=body.querySelector('#ppTitle').value.trim();
            const content=body.querySelector('#ppContent').value.trim();
            const cat=body.querySelector('#ppCat').value.trim()||'一般';
            if (!title || !content){ alert('請填寫標題與內容'); return false; }
            await API.submitProposal(State.profile.lineId, title, content, cat);
            showToast('提案已提交','success');
            close();
            if (State.activeTab==='board-lite') State.emit('tab');
          }}
        ]
      });
    }
    function caseDialog(){
      const body=document.createElement('div');
      body.innerHTML=`
        <label class="form-field">
          標題
          <input type="text" id="csTitle"/>
        </label>
        <label class="form-field">
          摘要
          <textarea id="csSummary"></textarea>
        </label>
        <label class="form-field">
          類型
          <input type="text" id="csType" value="一般"/>
        </label>
      `;
      openModal({
        title:'提交案件',
        body,
        actions:[
          { label:'取消', variant:'ghost' },
          { label:'送出', variant:'primary', onClick: async (close)=>{
            const title=body.querySelector('#csTitle').value.trim();
            if (!title) { alert('請填寫標題'); return false; }
            const summary=body.querySelector('#csSummary').value.trim();
            const type=body.querySelector('#csType').value.trim()||'一般';
            await API.submitCase(State.profile.lineId, title, summary, type);
            showToast('案件已提交','success');
            close();
          }}
        ]
      });
    }
    function motionDialog(){
      const body=document.createElement('div');
      body.innerHTML=`
        <label class="form-field">
          標題
          <input type="text" id="mtTitle" />
        </label>
        <label class="form-field">
          理由
          <textarea id="mtReason"></textarea>
        </label>
        <label class="form-field">
          會議ID (可留空)
          <input type="text" id="mtMeeting"/>
        </label>
      `;
      openModal({
        title:'提出臨時動議',
        body,
        actions:[
          { label:'取消', variant:'ghost' },
          { label:'送出', variant:'primary', onClick: async (close)=>{
            const title=body.querySelector('#mtTitle').value.trim();
            if (!title){ alert('請填寫標題'); return false; }
            const reason=body.querySelector('#mtReason').value.trim();
            const meetingId=body.querySelector('#mtMeeting').value.trim();
            await API.submitMotion(State.profile.lineId, title, reason, meetingId);
            showToast('臨時動議已提交','success');
            close();
          }}
        ]
      });
    }
  </script>

  <!-- ========================= 模組：views/admin-members.js ========================= -->
  <script type="module" data-file="views/admin-members.js">
    import { State } from '../state.js';
    import { API } from '../api/wrappers.js';
    import { esc } from '../utils/format.js';
    import { tableHTML } from './common/table.js';
    import { openModal } from '../ui/modal.js';
    import { showToast } from '../ui/toast.js';

    export async function renderAdminMembers(root){
      if (!State.isAdmin) return root.innerHTML='<div class="card">無權限</div>';
      root.innerHTML='<div class="card"><h2>載入會員...</h2></div>';
      try{
        const list=await API.getAllMembers(State.profile.lineId,'','');
        root.innerHTML=`
          <div class="card">
            <h2>會員管理</h2>
            <div class="toolbar">
              <input type="text" id="mbSearch" placeholder="搜尋 (姓名 / LINE)" style="padding:8px 12px; border:1px solid var(--border); border-radius:8px;"/>
              <select id="mbType" style="padding:8px 12px; border:1px solid var(--border); border-radius:8px;">
                <option value="">全部類別</option>
                <option value="一般">一般</option>
                <option value="理監事">理監事</option>
              </select>
              <button class="btn small outline" id="btnFilter">篩選</button>
              <button class="btn small primary" id="btnExport">匯出 CSV</button>
            </div>
            <div id="memberTable">
              ${
                list.length ?
                  tableHTML(['LINE ID','暱稱','真實姓名','類別','狀態','管理員','操作'],
                    list.map(m=>[
                      esc(m.lineId),
                      esc(m.lineName||''),
                      esc(m.realName||''),
                      esc(m.memberType||''),
                      esc(m.status||''),
                      m.isAdmin?'是':'否',
                      `<button class="btn small outline btnEdit" data-id="${m.lineId}">編輯</button>`
                    ]))
                : '<div class="empty">尚無會員</div>'
              }
            </div>
          </div>
        `;
        root.querySelectorAll('.btnEdit').forEach(b=>{
          b.onclick=()=> editMemberDialog(b.dataset.id);
        });
        document.getElementById('btnFilter').onclick=()=> filterMembers();
        document.getElementById('btnExport').onclick=()=> exportMembers();
      }catch(e){
        root.innerHTML=`<div class="card"><h2>錯誤</h2><p class="danger-text">${esc(e.message)}</p></div>`;
      }
    }

    async function filterMembers(){
      const q=document.getElementById('mbSearch').value.trim();
      const mt=document.getElementById('mbType').value;
      try{
        const list=await API.getAllMembers(State.profile.lineId, q, mt);
        document.getElementById('memberTable').innerHTML = list.length ?
          tableHTML(['LINE ID','暱稱','真實姓名','類別','狀態','管理員','操作'],
            list.map(m=>[
              esc(m.lineId),
              esc(m.lineName||''),
              esc(m.realName||''),
              esc(m.memberType||''),
              esc(m.status||''),
              m.isAdmin?'是':'否',
              `<button class="btn small outline btnEdit" data-id="${m.lineId}">編輯</button>`
            ]))
          : '<div class="empty">無符合結果</div>';
        document.querySelectorAll('.btnEdit').forEach(b=>{
          b.onclick=()=> editMemberDialog(b.dataset.id);
        });
      }catch(e){ showToast(e.message,'error'); }
    }

    async function exportMembers(){
      try{
        const res=await API.exportMembers(State.profile.lineId);
        const blob=new Blob([res.csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url; a.download='members.csv'; a.click();
        URL.revokeObjectURL(url);
        showToast('已匯出','success');
      }catch(e){ showToast(e.message,'error'); }
    }

    async function editMemberDialog(lineId){
      try{
        const info=await API.getUserInfo(lineId);
        const body=document.createElement('div');
        body.innerHTML=`
          <div class="form-grid">
            <label class="form-field">
              真實姓名
              <input type="text" id="emReal" value="${esc(info.realName||'')}"/>
            </label>
            <label class="form-field">
              會員類別
              <select id="emType">
                <option value="">(未設定)</option>
                <option value="一般" ${info.memberType==='一般'?'selected':''}>一般</option>
                <option value="理監事" ${info.memberType==='理監事'?'selected':''}>理監事</option>
              </select>
            </label>
            <label class="form-field">
              是否管理員
              <select id="emAdm">
                <option value="否" ${!info.isAdmin?'selected':''}>否</option>
                <option value="是" ${info.isAdmin?'selected':''}>是</option>
              </select>
            </label>
          </div>
        `;
        openModal({
          title:'編輯會員',
          body,
          actions:[
            { label:'取消', variant:'ghost' },
            { label:'儲存', variant:'primary', onClick: async (close)=>{
              const realName=body.querySelector('#emReal').value.trim();
              if (!realName){ alert('請輸入真實姓名'); return false; }
              const memberType=body.querySelector('#emType').value||'一般';
              const isAdmin = body.querySelector('#emAdm').value==='是';
              await API.updateMember(State.profile.lineId, lineId, { realName, memberType, isAdmin });
              showToast('已更新','success');
              close();
              if (State.activeTab==='admin-members') State.emit('tab');
            }}
          ]
        });
      }catch(e){ showToast(e.message,'error'); }
    }
  </script>

  <!-- ========================= 模組：views/admin-activities.js ========================= -->
  <script type="module" data-file="views/admin-activities.js">
    import { State } from '../state.js';
    import { API } from '../api/wrappers.js';
    import { esc, fmtDate } from '../utils/format.js';
    import { tableHTML } from './common/table.js';
    import { openModal } from '../ui/modal.js';
    import { showToast } from '../ui/toast.js';

    export async function renderAdminActivities(root){
      if (!State.isAdmin) return root.innerHTML='<div class="card">無權限</div>';
      root.innerHTML='<div class="card"><h2>載入活動...</h2></div>';
      try{
        const list=await API.getAllActivities(State.profile.lineId);
        root.innerHTML=`
          <div class="card">
            <h2>活動管理</h2>
            <div class="toolbar">
              <button class="btn small primary" id="btnAddAct">新增活動</button>
            </div>
            ${
              list.length ?
                tableHTML(['名稱','日期','地點','人數','狀態','操作'],
                  list.map(a=>[
                    esc(a.name),
                    fmtDate(a.date),
                    esc(a.location||''),
                    (a.currentParticipants||0)+'/'+(a.maxParticipants||'-'),
                    `<span class="status ${a.status==='開放報名'?'open':'closed'}">${a.status}</span>`,
                    `
                      <button class="btn small outline btnEdit" data-id="${a.id}">編輯</button>
                      <button class="btn small outline btnRegs" data-id="${a.id}">報名</button>
                      <button class="btn small danger btnDel" data-id="${a.id}">刪除</button>
                    `
                  ]))
              : '<div class="empty">尚無活動</div>'
            }
          </div>
          <div class="card" id="actRegsPanel" style="display:none;"></div>
        `;
        root.querySelector('#btnAddAct').onclick=()=> actDialog();
        root.querySelectorAll('.btnEdit').forEach(b=> b.onclick=()=> editActDialog(b.dataset.id));
        root.querySelectorAll('.btnDel').forEach(b=> b.onclick=()=> delAct(b.dataset.id));
        root.querySelectorAll('.btnRegs').forEach(b=> b.onclick=()=> loadRegistrations(b.dataset.id));
      }catch(e){
        root.innerHTML=`<div class="card"><h2>錯誤</h2><p class="danger-text">${esc(e.message)}</p></div>`;
      }
    }

    function actDialog(){
      const body=document.createElement('div');
      body.innerHTML=`
        <label class="form-field">
          活動名稱
          <input type="text" id="acName"/>
        </label>
        <label class="form-field">
          日期 (YYYY-MM-DD)
          <input type="text" id="acDate" placeholder="2025-01-01"/>
        </label>
        <label class="form-field">
          地點
          <input type="text" id="acLoc"/>
        </label>
        <label class="form-field">
          最大人數 (空=不限)
          <input type="number" id="acMax"/>
        </label>
        <label class="form-field">
          費用
          <input type="number" id="acFee" value="0"/>
        </label>
        <label class="form-field">
          描述
          <textarea id="acDesc"></textarea>
        </label>
      `;
      openModal({
        title:'新增活動',
        body,
        actions:[
          { label:'取消', variant:'ghost' },
          { label:'建立', variant:'primary', onClick: async (close)=>{
            const name=body.querySelector('#acName').value.trim();
            const date=body.querySelector('#acDate').value.trim();
            if (!name || !date){ alert('請填寫名稱與日期'); return false; }
            const loc=body.querySelector('#acLoc').value.trim();
            const max=body.querySelector('#acMax').value;
            const fee=body.querySelector('#acFee').value||0;
            const desc=body.querySelector('#acDesc').value.trim();
            await API.createActivity(State.profile.lineId, name, desc, date, loc, max||'', fee);
            showToast('建立成功','success'); close(); if (State.activeTab==='admin-activities') State.emit('tab');
          }}
        ]
      });
    }

    async function editActDialog(id){
      const list=await API.getAllActivities(State.profile.lineId);
      const act=list.find(a=>a.id===id);
      if (!act) return showToast('找不到活動','error');
      const body=document.createElement('div');
      body.innerHTML=`
        <label class="form-field">名稱 <input type="text" id="acName" value="${esc(act.name)}"/></label>
        <label class="form-field">日期 <input type="text" id="acDate" value="${esc(fmtDate(act.date))}"/></label>
        <label class="form-field">地點 <input type="text" id="acLoc" value="${esc(act.location||'')}"/></label>
        <label class="form-field">最大人數 <input type="number" id="acMax" value="${esc(act.maxParticipants||'')}"/></label>
        <label class="form-field">費用 <input type="number" id="acFee" value="${esc(act.fee||0)}"/></label>
        <label class="form-field">描述 <textarea id="acDesc">${esc(act.description||'')}</textarea></label>
      `;
      openModal({
        title:'編輯活動',
        body,
        actions:[
          { label:'取消', variant:'ghost' },
          { label:'儲存', variant:'primary', onClick: async (close)=>{
            const name=body.querySelector('#acName').value.trim();
            const date=body.querySelector('#acDate').value.trim();
            if (!name || !date){ alert('請填寫必填欄位'); return false; }
            await API.updateActivity(State.profile.lineId, id, {
              name, date,
              location: body.querySelector('#acLoc').value,
              maxParticipants: body.querySelector('#acMax').value || '',
              fee: body.querySelector('#acFee').value || 0,
              description: body.querySelector('#acDesc').value
            });
            showToast('已更新','success'); close(); if (State.activeTab==='admin-activities') State.emit('tab');
          }}
        ]
      });
    }

    async function delAct(id){
      if (!confirm('確定刪除活動？')) return;
      try{
        await API.deleteActivity(State.profile.lineId, id);
        showToast('已刪除','success');
        if (State.activeTab==='admin-activities') State.emit('tab');
      }catch(e){ showToast(e.message,'error'); }
    }

    async function loadRegistrations(id){
      try{
        const regs=await API.getActivityRegistrations(State.profile.lineId, id);
        const panel=document.getElementById('actRegsPanel');
        panel.style.display='block';
        panel.innerHTML=`
          <h2>報名名單</h2>
          ${
            regs.length ?
              tableHTML(['姓名','報名日','狀態'],
                regs.map(r=>[esc(r.participantName||''), fmtDate(r.registerDate), esc(r.status)]))
            : '<div class="empty">尚無報名</div>'
          }
        `;
        panel.scrollIntoView({behavior:'smooth'});
      }catch(e){ showToast(e.message,'error'); }
    }
  </script>

  <!-- ========================= 模組：views/finance.js ========================= -->
  <script type="module" data-file="views/finance.js">
    import { State } from '../state.js';
    import { API } from '../api/wrappers.js';
    import { esc, fmtDate } from '../utils/format.js';
    import { tableHTML } from './common/table.js';
    import { showToast } from '../ui/toast.js';
    import { openModal } from '../ui/modal.js';

    export async function renderFinance(root){
      if (!State.isAdmin) return root.innerHTML='<div class="card">無權限</div>';
      root.innerHTML='<div class="card"><h2>載入財務...</h2></div>';
      try{
        const [overview, pending, budget, transactions] = await Promise.all([
          API.getFinanceOverview(State.profile.lineId),
          API.getPendingExpenses(State.profile.lineId),
          API.getBudgetStatus(State.profile.lineId),
          API.getTransactions(State.profile.lineId)
        ]);
        root.innerHTML=`
          <div class="grid cols-2">
            <div class="card">
              <h2>財務概覽</h2>
              <p>總收入：${overview.totalIncome}</p>
              <p>總支出：${overview.totalExpense}</p>
              <p>結餘：<strong>${overview.balance}</strong></p>
              <p>捐款筆數：${overview.donationCount}</p>
            </div>
            <div class="card">
              <h2>預算狀況</h2>
              <p>本月預算：${budget.monthlyBudget}</p>
              <p>已使用：${budget.monthlyExpense}</p>
              <p>剩餘：${budget.remainingBudget}</p>
              <p>使用率：${budget.budgetUsed}%</p>
            </div>
            <div class="card">
              <h2>待審支出</h2>
              ${
                pending.length ?
                  tableHTML(['申請者','類別','金額','日期','操作'],
                    pending.map(p=>[
                      esc(p.applicantName||p.lineId),
                      esc(p.category),
                      p.amount,
                      fmtDate(p.submitDate),
                      `
                        <button class="btn small outline btnApprove" data-id="${p.id}">核准</button>
                        <button class="btn small danger btnReject" data-id="${p.id}">拒絕</button>
                      `
                    ]))
                : '<div class="empty">無待審核</div>'
              }
            </div>
            <div class="card">
              <h2>交易紀錄</h2>
              ${
                transactions.length ?
                  tableHTML(['日期','類型','金額','分類/說明'],
                    transactions.slice(0,30).map(t=>[
                      fmtDate(t.date),
                      t.type==='income'?'收入':'支出',
                      t.amount,
                      esc(t.category || t.notes || '')
                    ]))
                : '<div class="empty">尚無交易</div>'
              }
            </div>
          </div>
        `;
        root.querySelectorAll('.btnApprove').forEach(b=>{
          b.onclick=()=> reviewExpense(b.dataset.id,true);
        });
        root.querySelectorAll('.btnReject').forEach(b=>{
          b.onclick=()=> reviewExpense(b.dataset.id,false);
        });
      }catch(e){
        root.innerHTML=`<div class="card"><h2>錯誤</h2><p class="danger-text">${esc(e.message)}</p></div>`;
      }
    }

    function reviewExpense(id, approved){
      const body=document.createElement('div');
      body.innerHTML=`
        <label class="form-field">
          備註 / 理由
          <textarea id="rvNotes" placeholder="可留空"></textarea>
        </label>
      `;
      openModal({
        title: approved?'核准支出':'拒絕支出',
        body,
        actions:[
          { label:'取消', variant:'ghost' },
          { label:'送出', variant: approved?'primary':'danger', onClick: async (close)=>{
            const notes=body.querySelector('#rvNotes').value.trim();
            await API.approveExpense(State.profile.lineId, id, approved, notes);
            showToast(approved?'已核准':'已拒絕','success');
            close();
            if (State.activeTab==='finance') State.emit('tab');
          }}
        ]
      });
    }
  </script>

  <!-- ========================= 模組：views/board-admin.js ========================= -->
  <script type="module" data-file="views/board-admin.js">
    import { State } from '../state.js';
    import { API } from '../api/wrappers.js';
    import { esc, fmtDate } from '../utils/format.js';
    import { tableHTML } from './common/table.js';
    import { openModal } from '../ui/modal.js';
    import { showToast } from '../ui/toast.js';

    export async function renderBoardAdmin(root){
      if (!State.isAdmin) return root.innerHTML='<div class="card">無權限</div>';
      root.innerHTML='<div class="card"><h2>載入會議...</h2></div>';
      try{
        const meetings=await API.listBoardMeetings(State.profile.lineId,'');
        root.innerHTML=`
          <div class="card">
            <h2>會議列表</h2>
            <div class="toolbar">
              <button class="btn small primary" id="btnNewMeeting">新會議</button>
            </div>
            ${
              meetings.length ?
                tableHTML(['標題','日期','狀態','鎖定','操作'],
                  meetings.map(m=>[
                    esc(m.title),
                    fmtDate(m.meetingDate),
                    esc(m.status),
                    m.locked?'是':'否',
                    `
                      <button class="btn small outline btnAgenda" data-id="${m.id}">議程</button>
                      <button class="btn small outline btnLock" data-id="${m.id}">${m.locked?'解鎖':'鎖定'}</button>
                    `
                  ]))
              : '<div class="empty">尚無會議</div>'
            }
          </div>
          <div class="card" id="agendaPanel" style="display:none;"></div>
        `;
        root.querySelector('#btnNewMeeting').onclick=()=> meetingDialog();
        root.querySelectorAll('.btnAgenda').forEach(b=> b.onclick=()=> loadAgenda(b.dataset.id));
        root.querySelectorAll('.btnLock').forEach(b=> b.onclick=()=> toggleLock(b.dataset.id));
      }catch(e){
        root.innerHTML=`<div class="card"><h2>錯誤</h2><p class="danger-text">${esc(e.message)}</p></div>`;
      }
    }

    function meetingDialog(){
      const body=document.createElement('div');
      body.innerHTML=`
        <label class="form-field">
          標題
          <input type="text" id="mtTitle"/>
        </label>
        <label class="form-field">
          日期 (YYYY-MM-DD)
          <input type="text" id="mtDate"/>
        </label>
      `;
      openModal({
        title:'新增會議',
        body,
        actions:[
          { label:'取消', variant:'ghost' },
          { label:'建立', variant:'primary', onClick: async (close)=>{
            const title=body.querySelector('#mtTitle').value.trim();
            const date=body.querySelector('#mtDate').value.trim();
            if (!title || !date){ alert('請填寫標題與日期'); return false; }
            await API.createBoardMeeting(State.profile.lineId, title, date);
            showToast('會議已建立','success');
            close(); if (State.activeTab==='board-admin') State.emit('tab');
          }}
        ]
      });
    }

    async function loadAgenda(meetingId){
      try{
        const agendas=await API.listAgenda(State.profile.lineId, meetingId);
        const panel=document.getElementById('agendaPanel');
        panel.style.display='block';
        panel.innerHTML=`
          <h2>議程 - 會議ID: ${meetingId}</h2>
          <div class="toolbar">
            <button class="btn small primary" id="btnAddAgenda">新增議程</button>
            <button class="btn small outline" id="btnDecision">新增決議</button>
          </div>
          ${
            agendas.length ?
              tableHTML(['排序','標題','類型','狀態','決議','操作'],
                agendas.map(a=>[
                  a.order,
                  esc(a.title),
                  esc(a.type),
                  esc(a.status),
                  esc(a.decisionText||''),
                  `<button class="btn small outline btnAgStatus" data-id="${a.id}">狀態</button>`
                ]))
            : '<div class="empty">尚無議程</div>'
          }
        `;
        panel.querySelector('#btnAddAgenda').onclick=()=> addAgendaDialog(meetingId);
        panel.querySelector('#btnDecision').onclick=()=> decisionDialog(meetingId);
        panel.querySelectorAll('.btnAgStatus').forEach(b=>{
          b.onclick=()=> agendaStatusDialog(b.dataset.id);
        });
        panel.scrollIntoView({behavior:'smooth'});
      }catch(e){ showToast(e.message,'error'); }
    }

    async function toggleLock(meetingId){
      try{
        const meetings=await API.listBoardMeetings(State.profile.lineId,'');
        const m=meetings.find(x=>x.id===meetingId);
        if (!m) return;
        await API.lockBoardMeeting(State.profile.lineId, meetingId, !m.locked);
        showToast(!m.locked?'已鎖定':'已解鎖','success');
        if (State.activeTab==='board-admin') State.emit('tab');
      }catch(e){ showToast(e.message,'error'); }
    }

    function addAgendaDialog(meetingId){
      const body=document.createElement('div');
      body.innerHTML=`
        <label class="form-field">類型 <input type="text" id="agType" value="一般"/></label>
        <label class="form-field">標題 <input type="text" id="agTitle"/></label>
        <label class="form-field">說明 <textarea id="agDesc"></textarea></label>
        <label class="form-field">提報人 <input type="text" id="agPresenter"/></label>
      `;
      openModal({
        title:'新增議程',
        body,
        actions:[
          { label:'取消', variant:'ghost' },
          { label:'新增', variant:'primary', onClick: async (close)=>{
            const type=body.querySelector('#agType').value.trim();
            const title=body.querySelector('#agTitle').value.trim();
            if (!type || !title){ alert('請填寫類型與標題'); return false; }
            const desc=body.querySelector('#agDesc').value.trim();
            const presenter=body.querySelector('#agPresenter').value.trim();
            await API.addAgendaItem(State.profile.lineId, meetingId, type, '', title, desc, presenter);
            showToast('已新增','success');
            close(); loadAgenda(meetingId);
          }}
        ]
      });
    }

    function agendaStatusDialog(agendaId){
      const body=document.createElement('div');
      body.innerHTML=`
        <label class="form-field">狀態
          <select id="agStatus">
            <option value="待討論">待討論</option>
            <option value="討論中">討論中</option>
            <option value="完成">完成</option>
          </select>
        </label>
        <label class="form-field">決議文字
          <textarea id="agDecision"></textarea>
        </label>
      `;
      openModal({
        title:'更新議程狀態',
        body,
        actions:[
          { label:'取消', variant:'ghost' },
          { label:'儲存', variant:'primary', onClick: async (close)=>{
            const status=body.querySelector('#agStatus').value;
            const decision=body.querySelector('#agDecision').value.trim();
            await API.updateAgendaStatus(State.profile.lineId, agendaId, status, decision);
            showToast('已更新','success');
            close();
            if (State.activeTab==='board-admin') State.emit('tab');
          }}
        ]
      });
    }

    function decisionDialog(meetingId){
      const body=document.createElement('div');
      body.innerHTML=`
        <label class="form-field">議程ID <input type="text" id="dcAgenda"/></label>
        <label class="form-field">結果 <input type="text" id="dcResult" value="通過"/></label>
        <div class="form-grid cols-2">
          <label class="form-field">贊成票 <input type="number" id="dcFor" value="0"/></label>
          <label class="form-field">反對票 <input type="number" id="dcAgainst" value="0"/></label>
          <label class="form-field">棄權票 <input type="number" id="dcAbstain" value="0"/></label>
        </div>
        <label class="form-field">備註 <textarea id="dcNotes"></textarea></label>
      `;
      openModal({
        title:'新增決議',
        body,
        actions:[
          { label:'取消', variant:'ghost' },
          { label:'儲存', variant:'primary', onClick: async (close)=>{
            const ag=body.querySelector('#dcAgenda').value.trim();
            const res=body.querySelector('#dcResult').value.trim();
            if (!ag || !res){ alert('請填寫議程ID與結果'); return false; }
            await API.recordDecision(
              State.profile.lineId,
              meetingId, ag, res,
              body.querySelector('#dcFor').value||0,
              body.querySelector('#dcAgainst').value||0,
              body.querySelector('#dcAbstain').value||0,
              body.querySelector('#dcNotes').value.trim()
            );
            showToast('決議已記錄','success');
            close(); loadAgenda(meetingId);
          }}
        ]
      });
    }
  </script>

  <!-- ========================= 模組：app.js (主控制) ========================= -->
  <script type="module" data-file="app.js">
    import { CONFIG } from './config.js';
    import { State, buildTabs } from './state.js';
    import { API } from './api/wrappers.js';
    import { renderDashboard } from './views/dashboard.js';
    import { renderActivities } from './views/activities.js';
    import { renderDonations } from './views/donations.js';
    import { renderExpenses } from './views/expenses.js';
    import { renderFeedback } from './views/feedback.js';
    import { renderBoardLite } from './views/board-lite.js';
    import { renderAdminMembers } from './views/admin-members.js';
    import { renderAdminActivities } from './views/admin-activities.js';
    import { renderFinance } from './views/finance.js';
    import { renderBoardAdmin } from './views/board-admin.js';
    import { showToast } from './ui/toast.js';

    // 初始化
    async function init(){
      try{
        // 若需要 LIFF:
        if (CONFIG.USE_LIFF && CONFIG.LIFF_ID){
          await liff.init({ liffId: CONFIG.LIFF_ID });
          if (!liff.isLoggedIn()) liff.login();
          const pf = await liff.getProfile();
          State.setProfile({
            lineId: pf.userId,
            displayName: pf.displayName,
            pictureUrl: pf.pictureUrl
          });
        } else {
          State.setProfile(CONFIG.DEMO_FALLBACK_PROFILE);
        }
        await API.createUserIfNotExist(State.profile.lineId, State.profile.displayName);
        const u = await API.getUserInfo(State.profile.lineId);
        State.setUserInfo(u);
        buildTabs();
        renderTabs();
        renderCurrentView();
      }catch(e){
        console.error(e);
        showToast('初始化失敗: '+e.message,'error',6500);
        document.getElementById('viewContainer').innerHTML = '<div class="card"><h2>無法初始化</h2><p>'+e.message+'</p></div>';
      }
    }

    function renderTabs(){
      const box=document.getElementById('mainTabs');
      box.innerHTML='';
      State.tabs.forEach(t=>{
        const btn=document.createElement('button');
        btn.className='tab-btn '+(State.activeTab===t.id?'active':'');
        btn.textContent=t.label;
        btn.onclick=()=> {
          State.setActiveTab(t.id);
          renderTabs();
          renderCurrentView();
        };
        box.appendChild(btn);
      });
    }

    function renderCurrentView(){
      const root=document.getElementById('viewContainer');
      switch(State.activeTab){
        case 'dashboard': return renderDashboard(root);
        case 'activities': return renderActivities(root);
        case 'donations': return renderDonations(root);
        case 'expenses': return renderExpenses(root);
        case 'feedback': return renderFeedback(root);
        case 'board-lite': return renderBoardLite(root);
        case 'admin-members': return renderAdminMembers(root);
        case 'admin-activities': return renderAdminActivities(root);
        case 'finance': return renderFinance(root);
        case 'board-admin': return renderBoardAdmin(root);
        default:
          root.innerHTML='<div class="card"><h2>未知分頁</h2></div>';
      }
    }

    // Profile Render
    State.on(ev=>{
      if (ev==='profile' || ev==='userInfo'){
        const box=document.getElementById('profileBox');
        if (!State.profile) {
          box.innerHTML='<div class="small">尚未登入</div>';
          return;
        }
        box.innerHTML=`
          <div style="display:flex; gap:10px; align-items:center;">
            <img src="${State.profile.pictureUrl||''}" alt="pf" style="width:42px; height:42px; border-radius:50%; object-fit:cover; border:1px solid var(--border);" />
            <div style="display:flex; flex-direction:column;">
              <strong style="font-size:13px;">${State.profile.displayName}</strong>
              <span class="small" style="color:var(--muted);">${State.isAdmin?'管理員':'會員'}</span>
            </div>
          </div>
        `;
      }
      if (ev==='tabs'){ renderTabs(); }
      if (ev==='tab'){ renderCurrentView(); }
    });

    document.getElementById('btnReload').onclick=()=>{
      renderCurrentView();
      showToast('已重新整理','success',1500);
    };

    // 啟動
    init();
  </script>
</body>
</html>
