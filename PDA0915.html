<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>帕金森病友會系統 v2.4</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="theme-color" content="#4a67d6">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
<style>
:root {
--base-font:17px;
--font-scale:1;
--primary:#4a67d6;
--primary-alt:#2f4bb0;
--grad:linear-gradient(135deg,#4a67d6,#6d4acb);
--bg:#eef2f8;
--card:#ffffff;
--success:#2f9e44;
--warn:#d98324;
--error:#d64545;
--text:#1f2933;
--text-light:#5d6a75;
--radius:18px;
--shadow:0 4px 14px rgba(0,0,0,.08);
--focus-ring:0 0 0 4px rgba(74,103,214,.35);
}
body.high-contrast {
--bg:#101418;
--card:#1d242b;
--text:#f5f7fa;
--text-light:#c5ced6;
--shadow:0 4px 16px rgba(0,0,0,.6);
--grad:linear-gradient(135deg,#203a85,#4a67d6);
}
html,body { font-size: var(--base-font); }
body {
margin:0; background:var(--bg); color:var(--text);
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC",Roboto,sans-serif;
line-height:1.6; letter-spacing:.3px;
transition:background .4s,color .4s;
}
body.font-large { --base-font:20px; }
body.font-xlarge { --base-font:22px; }
header {
background:var(--grad); color:#fff; padding:28px 16px 22px;
position:sticky; top:0; z-index:20; text-align:center;
box-shadow:0 6px 16px rgba(0,0,0,.18);
}
h1 { margin:0; font-size:1.55rem; letter-spacing:1px; }
.subtitle { font-size:.9rem; opacity:.9; margin-top:6px; }
.access-bar {
margin-top:14px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;
}
.access-bar button {
background:rgba(255,255,255,.15); color:#fff; border:2px solid rgba(255,255,255,.35);
padding:8px 14px; border-radius:999px; cursor:pointer; font-size:.85rem;
font-weight:600; backdrop-filter:blur(4px);
transition:.25s;
}
.access-bar button:hover, .access-bar button:focus-visible {
background:#fff; color:#333;
outline:none;
}
.container { max-width:1180px; margin:0 auto; padding:18px 16px 60px; }

.tabs { display:flex; gap:10px; flex-wrap:wrap; margin:18px 0 14px; }
.tab-btn {
flex:1 1 180px; background:#fff; border:2px solid #d0d7e2;
border-radius:14px; padding:14px 12px; cursor:pointer;
font-size:1rem; font-weight:700; text-align:center;
display:flex; align-items:center; justify-content:center; gap:6px;
transition:.25s; min-height:54px; line-height:1.3;
}
.tab-btn .icon { font-size:1.25rem; }
.tab-btn:hover:not(.active){ border-color:var(--primary); }
.tab-btn.active {
background:var(--grad); color:#fff; border-color:var(--primary);
box-shadow:0 6px 18px rgba(74,103,214,.45);
}

.panel { display:none; animation:fade .45s ease; }
.panel.active { display:block; }

@keyframes fade { from{opacity:0; transform:translateY(18px);} to{opacity:1; transform:translateY(0);} }

.card {
background:var(--card); border-radius:var(--radius);
padding:22px 22px 24px; margin-bottom:22px;
box-shadow:var(--shadow); position:relative;
transition:background .4s;
}
.card h3 { margin:0 0 14px; font-size:1.2rem; letter-spacing:.5px; }
.card h4 { margin:0 0 10px; font-size:1.05rem; }

.grid { display:grid; gap:18px; }
@media (min-width:760px){
.grid.cols-2{ grid-template-columns:repeat(2,1fr); }
.grid.cols-3{ grid-template-columns:repeat(3,1fr); }
.grid.cols-4{ grid-template-columns:repeat(4,1fr); }
}

.stat {
background:var(--card); border-radius:18px; text-align:center;
padding:22px 12px 20px; position:relative;
box-shadow:var(--shadow);
}
.stat:before {
content:''; position:absolute; top:0; left:0; width:100%; height:5px;
background:var(--grad); border-top-left-radius:18px; border-top-right-radius:18px;
}
.stat .num { font-size:1.75rem; font-weight:800; color:var(--primary); margin:8px 0 4px; }
.stat .label { font-size:.8rem; color:var(--text-light); letter-spacing:1px; font-weight:600; }

label { font-size:.85rem; font-weight:700; margin-bottom:6px; display:block; color:var(--text-light); }
input,select,textarea {
width:100%; padding:13px 14px; font-size:1rem;
border:2px solid #c5ced8; border-radius:14px; background:#fff;
transition:.25s; font-weight:500;
}
textarea { resize:vertical; min-height:110px; }
input:focus,select:focus,textarea:focus {
outline:none; border-color:var(--primary); box-shadow:var(--focus-ring);
}

.actions { display:flex; gap:12px; flex-wrap:wrap; margin-top:6px; }
.btn {
background:var(--grad); color:#fff; padding:12px 20px;
border:none; border-radius:14px; font-size:.95rem; font-weight:700;
cursor:pointer; display:inline-flex; align-items:center; gap:8px;
box-shadow:0 5px 15px rgba(74,103,214,.45); position:relative; transition:.25s;
letter-spacing:.5px; min-height:46px;
}
.btn:hover { transform:translateY(-3px); }
.btn:active { transform:translateY(0); }
.btn.outline {
background:#fff; color:var(--primary); border:2px solid var(--primary);
box-shadow:none;
}
.btn.outline:hover { background:var(--grad); color:#fff; }
.btn.secondary { background:#455468; box-shadow:0 4px 12px rgba(69,84,104,.4); }
.btn.danger { background:linear-gradient(135deg,#e05252,#c92a2a); box-shadow:0 4px 14px rgba(201,42,42,.5); }
.btn.warn { background:linear-gradient(135deg,#f59f00,#d98200); }
.btn.small { padding:8px 14px; font-size:.8rem; min-height:40px; }
.btn.disabled,.btn:disabled { opacity:.55; cursor:not-allowed; }

.btn.loading .text{ opacity:0; }
.btn.loading:after {
content:''; width:20px; height:20px; border:3px solid rgba(255,255,255,.35);
border-top:3px solid #fff; border-radius:50%; animation:spin 1s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg);} }

.inline { display:flex; gap:14px; flex-wrap:wrap; align-items:center; }
.badge {
display:inline-block; padding:5px 12px; font-size:.7rem; font-weight:700;
border-radius:999px; background:#e6ebf2; color:#333; letter-spacing:.5px; margin-right:4px;
}
.badge.green { background:rgba(47,158,68,.18); color:#2f9e44; }
.badge.red { background:rgba(214,69,69,.18); color:#d64545; }
.badge.orange { background:rgba(217,131,36,.18); color:#d98324; }
.badge.blue { background:rgba(74,103,214,.18); color:#4a67d6; }

.list-item {
background:#fff; border-radius:18px; padding:18px 20px; margin-bottom:16px;
box-shadow:var(--shadow); border-left:6px solid var(--primary); position:relative;
font-size:1rem;
}
.list-item.full { border-left-color:var(--error); }
.list-item h4 { margin:0 0 8px; font-size:1.05rem; letter-spacing:.5px; }
.meta {
font-size:.72rem; color:var(--text-light); display:flex; gap:14px; flex-wrap:wrap;
line-height:1.3; font-weight:500;
}

.notice {
padding:16px 18px; border-radius:16px; font-size:.92rem; line-height:1.5;
background:#fffaf0; color:#744210; border:2px solid #fbd38d; margin-bottom:18px;
}
.notice.error { background:#fff5f5; color:#842029; border-color:#feb2b2; }
.notice.success { background:#f0fff4; color:#22543d; border-color:#9ae6b4; }
.notice.info { background:#ebf8ff; color:#2b6cb0; border-color:#90cdf4; }

.empty { text-align:center; padding:60px 20px; color:var(--text-light); font-size:1rem; }
.empty .icon { font-size:3rem; margin-bottom:8px; }

.pagination { display:flex; gap:8px; flex-wrap:wrap; margin-top:14px; }
.pagination button {
padding:8px 14px; border:2px solid #d0d7e2; background:#fff;
font-weight:700; border-radius:12px; cursor:pointer; font-size:.85rem; letter-spacing:.5px;
}
.pagination button.active, .pagination button:hover {
background:var(--grad); color:#fff; border-color:var(--primary);
}

.notification {
position:fixed; top:24px; right:24px; background:#2d3748; color:#fff;
padding:16px 22px; border-radius:16px; box-shadow:0 10px 35px rgba(0,0,0,.3);
transform:translateY(-25px); opacity:0; transition:.45s; z-index:999;
max-width:420px; display:flex; gap:16px; align-items:flex-start; font-size:1rem;
}
.notification.show { transform:translateY(0); opacity:1; }
.notification.success { background:var(--success); }
.notification.error { background:var(--error); }
.notification.warn { background:var(--warn); }
.notification button {
background:rgba(255,255,255,.2); color:#fff; border:none;
width:32px; height:32px; border-radius:50%; cursor:pointer;
font-weight:700; font-size:16px; line-height:1;
}

.table-wrap { overflow-x:auto; }
table { width:100%; border-collapse:collapse; font-size:.85rem; }
th,td { padding:10px 12px; text-align:left; border-bottom:1px solid #dfe5ec; }
th {
background:#f1f4f8; font-weight:700; font-size:.72rem;
letter-spacing:.8px; color:#4a5568; text-transform:uppercase;
}
tr:hover td { background:#fafbfc; }

.inline-edit-input {
width:100%; border:1px solid #cbd5e0; border-radius:8px; padding:6px 8px; font-size:.8rem;
background:#fff;
}

.progress { width:100%; height:12px; background:#d9e1eb; border-radius:8px; overflow:hidden; }
.progress > div { height:100%; background:var(--grad); width:0; transition:width .6s; }

.subtabs { display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 22px; }
.subtab-btn {
background:#fff; border:2px solid #d0d7e2; padding:10px 16px; border-radius:12px;
font-size:.85rem; font-weight:700; cursor:pointer; transition:.25s;
min-height:44px;
}
.subtab-btn.active {
background:var(--grad); color:#fff; border-color:var(--primary);
box-shadow:0 5px 16px rgba(74,103,214,.45);
}

footer {
text-align:center; padding:50px 0 80px; font-size:.7rem;
color:#8a98a8; letter-spacing:.5px;
}

body.high-contrast .card,
body.high-contrast .stat,
body.high-contrast .list-item,
body.high-contrast .tab-btn:not(.active),
body.high-contrast .subtab-btn:not(.active){
background:#24303a; border-color:#3a4a58;
}
body.high-contrast input,
body.high-contrast select,
body.high-contrast textarea {
background:#1d242b; color:#fff; border-color:#3a4a58;
}
body.high-contrast table th { background:#2d3a45; }
body.high-contrast .notice.info { background:#153954; color:#a9d8ff; }

:focus-visible { outline:2px solid var(--primary); outline-offset:3px; border-radius:8px; }

/* 手機調整 */
@media (max-width:640px){
h1 { font-size:1.35rem; }
.tab-btn { flex:1 1 calc(50% - 8px); font-size:.9rem; }
table { font-size:.75rem; }
.stat .num { font-size:1.4rem; }
}
</style>
</head>
<body>
<header>
<h1>🏥 帕金森病友會 系統 v2.4</h1>
<div class="subtitle">會員・活動・捐款・支出・回饋・理監事・報表</div>
<div class="access-bar">
  <button id="btn-font-down" aria-label="縮小字體">Ａ－</button>
  <button id="btn-font-up" aria-label="放大字體">Ａ＋</button>
  <button id="btn-contrast" aria-label="高對比模式切換">高對比</button>
  <button id="btn-reload" aria-label="重新整理資料">重新整理</button>
</div>
</header>
<div class="container">

<!-- 個人資訊 -->
<div id="user-info" class="card hidden">
  <h3>👤 個人資訊</h3>
  <div id="user-details"></div>
</div>

<!-- Tabs -->
<div class="tabs" id="tabs">
  <div class="tab-btn active" data-tab="profile"><span class="icon">📝</span>個人資料</div>
  <div class="tab-btn" data-tab="activities"><span class="icon">📅</span>活動</div>
  <div class="tab-btn" data-tab="donations"><span class="icon">💝</span>捐款</div>
  <div class="tab-btn" data-tab="finance"><span class="icon">💸</span>支出 / 財務</div>
  <div class="tab-btn" data-tab="feedback"><span class="icon">🗣</span>回饋</div>
  <div class="tab-btn admin-only hidden" data-tab="admin"><span class="icon">🛠</span>管理</div>
</div>

<!-- Panels: 依原功能 (為節省篇幅，以下前端 JS 與原 v2.3 相同邏輯，僅調整樣式及加上字級 / 高對比操作)
     由於篇幅限制，此處前端 JS 保留功能邏輯不再逐字註解 → 已內嵌於腳本區域
     若需細節說明可再提出。 -->

<div class="panel active" id="panel-profile">
  <div class="card">
    <h3>📝 會員註冊 / 更新</h3>
    <div class="grid cols-2">
      <div>
        <label for="realName">真實姓名 *</label>
        <input id="realName" type="text" placeholder="請輸入姓名">
      </div>
      <div>
        <label for="memberType">會員類別 *</label>
        <select id="memberType">
          <option value="">請選擇</option>
          <option value="patient">病友</option>
          <option value="family">家屬</option>
          <option value="volunteer">志工</option>
          <option value="medical">醫護</option>
          <option value="supporter">支持者</option>
        </select>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="btn-register"><span class="text">儲存註冊資料</span></button>
    </div>
    <div style="margin:22px 0 10px; height:2px; background:linear-gradient(90deg,#c8d1dc,#e2e8f0,#c8d1dc);"></div>
    <h4>📞 聯絡資訊</h4>
    <div class="grid cols-2">
      <div>
        <label for="phone">電話</label>
        <input id="phone" type="tel" placeholder="例如：0912345678">
      </div>
      <div>
        <label for="email">電子郵件</label>
        <input id="email" type="email">
      </div>
      <div>
        <label for="address">地址</label>
        <input id="address" type="text">
      </div>
      <div>
        <label for="birthday">生日</label>
        <input id="birthday" type="date">
      </div>
    </div>
    <div class="actions">
      <button class="btn secondary" id="btn-update-contact"><span class="text">更新聯絡資訊</span></button>
    </div>
  </div>
</div>

<div class="panel" id="panel-activities">
  <div class="grid cols-2 mb">
    <div class="stat"><div class="num" id="stat-activity-total">0</div><div class="label">可報名活動</div></div>
    <div class="stat"><div class="num" id="stat-my-registrations">0</div><div class="label">我的報名</div></div>
  </div>
  <div class="card">
    <div class="inline" style="justify-content:space-between;align-items:center;">
      <h3 style="margin:0;">📅 可報名活動</h3>
      <div style="position:relative;min-width:240px;">
        <input id="activity-search" type="text" placeholder="搜尋活動關鍵字...">
      </div>
    </div>
    <div id="activity-list" style="margin-top:16px;"></div>
    <div class="pagination" id="activity-pagination"></div>
  </div>
  <div class="card">
    <h3>🗂 我的活動報名</h3>
    <div id="my-activity-list"></div>
  </div>
</div>

<div class="panel" id="panel-donations">
  <div class="grid cols-2 mb">
    <div class="stat"><div class="num" id="stat-donation-count">0</div><div class="label">捐款筆數</div></div>
    <div class="stat"><div class="num" id="stat-donation-total">0</div><div class="label">捐款總額</div></div>
  </div>
  <div class="card">
    <h3>💝 新增捐款</h3>
    <div class="grid cols-2">
      <div>
        <label for="donation-amount">金額 *</label>
        <input id="donation-amount" type="number" min="1">
      </div>
      <div>
        <label for="donor-name">捐款人姓名 (可留空)</label>
        <input id="donor-name" type="text">
      </div>
    </div>
    <div>
      <label for="donation-notes">備註</label>
      <textarea id="donation-notes" placeholder="捐款用途或備註"></textarea>
    </div>
    <div class="actions">
      <button class="btn" id="btn-add-donation"><span class="text">新增捐款記錄</span></button>
    </div>
  </div>
  <div class="card">
    <h3>📊 我的捐款記錄</h3>
    <div id="donation-list"></div>
  </div>
</div>

<div class="panel" id="panel-finance">
  <div class="card admin-only hidden" id="accounts-card">
    <h3>💳 帳戶餘額</h3>
    <div id="account-list"></div>
  </div>
  <div class="card admin-only hidden" id="budget-card">
    <h3>📈 本月預算</h3>
    <div class="progress"><div id="budget-progress"></div></div>
    <div id="budget-detail" style="margin-top:12px;font-size:.95rem;"></div>
  </div>
  <div class="card">
    <h3>💸 支出申請</h3>
    <div class="grid cols-2">
      <div>
        <label for="expense-category">支出類別 *</label>
        <select id="expense-category">
          <option value="activity">活動支出</option>
          <option value="office">辦公費用</option>
          <option value="marketing">宣傳費用</option>
          <option value="equipment">設備費用</option>
          <option value="welfare">福利支出</option>
          <option value="medical">醫療支援</option>
          <option value="volunteer">志工費用</option>
          <option value="other">其他支出</option>
        </select>
      </div>
      <div>
        <label for="expense-amount">金額 *</label>
        <input id="expense-amount" type="number" min="1">
      </div>
    </div>
    <div>
      <label for="expense-description">說明 *</label>
      <textarea id="expense-description" placeholder="請詳細填寫用途"></textarea>
    </div>
    <div class="actions">
      <button class="btn" id="btn-submit-expense"><span class="text">提交支出申請</span></button>
    </div>
  </div>
  <div class="card">
    <h3>🗂 我的支出申請</h3>
    <div id="my-expense-list"></div>
  </div>
</div>

<div class="panel" id="panel-feedback">
  <div class="card">
    <h3>🗣 活動回饋</h3>
    <div class="grid cols-2">
      <div>
        <label for="feedback-activity">活動 *</label>
        <select id="feedback-activity"><option value="">請選擇活動</option></select>
      </div>
      <div>
        <label for="feedback-rating">評分 *</label>
        <select id="feedback-rating">
          <option value="">請選擇</option>
          <option value="5">5 - 非常滿意</option>
          <option value="4">4 - 滿意</option>
          <option value="3">3 - 普通</option>
          <option value="2">2 - 待改進</option>
          <option value="1">1 - 不滿意</option>
        </select>
      </div>
    </div>
    <div>
      <label for="feedback-comment">意見 / 建議</label>
      <textarea id="feedback-comment" placeholder="可描述活動亮點、需改進之處..."></textarea>
    </div>
    <div class="actions">
      <button class="btn" id="btn-submit-feedback"><span class="text">提交回饋</span></button>
    </div>
  </div>
  <div class="card">
    <h3>🗂 我的回饋紀錄</h3>
    <div id="my-feedback-list"></div>
  </div>
</div>

<!-- 管理面板 -->
<div class="panel" id="panel-admin">
  <div class="subtabs" id="admin-subtabs">
    <div class="subtab-btn active" data-subtab="admin-members">會員</div>
    <div class="subtab-btn" data-subtab="admin-activities">活動</div>
    <div class="subtab-btn" data-subtab="admin-expenses">支出審核</div>
    <div class="subtab-btn" data-subtab="admin-finance">財務總覽</div>
    <div class="subtab-btn" data-subtab="admin-board">理監事</div>
  </div>

  <!-- 會員管理 -->
  <div class="admin-subpanel" id="admin-members" style="display:block;">
    <div class="card">
      <h3>👥 會員列表</h3>
      <div class="grid cols-3">
        <div>
          <label for="member-search">關鍵字搜尋</label>
          <input id="member-search" type="text" placeholder="姓名 / LINE 名稱 / ID">
        </div>
        <div>
          <label for="member-filter-type">類別篩選</label>
            <select id="member-filter-type">
              <option value="">全部</option>
              <option value="patient">病友</option>
              <option value="family">家屬</option>
              <option value="volunteer">志工</option>
              <option value="medical">醫護</option>
              <option value="supporter">支持者</option>
            </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn small" id="btn-refresh-members">重新整理</button>
        </div>
      </div>
      <div class="actions" style="margin-top:10px;">
        <button class="btn outline small" id="btn-export-members">匯出 CSV</button>
      </div>
      <div id="member-list" style="margin-top:16px;"></div>
    </div>
  </div>

  <!-- 活動管理 -->
  <div class="admin-subpanel" id="admin-activities" style="display:none;">
    <div class="card">
      <h3>📅 建立活動</h3>
      <div class="grid cols-3">
        <div>
          <label for="admin-activity-name">名稱 *</label>
          <input id="admin-activity-name" type="text">
        </div>
        <div>
          <label for="admin-activity-date">日期 *</label>
          <input id="admin-activity-date" type="datetime-local">
        </div>
        <div>
          <label for="admin-activity-location">地點</label>
          <input id="admin-activity-location" type="text">
        </div>
        <div>
          <label for="admin-activity-max">最大人數</label>
          <input id="admin-activity-max" type="number" min="0">
        </div>
        <div>
          <label for="admin-activity-fee">費用</label>
          <input id="admin-activity-fee" type="number" min="0" value="0">
        </div>
        <div>
          <label for="admin-activity-desc">描述 *</label>
          <textarea id="admin-activity-desc" style="min-height:60px;"></textarea>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btn-create-activity"><span class="text">建立活動</span></button>
      </div>
    </div>
    <div class="card">
      <h3>🗂 活動列表</h3>
      <div id="admin-activity-list"></div>
    </div>
  </div>

  <!-- 支出審核 -->
  <div class="admin-subpanel" id="admin-expenses" style="display:none;">
    <div class="card">
      <h3>🧾 待審核支出</h3>
      <div id="pending-expense-list"></div>
    </div>
  </div>

  <!-- 財務總覽 -->
  <div class="admin-subpanel" id="admin-finance" style="display:none;">
    <div class="card">
      <h3>💹 財務概覽</h3>
      <div id="finance-overview"></div>
    </div>
    <div class="card">
      <h3>📑 交易紀錄</h3>
      <div id="transaction-list"></div>
    </div>
    <div class="card">
      <h3>🗓 產生月報表</h3>
      <div class="inline" style="flex-wrap:wrap;gap:12px;">
        <div>
          <label for="report-year">年份</label>
          <input id="report-year" type="number" min="2023" style="max-width:140px;">
        </div>
        <div>
          <label for="report-month">月份</label>
          <input id="report-month" type="number" min="1" max="12" style="max-width:120px;">
        </div>
        <div style="align-self:flex-end;padding-bottom:4px;">
          <button class="btn small" id="btn-generate-report"><span class="text">產生</span></button>
        </div>
      </div>
      <div id="report-result" style="margin-top:16px;"></div>
    </div>
  </div>

  <!-- 理監事 -->
  <div class="admin-subpanel" id="admin-board" style="display:none;">
    <div class="card">
      <h3>🏛 建立會議</h3>
      <div class="grid cols-3">
        <div>
          <label for="board-meeting-title">標題 *</label>
          <input id="board-meeting-title" type="text">
        </div>
        <div>
          <label for="board-meeting-date">日期 *</label>
          <input id="board-meeting-date" type="datetime-local">
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn small" id="btn-create-board-meeting"><span class="text">建立</span></button>
        </div>
      </div>
    </div>
    <div class="card">
      <h3>🗂 會議列表</h3>
      <div id="board-meeting-list"></div>
    </div>
    <div class="card">
      <h3>🧾 選取會議管理議程 / 決議</h3>
      <div class="inline" style="flex-wrap:wrap;gap:10px;">
        <select id="board-meeting-select"><option value="">選擇會議...</option></select>
        <button class="btn small" id="btn-refresh-agenda"><span class="text">載入議程</span></button>
        <button class="btn small" id="btn-lock-meeting"><span class="text">鎖定/解鎖</span></button>
      </div>
      <div style="margin-top:18px;">
        <h4 style="margin-top:0;">新增議程</h4>
        <div class="grid cols-3">
          <div>
            <label for="agenda-type">類型 *</label>
            <select id="agenda-type">
              <option value="general">一般</option>
              <option value="proposal">提案</option>
              <option value="case">案件</option>
              <option value="motion">臨時動議</option>
            </select>
          </div>
          <div>
            <label for="agenda-title">標題 *</label>
            <input id="agenda-title" type="text">
          </div>
          <div>
            <label for="agenda-presenter">提報人</label>
            <input id="agenda-presenter" type="text">
          </div>
          <div style="grid-column:1/-1;">
            <label for="agenda-desc">說明</label>
            <textarea id="agenda-desc" style="min-height:60px;"></textarea>
          </div>
        </div>
        <div class="actions">
          <button class="btn small" id="btn-add-agenda"><span class="text">新增議程</span></button>
        </div>
      </div>
      <div style="margin-top:24px;">
        <h4>議程清單</h4>
        <div id="agenda-list"></div>
      </div>
      <div style="margin-top:24px;">
        <h4>記錄決議 (請選議程)</h4>
        <div class="grid cols-4">
          <div>
            <label for="decision-agenda-id">議程ID *</label>
            <input id="decision-agenda-id" type="text" placeholder="點選議程自動填入" readonly>
          </div>
          <div>
            <label for="decision-result">結果 *</label>
            <input id="decision-result" type="text" placeholder="例如：通過 / 否決 / 延期">
          </div>
          <div>
            <label for="decision-vote-for">贊成</label>
            <input id="decision-vote-for" type="number" min="0" value="0">
          </div>
          <div>
            <label for="decision-vote-against">反對</label>
            <input id="decision-vote-against" type="number" min="0" value="0">
          </div>
          <div>
            <label for="decision-vote-abstain">棄權</label>
            <input id="decision-vote-abstain" type="number" min="0" value="0">
          </div>
          <div style="grid-column:1/-1;">
            <label for="decision-notes">備註</label>
            <textarea id="decision-notes" style="min-height:60px;"></textarea>
          </div>
        </div>
        <div class="actions">
          <button class="btn small" id="btn-record-decision"><span class="text">記錄決議</span></button>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  Parkinson Association System v2.4 · Powered by Google Apps Script & LIFF
</footer>

<!-- 通知 -->
<div class="notification" id="notification">
  <div id="notification-text">訊息</div>
  <button id="notification-close" aria-label="關閉通知">×</button>
</div>

<script>
/* ===================== 前端設定 ===================== */
const APP = {
  LIFF_ID: '1656516134-VaGgmaPm',
  API_URL: 'https://script.google.com/macros/s/AKfycbyCexHu1MtWzi2pZS9SknKh_ZnCWJmuWKdTTqwQcySB8NEcUKdafRggXUONzwppLTZN3Q/exec',   // 例如：https://script.google.com/macros/s/XXXX/exec
  API_KEY: 'AAbb8520258185202581',
  PAGE_SIZE_ACTIVITIES: 6
};

let STATE = {
  lineId: '',
  lineName: '',
  isAdmin: false,
  activities: [],
  myRegistrations: [],
  donations: [],
  expenses: [],
  myFeedback: [],
  currentActivitiesPage: 1,
  filteredActivities: [],
  meetings: [],
  agenda: [],
  meetingLockedMap: {}
};

function showNotification(msg, type='info', timeout=3200){
  const box = document.getElementById('notification');
  box.className = 'notification ' + (type==='error'?'error': type==='success'?'success': type==='warn'?'warn':'');
  document.getElementById('notification-text').textContent = msg;
  requestAnimationFrame(()=> box.classList.add('show'));
  if (timeout){
    setTimeout(()=> box.classList.remove('show'), timeout);
  }
}

document.getElementById('notification-close').addEventListener('click',()=>{
  document.getElementById('notification').classList.remove('show');
});

async function api(action, payload={}){
  const body = Object.assign({}, payload, {
    action,
    apiKey: APP.API_KEY
  });
  try{
    const res = await fetch(APP.API_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    const json = await res.json();
    if (!json.success){
      throw new Error(json.message || '操作失敗');
    }
    return json.data;
  }catch(e){
    showNotification(e.message || '連線錯誤','error');
    throw e;
  }
}

function qs(id){ return document.getElementById(id); }
function fmtDate(d){
  if(!d) return '';
  try {
    const dt = new Date(d);
    if (isNaN(dt.getTime())) return d;
    return dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0') + '-' + String(dt.getDate()).padStart(2,'0')
      + ' ' + String(dt.getHours()).padStart(2,'0') + ':' + String(dt.getMinutes()).padStart(2,'0');
  }catch(_){ return d; }
}

/* ===================== 初始化 LIFF ===================== */
async function init(){
  try{
    if (typeof liff !== 'undefined'){
      await liff.init({ liffId: APP.LIFF_ID });
      if (!liff.isLoggedIn()){
        liff.login();
        return;
      }
      const profile = await liff.getProfile();
      STATE.lineId = profile.userId;
      STATE.lineName = profile.displayName;
    }else{
      // 非 LIFF 測試模式
      STATE.lineId = 'TEST_LINE_ID';
      STATE.lineName = '測試用戶';
    }
    await ensureUser();
    await loadAllInitial();
    bindEvents();
  }catch(e){
    console.error(e);
    showNotification('初始化失敗：' + e.message,'error',6000);
  }
}

async function ensureUser(){
  await api('createUserIfNotExist',{ lineId: STATE.lineId, lineName: STATE.lineName });
  const info = await api('getUserInfo',{ lineId: STATE.lineId });
  renderUserInfo(info);
  STATE.isAdmin = !!info.isAdmin;
  if (STATE.isAdmin){
    document.querySelectorAll('.admin-only').forEach(el=> el.classList.remove('hidden'));
    const adminTab = document.querySelector('.tab-btn[data-tab="admin"]');
    if (adminTab) adminTab.classList.remove('hidden');
  }
}

function renderUserInfo(u){
  const box = qs('user-details');
  box.innerHTML = `
    <div style="font-size:1rem;font-weight:600;">${u.realName || '(未填姓名)'} <span class="badge ${u.status==='已註冊'?'green':'orange'}">${u.status||''}</span></div>
    <div style="margin-top:6px;font-size:.85rem;color:var(--text-light);">LINE：${u.lineName||''} (${u.lineId})</div>
    <div style="margin-top:6px;font-size:.8rem;">
      會員類別：${u.memberType||'-'}　
      最近互動：${fmtDate(u.lastActive)}　
      訊息次數：${u.messageCount||0}　
      管理員：${u.isAdmin?'是':'否'}
    </div>
  `;
}

/* ===================== 載入資料 ===================== */
async function loadAllInitial(){
  await Promise.allSettled([
    loadActivities(),
    loadMyActivities(),
    loadDonations(),
    loadMyExpenses(),
    loadFeedback()
  ]);
  if (STATE.isAdmin){
    await Promise.allSettled([
      loadMembers(),
      loadPendingExpenses(),
      loadFinanceOverview(),
      loadTransactions(),
      loadMeetings()
    ]);
  }
}

/* ===== 活動 ===== */
async function loadActivities(){
  const list = await api('getActivities',{});
  STATE.activities = list || [];
  STATE.filteredActivities = [...STATE.activities];
  renderActivities();
  qs('stat-activity-total').textContent = STATE.activities.length;
  // 填入回饋活動下拉
  const sel = qs('feedback-activity');
  sel.innerHTML = '<option value="">請選擇活動</option>' + STATE.activities.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
}

function renderActivities(){
  const pageSize = APP.PAGE_SIZE_ACTIVITIES;
  const totalPages = Math.max(1, Math.ceil(STATE.filteredActivities.length / pageSize));
  if (STATE.currentActivitiesPage > totalPages) STATE.currentActivitiesPage = totalPages;
  const start = (STATE.currentActivitiesPage - 1)*pageSize;
  const pageData = STATE.filteredActivities.slice(start,start+pageSize);
  const box = qs('activity-list');
  if (!pageData.length){
    box.innerHTML = '<div class="empty"><div class="icon">🗓</div>目前沒有可報名活動</div>';
  }else{
    box.innerHTML = pageData.map(a=>{
      const full = a.maxParticipants && Number(a.currentParticipants) >= Number(a.maxParticipants);
      return `<div class="list-item ${full?'full':''}">
        <h4>${a.name}</h4>
        <div class="meta">
          <span>日期：${fmtDate(a.date)}</span>
          <span>地點：${a.location||'-'}</span>
          <span>費用：${a.fee||0}</span>
          <span>人數：${a.currentParticipants||0}/${a.maxParticipants||'∞'}</span>
        </div>
        <div style="margin-top:8px;font-size:.85rem;color:var(--text-light);">${a.description||''}</div>
        <div class="actions" style="margin-top:10px;">
          <button class="btn small" data-act-register="${a.id}" ${full?'disabled':''}>報名</button>
        </div>
      </div>`;
    }).join('');
  }
  const pag = qs('activity-pagination');
  pag.innerHTML = '';
  for (let i=1;i<=totalPages;i++){
    const btn = document.createElement('button');
    btn.textContent = i;
    if (i===STATE.currentActivitiesPage) btn.classList.add('active');
    btn.addEventListener('click', ()=>{ STATE.currentActivitiesPage=i; renderActivities(); });
    pag.appendChild(btn);
  }
}

async function loadMyActivities(){
  const list = await api('getUserActivities',{ lineId: STATE.lineId });
  STATE.myRegistrations = list||[];
  qs('stat-my-registrations').textContent = STATE.myRegistrations.length;
  renderMyRegistrations();
}
function renderMyRegistrations(){
  const box = qs('my-activity-list');
  if (!STATE.myRegistrations.length){
    box.innerHTML = '<div class="empty"><div class="icon">🧾</div>尚未報名任何活動</div>';
    return;
  }
  box.innerHTML = STATE.myRegistrations.map(r=>`
    <div class="list-item">
      <h4>${r.activityName||'(活動已刪除)'} <span class="badge ${r.status==='已報名'?'green': 'red'}">${r.status}</span></h4>
      <div class="meta">
        <span>日期：${fmtDate(r.date)}</span>
        <span>參加者：${r.participantName}</span>
        <span>報名時間：${fmtDate(r.registerDate)}</span>
      </div>
      ${r.status==='已報名'? `<div class="actions" style="margin-top:8px;">
        <button class="btn danger small" data-act-cancel="${r.id}">取消報名</button>
      </div>`:''}
    </div>
  `).join('');
}

/* ===== 捐款 ===== */
async function loadDonations(){
  const list = await api('getDonations',{ lineId: STATE.lineId });
  STATE.donations = list||[];
  let total=0;
  STATE.donations.forEach(d=> total+= Number(d.amount||0));
  qs('stat-donation-count').textContent = STATE.donations.length;
  qs('stat-donation-total').textContent = total;
  renderDonations();
}
function renderDonations(){
  const box = qs('donation-list');
  if (!STATE.donations.length){
    box.innerHTML = '<div class="empty"><div class="icon">💝</div>尚無捐款紀錄</div>';
    return;
  }
  box.innerHTML = STATE.donations.map(d=>`
    <div class="list-item">
      <h4>${d.donorName||'(匿名)'} <span class="badge green">+${d.amount}</span></h4>
      <div class="meta">
        <span>日期：${fmtDate(d.date)}</span>
      </div>
      <div style="font-size:.8rem;color:var(--text-light);margin-top:6px;">${d.notes||''}</div>
    </div>
  `).join('');
}

/* ===== 支出 ===== */
async function loadMyExpenses(){
  const list = await api('getMyExpenses',{ lineId: STATE.lineId });
  STATE.expenses = list||[];
  renderMyExpenses();
}
function renderMyExpenses(){
  const box = qs('my-expense-list');
  if (!STATE.expenses.length){
    box.innerHTML = '<div class="empty"><div class="icon">💸</div>尚無支出申請</div>';
    return;
  }
  box.innerHTML = STATE.expenses.map(e=>`
    <div class="list-item">
      <h4>${e.category} - ${e.amount} <span class="badge ${e.status==='已核准'?'green': e.status==='已拒絕'?'red':'orange'}">${e.status}</span></h4>
      <div class="meta">
        <span>提交：${fmtDate(e.submitDate)}</span>
        ${e.approvedBy? `<span>審核者：${e.approvedBy}</span>`:''}
        ${e.approvedDate? `<span>審核時間：${fmtDate(e.approvedDate)}</span>`:''}
      </div>
      <div style="font-size:.8rem;color:var(--text-light);margin-top:6px;">${e.description||''}</div>
    </div>
  `).join('');
}

/* ===== 回饋 ===== */
async function loadFeedback(){
  const list = await api('getMyFeedback',{ lineId: STATE.lineId });
  STATE.myFeedback = list||[];
  renderMyFeedback();
}
function renderMyFeedback(){
  const box = qs('my-feedback-list');
  if (!STATE.myFeedback.length){
    box.innerHTML = '<div class="empty"><div class="icon">🗣</div>尚未提交回饋</div>';
    return;
  }
  box.innerHTML = STATE.myFeedback.map(f=>`
    <div class="list-item">
      <h4>${f.activityName||'(活動已刪除)'} - 評分 ${f.rating}</h4>
      <div class="meta">
        <span>時間：${fmtDate(f.submitDate)}</span>
      </div>
      <div style="margin-top:6px;font-size:.85rem;color:var(--text-light);">${f.comment||''}</div>
    </div>
  `).join('');
}

/* ===== 會員 (Admin) ===== */
async function loadMembers(){
  const kw = qs('member-search').value.trim();
  const mt = qs('member-filter-type').value;
  const list = await api('getAllMembers',{
    operatorLineId: STATE.lineId,
    searchTerm: kw,
    memberType: mt
  });
  renderMembers(list||[]);
}
function renderMembers(list){
  const box = qs('member-list');
  if (!list.length){
    box.innerHTML = '<div class="empty"><div class="icon">👥</div>沒有符合的會員</div>';
    return;
  }
  box.innerHTML = list.map(m=>`
    <div class="list-item">
      <h4>${m.realName||'(未填)'} ${m.isAdmin?'<span class="badge blue">管理員</span>':''}</h4>
      <div class="meta">
        <span>類別：${m.memberType||'-'}</span>
        <span>狀態：${m.status||'-'}</span>
        <span>訊息：${m.messageCount||0}</span>
        <span>最後：${fmtDate(m.lastActive)}</span>
      </div>
      <div style="font-size:.75rem;color:var(--text-light);margin-top:6px;">
        LINE：${m.lineName} (${m.lineId})<br>
        電話：${m.phone||'-'}　Email：${m.email||'-'}
      </div>
      <div class="actions" style="margin-top:8px;">
        <button class="btn small" data-member-edit="${m.lineId}">編輯</button>
      </div>
    </div>
  `).join('');
}

/* ===== 待審核支出 ===== */
async function loadPendingExpenses(){
  const list = await api('getPendingExpenses',{ operatorLineId: STATE.lineId });
  renderPendingExpenses(list||[]);
}
function renderPendingExpenses(list){
  const box = qs('pending-expense-list');
  if (!list.length){
    box.innerHTML = '<div class="empty"><div class="icon">🧾</div>目前沒有待審核支出</div>';
    return;
  }
  box.innerHTML = list.map(e=>`
    <div class="list-item">
      <h4>${e.category} - ${e.amount}</h4>
      <div class="meta">
        <span>申請人：${e.applicantName||e.lineId}</span>
        <span>提交：${fmtDate(e.submitDate)}</span>
        <span>ID：${e.id}</span>
      </div>
      <div style="font-size:.8rem;color:var(--text-light);margin-top:6px;">${e.description||''}</div>
      <div class="actions" style="margin-top:8px;">
        <button class="btn small" data-exp-approve="${e.id}">核准</button>
        <button class="btn danger small" data-exp-reject="${e.id}">拒絕</button>
      </div>
    </div>
  `).join('');
}

/* ===== 財務 ===== */
async function loadFinanceOverview(){
  const data = await api('getFinanceOverview',{ operatorLineId: STATE.lineId });
  qs('finance-overview').innerHTML = `
    <div class="grid cols-4" style="margin-bottom:14px;">
      <div class="stat"><div class="num">${data.totalIncome}</div><div class="label">總收入</div></div>
      <div class="stat"><div class="num">${data.totalExpense}</div><div class="label">總支出</div></div>
      <div class="stat"><div class="num">${data.balance}</div><div class="label">結餘</div></div>
      <div class="stat"><div class="num">${data.donationCount}</div><div class="label">捐款筆數</div></div>
    </div>
    <h4>支出分類</h4>
    <table>
      <thead><tr><th>分類</th><th>金額</th></tr></thead>
      <tbody>
        ${Object.keys(data.categoryBreakdown||{}).map(k=>`<tr><td>${k}</td><td>${data.categoryBreakdown[k]}</td></tr>`).join('')}
      </tbody>
    </table>
  `;
}
async function loadTransactions(){
  const list = await api('getTransactions',{ operatorLineId: STATE.lineId });
  const box = qs('transaction-list');
  if (!list.length){
    box.innerHTML = '<div class="empty"><div class="icon">📑</div>無交易資料</div>';
    return;
  }
  box.innerHTML = list.map(t=>`
    <div class="list-item">
      <h4>${t.type==='income'?'收入':'支出'} ${t.amount}</h4>
      <div class="meta">
        <span>日期：${fmtDate(t.date)}</span>
        ${t.category?`<span>分類：${t.category}</span>`:''}
        ${t.donorName?`<span>來源：${t.donorName}</span>`:''}
      </div>
      <div style="font-size:.75rem;color:var(--text-light);margin-top:4px;">${t.notes||''}</div>
    </div>
  `).join('');
}

/* ===== 月報表 ===== */
async function generateReport(){
  const y = Number(qs('report-year').value);
  const m = Number(qs('report-month').value);
  if (!y || !m){
    showNotification('請輸入年份與月份','warn');
    return;
  }
  const data = await api('generateReport',{
    operatorLineId: STATE.lineId,
    year: y,
    month: m
  });
  qs('report-result').innerHTML = `
    <div class="notice info">
      期間：${data.period}<br>
      收入：${data.totalIncome}　支出：${data.totalExpense}　結餘：${data.balance}　捐款筆數：${data.donationCount}
    </div>
    <h4>支出分類</h4>
    <ul style="margin:0;padding-left:20px;font-size:.85rem;">
      ${Object.keys(data.categoryBreakdown||{}).map(k=>`<li>${k}：${data.categoryBreakdown[k]}</li>`).join('')}
    </ul>
  `;
}

/* ===== 理監事：會議 & 議程 ===== */
async function loadMeetings(){
  const list = await api('listBoardMeetings',{ operatorLineId: STATE.lineId });
  STATE.meetings = list||[];
  const sel = qs('board-meeting-select');
  sel.innerHTML = '<option value="">選擇會議...</option>' + STATE.meetings.map(m=>`<option value="${m.id}">${m.title} (${fmtDate(m.meetingDate)}) ${m.locked?'[鎖定]':''}</option>`).join('');
  renderMeetingList();
}

function renderMeetingList(){
  const box = qs('board-meeting-list');
  if (!STATE.meetings.length){
    box.innerHTML = '<div class="empty"><div class="icon">🏛</div>尚無會議</div>';
    return;
  }
  box.innerHTML = STATE.meetings.map(m=>`
    <div class="list-item">
      <h4>${m.title} ${m.locked?'<span class="badge red">鎖定</span>':''}</h4>
      <div class="meta">
        <span>日期：${fmtDate(m.meetingDate)}</span>
        <span>狀態：${m.status}</span>
        <span>ID：${m.id}</span>
      </div>
    </div>
  `).join('');
}

async function loadAgenda(){
  const meetingId = qs('board-meeting-select').value;
  if (!meetingId){
    showNotification('請先選擇會議','warn');
    return;
  }
  const list = await api('listAgenda',{ operatorLineId: STATE.lineId, meetingId });
  STATE.agenda = list||[];
  renderAgenda();
}

function renderAgenda(){
  const box = qs('agenda-list');
  if (!STATE.agenda.length){
    box.innerHTML = '<div class="empty"><div class="icon">🗂</div>無議程</div>';
    return;
  }
  box.innerHTML = STATE.agenda.map(a=>`
    <div class="list-item" data-agenda-id="${a.id}" style="cursor:pointer;">
      <h4>${a.order}. ${a.title} <span class="badge ${a.status==='完成'?'green': 'orange'}">${a.status}</span></h4>
      <div class="meta">
        <span>ID：${a.id}</span>
        <span>類型：${a.type}</span>
        <span>提報人：${a.presenter||'-'}</span>
        <span>更新：${fmtDate(a.lastUpdate)}</span>
      </div>
      <div style="font-size:.75rem;color:var(--text-light);margin-top:6px;">${a.description||''}</div>
      ${a.decisionText? `<div style="margin-top:6px;font-size:.75rem;color:var(--text-light);">決議：${a.decisionText}</div>`:''}
      <div class="actions" style="margin-top:6px;">
        <button class="btn small" data-agenda-status='${a.id}' data-status="完成">標記完成</button>
        <button class="btn warn small" data-agenda-status='${a.id}' data-status="討論中">討論中</button>
      </div>
    </div>
  `).join('');
}

/* ===================== 事件綁定 ===================== */
function bindEvents(){

  // Tabs
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tab = btn.dataset.tab;
      document.querySelectorAll('.tab-btn').forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.panel').forEach(p=> p.classList.remove('active'));
      qs('panel-'+tab).classList.add('active');
    });
  });

  // Admin subtabs
  document.querySelectorAll('.subtab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.subtab-btn').forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.admin-subpanel').forEach(p=> p.style.display='none');
      qs(btn.dataset.subtab).style.display='block';
    });
  });

  // 字級 / 對比
  qs('btn-font-up').addEventListener('click',()=>{
    if (document.body.classList.contains('font-xlarge')) return;
    else if (document.body.classList.contains('font-large')) document.body.classList.add('font-xlarge');
    else document.body.classList.add('font-large');
  });
  qs('btn-font-down').addEventListener('click',()=>{
    if (document.body.classList.contains('font-xlarge')) document.body.classList.remove('font-xlarge');
    else if (document.body.classList.contains('font-large')) document.body.classList.remove('font-large');
  });
  qs('btn-contrast').addEventListener('click',()=> document.body.classList.toggle('high-contrast'));
  qs('btn-reload').addEventListener('click',()=> loadAllInitial());

  // 會員註冊
  qs('btn-register').addEventListener('click', async ()=>{
    const realName = qs('realName').value.trim();
    const memberType = qs('memberType').value;
    if (!realName || !memberType){
      showNotification('請填必填欄位','warn');
      return;
    }
    await api('register',{ lineId: STATE.lineId, realName, memberType });
    showNotification('已更新註冊資料','success');
    await ensureUser();
  });
  qs('btn-update-contact').addEventListener('click', async ()=>{
    await api('updateUserContact',{
      targetLineId: STATE.lineId,
      phone: qs('phone').value.trim(),
      email: qs('email').value.trim(),
      address: qs('address').value.trim(),
      birthday: qs('birthday').value
    });
    showNotification('聯絡資訊已更新','success');
    await ensureUser();
  });

  // 活動搜尋
  qs('activity-search').addEventListener('input',()=>{
    const kw = qs('activity-search').value.trim().toLowerCase();
    STATE.filteredActivities = STATE.activities.filter(a=>
      !kw || (a.name||'').toLowerCase().includes(kw) || (a.description||'').toLowerCase().includes(kw)
    );
    STATE.currentActivitiesPage = 1;
    renderActivities();
  });

  // 活動列表事件委派
  qs('activity-list').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act-register]');
    if (btn){
      const id = btn.getAttribute('data-act-register');
      const name = prompt('請輸入參加者姓名', '');
      if (!name) return;
      await api('registerActivity',{ lineId: STATE.lineId, activityId: id, participantName: name });
      showNotification('報名成功','success');
      await loadActivities();
      await loadMyActivities();
    }
  });

  // 我的報名取消
  qs('my-activity-list').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act-cancel]');
    if (btn){
      if (!confirm('確定要取消此報名？')) return;
      const regId = btn.getAttribute('data-act-cancel');
      await api('cancelActivity',{ lineId: STATE.lineId, registrationId: regId });
      showNotification('已取消','success');
      await loadActivities();
      await loadMyActivities();
    }
  });

  // 捐款
  qs('btn-add-donation').addEventListener('click', async ()=>{
    const amount = Number(qs('donation-amount').value);
    if (!amount || amount<=0){
      showNotification('金額需大於 0','warn');
      return;
    }
    await api('addDonation',{
      lineId: STATE.lineId,
      amount,
      donorName: qs('donor-name').value.trim(),
      notes: qs('donation-notes').value.trim()
    });
    qs('donation-amount').value='';
    qs('donor-name').value='';
    qs('donation-notes').value='';
    showNotification('捐款已記錄','success');
    await loadDonations();
  });

  // 支出申請
  qs('btn-submit-expense').addEventListener('click', async ()=>{
    const category = qs('expense-category').value;
    const amount = Number(qs('expense-amount').value);
    const desc = qs('expense-description').value.trim();
    if (!category || !amount || !desc){
      showNotification('請完整填寫支出欄位','warn');
      return;
    }
    await api('submitExpense',{
      lineId: STATE.lineId,
      category,
      amount,
      description: desc
    });
    qs('expense-amount').value='';
    qs('expense-description').value='';
    showNotification('支出申請已提交','success');
    await loadMyExpenses();
    if (STATE.isAdmin) await loadPendingExpenses();
  });

  // 回饋
  qs('btn-submit-feedback').addEventListener('click', async ()=>{
    const activityId = qs('feedback-activity').value;
    const rating = qs('feedback-rating').value;
    const comment = qs('feedback-comment').value.trim();
    if (!activityId || !rating){
      showNotification('請選擇活動並評分','warn');
      return;
    }
    await api('submitFeedback',{ lineId: STATE.lineId, activityId, rating, comment });
    qs('feedback-activity').value='';
    qs('feedback-rating').value='';
    qs('feedback-comment').value='';
    showNotification('回饋已提交','success');
    await loadFeedback();
  });

  /* ===== Admin ===== */

  // 會員搜尋/刷新
  qs('btn-refresh-members').addEventListener('click',()=> loadMembers());
  qs('member-search').addEventListener('keydown', e=>{ if (e.key==='Enter') loadMembers(); });
  qs('member-filter-type').addEventListener('change',()=> loadMembers());
  qs('btn-export-members').addEventListener('click', async ()=>{
    const data = await api('exportMembers',{ operatorLineId: STATE.lineId });
    if (data && data.csv){
      const blob = new Blob([data.csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download='members.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      showNotification('匯出完成','success');
    }
  });

  // 待審核支出核准/拒絕
  qs('pending-expense-list').addEventListener('click', async e=>{
    const approveBtn = e.target.closest('button[data-exp-approve]');
    const rejectBtn = e.target.closest('button[data-exp-reject]');
    if (approveBtn || rejectBtn){
      const id = (approveBtn||rejectBtn).getAttribute(approveBtn?'data-exp-approve':'data-exp-reject');
      const ok = approveBtn ? true : false;
      const notes = prompt('審核備註 (可留空)','');
      await api('approveExpense',{
        operatorLineId: STATE.lineId,
        expenseId: id,
        approved: ok,
        notes
      });
      showNotification('已審核','success');
      await loadPendingExpenses();
      await loadMyExpenses();
      await loadFinanceOverview();
      await loadTransactions();
    }
  });

  // 建立活動
  qs('btn-create-activity').addEventListener('click', async ()=>{
    const name = qs('admin-activity-name').value.trim();
    const date = qs('admin-activity-date').value;
    const desc = qs('admin-activity-desc').value.trim();
    if (!name || !date || !desc){
      showNotification('請完整填寫活動必填欄位','warn');
      return;
    }
    await api('createActivity',{
      operatorLineId: STATE.lineId,
      name,
      description: desc,
      date,
      location: qs('admin-activity-location').value.trim(),
      maxParticipants: qs('admin-activity-max').value || '',
      fee: qs('admin-activity-fee').value || 0
    });
    ['admin-activity-name','admin-activity-date','admin-activity-location','admin-activity-max','admin-activity-fee','admin-activity-desc']
      .forEach(id=> qs(id).value='');
    showNotification('活動建立成功','success');
    await loadActivities();
    await loadAdminActivities();
  });

  // 活動管理列表
  async function loadAdminActivities(){
    const list = await api('getAllActivities',{ operatorLineId: STATE.lineId });
    const box = qs('admin-activity-list');
    if (!list.length){
      box.innerHTML = '<div class="empty"><div class="icon">📅</div>無活動</div>';
      return;
    }
    box.innerHTML = list.map(a=>`
      <div class="list-item">
        <h4>${a.name} <span class="badge ${a.status==='開放報名'?'green':'red'}">${a.status}</span></h4>
        <div class="meta">
          <span>ID：${a.id}</span>
          <span>日期：${fmtDate(a.date)}</span>
          <span>人數：${a.currentParticipants}/${a.maxParticipants||'∞'}</span>
        </div>
        <div style="font-size:.7rem;color:var(--text-light);margin-top:6px;">${a.description||''}</div>
        <div class="actions" style="margin-top:8px;">
          <button class="btn small" data-act-close="${a.id}">${a.status==='開放報名'?'關閉':'開放'}</button>
          <button class="btn warn small" data-act-delete="${a.id}">刪除</button>
          <button class="btn secondary small" data-act-reg-list="${a.id}">報名名單</button>
        </div>
        <div class="registrations" id="reg-${a.id}" style="display:none;margin-top:10px;"></div>
      </div>
    `).join('');
  }
  loadAdminActivities();

  // 活動管理操作
  qs('admin-activity-list').addEventListener('click', async e=>{
    const t = e.target;
    const closeBtn = t.closest('button[data-act-close]');
    const delBtn = t.closest('button[data-act-delete]');
    const regBtn = t.closest('button[data-act-reg-list]');
    if (closeBtn){
      const id = closeBtn.getAttribute('data-act-close');
      const newStatus = closeBtn.textContent==='關閉'?'已結束':'開放報名';
      await api('changeActivityStatus',{ operatorLineId: STATE.lineId, activityId:id, status:newStatus });
      showNotification('狀態已更新','success');
      await loadActivities();
      await loadAdminActivities();
    }else if (delBtn){
      const id = delBtn.getAttribute('data-act-delete');
      if (!confirm('確定刪除此活動？')) return;
      await api('deleteActivity',{ operatorLineId: STATE.lineId, activityId:id });
      showNotification('已刪除','success');
      await loadActivities();
      await loadAdminActivities();
    }else if (regBtn){
      const id = regBtn.getAttribute('data-act-reg-list');
      const box = qs('reg-'+id);
      if (box.style.display==='none'){
        const list = await api('getActivityRegistrations',{ operatorLineId: STATE.lineId, activityId:id });
        if (!list.length){
          box.innerHTML = '<div class="empty" style="padding:20px;">無報名</div>';
        }else{
          box.innerHTML = list.map(r=>`
            <div style="font-size:.75rem;padding:6px 0;border-bottom:1px solid #e2e8f0;">
              <b>${r.participantName}</b> (${r.lineId})　${fmtDate(r.registerDate)}　<span class="badge ${r.status==='已報名'?'green':'red'}">${r.status}</span>
            </div>
          `).join('');
        }
        box.style.display='block';
      }else{
        box.style.display='none';
      }
    }
  });

  // 產生報表
  qs('btn-generate-report').addEventListener('click', generateReport);

  // 理監事：建立會議
  qs('btn-create-board-meeting').addEventListener('click', async ()=>{
    const title = qs('board-meeting-title').value.trim();
    const date = qs('board-meeting-date').value;
    if (!title || !date){
      showNotification('請填標題與日期','warn');
      return;
    }
    await api('createBoardMeeting',{ operatorLineId: STATE.lineId, title, meetingDate: date });
    qs('board-meeting-title').value='';
    qs('board-meeting-date').value='';
    showNotification('會議已建立','success');
    await loadMeetings();
  });

  // 載入議程
  qs('btn-refresh-agenda').addEventListener('click', loadAgenda);

  // 鎖定/解鎖會議
  qs('btn-lock-meeting').addEventListener('click', async ()=>{
    const meetingId = qs('board-meeting-select').value;
    if (!meetingId){ showNotification('請先選擇會議','warn'); return; }
    // 先查列表找當前鎖定狀態
    const meeting = STATE.meetings.find(m=> m.id===meetingId);
    const newState = !(meeting && meeting.locked);
    await api('lockBoardMeeting',{ operatorLineId: STATE.lineId, meetingId, locked: newState });
    showNotification(newState?'已鎖定':'已解鎖','success');
    await loadMeetings();
    await loadAgenda();
  });

  // 新增議程
  qs('btn-add-agenda').addEventListener('click', async ()=>{
    const meetingId = qs('board-meeting-select').value;
    if (!meetingId){ showNotification('請先選擇會議','warn'); return; }
    const type = qs('agenda-type').value;
    const title = qs('agenda-title').value.trim();
    const presenter = qs('agenda-presenter').value.trim();
    const desc = qs('agenda-desc').value.trim();
    if (!type || !title){
      showNotification('請填寫議程必填欄位','warn');
      return;
    }
    await api('addAgendaItem',{
      operatorLineId: STATE.lineId,
      meetingId,
      type,
      title,
      presenter,
      description: desc
    });
    ['agenda-title','agenda-presenter','agenda-desc'].forEach(id=> qs(id).value='');
    showNotification('議程已新增','success');
    await loadAgenda();
  });

  // 議程狀態更新 / 點選填入決議議程ID
  qs('agenda-list').addEventListener('click', async e=>{
    const statusBtn = e.target.closest('button[data-agenda-status]');
    const item = e.target.closest('.list-item[data-agenda-id]');
    if (statusBtn){
      const id = statusBtn.getAttribute('data-agenda-status');
      const status = statusBtn.getAttribute('data-status');
      await api('updateAgendaStatus',{ operatorLineId: STATE.lineId, agendaId: id, status });
      showNotification('狀態已更新','success');
      await loadAgenda();
    }else if (item){
      const id = item.getAttribute('data-agenda-id');
      qs('decision-agenda-id').value = id;
      showNotification('已填入議程 ID','info',1800);
    }
  });

  // 記錄決議
  qs('btn-record-decision').addEventListener('click', async ()=>{
    const meetingId = qs('board-meeting-select').value;
    const agendaId = qs('decision-agenda-id').value;
    const result = qs('decision-result').value.trim();
    if (!meetingId || !agendaId || !result){
      showNotification('請先選擇會議 / 議程並輸入結果','warn');
      return;
    }
    await api('recordDecision',{
      operatorLineId: STATE.lineId,
      meetingId,
      agendaId,
      result,
      voteFor: Number(qs('decision-vote-for').value)||0,
      voteAgainst: Number(qs('decision-vote-against').value)||0,
      voteAbstain: Number(qs('decision-vote-abstain').value)||0,
      notes: qs('decision-notes').value.trim()
    });
    ['decision-agenda-id','decision-result','decision-notes','decision-vote-for','decision-vote-against','decision-vote-abstain']
      .forEach(id=> qs(id).value = id.includes('vote') ? '0' : '');
    showNotification('決議已記錄','success');
    await loadAgenda();
  });

}

/* ===================== 啟動 ===================== */
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
