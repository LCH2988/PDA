<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>帕金森病友會 LIFF 前端</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root {
      --bg:#f7f9fb;
      --pri:#2563eb;
      --pri-hover:#1d4ed8;
      --danger:#dc2626;
      --ok:#16a34a;
      --border:#d1d9e0;
      --text:#1f2937;
      --muted:#6b7280;
      --warn:#d97706;
    }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial,sans-serif;
           background:var(--bg); margin:0; color:var(--text); }
    header { background:#fff; border-bottom:1px solid var(--border); padding:12px 16px;
             display:flex; flex-wrap:wrap; align-items:center; gap:12px; }
    header h1 { font-size:18px; margin:0; flex:1; }
    #statusBar { font-size:12px; color:var(--muted); }
    .tabs { display:flex; overflow-x:auto; background:#fff; border-bottom:1px solid var(--border); }
    .tabs button { background:none; border:0; padding:10px 14px; cursor:pointer; font-size:14px;
                   white-space:nowrap; border-bottom:3px solid transparent; }
    .tabs button.active { border-color:var(--pri); color:var(--pri); font-weight:600; }
    main { padding:14px; }
    section { display:none; animation:fade .2s; }
    section.active { display:block; }
    @keyframes fade { from { opacity:0 } to { opacity:1 } }
    h2 { font-size:16px; margin:16px 0 8px; }
    h3 { font-size:15px; margin:14px 0 6px; }
    form { background:#fff; border:1px solid var(--border); border-radius:6px; padding:12px; margin-bottom:16px; }
    input,select,textarea { width:100%; box-sizing:border-box; padding:8px; margin:4px 0 10px;
                            border:1px solid var(--border); border-radius:4px; font-size:14px; }
    textarea { resize:vertical; min-height:80px; }
    button.primary { background:var(--pri); color:#fff; border:0; padding:8px 14px; border-radius:4px; cursor:pointer; }
    button.primary:hover { background:var(--pri-hover); }
    button.outline { background:#fff; border:1px solid var(--pri); color:var(--pri); padding:6px 12px; border-radius:4px; cursor:pointer; }
    button.outline:hover { background:#eff6ff; }
    button.danger { background:var(--danger); color:#fff; border:0; padding:6px 12px; border-radius:4px; cursor:pointer; }
    button.small { font-size:12px; padding:4px 10px; }
    .grid { display:grid; gap:12px; }
    .list-card { background:#fff; border:1px solid var(--border); padding:10px 12px; border-radius:6px; margin-bottom:10px; }
    .muted { color:var(--muted); font-size:12px; }
    .badge { display:inline-block; font-size:11px; padding:2px 6px; background:#e5e7eb; border-radius:4px; margin-right:4px; }
    .badge.green { background:#dcfce7; color:#166534; }
    .badge.red { background:#fee2e2; color:#991b1b; }
    .badge.blue { background:#dbeafe; color:#1e3a8a; }
    .flex { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .right { margin-left:auto; }
    .inline { display:inline-block; }
    .danger-text { color:var(--danger); }
    .warn-text { color:var(--warn); }
    .divider { border-top:1px solid var(--border); margin:16px 0; }
    table { width:100%; border-collapse:collapse; font-size:13px; background:#fff; }
    th,td { border:1px solid var(--border); padding:6px 8px; text-align:left; vertical-align:top; }
    th { background:#f1f5f9; }
    .scroll-x { overflow-x:auto; }
    .hidden { display:none !important; }
    .code-block { background:#0f172a; color:#e2e8f0; padding:10px; border-radius:6px; font-size:12px; overflow:auto; }
    .footer-hint { font-size:11px; color:var(--muted); margin-top:30px; text-align:center; }
  </style>
</head>
<body>
  <header>
    <h1>帕金森病友會 LIFF</h1>
    <div id="userBrief" class="muted">未登入</div>
    <div id="statusBar">初始化中...</div>
  </header>
  <nav class="tabs" id="tabs">
    <button data-tab="tab-user" class="active">會員</button>
    <button data-tab="tab-activity">活動</button>
    <button data-tab="tab-volunteer">志工</button>
    <button data-tab="tab-donate">捐款</button>
    <button data-tab="tab-expense">支出</button>
    <button data-tab="tab-feedback">回饋</button>
    <button data-tab="tab-finance" class="admin-only">財務</button>
    <button data-tab="tab-board" class="admin-only">理監事</button>
    <button data-tab="tab-dev">系統/調試</button>
  </nav>
  <main>
    <!-- 會員 -->
    <section id="tab-user" class="active">
      <h2>會員資料</h2>
      <div id="userInfoBox" class="list-card">載入中...</div>

      <form id="formRegister">
        <h3>註冊 / 更新基本資料</h3>
        <input type="text" id="regRealName" placeholder="真實姓名" required />
          <input type="text" id="regMemberType" placeholder="會員類別 (一般 / 榮譽 等)" required />
        <button class="primary" type="submit">送出</button>
      </form>

      <form id="formContact">
        <h3>聯絡資訊</h3>
        <input type="text" id="contactPhone" placeholder="電話" />
        <input type="email" id="contactEmail" placeholder="Email" />
        <input type="text" id="contactAddress" placeholder="地址" />
        <input type="date" id="contactBirthday" placeholder="生日" />
        <button class="primary" type="submit">更新聯絡資料</button>
      </form>

      <div class="divider"></div>
      <h3>我報名的活動</h3>
      <div id="myActivitiesList">尚無資料</div>

      <div class="divider"></div>
      <button class="outline" id="btnRefreshUser">重新整理</button>
    </section>

    <!-- 活動 -->
    <section id="tab-activity">
      <h2>活動列表</h2>
      <div id="activityList">載入中...</div>
      <div class="divider"></div>
      <h3>管理員：建立活動</h3>
      <form id="formCreateActivity" class="admin-only">
        <input type="text" id="actName" placeholder="活動名稱" required />
        <textarea id="actDesc" placeholder="活動描述" required></textarea>
        <input type="datetime-local" id="actDate" required />
        <input type="text" id="actLocation" placeholder="地點" />
        <input type="number" id="actMax" placeholder="最大人數(可空)" />
        <input type="number" id="actFee" placeholder="費用(預設0)" />
        <button class="primary" type="submit">建立</button>
      </form>
      <div class="admin-only">
        <h3>全部活動 (管理)</h3>
        <div id="allActivitiesList">載入中...</div>
      </div>
    </section>

    <!-- 志工 -->
    <section id="tab-volunteer">
      <h2>志工功能</h2>
      <form id="formVolunteerNeeds" class="admin-only">
        <h3>設定活動志工需求</h3>
        <input type="text" id="vnActivityId" placeholder="活動ID" required />
        <input type="text" id="vnRole" placeholder="志工角色" required />
        <input type="number" id="vnNeeded" placeholder="需求人數" required />
        <input type="text" id="vnSkill" placeholder="專長需求 (可空)" />
        <input type="text" id="vnNotes" placeholder="備註 (可空)" />
        <button class="primary" type="submit">新增 / 更新</button>
      </form>
      <div class="divider"></div>
      <form id="formVolunteerList">
        <h3>查看某活動志工需求</h3>
        <input type="text" id="vlActivityId" placeholder="活動ID" required />
        <button class="outline" type="submit">載入</button>
      </form>
      <div id="volunteerNeedsBox">尚未查詢</div>

      <div class="divider"></div>
      <form id="formVolunteerJoin">
        <h3>加入志工角色</h3>
        <input type="text" id="vjActivityId" placeholder="活動ID" required />
        <input type="text" id="vjRole" placeholder="志工角色" required />
        <button class="primary" type="submit">加入</button>
      </form>

      <div class="divider"></div>
      <h3>我的志工時數</h3>
      <div id="myVolunteerHours">載入中...</div>

      <div class="divider admin-only"></div>
      <form id="formRecordHours" class="admin-only">
        <h3>管理員：記錄志工時數</h3>
        <input type="text" id="rhLineId" placeholder="LINE_ID" required />
        <input type="text" id="rhActivityId" placeholder="活動ID" required />
        <input type="text" id="rhRole" placeholder="角色" required />
        <input type="number" id="rhHours" placeholder="時數" required />
        <input type="date" id="rhDate" />
        <button class="primary" type="submit">記錄</button>
      </form>

      <div class="divider admin-only"></div>
      <form id="formVolunteerLeaderboard" class="admin-only">
        <h3>志工排行榜</h3>
        <input type="number" id="vlbLimit" placeholder="顯示前 N 名 (預設20)" />
        <button class="outline" type="submit">取得</button>
      </form>
      <div id="volunteerLeaderboardBox" class="admin-only"></div>
    </section>

    <!-- 捐款 -->
    <section id="tab-donate">
      <h2>捐款紀錄</h2>
      <div id="donationList">載入中...</div>
      <form id="formDonate">
        <h3>新增捐款</h3>
        <input type="number" id="donAmount" placeholder="金額" required />
        <input type="text" id="donDonor" placeholder="捐款人姓名(可空)" />
        <input type="text" id="donItem" placeholder="捐款項目(可空)" />
        <input type="text" id="donNotes" placeholder="備註(可空)" />
        <button class="primary" type="submit">送出</button>
      </form>
      <div class="admin-only">
        <h3>開立捐款收據</h3>
        <form id="formIssueDonateReceipt">
          <input type="text" id="idrDonationId" placeholder="捐款ID" required />
          <input type="text" id="idrTitle" placeholder="收據標題(可空)" />
          <button class="primary" type="submit">開立收據</button>
        </form>
        <div id="issueDonationResult"></div>
      </div>
    </section>

    <!-- 支出 -->
    <section id="tab-expense">
      <h2>支出申請</h2>
      <form id="formExpense">
        <input type="text" id="expCategory" placeholder="支出類別" required />
        <input type="text" id="expSubject" placeholder="科目代碼(可空)" />
        <input type="number" id="expAmount" placeholder="金額" required />
        <textarea id="expDesc" placeholder="說明" required></textarea>
        <label>附件(可多選): <input type="file" id="expFiles" multiple /></label>
        <button class="primary" type="submit">提交</button>
      </form>
      <div class="divider"></div>
      <h3>我的支出</h3>
      <div id="myExpenses">載入中...</div>

      <div class="divider admin-only"></div>
      <h3>待審核支出 (管理)</h3>
      <div id="pendingExpenses" class="admin-only">載入中...</div>

      <div class="divider admin-only"></div>
      <h3>開立支出憑證</h3>
      <form id="formIssueVoucher" class="admin-only">
        <input type="text" id="ivExpenseId" placeholder="支出ID" required />
        <input type="text" id="ivTitle" placeholder="憑證標題(可空)" />
        <button class="primary" type="submit">開立</button>
      </form>
      <div id="issueExpenseResult" class="admin-only"></div>
    </section>

    <!-- 回饋 -->
    <section id="tab-feedback">
      <h2>活動回饋</h2>
      <form id="formFeedback">
        <input type="text" id="fbActivityId" placeholder="活動ID" required />
        <input type="number" id="fbRating" placeholder="評分 1~5" min="1" max="5" required />
        <textarea id="fbComment" placeholder="意見(可空)"></textarea>
        <button class="primary" type="submit">提交回饋</button>
      </form>
      <h3>我的回饋紀錄</h3>
      <div id="myFeedbackList">載入中...</div>
    </section>

    <!-- 財務（管理員） -->
    <section id="tab-finance">
      <h2>財務總覽</h2>
      <div id="financeOverview">載入中...</div>
      <div class="divider"></div>
      <h3>交易列表</h3>
      <div id="transactionList">載入中...</div>
      <div class="divider"></div>
      <form id="formMonthlyReport">
        <h3>月報表</h3>
        <input type="number" id="mrYear" placeholder="年份" required />
        <input type="number" id="mrMonth" placeholder="月份" required />
        <button class="outline" type="submit">產生</button>
      </form>
      <div id="monthlyReportResult"></div>
    </section>

    <!-- 理監事 (管理員) -->
    <section id="tab-board">
      <h2>理監事會議</h2>
      <form id="formCreateMeeting">
        <h3>建立會議</h3>
        <input type="text" id="bmTitle" placeholder="會議標題" required />
        <input type="datetime-local" id="bmDate" required />
        <button class="primary" type="submit">建立</button>
      </form>
      <h3>會議列表</h3>
      <div id="boardMeetingList">載入中...</div>

      <div class="divider"></div>
      <form id="formAgendaAdd">
        <h3>新增議程</h3>
        <input type="text" id="agMeetingId" placeholder="會議ID" required />
        <input type="text" id="agType" placeholder="類型(一般/proposal/case/motion)" required />
        <input type="text" id="agRefId" placeholder="來源ID(可空)" />
        <input type="text" id="agTitle" placeholder="標題" required />
        <textarea id="agDesc" placeholder="說明"></textarea>
        <input type="text" id="agPresenter" placeholder="提報人(可空)" />
        <button class="primary" type="submit">新增</button>
      </form>
      <form id="formAgendaList">
        <h3>列出議程</h3>
        <input type="text" id="aglMeetingId" placeholder="會議ID" required />
        <button class="outline" type="submit">查詢</button>
      </form>
      <div id="agendaListBox"></div>

      <div class="divider"></div>
      <form id="formDecision">
        <h3>記錄決議</h3>
        <input type="text" id="decMeetingId" placeholder="會議ID" required />
        <input type="text" id="decAgendaId" placeholder="議程ID" required />
        <input type="text" id="decResult" placeholder="決議結果文字" required />
        <input type="number" id="decFor" placeholder="贊成" />
        <input type="number" id="decAgainst" placeholder="反對" />
        <input type="number" id="decAbstain" placeholder="棄權" />
        <input type="text" id="decNotes" placeholder="備註(可空)" />
        <button class="primary" type="submit">記錄</button>
      </form>

      <div class="divider"></div>
      <h3>提案管理</h3>
      <form id="formSubmitProposal">
        <input type="text" id="prTitle" placeholder="提案標題" required />
        <textarea id="prContent" placeholder="提案內容" required></textarea>
        <input type="text" id="prCategory" placeholder="分類(可空)" />
        <button class="primary" type="submit">提交提案</button>
      </form>
      <form id="formListProposal">
        <input type="text" id="prStatus" placeholder="狀態過濾(可空)" />
        <button class="outline" type="submit">載入提案</button>
      </form>
      <div id="proposalList"></div>

      <form id="formFirstStageReview">
        <h4>初審</h4>
        <input type="text" id="fsProposalId" placeholder="提案ID" required />
        <select id="fsPass">
          <option value="true">通過</option>
          <option value="false">退回</option>
        </select>
        <input type="text" id="fsComment" placeholder="意見(可空)" />
        <button class="outline" type="submit">初審送出</button>
      </form>

      <form id="formReviewProposal">
        <h4>複審 / 最終審</h4>
        <input type="text" id="rpProposalId" placeholder="提案ID" required />
        <select id="rpApprove">
          <option value="true">通過</option>
          <option value="false">退回</option>
        </select>
        <input type="text" id="rpComment" placeholder="審查意見(可空)" />
        <button class="outline" type="submit">審查送出</button>
      </form>

      <form id="formLinkProposal">
        <h4>提案連結會議</h4>
        <input type="text" id="lpProposalId" placeholder="提案ID" required />
        <input type="text" id="lpMeetingId" placeholder="會議ID" required />
        <button class="outline" type="submit">連結</button>
      </form>

      <div class="divider"></div>
      <h3>案件管理</h3>
      <form id="formSubmitCase">
        <input type="text" id="csTitle" placeholder="案件標題" required />
        <textarea id="csSummary" placeholder="摘要" required></textarea>
        <input type="text" id="csType" placeholder="類型(可空)" />
        <button class="primary" type="submit">提交案件</button>
      </form>
      <form id="formListCases">
        <input type="text" id="csStatus" placeholder="狀態過濾(可空)" />
        <button class="outline" type="submit">載入案件</button>
      </form>
      <div id="caseList"></div>

      <form id="formReviewCase">
        <h4>審查案件</h4>
        <input type="text" id="rcCaseId" placeholder="案件ID" required />
        <select id="rcApprove">
          <option value="true">通過</option>
          <option value="false">退回</option>
        </select>
        <input type="text" id="rcDecision" placeholder="決定(可空)" />
        <input type="text" id="rcComment" placeholder="意見(可空)" />
        <button class="outline" type="submit">審查送出</button>
      </form>

      <form id="formLinkCase">
        <h4>案件連結會議</h4>
        <input type="text" id="lcCaseId" placeholder="案件ID" required />
        <input type="text" id="lcMeetingId" placeholder="會議ID" required />
        <button class="outline" type="submit">連結</button>
      </form>

      <div class="divider"></div>
      <h3>臨時動議</h3>
      <form id="formSubmitMotion">
        <input type="text" id="moMeetingId" placeholder="會議ID" required />
        <input type="text" id="moTitle" placeholder="動議標題" required />
        <input type="text" id="moReason" placeholder="理由(可空)" />
        <button class="primary" type="submit">提出動議</button>
      </form>
      <form id="formListMotions">
        <input type="text" id="moFilterMeeting" placeholder="會議ID(可空)" />
        <input type="text" id="moFilterStatus" placeholder="狀態(可空)" />
        <button class="outline" type="submit">載入動議</button>
      </form>
      <div id="motionList"></div>

      <form id="formDecideMotion">
        <h4>決議動議</h4>
        <input type="text" id="dmMotionId" placeholder="動議ID" required />
        <input type="text" id="dmDecision" placeholder="決議文字" required />
        <button class="outline" type="submit">決議</button>
      </form>
    </section>

    <!-- 系統 / 調試 -->
    <section id="tab-dev">
      <h2>系統 / 調試</h2>
      <p>顯示目前 API Key 使用、lineId、是否管理員等資訊。</p>
      <div id="debugInfo" class="code-block"></div>
      <div class="divider"></div>
      <h3>重新載入全部資料</h3>
      <button class="outline" id="btnReloadAll">Reload All</button>
      <div class="divider"></div>
      <h3>系統統計 (Admin)</h3>
      <div id="systemStatsBox" class="admin-only">尚未載入</div>
    </section>
  </main>

  <div class="footer-hint">
    前端僅示範用途。請避免將固定 API Key 長期暴露於前端，建議採用短期授權 / 簽章機制。
  </div>

  <script>
    /***********************
     * 可調整設定
     ***********************/
    const APP_CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',
      API_ENDPOINT: 'https://script.google.com/macros/s/AKfycbzxu__u2vavKmjUA_XGenmv61zCcRgAUPo0iVgT4gac8AHI0LdZHRKZ7CgqZLC_urdXLw/exec', // 例如 https://script.google.com/macros/s/XXXX/exec
      API_KEY: 'AAbb8520258185202581',
      ENABLE_DEBUG: true
    };

    /***********************
     * 全域狀態
     ***********************/
    const state = {
      lineId: '',
      lineName: '',
      userProfile: null,
      isAdmin: false,
      userInfo: null
    };

    /***********************
     * 工具函式
     ***********************/
    function qs(sel){ return document.querySelector(sel); }
    function ce(tag, cls){ const el=document.createElement(tag); if(cls) el.className=cls; return el; }
    function setStatus(msg){ qs('#statusBar').textContent = msg; }
    function showToast(msg){
      setStatus(msg);
      if(APP_CONFIG.ENABLE_DEBUG) console.log('[TOAST]', msg);
    }
    function errAlert(e){
      console.error(e);
      alert(typeof e === 'string' ? e : (e.message || '發生錯誤'));
    }
    async function postAction(action, payload={}){
      const body = Object.assign({}, payload, {
        action,
        apiKey: APP_CONFIG.API_KEY,
      });
      // 大多數需要 lineId
      if(!body.lineId && state.lineId) body.lineId = state.lineId;
      try{
        const res = await fetch(APP_CONFIG.API_ENDPOINT, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        const json = await res.json();
          if(!json.success){
            throw new Error(json.message || 'Request failed');
        }
        return json;
      }catch(e){
        throw e;
      }
    }
    function formatDate(d){
      if(!d) return '';
      try{
        const dt = new Date(d);
        if(isNaN(dt.getTime())) return d;
        return dt.toLocaleString('zh-TW',{hour12:false});
      }catch(_){ return d; }
    }
    async function fileListToBase64(files){
      const out=[];
      for(const f of files){
        const b64 = await new Promise((res,rej)=>{
          const reader = new FileReader();
          reader.onload = ()=> res(reader.result.split(',')[1]);
          reader.onerror = rej;
          reader.readAsDataURL(f);
        });
        out.push({
          fileName: f.name,
          mimeType: f.type,
          base64: b64
        });
      }
      return out;
    }
    function toggleAdminUI(){
      document.querySelectorAll('.admin-only').forEach(el=>{
        el.classList.toggle('hidden', !state.isAdmin);
      });
    }

    /***********************
     * 初始化 LIFF
     ***********************/
    async function initLIFF(){
      if(!APP_CONFIG.LIFF_ID || APP_CONFIG.LIFF_ID.startsWith('請填入')){
        alert('請先設定 APP_CONFIG.LIFF_ID');
        return;
      }
      await liff.init({ liffId: APP_CONFIG.LIFF_ID });
      if(!liff.isLoggedIn()){
        liff.login();
        return;
      }
      const profile = await liff.getProfile();
      state.userProfile = profile;
      state.lineId = profile.userId;
      state.lineName = profile.displayName;
      qs('#userBrief').textContent = profile.displayName;
      setStatus('取得 LIFF Profile 完成');
      await ensureUser();
      await loadAllBasic();
    }

    /***********************
     * 會員 / 基本
     ***********************/
    async function ensureUser(){
      try{
        await postAction('createUserIfNotExist',{ lineId: state.lineId, lineName: state.lineName });
        await refreshUserInfo();
      }catch(e){ errAlert(e); }
    }
    async function refreshUserInfo(){
      try{
        const r = await postAction('getUserInfo',{ lineId: state.lineId });
        state.userInfo = r.data;
        state.isAdmin = !!r.data.isAdmin;
        toggleAdminUI();
        qs('#userInfoBox').innerHTML = `
          <div><strong>LINE名稱:</strong> ${r.data.lineName || ''}</div>
          <div><strong>真實姓名:</strong> ${r.data.realName || ''}</div>
          <div><strong>會員類別:</strong> ${r.data.memberType || ''}</div>
          <div><strong>狀態:</strong> ${r.data.status || ''}</div>
          <div><strong>電話:</strong> ${r.data.phone || ''}</div>
          <div><strong>Email:</strong> ${r.data.email || ''}</div>
          <div><strong>地址:</strong> ${r.data.address || ''}</div>
          <div><strong>生日:</strong> ${r.data.birthday || ''}</div>
          <div><strong>互動次數:</strong> ${r.data.messageCount || 0}</div>
          <div><strong>是否管理員:</strong> ${r.data.isAdmin ? '<span class="badge green">Yes</span>' : '<span class="badge red">No</span>'}</div>
        `;
      }catch(e){
        qs('#userInfoBox').textContent = '讀取失敗：' + e.message;
      }
    }
    async function loadMyActivities(){
      try{
        const r = await postAction('getUserActivities',{ lineId: state.lineId });
        if(!r.data.length) {
          qs('#myActivitiesList').textContent = '尚無報名';
          return;
        }
        qs('#myActivitiesList').innerHTML = r.data.map(a=>`
          <div class="list-card">
            <div><strong>${a.activityName||''}</strong></div>
            <div class="muted">${formatDate(a.date)} @ ${a.location||''}</div>
            <div>狀態：${a.status}</div>
            <div>報名ID：${a.id}</div>
            ${a.status==='已報名'? `<button class="danger small" onclick="cancelRegistration('${a.id}')">取消</button>`:''}
          </div>
        `).join('');
      }catch(e){
        qs('#myActivitiesList').textContent='讀取失敗 '+e.message;
      }
    }
    async function cancelRegistration(regId){
      if(!confirm('確定取消？')) return;
      try{
        await postAction('cancelActivity',{ lineId: state.lineId, registrationId: regId });
        showToast('已取消');
        await loadMyActivities();
        await loadActivities(); // 更新人數
      }catch(e){ errAlert(e); }
    }

    /***********************
     * 活動
     ***********************/
    async function loadActivities(){
      try{
        const r=await postAction('getActivities',{});
        if(!r.data.length){
          qs('#activityList').textContent='目前無開放活動';
        }else{
          qs('#activityList').innerHTML = r.data.map(a=>{
            return `<div class="list-card">
              <div class="flex">
                <strong>${a.name}</strong>
                <span class="badge blue">${a.status}</span>
                ${a.volunteerEnabled?'<span class="badge green">志工</span>':''}
              </div>
              <div>${a.description||''}</div>
              <div class="muted">${formatDate(a.date)} @ ${a.location||''}</div>
              <div>人數：${a.currentParticipants||0} / ${a.maxParticipants||'不限'}</div>
              <div>費用：${a.fee||0}</div>
              <button class="small outline" onclick="registerActivity('${a.id}','${a.name.replace(/'/g,'')}')">報名</button>
            </div>`;
          }).join('');
        }
      }catch(e){
        qs('#activityList').textContent='讀取失敗 '+e.message;
      }
    }
    async function registerActivity(actId, name){
      const participantName = state.userInfo?.realName || state.lineName || '我';
      if(!confirm('報名活動：'+name+' ?')) return;
      try{
        await postAction('registerActivity',{ activityId: actId, lineId: state.lineId, participantName });
        showToast('報名成功');
        await loadActivities();
        await loadMyActivities();
      }catch(e){ errAlert(e); }
    }
    async function loadAllActivitiesAdmin(){
      if(!state.isAdmin){
        qs('#allActivitiesList').textContent='(非管理員)';
        return;
      }
      try{
        const r=await postAction('getAllActivities',{ operatorLineId: state.lineId });
        qs('#allActivitiesList').innerHTML = r.data.map(a=>`
          <div class="list-card">
            <div class="flex">
              <strong>${a.name}</strong>
              <span class="badge">${a.status}</span>
              ${a.volunteerEnabled?'<span class="badge green">志工</span>':''}
            </div>
            <div class="muted">${a.id}</div>
            <div>${formatDate(a.date)} @ ${a.location||''}</div>
            <div>人數 ${a.currentParticipants}/${a.maxParticipants||'不限'} 費用 ${a.fee}</div>
            <div class="flex">
              <button class="small outline" onclick="changeActivityStatus('${a.id}','開放報名')">開放</button>
              <button class="small outline" onclick="changeActivityStatus('${a.id}','已結束')">結束</button>
              <button class="small outline" onclick="enableVolunteer('${a.id}', ${!a.volunteerEnabled})">${a.volunteerEnabled?'關閉志工':'啟用志工'}</button>
              <button class="small danger" onclick="deleteActivity('${a.id}')">刪除</button>
            </div>
          </div>
        `).join('');
      }catch(e){
        qs('#allActivitiesList').textContent='讀取失敗 '+e.message;
      }
    }
    async function changeActivityStatus(id,status){
      try{
        await postAction('changeActivityStatus',{ operatorLineId: state.lineId, activityId:id, status });
        showToast('已更新');
        await loadAllActivitiesAdmin();
        await loadActivities();
      }catch(e){errAlert(e);}
    }
    async function enableVolunteer(id, enabled){
      try{
        await postAction('enableActivityVolunteer',{ operatorLineId: state.lineId, activityId:id, enabled });
        showToast('志工功能已更新');
        await loadAllActivitiesAdmin();
        await loadActivities();
      }catch(e){errAlert(e);}
    }
    async function deleteActivity(id){
      if(!confirm('確定刪除?')) return;
      try{
        await postAction('deleteActivity',{ operatorLineId: state.lineId, activityId:id });
        showToast('已刪除');
        await loadAllActivitiesAdmin();
        await loadActivities();
      }catch(e){errAlert(e);}
    }

    /***********************
     * 志工
     ***********************/
    async function listVolunteerNeeds(actId){
      try{
        const r=await postAction('listActivityVolunteerNeeds',{ activityId:actId });
        if(!r.data.length){
          qs('#volunteerNeedsBox').textContent='無需求';
          return;
        }
        qs('#volunteerNeedsBox').innerHTML = r.data.map(v=>`
          <div class="list-card">
            <strong>${v.role}</strong>
            <div>需求 ${v.current}/${v.needed}</div>
            <div>專長: ${v.specialSkill||'-'}</div>
            <div>備註: ${v.notes||'-'}</div>
          </div>
        `).join('');
      }catch(e){ qs('#volunteerNeedsBox').textContent='讀取失敗 '+e.message; }
    }
    async function loadMyVolunteerHours(){
      try{
        const r=await postAction('listVolunteerHours',{ lineId:state.lineId });
        if(!r.data.length){
          qs('#myVolunteerHours').textContent='尚無時數';
          return;
        }
        let total = 0;
        qs('#myVolunteerHours').innerHTML = r.data.map(h=>{
          total += Number(h.hours||0);
          return `<div class="list-card">
            活動:${h.activityId} 角色:${h.role} 時數:${h.hours} 日期:${formatDate(h.date)}
          </div>`;
        }).join('') + `<div><strong>合計時數：${total}</strong></div>`;
      }catch(e){ qs('#myVolunteerHours').textContent='讀取失敗 '+e.message; }
    }
    async function volunteerLeaderboard(limit){
      try{
        const r=await postAction('volunteerLeaderboard',{ operatorLineId: state.lineId, limit });
        qs('#volunteerLeaderboardBox').innerHTML = r.data.map((v,i)=>`
          <div>${i+1}. ${v.lineId} - ${v.totalHours} 小時</div>
        `).join('');
      }catch(e){ qs('#volunteerLeaderboardBox').textContent='失敗 '+e.message; }
    }

    /***********************
     * 捐款
     ***********************/
    async function loadDonations(){
      try{
        const r=await postAction('getDonations',{ lineId:state.lineId });
        if(!r.data.length){
          qs('#donationList').textContent='尚無捐款紀錄';
          return;
        }
        qs('#donationList').innerHTML = r.data.map(d=>`
          <div class="list-card">
            <div>金額: ${d.amount}</div>
            <div>項目: ${d.item||''}</div>
            <div>日期: ${formatDate(d.date)}</div>
            <div>收據ID: ${d.receiptId||'-'}</div>
          </div>
        `).join('');
      }catch(e){ qs('#donationList').textContent='讀取失敗 '+e.message; }
    }

    /***********************
     * 支出
     ***********************/
    async function loadMyExpenses(){
      try{
        const r=await postAction('getMyExpenses',{ lineId:state.lineId });
        if(!r.data.length){ qs('#myExpenses').textContent='尚無支出'; return; }
        qs('#myExpenses').innerHTML = r.data.map(e=>`
          <div class="list-card">
            <div><strong>${e.category}</strong> 金額:${e.amount}</div>
            <div>狀態:${e.status} 申請:${formatDate(e.submitDate)}</div>
            <div>科目:${e.subjectCode||'-'} 核准者:${e.approvedBy||'-'}</div>
            <div>附件IDs:${e.attachments||'-'}</div>
            <div>憑證ID:${e.voucherId||'-'}</div>
          </div>
        `).join('');
      }catch(e){ qs('#myExpenses').textContent='讀取失敗 '+e.message; }
    }
    async function loadPendingExpenses(){
      if(!state.isAdmin){ qs('#pendingExpenses').textContent='(非管理員)'; return; }
      try{
        const r=await postAction('getPendingExpenses',{ operatorLineId:state.lineId });
        if(!r.data.length){ qs('#pendingExpenses').textContent='無待審核'; return; }
        qs('#pendingExpenses').innerHTML = r.data.map(e=>`
          <div class="list-card">
            <div><strong>${e.category}</strong> 金額:${e.amount}</div>
            <div>申請人:${e.applicantName||e.lineId}</div>
            <div>說明:${e.description}</div>
            <div>日期:${formatDate(e.submitDate)}</div>
            <div class="flex">
              <button class="small outline" onclick="approveExpense('${e.id}',true)">核准</button>
              <button class="small danger" onclick="approveExpense('${e.id}',false)">拒絕</button>
            </div>
          </div>
        `).join('');
      }catch(e){ qs('#pendingExpenses').textContent='讀取失敗 '+e.message; }
    }
    async function approveExpense(id,pass){
      const notes = pass? '': prompt('拒絕原因(可空)','');
      try{
        await postAction('approveExpense',{ operatorLineId:state.lineId, expenseId:id, approved:pass, notes });
        showToast('已處理');
        await loadPendingExpenses();
        await loadMyExpenses();
      }catch(e){ errAlert(e); }
    }

    /***********************
     * 回饋
     ***********************/
    async function loadMyFeedback(){
      try{
        const r=await postAction('getMyFeedback',{ lineId:state.lineId });
        if(!r.data.length){ qs('#myFeedbackList').textContent='尚無回饋'; return; }
        qs('#myFeedbackList').innerHTML=r.data.map(f=>`
          <div class="list-card">
            <div>活動:${f.activityName} (${f.activityId})</div>
            <div>評分:${f.rating}</div>
            <div>意見:${f.comment||''}</div>
            <div class="muted">${formatDate(f.submitDate)}</div>
          </div>
        `).join('');
      }catch(e){ qs('#myFeedbackList').textContent='讀取失敗 '+e.message; }
    }

    /***********************
     * 財務 (管理員)
     ***********************/
    async function loadFinanceOverview(){
      if(!state.isAdmin){
        qs('#financeOverview').textContent='(非管理員)';
        return;
      }
      try{
        const r=await postAction('getFinanceOverview',{ operatorLineId:state.lineId });
        const o=r.data;
        const breakdown = Object.entries(o.categoryBreakdown||{})
          .map(([k,v])=>`${k}: ${v}`).join('<br>') || '-';
        qs('#financeOverview').innerHTML = `
          <div class="list-card">
            <div>總收入: ${o.totalIncome}</div>
            <div>總支出: ${o.totalExpense}</div>
            <div>結餘: <strong>${o.balance}</strong></div>
            <div>捐款筆數: ${o.donationCount}</div>
            <div>支出分類:</div><div>${breakdown}</div>
          </div>
        `;
      }catch(e){ qs('#financeOverview').textContent='失敗 '+e.message; }
    }
    async function loadTransactions(){
      if(!state.isAdmin){ qs('#transactionList').textContent='(非管理員)'; return; }
      try{
        const r=await postAction('getTransactions',{ operatorLineId:state.lineId });
        if(!r.data.length){ qs('#transactionList').textContent='無交易'; return; }
        qs('#transactionList').innerHTML = r.data.map(t=>`
          <div class="list-card">
            <div>${t.type==='income'?'<span class="badge green">收入</span>':'<span class="badge red">支出</span>'} 金額:${t.amount}</div>
            <div>${formatDate(t.date)} 分類:${t.category||''}</div>
            <div>${t.notes||''}</div>
          </div>
        `).join('');
      }catch(e){ qs('#transactionList').textContent='失敗 '+e.message; }
    }

    /***********************
     * 理監事
     ***********************/
    async function loadBoardMeetings(){
      if(!state.isAdmin){ qs('#boardMeetingList').textContent='(非管理員)'; return; }
      try{
        const r=await postAction('listBoardMeetings',{ operatorLineId:state.lineId });
        if(!r.data.length){ qs('#boardMeetingList').textContent='無會議'; return; }
        qs('#boardMeetingList').innerHTML = r.data.map(m=>`
          <div class="list-card">
            <div><strong>${m.title}</strong> (${m.id})</div>
            <div>${formatDate(m.meetingDate)} 狀態:${m.status} 鎖定:${m.locked}</div>
            <div class="flex">
              <button class="small outline" onclick="lockMeeting('${m.id}',${!m.locked})">${m.locked?'解鎖':'鎖定'}</button>
              <button class="small outline" onclick="finalizeMeeting('${m.id}')">終結</button>
            </div>
          </div>
        `).join('');
      }catch(e){ qs('#boardMeetingList').textContent='失敗 '+e.message; }
    }
    async function lockMeeting(id,locked){
      try{
        await postAction('lockBoardMeeting',{ operatorLineId:state.lineId, meetingId:id, locked });
        showToast(locked?'已鎖定':'已解鎖');
        await loadBoardMeetings();
      }catch(e){errAlert(e);}
    }
    async function finalizeMeeting(id){
      if(!confirm('確定終結會議?')) return;
      try{
        await postAction('finalizeBoardMeeting',{ operatorLineId:state.lineId, meetingId:id, finalMinutesText:'(會議結束)' });
        showToast('已終結');
        await loadBoardMeetings();
      }catch(e){errAlert(e);}
    }
    async function listAgenda(meetingId){
      try{
        const r=await postAction('listAgenda',{ operatorLineId:state.lineId, meetingId });
        if(!r.data.length){ qs('#agendaListBox').textContent='無議程'; return; }
        qs('#agendaListBox').innerHTML = r.data.map(a=>`
          <div class="list-card">
            <div>#${a.order} <strong>${a.title}</strong> (${a.id})</div>
            <div>狀態:${a.status}</div>
            <div>決議:${a.decisionText||'-'}</div>
            <div>最後更新:${formatDate(a.lastUpdate)}</div>
          </div>
        `).join('');
      }catch(e){ qs('#agendaListBox').textContent='失敗 '+e.message; }
    }

    async function listProposals(filterStatus){
      if(!state.isAdmin){ qs('#proposalList').textContent='(非管理員)'; return; }
      try{
        const r=await postAction('listProposals',{ operatorLineId:state.lineId, status:filterStatus||'' });
        if(!r.data.length){ qs('#proposalList').textContent='無資料'; return; }
        qs('#proposalList').innerHTML = r.data.map(p=>`
          <div class="list-card">
            <div><strong>${p.title}</strong> (${p.id}) 狀態:${p.status}</div>
            <div>提交:${formatDate(p.submitDate)} 初審:${p.firstStageResult||'-'} / ${p.firstStageReviewer||''}</div>
            <div>複審:${p.reviewer||''} ${formatDate(p.reviewDate)||''}</div>
            <div>內容:${p.content.slice(0,100)}...</div>
            <div>會議:${p.linkedMeetingId||'-'}</div>
          </div>
        `).join('');
      }catch(e){ qs('#proposalList').textContent='失敗 '+e.message; }
    }
    async function listCases(filterStatus){
      if(!state.isAdmin){ qs('#caseList').textContent='(非管理員)'; return; }
      try{
        const r=await postAction('listCases',{ operatorLineId:state.lineId, status:filterStatus||'' });
        if(!r.data.length){ qs('#caseList').textContent='無資料'; return; }
        qs('#caseList').innerHTML=r.data.map(c=>`
          <div class="list-card">
            <div><strong>${c.title}</strong> (${c.id}) 狀態:${c.status}</div>
            <div>提交:${formatDate(c.submitDate)} 類型:${c.type}</div>
            <div>決定:${c.decision||'-'} 會議:${c.linkedMeetingId||'-'}</div>
            <div>摘要:${c.summary.slice(0,80)}...</div>
          </div>`).join('');
      }catch(e){ qs('#caseList').textContent='失敗 '+e.message; }
    }
    async function listMotions(meetingId,status){
      if(!state.isAdmin){ qs('#motionList').textContent='(非管理員)'; return; }
      try{
        const r=await postAction('listMotions',{ operatorLineId:state.lineId, meetingId:meetingId||'', status:status||'' });
        if(!r.data.length){ qs('#motionList').textContent='無動議'; return; }
        qs('#motionList').innerHTML = r.data.map(m=>`
          <div class="list-card">
            <div><strong>${m.title}</strong> (${m.id}) 狀態:${m.status}</div>
            <div>會議:${m.meetingId} 決議:${m.decisionText||'-'}</div>
            <div>理由:${m.reason||''}</div>
          </div>
        `).join('');
      }catch(e){ qs('#motionList').textContent='失敗 '+e.message; }
    }

    /***********************
     * 系統統計
     ***********************/
    async function loadSystemStats(){
      if(!state.isAdmin){ qs('#systemStatsBox').textContent='(非管理員)'; return; }
      try{
        const r=await postAction('getSystemStats',{ operatorLineId:state.lineId });
        const d=r.data;
        qs('#systemStatsBox').innerHTML = `
          <div>會員總數：${d.totalMembers}</div>
          <div>已註冊會員：${d.registeredMembers}</div>
          <div>開放中的活動：${d.activeActivities}</div>
          <div>報名總數：${d.totalRegistrations}</div>
        `;
      }catch(e){ qs('#systemStatsBox').textContent='失敗 '+e.message; }
    }

    /***********************
     * 統合載入
     ***********************/
    async function loadAllBasic(){
      await Promise.all([
        refreshUserInfo(),
        loadActivities(),
        loadMyActivities(),
        loadDonations(),
        loadMyExpenses(),
        loadMyFeedback(),
        loadMyVolunteerHours()
      ]);
      if(state.isAdmin){
        loadAllActivitiesAdmin();
        loadPendingExpenses();
        loadFinanceOverview();
        loadTransactions();
        loadBoardMeetings();
        loadSystemStats();
      }
      refreshDebugInfo();
    }

    function refreshDebugInfo(){
      qs('#debugInfo').textContent = JSON.stringify({
        lineId: state.lineId,
        lineName: state.lineName,
        isAdmin: state.isAdmin,
        apiEndpoint: APP_CONFIG.API_ENDPOINT
      }, null, 2);
    }

    /***********************
     * 事件綁定
     ***********************/
    function bindEvents(){
      // Tabs
      document.querySelectorAll('#tabs button').forEach(btn=>{
        btn.addEventListener('click',()=>{
          document.querySelectorAll('#tabs button').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const tabId=btn.getAttribute('data-tab');
          document.querySelectorAll('main section').forEach(s=> s.classList.remove('active'));
          qs('#'+tabId).classList.add('active');
        });
      });

      // 註冊
      qs('#formRegister').addEventListener('submit', async e=>{
        e.preventDefault();
        try{
          const realName = qs('#regRealName').value.trim();
          const memberType = qs('#regMemberType').value.trim();
          if(!realName||!memberType) return alert('請填寫完整');
          await postAction('register',{ lineId:state.lineId, realName, memberType });
          await refreshUserInfo();
          showToast('已更新註冊資料');
        }catch(err){ errAlert(err); }
      });

      qs('#formContact').addEventListener('submit', async e=>{
        e.preventDefault();
        try{
          await postAction('updateUserContact',{
            targetLineId: state.lineId,
            phone: qs('#contactPhone').value,
            email: qs('#contactEmail').value,
            address: qs('#contactAddress').value,
            birthday: qs('#contactBirthday').value
          });
          showToast('聯絡資訊已更新');
          await refreshUserInfo();
        }catch(err){ errAlert(err); }
      });

      qs('#btnRefreshUser').addEventListener('click', async ()=>{
        await refreshUserInfo();
        await loadMyActivities();
      });

      // 建立活動 (Admin)
      qs('#formCreateActivity').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        try{
          const name=qs('#actName').value.trim();
          const description=qs('#actDesc').value.trim();
          const date=qs('#actDate').value;
          if(!name||!description||!date) return alert('必填未完成');
          await postAction('createActivity',{
            operatorLineId: state.lineId,
            name, description,
            date, location:qs('#actLocation').value,
            maxParticipants: qs('#actMax').value,
            fee: qs('#actFee').value
          });
          showToast('活動已建立');
          e.target.reset();
          await loadActivities();
          await loadAllActivitiesAdmin();
        }catch(err){ errAlert(err); }
      });

      // 志工需求
      qs('#formVolunteerNeeds').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        try{
          await postAction('setActivityVolunteerNeed',{
            operatorLineId: state.lineId,
            activityId: qs('#vnActivityId').value.trim(),
            role: qs('#vnRole').value.trim(),
            needed: qs('#vnNeeded').value,
            specialSkill: qs('#vnSkill').value,
            notes: qs('#vnNotes').value
          });
          showToast('已設定');
        }catch(err){ errAlert(err); }
      });
      // 查志工需求
      qs('#formVolunteerList').addEventListener('submit', async e=>{
        e.preventDefault();
        listVolunteerNeeds(qs('#vlActivityId').value.trim());
      });
      // 加入志工角色
      qs('#formVolunteerJoin').addEventListener('submit', async e=>{
        e.preventDefault();
        try{
          await postAction('volunteerSignUp',{
            lineId: state.lineId,
            activityId: qs('#vjActivityId').value.trim(),
            role: qs('#vjRole').value.trim()
          });
          showToast('志工報名成功');
          await loadMyVolunteerHours();
          listVolunteerNeeds(qs('#vjActivityId').value.trim());
        }catch(err){ errAlert(err); }
      });
      // 記錄時數 (Admin)
      qs('#formRecordHours').addEventListener('submit', async e=>{
        e.preventDefault();
          if(!state.isAdmin) return alert('非管理員');
        try{
          await postAction('recordVolunteerHours',{
            operatorLineId: state.lineId,
            lineId: qs('#rhLineId').value.trim(),
            activityId: qs('#rhActivityId').value.trim(),
            role: qs('#rhRole').value.trim(),
            hours: qs('#rhHours').value,
            date: qs('#rhDate').value
          });
          showToast('時數已記錄');
        }catch(err){ errAlert(err); }
      });
      // 志工排行榜
      qs('#formVolunteerLeaderboard').addEventListener('submit', async e=>{
        e.preventDefault();
        volunteerLeaderboard(qs('#vlbLimit').value);
      });

      // 捐款
      qs('#formDonate').addEventListener('submit', async e=>{
        e.preventDefault();
        try{
          await postAction('addDonation',{
            lineId: state.lineId,
            amount: qs('#donAmount').value,
            donorName: qs('#donDonor').value,
            item: qs('#donItem').value,
            notes: qs('#donNotes').value
          });
          showToast('捐款已記錄');
          await loadDonations();
          e.target.reset();
        }catch(err){ errAlert(err); }
      });
      // 開立捐款收據 (Admin)
      qs('#formIssueDonateReceipt').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        try{
          const r=await postAction('issueDonationReceipt',{
            operatorLineId: state.lineId,
            donationId: qs('#idrDonationId').value.trim(),
            title: qs('#idrTitle').value
          });
          qs('#issueDonationResult').innerHTML = `<div class="list-card">收據ID: ${r.data.receiptId}<br><a target="_blank" href="${r.data.fileUrl}">開啟 PDF</a></div>`;
        }catch(err){ errAlert(err); }
      });

      // 支出提交
      qs('#formExpense').addEventListener('submit', async e=>{
        e.preventDefault();
        try{
          const files = qs('#expFiles').files;
          let attachments = [];
          if(files.length){
            attachments = await fileListToBase64(files);
          }
          await postAction('submitExpense',{
            lineId: state.lineId,
            category: qs('#expCategory').value.trim(),
            subjectCode: qs('#expSubject').value.trim(),
            amount: qs('#expAmount').value,
            description: qs('#expDesc').value,
            attachments
          });
          showToast('支出申請已提交');
          e.target.reset();
          await loadMyExpenses();
        }catch(err){ errAlert(err); }
      });
      // 開立支出憑證
      qs('#formIssueVoucher').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        try{
          const r=await postAction('issueExpenseVoucher',{
            operatorLineId: state.lineId,
            expenseId: qs('#ivExpenseId').value.trim(),
            title: qs('#ivTitle').value
          });
          qs('#issueExpenseResult').innerHTML = `<div class="list-card">憑證ID: ${r.data.voucherId}<br><a target="_blank" href="${r.data.fileUrl}">開啟 PDF</a></div>`;
        }catch(err){ errAlert(err); }
      });

      // 回饋
      qs('#formFeedback').addEventListener('submit', async e=>{
        e.preventDefault();
        try{
          await postAction('submitFeedback',{
            lineId: state.lineId,
            activityId: qs('#fbActivityId').value.trim(),
            rating: qs('#fbRating').value,
            comment: qs('#fbComment').value
          });
          showToast('回饋已提交');
          e.target.reset();
          await loadMyFeedback();
        }catch(err){ errAlert(err); }
      });

      // 月報表
      qs('#formMonthlyReport').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        try{
          const r=await postAction('generateReport',{
            operatorLineId: state.lineId,
            year: qs('#mrYear').value,
            month: qs('#mrMonth').value
          });
          const d=r.data;
          qs('#monthlyReportResult').innerHTML = `
            <div class="list-card">
              <div>${d.period}</div>
              <div>收入:${d.totalIncome} 支出:${d.totalExpense} 結餘:${d.balance}</div>
              <div>捐款筆數:${d.donationCount}</div>
              <pre>${JSON.stringify(d.categoryBreakdown,null,2)}</pre>
            </div>`;
        }catch(err){ errAlert(err); }
      });

      // 會議
      qs('#formCreateMeeting').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        try{
          await postAction('createBoardMeeting',{
            operatorLineId: state.lineId,
            title: qs('#bmTitle').value.trim(),
            meetingDate: qs('#bmDate').value
          });
          showToast('會議建立完成');
          e.target.reset();
          await loadBoardMeetings();
        }catch(err){ errAlert(err); }
      });

      // 新增議程
      qs('#formAgendaAdd').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        try{
          await postAction('addAgendaItem',{
            operatorLineId: state.lineId,
            meetingId: qs('#agMeetingId').value.trim(),
            type: qs('#agType').value.trim(),
            refId: qs('#agRefId').value.trim(),
            title: qs('#agTitle').value.trim(),
            description: qs('#agDesc').value,
            presenter: qs('#agPresenter').value
          });
          showToast('議程已新增');
        }catch(err){ errAlert(err); }
      });
      // 列出議程
      qs('#formAgendaList').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        listAgenda(qs('#aglMeetingId').value.trim());
      });

      // 決議記錄
      qs('#formDecision').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        try{
          await postAction('recordDecision',{
            operatorLineId: state.lineId,
            meetingId: qs('#decMeetingId').value.trim(),
            agendaId: qs('#decAgendaId').value.trim(),
            result: qs('#decResult').value.trim(),
            voteFor: qs('#decFor').value,
            voteAgainst: qs('#decAgainst').value,
            voteAbstain: qs('#decAbstain').value,
            notes: qs('#decNotes').value
          });
          showToast('決議已記錄');
        }catch(err){ errAlert(err); }
      });

      // 提案
      qs('#formSubmitProposal').addEventListener('submit', async e=>{
        e.preventDefault();
        try{
          await postAction('submitProposal',{
            lineId: state.lineId,
            title: qs('#prTitle').value.trim(),
            content: qs('#prContent').value,
            category: qs('#prCategory').value
          });
          showToast('提案已提交');
          await listProposals(qs('#prStatus').value.trim());
        }catch(err){ errAlert(err); }
      });
      qs('#formListProposal').addEventListener('submit', async e=>{
        e.preventDefault();
        listProposals(qs('#prStatus').value.trim());
      });
      // 初審
      qs('#formFirstStageReview').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        try{
          await postAction('firstStageReviewProposal',{
            operatorLineId: state.lineId,
            proposalId: qs('#fsProposalId').value.trim(),
            pass: qs('#fsPass').value==='true',
            comment: qs('#fsComment').value
          });
          showToast('初審完成');
          listProposals(qs('#prStatus').value.trim());
        }catch(err){ errAlert(err); }
      });
      // 複審
      qs('#formReviewProposal').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        try{
          await postAction('reviewProposal',{
            operatorLineId: state.lineId,
            proposalId: qs('#rpProposalId').value.trim(),
            approve: qs('#rpApprove').value==='true',
            comment: qs('#rpComment').value
          });
          showToast('審查完成');
          listProposals(qs('#prStatus').value.trim());
        }catch(err){ errAlert(err); }
      });
      // 連結提案
      qs('#formLinkProposal').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        try{
          await postAction('linkProposalToMeeting',{
            operatorLineId: state.lineId,
            proposalId: qs('#lpProposalId').value.trim(),
            meetingId: qs('#lpMeetingId').value.trim()
          });
          showToast('已連結會議');
          listProposals(qs('#prStatus').value.trim());
        }catch(err){ errAlert(err); }
      });

      // 案件
      qs('#formSubmitCase').addEventListener('submit', async e=>{
        e.preventDefault();
        try{
          await postAction('submitCase',{
            lineId: state.lineId,
            title: qs('#csTitle').value.trim(),
            summary: qs('#csSummary').value,
            type: qs('#csType').value
          });
          showToast('案件已提交');
          listCases(qs('#csStatus').value.trim());
        }catch(err){ errAlert(err); }
      });
      qs('#formListCases').addEventListener('submit', async e=>{
        e.preventDefault();
        listCases(qs('#csStatus').value.trim());
      });
      qs('#formReviewCase').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        try{
          await postAction('reviewCase',{
            operatorLineId: state.lineId,
            caseId: qs('#rcCaseId').value.trim(),
            approve: qs('#rcApprove').value==='true',
            decision: qs('#rcDecision').value,
            comment: qs('#rcComment').value
          });
          showToast('案件審查完成');
          listCases(qs('#csStatus').value.trim());
        }catch(err){ errAlert(err); }
      });
      qs('#formLinkCase').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        try{
          await postAction('linkCaseToMeeting',{
            operatorLineId: state.lineId,
            caseId: qs('#lcCaseId').value.trim(),
            meetingId: qs('#lcMeetingId').value.trim()
          });
          showToast('案件已連結');
          listCases(qs('#csStatus').value.trim());
        }catch(err){ errAlert(err); }
      });

      // 動議
      qs('#formSubmitMotion').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        try{
          await postAction('submitMotion',{
            operatorLineId: state.lineId,
            meetingId: qs('#moMeetingId').value.trim(),
            title: qs('#moTitle').value.trim(),
            reason: qs('#moReason').value
          });
          showToast('動議已提出');
          listMotions(qs('#moFilterMeeting').value.trim(), qs('#moFilterStatus').value.trim());
        }catch(err){ errAlert(err); }
      });
      qs('#formListMotions').addEventListener('submit', async e=>{
        e.preventDefault();
        listMotions(qs('#moFilterMeeting').value.trim(), qs('#moFilterStatus').value.trim());
      });
      qs('#formDecideMotion').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin) return alert('非管理員');
        try{
          await postAction('decideMotion',{
            operatorLineId: state.lineId,
            motionId: qs('#dmMotionId').value.trim(),
            decisionText: qs('#dmDecision').value.trim()
          });
          showToast('動議已決議');
          listMotions(qs('#moFilterMeeting').value.trim(), qs('#moFilterStatus').value.trim());
        }catch(err){ errAlert(err); }
      });

      // Reload All
      qs('#btnReloadAll').addEventListener('click', async ()=>{
        await loadAllBasic();
        showToast('已重新載入');
      });
    }

    /***********************
     * 啟動
     ***********************/
    (async function(){
      bindEvents();
      try{
        await initLIFF();
      }catch(e){
        errAlert(e);
        setStatus('初始化失敗');
      }
    })();
  </script>
</body>
</html>
