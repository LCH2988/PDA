<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>帕金森病友會管理系統</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="theme-color" content="#667eea">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
<style>
:root {
--primary: #4a90e2;
--primary-light: #e3f2fd;
--success: #4caf50;
--warn: #ff9800;
--error: #f44336;
--bg: #f5f7fa;
--card: #ffffff;
--text: #333333;
--text-light: #666666;
--border: #e0e0e0;
--shadow: 0 4px 12px rgba(0,0,0,0.1);
--radius: 20px;
}

* {
box-sizing: border-box;
}

body {
margin: 0;
padding: 0;
background: var(--bg);
color: var(--text);
font-family: 'Microsoft JhengHei', 'PingFang TC', 'Noto Sans TC', sans-serif;
font-size: 18px;
line-height: 1.6;
}

/* 頂部導航 */
.header {
background: linear-gradient(135deg, var(--primary), #667eea);
color: white;
padding: 20px 16px;
text-align: center;
position: sticky;
top: 0;
z-index: 100;
box-shadow: var(--shadow);
}

.header h1 {
margin: 0;
font-size: 24px;
font-weight: 700;
}

.header .subtitle {
margin-top: 8px;
font-size: 16px;
opacity: 0.9;
}

/* 容器 */
.container {
max-width: 480px;
margin: 0 auto;
padding: 16px;
min-height: calc(100vh - 120px);
}

/* 大型按鈕式選單 */
.main-menu {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 16px;
margin: 20px 0;
}

.menu-card {
background: var(--card);
border-radius: var(--radius);
padding: 24px 16px;
text-align: center;
box-shadow: var(--shadow);
cursor: pointer;
transition: all 0.3s ease;
border: 3px solid transparent;
min-height: 120px;
display: flex;
flex-direction: column;
justify-content: center;
}

.menu-card:hover {
transform: translateY(-4px);
box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.menu-card.active {
border-color: var(--primary);
background: var(--primary-light);
}

.menu-card .icon {
font-size: 36px;
margin-bottom: 8px;
display: block;
}

.menu-card .title {
font-size: 18px;
font-weight: 600;
color: var(--text);
}

/* 內容面板 */
.panel {
display: none;
animation: fadeIn 0.4s ease;
}

.panel.active {
display: block;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}

/* 卡片樣式 */
.card {
background: var(--card);
border-radius: var(--radius);
padding: 24px;
margin-bottom: 20px;
box-shadow: var(--shadow);
}

.card-header {
display: flex;
align-items: center;
margin-bottom: 20px;
padding-bottom: 16px;
border-bottom: 2px solid var(--border);
}

.card-header .icon {
font-size: 28px;
margin-right: 12px;
}

.card-header h3 {
margin: 0;
font-size: 20px;
font-weight: 600;
}

/* 表單元素 */
.form-group {
margin-bottom: 20px;
}

.form-label {
display: block;
font-size: 16px;
font-weight: 600;
margin-bottom: 8px;
color: var(--text);
}

.form-label.required::after {
content: " *";
color: var(--error);
}

.form-input, .form-select, .form-textarea {
width: 100%;
padding: 16px;
font-size: 18px;
border: 2px solid var(--border);
border-radius: 12px;
background: white;
transition: all 0.3s ease;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
}

.form-textarea {
min-height: 100px;
resize: vertical;
}

/* 大型按鈕 */
.btn {
background: var(--primary);
color: white;
border: none;
border-radius: 12px;
padding: 16px 24px;
font-size: 18px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 8px;
min-height: 56px;
width: 100%;
margin-bottom: 12px;
}

.btn:hover {
transform: translateY(-2px);
box-shadow: 0 6px 16px rgba(74, 144, 226, 0.3);
}

.btn:active {
transform: translateY(0);
}

.btn.btn-success {
background: var(--success);
}

.btn.btn-warning {
background: var(--warn);
}

.btn.btn-danger {
background: var(--error);
}

.btn.btn-outline {
background: white;
color: var(--primary);
border: 2px solid var(--primary);
}

.btn.btn-outline:hover {
background: var(--primary);
color: white;
}

.btn:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none;
}

/* 統計卡片 */
.stats-grid {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 16px;
margin-bottom: 24px;
}

.stat-card {
background: white;
border-radius: var(--radius);
padding: 20px;
text-align: center;
box-shadow: var(--shadow);
border-left: 5px solid var(--primary);
}

.stat-number {
font-size: 32px;
font-weight: 700;
color: var(--primary);
margin-bottom: 4px;
}

.stat-label {
font-size: 14px;
color: var(--text-light);
font-weight: 500;
}

/* 列表項目 */
.list-item {
background: white;
border-radius: var(--radius);
padding: 20px;
margin-bottom: 16px;
box-shadow: var(--shadow);
border-left: 5px solid var(--primary);
}

.list-item-header {
display: flex;
justify-content: space-between;
align-items: flex-start;
margin-bottom: 12px;
}

.list-item-title {
font-size: 18px;
font-weight: 600;
margin: 0;
}

.list-item-meta {
display: flex;
flex-wrap: wrap;
gap: 12px;
margin-bottom: 12px;
font-size: 14px;
color: var(--text-light);
}

.list-item-meta span {
display: flex;
align-items: center;
gap: 4px;
}

.list-item-content {
font-size: 16px;
line-height: 1.5;
margin-bottom: 16px;
}

.list-item-actions {
display: flex;
gap: 8px;
flex-wrap: wrap;
}

.list-item-actions .btn {
flex: 1;
min-width: 120px;
margin-bottom: 0;
}

/* 徽章 */
.badge {
display: inline-flex;
align-items: center;
padding: 6px 12px;
border-radius: 20px;
font-size: 14px;
font-weight: 600;
background: var(--border);
color: var(--text);
}

.badge.success {
background: rgba(76, 175, 80, 0.1);
color: var(--success);
}

.badge.warning {
background: rgba(255, 152, 0, 0.1);
color: var(--warn);
}

.badge.error {
background: rgba(244, 67, 54, 0.1);
color: var(--error);
}

.badge.primary {
background: rgba(74, 144, 226, 0.1);
color: var(--primary);
}

/* 通知 */
.notification {
position: fixed;
top: 20px;
left: 50%;
transform: translateX(-50%);
background: var(--text);
color: white;
padding: 16px 24px;
border-radius: 12px;
box-shadow: 0 8px 24px rgba(0,0,0,0.3);
z-index: 1000;
font-size: 16px;
max-width: 90%;
opacity: 0;
transition: all 0.3s ease;
}

.notification.show {
opacity: 1;
}

.notification.success {
background: var(--success);
}

.notification.error {
background: var(--error);
}

.notification.warning {
background: var(--warn);
}

/* 空狀態 */
.empty-state {
text-align: center;
padding: 40px 20px;
color: var(--text-light);
}

.empty-state .icon {
font-size: 48px;
margin-bottom: 16px;
opacity: 0.5;
}

.empty-state .message {
font-size: 16px;
}

/* 載入狀態 */
.loading {
text-align: center;
padding: 40px;
color: var(--text-light);
}

.loading::after {
content: '';
display: inline-block;
width: 24px;
height: 24px;
border: 3px solid var(--border);
border-top: 3px solid var(--primary);
border-radius: 50%;
animation: spin 1s linear infinite;
margin-left: 8px;
}

@keyframes spin {
to { transform: rotate(360deg); }
}

/* 分頁 */
.pagination {
display: flex;
justify-content: center;
gap: 8px;
margin: 20px 0;
}

.pagination button {
padding: 12px 16px;
border: 2px solid var(--border);
background: white;
border-radius: 8px;
font-size: 16px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
}

.pagination button.active,
.pagination button:hover {
background: var(--primary);
color: white;
border-color: var(--primary);
}

/* 搜尋框 */
.search-box {
position: relative;
margin-bottom: 20px;
}

.search-box input {
padding-left: 48px;
}

.search-box .search-icon {
position: absolute;
left: 16px;
top: 50%;
transform: translateY(-50%);
font-size: 20px;
color: var(--text-light);
}

/* 回到頂部按鈕 */
.back-to-top {
position: fixed;
bottom: 20px;
right: 20px;
width: 56px;
height: 56px;
background: var(--primary);
color: white;
border: none;
border-radius: 50%;
font-size: 20px;
cursor: pointer;
box-shadow: var(--shadow);
transition: all 0.3s ease;
opacity: 0;
transform: translateY(20px);
}

.back-to-top.show {
opacity: 1;
transform: translateY(0);
}

.back-to-top:hover {
transform: translateY(-4px);
box-shadow: 0 8px 20px rgba(74, 144, 226, 0.4);
}

/* 響應式設計 */
@media (max-width: 360px) {
.container {
  padding: 12px;
}

.main-menu {
  grid-template-columns: 1fr;
}

.stats-grid {
  grid-template-columns: 1fr;
}

.menu-card {
  min-height: 100px;
  padding: 20px 12px;
}

.menu-card .icon {
  font-size: 32px;
}

.card {
  padding: 20px;
}
}

/* 隱藏元素 */
.hidden {
display: none !important;
}

/* 管理員專用樣式 */
.admin-only {
display: none;
}

.admin-only.show {
display: block;
}

/* 表格樣式 */
.table-container {
overflow-x: auto;
margin: 16px 0;
}

.simple-table {
width: 100%;
border-collapse: collapse;
background: white;
border-radius: var(--radius);
overflow: hidden;
box-shadow: var(--shadow);
}

.simple-table th,
.simple-table td {
padding: 16px 12px;
text-align: left;
border-bottom: 1px solid var(--border);
font-size: 16px;
}

.simple-table th {
background: var(--primary-light);
font-weight: 600;
color: var(--text);
}

.simple-table tr:hover td {
background: rgba(74, 144, 226, 0.05);
}

/* 快速操作按鈕 */
.quick-actions {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
gap: 12px;
margin: 20px 0;
}

.quick-action-btn {
background: white;
border: 2px solid var(--border);
border-radius: 12px;
padding: 16px 12px;
text-align: center;
cursor: pointer;
transition: all 0.3s ease;
font-size: 14px;
font-weight: 600;
}

.quick-action-btn:hover {
border-color: var(--primary);
background: var(--primary-light);
}

.quick-action-btn .icon {
font-size: 24px;
margin-bottom: 8px;
display: block;
}
</style>
</head>
<body>

<!-- 頂部導航 -->
<div class="header">
<h1>🏥 帕金森病友會</h1>
<div class="subtitle">管理系統</div>
</div>

<div class="container">
<!-- 使用者資訊卡片 -->
<div id="user-info-card" class="card hidden">
  <div class="card-header">
    <span class="icon">👤</span>
    <h3>個人資訊</h3>
  </div>
  <div id="user-details"></div>
</div>

<!-- 主選單 -->
<div class="main-menu" id="main-menu">
  <div class="menu-card active" data-tab="profile">
    <span class="icon">📝</span>
    <div class="title">個人資料</div>
  </div>
  <div class="menu-card" data-tab="activities">
    <span class="icon">📅</span>
    <div class="title">活動報名</div>
  </div>
  <div class="menu-card" data-tab="donations">
    <span class="icon">💝</span>
    <div class="title">愛心捐款</div>
  </div>
  <div class="menu-card" data-tab="finance">
    <span class="icon">💰</span>
    <div class="title">財務支出</div>
  </div>
  <div class="menu-card" data-tab="feedback">
    <span class="icon">📝</span>
    <div class="title">活動回饋</div>
  </div>
  <div class="menu-card admin-only" data-tab="admin">
    <span class="icon">⚙️</span>
    <div class="title">系統管理</div>
  </div>
</div>

<!-- 個人資料面板 -->
<div class="panel active" id="panel-profile">
  <div class="card">
    <div class="card-header">
      <span class="icon">📝</span>
      <h3>會員註冊</h3>
    </div>
    
    <div class="form-group">
      <label class="form-label required">真實姓名</label>
      <input type="text" class="form-input" id="realName" placeholder="請輸入您的姓名">
    </div>
    
    <div class="form-group">
      <label class="form-label required">會員類別</label>
      <select class="form-select" id="memberType">
        <option value="">請選擇會員類別</option>
        <option value="patient">🏥 病友</option>
        <option value="family">👨‍👩‍👧‍👦 家屬</option>
        <option value="volunteer">🙋‍♀️ 志工</option>
        <option value="medical">👩‍⚕️ 醫護人員</option>
        <option value="supporter">🤝 支持者</option>
      </select>
    </div>
    
    <button class="btn" id="btn-register">
      <span>✅ 註冊 / 更新資料</span>
    </button>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="icon">📞</span>
      <h3>聯絡資訊</h3>
    </div>
    
    <div class="form-group">
      <label class="form-label">電話號碼</label>
      <input type="tel" class="form-input" id="phone" placeholder="例：0912345678">
    </div>
    
    <div class="form-group">
      <label class="form-label">電子郵件</label>
      <input type="email" class="form-input" id="email" placeholder="例：example@email.com">
    </div>
    
    <div class="form-group">
      <label class="form-label">居住地址</label>
      <input type="text" class="form-input" id="address" placeholder="請輸入地址">
    </div>
    
    <div class="form-group">
      <label class="form-label">生日</label>
      <input type="date" class="form-input" id="birthday">
    </div>
    
    <button class="btn btn-success" id="btn-update-contact">
      <span>💾 更新聯絡資訊</span>
    </button>
  </div>
</div>

<!-- 活動面板 -->
<div class="panel" id="panel-activities">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number" id="stat-activity-total">0</div>
      <div class="stat-label">可報名活動</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="stat-my-registrations">0</div>
      <div class="stat-label">我的報名</div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="icon">📅</span>
      <h3>可報名活動</h3>
    </div>
    
    <div class="search-box">
      <input type="text" class="form-input" id="activity-search" placeholder="搜尋活動名稱...">
      <span class="search-icon">🔍</span>
    </div>
    
    <div id="activity-list"></div>
    <div class="pagination" id="activity-pagination"></div>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="icon">📋</span>
      <h3>我的報名記錄</h3>
    </div>
    <div id="my-activity-list"></div>
  </div>
</div>

<!-- 捐款面板 -->
<div class="panel" id="panel-donations">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number" id="stat-donation-count">0</div>
      <div class="stat-label">捐款筆數</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="stat-donation-total">0</div>
      <div class="stat-label">捐款總額</div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="icon">💝</span>
      <h3>愛心捐款</h3>
    </div>
    
    <div class="form-group">
      <label class="form-label required">捐款金額</label>
      <select class="form-select" id="donation-amount-select">
        <option value="">請選擇捐款金額</option>
        <option value="100">💰 100 元</option>
        <option value="300">💰 300 元</option>
        <option value="500">💰 500 元</option>
        <option value="1000">💰 1,000 元</option>
        <option value="2000">💰 2,000 元</option>
        <option value="5000">💰 5,000 元</option>
        <option value="custom">✏️ 其他金額</option>
      </select>
    </div>
    
    <div class="form-group hidden" id="custom-amount-group">
      <label class="form-label">自訂金額</label>
      <input type="number" class="form-input" id="donation-amount" min="1" placeholder="請輸入金額">
    </div>
    
    <div class="form-group">
      <label class="form-label">捐款人姓名</label>
      <input type="text" class="form-input" id="donor-name" placeholder="可留空（匿名捐款）">
    </div>
    
    <div class="form-group">
      <label class="form-label">捐款用途</label>
      <select class="form-select" id="donation-purpose">
        <option value="">請選擇用途（可留空）</option>
        <option value="一般捐款">💝 一般捐款</option>
        <option value="活動經費">🎯 活動經費</option>
        <option value="醫療支援">🏥 醫療支援</option>
        <option value="設備購置">🔧 設備購置</option>
        <option value="急難救助">🆘 急難救助</option>
      </select>
    </div>
    
    <button class="btn" id="btn-add-donation">
      <span>💝 確認捐款</span>
    </button>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="icon">📊</span>
      <h3>我的捐款記錄</h3>
    </div>
    <div id="donation-list"></div>
  </div>
</div>

<!-- 財務面板 -->
<div class="panel" id="panel-finance">
  <div class="card">
    <div class="card-header">
      <span class="icon">💸</span>
      <h3>支出申請</h3>
    </div>
    
    <div class="form-group">
      <label class="form-label required">支出類別</label>
      <select class="form-select" id="expense-category">
        <option value="">請選擇支出類別</option>
        <option value="activity">🎯 活動支出</option>
        <option value="office">🏢 辦公費用</option>
        <option value="marketing">📢 宣傳費用</option>
        <option value="equipment">🔧 設備費用</option>
        <option value="welfare">🎁 福利支出</option>
        <option value="medical">🏥 醫療支援</option>
        <option value="volunteer">🙋‍♀️ 志工費用</option>
        <option value="other">📝 其他支出</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label required">申請金額</label>
      <select class="form-select" id="expense-amount-select">
        <option value="">請選擇金額範圍</option>
        <option value="500">💰 500 元以下</option>
        <option value="1000">💰 1,000 元以下</option>
        <option value="3000">💰 3,000 元以下</option>
        <option value="5000">💰 5,000 元以下</option>
        <option value="10000">💰 10,000 元以下</option>
        <option value="custom">✏️ 其他金額</option>
      </select>
    </div>
    
    <div class="form-group hidden" id="custom-expense-group">
      <label class="form-label">確切金額</label>
      <input type="number" class="form-input" id="expense-amount" min="1" placeholder="請輸入確切金額">
    </div>
    
    <div class="form-group">
      <label class="form-label required">用途說明</label>
      <textarea class="form-textarea" id="expense-description" placeholder="請詳細說明支出用途..."></textarea>
    </div>
    
    <button class="btn" id="btn-submit-expense">
      <span>📤 提交申請</span>
    </button>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="icon">📋</span>
      <h3>我的申請記錄</h3>
    </div>
    <div id="my-expense-list"></div>
  </div>
</div>

<!-- 回饋面板 -->
<div class="panel" id="panel-feedback">
  <div class="card">
    <div class="card-header">
      <span class="icon">📝</span>
      <h3>活動回饋</h3>
    </div>
    
    <div class="form-group">
      <label class="form-label required">選擇活動</label>
      <select class="form-select" id="feedback-activity">
        <option value="">請選擇要評價的活動</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label required">整體評分</label>
      <select class="form-select" id="feedback-rating">
        <option value="">請選擇評分</option>
        <option value="5">⭐⭐⭐⭐⭐ 非常滿意</option>
        <option value="3">⭐⭐⭐ 普通</option>
        <option value="2">⭐⭐ 不滿意</option>
        <option value="1">⭐ 非常不滿意</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label">意見建議</label>
      <textarea class="form-textarea" id="feedback-comment" placeholder="請分享您的心得與建議（選填）..."></textarea>
    </div>
    
    <button class="btn" id="btn-submit-feedback">
      <span>📤 提交回饋</span>
    </button>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="icon">📊</span>
      <h3>我的回饋記錄</h3>
    </div>
    <div id="my-feedback-list"></div>
  </div>
</div>

<!-- 管理面板 -->
<div class="panel" id="panel-admin">
  <div class="quick-actions admin-only">
    <div class="quick-action-btn" data-admin-tab="overview">
      <span class="icon">📊</span>
      <div>系統總覽</div>
    </div>
    <div class="quick-action-btn" data-admin-tab="members">
      <span class="icon">👥</span>
      <div>會員管理</div>
    </div>
    <div class="quick-action-btn" data-admin-tab="activities">
      <span class="icon">📅</span>
      <div>活動管理</div>
    </div>
    <div class="quick-action-btn" data-admin-tab="finance">
      <span class="icon">💰</span>
      <div>財務管理</div>
    </div>
    <div class="quick-action-btn" data-admin-tab="audit">
      <span class="icon">✅</span>
      <div>支出審核</div>
    </div>
    <div class="quick-action-btn" data-admin-tab="reports">
      <span class="icon">📈</span>
      <div>報表查詢</div>
    </div>
  </div>

  <!-- 系統總覽 -->
  <div class="admin-panel hidden" id="admin-overview">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="stat-total-members">0</div>
        <div class="stat-label">總會員數</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-active-activities">0</div>
        <div class="stat-label">進行中活動</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-total-registrations">0</div>
        <div class="stat-label">活動報名數</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-registered-members">0</div>
        <div class="stat-label">已註冊會員</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="icon">🎯</span>
        <h3>建立新活動</h3>
      </div>
      
      <div class="form-group">
        <label class="form-label required">活動名稱</label>
        <input type="text" class="form-input" id="new-activity-name" placeholder="請輸入活動名稱">
      </div>
      
      <div class="form-group">
        <label class="form-label required">活動日期</label>
        <input type="datetime-local" class="form-input" id="new-activity-date">
      </div>
      
      <div class="form-group">
        <label class="form-label">活動地點</label>
        <input type="text" class="form-input" id="new-activity-location" placeholder="請輸入活動地點">
      </div>
      
      <div class="form-group">
        <label class="form-label">人數限制</label>
        <select class="form-select" id="new-activity-max-select">
          <option value="">不限制人數</option>
          <option value="10">👥 10 人</option>
          <option value="20">👥 20 人</option>
          <option value="30">👥 30 人</option>
          <option value="50">👥 50 人</option>
          <option value="custom">✏️ 自訂人數</option>
        </select>
      </div>
      
      <div class="form-group hidden" id="custom-max-group">
        <label class="form-label">自訂人數</label>
        <input type="number" class="form-input" id="new-activity-max" min="1" placeholder="請輸入人數限制">
      </div>
      
      <div class="form-group">
        <label class="form-label">活動費用</label>
        <select class="form-select" id="new-activity-fee-select">
          <option value="0">🆓 免費活動</option>
          <option value="100">💰 100 元</option>
          <option value="200">💰 200 元</option>
          <option value="300">💰 300 元</option>
          <option value="500">💰 500 元</option>
          <option value="custom">✏️ 其他金額</option>
        </select>
      </div>
      
      <div class="form-group hidden" id="custom-fee-group">
        <label class="form-label">自訂費用</label>
        <input type="number" class="form-input" id="new-activity-fee" min="0" placeholder="請輸入活動費用">
      </div>
      
      <div class="form-group">
        <label class="form-label required">活動描述</label>
        <textarea class="form-textarea" id="new-activity-desc" placeholder="請詳細描述活動內容..."></textarea>
      </div>
      
      <button class="btn" id="btn-create-activity">
        <span>🎯 建立活動</span>
      </button>
    </div>
  </div>

  <!-- 其他管理面板暫時隱藏，保持原有功能 -->
  <div class="admin-panel hidden" id="admin-members">
    <div class="card">
      <div class="card-header">
        <span class="icon">👥</span>
        <h3>會員管理</h3>
      </div>
      <div class="loading">載入中...</div>
    </div>
  </div>

  <div class="admin-panel hidden" id="admin-activities">
    <div class="card">
      <div class="card-header">
        <span class="icon">📅</span>
        <h3>活動管理</h3>
      </div>
      <div class="loading">載入中...</div>
    </div>
  </div>

  <div class="admin-panel hidden" id="admin-finance">
    <div class="card">
      <div class="card-header">
        <span class="icon">💰</span>
        <h3>財務管理</h3>
      </div>
      <div class="loading">載入中...</div>
    </div>
  </div>

  <div class="admin-panel hidden" id="admin-audit">
    <div class="card">
      <div class="card-header">
        <span class="icon">✅</span>
        <h3>支出審核</h3>
      </div>
      <div id="pending-expense-list"></div>
    </div>
  </div>

  <div class="admin-panel hidden" id="admin-reports">
    <div class="card">
      <div class="card-header">
        <span class="icon">📈</span>
        <h3>月報表查詢</h3>
      </div>
      
      <div class="form-group">
        <label class="form-label required">查詢年份</label>
        <select class="form-select" id="report-year">
          <option value="2024">2024年</option>
          <option value="2023">2023年</option>
          <option value="2025">2025年</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label required">查詢月份</label>
        <select class="form-select" id="report-month">
          <option value="1">1月</option>
          <option value="2">2月</option>
          <option value="3">3月</option>
          <option value="4">4月</option>
          <option value="5">5月</option>
          <option value="6">6月</option>
          <option value="7">7月</option>
          <option value="8">8月</option>
          <option value="9">9月</option>
          <option value="10">10月</option>
          <option value="11">11月</option>
          <option value="12">12月</option>
        </select>
      </div>
      
      <button class="btn" id="btn-generate-report">
        <span>📊 產生報表</span>
      </button>
      
      <div id="report-result"></div>
    </div>
  </div>
</div>
</div>

<!-- 回到頂部按鈕 -->
<button class="back-to-top" id="back-to-top">↑</button>

<!-- 通知容器 -->
<div id="notification-container"></div>

<script>
/* ==============================
 基本設定與變數
============================== */
const APP = {
LIFF_ID: '1656516134-VaGgmaPm',
API_URL: 'https://script.google.com/macros/s/AKfycbzV6k9FCn0BwF3yKVns5N_C3KePPqxW-jzLDAZO1mO5gB3oqlgpAbZzR1jCwr0J2czopQ/exec',
API_KEY: 'AAbb8520258185202581',
RETRIES: 3,
RETRY_DELAY: 800,
PAGE_SIZE: 5
};

let currentUser = null;
let isAdmin = false;
let currentTab = 'profile';
let currentAdminTab = 'overview';

/* ==============================
 工具函數
============================== */
function formatDate(date) {
if (!date) return '';
const d = new Date(date);
if (isNaN(d.getTime())) return '';
return d.toLocaleDateString('zh-TW');
}

function formatDateTime(date) {
if (!date) return '';
const d = new Date(date);
if (isNaN(d.getTime())) return '';
return d.toLocaleString('zh-TW');
}

function formatNumber(num) {
return (num || 0).toLocaleString('zh-TW');
}

function showNotification(message, type = 'info', duration = 4000) {
const container = document.getElementById('notification-container');
const notification = document.createElement('div');
notification.className = `notification ${type}`;
notification.textContent = message;

container.appendChild(notification);

// 顯示動畫
setTimeout(() => notification.classList.add('show'), 100);

// 自動隱藏
if (duration > 0) {
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => notification.remove(), 300);
  }, duration);
}
}

function setButtonLoading(button, loading) {
if (!button) return;

if (loading) {
  button.disabled = true;
  button.classList.add('loading');
} else {
  button.disabled = false;
  button.classList.remove('loading');
}
}

/* ==============================
 API 呼叫
============================== */
async function callAPI(action, data = {}) {
const payload = {
  action,
  apiKey: APP.API_KEY,
  timestamp: Date.now(),
  ...data
};

for (let attempt = 1; attempt <= APP.RETRIES; attempt++) {
  try {
    const response = await fetch(APP.API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const result = await response.json();
    return result;
  } catch (error) {
    if (attempt === APP.RETRIES) {
      return { 
        success: false, 
        message: `API 呼叫失敗: ${error.message}` 
      };
    }
    await new Promise(resolve => setTimeout(resolve, APP.RETRY_DELAY * attempt));
  }
}
}

/* ==============================
 LIFF 初始化
============================== */
async function initializeApp() {
try {
  showNotification('系統初始化中...', 'info', 2000);
  
  await liff.init({ liffId: APP.LIFF_ID });
  
  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  const profile = await liff.getProfile();
  
  // 建立或更新使用者
  await callAPI('createUserIfNotExist', {
    lineId: profile.userId,
    lineName: profile.displayName
  });

  await loadUserInfo();
  setupEventListeners();
  
  showNotification('載入完成！', 'success', 2000);
  
} catch (error) {
  console.error('初始化錯誤:', error);
  showNotification('初始化失敗，請重新整理頁面', 'error', 6000);
}
}

/* ==============================
 使用者資訊
============================== */
async function loadUserInfo() {
try {
  const profile = await liff.getProfile();
  const result = await callAPI('getUserInfo', { lineId: profile.userId });
  
  if (!result.success) {
    showNotification('無法載入使用者資料', 'error');
    return;
  }

  currentUser = result.data;
  isAdmin = !!currentUser.isAdmin;
  
  renderUserInfo();
  updateAdminVisibility();
  
  // 預載資料
  loadActivitiesData();
  loadDonationsData();
  
  if (isAdmin) {
    loadSystemStats();
  }
  
} catch (error) {
  console.error('載入使用者資訊錯誤:', error);
  showNotification('載入使用者資料失敗', 'error');
}
}

function renderUserInfo() {
const card = document.getElementById('user-info-card');
const details = document.getElementById('user-details');

if (!currentUser) {
  card.classList.add('hidden');
  return;
}

const memberTypeMap = {
  patient: '🏥 病友',
  family: '👨‍👩‍👧‍👦 家屬',
  volunteer: '🙋‍♀️ 志工',
  medical: '👩‍⚕️ 醫護人員',
  supporter: '🤝 支持者'
};

details.innerHTML = `
  <div class="list-item">
    <div class="list-item-meta">
      <span><strong>姓名：</strong>${currentUser.realName || '未設定'}</span>
      <span><strong>LINE 名稱：</strong>${currentUser.lineName || ''}</span>
      <span><strong>會員類別：</strong>${memberTypeMap[currentUser.memberType] || '未設定'}</span>
      <span><strong>註冊狀態：</strong>
        <span class="badge ${currentUser.status === '已註冊' ? 'success' : 'warning'}">
          ${currentUser.status || '未註冊'}
        </span>
      </span>
      ${isAdmin ? '<span><strong>權限：</strong><span class="badge primary">管理員</span></span>' : ''}
    </div>
  </div>
`;

// 填入表單預設值
if (currentUser.realName) {
  document.getElementById('realName').value = currentUser.realName;
}
if (currentUser.memberType) {
  document.getElementById('memberType').value = currentUser.memberType;
}
if (currentUser.phone) {
  document.getElementById('phone').value = currentUser.phone;
}
if (currentUser.email) {
  document.getElementById('email').value = currentUser.email;
}
if (currentUser.address) {
  document.getElementById('address').value = currentUser.address;
}
if (currentUser.birthday) {
  const date = new Date(currentUser.birthday);
  if (!isNaN(date.getTime())) {
    document.getElementById('birthday').value = date.toISOString().split('T')[0];
  }
}

card.classList.remove('hidden');
}

function updateAdminVisibility() {
const adminElements = document.querySelectorAll('.admin-only');
adminElements.forEach(element => {
  if (isAdmin) {
    element.classList.add('show');
  } else {
    element.classList.remove('show');
  }
});
}

/* ==============================
 分頁切換
============================== */
function switchTab(tabName) {
// 更新選單狀態
document.querySelectorAll('.menu-card').forEach(card => {
  card.classList.toggle('active', card.dataset.tab === tabName);
});

// 更新面板顯示
document.querySelectorAll('.panel').forEach(panel => {
  panel.classList.toggle('active', panel.id === `panel-${tabName}`);
});

currentTab = tabName;

// 載入對應資料
switch (tabName) {
  case 'activities':
    loadActivitiesData();
    break;
  case 'donations':
    loadDonationsData();
    break;
  case 'finance':
    loadExpensesData();
    break;
  case 'feedback':
    loadFeedbackData();
    break;
  case 'admin':
    if (isAdmin) {
      switchAdminTab('overview');
    }
    break;
}
}

function switchAdminTab(tabName) {
// 更新管理選單狀態
document.querySelectorAll('.quick-action-btn').forEach(btn => {
  btn.classList.toggle('active', btn.dataset.adminTab === tabName);
});

// 更新管理面板顯示
document.querySelectorAll('.admin-panel').forEach(panel => {
  panel.classList.toggle('hidden', panel.id !== `admin-${tabName}`);
});

currentAdminTab = tabName;

// 載入對應資料
switch (tabName) {
  case 'overview':
    loadSystemStats();
    break;
  case 'audit':
    loadPendingExpenses();
    break;
}
}

/* ==============================
 會員註冊與更新
============================== */
async function registerMember() {
if (!currentUser) return;

const realName = document.getElementById('realName').value.trim();
const memberType = document.getElementById('memberType').value;

if (!realName || !memberType) {
  showNotification('請填寫完整的姓名和會員類別', 'warning');
  return;
}

const button = document.getElementById('btn-register');
setButtonLoading(button, true);

try {
  const result = await callAPI('register', {
    lineId: currentUser.lineId,
    realName,
    memberType
  });

  if (result.success) {
    showNotification('註冊成功！', 'success');
    await loadUserInfo();
  } else {
    showNotification(result.message || '註冊失敗', 'error');
  }
} catch (error) {
  showNotification('註冊過程發生錯誤', 'error');
} finally {
  setButtonLoading(button, false);
}
}

async function updateContact() {
if (!currentUser) return;

const phone = document.getElementById('phone').value.trim();
const email = document.getElementById('email').value.trim();
const address = document.getElementById('address').value.trim();
const birthday = document.getElementById('birthday').value;

const button = document.getElementById('btn-update-contact');
setButtonLoading(button, true);

try {
  const result = await callAPI('updateUserContact', {
    targetLineId: currentUser.lineId,
    phone,
    email,
    address,
    birthday
  });

  if (result.success) {
    showNotification('聯絡資訊更新成功！', 'success');
    await loadUserInfo();
  } else {
    showNotification(result.message || '更新失敗', 'error');
  }
} catch (error) {
  showNotification('更新過程發生錯誤', 'error');
} finally {
  setButtonLoading(button, false);
}
}

/* ==============================
 活動相關功能
============================== */
async function loadActivitiesData() {
try {
  // 載入可報名活動
  const activitiesResult = await callAPI('getActivities');
  if (activitiesResult.success) {
    renderActivitiesList(activitiesResult.data || []);
    document.getElementById('stat-activity-total').textContent = (activitiesResult.data || []).length;
  }

  // 載入我的報名
  if (currentUser) {
    const myActivitiesResult = await callAPI('getUserActivities', { 
      lineId: currentUser.lineId 
    });
    if (myActivitiesResult.success) {
      renderMyActivitiesList(myActivitiesResult.data || []);
      document.getElementById('stat-my-registrations').textContent = (myActivitiesResult.data || []).length;
      updateFeedbackActivityOptions(myActivitiesResult.data || []);
    }
  }
} catch (error) {
  console.error('載入活動資料錯誤:', error);
}
}

function renderActivitiesList(activities) {
const container = document.getElementById('activity-list');

if (!activities.length) {
  container.innerHTML = `
    <div class="empty-state">
      <div class="icon">📅</div>
      <div class="message">目前沒有可報名的活動</div>
    </div>
  `;
  return;
}

container.innerHTML = activities.map(activity => {
  const currentCount = activity.currentParticipants || 0;
  const maxCount = activity.maxParticipants || '不限';
  const isFull = activity.maxParticipants && currentCount >= activity.maxParticipants;
  
  return `
    <div class="list-item">
      <div class="list-item-header">
        <h4 class="list-item-title">${activity.name}</h4>
        ${isFull ? '<span class="badge error">已額滿</span>' : '<span class="badge success">可報名</span>'}
      </div>
      <div class="list-item-meta">
        <span>📅 ${formatDateTime(activity.date) || '待定'}</span>
        <span>📍 ${activity.location || '待定'}</span>
        <span>👥 ${currentCount}/${maxCount}</span>
        <span>${activity.fee ? `💰 NT$ ${formatNumber(activity.fee)}` : '🆓 免費'}</span>
      </div>
      <div class="list-item-content">
        ${activity.description || ''}
      </div>
      <div class="list-item-actions">
        ${!isFull ? `
          <button class="btn" onclick="registerForActivity('${activity.id}', '${activity.name}')">
            <span>✅ 立即報名</span>
          </button>
        ` : `
          <button class="btn" disabled>
            <span>❌ 已額滿</span>
          </button>
        `}
      </div>
    </div>
  `;
}).join('');
}

function renderMyActivitiesList(activities) {
const container = document.getElementById('my-activity-list');

if (!activities.length) {
  container.innerHTML = `
    <div class="empty-state">
      <div class="icon">📋</div>
      <div class="message">您還沒有報名任何活動</div>
    </div>
  `;
  return;
}

container.innerHTML = activities.map(activity => `
  <div class="list-item">
    <div class="list-item-header">
      <h4 class="list-item-title">${activity.activityName}</h4>
      <span class="badge ${activity.status === '已報名' ? 'success' : 'error'}">
        ${activity.status}
      </span>
    </div>
    <div class="list-item-meta">
      <span>📅 ${formatDateTime(activity.date)}</span>
      <span>📍 ${activity.location || '待定'}</span>
      <span>👤 ${activity.participantName}</span>
      <span>📝 ${formatDate(activity.registerDate)}</span>
    </div>
    ${activity.status === '已報名' ? `
      <div class="list-item-actions">
        <button class="btn btn-danger" onclick="cancelRegistration('${activity.id}')">
          <span>❌ 取消報名</span>
        </button>
      </div>
    ` : ''}
  </div>
`).join('');
}

async function registerForActivity(activityId, activityName) {
if (!currentUser || currentUser.status !== '已註冊') {
  showNotification('請先完成會員註冊', 'warning');
  switchTab('profile');
  return;
}

if (!confirm(`確認要報名「${activityName}」嗎？`)) {
  return;
}

try {
  const result = await callAPI('registerActivity', {
    lineId: currentUser.lineId,
    activityId,
    participantName: currentUser.realName || currentUser.lineName
  });

  if (result.success) {
    showNotification('報名成功！', 'success');
    loadActivitiesData();
  } else {
    showNotification(result.message || '報名失敗', 'error');
  }
} catch (error) {
  showNotification('報名過程發生錯誤', 'error');
}
}

async function cancelRegistration(registrationId) {
if (!confirm('確定要取消這個報名嗎？')) {
  return;
}

try {
  const result = await callAPI('cancelActivity', {
    lineId: currentUser.lineId,
    registrationId
  });

  if (result.success) {
    showNotification('已取消報名', 'success');
    loadActivitiesData();
  } else {
    showNotification(result.message || '取消失敗', 'error');
  }
} catch (error) {
  showNotification('取消過程發生錯誤', 'error');
}
}

/* ==============================
 捐款功能
============================== */
async function loadDonationsData() {
if (!currentUser) return;

try {
  const result = await callAPI('getDonations', { lineId: currentUser.lineId });
  
  if (result.success) {
    const donations = result.data || [];
    renderDonationsList(donations);
    
    // 更新統計
    document.getElementById('stat-donation-count').textContent = donations.length;
    const total = donations.reduce((sum, donation) => sum + (parseFloat(donation.amount) || 0), 0);
    document.getElementById('stat-donation-total').textContent = `NT$ ${formatNumber(total)}`;
  }
} catch (error) {
  console.error('載入捐款資料錯誤:', error);
}
}

function renderDonationsList(donations) {
const container = document.getElementById('donation-list');

if (!donations.length) {
  container.innerHTML = `
    <div class="empty-state">
      <div class="icon">💝</div>
      <div class="message">您還沒有捐款記錄</div>
    </div>
  `;
  return;
}

container.innerHTML = donations.map(donation => `
  <div class="list-item">
    <div class="list-item-header">
      <h4 class="list-item-title">捐款 NT$ ${formatNumber(donation.amount)}</h4>
      <span class="badge success">已完成</span>
    </div>
    <div class="list-item-meta">
      <span>🕒 ${formatDateTime(donation.date)}</span>
      <span>🙍 ${donation.donorName || '匿名'}</span>
    </div>
    ${donation.notes ? `
      <div class="list-item-content">
        用途：${donation.notes}
      </div>
    ` : ''}
  </div>
`).join('');
}

async function addDonation() {
if (!currentUser)
 return;

  const amountSelect = document.getElementById('donation-amount-select').value;
  const customAmount = document.getElementById('donation-amount').value;
  const donorName = document.getElementById('donor-name').value.trim();
  const purpose = document.getElementById('donation-purpose').value;

  let amount;
  if (amountSelect === 'custom') {
    amount = parseFloat(customAmount);
  } else {
    amount = parseFloat(amountSelect);
  }

  if (!amount || amount <= 0) {
    showNotification('請選擇或輸入有效的捐款金額', 'warning');
    return;
  }

  const button = document.getElementById('btn-add-donation');
  setButtonLoading(button, true);

  try {
    const result = await callAPI('addDonation', {
      lineId: currentUser.lineId,
      amount,
      donorName,
      notes: purpose
    });

    if (result.success) {
      showNotification('捐款成功，感謝您的愛心！', 'success');
      
      // 清空表單
      document.getElementById('donation-amount-select').value = '';
      document.getElementById('donation-amount').value = '';
      document.getElementById('donor-name').value = '';
      document.getElementById('donation-purpose').value = '';
      document.getElementById('custom-amount-group').classList.add('hidden');
      
      loadDonationsData();
    } else {
      showNotification(result.message || '捐款失敗', 'error');
    }
  } catch (error) {
    showNotification('捐款過程發生錯誤', 'error');
  } finally {
    setButtonLoading(button, false);
  }
}

/* ==============================
 支出申請功能
============================== */
async function loadExpensesData() {
  if (!currentUser) return;

  try {
    const result = await callAPI('getMyExpenses', { lineId: currentUser.lineId });
    
    if (result.success) {
      renderExpensesList(result.data || []);
    }
  } catch (error) {
    console.error('載入支出資料錯誤:', error);
  }
}

function renderExpensesList(expenses) {
  const container = document.getElementById('my-expense-list');
  
  if (!expenses.length) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">💸</div>
        <div class="message">您還沒有支出申請記錄</div>
      </div>
    `;
    return;
  }

  container.innerHTML = expenses.map(expense => {
    const statusClass = expense.status === '已核准' ? 'success' : 
                       expense.status === '已拒絕' ? 'error' : 'warning';
    
    return `
      <div class="list-item">
        <div class="list-item-header">
          <h4 class="list-item-title">${expense.category} - NT$ ${formatNumber(expense.amount)}</h4>
          <span class="badge ${statusClass}">${expense.status}</span>
        </div>
        <div class="list-item-meta">
          <span>🕒 申請：${formatDateTime(expense.submitDate)}</span>
          ${expense.approvedDate ? `<span>🔍 審核：${formatDateTime(expense.approvedDate)}</span>` : ''}
        </div>
        <div class="list-item-content">
          ${expense.description}
        </div>
        ${expense.notes ? `
          <div class="list-item-content">
            <strong>審核備註：</strong>${expense.notes}
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
}

async function submitExpense() {
  if (!currentUser) return;

  const category = document.getElementById('expense-category').value;
  const amountSelect = document.getElementById('expense-amount-select').value;
  const customAmount = document.getElementById('expense-amount').value;
  const description = document.getElementById('expense-description').value.trim();

  if (!category || !description) {
    showNotification('請填寫完整的支出資訊', 'warning');
    return;
  }

  let amount;
  if (amountSelect === 'custom') {
    amount = parseFloat(customAmount);
  } else {
    amount = parseFloat(amountSelect);
  }

  if (!amount || amount <= 0) {
    showNotification('請選擇或輸入有效的申請金額', 'warning');
    return;
  }

  const button = document.getElementById('btn-submit-expense');
  setButtonLoading(button, true);

  try {
    const result = await callAPI('submitExpense', {
      lineId: currentUser.lineId,
      category,
      amount,
      description
    });

    if (result.success) {
      showNotification('支出申請已提交', 'success');
      
      // 清空表單
      document.getElementById('expense-category').value = '';
      document.getElementById('expense-amount-select').value = '';
      document.getElementById('expense-amount').value = '';
      document.getElementById('expense-description').value = '';
      document.getElementById('custom-expense-group').classList.add('hidden');
      
      loadExpensesData();
    } else {
      showNotification(result.message || '申請失敗', 'error');
    }
  } catch (error) {
    showNotification('申請過程發生錯誤', 'error');
  } finally {
    setButtonLoading(button, false);
  }
}

/* ==============================
 回饋功能
============================== */
async function loadFeedbackData() {
  if (!currentUser) return;

  try {
    const result = await callAPI('getMyFeedback', { lineId: currentUser.lineId });
    
    if (result.success) {
      renderFeedbackList(result.data || []);
    }
  } catch (error) {
    console.error('載入回饋資料錯誤:', error);
  }
}

function renderFeedbackList(feedbacks) {
  const container = document.getElementById('my-feedback-list');
  
  if (!feedbacks.length) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">📝</div>
        <div class="message">您還沒有提交任何回饋</div>
      </div>
    `;
    return;
  }

  container.innerHTML = feedbacks.map(feedback => {
    const stars = '⭐'.repeat(feedback.rating) + '☆'.repeat(5 - feedback.rating);
    
    return `
      <div class="list-item">
        <div class="list-item-header">
          <h4 class="list-item-title">${feedback.activityName}</h4>
          <span class="badge primary">${stars}</span>
        </div>
        <div class="list-item-meta">
          <span>評分：${feedback.rating}/5</span>
          <span>日期：${formatDate(feedback.submitDate)}</span>
        </div>
        ${feedback.comment ? `
          <div class="list-item-content">
            ${feedback.comment}
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
}

function updateFeedbackActivityOptions(activities) {
  const select = document.getElementById('feedback-activity');
  const attendedActivities = activities.filter(activity => activity.status === '已報名');
  
  select.innerHTML = '<option value="">請選擇要評價的活動</option>' + 
    attendedActivities.map(activity => 
      `<option value="${activity.activityId}">${activity.activityName}</option>`
    ).join('');
}

async function submitFeedback() {
  if (!currentUser) return;

  const activityId = document.getElementById('feedback-activity').value;
  const rating = parseInt(document.getElementById('feedback-rating').value);
  const comment = document.getElementById('feedback-comment').value.trim();

  if (!activityId || !rating) {
    showNotification('請選擇活動和評分', 'warning');
    return;
  }

  const button = document.getElementById('btn-submit-feedback');
  setButtonLoading(button, true);

  try {
    const result = await callAPI('submitFeedback', {
      lineId: currentUser.lineId,
      activityId,
      rating,
      comment
    });

    if (result.success) {
      showNotification('回饋已提交，謝謝您的意見！', 'success');
      
      // 清空表單
      document.getElementById('feedback-activity').value = '';
      document.getElementById('feedback-rating').value = '';
      document.getElementById('feedback-comment').value = '';
      
      loadFeedbackData();
    } else {
      showNotification(result.message || '提交失敗', 'error');
    }
  } catch (error) {
    showNotification('提交過程發生錯誤', 'error');
  } finally {
    setButtonLoading(button, false);
  }
}

/* ==============================
 管理功能
============================== */
async function loadSystemStats() {
  if (!isAdmin || !currentUser) return;

  try {
    const result = await callAPI('getSystemStats', { 
      operatorLineId: currentUser.lineId 
    });
    
    if (result.success) {
      const stats = result.data;
      document.getElementById('stat-total-members').textContent = stats.totalMembers || 0;
      document.getElementById('stat-registered-members').textContent = stats.registeredMembers || 0;
      document.getElementById('stat-active-activities').textContent = stats.activeActivities || 0;
      document.getElementById('stat-total-registrations').textContent = stats.totalRegistrations || 0;
    }
  } catch (error) {
    console.error('載入系統統計錯誤:', error);
  }
}

async function createActivity() {
  if (!isAdmin || !currentUser) return;

  const name = document.getElementById('new-activity-name').value.trim();
  const date = document.getElementById('new-activity-date').value;
  const location = document.getElementById('new-activity-location').value.trim();
  const description = document.getElementById('new-activity-desc').value.trim();
  
  const maxSelect = document.getElementById('new-activity-max-select').value;
  const customMax = document.getElementById('new-activity-max').value;
  const feeSelect = document.getElementById('new-activity-fee-select').value;
  const customFee = document.getElementById('new-activity-fee').value;

  if (!name || !date || !description) {
    showNotification('請填寫活動名稱、日期和描述', 'warning');
    return;
  }

  let maxParticipants = null;
  if (maxSelect === 'custom') {
    maxParticipants = parseInt(customMax) || null;
  } else if (maxSelect) {
    maxParticipants = parseInt(maxSelect);
  }

  let fee = 0;
  if (feeSelect === 'custom') {
    fee = parseFloat(customFee) || 0;
  } else {
    fee = parseFloat(feeSelect) || 0;
  }

  const button = document.getElementById('btn-create-activity');
  setButtonLoading(button, true);

  try {
    const result = await callAPI('createActivity', {
      operatorLineId: currentUser.lineId,
      name,
      date,
      location,
      description,
      maxParticipants,
      fee
    });

    if (result.success) {
      showNotification('活動建立成功！', 'success');
      
      // 清空表單
      document.getElementById('new-activity-name').value = '';
      document.getElementById('new-activity-date').value = '';
      document.getElementById('new-activity-location').value = '';
      document.getElementById('new-activity-desc').value = '';
      document.getElementById('new-activity-max-select').value = '';
      document.getElementById('new-activity-max').value = '';
      document.getElementById('new-activity-fee-select').value = '0';
      document.getElementById('new-activity-fee').value = '';
      document.getElementById('custom-max-group').classList.add('hidden');
      document.getElementById('custom-fee-group').classList.add('hidden');
      
      loadSystemStats();
      if (currentTab === 'activities') {
        loadActivitiesData();
      }
    } else {
      showNotification(result.message || '建立失敗', 'error');
    }
  } catch (error) {
    showNotification('建立過程發生錯誤', 'error');
  } finally {
    setButtonLoading(button, false);
  }
}

async function loadPendingExpenses() {
  if (!isAdmin || !currentUser) return;

  try {
    const result = await callAPI('getPendingExpenses', { 
      operatorLineId: currentUser.lineId 
    });
    
    if (result.success) {
      renderPendingExpenses(result.data || []);
    }
  } catch (error) {
    console.error('載入待審核支出錯誤:', error);
  }
}

function renderPendingExpenses(expenses) {
  const container = document.getElementById('pending-expense-list');
  
  if (!expenses.length) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">✅</div>
        <div class="message">目前沒有待審核的支出申請</div>
      </div>
    `;
    return;
  }

  container.innerHTML = expenses.map(expense => `
    <div class="list-item">
      <div class="list-item-header">
        <h4 class="list-item-title">${expense.applicantName} - ${expense.category}</h4>
        <span class="badge warning">待審核</span>
      </div>
      <div class="list-item-meta">
        <span>💰 NT$ ${formatNumber(expense.amount)}</span>
        <span>🕒 ${formatDateTime(expense.submitDate)}</span>
      </div>
      <div class="list-item-content">
        ${expense.description}
      </div>
      <div class="list-item-actions">
        <button class="btn btn-success" onclick="approveExpense('${expense.id}', true)">
          <span>✅ 核准</span>
        </button>
        <button class="btn btn-danger" onclick="approveExpense('${expense.id}', false)">
          <span>❌ 拒絕</span>
        </button>
      </div>
    </div>
  `).join('');
}

async function approveExpense(expenseId, approved) {
  let notes = '';
  if (!approved) {
    notes = prompt('請輸入拒絕原因（可留空）：') || '';
  }

  try {
    const result = await callAPI('approveExpense', {
      operatorLineId: currentUser.lineId,
      expenseId,
      approved,
      notes
    });

    if (result.success) {
      showNotification(approved ? '已核准申請' : '已拒絕申請', 'success');
      loadPendingExpenses();
    } else {
      showNotification(result.message || '操作失敗', 'error');
    }
  } catch (error) {
    showNotification('操作過程發生錯誤', 'error');
  }
}

async function generateReport() {
  if (!isAdmin || !currentUser) return;

  const year = parseInt(document.getElementById('report-year').value);
  const month = parseInt(document.getElementById('report-month').value);

  const button = document.getElementById('btn-generate-report');
  setButtonLoading(button, true);

  try {
    const result = await callAPI('generateReport', {
      operatorLineId: currentUser.lineId,
      year,
      month
    });

    if (result.success) {
      renderReport(result.data);
      showNotification('報表產生成功', 'success');
    } else {
      showNotification(result.message || '報表產生失敗', 'error');
    }
  } catch (error) {
    showNotification('報表產生過程發生錯誤', 'error');
  } finally {
    setButtonLoading(button, false);
  }
}

function renderReport(data) {
  const container = document.getElementById('report-result');
  
  container.innerHTML = `
    <div class="card" style="margin-top: 20px;">
      <div class="card-header">
        <span class="icon">📊</span>
        <h3>${data.period} 財務報表</h3>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number">NT$ ${formatNumber(data.totalIncome)}</div>
          <div class="stat-label">總收入</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">NT$ ${formatNumber(data.totalExpense)}</div>
          <div class="stat-label">總支出</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">NT$ ${formatNumber(data.balance)}</div>
          <div class="stat-label">結餘</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${data.donationCount || 0}</div>
          <div class="stat-label">捐款筆數</div>
        </div>
      </div>
    </div>
  `;
}

/* ==============================
 事件監聽器設定
============================== */
function setupEventListeners() {
  // 主選單切換
  document.querySelectorAll('.menu-card').forEach(card => {
    card.addEventListener('click', () => {
      switchTab(card.dataset.tab);
    });
  });

  // 管理選單切換
  document.querySelectorAll('.quick-action-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      switchAdminTab(btn.dataset.adminTab);
    });
  });

  // 表單提交按鈕
  document.getElementById('btn-register').addEventListener('click', registerMember);
  document.getElementById('btn-update-contact').addEventListener('click', updateContact);
  document.getElementById('btn-add-donation').addEventListener('click', addDonation);
  document.getElementById('btn-submit-expense').addEventListener('click', submitExpense);
  document.getElementById('btn-submit-feedback').addEventListener('click', submitFeedback);
  document.getElementById('btn-create-activity').addEventListener('click', createActivity);
  document.getElementById('btn-generate-report').addEventListener('click', generateReport);

  // 動態顯示自訂輸入框
  document.getElementById('donation-amount-select').addEventListener('change', function() {
    const customGroup = document.getElementById('custom-amount-group');
    if (this.value === 'custom') {
      customGroup.classList.remove('hidden');
    } else {
      customGroup.classList.add('hidden');
    }
  });

  document.getElementById('expense-amount-select').addEventListener('change', function() {
    const customGroup = document.getElementById('custom-expense-group');
    if (this.value === 'custom') {
      customGroup.classList.remove('hidden');
    } else {
      customGroup.classList.add('hidden');
    }
  });

  document.getElementById('new-activity-max-select').addEventListener('change', function() {
    const customGroup = document.getElementById('custom-max-group');
    if (this.value === 'custom') {
      customGroup.classList.remove('hidden');
    } else {
      customGroup.classList.add('hidden');
    }
  });

  document.getElementById('new-activity-fee-select').addEventListener('change', function() {
    const customGroup = document.getElementById('custom-fee-group');
    if (this.value === 'custom') {
      customGroup.classList.remove('hidden');
    } else {
      customGroup.classList.add('hidden');
    }
  });

  // 搜尋功能
  document.getElementById('activity-search').addEventListener('input', debounce(searchActivities, 300));

  // 回到頂部按鈕
  const backToTopBtn = document.getElementById('back-to-top');
  window.addEventListener('scroll', () => {
    if (window.pageYOffset > 300) {
      backToTopBtn.classList.add('show');
    } else {
      backToTopBtn.classList.remove('show');
    }
  });

  backToTopBtn.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function searchActivities() {
  // 搜尋功能實作
  const keyword = document.getElementById('activity-search').value.toLowerCase();
  // 這裡可以加入搜尋邏輯
}

/* ==============================
 應用程式啟動
============================== */
document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
