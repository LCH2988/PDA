<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#2E7D32">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
:root {
--primary: #2E7D32;
--primary-light: #4CAF50;
--secondary: #1976D2;
--success: #4CAF50;
--warning: #FF9800;
--error: #F44336;
--bg: #F5F5F5;
--card: #FFFFFF;
--text: #212121;
--text-secondary: #757575;
--border: #E0E0E0;
--shadow: 0 2px 8px rgba(0,0,0,0.1);
--radius: 12px;
}

* {
box-sizing: border-box;
-webkit-tap-highlight-color: transparent;
}

body {
margin: 0;
padding: 0;
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans TC', sans-serif;
background: var(--bg);
color: var(--text);
font-size: 18px;
line-height: 1.6;
}

/* é©åˆå¹´é•·è€…çš„å¤§å­—é«”è¨­è¨ˆ */
.header {
background: linear-gradient(135deg, var(--primary), var(--primary-light));
color: white;
padding: 24px 20px;
text-align: center;
position: sticky;
top: 0;
z-index: 100;
box-shadow: var(--shadow);
}

.header h1 {
margin: 0;
font-size: 24px;
font-weight: 600;
}

.header .subtitle {
margin-top: 8px;
font-size: 16px;
opacity: 0.9;
}

.container {
max-width: 480px;
margin: 0 auto;
padding: 20px;
}

/* å¤§æŒ‰éˆ•è¨­è¨ˆ */
.tab-nav {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 12px;
margin-bottom: 24px;
}

.tab-btn {
background: white;
border: 3px solid var(--border);
border-radius: var(--radius);
padding: 20px 16px;
text-align: center;
cursor: pointer;
font-size: 18px;
font-weight: 600;
color: var(--text);
transition: all 0.3s ease;
min-height: 80px;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
gap: 8px;
}

.tab-btn.active {
background: var(--primary);
color: white;
border-color: var(--primary);
transform: translateY(-2px);
box-shadow: var(--shadow);
}

.tab-btn:hover:not(.active) {
border-color: var(--primary);
transform: translateY(-1px);
}

.tab-btn .icon {
font-size: 24px;
}

.tab-btn .text {
font-size: 16px;
}

/* å¡ç‰‡è¨­è¨ˆ */
.card {
background: var(--card);
border-radius: var(--radius);
padding: 24px;
margin-bottom: 20px;
box-shadow: var(--shadow);
border: 1px solid var(--border);
}

.card-title {
font-size: 20px;
font-weight: 600;
margin: 0 0 20px 0;
color: var(--primary);
display: flex;
align-items: center;
gap: 12px;
}

/* è¡¨å–®æ§åˆ¶é … */
.form-group {
margin-bottom: 20px;
}

.form-label {
display: block;
font-size: 16px;
font-weight: 600;
margin-bottom: 8px;
color: var(--text);
}

.form-label.required::after {
content: ' *';
color: var(--error);
}

.form-input, .form-select, .form-textarea {
width: 100%;
padding: 16px;
font-size: 18px;
border: 2px solid var(--border);
border-radius: var(--radius);
background: white;
color: var(--text);
transition: border-color 0.3s ease;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
}

.form-textarea {
min-height: 120px;
resize: vertical;
}

/* å¤§æŒ‰éˆ• */
.btn {
display: inline-flex;
align-items: center;
justify-content: center;
gap: 8px;
padding: 18px 24px;
font-size: 18px;
font-weight: 600;
border: none;
border-radius: var(--radius);
cursor: pointer;
transition: all 0.3s ease;
min-height: 56px;
text-decoration: none;
box-shadow: var(--shadow);
}

.btn-primary {
background: var(--primary);
color: white;
}

.btn-primary:hover {
background: var(--primary-light);
transform: translateY(-2px);
}

.btn-secondary {
background: var(--secondary);
color: white;
}

.btn-success {
background: var(--success);
color: white;
}

.btn-warning {
background: var(--warning);
color: white;
}

.btn-danger {
background: var(--error);
color: white;
}

.btn-outline {
background: white;
color: var(--primary);
border: 2px solid var(--primary);
}

.btn-block {
width: 100%;
}

.btn:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none !important;
}

.btn.loading {
position: relative;
color: transparent;
}

.btn.loading::after {
content: '';
position: absolute;
width: 20px;
height: 20px;
border: 2px solid transparent;
border-top: 2px solid currentColor;
border-radius: 50%;
animation: spin 1s linear infinite;
}

@keyframes spin {
to { transform: rotate(360deg); }
}

/* æ´»å‹•å¡ç‰‡ */
.activity-card {
background: white;
border-radius: var(--radius);
padding: 20px;
margin-bottom: 16px;
box-shadow: var(--shadow);
border-left: 4px solid var(--primary);
}

.activity-card.full {
border-left-color: var(--error);
opacity: 0.8;
}

.activity-title {
font-size: 20px;
font-weight: 600;
margin: 0 0 12px 0;
color: var(--text);
}

.activity-meta {
display: flex;
flex-wrap: wrap;
gap: 16px;
margin-bottom: 12px;
font-size: 16px;
color: var(--text-secondary);
}

.activity-meta .item {
display: flex;
align-items: center;
gap: 6px;
}

.activity-description {
font-size: 16px;
line-height: 1.5;
color: var(--text-secondary);
margin-bottom: 16px;
}

.activity-actions {
display: flex;
gap: 12px;
flex-wrap: wrap;
}

/* ç‹€æ…‹æ¨™ç±¤ */
.badge {
display: inline-flex;
align-items: center;
padding: 6px 12px;
font-size: 14px;
font-weight: 600;
border-radius: 20px;
gap: 4px;
}

.badge-success {
background: rgba(76, 175, 80, 0.1);
color: var(--success);
}

.badge-warning {
background: rgba(255, 152, 0, 0.1);
color: var(--warning);
}

.badge-error {
background: rgba(244, 67, 54, 0.1);
color: var(--error);
}

.badge-info {
background: rgba(25, 118, 210, 0.1);
color: var(--secondary);
}

/* çµ±è¨ˆå¡ç‰‡ */
.stats-grid {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 16px;
margin-bottom: 24px;
}

.stat-card {
background: white;
padding: 20px;
border-radius: var(--radius);
text-align: center;
box-shadow: var(--shadow);
border-top: 4px solid var(--primary);
}

.stat-number {
font-size: 32px;
font-weight: 700;
color: var(--primary);
margin-bottom: 8px;
}

.stat-label {
font-size: 16px;
color: var(--text-secondary);
}

/* åˆ—è¡¨é …ç›® */
.list-item {
background: white;
padding: 20px;
border-radius: var(--radius);
margin-bottom: 16px;
box-shadow: var(--shadow);
border-left: 4px solid var(--primary);
}

.list-item-title {
font-size: 18px;
font-weight: 600;
margin: 0 0 12px 0;
}

.list-item-meta {
font-size: 16px;
color: var(--text-secondary);
margin-bottom: 12px;
}

.list-item-content {
font-size: 16px;
line-height: 1.5;
margin-bottom: 16px;
}

/* é€šçŸ¥ */
.notification {
position: fixed;
top: 20px;
left: 20px;
right: 20px;
background: var(--text);
color: white;
padding: 16px 20px;
border-radius: var(--radius);
box-shadow: 0 4px 12px rgba(0,0,0,0.3);
z-index: 1000;
transform: translateY(-100px);
opacity: 0;
transition: all 0.3s ease;
font-size: 16px;
}

.notification.show {
transform: translateY(0);
opacity: 1;
}

.notification.success {
background: var(--success);
}

.notification.error {
background: var(--error);
}

.notification.warning {
background: var(--warning);
}

/* ç©ºç‹€æ…‹ */
.empty-state {
text-align: center;
padding: 40px 20px;
color: var(--text-secondary);
}

.empty-state .icon {
font-size: 48px;
margin-bottom: 16px;
}

.empty-state .text {
font-size: 18px;
}

/* è¼‰å…¥ç‹€æ…‹ */
.loading-state {
text-align: center;
padding: 40px 20px;
color: var(--text-secondary);
}

.loading-spinner {
width: 40px;
height: 40px;
border: 4px solid var(--border);
border-top: 4px solid var(--primary);
border-radius: 50%;
animation: spin 1s linear infinite;
margin: 0 auto 16px;
}

/* éš±è—/é¡¯ç¤º */
.hidden {
display: none !important;
}

.panel {
display: none;
}

.panel.active {
display: block;
animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(10px); }
to { opacity: 1; transform: translateY(0); }
}

/* ç®¡ç†å“¡å°ˆç”¨ */
.admin-only {
display: none;
}

.admin-only.show {
display: block;
}

/* éŸ¿æ‡‰å¼èª¿æ•´ */
@media (max-width: 360px) {
.container {
  padding: 16px;
}

.tab-nav {
  grid-template-columns: 1fr;
}

.stats-grid {
  grid-template-columns: 1fr;
}
}

/* å¿—å·¥ç›¸é—œæ¨£å¼ */
.volunteer-card {
background: linear-gradient(135deg, #E8F5E8, #F1F8E9);
border-left: 4px solid var(--success);
}

.volunteer-hours {
background: var(--success);
color: white;
padding: 8px 16px;
border-radius: 20px;
font-weight: 600;
display: inline-block;
margin-top: 8px;
}

/* è²¡å‹™ç›¸é—œæ¨£å¼ */
.finance-card {
background: linear-gradient(135deg, #E3F2FD, #F3E5F5);
border-left: 4px solid var(--secondary);
}

.amount-positive {
color: var(--success);
font-weight: 600;
}

.amount-negative {
color: var(--error);
font-weight: 600;
}

/* ææ¡ˆç›¸é—œæ¨£å¼ */
.proposal-card {
background: linear-gradient(135deg, #FFF3E0, #FCE4EC);
border-left: 4px solid var(--warning);
}

.proposal-status {
padding: 4px 12px;
border-radius: 16px;
font-size: 14px;
font-weight: 600;
}

.proposal-status.pending {
background: rgba(255, 152, 0, 0.1);
color: var(--warning);
}

.proposal-status.approved {
background: rgba(76, 175, 80, 0.1);
color: var(--success);
}

.proposal-status.rejected {
background: rgba(244, 67, 54, 0.1);
color: var(--error);
}
</style>
</head>
<body>

<div class="header">
<h1>ğŸ¥ å¸•é‡‘æ£®ç—…å‹æœƒ</h1>
<div class="subtitle">é—œæ‡·äº’åŠ© â€¢ å…±åŒæˆé•·</div>
</div>

<div class="container">
<!-- ä½¿ç”¨è€…è³‡è¨Šå¡ç‰‡ -->
<div id="user-info-card" class="card hidden">
  <div class="card-title">
    <span>ğŸ‘¤</span>
    <span>å€‹äººè³‡è¨Š</span>
  </div>
  <div id="user-details"></div>
</div>

<!-- ä¸»é¸å–® -->
<div class="tab-nav" id="main-tabs">
  <div class="tab-btn active" data-tab="profile">
    <div class="icon">ğŸ‘¤</div>
    <div class="text">å€‹äººè³‡æ–™</div>
  </div>
  <div class="tab-btn" data-tab="activities">
    <div class="icon">ğŸ“…</div>
    <div class="text">æ´»å‹•å ±å</div>
  </div>
  <div class="tab-btn" data-tab="volunteer">
    <div class="icon">ğŸ¤</div>
    <div class="text">å¿—å·¥æœå‹™</div>
  </div>
  <div class="tab-btn" data-tab="donation">
    <div class="icon">ğŸ’</div>
    <div class="text">ææ¬¾è¨˜éŒ„</div>
  </div>
  <div class="tab-btn" data-tab="expense">
    <div class="icon">ğŸ’¸</div>
    <div class="text">æ”¯å‡ºç”³è«‹</div>
  </div>
  <div class="tab-btn" data-tab="feedback">
    <div class="icon">ğŸ“</div>
    <div class="text">æ´»å‹•å›é¥‹</div>
  </div>
  <div class="tab-btn admin-only" data-tab="admin">
    <div class="icon">âš™ï¸</div>
    <div class="text">ç³»çµ±ç®¡ç†</div>
  </div>
  <div class="tab-btn admin-only" data-tab="board">
    <div class="icon">ğŸ›ï¸</div>
    <div class="text">ç†ç›£äº‹æœƒ</div>
  </div>
</div>

<!-- å€‹äººè³‡æ–™é é¢ -->
<div class="panel active" id="panel-profile">
  <div class="card">
    <div class="card-title">
      <span>ğŸ“</span>
      <span>æœƒå“¡è¨»å†Š</span>
    </div>
    
    <div class="form-group">
      <label class="form-label required">çœŸå¯¦å§“å</label>
      <input type="text" class="form-input" id="realName" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å">
    </div>
    
    <div class="form-group">
      <label class="form-label required">æœƒå“¡é¡åˆ¥</label>
      <select class="form-select" id="memberType">
        <option value="">è«‹é¸æ“‡æœƒå“¡é¡åˆ¥</option>
        <option value="patient">ç—…å‹</option>
        <option value="family">å®¶å±¬</option>
        <option value="volunteer">å¿—å·¥</option>
        <option value="medical">é†«è­·äººå“¡</option>
        <option value="supporter">æ”¯æŒè€…</option>
      </select>
    </div>
    
    <button class="btn btn-primary btn-block" id="btn-register">
      <span>è¨»å†Š / æ›´æ–°è³‡æ–™</span>
    </button>
  </div>

  <div class="card">
    <div class="card-title">
      <span>ğŸ“</span>
      <span>è¯çµ¡è³‡è¨Š</span>
    </div>
    
    <div class="form-group">
      <label class="form-label">é›»è©±è™Ÿç¢¼</label>
      <input type="tel" class="form-input" id="phone" placeholder="ä¾‹ï¼š0912345678">
    </div>
    
    <div class="form-group">
      <label class="form-label">é›»å­éƒµä»¶</label>
      <input type="email" class="form-input" id="email" placeholder="example@email.com">
    </div>
    
    <div class="form-group">
      <label class="form-label">åœ°å€</label>
      <input type="text" class="form-input" id="address" placeholder="è«‹è¼¸å…¥æ‚¨çš„åœ°å€">
    </div>
    
    <div class="form-group">
      <label class="form-label">ç”Ÿæ—¥</label>
      <input type="date" class="form-input" id="birthday">
    </div>
    
    <button class="btn btn-secondary btn-block" id="btn-update-contact">
      <span>æ›´æ–°è¯çµ¡è³‡è¨Š</span>
    </button>
  </div>
</div>

<!-- æ´»å‹•å ±åé é¢ -->
<div class="panel" id="panel-activities">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number" id="stat-available-activities">0</div>
      <div class="stat-label">å¯å ±åæ´»å‹•</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="stat-my-registrations">0</div>
      <div class="stat-label">æˆ‘çš„å ±å</div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">
      <span>ğŸ“…</span>
      <span>å¯å ±åæ´»å‹•</span>
    </div>
    <div id="activities-list"></div>
  </div>

  <div class="card">
    <div class="card-title">
      <span>ğŸ“‹</span>
      <span>æˆ‘çš„å ±åè¨˜éŒ„</span>
    </div>
    <div id="my-activities-list"></div>
  </div>
</div>

<!-- å¿—å·¥æœå‹™é é¢ -->
<div class="panel" id="panel-volunteer">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number" id="stat-volunteer-hours">0</div>
      <div class="stat-label">ç´¯ç©æ™‚æ•¸</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="stat-volunteer-activities">0</div>
      <div class="stat-label">æœå‹™æ¬¡æ•¸</div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">
      <span>ğŸ¤</span>
      <span>å¿—å·¥ç™»è¨˜</span>
    </div>
    <div id="volunteer-opportunities-list"></div>
  </div>

  <div class="card">
    <div class="card-title">
      <span>â°</span>
      <span>æˆ‘çš„æœå‹™è¨˜éŒ„</span>
    </div>
    <div id="my-volunteer-records"></div>
  </div>
</div>

<!-- ææ¬¾è¨˜éŒ„é é¢ -->
<div class="panel" id="panel-donation">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number" id="stat-donation-count">0</div>
      <div class="stat-label">ææ¬¾æ¬¡æ•¸</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="stat-donation-total">$0</div>
      <div class="stat-label">ææ¬¾ç¸½é¡</div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">
      <span>ğŸ’</span>
      <span>æ–°å¢ææ¬¾</span>
    </div>
    
    <div class="form-group">
      <label class="form-label required">ææ¬¾é‡‘é¡</label>
      <input type="number" class="form-input" id="donation-amount" min="1" placeholder="è«‹è¼¸å…¥ææ¬¾é‡‘é¡">
    </div>
    
    <div class="form-group">
      <label class="form-label">ææ¬¾é …ç›®</label>
      <select class="form-select" id="donation-category">
        <option value="general">ä¸€èˆ¬ææ¬¾</option>
        <option value="activity">æ´»å‹•æ”¯æŒ</option>
        <option value="medical">é†«ç™‚å”åŠ©</option>
        <option value="equipment">è¨­å‚™è³¼ç½®</option>
        <option value="other">å…¶ä»–ç”¨é€”</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label">ææ¬¾äººå§“å</label>
      <input type="text" class="form-input" id="donor-name" placeholder="ç•™ç©ºå‰‡ç‚ºåŒ¿åææ¬¾">
    </div>
    
    <div class="form-group">
      <label class="form-label">å‚™è¨»</label>
      <textarea class="form-textarea" id="donation-notes" placeholder="ææ¬¾ç”¨é€”æˆ–ç‰¹åˆ¥èªªæ˜"></textarea>
    </div>
    
    <button class="btn btn-success btn-block" id="btn-add-donation">
      <span>æ–°å¢ææ¬¾è¨˜éŒ„</span>
    </button>
  </div>

  <div class="card">
    <div class="card-title">
      <span>ğŸ“Š</span>
      <span>æˆ‘çš„ææ¬¾è¨˜éŒ„</span>
    </div>
    <div id="donations-list"></div>
  </div>
</div>

<!-- æ”¯å‡ºç”³è«‹é é¢ -->
<div class="panel" id="panel-expense">
  <div class="card">
    <div class="card-title">
      <span>ğŸ’¸</span>
      <span>æ”¯å‡ºç”³è«‹</span>
    </div>
    
    <div class="form-group">
      <label class="form-label required">æ”¯å‡ºé¡åˆ¥</label>
      <select class="form-select" id="expense-category">
        <option value="">è«‹é¸æ“‡æ”¯å‡ºé¡åˆ¥</option>
        <option value="activity">æ´»å‹•æ”¯å‡º</option>
        <option value="office">è¾¦å…¬è²»ç”¨</option>
        <option value="marketing">å®£å‚³è²»ç”¨</option>
        <option value="equipment">è¨­å‚™è²»ç”¨</option>
        <option value="welfare">ç¦åˆ©æ”¯å‡º</option>
        <option value="medical">é†«ç™‚æ”¯æ´</option>
        <option value="volunteer">å¿—å·¥è²»ç”¨</option>
        <option value="other">å…¶ä»–æ”¯å‡º</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label required">ç”³è«‹é‡‘é¡</label>
      <input type="number" class="form-input" id="expense-amount" min="1" placeholder="è«‹è¼¸å…¥ç”³è«‹é‡‘é¡">
    </div>
    
    <div class="form-group">
      <label class="form-label required">æ”¯å‡ºèªªæ˜</label>
      <textarea class="form-textarea" id="expense-description" placeholder="è«‹è©³ç´°èªªæ˜æ”¯å‡ºç”¨é€”å’Œå¿…è¦æ€§"></textarea>
    </div>
    
    <button class="btn btn-warning btn-block" id="btn-submit-expense">
      <span>æäº¤æ”¯å‡ºç”³è«‹</span>
    </button>
  </div>

  <div class="card">
    <div class="card-title">
      <span>ğŸ“‹</span>
      <span>æˆ‘çš„ç”³è«‹è¨˜éŒ„</span>
    </div>
    <div id="my-expenses-list"></div>
  </div>
</div>

<!-- æ´»å‹•å›é¥‹é é¢ -->
<div class="panel" id="panel-feedback">
  <div class="card">
    <div class="card-title">
      <span>ğŸ“</span>
      <span>æ´»å‹•å›é¥‹</span>
    </div>
    
    <div class="form-group">
      <label class="form-label required">é¸æ“‡æ´»å‹•</label>
      <select class="form-select" id="feedback-activity">
        <option value="">è«‹é¸æ“‡å·²åƒèˆ‡çš„æ´»å‹•</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label required">æ•´é«”è©•åˆ†</label>
      <select class="form-select" id="feedback-rating">
        <option value="">è«‹é¸æ“‡è©•åˆ†</option>
        <option value="5">â­â­â­â­â­ éå¸¸æ»¿æ„</option>
        <option value="4">â­â­â­â­ æ»¿æ„</option>
        <option value="3">â­â­â­ æ™®é€š</option>
        <option value="2">â­â­ ä¸æ»¿æ„</option>
        <option value="1">â­ éå¸¸ä¸æ»¿æ„</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label">æ„è¦‹èˆ‡å»ºè­°</label>
      <textarea class="form-textarea" id="feedback-comment" placeholder="è«‹åˆ†äº«æ‚¨çš„åƒèˆ‡å¿ƒå¾—å’Œæ”¹é€²å»ºè­°"></textarea>
    </div>
    
    <button class="btn btn-primary btn-block" id="btn-submit-feedback">
      <span>æäº¤å›é¥‹</span>
    </button>
  </div>

  <div class="card">
    <div class="card-title">
      <span>ğŸ“Š</span>
      <span>æˆ‘çš„å›é¥‹è¨˜éŒ„</span>
    </div>
    <div id="my-feedback-list"></div>
  </div>
</div>

<!-- ç³»çµ±ç®¡ç†é é¢ -->
<div class="panel admin-only" id="panel-admin">
  <div class="tab-nav">
    <div class="tab-btn active" data-subtab="overview">
      <div class="icon">ğŸ“Š</div>
      <div class="text">ç¸½è¦½</div>
    </div>
    <div class="tab-btn" data-subtab="members">
      <div class="icon">ğŸ‘¥</div>
      <div class="text">æœƒå“¡ç®¡ç†</div>
    </div>
    <div class="tab-btn" data-subtab="activities">
      <div class="icon">ğŸ“…</div>
      <div class="text">æ´»å‹•ç®¡ç†</div>
    </div>
    <div class="tab-btn" data-subtab="finance">
      <div class="icon">ğŸ’°</div>
      <div class="text">è²¡å‹™ç®¡ç†</div>
    </div>
  </div>

  <!-- ç®¡ç†ç¸½è¦½ -->
  <div class="admin-panel active" id="admin-overview">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="admin-stat-members">0</div>
        <div class="stat-label">ç¸½æœƒå“¡æ•¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="admin-stat-activities">0</div>
        <div class="stat-label">æ´»å‹•æ•¸é‡</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="admin-stat-volunteers">0</div>
        <div class="stat-label">å¿—å·¥äººæ•¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="admin-stat-donations">$0</div>
        <div class="stat-label">ç¸½ææ¬¾é¡</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <span>ğŸ¯</span>
        <span>å»ºç«‹æ–°æ´»å‹•</span>
      </div>
      
      <div class="form-group">
        <label class="form-label required">æ´»å‹•åç¨±</label>
        <input type="text" class="form-input" id="new-activity-name" placeholder="è«‹è¼¸å…¥æ´»å‹•åç¨±">
      </div>
      
      <div class="form-group">
        <label class="form-label required">æ´»å‹•æ—¥æœŸ</label>
        <input type="datetime-local" class="form-input" id="new-activity-date">
      </div>
      
      <div class="form-group">
        <label class="form-label">æ´»å‹•åœ°é»</label>
        <input type="text" class="form-input" id="new-activity-location" placeholder="è«‹è¼¸å…¥æ´»å‹•åœ°é»">
      </div>
      
      <div class="form-group">
        <label class="form-label">æœ€å¤§äººæ•¸</label>
        <input type="number" class="form-input" id="new-activity-max" min="1" placeholder="ä¸å¡«å¯«è¡¨ç¤ºä¸é™äººæ•¸">
      </div>
      
      <div class="form-group">
        <label class="form-label">å ±åè²»ç”¨</label>
        <input type="number" class="form-input" id="new-activity-fee" min="0" value="0" placeholder="0è¡¨ç¤ºå…è²»">
      </div>
      
      <div class="form-group">
        <label class="form-label">å¿—å·¥éœ€æ±‚äººæ•¸</label>
        <input type="number" class="form-input" id="new-activity-volunteer-needed" min="0" value="0">
      </div>
      
      <div class="form-group">
        <label class="form-label">å¿—å·¥å°ˆæ¥­éœ€æ±‚</label>
        <input type="text" class="form-input" id="new-activity-volunteer-skills" placeholder="ä¾‹ï¼šé†«è­·èƒŒæ™¯ã€æ´»å‹•ä¼åŠƒç¶“é©—ç­‰">
      </div>
      
      <div class="form-group">
        <label class="form-label required">æ´»å‹•æè¿°</label>
        <textarea class="form-textarea" id="new-activity-description" placeholder="è«‹è©³ç´°æè¿°æ´»å‹•å…§å®¹ã€ç›®çš„å’Œæ³¨æ„äº‹é …"></textarea>
      </div>
      
      <button class="btn btn-primary btn-block" id="btn-create-activity">
        <span>å»ºç«‹æ´»å‹•</span>
      </button>
    </div>
  </div>

  <!-- å…¶ä»–ç®¡ç†é¢æ¿å…§å®¹çœç•¥ï¼Œå¯¦éš›ä½¿ç”¨æ™‚éœ€è¦å®Œæ•´å¯¦ç¾ -->
</div>

<!-- ç†ç›£äº‹æœƒé é¢ -->
<div class="panel admin-only" id="panel-board">
  <div class="card">
    <div class="card-title">
      <span>ğŸ›ï¸</span>
      <span>ç†ç›£äº‹æœƒåŠŸèƒ½</span>
    </div>
    <div class="empty-state">
      <div class="icon">ğŸš§</div>
      <div class="text">ç†ç›£äº‹æœƒåŠŸèƒ½é–‹ç™¼ä¸­...</div>
    </div>
  </div>
</div>
</div>

<!-- é€šçŸ¥å®¹å™¨ -->
<div id="notification-container"></div>

<script>
// æ‡‰ç”¨ç¨‹å¼é…ç½®
const APP_CONFIG = {
LIFF_ID: '1656516134-VaGgmaPm',
API_URL: 'https://script.google.com/macros/s/AKfycbxLimHEenjW3E5wcuEbJWgkwE5CclLhk_su6TsHy366pLWXmNDMsZLhb5ZSzKTzmb_N1Q/exec',
API_KEY: 'AAbb8520258185202581'
};

// å…¨åŸŸè®Šæ•¸
let currentUser = null;
let isAdmin = false;

// å·¥å…·å‡½æ•¸
function formatDate(date) {
if (!date) return '';
const d = new Date(date);
return d.toLocaleDateString('zh-TW');
}

function formatDateTime(date) {
if (!date) return '';
const d = new Date(date);
return d.toLocaleString('zh-TW');
}

function formatCurrency(amount) {
return new Intl.NumberFormat('zh-TW', {
  style: 'currency',
  currency: 'TWD',
  minimumFractionDigits: 0
}).format(amount || 0);
}

function showNotification(message, type = 'info', duration = 4000) {
const container = document.getElementById('notification-container');
const notification = document.createElement('div');
notification.className = `notification ${type}`;
notification.textContent = message;

container.appendChild(notification);

// é¡¯ç¤ºå‹•ç•«
setTimeout(() => notification.classList.add('show'), 100);

// è‡ªå‹•éš±è—
setTimeout(() => {
  notification.classList.remove('show');
  setTimeout(() => container.removeChild(notification), 300);
}, duration);
}

function setLoading(button, loading) {
if (loading) {
  button.classList.add('loading');
  button.disabled = true;
} else {
  button.classList.remove('loading');
  button.disabled = false;
}
}

// API å‘¼å«å‡½æ•¸
async function callAPI(action, data = {}) {
try {
  const response = await fetch(APP_CONFIG.API_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      action,
      apiKey: APP_CONFIG.API_KEY,
      timestamp: Date.now(),
      ...data
    })
  });
  
  const result = await response.json();
  return result;
} catch (error) {
  console.error('API Error:', error);
  return { success: false, message: 'ç¶²è·¯é€£ç·šéŒ¯èª¤' };
}
}

// LIFF åˆå§‹åŒ–
async function initLiff() {
try {
  await liff.init({ liffId: APP_CONFIG.LIFF_ID });
  
  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }
  
  const profile = await liff.getProfile();
  
  // å»ºç«‹æˆ–æ›´æ–°ä½¿ç”¨è€…
  await callAPI('createUserIfNotExist', {
    lineId: profile.userId,
    lineName: profile.displayName
  });
  
  // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
  await loadUserInfo(profile.userId);
  
  // åˆå§‹åŒ–ä»‹é¢
  initializeUI();
  
  showNotification('ç³»çµ±è¼‰å…¥å®Œæˆ', 'success');
  
} catch (error) {
  console.error('LIFFåˆå§‹åŒ–å¤±æ•—:', error);
  showNotification('ç³»çµ±åˆå§‹åŒ–å¤±æ•—', 'error');
}
}

// è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
async function loadUserInfo(lineId) {
const result = await callAPI('getUserInfo', { lineId });

if (result.success) {
  currentUser = result.data;
  isAdmin = currentUser.isAdmin;
  
  // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
  displayUserInfo();
  
  // é¡¯ç¤ºç®¡ç†å“¡åŠŸèƒ½
  if (isAdmin) {
    document.querySelectorAll('.admin-only').forEach(el => {
      el.classList.add('show');
    });
  }
}
}

// é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
function displayUserInfo() {
const userCard = document.getElementById('user-info-card');
const userDetails = document.getElementById('user-details');

if (!currentUser) {
  userCard.classList.add('hidden');
  return;
}

const memberTypeMap = {
  patient: 'ç—…å‹',
  family: 'å®¶å±¬',
  volunteer: 'å¿—å·¥',
  medical: 'é†«è­·äººå“¡',
  supporter: 'æ”¯æŒè€…'
};

userDetails.innerHTML = `
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 16px;">
    <div><strong>å§“åï¼š</strong>${currentUser.realName || 'æœªè¨­å®š'}</div>
    <div><strong>LINEåç¨±ï¼š</strong>${currentUser.lineName || ''}</div>
    <div><strong>æœƒå“¡é¡åˆ¥ï¼š</strong>${memberTypeMap[currentUser.memberType] || 'æœªè¨­å®š'}</div>
    <div><strong>è¨»å†Šç‹€æ…‹ï¼š</strong>
      <span class="badge ${currentUser.status === 'å·²è¨»å†Š' ? 'badge-success' : 'badge-warning'}">
        ${currentUser.status || 'æœªè¨»å†Š'}
      </span>
    </div>
  </div>
`;

userCard.classList.remove('hidden');

// å¡«å…¥è¡¨å–®æ¬„ä½
if (currentUser.realName) {
  document.getElementById('realName').value = currentUser.realName;
}
if (currentUser.memberType) {
  document.getElementById('memberType').value = currentUser.memberType;
}
if (currentUser.phone) {
  document.getElementById('phone').value = currentUser.phone;
}
if (currentUser.email) {
  document.getElementById('email').value = currentUser.email;
}
if (currentUser.address) {
  document.getElementById('address').value = currentUser.address;
}
if (currentUser.birthday) {
  const date = new Date(currentUser.birthday);
  document.getElementById('birthday').value = date.toISOString().split('T')[0];
}
}

// åˆå§‹åŒ–UI
function initializeUI() {
// åˆ†é åˆ‡æ›
document.querySelectorAll('[data-tab]').forEach(tab => {
  tab.addEventListener('click', () => switchTab(tab.dataset.tab));
});

// å­åˆ†é åˆ‡æ›
document.querySelectorAll('[data-subtab]').forEach(tab => {
  tab.addEventListener('click', () => switchSubTab(tab.dataset.subtab));
});

// ç¶å®šæŒ‰éˆ•äº‹ä»¶
bindButtonEvents();

// è¼‰å…¥åˆå§‹è³‡æ–™
loadInitialData();
}

// åˆ†é åˆ‡æ›
function switchTab(tabName) {
// æ›´æ–°åˆ†é æŒ‰éˆ•ç‹€æ…‹
document.querySelectorAll('[data-tab]').forEach(tab => {
  tab.classList.toggle('active', tab.dataset.tab === tabName);
});

// é¡¯ç¤ºå°æ‡‰é¢æ¿
document.querySelectorAll('.panel').forEach(panel => {
  panel.classList.toggle('active', panel.id === `panel-${tabName}`);
});

// è¼‰å…¥å°æ‡‰è³‡æ–™
loadTabData(tabName);
}

// å­åˆ†é åˆ‡æ›
function switchSubTab(subtabName) {
// æ›´æ–°å­åˆ†é æŒ‰éˆ•ç‹€æ…‹
document.querySelectorAll('[data-subtab]').forEach(tab => {
  tab.classList.toggle('active', tab.dataset.subtab === subtabName);
});

// é¡¯ç¤ºå°æ‡‰é¢æ¿
document.querySelectorAll('.admin-panel').forEach(panel => {
  panel.classList.toggle('active', panel.id === `admin-${subtabName}`);
});
}

// ç¶å®šæŒ‰éˆ•äº‹ä»¶
function bindButtonEvents() {
// è¨»å†ŠæŒ‰éˆ•
document.getElementById('btn-register').addEventListener('click', handleRegister);

// æ›´æ–°è¯çµ¡è³‡è¨ŠæŒ‰éˆ•
document.getElementById('btn-update-contact').addEventListener('click', handleUpdateContact);

// æ–°å¢ææ¬¾æŒ‰éˆ•
document.getElementById('btn-add-donation').addEventListener('click', handleAddDonation);

// æäº¤æ”¯å‡ºç”³è«‹æŒ‰éˆ•
document.getElementById('btn-submit-expense').addEventListener('click', handleSubmitExpense);

// æäº¤å›é¥‹æŒ‰éˆ•
document.getElementById('btn-submit-feedback').addEventListener('click', handleSubmitFeedback);

// å»ºç«‹æ´»å‹•æŒ‰éˆ•
document.getElementById('btn-create-activity').addEventListener('click', handleCreateActivity);
}

// è¼‰å…¥åˆå§‹è³‡æ–™
function loadInitialData() {
loadActivities();
loadMyActivities();
loadDonations();
loadMyExpenses();
loadMyFeedback();
loadVolunteerData();
}

// è¼‰å…¥åˆ†é è³‡æ–™
function loadTabData(tabName) {
switch (tabName) {
  case 'activities':
    loadActivities();
    loadMyActivities();
    break;
  case 'volunteer':
    loadVolunteerData();
    break;
  case 'donation':
    loadDonations();
    break;
  case 'expense':
    loadMyExpenses();
    break;
  case 'feedback':
    loadMyFeedback();
    loadFeedbackActivities();
    break;
  case 'admin':
    if (isAdmin) loadAdminData();
    break;
}
}

// è™•ç†è¨»å†Š
async function handleRegister() {
const realName = document.getElementById('realName').value.trim();
const memberType = document.getElementById('memberType').value;

if (!realName || !memberType) {
  showNotification('è«‹å¡«å¯«å®Œæ•´çš„è¨»å†Šè³‡è¨Š', 'warning');
  return;
}

const button = document.getElementById('btn-register');
setLoading(button, true);

try {
  const result = await callAPI('register', {
    lineId: currentUser.lineId,
    realName,
    memberType
  });
  
  if (result.success) {
    showNotification('è¨»å†ŠæˆåŠŸï¼', 'success');
    await loadUserInfo(currentUser.lineId);
  } else {
    showNotification(result.message || 'è¨»å†Šå¤±æ•—', 'error');
  }
} finally {
  setLoading(button, false);
}
}

// è™•ç†æ›´æ–°è¯çµ¡è³‡è¨Š
async function handleUpdateContact() {
const phone = document.getElementById('phone').value.trim();
const email = document.getElementById('email').value.trim();
const address = document.getElementById('address').value.trim();
const birthday = document.getElementById('birthday').value;

const button = document.getElementById('btn-update-contact');
setLoading(button, true);

try {
  const result = await callAPI('updateUserContact', {
    targetLineId: currentUser.lineId,
    phone,
    email,
    address,
    birthday
  });
  
  if (result.success) {
    showNotification('è¯çµ¡è³‡è¨Šæ›´æ–°æˆåŠŸï¼', 'success');
    await loadUserInfo(currentUser.lineId);
  } else {
    showNotification(result.message || 'æ›´æ–°å¤±æ•—', 'error');
  }
} finally {
  setLoading(button, false);
}
}

// è¼‰å…¥æ´»å‹•åˆ—è¡¨
async function loadActivities() {
const result = await callAPI('getActivities');
const container = document.getElementById('activities-list');

if (!result.success) {
  container.innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><div class="text">è¼‰å…¥æ´»å‹•å¤±æ•—</div></div>';
  return;
}

const activities = result.data || [];
document.getElementById('stat-available-activities').textContent = activities.length;

if (activities.length === 0) {
  container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“…</div><div class="text">ç›®å‰æ²’æœ‰å¯å ±åçš„æ´»å‹•</div></div>';
  return;
}

container.innerHTML = activities.map(activity => {
  const isFull = activity.maxParticipants && activity.currentParticipants >= activity.maxParticipants;
  const volunteerInfo = activity.volunteerNeeded > 0 ? 
    `<div class="item"><span>ğŸ¤</span>å¿—å·¥éœ€æ±‚ï¼š${activity.volunteerCurrent || 0}/${activity.volunteerNeeded}</div>` : '';
  
  return `
    <div class="activity-card ${isFull ? 'full' : ''}">
      <div class="activity-title">${activity.name}</div>
      <div class="activity-meta">
        <div class="item"><span>ğŸ“…</span>${formatDateTime(activity.date)}</div>
        <div class="item"><span>ğŸ“</span>${activity.location || 'å¾…å®š'}</div>
        <div class="item"><span>ğŸ‘¥</span>${activity.currentParticipants || 0}/${activity.maxParticipants || 'ä¸é™'}</div>
        <div class="item"><span>ğŸ’°</span>${activity.fee > 0 ? formatCurrency(activity.fee) : 'å…è²»'}</div>
        ${volunteerInfo}
      </div>
      <div class="activity-description">${activity.description || ''}</div>
      <div class="activity-actions">
        ${isFull ? 
          '<span class="badge badge-error">å·²é¡æ»¿</span>' : 
          `<button class="btn btn-primary" onclick="registerActivity('${activity.id}')">å ±ååƒåŠ </button>`
        }
        ${activity.volunteerNeeded > 0 && (!activity.volunteerCurrent || activity.volunteerCurrent < activity.volunteerNeeded) ?
          `<button class="btn btn-success" onclick="registerVolunteer('${activity.id}')">å¿—å·¥ç™»è¨˜</button>` : ''
        }
      </div>
    </div>
  `;
}).join('');
}

// å ±åæ´»å‹•
async function registerActivity(activityId) {
if (!currentUser || currentUser.status !== 'å·²è¨»å†Š') {
  showNotification('è«‹å…ˆå®Œæˆæœƒå“¡è¨»å†Š', 'warning');
  switchTab('profile');
  return;
}

if (!confirm('ç¢ºèªè¦å ±åé€™å€‹æ´»å‹•å—ï¼Ÿ')) return;

const result = await callAPI('registerActivity', {
  lineId: currentUser.lineId,
  activityId,
  participantName: currentUser.realName || currentUser.lineName
});

if (result.success) {
  showNotification('å ±åæˆåŠŸï¼', 'success');
  loadActivities();
  loadMyActivities();
} else {
  showNotification(result.message || 'å ±åå¤±æ•—', 'error');
}
}

// å¿—å·¥ç™»è¨˜
async function registerVolunteer(activityId) {
if (!currentUser || currentUser.status !== 'å·²è¨»å†Š') {
  showNotification('è«‹å…ˆå®Œæˆæœƒå“¡è¨»å†Š', 'warning');
  switchTab('profile');
  return;
}

const skills = prompt('è«‹è¼¸å…¥æ‚¨çš„å°ˆæ¥­æŠ€èƒ½æˆ–ç›¸é—œç¶“é©—ï¼ˆå¯ç•™ç©ºï¼‰ï¼š') || '';

const result = await callAPI('registerVolunteer', {
  lineId: currentUser.lineId,
  activityId,
  volunteerName: currentUser.realName || currentUser.lineName,
  skills,
  phone: currentUser.phone || ''
});

if (result.success) {
  showNotification('å¿—å·¥ç™»è¨˜æˆåŠŸï¼', 'success');
  loadActivities();
  loadVolunteerData();
} else {
  showNotification(result.message || 'å¿—å·¥ç™»è¨˜å¤±æ•—', 'error');
}
}

// è¼‰å…¥æˆ‘çš„æ´»å‹•å ±å
async function loadMyActivities() {
if (!currentUser) return;

const result = await callAPI('getMyRegistrations', { lineId: currentUser.lineId });
const container = document.getElementById('my-activities-list');

if (!result.success) {
  container.innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><div class="text">è¼‰å…¥å¤±æ•—</div></div>';
  return;
}

const registrations = result.data || [];
document.getElementById('stat-my-registrations').textContent = registrations.length;

if (registrations.length === 0) {
  container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“‹</div><div class="text">æ‚¨é‚„æ²’æœ‰å ±åä»»ä½•æ´»å‹•</div></div>';
  return;
}

container.innerHTML = registrations.map(reg => `
  <div class="list-item">
    <div class="list-item-title">${reg.activityName}</div>
    <div class="list-item-meta">
      å ±åæ—¥æœŸï¼š${formatDate(reg.registrationDate)} â€¢ 
      ç‹€æ…‹ï¼š<span class="badge badge-${reg.status === 'å·²ç¢ºèª' ? 'success' : 'warning'}">${reg.status}</span>
    </div>
    <div class="list-item-content">
      æ´»å‹•æ—¥æœŸï¼š${formatDateTime(reg.activityDate)}<br>
      æ´»å‹•åœ°é»ï¼š${reg.activityLocation || 'å¾…å®š'}
    </div>
    <button class="btn btn-outline" onclick="cancelRegistration('${reg.registrationId}')">
      å–æ¶ˆå ±å
    </button>
  </div>
`).join('');
}

// å–æ¶ˆå ±å
async function cancelRegistration(registrationId) {
if (!confirm('ç¢ºèªè¦å–æ¶ˆå ±åå—ï¼Ÿ')) return;

const result = await callAPI('cancelRegistration', {
  lineId: currentUser.lineId,
  registrationId
});

if (result.success) {
  showNotification('å·²å–æ¶ˆå ±å', 'success');
  loadActivities();
  loadMyActivities();
} else {
  showNotification(result.message || 'å–æ¶ˆå¤±æ•—', 'error');
}
}

// è¼‰å…¥å¿—å·¥è³‡æ–™
async function loadVolunteerData() {
if (!currentUser) return;

// è¼‰å…¥å¿—å·¥çµ±è¨ˆ
const statsResult = await callAPI('getVolunteerStats', { lineId: currentUser.lineId });
if (statsResult.success) {
  document.getElementById('stat-volunteer-hours').textContent = statsResult.data.totalHours || 0;
  document.getElementById('stat-volunteer-activities').textContent = statsResult.data.totalActivities || 0;
}

// è¼‰å…¥å¿—å·¥æ©Ÿæœƒ
const opportunitiesResult = await callAPI('getVolunteerOpportunities');
const opportunitiesContainer = document.getElementById('volunteer-opportunities-list');

if (opportunitiesResult.success && opportunitiesResult.data.length > 0) {
  opportunitiesContainer.innerHTML = opportunitiesResult.data.map(opp => `
    <div class="volunteer-card">
      <div class="activity-title">${opp.activityName}</div>
      <div class="activity-meta">
        <div class="item"><span>ğŸ“…</span>${formatDateTime(opp.activityDate)}</div>
        <div class="item"><span>ğŸ‘¥</span>éœ€è¦ ${opp.volunteerNeeded} äºº</div>
        <div class="item"><span>ğŸ¯</span>${opp.volunteerSkills || 'ç„¡ç‰¹æ®Šè¦æ±‚'}</div>
      </div>
      <button class="btn btn-success" onclick="registerVolunteer('${opp.activityId}')">
        æˆ‘è¦ç•¶å¿—å·¥
      </button>
    </div>
  `).join('');
} else {
  opportunitiesContainer.innerHTML = '<div class="empty-state"><div class="icon">ğŸ¤</div><div class="text">ç›®å‰æ²’æœ‰å¿—å·¥æ©Ÿæœƒ</div></div>';
}

// è¼‰å…¥æˆ‘çš„å¿—å·¥è¨˜éŒ„
const recordsResult = await callAPI('getMyVolunteerRecords', { lineId: currentUser.lineId });
const recordsContainer = document.getElementById('my-volunteer-records');

if (recordsResult.success && recordsResult.data.length > 0) {
  recordsContainer.innerHTML = recordsResult.data.map(record => `
    <div class="list-item volunteer-card">
      <div class="list-item-title">${record.activityName}</div>
      <div class="list-item-meta">
        æœå‹™æ—¥æœŸï¼š${formatDate(record.serviceDate)} â€¢ 
        ç‹€æ…‹ï¼š<span class="badge badge-${record.status === 'å·²ç¢ºèª' ? 'success' : 'warning'}">${record.status}</span>
      </div>
      <div class="list-item-content">
        æœå‹™å…§å®¹ï¼š${record.serviceContent || 'å¿—å·¥æœå‹™'}<br>
        ${record.serviceHours ? `<div class="volunteer-hours">æœå‹™æ™‚æ•¸ï¼š${record.serviceHours} å°æ™‚</div>` : ''}
      </div>
    </div>
  `).join('');
} else {
  recordsContainer.innerHTML = '<div class="empty-state"><div class="icon">â°</div><div class="text">é‚„æ²’æœ‰å¿—å·¥æœå‹™è¨˜éŒ„</div></div>';
}
}

// è™•ç†æ–°å¢ææ¬¾
async function handleAddDonation() {
const amount = parseInt(document.getElementById('donation-amount').value);
const category = document.getElementById('donation-category').value;
const donorName = document.getElementById('donor-name').value.trim() || 'åŒ¿å';
const notes = document.getElementById('donation-notes').value.trim();

if (!amount || amount < 1) {
  showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„ææ¬¾é‡‘é¡', 'warning');
  return;
}

const button = document.getElementById('btn-add-donation');
setLoading(button, true);

try {
  const result = await callAPI('addDonation', {
    lineId: currentUser.lineId,
    amount,
    category,
    donorName,
    notes
  });
  
  if (result.success) {
    showNotification('ææ¬¾è¨˜éŒ„æ–°å¢æˆåŠŸï¼', 'success');
    
    // æ¸…ç©ºè¡¨å–®
    document.getElementById('donation-amount').value = '';
    document.getElementById('donation-category').value = 'general';
    document.getElementById('donor-name').value = '';
    document.getElementById('donation-notes').value = '';
    
    loadDonations();
  } else {
    showNotification(result.message || 'æ–°å¢å¤±æ•—', 'error');
  }
} finally {
  setLoading(button, false);
}
}

// è¼‰å…¥ææ¬¾è¨˜éŒ„
async function loadDonations() {
if (!currentUser) return;

const result = await callAPI('getMyDonations', { lineId: currentUser.lineId });
const container = document.getElementById('donations-list');

if (!result.success) {
  container.innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><div class="text">è¼‰å…¥å¤±æ•—</div></div>';
  return;
}

const donations = result.data || [];
const totalAmount = donations.reduce((sum, d) => sum + (d.amount || 0), 0);

document.getElementById('stat-donation-count').textContent = donations.length;
document.getElementById('stat-donation-total').textContent = formatCurrency(totalAmount);

if (donations.length === 0) {
  container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ’</div><div class="text">é‚„æ²’æœ‰ææ¬¾è¨˜éŒ„</div></div>';
  return;
}

const categoryMap = {
  general: 'ä¸€èˆ¬ææ¬¾',
  activity: 'æ´»å‹•æ”¯æŒ',
  medical: 'é†«ç™‚å”åŠ©',
  equipment: 'è¨­å‚™è³¼ç½®',
  other: 'å…¶ä»–ç”¨é€”'
};

container.innerHTML = donations.map(donation => `
  <div class="list-item">
    <div class="list-item-title">
      ${categoryMap[donation.category] || donation.category}
      <span class="amount-positive" style="float: right;">${formatCurrency(donation.amount)}</span>
    </div>
    <div class="list-item-meta">
      ææ¬¾æ—¥æœŸï¼š${formatDate(donation.date)} â€¢ 
      ææ¬¾äººï¼š${donation.donorName}
      ${donation.receiptNumber ? ` â€¢ æ”¶æ“šè™Ÿï¼š${donation.receiptNumber}` : ''}
    </div>
    ${donation.notes ? `<div class="list-item-content">${donation.notes}</div>` : ''}
    ${donation.receiptLink ? 
      `<a href="${donation.receiptLink}" target="_blank" class="btn btn-outline" style="margin-top: 8px;">æŸ¥çœ‹æ”¶æ“š</a>` : ''
    }
  </div>
`).join('');
}

// è™•ç†æ”¯å‡ºç”³è«‹
async function handleSubmitExpense() {
const category = document.getElementById('expense-category').value;
const amount = parseInt(document.getElementById('expense-amount').value);
const description = document.getElementById('expense-description').value.trim();

if (!category || !amount || !description) {
  showNotification('è«‹å¡«å¯«å®Œæ•´çš„ç”³è«‹è³‡è¨Š', 'warning');
  return;
}

if (amount < 1) {
  showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç”³è«‹é‡‘é¡', 'warning');
  return;
}

const button = document.getElementById('btn-submit-expense');
setLoading(button, true);

try {
  const result = await callAPI('submitExpense', {
    lineId: currentUser.lineId,
    category,
    amount,
    description
  });
  
  if (result.success) {
    showNotification('æ”¯å‡ºç”³è«‹æäº¤æˆåŠŸï¼', 'success');
    
    // æ¸…ç©ºè¡¨å–®
    document.getElementById('expense-category').value = '';
    document.getElementById('expense-amount').value = '';
    document.getElementById('expense-description').value = '';
    
    loadMyExpenses();
  } else {
    showNotification(result.message || 'æäº¤å¤±æ•—', 'error');
  }
} finally {
  setLoading(button, false);
}
}

// è¼‰å…¥æˆ‘çš„æ”¯å‡ºç”³è«‹
async function loadMyExpenses() {
if (!currentUser) return;

const result = await callAPI('getMyExpenses', { lineId: currentUser.lineId });
const container = document.getElementById('my-expenses-list');

if (!result.success) {
  container.innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><div class="text">è¼‰å…¥å¤±æ•—</div></div>';
  return;
}

const expenses = result.data || [];

if (expenses.length === 0) {
  container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ’¸</div><div class="text">é‚„æ²’æœ‰æ”¯å‡ºç”³è«‹è¨˜éŒ„</div></div>';
  return;
}

const categoryMap = {
  activity: 'æ´»å‹•æ”¯å‡º',
  office: 'è¾¦å…¬è²»ç”¨',
  marketing: 'å®£å‚³è²»ç”¨',
  equipment: 'è¨­å‚™è²»ç”¨',
  welfare: 'ç¦åˆ©æ”¯å‡º',
  medical: 'é†«ç™‚æ”¯æ´',
  volunteer: 'å¿—å·¥è²»ç”¨',
  other: 'å…¶ä»–æ”¯å‡º'
};

const statusMap = {
  pending: { text: 'å¾…å¯©æ ¸', class: 'warning' },
  approved: { text: 'å·²æ ¸å‡†', class: 'success' },
  rejected: { text: 'å·²æ‹’çµ•', class: 'error' }
};

container.innerHTML = expenses.map(expense => `
  <div class="list-item">
    <div class="list-item-title">
      ${categoryMap[expense.category] || expense.category}
      <span class="amount-negative" style="float: right;">${formatCurrency(expense.amount)}</span>
    </div>
    <div class="list-item-meta">
      ç”³è«‹æ—¥æœŸï¼š${formatDate(expense.applicationDate)} â€¢ 
      ç‹€æ…‹ï¼š<span class="badge badge-${statusMap[expense.status]?.class || 'info'}">${statusMap[expense.status]?.text || expense.status}</span>
      ${expense.reviewDate ? ` â€¢ å¯©æ ¸æ—¥æœŸï¼š${formatDate(expense.reviewDate)}` : ''}
    </div>
    <div class="list-item-content">${expense.description}</div>
    ${expense.reviewNotes ? `<div style="margin-top: 8px; padding: 8px; background: #f5f5f5; border-radius: 4px; font-size: 14px;">å¯©æ ¸æ„è¦‹ï¼š${expense.reviewNotes}</div>` : ''}
    ${expense.voucherLink ? 
      `<a href="${expense.voucherLink}" target="_blank" class="btn btn-outline" style="margin-top: 8px;">æŸ¥çœ‹æ†‘è­‰</a>` : ''
    }
  </div>
`).join('');
}

// è¼‰å…¥å›é¥‹æ´»å‹•é¸é …
async function loadFeedbackActivities() {
if (!currentUser) return;

const result = await callAPI('getMyCompletedActivities', { lineId: currentUser.lineId });
const select = document.getElementById('feedback-activity');

if (result.success && result.data.length > 0) {
  select.innerHTML = '<option value="">è«‹é¸æ“‡å·²åƒèˆ‡çš„æ´»å‹•</option>' + 
    result.data.map(activity => 
      `<option value="${activity.id}">${activity.name} (${formatDate(activity.date)})</option>`
    ).join('');
} else {
  select.innerHTML = '<option value="">æ²’æœ‰å¯å›é¥‹çš„æ´»å‹•</option>';
}
}

// è™•ç†æäº¤å›é¥‹
async function handleSubmitFeedback() {
const activityId = document.getElementById('feedback-activity').value;
const rating = parseInt(document.getElementById('feedback-rating').value);
const comment = document.getElementById('feedback-comment').value.trim();

if (!activityId || !rating) {
  showNotification('è«‹é¸æ“‡æ´»å‹•ä¸¦çµ¦äºˆè©•åˆ†', 'warning');
  return;
}

const button = document.getElementById('btn-submit-feedback');
setLoading(button, true);

try {
  const result = await callAPI('submitFeedback', {
    lineId: currentUser.lineId,
    activityId,
    rating,
    comment
  });
  
  if (result.success) {
    showNotification('å›é¥‹æäº¤æˆåŠŸï¼æ„Ÿè¬æ‚¨çš„æ„è¦‹', 'success');
    
    // æ¸…ç©ºè¡¨å–®
    document.getElementById('feedback-activity').value = '';
    document.getElementById('feedback-rating').value = '';
    document.getElementById('feedback-comment').value = '';
    
    loadMyFeedback();
  } else {
    showNotification(result.message || 'æäº¤å¤±æ•—', 'error');
  }
} finally {
  setLoading(button, false);
}
}

// è¼‰å…¥æˆ‘çš„å›é¥‹è¨˜éŒ„
async function loadMyFeedback() {
if (!currentUser) return;

const result = await callAPI('getMyFeedback', { lineId: currentUser.lineId });
const container = document.getElementById('my-feedback-list');

if (!result.success) {
  container.innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><div class="text">è¼‰å…¥å¤±æ•—</div></div>';
  return;
}

const feedbacks = result.data || [];

if (feedbacks.length === 0) {
  container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“</div><div class="text">é‚„æ²’æœ‰å›é¥‹è¨˜éŒ„</div></div>';
  return;
}

container.innerHTML = feedbacks.map(feedback => {
  const stars = 'â­'.repeat(feedback.rating);
  return `
    <div class="list-item">
      <div class="list-item-title">
        ${feedback.activityName}
        <span style="float: right;">${stars}</span>
      </div>
      <div class="list-item-meta">
        å›é¥‹æ—¥æœŸï¼š${formatDate(feedback.submitDate)} â€¢ 
        æ´»å‹•æ—¥æœŸï¼š${formatDate(feedback.activityDate)}
      </div>
      ${feedback.comment ? `<div class="list-item-content">${feedback.comment}</div>` : ''}
    </div>
  `;
}).join('');
}

// è™•ç†å»ºç«‹æ´»å‹•
async function handleCreateActivity() {
const name = document.getElementById('new-activity-name').value.trim();
const date = document.getElementById('new-activity-date').value;
const location = document.getElementById('new-activity-location').value.trim();
const maxParticipants = parseInt(document.getElementById('new-activity-max').value) || null;
const fee = parseInt(document.getElementById('new-activity-fee').value) || 0;
const volunteerNeeded = parseInt(document.getElementById('new-activity-volunteer-needed').value) || 0;
const volunteerSkills = document.getElementById('new-activity-volunteer-skills').value.trim();
const description = document.getElementById('new-activity-description').value.trim();

if (!name || !date || !description) {
  showNotification('è«‹å¡«å¯«å¿…è¦çš„æ´»å‹•è³‡è¨Š', 'warning');
  return;
}

const button = document.getElementById('btn-create-activity');
setLoading(button, true);

try {
  const result = await callAPI('createActivity', {
    lineId: currentUser.lineId,
    name,
    date,
    location,
    maxParticipants,
    fee,
    volunteerNeeded,
    volunteerSkills,
    description
  });
  
  if (result.success) {
    showNotification('æ´»å‹•å»ºç«‹æˆåŠŸï¼', 'success');
    
    // æ¸…ç©ºè¡¨å–®
    document.getElementById('new-activity-name').value = '';
    document.getElementById('new-activity-date').value = '';
    document.getElementById('new-activity-location').value = '';
    document.getElementById('new-activity-max').value = '';
    document.getElementById('new-activity-fee').value = '0';
    document.getElementById('new-activity-volunteer-needed').value = '0';
    document.getElementById('new-activity-volunteer-skills').value = '';
    document.getElementById('new-activity-description').value = '';
    
    loadActivities();
    loadAdminData();
  } else {
    showNotification(result.message || 'å»ºç«‹å¤±æ•—', 'error');
  }
} finally {
  setLoading(button, false);
}
}

// è¼‰å…¥ç®¡ç†å“¡è³‡æ–™
async function loadAdminData() {
if (!isAdmin) return;

const result = await callAPI('getAdminStats');

if (result.success) {
  const stats = result.data;
  document.getElementById('admin-stat-members').textContent = stats.totalMembers || 0;
  document.getElementById('admin-stat-activities').textContent = stats.totalActivities || 0;
  document.getElementById('admin-stat-volunteers').textContent = stats.totalVolunteers || 0;
  document.getElementById('admin-stat-donations').textContent = formatCurrency(stats.totalDonations || 0);
}
}

// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
initLiff();
});
</script>

</body>
</html>
