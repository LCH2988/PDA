<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>帕金森病友會管理系統 - 改進版</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
<style>
  * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
  }
  
  body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
  }
  
  .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
  }
  
  .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  }
  
  .header h1 {
      color: #4a5568;
      font-size: 28px;
      margin-bottom: 10px;
  }
  
  .header .subtitle {
      color: #718096;
      font-size: 16px;
  }
  
  .user-info {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  }
  
  .tabs {
      display: flex;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 5px;
      margin-bottom: 20px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
  }
  
  .tab {
      flex: 1;
      padding: 12px 16px;
      text-align: center;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      min-width: 80px;
      font-size: 14px;
  }
  
  .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }
  
  .tab-content {
      display: none;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  }
  
  .tab-content.active {
      display: block;
  }
  
  .form-group {
      margin-bottom: 20px;
  }
  
  .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #4a5568;
  }
  
  .form-group input,
  .form-group select,
  .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s ease;
  }
  
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      position: relative;
      overflow: hidden;
  }
  
  .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }
  
  .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
  }
  
  .btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid transparent;
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }
  
  .btn-secondary {
      background: #718096;
      box-shadow: 0 4px 12px rgba(113, 128, 150, 0.3);
  }
  
  .btn-danger {
      background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
      box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
  }
  
  .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #667eea;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }
  
  .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
  }
  
  .status.registered {
      background: #c6f6d5;
      color: #22543d;
  }
  
  .status.unregistered {
      background: #fed7d7;
      color: #742a2a;
  }
  
  .status.approved {
      background: #c6f6d5;
      color: #22543d;
  }
  
  .status.pending {
      background: #feebc8;
      color: #7b341e;
  }
  
  .status.rejected {
      background: #fed7d7;
      color: #742a2a;
  }
  
  .loading {
      text-align: center;
      padding: 40px;
      color: #718096;
  }
  
  .loading::after {
      content: '';
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid #e2e8f0;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
  }
  
  .error {
      background: #fed7d7;
      color: #742a2a;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #f56565;
  }
  
  .success {
      background: #c6f6d5;
      color: #22543d;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #48bb78;
  }
  
  .warning {
      background: #feebc8;
      color: #7b341e;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #ed8936;
  }
  
  .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
  }
  
  .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
  }
  
  .stat-card:hover {
      transform: translateY(-2px);
  }
  
  .stat-card .number {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
  }
  
  .stat-card .label {
      color: #718096;
      font-size: 14px;
  }
  
  .activity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: white;
      border-radius: 10px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
  }
  
  .activity-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }
  
  .activity-info h4 {
      color: #4a5568;
      margin-bottom: 5px;
  }
  
  .activity-info p {
      color: #718096;
      font-size: 14px;
  }
  
  .participants {
      background: #edf2f7;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: #4a5568;
  }
  
  .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
  }
  
  .quick-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #e2e8f0;
      padding: 15px 10px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      color: #4a5568;
  }
  
  .quick-btn:hover {
      border-color: #667eea;
      background: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
  }
  
  .quick-btn .icon {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
  }
  
  /* 新增：資料驗證提示 */
  .form-group .validation-message {
      color: #e53e3e;
      font-size: 12px;
      margin-top: 5px;
      display: none;
  }
  
  .form-group.error input,
  .form-group.error select,
  .form-group.error textarea {
      border-color: #e53e3e;
  }
  
  .form-group.error .validation-message {
      display: block;
  }
  
  /* 新增：搜尋功能樣式 */
  .search-container {
      position: relative;
      margin-bottom: 20px;
  }
  
  .search-input {
      padding-right: 40px;
  }
  
  .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #718096;
  }
  
  /* 新增：分頁功能 */
  .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
  }
  
  .pagination button {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
  }
  
  .pagination button:hover {
      background: #f7fafc;
      border-color: #667eea;
  }
  
  .pagination button.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
  }
  
  /* 新增：響應式改進 */
  @media (max-width: 600px) {
      .container {
          padding: 10px;
      }
      
      .header {
          padding: 20px;
      }
      
      .header h1 {
          font-size: 24px;
      }
      
      .tabs {
          flex-wrap: nowrap;
          overflow-x: auto;
          scrollbar-width: none;
          -ms-overflow-style: none;
      }
      
      .tabs::-webkit-scrollbar {
          display: none;
      }
      
      .tab {
          font-size: 12px;
          padding: 10px 12px;
      }
      
      .activity-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
      }
      
      .quick-actions {
          grid-template-columns: repeat(2, 1fr);
      }
      
      .grid {
          grid-template-columns: 1fr;
      }
  }
  
  /* 新增：深色模式支援 */
  @media (prefers-color-scheme: dark) {
      body {
          background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
      }
      
      .header,
      .user-info,
      .tabs,
      .tab-content {
          background: rgba(45, 55, 72, 0.95);
          color: #e2e8f0;
      }
      
      .header h1,
      .form-group label {
          color: #e2e8f0;
      }
      
      .header .subtitle {
          color: #a0aec0;
      }
      
      .card,
      .activity-item,
      .stat-card {
          background: #2d3748;
          color: #e2e8f0;
      }
      
      .form-group input,
      .form-group select,
      .form-group textarea {
          background: #4a5568;
          border-color: #718096;
          color: #e2e8f0;
      }
      
      .quick-btn {
          background: rgba(45, 55, 72, 0.9);
          border-color: #718096;
          color: #e2e8f0;
      }
  }
  
  /* 新增：無障礙改進 */
  .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
  }
  
  /* 新增：焦點樣式 */
  .btn:focus,
  .tab:focus,
  .quick-btn:focus {
      outline: 2px solid #667eea;
      outline-offset: 2px;
  }
  
  /* 新增：動畫效果 */
  .fade-in {
      animation: fadeIn 0.5s ease-in;
  }
  
  @keyframes fadeIn {
      from {
          opacity: 0;
          transform: translateY(20px);
      }
      to {
          opacity: 1;
          transform: translateY(0);
      }
  }
  
  /* 新增：通知樣式 */
  .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
  }
  
  .notification.show {
      transform: translateX(0);
  }
  
  .notification.success {
      background: #c6f6d5;
      color: #22543d;
      border-left: 4px solid #48bb78;
  }
  
  .notification.error {
      background: #fed7d7;
      color: #742a2a;
      border-left: 4px solid #f56565;
  }
  
  .notification.warning {
      background: #feebc8;
      color: #7b341e;
      border-left: 4px solid #ed8936;
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
      <h1>🏥 帕金森病友會</h1>
      <p class="subtitle">會員管理系統 - 改進版</p>
  </div>

  <div id="user-info" class="user-info" style="display: none;">
      <h3>👤 個人資訊</h3>
      <div id="user-details"></div>
  </div>

  <div class="quick-actions">
      <div class="quick-btn" onclick="showTab('profile')" tabindex="0" role="button" aria-label="個人檔案">
          <span class="icon">👤</span>
          個人檔案
      </div>
      <div class="quick-btn" onclick="showTab('activities')" tabindex="0" role="button" aria-label="活動報名">
          <span class="icon">🎯</span>
          活動報名
      </div>
      <div class="quick-btn" onclick="showTab('donations')" tabindex="0" role="button" aria-label="捐款記錄">
          <span class="icon">💰</span>
          捐款記錄
      </div>
      <div class="quick-btn" onclick="showTab('finance')" tabindex="0" role="button" aria-label="財務管理">
          <span class="icon">📊</span>
          財務管理
      </div>
  </div>

  <div class="tabs" role="tablist">
      <div class="tab active" onclick="showTab('profile')" role="tab" aria-selected="true" tabindex="0">個人檔案</div>
      <div class="tab" onclick="showTab('activities')" role="tab" aria-selected="false" tabindex="0">活動管理</div>
      <div class="tab" onclick="showTab('donations')" role="tab" aria-selected="false" tabindex="0">捐款記錄</div>
      <div class="tab" onclick="showTab('finance')" role="tab" aria-selected="false" tabindex="0">財務管理</div>
      <div class="tab" onclick="showTab('feedback')" role="tab" aria-selected="false" tabindex="0">活動回饋</div>
      <div class="tab admin-only" onclick="showTab('admin')" role="tab" aria-selected="false" tabindex="0" style="display: none;">管理功能</div>
  </div>

  <!-- 個人檔案頁面 -->
  <div id="profile-tab" class="tab-content active fade-in" role="tabpanel">
      <h3>📝 會員註冊 / 個人資料</h3>
      
      <div id="registration-form">
          <div class="form-group">
              <label for="realName">真實姓名 *</label>
              <input type="text" id="realName" placeholder="請輸入您的真實姓名" required aria-describedby="realName-error">
              <div class="validation-message" id="realName-error">請輸入有效的姓名</div>
          </div>
          
          <div class="form-group">
              <label for="memberType">會員類別 *</label>
              <select id="memberType" required aria-describedby="memberType-error">
                  <option value="">請選擇會員類別</option>
                  <option value="member">一般會員</option>
                  <option value="volunteer">志工</option>
                  <option value="vip">VIP會員</option>
              </select>
              <div class="validation-message" id="memberType-error">請選擇會員類別</div>
          </div>
          
          <button class="btn" onclick="registerUser()" id="register-btn">
              <span class="btn-text">註冊會員</span>
          </button>
      </div>

      <div id="contact-form" style="display: none;">
          <h4>📞 聯絡資訊更新</h4>
          <div class="form-group">
              <label for="phone">電話</label>
              <input type="tel" id="phone" placeholder="例：0912345678" pattern="[0-9]{10}">
              <div class="validation-message">請輸入有效的電話號碼</div>
          </div>
          
          <div class="form-group">
              <label for="email">電子郵件</label>
              <input type="email" id="email" placeholder="例：user@example.com">
              <div class="validation-message">請輸入有效的電子郵件地址</div>
          </div>
          
          <div class="form-group">
              <label for="address">地址</label>
              <input type="text" id="address" placeholder="請輸入地址">
          </div>
          
          <div class="form-group">
              <label for="birthday">生日</label>
              <input type="date" id="birthday">
          </div>
          
          <button class="btn" onclick="updateContact()" id="update-btn">
              <span class="btn-text">更新聯絡資訊</span>
          </button>
      </div>
  </div>

  <!-- 活動管理頁面 -->
  <div id="activities-tab" class="tab-content" role="tabpanel">
      <h3>🎯 活動報名管理</h3>
      
      <div class="grid">
          <div class="stat-card">
              <div class="number" id="total-activities">0</div>
              <div class="label">可報名活動</div>
          </div>
          <div class="stat-card">
              <div class="number" id="my-registrations">0</div>
              <div class="label">我的報名</div>
          </div>
      </div>

      <div class="search-container">
          <input type="text" class="form-control search-input" id="activity-search" placeholder="搜尋活動...">
          <span class="search-icon">🔍</span>
      </div>

      <h4>📅 可報名活動</h4>
      <div id="activities-list" class="loading">載入中...</div>
      <div id="activities-pagination" class="pagination"></div>

      <h4>📋 我的活動報名</h4>
      <div id="my-activities-list" class="loading">載入中...</div>
  </div>

  <!-- 其他頁面內容保持原樣，但加入改進的樣式和功能 -->
  <div id="donations-tab" class="tab-content" role="tabpanel">
      <h3>💰 捐款記錄</h3>
      
      <div class="grid">
          <div class="stat-card">
              <div class="number" id="total-donations">0</div>
              <div class="label">捐款筆數</div>
          </div>
          <div class="stat-card">
              <div class="number" id="total-amount">NT$ 0</div>
              <div class="label">捐款總額</div>
          </div>
      </div>

      <div id="donations-list" class="loading">載入中...</div>
  </div>

  <div id="finance-tab" class="tab-content" role="tabpanel">
      <h3>📊 財務管理</h3>
      
      <h4>💳 帳戶餘額</h4>
      <div id="accounts-list" class="loading">載入中...</div>

      <h4>📈 預算使用狀況</h4>
      <div id="budget-status" class="loading">載入中...</div>

      <h4>💸 支出申請</h4>
      <div class="form-group">
          <label for="expense-category">支出類別</label>
          <select id="expense-category">
              <option value="activity">活動支出</option>
              <option value="office">辦公費用</option>
              <option value="marketing">宣傳費用</option>
              <option value="equipment">設備費用</option>
              <option value="welfare">福利支出</option>
              <option value="medical">醫療支援</option>
              <option value="volunteer">志工費用</option>
              <option value="other">其他支出</option>
          </select>
      </div>
      
      <div class="form-group">
          <label for="expense-amount">金額</label>
          <input type="number" id="expense-amount" placeholder="請輸入金額" min="0">
      </div>
      
      <div class="form-group">
          <label for="expense-description">說明</label>
          <textarea id="expense-description" placeholder="請詳細說明支出用途" rows="3"></textarea>
      </div>
      
      <button class="btn" onclick="submitExpense()">提交支出申請</button>

      <h4>📋 我的支出申請</h4>
      <div id="my-expenses" class="loading">載入中...</div>
  </div>

  <div id="feedback-tab" class="tab-content" role="tabpanel">
      <h3>📝 活動回饋</h3>
      
      <div class="form-group">
          <label for="feedback-activity">選擇活動</label>
          <select id="feedback-activity">
              <option value="">請選擇已參與的活動</option>
          </select>
      </div>
      
      <div class="form-group">
          <label for="feedback-rating">評分 (1-5分)</label>
          <select id="feedback-rating">
              <option value="">請選擇評分</option>
              <option value="1">1分 - 很不滿意</option>
              <option value="2">2分 - 不滿意</option>
              <option value="3">3分 - 普通</option>
              <option value="4">4分 - 滿意</option>
              <option value="5">5分 - 非常滿意</option>
          </select>
      </div>
      
      <div class="form-group">
          <label for="feedback-comment">意見與建議</label>
          <textarea id="feedback-comment" placeholder="請分享您的參與心得與建議" rows="4"></textarea>
      </div>
      
      <button class="btn" onclick="submitFeedback()">提交回饋</button>

      <h4>📊 我的回饋記錄</h4>
      <div id="my-feedback" class="loading">載入中...</div>
  </div>

  <div id="admin-tab" class="tab-content" role="tabpanel">
      <h3>🔧 管理功能</h3>
      
      <div class="grid">
          <div class="stat-card">
              <div class="number" id="total-members">0</div>
              <div class="label">總會員數</div>
          </div>
          <div class="stat-card">
              <div class="number" id="registered-members">0</div>
              <div class="label">已註冊會員</div>
          </div>
      </div>

      <h4>👥 會員管理</h4>
      <div class="form-group">
          <input type="text" id="member-search" placeholder="搜尋會員（姓名或LINE ID）">
      </div>
      <div class="form-group">
          <select id="member-type-filter">
              <option value="">所有會員類別</option>
              <option value="member">一般會員</option>
              <option value="volunteer">志工</option>
              <option value="vip">VIP會員</option>
          </select>
      </div>
      <button class="btn btn-secondary" onclick="searchMembers()">搜尋會員</button>
      
      <div id="members-list" class="loading">載入中...</div>

      <h4>💸 支出審核</h4>
      <div id="pending-expenses" class="loading">載入中...</div>

      <h4>📊 財務報表</h4>
      <div class="form-group">
          <label for="report-year">年份</label>
          <input type="number" id="report-year" value="2024" min="2020" max="2030">
      </div>
      <div class="form-group">
          <label for="report-month">月份</label>
          <select id="report-month">
              <option value="1">1月</option>
              <option value="2">2月</option>
              <option value="3">3月</option>
              <option value="4">4月</option>
              <option value="5">5月</option>
              <option value="6">6月</option>
              <option value="7">7月</option>
              <option value="8">8月</option>
              <option value="9">9月</option>
              <option value="10">10月</option>
              <option value="11">11月</option>
              <option value="12">12月</option>
          </select>
      </div>
      <button class="btn" onclick="generateReport()">產生報表</button>
      
      <div id="finance-report"></div>
  </div>
</div>

<script>
  // 系統配置 - 請修改為您的實際值
  const CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycbyULkqY0Apt9nnPOq0pamUEIKxtbmo2KmQBTu_Tg5Bmc116WYMDpLPdbKFvOgP_ZtkHAQ/exec',
      API_KEY: 'AAbb8520258185202581',
      STRICT_SIGN: false
  };

  // 全域變數
  let currentUser = null;
  let isAdmin = false;
  let currentPage = 1;
  let itemsPerPage = 10;

  // 改進的 LIFF 初始化
  async function initializeLiff() {
      try {
          await liff.init({ liffId: CONFIG.LIFF_ID });
          
          if (!liff.isLoggedIn()) {
              liff.login();
              return;
          }

          const profile = await liff.getProfile();
          await createUserIfNotExist(profile.userId, profile.displayName);
          await loadUserInfo();
          
          showNotification('系統初始化成功', 'success');
      } catch (error) {
          console.error('LIFF 初始化失敗:', error);
          showNotification('系統初始化失敗，請重新整理頁面', 'error');
      }
  }

  // 改進的 API 呼叫函式，加入重試機制
  async function callAPI(action, data = {}, retries = 3) {
      for (let i = 0; i < retries; i++) {
          try {
              const payload = {
                  action,
                  ...data,
                  apiKey: CONFIG.API_KEY,
                  ts: Date.now(),
                  nonce: Math.random().toString(36).substring(2)
              };

              if (CONFIG.STRICT_SIGN) {
                  const baseString = `${action}|${payload.ts}|${payload.nonce}|${CONFIG.API_KEY}`;
                  const signature = CryptoJS.HmacSHA256(baseString, CONFIG.API_KEY).toString();
                  payload.sign = signature;
              }

              const response = await fetch(CONFIG.API_BASE_URL, {
                  method: 'POST',
                  headers: { 
                      'Content-Type': 'application/json',
                      'Cache-Control': 'no-cache'
                  },
                  body: JSON.stringify(payload)
              });

              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }

              return await response.json();
          } catch (error) {
              console.error(`API 呼叫失敗 (嘗試 ${i + 1}/${retries}):`, error);
              if (i === retries - 1) throw error;
              await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
          }
      }
  }

  // 改進的表單驗證
  function validateForm(formId) {
      const form = document.getElementById(formId) || document;
      const inputs = form.querySelectorAll('input[required], select[required]');
      let isValid = true;

      inputs.forEach(input => {
          const formGroup = input.closest('.form-group');
          const errorMessage = formGroup.querySelector('.validation-message');
          
          if (!input.value.trim()) {
              formGroup.classList.add('error');
              if (errorMessage) errorMessage.style.display = 'block';
              isValid = false;
          } else {
              formGroup.classList.remove('error');
              if (errorMessage) errorMessage.style.display = 'none';
              
              // 特定欄位驗證
              if (input.type === 'email' && !isValidEmail(input.value)) {
                  formGroup.classList.add('error');
                  if (errorMessage) errorMessage.style.display = 'block';
                  isValid = false;
              }
              
              if (input.type === 'tel' && !isValidPhone(input.value)) {
                  formGroup.classList.add('error');
                  if (errorMessage) errorMessage.style.display = 'block';
                  isValid = false;
              }
          }
      });

      return isValid;
  }

  function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
  }

  function isValidPhone(phone) {
      const phoneRegex = /^[0-9]{10}$/;
      return phoneRegex.test(phone.replace(/\D/g, ''));
  }

  // 改進的按鈕載入狀態
  function setButtonLoading(buttonId, loading = true) {
      const button = document.getElementById(buttonId);
      if (!button) return;

      if (loading) {
          button.classList.add('loading');
          button.disabled = true;
          const text = button.querySelector('.btn-text');
          if (text) text.style.opacity = '0';
      } else {
          button.classList.remove('loading');
          button.disabled = false;
          const text = button.querySelector('.btn-text');
          if (text) text.style.opacity = '1';
      }
  }

  // 改進的通知系統
  function showNotification(message, type = 'info', duration = 3000) {
      // 移除現有通知
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
          existingNotification.remove();
      }
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
              <span>${message}</span>
              <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 18px; margin-left: 10px;">&times;</button>
          </div>
      `;
      
      document.body.appendChild(notification);
      
      // 顯示動畫
      setTimeout(() => notification.classList.add('show'), 100);
      
      // 自動隱藏
      setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => notification.remove(), 300);
      }, duration);
  }

  // 改進的會員註冊函式
  async function registerUser() {
      if (!validateForm('registration-form')) {
          showNotification('請填寫所有必填欄位', 'error');
          return;
      }

      const realName = document.getElementById('realName').value.trim();
      const memberType = document.getElementById('memberType').value;

      setButtonLoading('register-btn', true);

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('register', {
              lineId: profile.userId,
              realName,
              memberType
          });

          if (result.success) {
              showNotification('註冊成功！', 'success');
              await loadUserInfo();
          } else {
              showNotification(`註冊失敗：${result.message}`, 'error');
          }
      } catch (error) {
          console.error('註冊失敗:', error);
          showNotification('註冊過程發生錯誤', 'error');
      } finally {
          setButtonLoading('register-btn', false);
      }
  }

  // 改進的聯絡資訊更新
  async function updateContact() {
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const address = document.getElementById('address').value.trim();
      const birthday = document.getElementById('birthday').value;

      // 驗證電話和電子郵件格式
      if (phone && !isValidPhone(phone)) {
          showNotification('請輸入有效的電話號碼', 'error');
          return;
      }

      if (email && !isValidEmail(email)) {
          showNotification('請輸入有效的電子郵件地址', 'error');
          return;
      }

      setButtonLoading('update-btn', true);

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('updateUserContact', {
              operatorLineId: profile.userId,
              targetLineId: profile.userId,
              phone,
              email,
              address,
              birthday
          });

          if (result.success) {
              showNotification('聯絡資訊更新成功！', 'success');
              await loadUserInfo();
          } else {
              showNotification(`更新失敗：${result.message}`, 'error');
          }
      } catch (error) {
          console.error('更新聯絡資訊失敗:', error);
          showNotification('更新過程發生錯誤', 'error');
      } finally {
          setButtonLoading('update-btn', false);
      }
  }

  // 改進的使用者資訊載入
  async function loadUserInfo() {
      try {
          const profile = await liff.getProfile();
          const result = await callAPI('getUserInfo', { lineId: profile.userId });
          
          if (result.error) {
              showNotification('無法載入使用者資訊', 'error');
              return;
          }

          currentUser = result;
          isAdmin = result.isAdmin || false;
          
          updateUserInfoDisplay();
          updateUIBasedOnUserStatus();
          
      } catch (error) {
          console.error('載入使用者資訊失敗:', error);
          showNotification('載入使用者資訊失敗', 'error');
      }
  }

  function updateUserInfoDisplay() {
      if (!currentUser) return;

      const userInfoDiv = document.getElementById('user-info');
      const userDetailsDiv = document.getElementById('user-details');
      
      userDetailsDiv.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
              <div><strong>姓名:</strong> ${currentUser.realName || '未設定'}</div>
              <div><strong>LINE 名稱:</strong> ${currentUser.lineName || '未知'}</div>
              <div><strong>狀態:</strong> <span class="status ${currentUser.status === '已註冊' ? 'registered' : 'unregistered'}">${currentUser.status}</span></div>
              <div><strong>會員類別:</strong> ${currentUser.memberType || '未設定'}</div>
              <div><strong>互動次數:</strong> ${currentUser.messageCount || 0} 次</div>
              ${isAdmin ? '<div><strong>權限:</strong> <span class="status approved">管理員</span></div>' : ''}
          </div>
      `;
      
      userInfoDiv.style.display = 'block';
      userInfoDiv.classList.add('fade-in');
  }

  function updateUIBasedOnUserStatus() {
      const registrationForm = document.getElementById('registration-form');
      const contactForm = document.getElementById('contact-form');
      const adminTab = document.querySelector('.admin-only');

      if (currentUser.status === '已註冊') {
          registrationForm.style.display = 'none';
          contactForm.style.display = 'block';
          
          // 填入現有聯絡資訊
          document.getElementById('phone').value = currentUser.phone || '';
          document.getElementById('email').value = currentUser.email || '';
          document.getElementById('address').value = currentUser.address || '';
          document.getElementById('birthday').value = currentUser.birthday || '';
      } else {
          registrationForm.style.display = 'block';
          contactForm.style.display = 'none';
      }

      if (isAdmin) {
          adminTab.style.display = 'block';
      }
  }

  // 改進的分頁切換
  function showTab(tabName) {
      // 更新 ARIA 屬性
      document.querySelectorAll('.tab').forEach(tab => {
          tab.setAttribute('aria-selected', 'false');
          tab.classList.remove('active');
      });
      
      document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
      });
      
      const targetContent = document.getElementById(`${tabName}-tab`);
      const targetTab = document.querySelector(`.tab[onclick="showTab('${tabName}')"]`);
      
      if (targetContent && targetTab) {
          targetContent.classList.add('active', 'fade-in');
          targetTab.classList.add('active');
          targetTab.setAttribute('aria-selected', 'true');
      }
      
      loadTabData(tabName);
  }

  async function loadTabData(tabName) {
      switch (tabName) {
          case 'activities':
              await Promise.all([loadActivities(), loadMyActivities()]);
              break;
          case 'donations':
              await loadDonations();
              break;
          case 'finance':
              await loadFinanceData();
              break;
          case 'feedback':
              await loadFeedbackData();
              break;
          case 'admin':
              if (isAdmin) {
                  await loadAdminData();
              }
              break;
      }
  }

  // 改進的活動載入函式
  async function loadActivities() {
      try {
          const result = await callAPI('getActivities');
          const activitiesList = document.getElementById('activities-list');
          
          if (!result || result.length === 0) {
              activitiesList.innerHTML = '<div class="card"><p>目前沒有開放的活動</p></div>';
              return;
          }

          document.getElementById('total-activities').textContent = result.length;
          renderActivities(result);
          
      } catch (error) {
          console.error('載入活動失敗:', error);
          document.getElementById('activities-list').innerHTML = '<div class="error">載入活動失敗</div>';
      }
  }

  function renderActivities(activities, page = 1) {
      const activitiesList = document.getElementById('activities-list');
      const startIndex = (page - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedActivities = activities.slice(startIndex, endIndex);

      let html = '';
      paginatedActivities.forEach(activity => {
          const dateStr = activity.date ? new Date(activity.date).toLocaleDateString('zh-TW') : '待定';
          const participantsText = `${activity.currentParticipants}/${activity.maxParticipants || '不限'}`;
          const isFull = activity.maxParticipants && activity.currentParticipants >= activity.maxParticipants;
          
          html += `
              <div class="activity-item">
                  <div class="activity-info">
                      <h4>${activity.name}</h4>
                      <p>📅 ${dateStr} | 📍 ${activity.location || '待定'}</p>
                      <p>${activity.description || ''}</p>
                      ${activity.fee ? `<p>💰 費用：NT$ ${activity.fee}</p>` : ''}
                  </div>
                  <div style="text-align: right;">
                      <div class="participants">${participantsText}</div>
                      ${!isFull ? `<button class="btn" style="margin-top: 10px; padding: 8px 16px; font-size: 14px;" onclick="registerActivity('${activity.id}')">報名</button>` : '<span class="status rejected">已額滿</span>'}
                  </div>
              </div>
          `;
      });

      activitiesList.innerHTML = html;
      renderPagination('activities-pagination', activities.length, page, (newPage) => renderActivities(activities, newPage));
  }

  function renderPagination(containerId, totalItems, currentPage, onPageChange) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const totalPages = Math.ceil(totalItems / itemsPerPage);
      if (totalPages <= 1) {
          container.innerHTML = '';
          return;
      }

      let html = '';
      
      // 上一頁
      if (currentPage > 1) {
          html += `<button onclick="changePage(${currentPage - 1})">上一頁</button>`;
      }
      
      // 頁碼
      for (let i = 1; i <= totalPages; i++) {
          if (i === currentPage) {
              html += `<button class="active">${i}</button>`;
          } else if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
              html += `<button onclick="changePage(${i})">${i}</button>`;
          } else if (i === currentPage - 3 || i === currentPage + 3) {
              html += '<span>...</span>';
          }
      }
      
      // 下一頁
      if (currentPage < totalPages) {
          html += `<button onclick="changePage(${currentPage + 1})">下一頁</button>`;
      }

      container.innerHTML = html;
      
      // 儲存回調函式
      window.changePage = onPageChange;
  }

  // 新增活動報名功能
  async function registerActivity(activityId) {
      if (!currentUser || currentUser.status !== '已註冊') {
          showNotification('請先完成會員註冊', 'warning');
          return;
      }

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('registerActivity', {
              lineId: profile.userId,
              activityId: activityId,
              participantName: currentUser.realName
          });

          if (result.success) {
              showNotification('活動報名成功！', 'success');
              await loadActivities();
              await loadMyActivities();
          } else {
              showNotification(`報名失敗：${result.message}`, 'error');
          }
      } catch (error) {
          console.error('活動報名失敗:', error);
          showNotification('報名過程發生錯誤', 'error');
      }
  }

  // 載入我的活動
  async function loadMyActivities() {
      try {
          const profile = await liff.getProfile();
          const result = await callAPI('getUserActivities', { lineId: profile.userId });
          const myActivitiesList = document.getElementById('my-activities-list');
          
          if (!result || result.length === 0) {
              myActivitiesList.innerHTML = '<div class="card"><p>您目前沒有報名任何活動</p></div>';
              document.getElementById('my-registrations').textContent = '0';
              return;
          }

          document.getElementById('my-registrations').textContent = result.length;

          let html = '';
          result.forEach(registration => {
              const dateStr = registration.date ? new Date(registration.date).toLocaleDateString('zh-TW') : '待定';
              
              html += `
                  <div class="card">
                      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                          <div>
                              <h4>${registration.activityName}</h4>
                              <p>📅 ${dateStr}</p>
                              <p>📍 ${registration.location || '待定'}</p>
                              <p>👤 參與者：${registration.participantName}</p>
                          </div>
                          <div style="text-align: right;">
                              <span class="status registered">${registration.status}</span>
                              ${registration.status === '已報名' ? `<br><button class="btn btn-danger" style="margin-top: 10px; padding: 6px 12px; font-size: 12px;" onclick="cancelActivity('${registration.id}')">取消報名</button>` : ''}
                          </div>
                      </div>
                  </div>
              `;
          });

          myActivitiesList.innerHTML = html;
          loadActivitiesForFeedback(result);
          
      } catch (error) {
          console.error('載入我的活動失敗:', error);
          document.getElementById('my-activities-list').innerHTML = '<div class="error">載入失敗</div>';
      }
  }

  // 取消活動報名
  async function cancelActivity(registrationId) {
      if (!confirm('確定要取消這個活動的報名嗎？')) {
          return;
      }

      try {
          const profile = await liff.getProfile();
          const result = await callAPI('cancelActivity', {
              lineId: profile.userId,
              registrationId: registrationId
          });

          if (result.success) {
              showNotification('已取消報名', 'success');
              await loadActivities();
              await loadMyActivities();
          } else {
              showNotification(`取消失敗：${result.message}`, 'error');
          }
      } catch (error) {
          console.error('取消報名失敗:', error);
          showNotification('取消過程發生錯誤', 'error');
      }
  }

  function loadActivitiesForFeedback(activities) {
      const select = document.getElementById('feedback-activity');
      select.innerHTML = '<option value="">請選擇已參與的活動</option>';
      
      activities.forEach(activity => {
          const option = document.createElement('option');
          option.value = activity.activityId;
          option.textContent = activity.activityName;
          select.appendChild(option);
      });
  }

  // 新增搜尋功能
  function setupSearch() {
      const searchInput = document.getElementById('activity-search');
      if (searchInput) {
          searchInput.addEventListener('input', debounce(searchActivities, 300));
      }
  }

  function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
          const later = () => {
              clearTimeout(timeout);
              func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
      };
  }

  async function searchActivities() {
      const searchTerm = document.getElementById('activity-search').value.toLowerCase();
      try {
          const result = await callAPI('getActivities');
          const filteredActivities = result.filter(activity => 
              activity.name.toLowerCase().includes(searchTerm) ||
              (activity.description && activity.description.toLowerCase().includes(searchTerm)) ||
              (activity.location && activity.location.toLowerCase().includes(searchTerm))
          );
          renderActivities(filteredActivities);
      } catch (error) {
          console.error('搜尋活動失敗:', error);
      }
  }

  // 新增其他功能的空函式（可根據需要實現）
  async function loadDonations() {
      document.getElementById('donations-list').innerHTML = '<div class="card"><p>捐款功能開發中...</p></div>';
  }

  async function loadFinanceData() {
      document.getElementById('accounts-list').innerHTML = '<div class="card"><p>財務功能開發中...</p></div>';
      document.getElementById('budget-status').innerHTML = '<div class="card"><p>預算功能開發中...</p></div>';
      document.getElementById('my-expenses').innerHTML = '<div class="card"><p>支出記錄開發中...</p></div>';
  }

  async function loadFeedbackData() {
      document.getElementById('my-feedback').innerHTML = '<div class="card"><p>回饋記錄開發中...</p></div>';
  }

  async function loadAdminData() {
      document.getElementById('members-list').innerHTML = '<div class="card"><p>會員管理功能開發中...</p></div>';
      document.getElementById('pending-expenses').innerHTML = '<div class="card"><p>支出審核功能開發中...</p></div>';
  }

  async function submitExpense() {
      showNotification('支出申請功能開發中', 'warning');
  }

  async function submitFeedback() {
      showNotification('回饋提交功能開發中', 'warning');
  }

  async function searchMembers() {
      showNotification('會員搜尋功能開發中', 'warning');
  }

  async function generateReport() {
      showNotification('報表產生功能開發中', 'warning');
  }

  // 新增鍵盤導航支援
  function setupKeyboardNavigation() {
      document.addEventListener('keydown', (e) => {
          if (e.key === 'Tab') {
              document.body.classList.add('keyboard-navigation');
          }
      });

      document.addEventListener('mousedown', () => {
          document.body.classList.remove('keyboard-navigation');
      });
  }

  // 頁面載入完成後初始化
  document.addEventListener('DOMContentLoaded', async () => {
      try {
          await initializeLiff();
          setupSearch();
          setupKeyboardNavigation();
          
          // 設定當前月份為預設值
          const currentDate = new Date();
          const reportMonth = document.getElementById('report-month');
          if (reportMonth) {
              reportMonth.value = currentDate.getMonth() + 1;
          }
          
          // 載入預設分頁資料
          await loadTabData('profile');
          
      } catch (error) {
          console.error('頁面初始化失敗:', error);
          showNotification('系統初始化失敗，請重新整理頁面', 'error');
      }
  });

  // 防止表單提交時頁面重新載入
  document.addEventListener('submit', (e) => {
      e.preventDefault();
  });

  // 新增 Service Worker 支援（PWA）
  if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
              .then((registration) => {
                  console.log('SW registered: ', registration);
              })
              .catch((registrationError) => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }
</script>
</body>
</html>
