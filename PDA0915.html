<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友會管理系統</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
      :root {
          --primary-color: #00B900;
          --secondary-color: #f8f9fa;
          --accent-color: #007bff;
          --danger-color: #dc3545;
          --warning-color: #ffc107;
          --success-color: #28a745;
      }
      
      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background-color: var(--secondary-color);
          margin: 0;
          padding: 0;
      }
      
      .navbar {
          background: linear-gradient(135deg, var(--primary-color), #00a000);
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      .navbar-brand {
          font-weight: bold;
          color: white !important;
      }
      
      .nav-link {
          color: rgba(255,255,255,0.9) !important;
          transition: color 0.3s;
      }
      
      .nav-link:hover {
          color: white !important;
      }
      
      .container-fluid {
          padding: 20px;
      }
      
      .card {
          border: none;
          border-radius: 15px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
          margin-bottom: 20px;
          transition: transform 0.3s, box-shadow 0.3s;
      }
      
      .card:hover {
          transform: translateY(-5px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      }
      
      .card-header {
          background: linear-gradient(135deg, var(--accent-color), #0056b3);
          color: white;
          border-radius: 15px 15px 0 0 !important;
          font-weight: bold;
      }
      
      .btn-primary {
          background: linear-gradient(135deg, var(--primary-color), #00a000);
          border: none;
          border-radius: 25px;
          padding: 10px 25px;
          transition: all 0.3s;
      }
      
      .btn-primary:hover {
          background: linear-gradient(135deg, #00a000, #008000);
          transform: translateY(-2px);
      }
      
      .btn-secondary {
          border-radius: 25px;
          padding: 10px 25px;
      }
      
      .form-control {
          border-radius: 10px;
          border: 2px solid #e9ecef;
          transition: border-color 0.3s;
      }
      
      .form-control:focus {
          border-color: var(--primary-color);
          box-shadow: 0 0 0 0.2rem rgba(0, 185, 0, 0.25);
      }
      
      .table {
          border-radius: 10px;
          overflow: hidden;
      }
      
      .table th {
          background-color: var(--primary-color);
          color: white;
          border: none;
      }
      
      .badge {
          border-radius: 15px;
          padding: 8px 12px;
      }
      
      .loading {
          display: none;
          text-align: center;
          padding: 20px;
      }
      
      .spinner-border {
          color: var(--primary-color);
      }
      
      .alert {
          border-radius: 10px;
          border: none;
      }
      
      .modal-content {
          border-radius: 15px;
      }
      
      .modal-header {
          background: linear-gradient(135deg, var(--accent-color), #0056b3);
          color: white;
          border-radius: 15px 15px 0 0;
      }
      
      .stats-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          text-align: center;
          padding: 30px;
      }
      
      .stats-number {
          font-size: 2.5rem;
          font-weight: bold;
          margin-bottom: 10px;
      }
      
      .activity-card {
          border-left: 5px solid var(--primary-color);
      }
      
      .expense-card {
          border-left: 5px solid var(--warning-color);
      }
      
      .finance-card {
          border-left: 5px solid var(--success-color);
      }
      
      .board-card {
          border-left: 5px solid var(--accent-color);
      }
      
      .hidden {
          display: none !important;
      }
      
      .fade-in {
          animation: fadeIn 0.5s ease-in;
      }
      
      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }
      
      .status-active { color: var(--success-color); }
      .status-pending { color: var(--warning-color); }
      .status-inactive { color: var(--danger-color); }
      
      @media (max-width: 768px) {
          .container-fluid { padding: 10px; }
          .card { margin-bottom: 15px; }
          .stats-number { font-size: 2rem; }
      }
  </style>
</head>
<body>
  <!-- 導航欄 -->
  <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
          <a class="navbar-brand" href="#">
              <i class="fas fa-heart"></i> 帕金森病友會
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
              <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav me-auto">
                  <li class="nav-item">
                      <a class="nav-link" href="#" onclick="showPage('dashboard')">
                          <i class="fas fa-home"></i> 首頁
                      </a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="#" onclick="showPage('profile')">
                          <i class="fas fa-user"></i> 個人資料
                      </a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="#" onclick="showPage('activities')">
                          <i class="fas fa-calendar"></i> 活動
                      </a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="#" onclick="showPage('volunteer')">
                          <i class="fas fa-hands-helping"></i> 志工
                      </a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="#" onclick="showPage('finance')">
                          <i class="fas fa-coins"></i> 財務
                      </a>
                  </li>
                  <li class="nav-item" id="adminNav" style="display: none;">
                      <a class="nav-link" href="#" onclick="showPage('admin')">
                          <i class="fas fa-cog"></i> 管理
                      </a>
                  </li>
                  <li class="nav-item" id="boardNav" style="display: none;">
                      <a class="nav-link" href="#" onclick="showPage('board')">
                          <i class="fas fa-gavel"></i> 理監事
                      </a>
                  </li>
              </ul>
              <ul class="navbar-nav">
                  <li class="nav-item">
                      <span class="navbar-text" id="userInfo">載入中...</span>
                  </li>
              </ul>
          </div>
      </div>
  </nav>

  <!-- 主要內容區域 -->
  <div class="container-fluid">
      <!-- 載入中畫面 -->
      <div id="loading" class="loading">
          <div class="spinner-border" role="status">
              <span class="visually-hidden">載入中...</span>
          </div>
          <p class="mt-3">系統載入中，請稍候...</p>
      </div>

      <!-- 錯誤訊息 -->
      <div id="errorAlert" class="alert alert-danger hidden" role="alert">
          <i class="fas fa-exclamation-triangle"></i>
          <span id="errorMessage"></span>
      </div>

      <!-- 成功訊息 -->
      <div id="successAlert" class="alert alert-success hidden" role="alert">
          <i class="fas fa-check-circle"></i>
          <span id="successMessage"></span>
      </div>

      <!-- 首頁 -->
      <div id="dashboardPage" class="page-content hidden">
          <div class="row">
              <div class="col-12">
                  <h2 class="mb-4">
                      <i class="fas fa-home"></i> 系統首頁
                  </h2>
              </div>
          </div>
          
          <!-- 統計卡片 -->
          <div class="row mb-4">
              <div class="col-md-3 col-sm-6 mb-3">
                  <div class="card stats-card">
                      <div class="stats-number" id="totalActivities">0</div>
                      <div>進行中活動</div>
                  </div>
              </div>
              <div class="col-md-3 col-sm-6 mb-3">
                  <div class="card stats-card">
                      <div class="stats-number" id="myRegistrations">0</div>
                      <div>我的報名</div>
                  </div>
              </div>
              <div class="col-md-3 col-sm-6 mb-3">
                  <div class="card stats-card">
                      <div class="stats-number" id="volunteerHours">0</div>
                      <div>志工時數</div>
                  </div>
              </div>
              <div class="col-md-3 col-sm-6 mb-3">
                  <div class="card stats-card">
                      <div class="stats-number" id="totalDonations">0</div>
                      <div>捐款次數</div>
                  </div>
              </div>
          </div>

          <!-- 最新活動 -->
          <div class="row">
              <div class="col-md-6">
                  <div class="card activity-card">
                      <div class="card-header">
                          <i class="fas fa-calendar-alt"></i> 最新活動
                      </div>
                      <div class="card-body">
                          <div id="recentActivities">載入中...</div>
                      </div>
                  </div>
              </div>
              <div class="col-md-6">
                  <div class="card">
                      <div class="card-header">
                          <i class="fas fa-bell"></i> 系統公告
                      </div>
                      <div class="card-body">
                          <div id="systemAnnouncements">
                              <p><i class="fas fa-info-circle text-info"></i> 歡迎使用帕金森病友會管理系統</p>
                              <p><i class="fas fa-heart text-danger"></i> 感謝您的參與和支持</p>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- 個人資料頁面 -->
      <div id="profilePage" class="page-content hidden">
          <div class="row">
              <div class="col-12">
                  <h2 class="mb-4">
                      <i class="fas fa-user"></i> 個人資料
                  </h2>
              </div>
          </div>
          
          <div class="row">
              <div class="col-md-8">
                  <div class="card">
                      <div class="card-header">
                          <i class="fas fa-edit"></i> 編輯個人資料
                      </div>
                      <div class="card-body">
                          <form id="profileForm">
                              <div class="row">
                                  <div class="col-md-6 mb-3">
                                      <label class="form-label">LINE名稱</label>
                                      <input type="text" class="form-control" id="lineName" readonly>
                                  </div>
                                  <div class="col-md-6 mb-3">
                                      <label class="form-label">真實姓名 *</label>
                                      <input type="text" class="form-control" id="realName" required>
                                  </div>
                              </div>
                              <div class="row">
                                  <div class="col-md-6 mb-3">
                                      <label class="form-label">電話</label>
                                      <input type="tel" class="form-control" id="phone">
                                  </div>
                                  <div class="col-md-6 mb-3">
                                      <label class="form-label">Email</label>
                                      <input type="email" class="form-control" id="email">
                                  </div>
                              </div>
                              <div class="row">
                                  <div class="col-md-6 mb-3">
                                      <label class="form-label">生日</label>
                                      <input type="date" class="form-control" id="birthday">
                                  </div>
                                  <div class="col-md-6 mb-3">
                                      <label class="form-label">會員類型</label>
                                      <select class="form-control" id="memberType">
                                          <option value="病友">病友</option>
                                          <option value="家屬">家屬</option>
                                          <option value="志工">志工</option>
                                          <option value="醫護">醫護人員</option>
                                      </select>
                                  </div>
                              </div>
                              <div class="mb-3">
                                  <label class="form-label">地址</label>
                                  <textarea class="form-control" id="address" rows="2"></textarea>
                              </div>
                              <button type="submit" class="btn btn-primary">
                                  <i class="fas fa-save"></i> 儲存變更
                              </button>
                          </form>
                      </div>
                  </div>
              </div>
              <div class="col-md-4">
                  <div class="card">
                      <div class="card-header">
                          <i class="fas fa-info-circle"></i> 會員資訊
                      </div>
                      <div class="card-body">
                          <p><strong>會員狀態：</strong> <span id="memberStatus" class="badge bg-success">已註冊</span></p>
                          <p><strong>註冊日期：</strong> <span id="registerDate">-</span></p>
                          <p><strong>志工時數：</strong> <span id="profileVolunteerHours">0</span> 小時</p>
                          <p><strong>參與活動：</strong> <span id="activityCount">0</span> 次</p>
                          <p><strong>最後活動：</strong> <span id="lastActive">-</span></p>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- 活動頁面 -->
      <div id="activitiesPage" class="page-content hidden">
          <div class="row">
              <div class="col-12">
                  <h2 class="mb-4">
                      <i class="fas fa-calendar"></i> 活動管理
                  </h2>
              </div>
          </div>
          
          <!-- 活動篩選 -->
          <div class="card mb-4">
              <div class="card-body">
                  <div class="row">
                      <div class="col-md-3">
                          <select class="form-control" id="activityStatusFilter">
                              <option value="">所有狀態</option>
                              <option value="開放報名">開放報名</option>
                              <option value="報名截止">報名截止</option>
                              <option value="已結束">已結束</option>
                          </select>
                      </div>
                      <div class="col-md-3">
                          <input type="date" class="form-control" id="activityDateFilter">
                      </div>
                      <div class="col-md-4">
                          <input type="text" class="form-control" id="activitySearchFilter" placeholder="搜尋活動名稱...">
                      </div>
                      <div class="col-md-2">
                          <button class="btn btn-primary w-100" onclick="filterActivities()">
                              <i class="fas fa-search"></i> 搜尋
                          </button>
                      </div>
                  </div>
              </div>
          </div>

          <!-- 活動列表 -->
          <div id="activitiesList">
              <div class="text-center">
                  <div class="spinner-border" role="status">
                      <span class="visually-hidden">載入中...</span>
                  </div>
              </div>
          </div>

          <!-- 我的報名 -->
          <div class="card mt-4">
              <div class="card-header">
                  <i class="fas fa-list"></i> 我的活動報名
              </div>
              <div class="card-body">
                  <div id="myRegistrationsList">載入中...</div>
              </div>
          </div>
      </div>

      <!-- 志工頁面 -->
      <div id="volunteerPage" class="page-content hidden">
          <div class="row">
              <div class="col-12">
                  <h2 class="mb-4">
                      <i class="fas fa-hands-helping"></i> 志工服務
                  </h2>
              </div>
          </div>
          
          <div class="row">
              <div class="col-md-8">
                  <!-- 志工需求 -->
                  <div class="card mb-4">
                      <div class="card-header">
                          <i class="fas fa-bullhorn"></i> 志工需求
                      </div>
                      <div class="card-body">
                          <div id="volunteerNeedsList">載入中...</div>
                      </div>
                  </div>

                  <!-- 我的志工記錄 -->
                  <div class="card">
                      <div class="card-header">
                          <i class="fas fa-history"></i> 我的志工記錄
                      </div>
                      <div class="card-body">
                          <div id="myVolunteerRecords">載入中...</div>
                      </div>
                  </div>
              </div>
              <div class="col-md-4">
                  <div class="card">
                      <div class="card-header">
                          <i class="fas fa-chart-bar"></i> 志工統計
                      </div>
                      <div class="card-body text-center">
                          <div class="mb-3">
                              <h3 id="totalVolunteerHours" class="text-primary">0</h3>
                              <small class="text-muted">總志工時數</small>
                          </div>
                          <div class="mb-3">
                              <h3 id="volunteerCount" class="text-success">0</h3>
                              <small class="text-muted">服務次數</small>
                          </div>
                          <div class="mb-3">
                              <h3 id="pendingHours" class="text-warning">0</h3>
                              <small class="text-muted">待審核時數</small>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- 財務頁面 -->
      <div id="financePage" class="page-content hidden">
          <div class="row">
              <div class="col-12">
                  <h2 class="mb-4">
                      <i class="fas fa-coins"></i> 財務管理
                  </h2>
              </div>
          </div>
          
          <div class="row">
              <div class="col-md-6">
                  <!-- 捐款記錄 -->
                  <div class="card finance-card mb-4">
                      <div class="card-header">
                          <i class="fas fa-heart"></i> 我的捐款記錄
                          <button class="btn btn-sm btn-light float-end" onclick="showDonationModal()">
                              <i class="fas fa-plus"></i> 新增捐款
                          </button>
                      </div>
                      <div class="card-body">
                          <div id="myDonationsList">載入中...</div>
                      </div>
                  </div>
              </div>
              <div class="col-md-6">
                  <!-- 支出申請 -->
                  <div class="card expense-card mb-4">
                      <div class="card-header">
                          <i class="fas fa-receipt"></i> 我的支出申請
                          <button class="btn btn-sm btn-light float-end" onclick="showExpenseModal()">
                              <i class="fas fa-plus"></i> 申請支出
                          </button>
                      </div>
                      <div class="card-body">
                          <div id="myExpensesList">載入中...</div>
                      </div>
                  </div>
              </div>
          </div>

          <!-- 財務概覽 -->
          <div class="card" id="financeOverview" style="display: none;">
              <div class="card-header">
                  <i class="fas fa-chart-pie"></i> 財務概覽
              </div>
              <div class="card-body">
                  <div class="row text-center">
                      <div class="col-md-3">
                          <h4 id="totalIncome" class="text-success">$0</h4>
                          <small>總收入</small>
                      </div>
                      <div class="col-md-3">
                          <h4 id="totalExpense" class="text-danger">$0</h4>
                          <small>總支出</small>
                      </div>
                      <div class="col-md-3">
                          <h4 id="currentBalance" class="text-primary">$0</h4>
                          <small>目前餘額</small>
                      </div>
                      <div class="col-md-3">
                          <h4 id="donationCount" class="text-info">0</h4>
                          <small>捐款筆數</small>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- 管理頁面 -->
      <div id="adminPage" class="page-content hidden">
          <div class="row">
              <div class="col-12">
                  <h2 class="mb-4">
                      <i class="fas fa-cog"></i> 系統管理
                  </h2>
              </div>
          </div>
          
          <!-- 管理功能選單 -->
          <div class="row mb-4">
              <div class="col-md-3">
                  <div class="card text-center" onclick="showAdminSection('members')">
                      <div class="card-body">
                          <i class="fas fa-users fa-3x text-primary mb-3"></i>
                          <h5>會員管理</h5>
                      </div>
                  </div>
              </div>
              <div class="col-md-3">
                  <div class="card text-center" onclick="showAdminSection('activities')">
                      <div class="card-body">
                          <i class="fas fa-calendar-plus fa-3x text-success mb-3"></i>
                          <h5>活動管理</h5>
                      </div>
                  </div>
              </div>
              <div class="col-md-3">
                  <div class="card text-center" onclick="showAdminSection('finance')">
                      <div class="card-body">
                          <i class="fas fa-chart-line fa-3x text-warning mb-3"></i>
                          <h5>財務管理</h5>
                      </div>
                  </div>
              </div>
              <div class="col-md-3">
                  <div class="card text-center" onclick="showAdminSection('system')">
                      <div class="card-body">
                          <i class="fas fa-server fa-3x text-info mb-3"></i>
                          <h5>系統設定</h5>
                      </div>
                  </div>
              </div>
          </div>

          <!-- 管理內容區域 -->
          <div id="adminContent">
              <div class="card">
                  <div class="card-body text-center">
                      <i class="fas fa-mouse-pointer fa-3x text-muted mb-3"></i>
                      <p class="text-muted">請選擇上方功能進行管理</p>
                  </div>
              </div>
          </div>
      </div>

      <!-- 理監事頁面 -->
      <div id="boardPage" class="page-content hidden">
          <div class="row">
              <div class="col-12">
                  <h2 class="mb-4">
                      <i class="fas fa-gavel"></i> 理監事專區
                  </h2>
              </div>
          </div>
          
          <!-- 理監事功能選單 -->
          <div class="row mb-4">
              <div class="col-md-3">
                  <div class="card board-card text-center" onclick="showBoardSection('meetings')">
                      <div class="card-body">
                          <i class="fas fa-users fa-3x text-primary mb-3"></i>
                          <h5>會議管理</h5>
                      </div>
                  </div>
              </div>
              <div class="col-md-3">
                  <div class="card board-card text-center" onclick="showBoardSection('proposals')">
                      <div class="card-body">
                          <i class="fas fa-lightbulb fa-3x text-success mb-3"></i>
                          <h5>提案管理</h5>
                      </div>
                  </div>
              </div>
              <div class="col-md-3">
                  <div class="card board-card text-center" onclick="showBoardSection('cases')">
                      <div class="card-body">
                          <i class="fas fa-folder-open fa-3x text-warning mb-3"></i>
                          <h5>案件管理</h5>
                      </div>
                  </div>
              </div>
              <div class="col-md-3">
                  <div class="card board-card text-center" onclick="showBoardSection('decisions')">
                      <div class="card-body">
                          <i class="fas fa-balance-scale fa-3x text-info mb-3"></i>
                          <h5>決議記錄</h5>
                      </div>
                  </div>
              </div>
          </div>

          <!-- 理監事內容區域 -->
          <div id="boardContent">
              <div class="card">
                  <div class="card-body text-center">
                      <i class="fas fa-mouse-pointer fa-3x text-muted mb-3"></i>
                      <p class="text-muted">請選擇上方功能進行管理</p>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- 捐款Modal -->
  <div class="modal fade" id="donationModal" tabindex="-1">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="fas fa-heart"></i> 新增捐款記錄
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="donationForm">
                      <div class="mb-3">
                          <label class="form-label">捐款金額 *</label>
                          <input type="number" class="form-control" id="donationAmount" required min="1">
                      </div>
                      <div class="mb-3">
                          <label class="form-label">捐款方式</label>
                          <select class="form-control" id="donationMethod">
                              <option value="現金">現金</option>
                              <option value="轉帳">銀行轉帳</option>
                              <option value="信用卡">信用卡</option>
                              <option value="支票">支票</option>
                          </select>
                      </div>
                      <div class="mb-3">
                          <label class="form-label">捐款日期</label>
                          <input type="date" class="form-control" id="donationDate" required>
                      </div>
                      <div class="mb-3">
                          <label class="form-label">備註</label>
                          <textarea class="form-control" id="donationNote" rows="3"></textarea>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="submitDonation()">
                      <i class="fas fa-save"></i> 提交
                  </button>
              </div>
          </div>
      </div>
  </div>

  <!-- 支出申請Modal -->
  <div class="modal fade" id="expenseModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="fas fa-receipt"></i> 支出申請
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="expenseForm">
                      <div class="row">
                          <div class="col-md-6 mb-3">
                              <label class="form-label">支出項目 *</label>
                              <input type="text" class="form-control" id="expenseItem" required>
                          </div>
                          <div class="col-md-6 mb-3">
                              <label class="form-label">金額 *</label>
                              <input type="number" class="form-control" id="expenseAmount" required min="1">
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6 mb-3">
                              <label class="form-label">類別</label>
                              <select class="form-control" id="expenseCategory">
                                  <option value="活動費用">活動費用</option>
                                  <option value="辦公用品">辦公用品</option>
                                  <option value="交通費">交通費</option>
                                  <option value="餐飲費">餐飲費</option>
                                  <option value="設備費">設備費</option>
                                  <option value="其他">其他</option>
                              </select>
                          </div>
                          <div class="col-md-6 mb-3">
                              <label class="form-label">支出日期</label>
                              <input type="date" class="form-control" id="expenseDate" required>
                          </div>
                      </div>
                      <div class="mb-3">
                          <label class="form-label">說明</label>
                          <textarea class="form-control" id="expenseDescription" rows="3"></textarea>
                      </div>
                      <div class="mb-3">
                          <label class="form-label">收據/發票</label>
                          <input type="file" class="form-control" id="expenseReceipt" accept="image/*,.pdf">
                          <small class="text-muted">支援圖片或PDF檔案</small>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="submitExpense()">
                      <i class="fas fa-paper-plane"></i> 提交申請
                  </button>
              </div>
          </div>
      </div>
  </div>

  <!-- 活動詳情Modal -->
  <div class="modal fade" id="activityDetailModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="activityDetailTitle">活動詳情</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="activityDetailContent">
                  <!-- 活動詳情內容 -->
              </div>
              <div class="modal-footer" id="activityDetailFooter">
                  <!-- 操作按鈕 -->
              </div>
          </div>
      </div>
  </div>

  <!-- 志工報名Modal -->
  <div class="modal fade" id="volunteerModal" tabindex="-1">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="fas fa-hands-helping"></i> 志工報名
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="volunteerForm">
                      <input type="hidden" id="volunteerActivityId">
                      <div class="mb-3">
                          <label class="form-label">服務時數 *</label>
                          <input type="number" class="form-control" id="volunteerHours" required min="0.5" step="0.5">
                      </div>
                      <div class="mb-3">
                          <label class="form-label">服務內容</label>
                          <textarea class="form-control" id="volunteerTask" rows="3" placeholder="請描述您的服務內容..."></textarea>
                      </div>
                      <div class="mb-3">
                          <label class="form-label">備註</label>
                          <textarea class="form-control" id="volunteerNote" rows="2"></textarea>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="submitVolunteer()">
                      <i class="fas fa-check"></i> 確認報名
                  </button>
              </div>
          </div>
      </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
      // 全域變數
      let currentUser = null;
      let liffId = '1656516134-VaGgmaPm'; // 請替換為實際的LIFF ID
      let apiUrl = 'https://script.google.com/macros/s/AKfycbz-lwvCaK0Rvu9vSld_HfOVBIjCUclGDTT48GJ0NZNU4EzwBmlr2IWC3wChoZxmVH1tFg/exec'; // 請替換為實際的GAS API URL
      let currentPage = 'dashboard';

      // LIFF初始化
      async function initializeLiff() {
          try {
              showLoading(true);
              await liff.init({ liffId: liffId });
              
              if (!liff.isLoggedIn()) {
                  liff.login();
                  return;
              }

              const profile = await liff.getProfile();
              await registerOrUpdateUser(profile);
              await loadUserProfile();
              await loadDashboard();
              
              showLoading(false);
              showPage('dashboard');
              
          } catch (error) {
              console.error('LIFF初始化失敗:', error);
              showError('系統初始化失敗，請重新整理頁面');
              showLoading(false);
          }
      }

      // API呼叫函數
      async function callAPI(action, data = {}) {
          try {
              const response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: action,
                      ...data
                  })
              });

              const result = await response.json();
              
              if (!result.success) {
                  throw new Error(result.message || '操作失敗');
              }
              
              return result.data;
              
          } catch (error) {
              console.error('API呼叫失敗:', error);
              throw error;
          }
      }

      // 用戶註冊或更新
      async function registerOrUpdateUser(profile) {
          try {
              const data = await callAPI('register', {
                  lineId: profile.userId,
                  lineName: profile.displayName,
                  realName: profile.displayName
              });
              
              currentUser = data;
              updateUserInfo();
              
          } catch (error) {
              console.error('用戶註冊失敗:', error);
              showError('用戶註冊失敗: ' + error.message);
          }
      }

      // 載入用戶資料
      async function loadUserProfile() {
          try {
              const profile = await liff.getProfile();
              const data = await callAPI('getProfile', {
                  lineId: profile.userId
              });
              
              currentUser = data;
              updateUserInfo();
              fillProfileForm(data);
              
          } catch (error) {
              console.error('載入用戶資料失敗:', error);
          }
      }

      // 更新用戶資訊顯示
      function updateUserInfo() {
          if (currentUser) {
              document.getElementById('userInfo').textContent = 
                  `${currentUser.realName || currentUser.lineName} (${currentUser.memberType || '一般會員'})`;
              
              // 顯示管理選單
              if (currentUser.isAdmin) {
                  document.getElementById('adminNav').style.display = 'block';
              }
              if (currentUser.isBoardMember) {
                  document.getElementById('boardNav').style.display = 'block';
              }
          }
      }

      // 填充個人資料表單
      function fillProfileForm(data) {
          if (!data) return;
          
          document.getElementById('lineName').value = data.lineName || '';
          document.getElementById('realName').value = data.realName || '';
          document.getElementById('phone').value = data.phone || '';
          document.getElementById('email').value = data.email || '';
          document.getElementById('birthday').value = data.birthday || '';
          document.getElementById('memberType').value = data.memberType || '病友';
          document.getElementById('address').value = data.address || '';
          
          // 更新會員資訊
          document.getElementById('memberStatus').textContent = data.status || '已註冊';
          document.getElementById('registerDate').textContent = formatDate(data.registerDate);
          document.getElementById('profileVolunteerHours').textContent = data.volunteerHours || 0;
          document.getElementById('activityCount').textContent = data.activityCount || 0;
          document.getElementById('lastActive').textContent = formatDate(data.lastActive);
      }

      // 載入儀表板
      async function loadDashboard() {
          try {
              const profile = await liff.getProfile();
              
              // 載入統計資料
              const activities = await callAPI('getActivities', { lineId: profile.userId });
              const registrations = await callAPI('getMyRegistrations', { lineId: profile.userId });
              const volunteerRecords = await callAPI('getMyVolunteerRecords', { lineId: profile.userId });
              const donations = await callAPI('getDonations', { lineId: profile.userId });
              
              // 更新統計卡片
              document.getElementById('totalActivities').textContent = 
                  activities.filter(a => a.status === '開放報名').length;
              document.getElementById('myRegistrations').textContent = 
                  registrations.filter(r => r.status === '已報名').length;
              document.getElementById('volunteerHours').textContent = 
                  volunteerRecords.reduce((sum, r) => sum + (r.hours || 0), 0);
              document.getElementById('totalDonations').textContent = donations.length;
              
              // 載入最新活動
              loadRecentActivities(activities.slice(0, 5));
              
          } catch (error) {
              console.error('載入儀表板失敗:', error);
          }
      }

      // 載入最新活動
      function loadRecentActivities(activities) {
          const container = document.getElementById('recentActivities');
          
          if (!activities || activities.length === 0) {
              container.innerHTML = '<p class="text-muted">目前沒有活動</p>';
              return;
          }
          
          let html = '';
          activities.forEach(activity => {
              const statusClass = getStatusClass(activity.status);
              html += `
                  <div class="border-bottom pb-2 mb-2">
                      <div class="d-flex justify-content-between align-items-start">
                          <div>
                              <h6 class="mb-1">${activity.name}</h6>
                              <small class="text-muted">
                                  <i class="fas fa-calendar"></i> ${formatDate(activity.activityDate)}
                                  <i class="fas fa-map-marker-alt ms-2"></i> ${activity.location}
                              </small>
                          </div>
                          <span class="badge ${statusClass}">${activity.status}</span>
                      </div>
                  </div>
              `;
          });
          
          container.innerHTML = html;
      }

      // 載入活動列表
      async function loadActivities() {
          try {
              showLoading(true);
              const profile = await liff.getProfile();
              const activities = await callAPI('getActivities', { lineId: profile.userId });
              const registrations = await callAPI('getMyRegistrations', { lineId: profile.userId });
              
              displayActivities(activities);
              displayMyRegistrations(registrations);
              showLoading(false);
              
          } catch (error) {
              console.error('載入活動失敗:', error);
              showError('載入活動失敗: ' + error.message);
              showLoading(false);
          }
      }

      // 顯示活動列表
      function displayActivities(activities) {
          const container = document.getElementById('activitiesList');
          
          if (!activities || activities.length === 0) {
              container.innerHTML = `
                  <div class="card">
                      <div class="card-body text-center">
                          <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                          <p class="text-muted">目前沒有活動</p>
                      </div>
                  </div>
              `;
              return;
          }
          
          let html = '';
          activities.forEach(activity => {
              const statusClass = getStatusClass(activity.status);
              const isRegistrationOpen = activity.status === '開放報名';
              const isFull = activity.currentCount >= activity.maxParticipants;
              
              html += `
                  <div class="card activity-card mb-3 fade-in">
                      <div class="card-body">
                          <div class="row">
                              <div class="col-md-8">
                                  <h5 class="card-title">${activity.name}</h5>
                                  <p class="card-text text-muted">${activity.description}</p>
                                  <div class="row">
                                      <div class="col-sm-6">
                                          <small class="text-muted">
                                              <i class="fas fa-calendar"></i> ${formatDate(activity.activityDate)}
                                          </small>
                                      </div>
                                      <div class="col-sm-6">
                                          <small class="text-muted">
                                              <i class="fas fa-map-marker-alt"></i> ${activity.location}
                                          </small>
                                      </div>
                                  </div>
                                  <div class="row mt-2">
                                      <div class="col-sm-6">
                                          <small class="text-muted">
                                              <i class="fas fa-users"></i> ${activity.currentCount}/${activity.maxParticipants}
                                          </small>
                                      </div>
                                      <div class="col-sm-6">
                                          <small class="text-muted">
                                              <i class="fas fa-dollar-sign"></i> $${activity.fee || 0}
                                          </small>
                                      </div>
                                  </div>
                              </div>
                              <div class="col-md-4 text-end">
                                  <span class="badge ${statusClass} mb-2">${activity.status}</span>
                                  <div>
                                      <button class="btn btn-outline-primary btn-sm me-2" 
                                              onclick="showActivityDetail('${activity.id}')">
                                          <i class="fas fa-info-circle"></i> 詳情
                                      </button>
                                      ${isRegistrationOpen && !isFull ? 
                                          `<button class="btn btn-primary btn-sm" 
                                                   onclick="registerForActivity('${activity.id}')">
                                              <i class="fas fa-plus"></i> 報名
                                           </button>` : 
                                          (isFull ? '<span class="text-danger">已額滿</span>' : '')
                                      }
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              `;
          });
          
          container.innerHTML = html;
      }

      // 顯示我的報名
      function displayMyRegistrations(registrations) {
          const container = document.getElementById('myRegistrationsList');
          
          if (!registrations || registrations.length === 0) {
              container.innerHTML = '<p class="text-muted">您尚未報名任何活動</p>';
              return;
          }
          
          let html = '<div class="table-responsive"><table class="table table-striped">';
          html += '<thead><tr><th>活動名稱</th><th>活動日期</th><th>狀態</th><th>操作</th></tr></thead><tbody>';
          
          registrations.forEach(reg => {
              const statusClass = getStatusClass(reg.status);
              html += `
                  <tr>
                      <td>${reg.activityName}</td>
                      <td>${formatDate(reg.activityDate)}</td>
                      <td><span class="badge ${statusClass}">${reg.status}</span></td>
                      <td>
                          ${reg.status === '已報名' ? 
                              `<button class="btn btn-danger btn-sm" 
                                       onclick="cancelRegistration('${reg.id}')">
                                  <i class="fas fa-times"></i> 取消
                               </button>` : 
                              '-'
                          }
                      </td>
                  </tr>
              `;
          });
          
          html += '</tbody></table></div>';
          container.innerHTML = html;
      }

      // 載入志工資料
      async function loadVolunteerData() {
          try {
              showLoading(true);
              const profile = await liff.getProfile();
              
              const needs = await callAPI('getVolunteerNeeds', { lineId: profile.userId });
              const records = await callAPI('getMyVolunteerRecords', { lineId: profile.userId });
              
              displayVolunteerNeeds(needs);
              displayVolunteerRecords(records);
              updateVolunteerStats(records);
              
              showLoading(false);
              
          } catch (error) {
              console.error('載入志工資料失敗:', error);
              showError('載入志工資料失敗: ' + error.message);
              showLoading(false);
          }
      }

      // 顯示志工需求
      function displayVolunteerNeeds(needs) {
          const container = document.getElementById('volunteerNeedsList');
          
          if (!needs || needs.length === 0) {
              container.innerHTML = '<p class="text-muted">目前沒有志工需求</p>';
              return;
          }
          
          let html = '';
          needs.forEach(need => {
              html += `
                  <div class="border-bottom pb-3 mb-3">
                      <div class="d-flex justify-content-between align-items-start">
                          <div>
                              <h6 class="mb-1">${need.activityName}</h6>
                              <p class="text-muted mb-1">${need.description}</p>
                              <small class="text-muted">
                                  <i class="fas fa-calendar"></i> ${formatDate(need.activityDate)}
                                  <i class="fas fa-clock ms-2"></i> 需要 ${need.requiredHours} 小時
                              </small>
                          </div>
                          <button class="btn btn-primary btn-sm" 
                                  onclick="registerVolunteer('${need.activityId}')">
                              <i class="fas fa-hand-paper"></i> 報名
                          </button>
                      </div>
                  </div>
              `;
          });
          
          container.innerHTML = html;
      }

      // 顯示志工記錄
      function displayVolunteerRecords(records) {
          const container = document.getElementById('myVolunteerRecords');
          
          if (!records || records.length === 0) {
              container.innerHTML = '<p class="text-muted">您尚未有志工服務記錄</p>';
              return;
          }
          
          let html = '<div class="table-responsive"><table class="table table-striped">';
          html += '<thead><tr><th>活動</th><th>服務時數</th><th>狀態</th><th>日期</th></tr></thead><tbody>';
          
          records.forEach(record => {
              const statusClass = record.status === '已核准' ? 'bg-success' : 
                                record.status === '待審核' ? 'bg-warning' : 'bg-danger';
              html += `
                  <tr>
                      <td>${record.activityName}</td>
                      <td>${record.hours} 小時</td>
                      <td><span class="badge ${statusClass}">${record.status}</span></td>
                      <td>${formatDate(record.serviceDate)}</td>
                  </tr>
              `;
          });
          
          html += '</tbody></table></div>';
          container.innerHTML = html;
      }

      // 更新志工統計
      function updateVolunteerStats(records) {
          const totalHours = records.filter(r => r.status === '已核准')
                                  .reduce((sum, r) => sum + (r.hours || 0), 0);
          const pendingHours = records.filter(r => r.status === '待審核')
                                     .reduce((sum, r) => sum + (r.hours || 0), 0);
          const volunteerCount = records.filter(r => r.status === '已核准').length;
          
          document.getElementById('totalVolunteerHours').textContent = totalHours;
          document.getElementById('volunteerCount').textContent = volunteerCount;
          document.getElementById('pendingHours').textContent = pendingHours;
      }

      // 載入財務資料
      async function loadFinanceData() {
          try {
              showLoading(true);
              const profile = await liff.getProfile();
              
              const donations = await callAPI('getDonations', { lineId: profile.userId });
              const expenses = await callAPI('getMyExpenses', { lineId: profile.userId });
              
              displayDonations(donations);
              displayExpenses(expenses);
              
              // 如果是管理員，載入財務概覽
              if (currentUser && currentUser.isAdmin) {
                  const overview = await callAPI('getFinanceOverview', { 
                      operatorLineId: profile.userId 
                  });
                  displayFinanceOverview(overview);
              }
              
              showLoading(false);
              
          } catch (error) {
              console.error('載入財務資料失敗:', error);
              showError('載入財務資料失敗: ' + error.message);
              showLoading(false);
          }
      }

      // 顯示捐款記錄
      function displayDonations(donations) {
          const container = document.getElementById('myDonationsList');
          
          if (!donations || donations.length === 0) {
              container.innerHTML = '<p class="text-muted">您尚未有捐款記錄</p>';
              return;
          }
          
          let html = '<div class="table-responsive"><table class="table table-striped">';
          html += '<thead><tr><th>金額</th><th>方式</th><th>日期</th><th>收據</th></tr></thead><tbody>';
          
          donations.forEach(donation => {
              html += `
                  <tr>
                      <td>$${donation.amount.toLocaleString()}</td>
                      <td>${donation.method}</td>
                      <td>${formatDate(donation.donationDate)}</td>
                      <td>
                          ${donation.receiptNumber ? 
                              `<button class="btn btn-outline-primary btn-sm" 
                                       onclick="viewReceipt('${donation.receiptNumber}')">
                                  <i class="fas fa-file-alt"></i> 查看
                               </button>` : 
                              '-'
                          }
                      </td>
                  </tr>
              `;
          });
          
          html += '</tbody></table></div>';
          container.innerHTML = html;
      }

      // 顯示支出記錄
      function displayExpenses(expenses) {
          const container = document.getElementById('myExpensesList');
          
          if (!expenses || expenses.length === 0) {
              container.innerHTML = '<p class="text-muted">您尚未有支出申請記錄</p>';
              return;
          }
          
          let html = '<div class="table-responsive"><table class="table table-striped">';
          html += '<thead><tr><th>項目</th><th>金額</th><th>狀態</th><th>日期</th></tr></thead><tbody>';
          
          expenses.forEach(expense => {
              const statusClass = expense.status === '已核准' ? 'bg-success' : 
                                expense.status === '待審核' ? 'bg-warning' : 'bg-danger';
              html += `
                  <tr>
                      <td>${expense.item}</td>
                      <td>$${expense.amount.toLocaleString()}</td>
                      <td><span class="badge ${statusClass}">${expense.status}</span></td>
                      <td>${formatDate(expense.submitDate)}</td>
                  </tr>
              `;
          });
          
          html += '</tbody></table></div>';
          container.innerHTML = html;
      }

      // 顯示財務概覽
      function displayFinanceOverview(overview) {
          if (!overview) return;
          
          document.getElementById('totalIncome').textContent = '$' + (overview.totalIncome || 0).toLocaleString();
          document.getElementById('totalExpense').textContent = '$' + (overview.totalExpense || 0).toLocaleString();
          document.getElementById('currentBalance').textContent = '$' + (overview.balance || 0).toLocaleString();
          document.getElementById('donationCount').textContent = overview.donationCount || 0;
          
          document.getElementById('financeOverview').style.display = 'block';
      }

      // 事件處理函數
      async function submitProfile() {
          try {
              const profile = await liff.getProfile();
              const formData = {
                  lineId: profile.userId,
                  realName: document.getElementById('realName').value,
                  phone: document.getElementById('phone').value,
                  email: document.getElementById('email').value,
                  birthday: document.getElementById('birthday').value,
                  memberType: document.getElementById('memberType').value,
                  address: document.getElementById('address').value
              };
              
              await callAPI('updateProfile', formData);
              showSuccess('個人資料更新成功');
              await loadUserProfile();
              
          } catch (error) {
              showError('更新個人資料失敗: ' + error.message);
          }
      }

      async function registerForActivity(activityId) {
          try {
              const profile = await liff.getProfile();
              await callAPI('registerActivity', {
                  lineId: profile.userId,
                  activityId: activityId
              });
              
              showSuccess('活動報名成功');
              await loadActivities();
              
          } catch (error) {
              showError('活動報名失敗: ' + error.message);
          }
      }

      async function cancelRegistration(registrationId) {
          if (!confirm('確定要取消報名嗎？')) return;
          
          try {
              const profile = await liff.getProfile();
              await callAPI('cancelActivity', {
                  lineId: profile.userId,
                  registrationId: registrationId
              });
              
              showSuccess('取消報名成功');
              await loadActivities();
              
          } catch (error) {
              showError('取消報名失敗: ' + error.message);
          }
      }

      async function showActivityDetail(activityId) {
          try {
              const profile = await liff.getProfile();
              const activities = await callAPI('getActivities', { lineId: profile.userId });
              const activity = activities.find(a => a.id === activityId);
              
              if (!activity) {
                  showError('找不到活動資料');
                  return;
              }
              
              document.getElementById('activityDetailTitle').textContent = activity.name;
              document.getElementById('activityDetailContent').innerHTML = `
                  <div class="row">
                      <div class="col-md-6">
                          <p><strong>活動日期：</strong> ${formatDate(activity.activityDate)}</p>
                          <p><strong>活動地點：</strong> ${activity.location}</p>
                          <p><strong>報名人數：</strong> ${activity.currentCount}/${activity.maxParticipants}</p>
                          <p><strong>活動費用：</strong> $${activity.fee || 0}</p>
                      </div>
                      <div class="col-md-6">
                          <p><strong>活動狀態：</strong> <span class="badge ${getStatusClass(activity.status)}">${activity.status}</span></p>
                          <p><strong>建立者：</strong> ${activity.creator}</p>
                          <p><strong>建立日期：</strong> ${formatDate(activity.createDate)}</p>
                          <p><strong>需要志工：</strong> ${activity.needVolunteer ? '是' : '否'}</p>
                      </div>
                  </div>
                  <div class="mt-3">
                      <h6>活動說明：</h6>
                      <p>${activity.description}</p>
                  </div>
              `;
              
              const isRegistrationOpen = activity.status === '開放報名';
              const isFull = activity.currentCount >= activity.maxParticipants;
              
              document.getElementById('activityDetailFooter').innerHTML = `
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                  ${isRegistrationOpen && !isFull ? 
                      `<button type="button" class="btn btn-primary" onclick="registerForActivity('${activity.id}')" data-bs-dismiss="modal">
                          <i class="fas fa-plus"></i> 立即報名
                       </button>` : ''
                  }
                  ${activity.needVolunteer ? 
                      `<button type="button" class="btn btn-success" onclick="showVolunteerModal('${activity.id}')" data-bs-dismiss="modal">
                          <i class="fas fa-hands-helping"></i> 志工報名
                       </button>` : ''
                  }
              `;
              
              new bootstrap.Modal(document.getElementById('activityDetailModal')).show();
              
          } catch (error) {
              showError('載入活動詳情失敗: ' + error.message);
          }
      }

      function showVolunteerModal(activityId) {
          document.getElementById('volunteerActivityId').value = activityId;
          new bootstrap.Modal(document.getElementById('volunteerModal')).show();
      }

      async function submitVolunteer() {
          try {
              const profile = await liff.getProfile();
              const formData = {
                  lineId: profile.userId,
                  activityId: document.getElementById('volunteerActivityId').value,
                  hours: parseFloat(document.getElementById('volunteerHours').value),
                  task: document.getElementById('volunteerTask').value,
                  note: document.getElementById('volunteerNote').value
              };
              
              await callAPI('registerVolunteer', formData);
              showSuccess('志工報名成功，等待審核');
              
              bootstrap.Modal.getInstance(document.getElementById('volunteerModal')).hide();
              document.getElementById('volunteerForm').reset();
              
              if (currentPage === 'volunteer') {
                  await loadVolunteerData();
              }
              
          } catch (error) {
              showError('志工報名失敗: ' + error.message);
          }
      }

      function showDonationModal() {
          document.getElementById('donationDate').value = new Date().toISOString().split('T')[0];
          new bootstrap.Modal(document.getElementById('donationModal')).show();
      }

      async function submitDonation() {
          try {
              const profile = await liff.getProfile();
              const formData = {
                  lineId: profile.userId,
                  amount: parseInt(document.getElementById('donationAmount').value),
                  method: document.getElementById('donationMethod').value,
                  donationDate: document.getElementById('donationDate').value,
                  note: document.getElementById('donationNote').value
              };
              
              await callAPI('addDonation', formData);
              showSuccess('捐款記錄新增成功');
              
              bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
              document.getElementById('donationForm').reset();
              
              if (currentPage === 'finance') {
                  await loadFinanceData();
              }
              
          } catch (error) {
              showError('新增捐款記錄失敗: ' + error.message);
          }
      }

      function showExpenseModal() {
          document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
          new bootstrap.Modal(document.getElementById('expenseModal')).show();
      }

      async function submitExpense() {
          try {
              const profile = await liff.getProfile();
              const formData = {
                  lineId: profile.userId,
                  item: document.getElementById('expenseItem').value,
                  amount: parseInt(document.getElementById('expenseAmount').value),
                  category: document.getElementById('expenseCategory').value,
                  expenseDate: document.getElementById('expenseDate').value,
                  description: document.getElementById('expenseDescription').value
              };
              
              // 處理收據上傳（簡化版本）
              const receiptFile = document.getElementById('expenseReceipt').files[0];
              if (receiptFile) {
                  // 這裡可以加入檔案上傳邏輯
                  formData.hasReceipt = true;
              }
              
              await callAPI('submitExpense', formData);
              showSuccess('支出申請提交成功，等待審核');
              
              bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
              document.getElementById('expenseForm').reset();
              
              if (currentPage === 'finance') {
                  await loadFinanceData();
              }
              
          } catch (error) {
              showError('提交支出申請失敗: ' + error.message);
          }
      }

      async function filterActivities() {
          try {
              const profile = await liff.getProfile();
              const filters = {
                  lineId: profile.userId,
                  status: document.getElementById('activityStatusFilter').value,
                  date: document.getElementById('activityDateFilter').value,
                  search: document.getElementById('activitySearchFilter').value
              };
              
              const activities = await callAPI('getActivities', filters);
              displayActivities(activities);
              
          } catch (error) {
              showError('篩選活動失敗: ' + error.message);
          }
      }

      // 管理功能
      function showAdminSection(section) {
          const content = document.getElementById('adminContent');
          
          switch(section) {
              case 'members':
                  loadMemberManagement();
                  break;
              case 'activities':
                  loadActivityManagement();
                  break;
              case 'finance':
                  loadFinanceManagement();
                  break;
              case 'system':
                  loadSystemManagement();
                  break;
          }
      }

      async function loadMemberManagement() {
          try {
              const profile = await liff.getProfile();
              const members = await callAPI('getAllMembers', { 
                  operatorLineId: profile.userId 
              });
              
              let html = `
                  <div class="card">
                      <div class="card-header">
                          <i class="fas fa-users"></i> 會員管理
                          <button class="btn btn-primary btn-sm float-end" onclick="exportMembers()">
                              <i class="fas fa-download"></i> 匯出會員
                          </button>
                      </div>
                      <div class="card-body">
                          <div class="table-responsive">
                              <table class="table table-striped">
                                  <thead>
                                      <tr>
                                          <th>姓名</th>
                                          <th>會員類型</th>
                                          <th>狀態</th>
                                          <th>註冊日期</th>
                                          <th>志工時數</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody>
              `;
              
              members.forEach(member => {
                  const statusClass = getStatusClass(member.status);
                  html += `
                      <tr>
                          <td>${member.realName || member.lineName}</td>
                          <td>${member.memberType || '一般會員'}</td>
                          <td><span class="badge ${statusClass}">${member.status}</span></td>
                          <td>${formatDate(member.registerDate)}</td>
                          <td>${member.volunteerHours || 0}</td>
                          <td>
                              <button class="btn btn-outline-primary btn-sm" onclick="editMember('${member.lineId}')">
                                  <i class="fas fa-edit"></i>
                              </button>
                          </td>
                      </tr>
                  `;
              });
              
              html += `
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              `;
              
              document.getElementById('adminContent').innerHTML = html;
              
          } catch (error) {
              showError('載入會員資料失敗: ' + error.message);
          }
      }

      // 理監事功能
      function showBoardSection(section) {
          const content = document.getElementById('boardContent');
          
          switch(section) {
              case 'meetings':
                  loadMeetingManagement();
                  break;
              case 'proposals':
                  loadProposalManagement();
                  break;
              case 'cases':
                  loadCaseManagement();
                  break;
              case 'decisions':
                  loadDecisionManagement();
                  break;
          }
      }

      async function loadMeetingManagement() {
          try {
              const profile = await liff.getProfile();
              const meetings = await callAPI('listBoardMeetings', { 
                  operatorLineId: profile.userId 
              });
              
              let html = `
                  <div class="card">
                      <div class="card-header">
                          <i class="fas fa-users"></i> 會議管理
                          <button class="btn btn-primary btn-sm float-end" onclick="createMeeting()">
                              <i class="fas fa-plus"></i> 新增會議
                          </button>
                      </div>
                      <div class="card-body">
              `;
              
              if (meetings && meetings.length > 0) {
                  html += '<div class="table-responsive"><table class="table table-striped">';
                  html += '<thead><tr><th>會議名稱</th><th>日期</th><th>狀態</th><th>操作</th></tr></thead><tbody>';
                  
                  meetings.forEach(meeting => {
                      const statusClass = getStatusClass(meeting.status);
                      html += `
                          <tr>
                              <td>${meeting.title}</td>
                              <td>${formatDate(meeting.meetingDate)}</td>
                              <td><span class="badge ${statusClass}">${meeting.status}</span></td>
                              <td>
                                  <button class="btn btn-outline-primary btn-sm" onclick="viewMeeting('${meeting.id}')">
                                      <i class="fas fa-eye"></i>
                                  </button>
                                  <button class="btn btn-outline-success btn-sm" onclick="editMeeting('${meeting.id}')">
                                      <i class="fas fa-edit"></i>
                                  </button>
                              </td>
                          </tr>
                      `;
                  });
                  
                  html += '</tbody></table></div>';
              } else {
                  html += '<p class="text-muted text-center">尚無會議記錄</p>';
              }
              
              html += '</div></div>';
              document.getElementById('boardContent').innerHTML = html;
              
          } catch (error) {
              showError('載入會議資料失敗: ' + error.message);
          }
      }

      // 工具函數
      function showPage(pageName) {
          // 隱藏所有頁面
          document.querySelectorAll('.page-content').forEach(page => {
              page.classList.add('hidden');
          });
          
          // 顯示指定頁面
          const targetPage = document.getElementById(pageName + 'Page');
          if (targetPage) {
              targetPage.classList.remove('hidden');
              targetPage.classList.add('fade-in');
              currentPage = pageName;
              
              // 載入頁面資料
              switch(pageName) {
                  case 'dashboard':
                      loadDashboard();
                      break;
                  case 'profile':
                      loadUserProfile();
                      break;
                  case 'activities':
                      loadActivities();
                      break;
                  case 'volunteer':
                      loadVolunteerData();
                      break;
                  case 'finance':
                      loadFinanceData();
                      break;
              }
          }
      }

      function showLoading(show) {
          const loading = document.getElementById('loading');
          if (show) {
              loading.classList.remove('hidden');
          } else {
              loading.classList.add('hidden');
          }
      }

      function showError(message) {
          const alert = document.getElementById('errorAlert');
          const messageEl = document.getElementById('errorMessage');
          messageEl.textContent = message;
          alert.classList.remove('hidden');
          
          setTimeout(() => {
              alert.classList.add('hidden');
          }, 5000);
      }

      function showSuccess(message) {
          const alert = document.getElementById('successAlert');
          const messageEl = document.getElementById('successMessage');
          messageEl.textContent = message;
          alert.classList.remove('hidden');
          
          setTimeout(() => {
              alert.classList.add('hidden');
          }, 3000);
      }

      function formatDate(dateString) {
          if (!dateString) return '-';
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW');
      }

      function getStatusClass(status) {
          switch(status) {
              case '已註冊':
              case '開放報名':
              case '已核准':
              case '已完成':
                  return 'bg-success';
              case '待審核':
              case '報名截止':
                  return 'bg-warning';
              case '已取消':
              case '已拒絕':
              case '已結束':
                  return 'bg-danger';
              default:
                  return 'bg-secondary';
          }
      }

      // 表單事件綁定
      document.addEventListener('DOMContentLoaded', function() {
          // 個人資料表單
          document.getElementById('profileForm').addEventListener('submit', function(e) {
              e.preventDefault();
              submitProfile();
          });
          
          // 捐款表單
          document.getElementById('donationForm').addEventListener('submit', function(e) {
              e.preventDefault();
              submitDonation();
          });
          
          // 支出表單
          document.getElementById('expenseForm').addEventListener('submit', function(e) {
              e.preventDefault();
              submitExpense();
          });
          
          // 志工表單
          document.getElementById('volunteerForm').addEventListener('submit', function(e) {
              e.preventDefault();
              submitVolunteer();
          });
      });

      // 啟動應用程式
      window.addEventListener('load', function() {
          initializeLiff();
      });

      // 錯誤處理
      window.addEventListener('error', function(e) {
          console.error('全域錯誤:', e.error);
          showError('系統發生錯誤，請重新整理頁面');
      });

      // 未實作的函數（可根據需要補充）
      function registerVolunteer(activityId) { showVolunteerModal(activityId); }
      function viewReceipt(receiptNumber) { showError('收據查看功能開發中'); }
      function exportMembers() { showError('會員匯出功能開發中'); }
      function editMember(lineId) { showError('會員編輯功能開發中'); }
      function createMeeting() { showError('新增會議功能開發中'); }
      function viewMeeting(meetingId) { showError('查看會議功能開發中'); }
      function editMeeting(meetingId) { showError('編輯會議功能開發中'); }
      function loadActivityManagement() { showError('活動管理功能開發中'); }
      function loadFinanceManagement() { showError('財務管理功能開發中'); }
      function loadSystemManagement() { showError('系統管理功能開發中'); }
      function loadProposalManagement() { showError('提案管理功能開發中'); }
      function loadCaseManagement() { showError('案件管理功能開發中'); }
      function loadDecisionManagement() { showError('決議管理功能開發中'); }
  </script>
</body>
</html>
