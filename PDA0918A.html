<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友會管理系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #667eea;
      --secondary-color: #764ba2;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #4a5568;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .user-info {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .admin-nav {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
    }

    .nav-pills .nav-link {
      border-radius: 10px;
      margin: 0 5px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .nav-pills .nav-link.active {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .content-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .stat-card {
      background: linear-gradient(135deg, var(--success-color), #20c997);
      color: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
      transition: transform 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
    }

    .stat-card h3 {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .btn {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success-color), #20c997);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger-color), #c82333);
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning-color), #e0a800);
      color: #212529;
    }

    .btn-info {
      background: linear-gradient(135deg, var(--info-color), #138496);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #4a5568;
    }

    .form-control,
    .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-left: 4px solid var(--primary-color);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .activity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: white;
      border-radius: 10px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
    }

    .activity-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .table-container {
      max-height: 430px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      background: white;
    }

    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status.registered {
      background: #c6f6d5;
      color: #22543d;
    }

    .status.approved {
      background: #c6f6d5;
      color: #22543d;
    }

    .status.pending {
      background: #feebc8;
      color: #7b341e;
    }

    .status.rejected {
      background: #fed7d7;
      color: #742a2a;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #718096;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid #e2e8f0;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 300px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: #c6f6d5;
      color: #22543d;
      border-left: 4px solid #48bb78;
    }

    .notification.error {
      background: #fed7d7;
      color: #742a2a;
      border-left: 4px solid #f56565;
    }

    .notification.warning {
      background: #feebc8;
      color: #7b341e;
      border-left: 4px solid #ed8936;
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .quick-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #e2e8f0;
      padding: 15px 10px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      color: #4a5568;
      text-decoration: none;
    }

    .quick-btn:hover {
      border-color: var(--primary-color);
      background: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      color: #4a5568;
      text-decoration: none;
    }

    .quick-btn .icon {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
    }

    .proposal-card,
    .receipt-card,
    .expense-receipt {
      border: 1px solid #dee2e6;
      border-radius: 15px;
      margin-bottom: 20px;
      overflow: hidden;
      background: white;
    }

    .proposal-card .card-header {
      background: linear-gradient(135deg, #6c757d, #495057);
      color: white;
      font-weight: 600;
      padding: 15px;
    }

    .receipt-card .card-header {
      background: linear-gradient(135deg, var(--info-color), #138496);
      color: white;
      font-weight: 600;
      padding: 15px;
    }

    .vote-buttons,
    .receipt-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .receipt-image {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin-top: 8px;
      cursor: pointer;
    }

    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      border-radius: 15px;
      border: none;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      border-bottom: 1px solid #e9ecef;
      border-radius: 15px 15px 0 0;
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .pagination button:hover {
      background: #f7fafc;
      border-color: var(--primary-color);
    }

    .pagination button.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .header {
        padding: 20px;
      }

      .header h1 {
        font-size: 24px;
      }

      .activity-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .quick-actions {
        grid-template-columns: repeat(2, 1fr);
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .table-container {
        max-height: 300px;
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .btn:focus,
    .nav-link:focus,
    .quick-btn:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    .validation-message {
      color: #e53e3e;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }

    .form-group.error input,
    .form-group.error select,
    .form-group.error textarea {
      border-color: #e53e3e;
    }

    .form-group.error .validation-message {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 系統標題 -->
    <div class="header">
      <h1>🏥 帕金森病友會管理系統</h1>
      <p class="subtitle">完整版管理平台</p>
    </div>

    <!-- 全域訊息 -->
    <div id="errorAlert" class="alert alert-danger d-none">
      <i class="bi bi-exclamation-triangle me-2"></i><span id="errorMessage"></span>
    </div>
    <div id="successAlert" class="alert alert-success d-none">
      <i class="bi bi-check-circle me-2"></i><span id="successMessage"></span>
    </div>

    <!-- 使用者資訊 -->
    <div id="user-info" class="user-info" style="display: none;">
      <h3>👤 個人資訊</h3>
      <div id="user-details"></div>
    </div>

    <!-- 快速操作 -->
    <div class="quick-actions">
      <div class="quick-btn" onclick="showTab('profile')" tabindex="0" role="button">
        <span class="icon">👤</span>
        個人檔案
      </div>
      <div class="quick-btn" onclick="showTab('activities')" tabindex="0" role="button">
        <span class="icon">🎯</span>
        活動報名
      </div>
      <div class="quick-btn" onclick="showTab('donations')" tabindex="0" role="button">
        <span class="icon">💰</span>
        捐款記錄
      </div>
      <div class="quick-btn" onclick="showTab('finance')" tabindex="0" role="button">
        <span class="icon">📊</span>
        財務管理
      </div>
      <div class="quick-btn admin-only" onclick="showTab('admin')" tabindex="0" role="button" style="display: none;">
        <span class="icon">🔧</span>
        管理功能
      </div>
    </div>

    <!-- 主導航 -->
    <div class="admin-nav">
      <ul class="nav nav-pills justify-content-center flex-wrap" id="mainTabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" data-bs-toggle="pill" href="#profile-tab" role="tab">
            <i class="bi bi-person me-1"></i>個人檔案
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="pill" href="#activities-tab" role="tab">
            <i class="bi bi-calendar-event me-1"></i>活動管理
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="pill" href="#donations-tab" role="tab">
            <i class="bi bi-heart me-1"></i>捐款記錄
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="pill" href="#finance-tab" role="tab">
            <i class="bi bi-cash-coin me-1"></i>財務管理
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="pill" href="#feedback-tab" role="tab">
            <i class="bi bi-chat-dots me-1"></i>活動回饋
          </a>
        </li>
        <li class="nav-item admin-only" style="display: none;">
          <a class="nav-link" data-bs-toggle="pill" href="#admin-tab" role="tab">
            <i class="bi bi-gear me-1"></i>管理專區
          </a>
        </li>
      </ul>
    </div>

    <!-- 分頁內容 -->
    <div class="tab-content">
      <!-- 個人檔案 -->
      <div class="tab-pane fade show active" id="profile-tab" role="tabpanel">
        <div class="content-card">
          <h3>📝 會員註冊 / 個人資料</h3>
          
          <div id="registration-form">
            <div class="form-group">
              <label for="realName">真實姓名 *</label>
              <input type="text" id="realName" class="form-control" placeholder="請輸入您的真實姓名" required>
              <div class="validation-message">請輸入有效的姓名</div>
            </div>
            
            <div class="form-group">
              <label for="memberType">會員類別 *</label>
              <select id="memberType" class="form-select" required>
                <option value="">請選擇會員類別</option>
                <option value="病友">病友</option>
                <option value="家屬">家屬</option>
                <option value="志工">志工</option>
                <option value="醫護">醫護人員</option>
              </select>
              <div class="validation-message">請選擇會員類別</div>
            </div>
            
            <button class="btn" onclick="registerUser()" id="register-btn">
              <span class="btn-text">註冊會員</span>
            </button>
          </div>

          <div id="contact-form" style="display: none;">
            <h4>📞 聯絡資訊更新</h4>
            <div class="row g-3">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="phone">電話</label>
                  <input type="tel" id="phone" class="form-control" placeholder="例：0912345678">
                  <div class="validation-message">請輸入有效的電話號碼</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="email">電子郵件</label>
                  <input type="email" id="email" class="form-control" placeholder="例：user@example.com">
                  <div class="validation-message">請輸入有效的電子郵件地址</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="birthday">生日</label>
                  <input type="date" id="birthday" class="form-control">
                </div>
              </div>
              <div class="col-12">
                <div class="form-group">
                  <label for="address">地址</label>
                  <textarea id="address" class="form-control" rows="2" placeholder="請輸入地址"></textarea>
                </div>
              </div>
            </div>
            
            <button class="btn" onclick="updateContact()" id="update-btn">
              <span class="btn-text">更新聯絡資訊</span>
            </button>
          </div>
        </div>
      </div>

      <!-- 活動管理 -->
      <div class="tab-pane fade" id="activities-tab" role="tabpanel">
        <div class="content-card">
          <h3>🎯 活動報名管理</h3>
          
          <div class="grid">
            <div class="stat-card">
              <h3 id="total-activities">0</h3>
              <p>可報名活動</p>
            </div>
            <div class="stat-card">
              <h3 id="my-registrations">0</h3>
              <p>我的報名</p>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-3">
              <select id="activity-status-filter" class="form-select">
                <option value="">全部狀態</option>
                <option value="開放報名">開放報名</option>
                <option value="已結束">已結束</option>
              </select>
            </div>
            <div class="col-md-3">
              <input type="date" id="activity-date-filter" class="form-control">
            </div>
            <div class="col-md-4">
              <input type="text" id="activity-search" class="form-control" placeholder="搜尋活動...">
            </div>
            <div class="col-md-2">
              <button class="btn w-100" onclick="filterActivities()">
                <i class="bi bi-search me-1"></i>搜尋
              </button>
            </div>
          </div>

          <h4>📅 可報名活動</h4>
          <div id="activities-list" class="loading">載入中...</div>
          <div id="activities-pagination" class="pagination"></div>

          <h4>📋 我的活動報名</h4>
          <div id="my-activities-list" class="loading">載入中...</div>
        </div>
      </div>

      <!-- 捐款記錄 -->
      <div class="tab-pane fade" id="donations-tab" role="tabpanel">
        <div class="content-card">
          <h3>💰 捐款記錄</h3>
          
          <div class="grid">
            <div class="stat-card">
              <h3 id="total-donations">0</h3>
              <p>捐款筆數</p>
            </div>
            <div class="stat-card">
              <h3 id="total-amount">NT$ 0</h3>
              <p>捐款總額</p>
            </div>
          </div>

          <div class="mb-3">
            <button class="btn btn-success" onclick="showDonationForm()">
              <i class="bi bi-plus-circle me-1"></i>新增捐款
            </button>
          </div>

          <!-- 捐款表單 -->
          <div id="donation-form" style="display: none;">
            <div class="card border-success mb-4">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0">新增捐款記錄</h6>
              </div>
              <div class="card-body">
                <form id="donation-form-element">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <div class="form-group">
                        <label for="donation-amount">捐款金額 *</label>
                        <input type="number" id="donation-amount" class="form-control" min="1" required>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-group">
                        <label for="donation-method">捐款方式</label>
                        <select id="donation-method" class="form-select">
                          <option value="現金">現金</option>
                          <option value="轉帳">轉帳</option>
                          <option value="信用卡">信用卡</option>
                          <option value="其他">其他</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-group">
                        <label for="donation-date">捐款日期</label>
                        <input type="date" id="donation-date" class="form-control">
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-group">
                        <label for="donation-note">備註</label>
                        <textarea id="donation-note" class="form-control" rows="2"></textarea>
                      </div>
                    </div>
                  </div>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-success me-2">
                      <i class="bi bi-check-circle me-1"></i>提交
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideDonationForm()">
                      <i class="bi bi-x-circle me-1"></i>取消
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div id="donations-list" class="loading">載入中...</div>
        </div>
      </div>

      <!-- 財務管理 -->
      <div class="tab-pane fade" id="finance-tab" role="tabpanel">
        <div class="content-card">
          <h3>📊 財務管理</h3>
          
          <div class="grid">
            <div class="stat-card">
              <h3 id="account-balance">NT$ 0</h3>
              <p>帳戶餘額</p>
            </div>
            <div class="stat-card">
              <h3 id="monthly-income">NT$ 0</h3>
              <p>本月收入</p>
            </div>
            <div class="stat-card">
              <h3 id="monthly-expense">NT$ 0</h3>
              <p>本月支出</p>
            </div>
          </div>

          <div class="mb-3">
            <button class="btn btn-warning" onclick="showExpenseForm()">
              <i class="bi bi-plus-circle me-1"></i>支出申請
            </button>
          </div>

          <!-- 支出申請表單 -->
          <div id="expense-form" style="display: none;">
            <div class="card border-warning mb-4">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">支出申請</h6>
              </div>
              <div class="card-body">
                <form id="expense-form-element">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <div class="form-group">
                        <label for="expense-category">支出類別 *</label>
                        <select id="expense-category" class="form-select" required>
                          <option value="">請選擇</option>
                          <option value="活動支出">活動支出</option>
                          <option value="辦公費用">辦公費用</option>
                          <option value="宣傳費用">宣傳費用</option>
                          <option value="設備費用">設備費用</option>
                          <option value="福利支出">福利支出</option>
                          <option value="醫療支援">醫療支援</option>
                          <option value="志工費用">志工費用</option>
                          <option value="其他支出">其他支出</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-group">
                        <label for="expense-amount">金額 *</label>
                        <input type="number" id="expense-amount" class="form-control" min="0" required>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-group">
                        <label for="expense-date">支出日期</label>
                        <input type="date" id="expense-date" class="form-control">
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-group">
                        <label for="expense-description">說明 *</label>
                        <textarea id="expense-description" class="form-control" rows="3" required></textarea>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-group">
                        <label for="expense-receipt">上傳憑證</label>
                        <input type="file" id="expense-receipt" class="form-control" accept="image/*">
                      </div>
                    </div>
                  </div>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-warning me-2">
                      <i class="bi bi-check-circle me-1"></i>提交申請
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideExpenseForm()">
                      <i class="bi bi-x-circle me-1"></i>取消
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <h4>📋 我的支出申請</h4>
          <div id="my-expenses" class="loading">載入中...</div>

          <!-- 管理員財務概覽 -->
          <div id="admin-finance-overview" class="admin-only" style="display: none;">
            <hr>
            <h4>💼 財務概覽（管理員）</h4>
            <div class="table-container">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>日期</th>
                    <th>類型</th>
                    <th>類別</th>
                    <th>金額</th>
                    <th>對象</th>
                    <th>收據</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="admin-transaction-list">
                  <tr><td colspan="7" class="text-center text-muted">載入中...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 活動回饋 -->
      <div class="tab-pane fade" id="feedback-tab" role="tabpanel">
        <div class="content-card">
          <h3>📝 活動回饋</h3>
          
          <div class="form-group">
            <label for="feedback-activity">選擇活動</label>
            <select id="feedback-activity" class="form-select">
              <option value="">請選擇已參與的活動</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="feedback-rating">評分 (1-5分)</label>
            <select id="feedback-rating" class="form-select">
              <option value="">請選擇評分</option>
              <option value="1">1分 - 很不滿意</option>
              <option value="2">2分 - 不滿意</option>
              <option value="3">3分 - 普通</option>
              <option value="4">4分 - 滿意</option>
              <option value="5">5分 - 非常滿意</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="feedback-comment">意見與建議</label>
            <textarea id="feedback-comment" class="form-control" rows="4" placeholder="請分享您的參與心得與建議"></textarea>
          </div>
          
          <button class="btn" onclick="submitFeedback()">
            <i class="bi bi-send me-1"></i>提交回饋
          </button>

          <h4>📊 我的回饋記錄</h4>
          <div id="my-feedback" class="loading">載入中...</div>
        </div>
      </div>

      <!-- 管理專區 -->
      <div class="tab-pane fade" id="admin-tab" role="tabpanel">
        <div class="content-card">
          <h3>🔧 管理專區</h3>
          
          <!-- 管理員統計 -->
          <div class="grid">
            <div class="stat-card">
              <h3 id="admin-total-members">0</h3>
              <p>總會員數</p>
            </div>
            <div class="stat-card">
              <h3 id="admin-active-members">0</h3>
              <p>活躍會員</p>
            </div>
            <div class="stat-card">
              <h3 id="admin-pending-approvals">0</h3>
              <p>待審核項目</p>
            </div>
            <div class="stat-card">
              <h3 id="admin-monthly-donations">0</h3>
              <p>本月捐款</p>
            </div>
          </div>

          <!-- 管理功能導航 -->
          <div class="row mb-4">
            <div class="col-md-3">
              <button class="btn w-100 mb-2" onclick="showAdminSection('members')">
                <i class="bi bi-people me-1"></i>會員管理
              </button>
            </div>
            <div class="col-md-3">
              <button class="btn w-100 mb-2" onclick="showAdminSection('activities')">
                <i class="bi bi-calendar-event me-1"></i>活動管理
              </button>
            </div>
            <div class="col-md-3">
              <button class="btn w-100 mb-2" onclick="showAdminSection('finances')">
                <i class="bi bi-cash-coin me-1"></i>財務審核
              </button>
            </div>
            <div class="col-md-3">
              <button class="btn w-100 mb-2" onclick="showAdminSection('reports')">
                <i class="bi bi-graph-up me-1"></i>報表分析
              </button>
            </div>
          </div>

          <!-- 會員管理 -->
          <div id="admin-members" class="admin-section">
            <h4>👥 會員管理</h4>
            <div class="row mb-3">
              <div class="col-md-4">
                <input type="text" id="member-search" class="form-control" placeholder="搜尋會員（姓名或LINE ID）">
              </div>
              <div class="col-md-3">
                <select id="member-type-filter" class="form-select">
                  <option value="">所有會員類別</option>
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                  <option value="醫護">醫護人員</option>
                </select>
              </div>
              <div class="col-md-3">
                <button class="btn w-100" onclick="searchMembers()">
                  <i class="bi bi-search me-1"></i>搜尋
                </button>
              </div>
              <div class="col-md-2">
                <button class="btn btn-success w-100" onclick="exportMembers()">
                  <i class="bi bi-download me-1"></i>匯出
                </button>
              </div>
            </div>
            
            <div class="table-container">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>姓名</th>
                    <th>類別</th>
                    <th>電話</th>
                    <th>狀態</th>
                    <th>加入日期</th>
                    <th>最後活動</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="admin-member-list">
                  <tr><td colspan="7" class="text-center text-muted">載入中...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- 活動管理 -->
          <div id="admin-activities" class="admin-section" style="display: none;">
            <h4>🎯 活動管理</h4>
            <div class="mb-3">
              <button class="btn btn-success" onclick="showActivityForm()">
                <i class="bi bi-plus-circle me-1"></i>新增活動
              </button>
            </div>

            <!-- 活動表單 -->
            <div id="activity-form" style="display: none;">
              <div class="card border-success mb-4">
                <div class="card-header bg-success text-white">
                  <h6 class="mb-0">新增活動</h6>
                </div>
                <div class="card-body">
                  <form id="activity-form-element">
                    <div class="row g-3">
                      <div class="col-md-8">
                        <div class="form-group">
                          <label for="activity-name">活動名稱 *</label>
                          <input type="text" id="activity-name" class="form-control" required>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="activity-type">活動類型 *</label>
                          <select id="activity-type" class="form-select" required>
                            <option value="">選擇</option>
                            <option value="講座">講座</option>
                            <option value="聚會">聚會</option>
                            <option value="旅遊">旅遊</option>
                            <option value="運動">運動</option>
                            <option value="志工服務">志工服務</option>
                            <option value="其他">其他</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="activity-date">活動日期 *</label>
                          <input type="date" id="activity-date" class="form-control" required>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="activity-time">活動時間</label>
                          <input type="time" id="activity-time" class="form-control">
                        </div>
                      </div>
                      <div class="col-md-8">
                        <div class="form-group">
                          <label for="activity-location">活動地點</label>
                          <input type="text" id="activity-location" class="form-control">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="activity-max-people">人數上限</label>
                          <input type="number" id="activity-max-people" class="form-control" min="1" value="50">
                        </div>
                      </div>
                      <div class="col-12">
                        <div class="form-group">
                          <label for="activity-description">活動描述</label>
                          <textarea id="activity-description" class="form-control" rows="3"></textarea>
                        </div>
                      </div>
                    </div>
                    <div class="mt-3">
                      <button type="submit" class="btn btn-success me-2">
                        <i class="bi bi-check-circle me-1"></i>建立活動
                      </button>
                      <button type="button" class="btn btn-secondary" onclick="hideActivityForm()">
                        <i class="bi bi-x-circle me-1"></i>取消
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div id="admin-activity-list" class="loading">載入中...</div>
          </div>

          <!-- 財務審核 -->
          <div id="admin-finances" class="admin-section" style="display: none;">
            <h4>💰 財務審核</h4>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <h5>待審核支出</h5>
                <div id="pending-expenses" class="loading">載入中...</div>
              </div>
              <div class="col-md-6">
                <h5>收據管理</h5>
                <div class="mb-2">
                  <button class="btn btn-info btn-sm" onclick="showReceiptForm()">
                    <i class="bi bi-plus-circle me-1"></i>手動開立收據
                  </button>
                </div>
                <div id="recent-receipts" class="loading">載入中...</div>
              </div>
            </div>
          </div>

          <!-- 報表分析 -->
          <div id="admin-reports" class="admin-section" style="display: none;">
            <h4>📊 報表分析</h4>
            
            <div class="row mb-3">
              <div class="col-md-3">
                <div class="form-group">
                  <label for="report-year">年份</label>
                  <input type="number" id="report-year" class="form-control" value="2024" min="2020" max="2030">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label for="report-month">月份</label>
                  <select id="report-month" class="form-select">
                    <option value="1">1月</option>
                    <option value="2">2月</option>
                    <option value="3">3月</option>
                    <option value="4">4月</option>
                    <option value="5">5月</option>
                    <option value="6">6月</option>
                    <option value="7">7月</option>
                    <option value="8">8月</option>
                    <option value="9">9月</option>
                    <option value="10">10月</option>
                    <option value="11">11月</option>
                    <option value="12">12月</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <button class="btn w-100" onclick="generateReport()">
                  <i class="bi bi-graph-up me-1"></i>產生報表
                </button>
              </div>
              <div class="col-md-3">
                <button class="btn btn-success w-100" onclick="exportAllData()">
                  <i class="bi bi-download me-1"></i>匯出資料
                </button>
              </div>
            </div>
            
            <div id="finance-report" class="loading">載入中...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 動態 Modal 容器 -->
  <div id="dynamic-modal-container"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // 系統配置
    const CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycby2DGS645Kubn8x4EVmhRz5v86lmkFgsBf9xYRSBryTzVHHV20jmpz_DglULgIvVtOgDg/exec',
      API_KEY: 'AAbb8520258185202581',
      STRICT_SIGN: false
    };

    // 全域變數
    let currentUser = null;
    let isAdmin = false;
    let currentPage = 1;
    let itemsPerPage = 10;

    // LIFF 初始化
    async function initializeLiff() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        await createUserIfNotExist(profile.userId, profile.displayName);
        await loadUserInfo();
        
        showNotification('系統初始化成功', 'success');
      } catch (error) {
        console.error('LIFF 初始化失敗:', error);
        showNotification('系統初始化失敗，請重新整理頁面', 'error');
      }
    }

    // API 呼叫函式
    async function callAPI(action, data = {}, retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          const payload = {
            action,
            ...data,
            apiKey: CONFIG.API_KEY,
            ts: Date.now(),
            nonce: Math.random().toString(36).substring(2)
          };

          if (CONFIG.STRICT_SIGN) {
            const baseString = `${action}|${payload.ts}|${payload.nonce}|${CONFIG.API_KEY}`;
            const signature = CryptoJS.HmacSHA256(baseString, CONFIG.API_KEY).toString();
            payload.sign = signature;
          }

          const response = await fetch(CONFIG.API_BASE_URL, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Cache-Control': 'no-cache'
            },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          return await response.json();
        } catch (error) {
          console.error(`API 呼叫失敗 (嘗試 ${i + 1}/${retries}):`, error);
          if (i === retries - 1) throw error;
          await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        }
      }
    }

    // 建立使用者（如果不存在）
    async function createUserIfNotExist(lineId, lineName) {
      try {
        await callAPI('register', {
          lineId: lineId,
          lineName: lineName,
          realName: lineName
        });
      } catch (error) {
        console.error('建立使用者失敗:', error);
      }
    }

    // 載入使用者資訊
    async function loadUserInfo() {
      try {
        const profile = await liff.getProfile();
        const result = await callAPI('getUserInfo', { lineId: profile.userId });
        
        if (result.error) {
          showNotification('無法載入使用者資訊', 'error');
          return;
        }

        currentUser = result;
        isAdmin = result.isAdmin || false;
        
        updateUserInfoDisplay();
        updateUIBasedOnUserStatus();
        
      } catch (error) {
        console.error('載入使用者資訊失敗:', error);
        showNotification('載入使用者資訊失敗', 'error');
      }
    }

    // 更新使用者資訊顯示
    function updateUserInfoDisplay() {
      if (!currentUser) return;

      const userInfoDiv = document.getElementById('user-info');
      const userDetailsDiv = document.getElementById('user-details');
      
      userDetailsDiv.innerHTML = `
        <div class="row g-3">
          <div class="col-md-3">
            <strong>姓名:</strong> ${currentUser.realName || '未設定'}
          </div>
          <div class="col-md-3">
            <strong>LINE 名稱:</strong> ${currentUser.lineName || '未知'}
          </div>
          <div class="col-md-3">
            <strong>狀態:</strong> <span class="status ${currentUser.status === '已註冊' ? 'registered' : 'pending'}">${currentUser.status}</span>
          </div>
          <div class="col-md-3">
            <strong>會員類別:</strong> ${currentUser.memberType || '未設定'}
          </div>
          ${isAdmin ? '<div class="col-md-12"><strong>權限:</strong> <span class="status approved">管理員</span></div>' : ''}
        </div>
      `;
      
      userInfoDiv.style.display = 'block';
      userInfoDiv.classList.add('fade-in');
    }

    // 根據使用者狀態更新UI
    function updateUIBasedOnUserStatus() {
      const registrationForm = document.getElementById('registration-form');
      const contactForm = document.getElementById('contact-form');
      const adminElements = document.querySelectorAll('.admin-only');

      if (currentUser.status === '已註冊') {
        registrationForm.style.display = 'none';
        contactForm.style.display = 'block';
        
        // 填入現有聯絡資訊
        document.getElementById('phone').value = currentUser.phone || '';
        document.getElementById('email').value = currentUser.email || '';
        document.getElementById('address').value = currentUser.address || '';
        document.getElementById('birthday').value = currentUser.birthday || '';
      } else {
        registrationForm.style.display = 'block';
        contactForm.style.display = 'none';
      }

      if (isAdmin) {
        adminElements.forEach(el => el.style.display = 'block');
      }
    }

    // 表單驗證
    function validateForm(formElement) {
      const inputs = formElement.querySelectorAll('input[required], select[required]');
      let isValid = true;

      inputs.forEach(input => {
        const formGroup = input.closest('.form-group');
        const errorMessage = formGroup?.querySelector('.validation-message');
        
        if (!input.value.trim()) {
          formGroup?.classList.add('error');
          if (errorMessage) errorMessage.style.display = 'block';
          isValid = false;
        } else {
          formGroup?.classList.remove('error');
          if (errorMessage) errorMessage.style.display = 'none';
          
          // 特定欄位驗證
          if (input.type === 'email' && !isValidEmail(input.value)) {
            formGroup?.classList.add('error');
            if (errorMessage) errorMessage.style.display = 'block';
            isValid = false;
          }
          
          if (input.type === 'tel' && !isValidPhone(input.value)) {
            formGroup?.classList.add('error');
            if (errorMessage) errorMessage.style.display = 'block';
            isValid = false;
          }
        }
      });

      return isValid;
    }

    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function isValidPhone(phone) {
      const phoneRegex = /^[0-9]{10}$/;
      return phoneRegex.test(phone.replace(/\D/g, ''));
    }

    // 按鈕載入狀態
    function setButtonLoading(buttonId, loading = true) {
      const button = document.getElementById(buttonId);
      if (!button) return;

      if (loading) {
        button.classList.add('loading');
        button.disabled = true;
        const text = button.querySelector('.btn-text');
        if (text) text.style.opacity = '0';
      } else {
        button.classList.remove('loading');
        button.disabled = false;
        const text = button.querySelector('.btn-text');
        if (text) text.style.opacity = '1';
      }
    }

    // 通知系統
    function showNotification(message, type = 'info', duration = 3000) {
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span>${message}</span>
          <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 18px; margin-left: 10px;">&times;</button>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => notification.classList.add('show'), 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, duration);
    }

    // 會員註冊
    async function registerUser() {
      const form = document.getElementById('registration-form');
      if (!validateForm(form)) {
        showNotification('請填寫所有必填欄位', 'error');
        return;
      }

      const realName = document.getElementById('realName').value.trim();
      const memberType = document.getElementById('memberType').value;

      setButtonLoading('register-btn', true);

      try {
        const profile = await liff.getProfile();
        const result = await callAPI('register', {
          lineId: profile.userId,
          realName,
          memberType
        });

        if (result.success) {
          showNotification('註冊成功！', 'success');
          await loadUserInfo();
        } else {
          showNotification(`註冊失敗：${result.message}`, 'error');
        }
      } catch (error) {
        console.error('註冊失敗:', error);
        showNotification('註冊過程發生錯誤', 'error');
      } finally {
        setButtonLoading('register-btn', false);
      }
    }

    // 更新聯絡資訊
    async function updateContact() {
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const address = document.getElementById('address').value.trim();
      const birthday = document.getElementById('birthday').value;

      if (phone && !isValidPhone(phone)) {
        showNotification('請輸入有效的電話號碼', 'error');
        return;
      }

      if (email && !isValidEmail(email)) {
        showNotification('請輸入有效的電子郵件地址', 'error');
        return;
      }

      setButtonLoading('update-btn', true);

      try {
        const profile = await liff.getProfile();
        const result = await callAPI('updateUserContact', {
          operatorLineId: profile.userId,
          targetLineId: profile.userId,
          phone,
          email,
          address,
          birthday
        });

        if (result.success) {
          showNotification('聯絡資訊更新成功！', 'success');
          await loadUserInfo();
        } else {
          showNotification(`更新失敗：${result.message}`, 'error');
        }
      } catch (error) {
        console.error('更新聯絡資訊失敗:', error);
        showNotification('更新過程發生錯誤', 'error');
      } finally {
        setButtonLoading('update-btn', false);
      }
    }

    // 分頁切換
    function showTab(tabName) {
      const tabs = document.querySelectorAll('.nav-link');
      tabs.forEach(tab => {
        tab.classList.remove('active');
      });
      
      const tabContents = document.querySelectorAll('.tab-pane');
      tabContents.forEach(content => {
        content.classList.remove('show', 'active');
      });
      
      const targetTab = document.querySelector(`a[href="#${tabName}-tab"]`);
      const targetContent = document.getElementById(`${tabName}-tab`);
      
      if (targetTab && targetContent) {
        targetTab.classList.add('active');
        targetContent.classList.add('show', 'active', 'fade-in');
      }
      
      loadTabData(tabName);
    }

    async function loadTabData(tabName) {
      switch (tabName) {
        case 'activities':
          await Promise.all([loadActivities(), loadMyActivities()]);
          break;
        case 'donations':
          await loadDonations();
          break;
        case 'finance':
          await loadFinanceData();
          break;
        case 'feedback':
          await loadFeedbackData();
          break;
        case 'admin':
          if (isAdmin) {
            await loadAdminData();
          }
          break;
      }
    }

    // 活動相關功能
    async function loadActivities() {
      try {
        const result = await callAPI('getActivities');
        const activitiesList = document.getElementById('activities-list');
        
        if (!result || result.length === 0) {
          activitiesList.innerHTML = '<div class="card"><p>目前沒有開放的活動</p></div>';
          return;
        }

        document.getElementById('total-activities').textContent = result.length;
        renderActivities(result);
        
      } catch (error) {
        console.error('載入活動失敗:', error);
        document.getElementById('activities-list').innerHTML = '<div class="alert alert-danger">載入活動失敗</div>';
      }
    }

    function renderActivities(activities, page = 1) {
      const activitiesList = document.getElementById('activities-list');
      const startIndex = (page - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedActivities = activities.slice(startIndex, endIndex);

      let html = '';
      paginatedActivities.forEach(activity => {
        const dateStr = activity.date ? new Date(activity.date).toLocaleDateString('zh-TW') : '待定';
        const participantsText = `${activity.currentParticipants || 0}/${activity.maxParticipants || '不限'}`;
        const isFull = activity.maxParticipants && (activity.currentParticipants || 0) >= activity.maxParticipants;
        
        html += `
          <div class="activity-item">
            <div class="activity-info">
              <h4>${activity.name}</h4>
              <p><i class="bi bi-calendar me-1"></i>${dateStr} | <i class="bi bi-geo-alt me-1"></i>${activity.location || '待定'}</p>
              <p>${activity.description || ''}</p>
              ${activity.fee ? `<p><i class="bi bi-currency-dollar me-1"></i>費用：NT$ ${activity.fee}</p>` : ''}
            </div>
            <div style="text-align: right;">
              <div class="participants mb-2">${participantsText}</div>
              ${!isFull ? `<button class="btn btn-sm" onclick="registerActivity('${activity.id}')">報名</button>` : '<span class="status rejected">已額滿</span>'}
            </div>
          </div>
        `;
      });

      activitiesList.innerHTML = html;
      renderPagination('activities-pagination', activities.length, page, (newPage) => renderActivities(activities, newPage));
    }

    function renderPagination(containerId, totalItems, currentPage, onPageChange) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const totalPages = Math.ceil(totalItems / itemsPerPage);
      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      let html = '';
      
      if (currentPage > 1) {
        html += `<button onclick="changePage(${currentPage - 1})">上一頁</button>`;
      }
      
      for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
          html += `<button class="active">${i}</button>`;
        } else if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
          html += `<button onclick="changePage(${i})">${i}</button>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<span>...</span>';
        }
      }
      
      if (currentPage < totalPages) {
        html += `<button onclick="changePage(${currentPage + 1})">下一頁</button>`;
      }

      container.innerHTML = html;
      window.changePage = onPageChange;
    }

    async function registerActivity(activityId) {
      if (!currentUser || currentUser.status !== '已註冊') {
        showNotification('請先完成會員註冊', 'warning');
        return;
      }

      try {
        const profile = await liff.getProfile();
        const result = await callAPI('registerActivity', {
          lineId: profile.userId,
          activityId: activityId,
          participantName: currentUser.realName
        });

        if (result.success) {
          showNotification('活動報名成功！', 'success');
          await loadActivities();
          await loadMyActivities();
        } else {
          showNotification(`報名失敗：${result.message}`, 'error');
        }
      } catch (error) {
        console.error('活動報名失敗:', error);
        showNotification('報名過程發生錯誤', 'error');
      }
    }

    async function loadMyActivities() {
      try {
        const profile = await liff.getProfile();
        const result = await callAPI('getUserActivities', { lineId: profile.userId });
        const myActivitiesList = document.getElementById('my-activities-list');
        
        if (!result || result.length === 0) {
          myActivitiesList.innerHTML = '<div class="card"><p>您目前沒有報名任何活動</p></div>';
          document.getElementById('my-registrations').textContent = '0';
          return;
        }

        document.getElementById('my-registrations').textContent = result.length;

        let html = '';
        result.forEach(registration => {
          const dateStr = registration.date ? new Date(registration.date).toLocaleDateString('zh-TW') : '待定';
          
          html += `
            <div class="card">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h4>${registration.activityName}</h4>
                  <p><i class="bi bi-calendar me-1"></i>${dateStr}</p>
                  <p><i class="bi bi-geo-alt me-1"></i>${registration.location || '待定'}</p>
                  <p><i class="bi bi-person me-1"></i>參與者：${registration.participantName}</p>
                </div>
                <div style="text-align: right;">
                  <span class="status registered">${registration.status}</span>
                  ${registration.status === '已報名' ? `<br><button class="btn btn-danger btn-sm mt-2" onclick="cancelActivity('${registration.id}')">取消報名</button>` : ''}
                </div>
              </div>
            </div>
          `;
        });

        myActivitiesList.innerHTML = html;
        loadActivitiesForFeedback(result);
        
      } catch (error) {
        console.error('載入我的活動失敗:', error);
        document.getElementById('my-activities-list').innerHTML = '<div class="alert alert-danger">載入失敗</div>';
      }
    }

    async function cancelActivity(registrationId) {
      if (!confirm('確定要取消這個活動的報名嗎？')) {
        return;
      }

      try {
        const profile = await liff.getProfile();
        const result = await callAPI('cancelActivity', {
          lineId: profile.userId,
          registrationId: registrationId
        });

        if (result.success) {
          showNotification('已取消報名', 'success');
          await loadActivities();
          await loadMyActivities();
        } else {
          showNotification(`取消失敗：${result.message}`, 'error');
        }
      } catch (error) {
        console.error('取消報名失敗:', error);
        showNotification('取消過程發生錯誤', 'error');
      }
    }

    function loadActivitiesForFeedback(activities) {
      const select = document.getElementById('feedback-activity');
      select.innerHTML = '<option value="">請選擇已參與的活動</option>';
      
      activities.forEach(activity => {
        const option = document.createElement('option');
        option.value = activity.activityId;
        option.textContent = activity.activityName;
        select.appendChild(option);
      });
    }

    async function filterActivities() {
      const status = document.getElementById('activity-status-filter').value;
      const date = document.getElementById('activity-date-filter').value;
      const search = document.getElementById('activity-search').value.toLowerCase();

      try {
        const result = await callAPI('getActivities', { status, date, search });
        const filteredActivities = result.filter(activity => {
          let matches = true;
          
          if (search) {
            matches = matches && (
              activity.name.toLowerCase().includes(search) ||
              (activity.description && activity.description.toLowerCase().includes(search)) ||
              (activity.location && activity.location.toLowerCase().includes(search))
            );
          }
          
          return matches;
        });
        
        renderActivities(filteredActivities);
      } catch (error) {
        console.error('篩選活動失敗:', error);
      }
    }

    // 捐款相關功能
    function showDonationForm() {
      document.getElementById('donation-form').style.display = 'block';
      document.getElementById('donation-date').value = new Date().toISOString().split('T')[0];
    }

    function hideDonationForm() {
      document.getElementById('donation-form').style.display = 'none';
      document.getElementById('donation-form-element').reset();
    }

    async function loadDonations() {
      try {
        const profile = await liff.getProfile();
        const result = await callAPI('getDonations', { lineId: profile.userId });
        const donationsList = document.getElementById('donations-list');
        
        if (!result || result.length === 0) {
          donationsList.innerHTML = '<div class="card"><p>您目前沒有捐款記錄</p></div>';
          document.getElementById('total-donations').textContent = '0';
          document.getElementById('total-amount').textContent = 'NT$ 0';
          return;
        }

        document.getElementById('total-donations').textContent = result.length;
        const totalAmount = result.reduce((sum, donation) => sum + (donation.amount || 0), 0);
        document.getElementById('total-amount').textContent = `NT$ ${totalAmount.toLocaleString()}`;

        let html = '';
        result.forEach(donation => {
          const dateStr = donation.date ? new Date(donation.date).toLocaleDateString('zh-TW') : '未知';
          
          html += `
            <div class="card">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h5>NT$ ${(donation.amount || 0).toLocaleString()}</h5>
                  <p><i class="bi bi-calendar me-1"></i>${dateStr}</p>
                  <p><i class="bi bi-credit-card me-1"></i>${donation.method || '未知'}</p>
                  ${donation.note ? `<p><i class="bi bi-chat-dots me-1"></i>${donation.note}</p>` : ''}
                </div>
                <div>
                  <span class="status approved">已完成</span>
                </div>
              </div>
            </div>
          `;
        });

        donationsList.innerHTML = html;
        
      } catch (error) {
        console.error('載入捐款記錄失敗:', error);
        document.getElementById('donations-list').innerHTML = '<div class="alert alert-danger">載入失敗</div>';
      }
    }

    // 支出申請相關功能
    function showExpenseForm() {
      document.getElementById('expense-form').style.display = 'block';
      document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
    }

    function hideExpenseForm() {
      document.getElementById('expense-form').style.display = 'none';
      document.getElementById('expense-form-element').reset();
    }

    async function loadFinanceData() {
      try {
        const profile = await liff.getProfile();
        const result = await callAPI('getFinanceData', { lineId: profile.userId });
        
        if (result) {
          document.getElementById('account-balance').textContent = `NT$ ${(result.balance || 0).toLocaleString()}`;
          document.getElementById('monthly-income').textContent = `NT$ ${(result.monthlyIncome || 0).toLocaleString()}`;
          document.getElementById('monthly-expense').textContent = `NT$ ${(result.monthlyExpense || 0).toLocaleString()}`;
        }

        await loadMyExpenses();
        
        if (isAdmin) {
          document.getElementById('admin-finance-overview').style.display = 'block';
          await loadAdminTransactions();
        }
        
      } catch (error) {
        console.error('載入財務資料失敗:', error);
      }
    }

    async function loadMyExpenses() {
      try {
        const profile = await liff.getProfile();
        const result = await callAPI('getMyExpenses', { lineId: profile.userId });
        const expensesList = document.getElementById('my-expenses');
        
        if (!result || result.length === 0) {
          expensesList.innerHTML = '<div class="card"><p>您目前沒有支出申請記錄</p></div>';
          return;
        }

        let html = '';
        result.forEach(expense => {
          const dateStr = expense.date ? new Date(expense.date).toLocaleDateString('zh-TW') : '未知';
          
          html += `
            <div class="card">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h5>${expense.category} - NT$ ${(expense.amount || 0).toLocaleString()}</h5>
                  <p><i class="bi bi-calendar me-1"></i>${dateStr}</p>
                  <p>${expense.description}</p>
                </div>
                <div>
                  <span class="status ${getExpenseStatusClass(expense.status)}">${expense.status}</span>
                </div>
              </div>
            </div>
          `;
        });

        expensesList.innerHTML = html;
        
      } catch (error) {
        console.error('載入支出記錄失敗:', error);
        document.getElementById('my-expenses').innerHTML = '<div class="alert alert-danger">載入失敗</div>';
      }
    }

    function getExpenseStatusClass(status) {
      switch (status) {
        case '已通過': return 'approved';
        case '待審核': return 'pending';
        case '已駁回': return 'rejected';
        default: return 'pending';
      }
    }

    // 回饋相關功能
    async function submitFeedback() {
      const activityId = document.getElementById('feedback-activity').value;
      const rating = document.getElementById('feedback-rating').value;
      const comment = document.getElementById('feedback-comment').value.trim();

      if (!activityId) {
        showNotification('請選擇活動', 'error');
        return;
      }

      if (!rating) {
        showNotification('請選擇評分', 'error');
        return;
      }

      try {
        const profile = await liff.getProfile();
        const result = await callAPI('submitFeedback', {
          lineId: profile.userId,
          activityId,
          rating: parseInt(rating),
          comment
        });

        if (result.success) {
          showNotification('回饋提交成功！', 'success');
          document.getElementById('feedback-activity').value = '';
          document.getElementById('feedback-rating').value = '';
          document.getElementById('feedback-comment').value = '';
          await loadFeedbackData();
        } else {
          showNotification(`提交失敗：${result.message}`, 'error');
        }
      } catch (error) {
        console.error('提交回饋失敗:', error);
        showNotification('提交過程發生錯誤', 'error');
      }
    }

    async function loadFeedbackData() {
      try {
        const profile = await liff.getProfile();
        const result = await callAPI('getMyFeedback', { lineId: profile.userId });
        const feedbackList = document.getElementById('my-feedback');
        
        if (!result || result.length === 0) {
          feedbackList.innerHTML = '<div class="card"><p>您目前沒有回饋記錄</p></div>';
          return;
        }

        let html = '';
        result.forEach(feedback => {
          const dateStr = feedback.date ? new Date(feedback.date).toLocaleDateString('zh-TW') : '未知';
          const stars = '★'.repeat(feedback.rating) + '☆'.repeat(5 - feedback.rating);
          
          html += `
            <div class="card">
              <h5>${feedback.activityName}</h5>
              <p><i class="bi bi-star-fill me-1"></i>${stars} (${feedback.rating}/5)</p>
              <p>${feedback.comment}</p>
              <p class="text-muted small"><i class="bi bi-calendar me-1"></i>${dateStr}</p>
            </div>
          `;
        });

        feedbackList.innerHTML = html;
        
      } catch (error) {
        console.error('載入回饋記錄失敗:', error);
        document.getElementById('my-feedback').innerHTML = '<div class="alert alert-danger">載入失敗</div>';
      }
    }

    // 管理員功能
    function showAdminSection(sectionName) {
      const sections = document.querySelectorAll('.admin-section');
      sections.forEach(section => section.style.display = 'none');
      
      const targetSection = document.getElementById(`admin-${sectionName}`);
      if (targetSection) {
        targetSection.style.display = 'block';
      }
      
      switch (sectionName) {
        case 'members':
          loadAdminMembers();
          break;
        case 'activities':
          loadAdminActivities();
          break;
        case 'finances':
          loadAdminFinances();
          break;
        case 'reports':
          loadAdminReports();
          break;
      }
    }

    async function loadAdminData() {
      try {
        const result = await callAPI('getAdminDashboard');
        
        if (result) {
          document.getElementById('admin-total-members').textContent = result.totalMembers || 0;
          document.getElementById('admin-active-members').textContent = result.activeMembers || 0;
          document.getElementById('admin-pending-approvals').textContent = result.pendingApprovals || 0;
          document.getElementById('admin-monthly-donations').textContent = result.monthlyDonations || 0;
        }
        
        // 預設顯示會員管理
        showAdminSection('members');
        
      } catch (error) {
        console.error('載入管理員資料失敗:', error);
      }
    }

    async function loadAdminMembers() {
      try {
        const result = await callAPI('getAllMembers');
        const memberList = document.getElementById('admin-member-list');
        
        if (!result || result.length === 0) {
          memberList.innerHTML = '<tr><td colspan="7" class="text-center text-muted">尚無會員</td></tr>';
          return;
        }

        let html = '';
        result.forEach(member => {
          const joinDate = member.joinDate ? new Date(member.joinDate).toLocaleDateString('zh-TW') : '未知';
          const lastActivity = member.lastActivity ? new Date(member.lastActivity).toLocaleDateString('zh-TW') : '無';
          
          html += `
            <tr>
              <td>${member.realName || member.lineName || '-'}</td>
              <td><span class="badge bg-${getMemberTypeBadge(member.memberType)}">${member.memberType || '未設定'}</span></td>
              <td>${member.phone || '-'}</td>
              <td><span class="status ${member.status === '已註冊' ? 'registered' : 'pending'}">${member.status}</span></td>
              <td>${joinDate}</td>
              <td>${lastActivity}</td>
              <td>
                <button class="btn btn-outline-primary btn-sm" onclick="viewMemberDetail('${member.lineId}')">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-warning btn-sm" onclick="editMember('${member.lineId}')">
                  <i class="bi bi-pencil"></i>
                </button>
              </td>
            </tr>
          `;
        });

        memberList.innerHTML = html;
        
      } catch (error) {
        console.error('載入會員列表失敗:', error);
        document.getElementById('admin-member-list').innerHTML = '<tr><td colspan="7" class="text-center text-danger">載入失敗</td></tr>';
      }
    }

    function getMemberTypeBadge(type) {
      switch (type) {
        case '病友': return 'primary';
        case '家屬': return 'success';
        case '志工': return 'warning';
        case '醫護': return 'info';
        default: return 'secondary';
      }
    }

    // 表單提交事件
    document.addEventListener('DOMContentLoaded', () => {
      // 捐款表單提交
      document.getElementById('donation-form-element').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const amount = parseInt(document.getElementById('donation-amount').value);
        const method = document.getElementById('donation-method').value;
        const date = document.getElementById('donation-date').value;
        const note = document.getElementById('donation-note').value.trim();

        try {
          const profile = await liff.getProfile();
          const result = await callAPI('addDonation', {
            lineId: profile.userId,
            amount,
            method,
            date,
            note
          });

          if (result.success) {
            showNotification('捐款記錄已新增', 'success');
            hideDonationForm();
            await loadDonations();
          } else {
            showNotification(`新增失敗：${result.message}`, 'error');
          }
        } catch (error) {
          console.error('新增捐款失敗:', error);
          showNotification('新增過程發生錯誤', 'error');
        }
      });

      // 支出申請表單提交
      document.getElementById('expense-form-element').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const category = document.getElementById('expense-category').value;
        const amount = parseInt(document.getElementById('expense-amount').value);
        const date = document.getElementById('expense-date').value;
        const description = document.getElementById('expense-description').value.trim();
        const receiptFile = document.getElementById('expense-receipt').files[0];

        try {
          const profile = await liff.getProfile();
          let receiptData = null;
          
          if (receiptFile) {
            receiptData = await fileToBase64(receiptFile);
          }

          const result = await callAPI('submitExpense', {
            lineId: profile.userId,
            category,
            amount,
            date,
            description,
            receipt: receiptData
          });

          if (result.success) {
            showNotification('支出申請已提交', 'success');
            hideExpenseForm();
            await loadMyExpenses();
          } else {
            showNotification(`提交失敗：${result.message}`, 'error');
          }
        } catch (error) {
          console.error('提交支出申請失敗:', error);
          showNotification('提交過程發生錯誤', 'error');
        }
      });

      // 活動表單提交
      document.getElementById('activity-form-element').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!isAdmin) {
          showNotification('權限不足', 'error');
          return;
        }

        const name = document.getElementById('activity-name').value.trim();
        const type = document.getElementById('activity-type').value;
        const date = document.getElementById('activity-date').value;
        const time = document.getElementById('activity-time').value;
        const location = document.getElementById('activity-location').value.trim();
        const maxPeople = parseInt(document.getElementById('activity-max-people').value);
        const description = document.getElementById('activity-description').value.trim();

        try {
          const profile = await liff.getProfile();
          const result = await callAPI('addActivity', {
            operatorLineId: profile.userId,
            name,
            type,
            date,
            time,
            location,
            maxPeople,
            description
          });

          if (result.success) {
            showNotification('活動已建立', 'success');
            hideActivityForm();
            await loadAdminActivities();
          } else {
            showNotification(`建立失敗：${result.message}`, 'error');
          }
        } catch (error) {
          console.error('建立活動失敗:', error);
          showNotification('建立過程發生錯誤', 'error');
        }
      });
    });

    // 工具函式
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    function showActivityForm() {
      document.getElementById('activity-form').style.display = 'block';
      document.getElementById('activity-date').value = new Date().toISOString().split('T')[0];
    }

    function hideActivityForm() {
      document.getElementById('activity-form').style.display = 'none';
      document.getElementById('activity-form-element').reset();
    }

    // 其他管理員功能的空實現
    async function loadAdminActivities() {
      document.getElementById('admin-activity-list').innerHTML = '<div class="alert alert-info">活動管理功能開發中...</div>';
    }

    async function loadAdminFinances() {
      document.getElementById('pending-expenses').innerHTML = '<div class="alert alert-info">財務審核功能開發中...</div>';
      document.getElementById('recent-receipts').innerHTML = '<div class="alert alert-info">收據管理功能開發中...</div>';
    }

    async function loadAdminReports() {
      document.getElementById('finance-report').innerHTML = '<div class="alert alert-info">報表分析功能開發中...</div>';
    }

    async function loadAdminTransactions() {
      document.getElementById('admin-transaction-list').innerHTML = '<tr><td colspan="7" class="text-center text-muted">交易記錄功能開發中...</td></tr>';
    }

    function searchMembers() {
      showNotification('會員搜尋功能開發中', 'warning');
    }

    function exportMembers() {
      showNotification('會員匯出功能開發中', 'warning');
    }

    function viewMemberDetail(lineId) {
      showNotification('會員詳情功能開發中', 'warning');
    }

    function editMember(lineId) {
      showNotification('會員編輯功能開發中', 'warning');
    }

    function generateReport() {
      showNotification('報表產生功能開發中', 'warning');
    }

    function exportAllData() {
      showNotification('資料匯出功能開發中', 'warning');
    }

    function showReceiptForm() {
      showNotification('收據開立功能開發中', 'warning');
    }

    // 頁面載入完成後初始化
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await initializeLiff();
        
        // 設定當前月份為預設值
        const currentDate = new Date();
        const reportMonth = document.getElementById('report-month');
        if (reportMonth) {
          reportMonth.value = currentDate.getMonth() + 1;
        }
        
        // 載入預設分頁資料
        await loadTabData('profile');
        
      } catch (error) {
        console.error('頁面初始化失敗:', error);
        showNotification('系統初始化失敗，請重新整理頁面', 'error');
      }
    });

    // 防止表單提交時頁面重新載入
    document.addEventListener('submit', (e) => {
      e.preventDefault();
    });

    // Service Worker 支援（PWA）
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
              .then(reg => console.log('Service Worker registered:', reg.scope))
              .catch(err => console.warn('Service Worker registration failed:', err));
          });
        }
  </script>
</body>
</html>
