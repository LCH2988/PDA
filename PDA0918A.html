<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>帕金森病友會整合系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="theme-color" content="#5563c1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <style>
    :root {
      --brand-grad: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --brand-accent: #667eea;
      --radius: 16px;
      --transition: .25s cubic-bezier(.4,0,.2,1);
    }
    [data-theme="dark"] {
      --bs-body-bg: #1f2430;
      --panel-bg: #2b3242;
      --panel-border: #394255;
      --text-color: #e6e9ef;
      --muted: #9aa4b4;
    }
    [data-theme="light"] {
      --bs-body-bg: #f5f7fb;
      --panel-bg: #ffffff;
      --panel-border: #e2e8f0;
      --text-color: #2d3748;
      --muted: #6b7280;
    }
    body {
      background: var(--bs-body-bg);
      color: var(--text-color);
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    .app-shell {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px 12px 60px;
    }
    .glass {
      background: rgba(255,255,255,0.75);
      backdrop-filter: blur(10px);
    }
    [data-theme="dark"] .glass {
      background: rgba(43,50,66,0.85);
    }
    .panel {
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius);
      padding: 20px 22px;
      margin-bottom: 20px;
      position: relative;
      transition: var(--transition);
    }
    .panel h5,.panel h4 { font-weight:600; }
    .panel-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .badge-soft {
      background: #eef2ff;
      color:#3949ab;
      font-weight:500;
    }
    [data-theme="dark"] .badge-soft {
      background:#394255;
      color:#a5b4fc;
    }
    .stat-grid {
      display:grid;
      gap:14px;
      grid-template-columns: repeat(auto-fit,minmax(150px,1fr));
    }
    .stat {
      background: var(--panel-bg);
      border:1px solid var(--panel-border);
      border-radius:12px;
      padding:16px 14px;
      position:relative;
      overflow:hidden;
      cursor:default;
    }
    .stat:hover { box-shadow:0 4px 16px rgba(0,0,0,.08); }
    .stat .label {
      font-size:.75rem;
      letter-spacing:.5px;
      text-transform:uppercase;
      color: var(--muted);
      font-weight:600;
    }
    .stat .value {
      font-size:1.8rem;
      font-weight:700;
      margin-top:4px;
      line-height:1.1;
    }
    .nav-main {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:18px;
    }
    .nav-main .nav-btn {
      border:1px solid var(--panel-border);
      background:var(--panel-bg);
      border-radius:50px;
      padding:8px 18px;
      font-size:.9rem;
      font-weight:500;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      transition:var(--transition);
    }
    .nav-main .nav-btn.active,
    .nav-main .nav-btn:hover {
      background: var(--brand-grad);
      color:#fff;
      border-color: transparent;
      box-shadow:0 4px 12px rgba(102,126,234,.35);
    }
    .divider {
      height:1px;
      background:var(--panel-border);
      margin:20px 0;
    }
    .table thead th {
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .activity-card {
      border:1px solid var(--panel-border);
      border-radius:14px;
      padding:14px 16px;
      margin-bottom:12px;
      position:relative;
      background: var(--panel-bg);
      transition:var(--transition);
    }
    .activity-card:hover {
      transform:translateY(-2px);
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    .floating-action {
      position:fixed;
      bottom:24px;
      right:24px;
      z-index:900;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .floating-action button {
      border-radius:50%;
      width:54px;
      height:54px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--brand-grad);
      color:#fff;
      border:none;
      box-shadow:0 6px 18px rgba(102,126,234,.4);
      font-size:1.3rem;
      transition:var(--transition);
    }
    .floating-action button:hover { transform:scale(1.08); }
    .search-bar {
      position:relative;
      margin-bottom:12px;
    }
    .search-bar input {
      padding-left:40px;
    }
    .search-bar .icon {
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      color:var(--muted);
    }
    .status-pill {
      font-size:.65rem;
      border-radius:10px;
      padding:4px 8px;
      font-weight:600;
      letter-spacing:.5px;
    }
    .status-open { background:#d1fae5; color:#065f46; }
    .status-full { background:#fee2e2; color:#991b1b; }
    .status-closed { background:#e5e7eb; color:#374151; }
    [data-theme="dark"] .status-open { background:#064e3b; color:#10b981; }
    [data-theme="dark"] .status-full { background:#7f1d1d; color:#fca5a5; }
    [data-theme="dark"] .status-closed { background:#374151; color:#d1d5db; }
    .pagination {
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:12px;
    }
    .pagination button {
      border:1px solid var(--panel-border);
      background:var(--panel-bg);
      padding:4px 12px;
      font-size:.8rem;
      border-radius:8px;
      cursor:pointer;
      transition:var(--transition);
    }
    .pagination button.active,
    .pagination button:hover {
      background:var(--brand-grad);
      color:#fff;
      border-color:transparent;
    }
    .notification-container {
      position:fixed;
      top:16px;
      right:16px;
      z-index:2000;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-width:380px;
    }
    .toast-msg {
      background:#fff;
      border-radius:14px;
      padding:14px 16px;
      box-shadow:0 10px 24px -4px rgba(0,0,0,.18);
      display:flex;
      gap:12px;
      animation: slideIn .4s ease;
      border-left:6px solid #667eea;
    }
    [data-theme="dark"] .toast-msg { background:#2b3242; }
    .toast-msg.success { border-left-color:#16a34a; }
    .toast-msg.error { border-left-color:#dc2626; }
    .toast-msg.warn { border-left-color:#d97706; }
    .toast-msg .close {
      background:transparent;
      border:none;
      color:inherit;
      margin-left:auto;
      font-size:1.05rem;
      cursor:pointer;
    }
    @keyframes slideIn {
      from { transform:translateX(40px); opacity:0; }
      to { transform:translateX(0); opacity:1; }
    }
    .skeleton {
      background:linear-gradient(90deg,#e5e7eb 25%,#f3f4f6 37%,#e5e7eb 63%);
      background-size:400% 100%;
      animation: shimmer 1.4s ease infinite;
      border-radius:8px;
      min-height:14px;
    }
    @keyframes shimmer {
      0% { background-position:100% 0; }
      100% { background-position:0 0; }
    }
    .hidden { display:none !important; }
    .tab-section { display:none; }
    .tab-section.active { display:block; animation:fade .35s ease; }
    @keyframes fade {
      from { opacity:0; transform:translateY(8px); }
      to { opacity:1; transform:translateY(0); }
    }
    .form-floating>.form-control:focus, .form-select:focus {
      box-shadow:0 0 0 2px rgba(102,126,234,.25);
    }
    .code-inline {
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      background: #1e293b;
      color:#f8fafc;
      padding:2px 6px;
      border-radius:6px;
      font-size:.75rem;
    }
    footer {
      margin-top:50px;
      text-align:center;
      font-size:.7rem;
      color:var(--muted);
    }
    .theme-toggle {
      cursor:pointer;
      padding:6px 10px;
      border-radius:10px;
      border:1px solid var(--panel-border);
      background:var(--panel-bg);
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.75rem;
      font-weight:500;
    }
    .flex-between { display:flex; justify-content:space-between; align-items:center; }
    .wrap { flex-wrap:wrap; }
    .gap-2 { gap:.5rem; }
    .text-muted-small { font-size:.7rem; color:var(--muted); }
    /* Scrollbars */
    ::-webkit-scrollbar { width:10px; height:10px; }
    ::-webkit-scrollbar-track { background:transparent; }
    ::-webkit-scrollbar-thumb { background:#c4c9d2; border-radius:20px; }
    [data-theme="dark"] ::-webkit-scrollbar-thumb { background:#4b5563; }
    ::-webkit-scrollbar-thumb:hover { background:#9aa4b1; }
    [data-theme="dark"] ::-webkit-scrollbar-thumb:hover { background:#6b7280; }
    /* Mobile tweaks */
    @media (max-width: 768px) {
      .nav-main { justify-content:flex-start; overflow-x:auto; scrollbar-width:none; }
      .nav-main::-webkit-scrollbar { display:none; }
      .stat .value { font-size:1.5rem; }
      .panel { padding:16px 16px; }
    }
  </style>
</head>
<body data-theme="light">
  <div class="notification-container" id="notify"></div>
  <div class="app-shell">
    <!-- Header / Top Bar -->
    <div class="panel flex-between wrap" style="align-items:flex-start; gap:14px;">
      <div>
        <h4 class="mb-1 d-flex align-items-center gap-2">
          <span>🏥 帕金森病友會整合系統</span>
          <span class="badge bg-primary">Unified</span>
        </h4>
        <div class="text-muted-small">
          會員服務 · 活動 · 志工 · 財務/收據 · 提案/動議 · 後台管理
        </div>
        <div id="currentUserLine" class="mt-2 small text-secondary">
          使用者狀態載入中...
        </div>
      </div>
      <div class="d-flex flex-column align-items-end gap-2">
        <div class="d-flex gap-2">
          <button class="theme-toggle" id="btnTheme">
            <i class="bi bi-moon-stars"></i><span>深色模式</span>
          </button>
          <button class="btn btn-sm btn-outline-primary" id="btnReloadProfile">
            <i class="bi bi-arrow-clockwise me-1"></i>重新載入資料
          </button>
        </div>
        <div class="d-flex gap-2">
          <button id="btnSwitchPortal" class="btn btn-sm btn-outline-secondary hidden">切換：管理後台</button>
          <button id="btnLogout" class="btn btn-sm btn-outline-danger"><i class="bi bi-box-arrow-right me-1"></i>登出</button>
        </div>
      </div>
    </div>

    <!-- Navigation (Dynamic between member portal / admin console) -->
    <div class="nav-main" id="memberNav">
      <button class="nav-btn active" data-section="member-dashboard"><i class="bi bi-speedometer2"></i>儀表板</button>
      <button class="nav-btn" data-section="member-profile"><i class="bi bi-person-badge"></i>個人資料</button>
      <button class="nav-btn" data-section="member-activities"><i class="bi bi-calendar-event"></i>活動</button>
      <button class="nav-btn" data-section="member-volunteer"><i class="bi bi-heart"></i>志工</button>
      <button class="nav-btn" data-section="member-finance"><i class="bi bi-wallet2"></i>財務</button>
      <button class="nav-btn" data-section="member-feedback"><i class="bi bi-chat-dots"></i>回饋</button>
      <button class="nav-btn hidden" id="navToAdmin"><i class="bi bi-shield-lock"></i>後台</button>
    </div>

    <div class="nav-main hidden" id="adminNav">
      <button class="nav-btn active" data-section="admin-dashboard"><i class="bi bi-speedometer2"></i>後台儀表板</button>
      <button class="nav-btn" data-section="admin-finance"><i class="bi bi-cash-coin"></i>財務管理</button>
      <button class="nav-btn" data-section="admin-receipts"><i class="bi bi-receipt-cutoff"></i>收據</button>
      <button class="nav-btn" data-section="admin-members"><i class="bi bi-people"></i>會員</button>
      <button class="nav-btn" data-section="admin-activities"><i class="bi bi-calendar3"></i>活動管理</button>
      <button class="nav-btn" data-section="admin-proposals"><i class="bi bi-file-text"></i>提案</button>
      <button class="nav-btn" data-section="admin-expenses"><i class="bi bi-receipt"></i>支出審核</button>
      <button class="nav-btn" data-section="admin-motions"><i class="bi bi-lightning"></i>臨時動議</button>
      <button class="nav-btn" data-section="admin-system"><i class="bi bi-gear-wide-connected"></i>系統工具</button>
      <button class="nav-btn" id="navBackToMember"><i class="bi bi-arrow-return-left"></i>返回會員</button>
    </div>

    <!-- MEMBER PORTAL SECTIONS -->
    <div id="memberSections">
      <!-- Dashboard -->
      <section id="member-dashboard" class="tab-section active">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">會員儀表板</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" id="btnRefreshMemberDash"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
          </div>
          <div class="stat-grid" id="memberStatsSkeleton">
            <div class="skeleton" style="height:90px;"></div>
            <div class="skeleton" style="height:90px;"></div>
            <div class="skeleton" style="height:90px;"></div>
            <div class="skeleton" style="height:90px;"></div>
          </div>
          <div class="stat-grid d-none" id="memberStats">
            <div class="stat">
              <div class="label">開放活動</div>
              <div class="value" id="stOpenActs">0</div>
            </div>
            <div class="stat">
              <div class="label">我的報名</div>
              <div class="value" id="stMyRegs">0</div>
            </div>
            <div class="stat">
              <div class="label">志工時數</div>
              <div class="value" id="stVolHours">0</div>
            </div>
            <div class="stat">
              <div class="label">捐款次數</div>
              <div class="value" id="stDonCount">0</div>
            </div>
          </div>
          <div class="divider"></div>
          <h6 class="mb-2">最新活動</h6>
          <div id="latestActivities" class="row g-3">
            <div class="col-12 skeleton" style="height:48px;"></div>
          </div>
        </div>
      </section>

      <!-- Profile -->
      <section id="member-profile" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">個人資料</h5>
            <button class="btn btn-sm btn-outline-success" id="btnSaveProfile"><i class="bi bi-save me-1"></i>儲存</button>
          </div>
          <form id="profileForm" class="row g-3">
            <div class="col-md-4">
              <div class="form-floating">
                <input type="text" id="pfLineName" class="form-control" disabled>
                <label>LINE 名稱</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="text" id="pfRealName" class="form-control" required>
                <label>真實姓名 *</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <select id="pfMemberType" class="form-select">
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                  <option value="醫護">醫護人員</option>
                  <option value="一般會員">一般會員</option>
                  <option value="VIP會員">VIP會員</option>
                </select>
                <label>會員類別</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="tel" id="pfPhone" class="form-control">
                <label>電話</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="email" id="pfEmail" class="form-control">
                <label>Email</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="date" id="pfBirthday" class="form-control">
                <label>生日</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea id="pfAddress" class="form-control" style="height:80px;"></textarea>
                <label>地址</label>
              </div>
            </div>
          </form>
          <div class="divider"></div>
          <h6>統計資訊</h6>
          <ul class="list-group small" id="profileStats"></ul>
        </div>
      </section>

      <!-- Activities -->
      <section id="member-activities" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">活動列表 / 報名</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" id="btnReloadActs"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
          </div>
          <div class="row g-3 mb-2">
            <div class="col-md-2">
              <select id="actFilterStatus" class="form-select form-select-sm">
                <option value="">全部狀態</option>
                <option value="開放報名">開放報名</option>
                <option value="已結束">已結束</option>
              </select>
            </div>
            <div class="col-md-2">
              <input type="date" id="actFilterDate" class="form-control form-control-sm">
            </div>
            <div class="col-md-3">
              <input type="text" id="actFilterSearch" class="form-control form-control-sm" placeholder="搜尋活動名稱/地點/描述">
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-sm btn-outline-secondary" id="btnApplyActFilter">篩選</button>
            </div>
          </div>
          <div id="activitiesList" class="mb-4"></div>
          <div id="activitiesPagination" class="pagination"></div>
          <div class="divider"></div>
          <h6 class="mb-2">我的報名</h6>
          <div id="myRegistrations"></div>
        </div>
      </section>

      <!-- Volunteer -->
      <section id="member-volunteer" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">志工服務</h5>
            <button class="btn btn-sm btn-outline-primary" id="btnReloadVolunteer">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
          <h6 class="mb-2">志工需求</h6>
          <div id="volNeedsList" class="mb-3"></div>
          <div class="divider"></div>
          <h6 class="mb-2">我的志工紀錄</h6>
          <div id="volRecordsList"></div>
        </div>
      </section>

      <!-- Finance (Member) -->
      <section id="member-finance" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">財務互動（個人）</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalDonation">
                <i class="bi bi-cash-coin me-1"></i>新增捐款
              </button>
              <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalExpense">
                <i class="bi bi-receipt me-1"></i>支出申請
              </button>
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <div class="stat">
                <div class="label">總捐款次數</div>
                <div class="value" id="finDonCountMember">0</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat">
                <div class="label">總捐款額</div>
                <div class="value" id="finDonAmountMember">0</div>
              </div>
            </div>
          </div>
          <h6>捐款紀錄</h6>
          <div id="memberDonationList" class="mb-3"></div>
          <div class="divider"></div>
          <h6>支出申請紀錄</h6>
          <div id="memberExpenseList"></div>
          <div class="divider d-none" id="memberFinAdminDivider"></div>
          <div id="financeOverviewAdmin" class="d-none">
            <h6>（管理員）組織財務概覽</h6>
            <div class="row g-3">
              <div class="col-md-3">
                <div class="stat">
                  <div class="label">總收入</div>
                  <div class="value" id="ovIncome">0</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat">
                  <div class="label">總支出</div>
                  <div class="value" id="ovExpense">0</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat">
                  <div class="label">餘額</div>
                  <div class="value" id="ovBalance">0</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat">
                  <div class="label">捐款筆數</div>
                  <div class="value" id="ovDonationCount">0</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Feedback -->
      <section id="member-feedback" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">活動回饋</h5>
            <button class="btn btn-sm btn-outline-primary" id="btnReloadFeedback"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <div class="form-floating">
                <select id="fbActivitySelect" class="form-select">
                  <option value="">選擇活動</option>
                </select>
                <label>已參與活動</label>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-floating">
                <select id="fbRating" class="form-select">
                  <option value="">選擇</option>
                  <option value="5">5 - 極好</option>
                  <option value="4">4 - 很好</option>
                  <option value="3">3 - 普通</option>
                  <option value="2">2 - 待改善</option>
                  <option value="1">1 - 不滿意</option>
                </select>
                <label>評分</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <textarea id="fbComment" class="form-control" style="height:90px;"></textarea>
                <label>意見 / 建議</label>
              </div>
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-sm btn-success" id="btnSubmitFeedback">
                <i class="bi bi-send me-1"></i>提交回饋
              </button>
            </div>
          </div>
          <div class="divider"></div>
          <h6>我的回饋紀錄</h6>
          <div id="myFeedbackList">尚無資料</div>
        </div>
      </section>
    </div>

    <!-- ADMIN CONSOLE SECTIONS -->
    <div id="adminSections" class="hidden">
      <!-- Admin Dashboard -->
      <section id="admin-dashboard" class="tab-section active">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">管理儀表板</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" id="btnRefreshAdminDashboard">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
          </div>
          <div class="stat-grid" id="adminDashStats">
            <div class="skeleton" style="height:110px;"></div>
            <div class="skeleton" style="height:110px;"></div>
            <div class="skeleton" style="height:110px;"></div>
            <div class="skeleton" style="height:110px;"></div>
            <div class="skeleton" style="height:110px;"></div>
            <div class="skeleton" style="height:110px;"></div>
          </div>
          <div class="divider"></div>
          <h6>提醒 / 系統訊息</h6>
          <ul class="list-group small" id="systemAlerts"></ul>
        </div>
      </section>

      <!-- Finance Management -->
      <section id="admin-finance" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">財務管理</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-success" id="btnShowTransactionForm"><i class="bi bi-plus-circle"></i> 交易</button>
              <button class="btn btn-sm btn-outline-secondary" id="btnExportTransactions"><i class="bi bi-download"></i> 匯出</button>
            </div>
          </div>
          <div id="transactionFormWrap" class="mb-3 hidden">
            <div class="card border-primary">
              <div class="card-header py-2 bg-primary text-white d-flex justify-content-between align-items-center">
                <span>新增交易</span>
                <button class="btn btn-sm btn-light" id="btnHideTransactionForm">關閉</button>
              </div>
              <div class="card-body">
                <form id="formTransaction" class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="txDate" class="form-control" required>
                      <label>日期</label>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-floating">
                      <select id="txType" class="form-select" required>
                        <option value="">選擇</option>
                        <option value="收入">收入</option>
                        <option value="支出">支出</option>
                      </select>
                      <label>類型</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="txCategory" class="form-select" required>
                        <option value="">請先選擇類型</option>
                      </select>
                      <label>類別</label>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-floating">
                      <input type="number" id="txAmount" min="1" class="form-control" required>
                      <label>金額</label>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-floating">
                      <select id="txAccount" class="form-select">
                        <option value="現金">現金</option>
                        <option value="銀行">銀行</option>
                      </select>
                      <label>帳戶</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="text" id="txTarget" class="form-control">
                      <label>對象 / 捐款人</label>
                    </div>
                  </div>
                  <div class="col-md-8">
                    <div class="form-floating">
                      <input type="text" id="txDesc" class="form-control">
                      <label>說明</label>
                    </div>
                  </div>
                  <div class="col-12" id="txReceiptBlock" class="hidden">
                    <div class="border rounded p-3">
                      <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" id="txNeedReceipt">
                        <label class="form-check-label" for="txNeedReceipt">開立收據</label>
                      </div>
                      <div id="txReceiptDetails" class="row g-3 hidden">
                        <div class="col-md-4">
                          <div class="form-floating">
                            <input type="text" id="rcName" class="form-control">
                            <label>收據抬頭</label>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-floating">
                            <input type="email" id="rcEmail" class="form-control">
                            <label>Email（選填）</label>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-floating">
                            <input type="text" id="rcPhone" class="form-control">
                            <label>聯絡電話</label>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-floating">
                            <input type="text" id="rcTaxId" class="form-control">
                            <label>統一編號</label>
                          </div>
                        </div>
                        <div class="col-md-8">
                          <div class="form-floating">
                            <textarea id="rcAddress" class="form-control" style="height:70px;"></textarea>
                            <label>地址</label>
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="rcSendNow">
                            <label for="rcSendNow" class="form-check-label">立即寄送 Email</label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-primary btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>儲存</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>交易清單</h6>
          <div class="table-responsive mb-3" style="max-height:400px;">
            <table class="table table-hover table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>日期</th><th>類型</th><th>類別</th><th>金額</th><th>對象</th><th>收據</th><th></th>
                </tr>
              </thead>
              <tbody id="txList"><tr><td colspan="7" class="text-center text-muted">載入中...</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Receipts -->
      <section id="admin-receipts" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">收據管理</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-info" id="btnOpenReceiptTemplate"><i class="bi bi-file-earmark-text"></i> 模板設定</button>
              <button class="btn btn-sm btn-outline-success" id="btnManualReceipt"><i class="bi bi-plus-circle"></i> 手動開立</button>
            </div>
          </div>
          <div id="manualReceiptForm" class="hidden mb-3">
            <div class="card border-success">
              <div class="card-header bg-success text-white py-2 d-flex justify-content-between">
                <span>手動開立收據</span>
                <button class="btn btn-sm btn-light" id="btnCloseManualReceipt">關閉</button>
              </div>
              <div class="card-body">
                <form id="formManualReceipt" class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="mrDate" class="form-control" required>
                      <label>日期</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="number" id="mrAmount" class="form-control" min="1" required>
                      <label>金額</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="mrCategory" class="form-select" required>
                        <option value="">選擇</option>
                        <option value="會費">會費</option>
                        <option value="捐款">捐款</option>
                        <option value="活動收入">活動收入</option>
                        <option value="其他收入">其他收入</option>
                      </select>
                      <label>類別</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="text" id="mrTitle" class="form-control" required>
                      <label>收據抬頭</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="email" id="mrEmail" class="form-control">
                      <label>Email（可空）</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="text" id="mrPhone" class="form-control">
                      <label>電話</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="text" id="mrTaxId" class="form-control">
                      <label>統編</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="mrAddress" class="form-control" style="height:70px;"></textarea>
                      <label>地址（可空）</label>
                    </div>
                  </div>
                  <div class="col-12 d-flex justify-content-between align-items-center">
                    <div class="form-check">
                      <input type="checkbox" id="mrSendNow" class="form-check-input">
                      <label for="mrSendNow" class="form-check-label">立即寄送（需 Email）</label>
                    </div>
                    <button class="btn btn-success btn-sm" type="submit">
                      <i class="bi bi-check-circle me-1"></i>開立
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>收據列表</h6>
          <div id="receiptList"><div class="text-center py-4 text-muted">載入中...</div></div>
        </div>
      </section>

      <!-- Members -->
      <section id="admin-members" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">會員管理</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" id="btnExportMembers"><i class="bi bi-download"></i> 匯出</button>
            </div>
          </div>
          <div class="row g-2 mb-2">
            <div class="col-md-3">
              <input type="text" id="memberSearch" class="form-control form-control-sm" placeholder="搜尋姓名 / LINE ID">
            </div>
            <div class="col-md-2">
              <select id="memberTypeFilter" class="form-select form-select-sm">
                <option value="">所有類別</option>
                <option value="志工">志工</option>
                <option value="病友">病友</option>
                <option value="家屬">家屬</option>
                <option value="一般會員">一般會員</option>
                <option value="VIP會員">VIP會員</option>
              </select>
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-sm btn-outline-secondary" id="btnSearchMembers">搜尋</button>
            </div>
          </div>
          <div class="table-responsive" style="max-height:420px;">
            <table class="table table-sm table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>姓名</th><th>電話</th><th>會員狀態</th><th>加入日期</th><th>最後捐款</th><th></th>
                </tr>
              </thead>
              <tbody id="memberList"><tr><td colspan="6" class="text-center text-muted">載入中...</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Activities (Admin) -->
      <section id="admin-activities" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">活動管理</h5>
            <button class="btn btn-sm btn-outline-success" id="btnShowActForm"><i class="bi bi-plus-circle"></i> 新增活動</button>
          </div>
          <div id="adminActFormWrap" class="hidden mb-3">
            <div class="card border-success">
              <div class="card-header bg-success text-white py-2 d-flex justify-content-between">
                <span>新增活動</span>
                <button class="btn btn-sm btn-light" id="btnCloseActForm">關閉</button>
              </div>
              <div class="card-body">
                <form id="formAdminActivity" class="row g-3">
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" id="admActName" class="form-control" required>
                      <label>活動名稱</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="admActType" class="form-select" required>
                        <option value="">選擇</option>
                        <option value="講座">講座</option>
                        <option value="聚會">聚會</option>
                        <option value="旅遊">旅遊</option>
                        <option value="運動">運動</option>
                        <option value="志工服務">志工服務</option>
                        <option value="其他">其他</option>
                      </select>
                      <label>活動類型</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="number" id="admActMax" class="form-control" value="50">
                      <label>人數上限</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="admActDate" class="form-control" required>
                      <label>日期</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="time" id="admActTime" class="form-control">
                      <label>時間</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" id="admActLocation" class="form-control">
                      <label>地點</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="admActDesc" class="form-control" style="height:80px;"></textarea>
                      <label>描述</label>
                    </div>
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-success btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>建立</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>活動清單</h6>
          <div id="adminActList" class="row g-3">
            <div class="col-12 text-center text-muted py-4">載入中...</div>
          </div>
        </div>
      </section>

      <!-- Proposals -->
      <section id="admin-proposals" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">提案審查</h5>
            <button class="btn btn-sm btn-outline-success" id="btnShowProposalForm"><i class="bi bi-plus-circle"></i> 新增提案</button>
          </div>
          <div id="proposalFormWrap" class="hidden mb-3">
            <div class="card border-success">
              <div class="card-header bg-success text-white py-2 d-flex justify-content-between">
                <span>新增提案</span>
                <button class="btn btn-sm btn-light" id="btnCloseProposalForm">關閉</button>
              </div>
              <div class="card-body">
                <form id="formProposal" class="row g-3">
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" id="propTitle" class="form-control" required>
                      <label>標題</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="propType" class="form-select" required>
                        <option value="">類型</option>
                        <option value="預算提案">預算提案</option>
                        <option value="活動提案">活動提案</option>
                        <option value="制度提案">制度提案</option>
                        <option value="人事提案">人事提案</option>
                        <option value="其他提案">其他提案</option>
                      </select>
                      <label>提案類型</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="number" id="propBudget" class="form-control" min="0">
                      <label>預算（可空）</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="propDeadline" class="form-control">
                      <label>執行期限</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="propContent" class="form-control" style="height:120px;" required></textarea>
                      <label>內容</label>
                    </div>
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-success btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>提交</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>提案列表</h6>
          <div id="proposalList"><div class="text-center py-4 text-muted">載入中...</div></div>
        </div>
      </section>

      <!-- Expenses Review -->
      <section id="admin-expenses" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">支出憑證審核</h5>
            <button class="btn btn-sm btn-outline-warning" id="btnShowExpenseSubmit"><i class="bi bi-plus-circle"></i> 提交憑證</button>
          </div>
          <div id="expenseSubmitWrap" class="hidden mb-3">
            <div class="card border-warning">
              <div class="card-header bg-warning py-2 d-flex justify-content-between">
                <span class="fw-bold">提交支出憑證</span>
                <button class="btn btn-sm btn-light" id="btnCloseExpenseSubmit">關閉</button>
              </div>
              <div class="card-body">
                <form id="formExpenseSubmit" class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="exDate" class="form-control" required>
                      <label>日期</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="exCategory" class="form-select" required>
                        <option value="">選擇</option>
                        <option value="活動費用">活動費用</option>
                        <option value="辦公費用">辦公費用</option>
                        <option value="交通費">交通費</option>
                        <option value="餐費">餐費</option>
                        <option value="場地費">場地費</option>
                        <option value="其他支出">其他支出</option>
                      </select>
                      <label>類別</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="number" id="exAmount" class="form-control" min="1" required>
                      <label>金額</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="text" id="exVendor" class="form-control" required>
                      <label>廠商 / 店家</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="exDesc" class="form-control" style="height:90px;" required></textarea>
                      <label>支出說明</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label fw-semibold">憑證圖片 (jpg/png)</label>
                    <input type="file" id="exFile" class="form-control" accept="image/*" required>
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-warning btn-sm" type="submit">
                      <i class="bi bi-check-circle me-1"></i>提交
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>支出列表</h6>
          <div id="expenseList"><div class="text-center py-4 text-muted">載入中...</div></div>
        </div>
      </section>

      <!-- Motions -->
      <section id="admin-motions" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">臨時動議</h5>
            <button class="btn btn-sm btn-outline-danger" id="btnShowMotionForm"><i class="bi bi-plus-circle"></i> 提出動議</button>
          </div>
          <div id="motionFormWrap" class="hidden mb-3">
            <div class="card border-danger">
              <div class="card-header bg-danger text-white py-2 d-flex justify-content-between">
                <span>提出臨時動議</span>
                <button class="btn btn-sm btn-light" id="btnCloseMotionForm">關閉</button>
              </div>
              <div class="card-body">
                <form id="formMotion" class="row g-3">
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" id="moTitle" class="form-control" required>
                      <label>標題</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="moUrgency" class="form-select" required>
                        <option value="">緊急程度</option>
                        <option value="緊急">緊急</option>
                        <option value="重要">重要</option>
                        <option value="一般">一般</option>
                      </select>
                      <label>緊急程度</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="moDeadline" class="form-control">
                      <label>決議期限</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="moContent" class="form-control" style="height:100px;" required></textarea>
                      <label>動議內容</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="moReason" class="form-control" style="height:70px;" required></textarea>
                      <label>提出理由</label>
                    </div>
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-danger btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>送出</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>動議列表</h6>
          <div id="motionList"><div class="text-center py-4 text-muted">載入中...</div></div>
        </div>
      </section>

      <!-- System Tools -->
      <section id="admin-system" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">系統工具 / 匯出 / 通知</h5>
          </div>
          <div class="row g-3">
            <div class="col-md-4">
              <div class="stat">
                <div class="label">備份</div>
                <div class="value" style="font-size:1.4rem;">System</div>
                <button class="btn btn-sm btn-outline-secondary mt-2 w-100" id="btnBackupSystem">
                  <i class="bi bi-hdd-stack me-1"></i>開始備份
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat">
                <div class="label">匯出</div>
                <div class="value" style="font-size:1.4rem;">Data</div>
                <button class="btn btn-sm btn-outline-secondary mt-2 w-100" id="btnExportDataAll">
                  <i class="bi bi-download me-1"></i>匯出資料
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat">
                <div class="label">通知</div>
                <div class="value" style="font-size:1.4rem;">Push</div>
                <button class="btn btn-sm btn-outline-secondary mt-2 w-100" id="btnSendSystemNotice">
                  <i class="bi bi-megaphone me-1"></i>發送通知
                </button>
              </div>
            </div>
          </div>
          <div class="divider"></div>
          <h6>匯出工具</h6>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-primary btn-sm export-btn" data-type="會員資料">會員</button>
            <button class="btn btn-outline-primary btn-sm export-btn" data-type="交易記錄">交易</button>
            <button class="btn btn-outline-primary btn-sm export-btn" data-type="收據記錄">收據</button>
            <button class="btn btn-outline-primary btn-sm export-btn" data-type="活動資料">活動</button>
          </div>
        </div>
      </section>
    </div>

    <footer class="mt-5">
      Unified Parkinson Association System | Front-end Integration Template v1.0.0 | 由 GPT-5 協助產出（請依需求調整） 
    </footer>
  </div>

  <!-- Floating global quick actions (context aware) -->
  <div class="floating-action" id="floatingActions">
    <button id="fabAddDonation" class="hidden" title="快速捐款"><i class="bi bi-cash-stack"></i></button>
    <button id="fabAddActivity" class="hidden" title="快速活動 (管理員)"><i class="bi bi-calendar-plus"></i></button>
    <button id="fabScrollTop" title="回到頂部"><i class="bi bi-arrow-up-short"></i></button>
  </div>

  <!-- Modals (Member Donation / Expense) -->
  <div class="modal fade" id="modalDonation" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="formDonation">
        <div class="modal-header">
          <h5 class="modal-title">新增捐款</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-3">
          <div class="col-md-6">
            <div class="form-floating">
              <input type="number" min="1" id="donAmount" class="form-control" required>
              <label>金額 *</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <select id="donMethod" class="form-select">
                <option value="現金">現金</option>
                <option value="轉帳">轉帳</option>
                <option value="信用卡">信用卡</option>
                <option value="其他">其他</option>
              </select>
              <label>方式</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <input type="date" id="donDate" class="form-control">
              <label>日期</label>
            </div>
          </div>
          <div class="col-12">
            <div class="form-floating">
              <textarea id="donNote" class="form-control" style="height:80px;"></textarea>
              <label>備註</label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal" type="button">取消</button>
          <button class="btn btn-primary btn-sm" type="submit">送出</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="modalExpense" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="formMemberExpense">
        <div class="modal-header">
          <h5 class="modal-title">支出申請</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-3">
          <div class="col-md-6">
            <div class="form-floating">
              <input type="text" id="memExpItem" class="form-control" required>
              <label>項目 *</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <input type="number" id="memExpAmount" class="form-control" min="1" required>
              <label>金額 *</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <select id="memExpCategory" class="form-select">
                <option value="活動費用">活動費用</option>
                <option value="交通費">交通費</option>
                <option value="餐飲費">餐飲費</option>
                <option value="設備費">設備費</option>
                <option value="其他">其他</option>
              </select>
              <label>類別</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <input type="date" id="memExpDate" class="form-control">
              <label>日期</label>
            </div>
          </div>
          <div class="col-12">
            <div class="form-floating">
              <textarea id="memExpDesc" class="form-control" style="height:80px;"></textarea>
              <label>說明</label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal" type="button">取消</button>
          <button class="btn btn-primary btn-sm" type="submit">送出</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Receipt Template Modal -->
  <div class="modal fade" id="modalReceiptTemplate" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-file-earmark-text me-1"></i>收據模板設定</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
          <div class="modal-body">
            <form id="formReceiptTemplate" class="row g-3">
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" id="tplDocId" class="form-control">
                  <label>Google 文件模板 ID</label>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-floating">
                  <input type="text" id="tplPrefix" class="form-control" value="RCP">
                  <label>收據前綴</label>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-floating">
                  <input type="text" id="tplOrgName" class="form-control">
                  <label>機構名稱</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" id="tplOrgPhone" class="form-control">
                  <label>機構電話</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <textarea id="tplOrgAddress" class="form-control" style="height:80px;"></textarea>
                  <label>機構地址</label>
                </div>
              </div>
            </form>
          </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary btn-sm" id="btnSaveReceiptTemplate"><i class="bi bi-save me-1"></i>儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dynamic Modal Container -->
  <div id="dynamicModal"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /*********************************************************
     * CONFIG 與 行為設定
     *********************************************************/
    const CONFIG = {
      LIFF_ID: 'REPLACE_WITH_LIFF_ID',  // TODO: 替換
      API_BASE: 'https://script.google.com/macros/s/REPLACE_APP_SCRIPT/exec', // TODO: 主 API
      API_KEY: 'AAbb8520258185202581',
      USE_SIGNATURE: false,
      RETRIES: 2,
      ACTIVITY_PAGE_SIZE: 8
    };

    /* 對應：為整合三份程式已出現的 action 名稱建立統一 map */
    const ACTION_MAP = {
      // 會員/登入
      register: 'register',
      getProfile: 'getProfile',
      updateProfile: 'updateProfile',
      getUserInfo: 'getUserInfo',
      updateUserContact: 'updateUserContact',

      // 活動 (會員)
      getActivities: 'getActivities',
      registerActivity: 'registerActivity',
      getMyRegistrations: 'getMyRegistrations',
      cancelActivity: 'cancelActivity',
      getUserActivities: 'getUserActivities',

      // 志工
      getVolunteerNeeds: 'getVolunteerNeeds',
      getMyVolunteerRecords: 'getMyVolunteerRecords',
      registerVolunteer: 'registerVolunteer',

      // 捐款 / 支出 (會員)
      getDonations: 'getDonations',
      addDonation: 'addDonation',
      getMyExpenses: 'getMyExpenses',
      submitExpense: 'submitExpense',

      // 財務總覽 (管理員)
      getFinanceOverview: 'getFinanceOverview',

      // 後台儀表板 & 系統
      getDashboardData: 'getDashboardData',
      exportData: 'exportData',
      backupSystem: 'backupSystem',
      sendSystemNotification: 'sendSystemNotification',

      // 財務管理 (後台)
      getTransactionList: 'getTransactionList',
      addTransactionWithReceipt: 'addTransactionWithReceipt',
      deleteTransaction: 'deleteTransaction',
      createReceiptForTransaction: 'createReceiptForTransaction',

      // 收據
      getReceiptTemplate: 'getReceiptTemplate',
      saveReceiptTemplate: 'saveReceiptTemplate',
      getReceiptList: 'getReceiptList',
      createManualReceipt: 'createManualReceipt',
      sendReceipt: 'sendReceipt',
      regenerateReceiptPDF: 'regenerateReceiptPDF',

      // 會員管理
      getMemberList: 'getMemberList',
      getMemberDetail: 'getMemberDetail',
      updateMemberStatus: 'updateMemberStatus',

      // 活動管理 (後台)
      addActivity: 'addActivity',
      getActivityList: 'getActivityList',
      exportActivityMembers: 'exportActivityMembers',

      // 提案
      addProposal: 'addProposal',
      getProposalList: 'getProposalList',
      voteProposal: 'voteProposal',

      // 支出審核
      addExpense: 'addExpense',
      getExpenseList: 'getExpenseList',
      approveExpense: 'approveExpense',

      // 動議
      addMotion: 'addMotion',
      getMotionList: 'getMotionList',
      processMotion: 'processMotion',

      // Feedback (預留 / 需後端實作)
      submitFeedback: 'submitFeedback',
      getMyFeedback: 'getMyFeedback'
    };

    /*********************************************************
     * 全域狀態
     *********************************************************/
    let currentUser = null;
    let isAdmin = false;
    let currentSection = 'member-dashboard';
    let activityCache = [];
    let filteredActivities = [];
    let currentActPage = 1;
    let liffProfile = null;

    /*********************************************************
     * 工具函式
     *********************************************************/
    const $ = (sel)=>document.querySelector(sel);
    const $all = (sel)=>document.querySelectorAll(sel);

    function fmtDate(d) {
      if(!d) return '-';
      const dt = new Date(d);
      if(isNaN(dt)) return '-';
      return dt.getFullYear()+'/'+String(dt.getMonth()+1).padStart(2,'0')+'/'+String(dt.getDate()).padStart(2,'0');
    }
    function fmtDateTime(d){
      if(!d) return '-';
      const dt=new Date(d);
      if(isNaN(dt)) return '-';
      return dt.toLocaleString('zh-TW');
    }
    function numberFmt(n) {
      return (Number(n)||0).toLocaleString();
    }
    function escapeHtml(str='') {
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    /*********************************************************
     * 通知系統
     *********************************************************/
    function notify(msg, type='info', ms=3500) {
      const cont = $('#notify');
      const div = document.createElement('div');
      div.className = 'toast-msg '+ (type==='error'?'error':type==='success'?'success':type==='warn'?'warn':'');
      div.innerHTML = `
        <div>
          <strong>${type==='error'?'錯誤': type==='success'?'成功': type==='warn'?'提醒':'訊息'}</strong><br>
          <span>${escapeHtml(msg)}</span>
        </div>
        <button class="close" aria-label="關閉">&times;</button>
      `;
      div.querySelector('.close').addEventListener('click', ()=> div.remove());
      cont.appendChild(div);
      if (ms) setTimeout(()=> div.remove(), ms);
    }

    /*********************************************************
     * API 呼叫封裝
     *********************************************************/
    async function callAPI(action, data={}, opt={silent:false}) {
      const payload = {
        action,
        apiKey: CONFIG.API_KEY,
        ...data,
        ts: Date.now(),
        nonce: Math.random().toString(36).slice(2)
      };
      if (CONFIG.USE_SIGNATURE) {
        const baseString = `${action}|${payload.ts}|${payload.nonce}|${CONFIG.API_KEY}`;
        payload.sign = CryptoJS.HmacSHA256(baseString, CONFIG.API_KEY).toString();
      }
      let attempt=0;
      while (attempt <= CONFIG.RETRIES) {
        try {
          const res = await fetch(CONFIG.API_BASE, {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify(payload),
            cache:'no-store'
          });
          if(!res.ok) throw new Error('HTTP '+res.status);
          const json = await res.json();
          if(json.success === false) {
            throw new Error(json.message || '操作失敗');
          }
          return json;
        } catch(e) {
          attempt++;
          if(attempt>CONFIG.RETRIES) {
            if(!opt.silent) notify(`API(${action}) 失敗：${e.message}`,'error',6000);
            throw e;
          }
          await new Promise(r=>setTimeout(r, 500 * attempt));
        }
      }
    }

    /*********************************************************
     * LIFF 初始化與使用者載入
     *********************************************************/
    async function initApp() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if(!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        liffProfile = await liff.getProfile();
        // 自動註冊 / 確保存在
          await safeRegister();
        await loadUserProfile();  // 取得後端資料
        setupUIByRole();
        await loadMemberDashboard();
      } catch(e) {
        notify('初始化失敗：'+ e.message,'error',8000);
        console.error(e);
      }
    }

    async function safeRegister() {
      try {
        await callAPI(ACTION_MAP.register,{
          lineId: liffProfile.userId,
          lineName: liffProfile.displayName,
          realName: liffProfile.displayName
        },{silent:true});
      } catch(e) {
        // 可能後端已存在 / 不支援; 不擋流程
        console.warn('register skipped:', e.message);
      }
    }

    async function loadUserProfile() {
      try {
        const pr = await callAPI(ACTION_MAP.getProfile,{ lineId: liffProfile.userId },{silent:true});
        currentUser = pr.data || pr; // 兼容不同格式
      } catch(e) {
        console.warn('getProfile fallback -> getUserInfo', e.message);
        try {
          const alt = await callAPI(ACTION_MAP.getUserInfo,{ lineId: liffProfile.userId },{silent:true});
          currentUser = alt.data || alt;
        } catch(e2) {
          notify('無法載入使用者資料','error');
        }
      }
      isAdmin = !!(currentUser && (currentUser.isAdmin || ['admin','chairman','director','supervisor'].includes(currentUser.role)));
      updateUserLine();
      fillProfileForm();
    }

    function updateUserLine() {
      const el = $("#currentUserLine");
      if(!currentUser) {
        el.textContent = '尚未載入使用者資料';
        return;
      }
      el.innerHTML = `
        <span class="me-2"><i class="bi bi-person-circle"></i> ${escapeHtml(currentUser.realName || currentUser.lineName || '用戶')}</span>
        <span class="badge bg-secondary me-2">${escapeHtml(currentUser.memberType || '會員')}</span>
        ${isAdmin ? '<span class="badge bg-danger">管理員</span>':''}
      `;
      if(isAdmin) {
        $('#navToAdmin').classList.remove('hidden');
        $('#btnSwitchPortal').classList.remove('hidden');
      }
    }

    function fillProfileForm() {
      if(!currentUser) return;
      $('#pfLineName').value = currentUser.lineName || '';
      $('#pfRealName').value = currentUser.realName || '';
      $('#pfPhone').value = currentUser.phone || '';
      $('#pfEmail').value = currentUser.email || '';
      $('#pfBirthday').value = currentUser.birthday || '';
      $('#pfMemberType').value = currentUser.memberType || '病友';
      $('#pfAddress').value = currentUser.address || '';
      const stats = [
        '狀態：' + (currentUser.status || '-'),
        '註冊：' + (currentUser.registerDate ? fmtDate(currentUser.registerDate) : '-'),
        '最後活動：' + (currentUser.lastActive ? fmtDate(currentUser.lastActive) : '-'),
        '志工時數：' + (currentUser.volunteerHours || 0),
        '活動次數：' + (currentUser.activityCount || 0)
      ];
      $('#profileStats').innerHTML = stats.map(s=>`<li class="list-group-item">${escapeHtml(s)}</li>`).join('');
    }

    function setupUIByRole() {
      // 預設顯示會員入口
      $('#memberSections').classList.remove('hidden');
      $('#adminSections').classList.add('hidden');
      $('#memberNav').classList.remove('hidden');
      $('#adminNav').classList.add('hidden');
    }

    /*********************************************************
     * 切換區塊 / 導航
     *********************************************************/
    function showSection(id) {
      currentSection = id;
      $all('.tab-section').forEach(sec => sec.classList.remove('active'));
      const target = '#'+id;
      const el = $(target);
      if(el) el.classList.add('active');
      // 切換 nav active
      $all('.nav-btn').forEach(btn=> btn.classList.remove('active'));
      const navBtn = document.querySelector(`.nav-btn[data-section="${id}"]`);
      if(navBtn) navBtn.classList.add('active');
      handleFabVisibility();
      // 進入某些頁面時自動載入
      if(id === 'member-activities') loadActivities();
      else if(id === 'member-volunteer') loadVolunteer();
      else if(id === 'member-finance') loadMemberFinance();
      else if(id === 'member-feedback') loadFeedbackModule();
      else if(id === 'admin-dashboard') loadAdminDashboard();
      else if(id === 'admin-finance') loadTransactions();
      else if(id === 'admin-receipts') loadReceipts();
      else if(id === 'admin-members') loadMemberList();
      else if(id === 'admin-activities') loadAdminActivities();
      else if(id === 'admin-proposals') loadProposals();
      else if(id === 'admin-expenses') loadExpenses();
      else if(id === 'admin-motions') loadMotions();
    }

    /*********************************************************
     * 主題切換
     *********************************************************/
    function toggleTheme() {
      const body = document.body;
      const current = body.getAttribute('data-theme');
      const next = current === 'light' ? 'dark':'light';
      body.setAttribute('data-theme', next);
      const icon = $('#btnTheme i');
      const label = $('#btnTheme span');
      if(next === 'dark') {
        icon.className='bi bi-sun';
        label.textContent='淺色模式';
      } else {
        icon.className='bi bi-moon-stars';
        label.textContent='深色模式';
      }
      localStorage.setItem('appTheme', next);
    }
    function initTheme() {
      const saved = localStorage.getItem('appTheme');
      if(saved) {
        document.body.setAttribute('data-theme', saved);
        if(saved==='dark') {
          $('#btnTheme i').className='bi bi-sun';
          $('#btnTheme span').textContent='淺色模式';
        }
      }
    }

    /*********************************************************
     * 會員儀表板
     *********************************************************/
    async function loadMemberDashboard() {
      // 取得活動、報名、志工、捐款
      try {
        $('#memberStatsSkeleton').classList.remove('d-none');
        $('#memberStats').classList.add('d-none');
        const [actsRes, regsRes, volsRes, donsRes] = await Promise.allSettled([
          callAPI(ACTION_MAP.getActivities,{},{silent:true}),
          callAPI(ACTION_MAP.getMyRegistrations,{ lineId: liffProfile.userId },{silent:true}),
          callAPI(ACTION_MAP.getMyVolunteerRecords,{ lineId: liffProfile.userId },{silent:true}),
          callAPI(ACTION_MAP.getDonations,{ lineId: liffProfile.userId },{silent:true})
        ]);

        const acts = actsRes.value?.data || actsRes.value || [];
        const regs = regsRes.value?.data || regsRes.value || [];
          const vols = volsRes.value?.data || volsRes.value || [];
        const dons = donsRes.value?.data || donsRes.value || [];

        $('#stOpenActs').textContent = acts.filter(a=>a.status==='開放報名' || a.status==='報名中').length;
        $('#stMyRegs').textContent = regs.filter(r=> r.status==='已報名' || r.status==='報名中').length;
        const volHours = vols.filter(v=> v.status==='已核准' || v.status==='通過')
          .reduce((s,v)=> s + (Number(v.hours||0)),0);
        $('#stVolHours').textContent = volHours;
        $('#stDonCount').textContent = dons.length;

        // 最新活動
        const latest = acts.slice(0,4);
        const container = $('#latestActivities');
        if(!latest.length) {
          container.innerHTML = '<div class="col-12 small text-muted">目前沒有活動</div>';
        } else {
          container.innerHTML = latest.map(a=>`
            <div class="col-md-6">
              <div class="activity-card">
                <div class="d-flex justify-content-between">
                  <strong>${escapeHtml(a.name || a.活動名稱 || '未命名')}</strong>
                  <span class="status-pill ${a.status==='開放報名'?'status-open': (a.currentCount && a.maxParticipants && a.currentCount>=a.maxParticipants?'status-full':'status-closed')}">
                    ${escapeHtml(a.status || a.活動狀態 || '')}
                  </span>
                </div>
                <div class="small text-muted">
                  日期：${fmtDate(a.activityDate || a.活動日期)}<br>
                  地點：${escapeHtml(a.location || a.活動地點 || '待定')}
                </div>
              </div>
            </div>
          `).join('');
        }

        $('#memberStatsSkeleton').classList.add('d-none');
        $('#memberStats').classList.remove('d-none');
      } catch(e) {
        notify('載入儀表板失敗：'+e.message,'error');
      }
    }

    /*********************************************************
     * 活動（會員）
     *********************************************************/
    async function loadActivities() {
      try {
        const res = await callAPI(ACTION_MAP.getActivities, buildActivityFilter(), {silent:true});
        activityCache = res.data || res;
        applyActivityFilter();
      } catch(e) {
        $('#activitiesList').innerHTML = '<div class="text-danger small">載入活動失敗</div>';
      }
      loadMyRegistrations();
    }

    function buildActivityFilter() {
      return {
        status: $('#actFilterStatus').value,
        date: $('#actFilterDate').value,
        search: $('#actFilterSearch').value.trim()
      };
    }
    function applyActivityFilter() {
      const { status, date, search } = buildActivityFilter();
      filteredActivities = activityCache.filter(a=>{
        const matchStatus = !status || (a.status===status || a.活動狀態===status);
        const matchDate = !date || (a.activityDate===date || a.活動日期===date || (a.activityDate || a.活動日期 || '').startsWith(date));
        const lower = (search||'').toLowerCase();
        const matchSearch = !search || (
          (a.name||'').toLowerCase().includes(lower) ||
          (a.description||'').toLowerCase().includes(lower) ||
          (a.location||'').toLowerCase().includes(lower) ||
          (a.活動名稱||'').toLowerCase().includes(lower) ||
          (a.活動描述||'').toLowerCase().includes(lower) ||
          (a.活動地點||'').toLowerCase().includes(lower)
        );
        return matchStatus && matchDate && matchSearch;
      });
      currentActPage = 1;
      renderActivitiesPage();
    }

    function renderActivitiesPage() {
      const wrap = $('#activitiesList');
      const pag = $('#activitiesPagination');
      const size = CONFIG.ACTIVITY_PAGE_SIZE;
      const total = filteredActivities.length;
      const pages = Math.ceil(total/size)||1;
      if(currentActPage>pages) currentActPage=pages;
      const start = (currentActPage-1)*size;
      const pageData = filteredActivities.slice(start, start+size);
      if(!pageData.length) {
        wrap.innerHTML = '<div class="small text-muted">無符合活動</div>';
        pag.innerHTML='';
        return;
      }
      wrap.innerHTML = pageData.map(a=>{
        const max = a.maxParticipants || a.人數上限;
        const cur = a.currentCount || a.報名人數 || 0;
        const full = max && cur >= max;
        const id = a.id || a.activityId || a.活動ID;
        const status = a.status || a.活動狀態 || '';
        const canReg = (status==='開放報名' || status==='報名中') && !full;
        return `
          <div class="activity-card">
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-bold">${escapeHtml(a.name || a.活動名稱 || '未命名')}</div>
              <span class="status-pill ${full?'status-full': canReg?'status-open':'status-closed'}">${full?'額滿':escapeHtml(status||'')}</span>
            </div>
            <div class="small text-muted">
              日期：${fmtDate(a.activityDate || a.活動日期)}　地點：${escapeHtml(a.location || a.活動地點 || '待定')}
            </div>
            <div class="small mt-1">
              人數：${cur}/${max || '∞'}
            </div>
            <div class="mt-2">
              ${canReg? `<button class="btn btn-sm btn-primary" data-act="${id}"><i class="bi bi-check2-circle me-1"></i>報名</button>`:''}
            </div>
          </div>
        `;
      }).join('');

      // Pagination
      let pagHtml='';
      for(let i=1;i<=pages;i++){
        pagHtml += `<button class="${i===currentActPage?'active':''}" data-page="${i}">${i}</button>`;
      }
      pag.innerHTML = pagHtml;

      // Bind events
      wrap.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.addEventListener('click', ()=> registerActivity(btn.getAttribute('data-act')));
      });
      pag.querySelectorAll('button[data-page]').forEach(b=>{
        b.addEventListener('click', ()=>{
          currentActPage = Number(b.getAttribute('data-page'));
          renderActivitiesPage();
        });
      });
    }

    async function registerActivity(id) {
      if(!currentUser) return notify('尚未載入使用者','warn');
      try {
        await callAPI(ACTION_MAP.registerActivity, {
          lineId: liffProfile.userId,
          activityId: id,
          participantName: currentUser.realName || currentUser.lineName
        });
        notify('活動報名成功','success');
        loadActivities();
      } catch(e) {
        notify('報名失敗：'+e.message,'error');
      }
    }

    async function loadMyRegistrations() {
      try {
        const res = await callAPI(ACTION_MAP.getMyRegistrations,{ lineId: liffProfile.userId },{silent:true});
        const regs = res.data || res;
        const container = $('#myRegistrations');
        if(!regs.length){
          container.innerHTML = '<div class="small text-muted">尚未報名任何活動</div>';
          return;
        }
        container.innerHTML = `
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light">
                <tr><th>活動</th><th>日期</th><th>狀態</th><th></th></tr>
              </thead>
              <tbody>
                ${regs.map(r=>{
                  const cancelBtn = (r.status==='已報名' || r.status==='報名中') ? `<button class="btn btn-sm btn-outline-danger" data-reg="${r.id || r.registrationId}"><i class="bi bi-x-circle"></i></button>`:'';
                  return `<tr>
                    <td>${escapeHtml(r.activityName || r.活動名稱 || '')}</td>
                    <td>${fmtDate(r.activityDate || r.活動日期)}</td>
                    <td>${escapeHtml(r.status || r.狀態 || '')}</td>
                    <td>${cancelBtn}</td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
        container.querySelectorAll('button[data-reg]').forEach(b=>{
          b.addEventListener('click',()=>{
            if(confirm('確定取消？')) cancelRegistration(b.getAttribute('data-reg'));
          });
        });
        // 也更新回饋活動選單
        loadActivitiesForFeedback(regs);
      } catch(e) {
        $('#myRegistrations').innerHTML='<div class="text-danger small">讀取失敗</div>';
      }
    }

    async function cancelRegistration(regId) {
      try {
        await callAPI(ACTION_MAP.cancelActivity,{
          lineId: liffProfile.userId,
          registrationId: regId
        });
        notify('已取消報名','success');
        loadActivities();
      } catch(e) {
        notify('取消失敗：'+e.message,'error');
      }
    }

    /*********************************************************
     * 志工
     *********************************************************/
    async function loadVolunteer() {
      try {
        const [needsRes, recordsRes] = await Promise.allSettled([
          callAPI(ACTION_MAP.getVolunteerNeeds, {}, {silent:true}),
          callAPI(ACTION_MAP.getMyVolunteerRecords, { lineId: liffProfile.userId }, {silent:true})
        ]);
        const needs = needsRes.value?.data || needsRes.value || [];
        $('#volNeedsList').innerHTML = needs.length
          ? needs.map(n=>{
              return `<div class="activity-card">
                <div class="d-flex justify-content-between">
                  <strong>${escapeHtml(n.activityName || '志工需求')}</strong>
                  <span class="badge bg-primary">${fmtDate(n.activityDate)}</span>
                </div>
                <div class="small text-muted">${escapeHtml(n.description || '')}</div>
                <div class="mt-2">
                  <button class="btn btn-sm btn-outline-primary" data-vol="${n.activityId}"><i class="bi bi-person-plus"></i> 報名志工</button>
                </div>
              </div>`;
            }).join('')
          : '<div class="small text-muted">目前無志工需求</div>';
        $('#volNeedsList').querySelectorAll('button[data-vol]').forEach(b=>{
          b.addEventListener('click',()=>registerVolunteer(b.getAttribute('data-vol')));
        });

        const records = recordsRes.value?.data || recordsRes.value || [];
        $('#volRecordsList').innerHTML = records.length
          ? `<div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead class="table-light">
                  <tr><th>活動</th><th>時數</th><th>狀態</th><th>日期</th></tr>
                </thead>
                <tbody>
                  ${records.map(r=>`
                    <tr>
                      <td>${escapeHtml(r.activityName||'')}</td>
                      <td>${r.hours||0}</td>
                      <td>${escapeHtml(r.status||'')}</td>
                      <td>${fmtDate(r.serviceDate)}</td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </div>`
          : '<div class="small text-muted">尚無志工紀錄</div>';
      } catch(e) {
        notify('載入志工資料失敗','error');
      }
    }

    async function registerVolunteer(activityId) {
      const hours = prompt('請輸入預估服務時數');
      if(!hours) return;
      try {
        await callAPI(ACTION_MAP.registerVolunteer,{
          lineId: liffProfile.userId,
          activityId,
          hours: parseFloat(hours)
        });
        notify('志工登記成功（待審核）','success');
        loadVolunteer();
      } catch(e) {
        notify('登記失敗：'+e.message,'error');
      }
    }

    /*********************************************************
     * 個人財務
     *********************************************************/
    async function loadMemberFinance() {
      try {
        const [donRes, expRes] = await Promise.allSettled([
          callAPI(ACTION_MAP.getDonations,{ lineId: liffProfile.userId },{silent:true}),
          callAPI(ACTION_MAP.getMyExpenses,{ lineId: liffProfile.userId },{silent:true})
        ]);
        const dons = donRes.value?.data || donRes.value || [];
        const exps = expRes.value?.data || expRes.value || [];
        let totalAmount = 0;
        dons.forEach(d=> totalAmount += Number(d.amount||d.金額||0));
        $('#finDonCountMember').textContent = dons.length;
        $('#finDonAmountMember').textContent = numberFmt(totalAmount);

        $('#memberDonationList').innerHTML = dons.length
          ? `<div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                  <tr><th>日期</th><th>金額</th><th>方式</th></tr>
                </thead>
                <tbody>
                  ${dons.map(d=>`
                    <tr>
                      <td>${fmtDate(d.donationDate || d.日期)}</td>
                      <td>${numberFmt(d.amount || d.金額)}</td>
                      <td>${escapeHtml(d.method || d.方式 || '')}</td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </div>`
          : '<div class="small text-muted">無捐款紀錄</div>';

        $('#memberExpenseList').innerHTML = exps.length
          ? `<div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                  <tr><th>日期</th><th>項目</th><th>金額</th><th>狀態</th></tr>
                </thead>
                <tbody>
                  ${exps.map(e=>`
                    <tr>
                      <td>${fmtDate(e.submitDate || e.提交日期 || e.expenseDate)}</td>
                      <td>${escapeHtml(e.item || e.項目 || '')}</td>
                      <td>${numberFmt(e.amount || e.金額)}</td>
                      <td>${escapeHtml(e.status || e.狀態 || '')}</td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </div>`
          : '<div class="small text-muted">無支出申請</div>';

        if(isAdmin) {
          $('#memberFinAdminDivider').classList.remove('d-none');
          $('#financeOverviewAdmin').classList.remove('d-none');
          try {
            const ovRes = await callAPI(ACTION_MAP.getFinanceOverview, { operatorLineId: liffProfile.userId },{silent:true});
            const ov = ovRes.data || ovRes;
            $('#ovIncome').textContent = numberFmt(ov.totalIncome || ov.總收入);
            $('#ovExpense').textContent = numberFmt(ov.totalExpense || ov.總支出);
            $('#ovBalance').textContent = numberFmt(ov.balance || ov.餘額);
            $('#ovDonationCount').textContent = numberFmt(ov.donationCount || ov.捐款筆數);
          } catch(e) {
            notify('無法載入財務總覽','warn');
          }
        } else {
          $('#memberFinAdminDivider').classList.add('d-none');
          $('#financeOverviewAdmin').classList.add('d-none');
        }
      } catch(e) {
        notify('載入財務資料失敗','error');
      }
    }

    // Member Donation
    $('#formDonation').addEventListener('submit', async e=>{
      e.preventDefault();
      try {
        await callAPI(ACTION_MAP.addDonation,{
          lineId: liffProfile.userId,
          amount: parseInt($('#donAmount').value),
          method: $('#donMethod').value,
          donationDate: $('#donDate').value,
          note: $('#donNote').value
        });
        notify('捐款已記錄','success');
        bootstrap.Modal.getInstance($('#modalDonation')).hide();
        $('#formDonation').reset();
        if(currentSection==='member-finance') loadMemberFinance();
      } catch(err) { notify(err.message,'error'); }
    });

    // Member Expense
    $('#formMemberExpense').addEventListener('submit', async e=>{
      e.preventDefault();
      try {
        await callAPI(ACTION_MAP.submitExpense,{
          lineId: liffProfile.userId,
          item: $('#memExpItem').value,
          amount: parseInt($('#memExpAmount').value),
          category: $('#memExpCategory').value,
          description: $('#memExpDesc').value,
          expenseDate: $('#memExpDate').value
        });
        notify('支出申請已送出','success');
        bootstrap.Modal.getInstance($('#modalExpense')).hide();
        $('#formMemberExpense').reset();
        if(currentSection==='member-finance') loadMemberFinance();
      } catch(err){ notify(err.message,'error'); }
    });

    /*********************************************************
     * 回饋 (Feedback)
     *********************************************************/
    function loadActivitiesForFeedback(regs) {
      const sel = $('#fbActivitySelect');
      sel.innerHTML = '<option value="">選擇活動</option>';
      regs.forEach(r=>{
        const id = r.activityId || r.活動ID;
        const name = r.activityName || r.活動名稱 || '活動';
        const opt = document.createElement('option');
          opt.value = id;
        opt.textContent = name;
        sel.appendChild(opt);
      });
    }

    async function loadFeedbackModule() {
      // 取得已參與活動 (再利用 getMyRegistrations)
      try {
        const regsRes = await callAPI(ACTION_MAP.getMyRegistrations,{ lineId:liffProfile.userId },{silent:true});
        const regs = regsRes.data || regsRes || [];
        loadActivitiesForFeedback(regs);
      } catch(e) {
        console.warn('回饋：活動載入失敗');
      }
      // 載入歷史回饋
      try {
        const fbRes = await callAPI(ACTION_MAP.getMyFeedback,{ lineId:liffProfile.userId },{silent:true});
        const arr = fbRes.data || fbRes || [];
        $('#myFeedbackList').innerHTML = arr.length
          ? arr.map(f=>`
              <div class="activity-card">
                <div class="d-flex justify-content-between">
                  <strong>${escapeHtml(f.activityName || '')}</strong>
                  <span class="badge bg-warning text-dark">${f.rating || f.評分 || ''}★</span>
                </div>
                <div class="small text-muted">${fmtDate(f.createDate || f.日期)}</div>
                <div class="mt-1 small">${escapeHtml(f.comment || f.意見 || '')}</div>
              </div>
            `).join('')
          : '<div class="small text-muted">尚無回饋</div>';
      } catch(e) {
        $('#myFeedbackList').innerHTML = '<div class="small text-muted">尚未實作回饋 API</div>';
      }
    }

    $('#btnSubmitFeedback').addEventListener('click', async ()=>{
      const actId = $('#fbActivitySelect').value;
      const rating = $('#fbRating').value;
      const comment = $('#fbComment').value.trim();
      if(!actId || !rating) return notify('請選擇活動與評分','warn');
      try {
        await callAPI(ACTION_MAP.submitFeedback,{
          lineId: liffProfile.userId,
          activityId: actId,
          rating,
          comment
        });
        notify('回饋已送出','success');
        $('#fbRating').value='';
        $('#fbComment').value='';
        loadFeedbackModule();
      } catch(e) {
        notify('回饋提交失敗 / 或尚未實作','error');
      }
    });

    /*********************************************************
     * 後台：儀表板
     *********************************************************/
    async function loadAdminDashboard() {
      const statsWrap = $('#adminDashStats');
      statsWrap.innerHTML = `
        <div class="skeleton" style="height:110px;"></div>
        <div class="skeleton" style="height:110px;"></div>
        <div class="skeleton" style="height:110px;"></div>
        <div class="skeleton" style="height:110px;"></div>
        <div class="skeleton" style="height:110px;"></div>
        <div class="skeleton" style="height:110px;"></div>`;
      try {
        const res = await callAPI(ACTION_MAP.getDashboardData,{}, {silent:true});
        const d = res.data || res;
        const statTpl = (label,val,icon,grad) => `
          <div class="stat" style="border:0;background:linear-gradient(135deg,${grad});color:#fff;">
            <div class="label" style="color:rgba(255,255,255,.85)">${label}</div>
            <div class="value" style="font-size:1.7rem;">${escapeHtml(String(val||0))}</div>
            <div style="position:absolute;right:8px;top:8px;font-size:1.3rem;opacity:.3;"><i class="${icon}"></i></div>
          </div>`;
        statsWrap.innerHTML = `
          ${statTpl('總會員數', d.總會員數 ,'bi bi-people-fill','#28a745,#20c997')}
          ${statTpl('本月捐款', d.本月捐款總額 ,'bi bi-heart-fill','#dc3545,#b91c1c')}
          ${statTpl('捐款次數', d.本月捐款次數 ,'bi bi-cash-coin','#f59e0b,#d97706')}
          ${statTpl('進行中活動', d.進行中活動 ,'bi bi-calendar-event','#6366f1,#4338ca')}
          ${statTpl('待審提案', d.待審提案 ,'bi bi-file-text','#0ea5e9,#0369a1')}
          ${statTpl('待審憑證', d.待審憑證 ,'bi bi-receipt','#ec4899,#be185d')}
        `;
        $('#systemAlerts').innerHTML = `
          <li class="list-group-item small">最後更新：${fmtDateTime(new Date())}</li>
          <li class="list-group-item small">本月收據：${d.本月收據數 || 0}</li>
          <li class="list-group-item small text-muted">若某數字顯示 0，請確認後端 Apps Script 是否已完整返回欄位。</li>
        `;
      } catch(e) {
        statsWrap.innerHTML = '<div class="col-12 text-danger small">載入失敗</div>';
      }
    }

    /*********************************************************
     * 後台：財務交易與收據
     *********************************************************/
    $('#txType').addEventListener('change', e=>{
      const val = e.target.value;
      const cat = $('#txCategory');
      if(val==='收入') {
        cat.innerHTML = `
          <option value="">選擇</option>
          <option value="會費">會費</option>
          <option value="捐款">捐款</option>
          <option value="活動收入">活動收入</option>
          <option value="政府補助">政府補助</option>
          <option value="其他收入">其他收入</option>`;
        $('#txReceiptBlock').classList.remove('hidden');
      } else if(val==='支出') {
        cat.innerHTML = `
          <option value="">選擇</option>
          <option value="活動費用">活動費用</option>
          <option value="辦公費用">辦公費用</option>
          <option value="交通費">交通費</option>
          <option value="餐費">餐費</option>
          <option value="場地費">場地費</option>
          <option value="其他支出">其他支出</option>`;
        $('#txReceiptBlock').classList.add('hidden');
      } else {
        cat.innerHTML = '<option value="">請先選擇類型</option>';
        $('#txReceiptBlock').classList.add('hidden');
      }
    });

    $('#txNeedReceipt').addEventListener('change', e=>{
      $('#txReceiptDetails').classList.toggle('hidden', !e.target.checked);
      if(e.target.checked) {
        const target = $('#txTarget').value;
        if(target && !$('#rcName').value) $('#rcName').value = target;
      }
    });

    $('#formTransaction').addEventListener('submit', async e=>{
      e.preventDefault();
      try {
        const needReceipt = $('#txNeedReceipt').checked;
        const payload = {
          日期: $('#txDate').value,
          類型: $('#txType').value,
          類別: $('#txCategory').value,
          金額: parseInt($('#txAmount').value),
          對象: $('#txTarget').value.trim(),
          帳戶: $('#txAccount').value,
          說明: $('#txDesc').value.trim(),
          開立收據: needReceipt,
          userId: liffProfile.userId
        };
        if(needReceipt) {
          payload.收據資料 = {
            收據抬頭: $('#rcName').value.trim(),
            Email: $('#rcEmail').value.trim(),
            聯絡電話: $('#rcPhone').value.trim(),
            統一編號: $('#rcTaxId').value.trim(),
            地址: $('#rcAddress').value.trim(),
            備註: '',
            立即寄送: $('#rcSendNow').checked
          };
        }
        await callAPI(ACTION_MAP.addTransactionWithReceipt, payload);
        notify('交易新增成功'+ (needReceipt?'（含收據）':''),'success');
        $('#formTransaction').reset();
        $('#txReceiptDetails').classList.add('hidden');
        loadTransactions();
      } catch(e2) {
        notify('新增失敗：'+e2.message,'error');
      }
    });

    async function loadTransactions() {
      const tbody = $('#txList');
      tbody.innerHTML = '<tr><td colspan="7" class="text-muted text-center">載入中...</td></tr>';
      try {
        const res = await callAPI(ACTION_MAP.getTransactionList,{}, {silent:true});
        const data = res.data || res || [];
        if(!data.length) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-muted text-center">目前無交易</td></tr>';
          return;
        }
        tbody.innerHTML = data.slice(0,80).map(t=>{
          const amount = Number(t.金額||t.amount||0);
          const type = t.類型 || t.type;
          const sign = type==='收入'? '+':'-';
          const color = type==='收入'?'text-success':'text-danger';
          return `
            <tr>
              <td>${fmtDate(t.日期)}</td>
              <td><span class="badge ${type==='收入'?'bg-success':'bg-danger'}">${type}</span></td>
              <td>${escapeHtml(t.類別||'')}</td>
              <td class="${color}">${sign}$${numberFmt(amount)}</td>
              <td>${escapeHtml(t.對象||'-')}</td>
              <td>${
                t.收據編號
                  ? `<span class="badge bg-info">${escapeHtml(t.收據編號)}</span>`
                  : (type==='收入'
                      ? `<button class="btn btn-sm btn-outline-success" data-makercp="${t.編號}"><i class="bi bi-plus-circle"></i></button>`
                      : '-')
              }</td>
              <td>
                <button class="btn btn-sm btn-outline-danger" data-del="${t.編號}"><i class="bi bi-trash"></i></button>
              </td>
            </tr>
          `;
        }).join('');
        tbody.querySelectorAll('button[data-del]').forEach(btn=>{
          btn.addEventListener('click',()=>{
            if(confirm('確定刪除？')) deleteTransaction(btn.getAttribute('data-del'));
          });
        });
        tbody.querySelectorAll('button[data-makercp]').forEach(btn=>{
          btn.addEventListener('click',()=>createReceiptOnTx(btn.getAttribute('data-makercp')));
        });
      } catch(e) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-danger text-center">載入失敗</td></tr>';
      }
    }

    async function deleteTransaction(id) {
      try {
        await callAPI(ACTION_MAP.deleteTransaction,{ transactionId:id, deleterId:liffProfile.userId });
        notify('已刪除','success');
        loadTransactions();
      } catch(e) {
        notify('刪除失敗：'+e.message,'error');
      }
    }

    async function createReceiptOnTx(txId) {
      const title = prompt('收據抬頭：');
      if(!title) return;
      const email = prompt('Email（可空）') || '';
      const sendNow = email ? confirm('立即寄送？'): false;
      try {
        await callAPI(ACTION_MAP.createReceiptForTransaction,{
          transactionId: txId,
          收據抬頭: title.trim(),
          Email: email.trim(),
          立即寄送: sendNow,
          userId: liffProfile.userId
        });
        notify('收據已開立'+ (sendNow?'並寄送':''),'success');
        loadTransactions();
        loadReceipts();
      } catch(e) {
        notify('補開失敗：'+e.message,'error');
      }
    }

    // Receipts
    async function loadReceipts() {
      const list = $('#receiptList');
      list.innerHTML = '<div class="text-center py-4 text-muted">載入中...</div>';
      try {
        const res = await callAPI(ACTION_MAP.getReceiptList,{}, {silent:true});
        const data = res.data || res || [];
        if(!data.length) {
          list.innerHTML = '<div class="text-center py-4 text-muted">尚無收據</div>';
          return;
        }
        list.innerHTML = data.slice(0,100).map(r=>{
          return `<div class="activity-card">
            <div class="d-flex justify-content-between">
              <div>
                <strong>${escapeHtml(r.收據編號 || '')}</strong><br>
                <span class="small text-muted">${fmtDate(r.收據日期)}</span>
              </div>
              <div class="text-end">
                <span class="badge ${receiptStatusBadge(r.狀態)}">${escapeHtml(r.狀態||'')}</span><br>
                <span class="small">$${numberFmt(r.金額)}</span>
              </div>
            </div>
            <div class="small mt-2">
              抬頭：${escapeHtml(r.收據抬頭||'')}<br>
              類別：${escapeHtml(r.收入類別||'')}
            </div>
            <div class="mt-2 d-flex gap-2 flex-wrap">
              ${r.PDF連結? `<button class="btn btn-sm btn-outline-primary" onclick="window.open('${r.PDF連結}','_blank')"><i class="bi bi-file-pdf"></i> PDF</button>`:''}
              ${(r.Email && r.狀態!=='已寄送')
                  ? `<button class="btn btn-sm btn-outline-success" data-sendrc="${r.收據ID}"><i class="bi bi-envelope"></i></button>`:''
              }
              <button class="btn btn-sm btn-outline-secondary" data-regencp="${r.收據ID}">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
          </div>`;
        }).join('');

        list.querySelectorAll('button[data-sendrc]').forEach(btn=>{
          btn.addEventListener('click', ()=> sendReceipt(btn.getAttribute('data-sendrc')));
        });
        list.querySelectorAll('button[data-regencp]').forEach(btn=>{
          btn.addEventListener('click', ()=> regenerateReceiptPDF(btn.getAttribute('data-regencp')));
        });
      } catch(e) {
        list.innerHTML = '<div class="text-center text-danger py-4">載入失敗</div>';
      }
    }
    function receiptStatusBadge(st) {
      switch(st) {
        case '已開立': return 'bg-success';
        case '已寄送': return 'bg-primary';
        case '錯誤': return 'bg-danger';
        default: return 'bg-secondary';
      }
    }
    async function sendReceipt(id) {
      try {
        await callAPI(ACTION_MAP.sendReceipt,{ receiptId:id });
        notify('收據已寄送','success');
        loadReceipts();
      } catch(e) {
        notify('寄送失敗：'+e.message,'error');
      }
    }
    async function regenerateReceiptPDF(id) {
      try {
        await callAPI(ACTION_MAP.regenerateReceiptPDF,{ receiptId:id });
        notify('PDF 已重新產生','success');
        loadReceipts();
      } catch(e) {
        notify('重新產生失敗：'+e.message,'error');
      }
    }

    // Receipt template
    $('#btnOpenReceiptTemplate').addEventListener('click', async ()=>{
      const modal = new bootstrap.Modal($('#modalReceiptTemplate'));
      try {
        const res = await callAPI(ACTION_MAP.getReceiptTemplate,{}, {silent:true});
        const t = res.data || res;
        $('#tplDocId').value = t.templateDocId || '';
        $('#tplPrefix').value = t.receiptPrefix || 'RCP';
        $('#tplOrgName').value = t.organizationName || '';
        $('#tplOrgPhone').value = t.organizationPhone || '';
        $('#tplOrgAddress').value = t.organizationAddress || '';
      } catch(e) {
        notify('載入模板設定失敗','warn');
      }
      modal.show();
    });

    $('#btnSaveReceiptTemplate').addEventListener('click', async ()=>{
      try {
        await callAPI(ACTION_MAP.saveReceiptTemplate,{
          templateDocId: $('#tplDocId').value.trim(),
          receiptPrefix: $('#tplPrefix').value.trim(),
          organizationName: $('#tplOrgName').value.trim(),
          organizationAddress: $('#tplOrgAddress').value.trim(),
          organizationPhone: $('#tplOrgPhone').value.trim()
        });
        notify('模板已儲存','success');
        bootstrap.Modal.getInstance($('#modalReceiptTemplate')).hide();
      } catch(e) {
        notify('儲存失敗：'+e.message,'error');
      }
    });

    // Manual receipt
    $('#btnManualReceipt').addEventListener('click', ()=>{
      $('#manualReceiptForm').classList.remove('hidden');
      $('#mrDate').value = new Date().toISOString().split('T')[0];
    });
    $('#btnCloseManualReceipt').addEventListener('click', ()=>{
      $('#manualReceiptForm').classList.add('hidden');
      $('#formManualReceipt').reset();
    });
    $('#formManualReceipt').addEventListener('submit', async e=>{
      e.preventDefault();
      try {
        await callAPI(ACTION_MAP.createManualReceipt,{
          收據日期: $('#mrDate').value,
          金額: parseInt($('#mrAmount').value),
          收據抬頭: $('#mrTitle').value.trim(),
          收入類別: $('#mrCategory').value,
          Email: $('#mrEmail').value.trim(),
          聯絡電話: $('#mrPhone').value.trim(),
          統一編號: $('#mrTaxId').value.trim(),
          地址: $('#mrAddress').value.trim(),
          備註: '',
          立即寄送: $('#mrSendNow').checked,
          開立人: liffProfile.userId
        });
        notify('收據已開立','success');
        $('#formManualReceipt').reset();
        $('#manualReceiptForm').classList.add('hidden');
        loadReceipts();
        loadTransactions();
      } catch(e2) {
        notify('開立失敗：'+e2.message,'error');
      }
    });

    /*********************************************************
     * 會員管理
     *********************************************************/
    async function loadMemberList() {
      const tbody = $('#memberList');
      tbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center">載入中...</td></tr>';
      try {
        const res = await callAPI(ACTION_MAP.getMemberList,{}, {silent:true});
        const data = res.data || res || [];
        if(!data.length) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center">尚無會員</td></tr>';
          return;
        }
        tbody.innerHTML = data.slice(0,120).map(m=>{
          return `<tr>
            <td>${escapeHtml(m.真實姓名 || m.realName || m.LINE名稱 || '-')}</td>
            <td>${escapeHtml(m.電話 || m.phone || '-')}</td>
            <td><span class="badge ${m.是否會員?'bg-success':'bg-secondary'}">${m.是否會員?'正式會員':'一般'}</span></td>
            <td>${fmtDate(m.加入日期)}</td>
            <td>${m.最後捐款日期? fmtDate(m.最後捐款日期): '-'}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" data-member="${m.用戶ID || m.memberId}">
                <i class="bi bi-eye"></i>
              </button>
            </td>
          </tr>`;
        }).join('');
        tbody.querySelectorAll('button[data-member]').forEach(btn=>{
          btn.addEventListener('click',()=>viewMemberDetail(btn.getAttribute('data-member')));
        });
      } catch(e) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-danger text-center">載入失敗</td></tr>';
      }
    }

    async function viewMemberDetail(memberId) {
      try {
        const res = await callAPI(ACTION_MAP.getMemberDetail,{ memberId });
        const m = res.data || res;
        const donations = (m.捐款記錄||[]).slice(0,8).map(d=>`
          <tr>
            <td>${fmtDate(d.日期)}</td>
            <td class="text-success">$${numberFmt(d.金額)}</td>
            <td>${escapeHtml(d.類別||'')}</td>
            <td>${escapeHtml(d.收據編號||'-')}</td>
          </tr>`).join('') || `<tr><td colspan="4" class="text-center text-muted">無</td></tr>`;
        const acts = (m.活動參與||[]).slice(0,8).map(a=>`
          <tr>
            <td>${escapeHtml(a.活動名稱||'')}</td>
            <td>${fmtDate(a.活動日期)}</td>
            <td><span class="badge ${a.參與狀態==='已參加'?'bg-success':'bg-warning'}">${escapeHtml(a.參與狀態||'-')}</span></td>
          </tr>`).join('') || `<tr><td colspan="3" class="text-center text-muted">無</td></tr>`;

        const modalHtml = `
          <div class="modal fade" id="modalMemberDetail" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">會員詳情 - ${escapeHtml(m.真實姓名|| m.realName || m.LINE名稱 || '')}</h5>
                  <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="col-md-6 small">
                      <h6>基本資料</h6><hr class="mt-1">
                      <p><strong>姓名：</strong>${escapeHtml(m.真實姓名|| m.realName||'-')}</p>
                      <p><strong>LINE 名稱：</strong>${escapeHtml(m.LINE名稱||m.lineName||'-')}</p>
                      <p><strong>電話：</strong>${escapeHtml(m.電話|| m.phone || '-')}</p>
                      <p><strong>Email：</strong>${escapeHtml(m.Email|| m.email || '-')}</p>
                      <p><strong>會員狀態：</strong><span class="badge ${m.是否會員?'bg-success':'bg-secondary'}">${m.是否會員?'正式會員':'一般'}</span></p>
                      <p><strong>加入日期：</strong>${fmtDate(m.加入日期)}</p>
                      <p><strong>地址：</strong>${escapeHtml(m.地址||'-')}</p>
                      <p><strong>生日：</strong>${m.生日?fmtDate(m.生日):'-'}</p>
                    </div>
                    <div class="col-md-6 small">
                      <h6>捐款統計</h6><hr class="mt-1">
                      <p><strong>總額：</strong>$${numberFmt(m.總捐款金額)}</p>
                      <p><strong>次數：</strong>${m.捐款次數||0}</p>
                      <p><strong>最後捐款：</strong>${m.最後捐款日期? fmtDate(m.最後捐款日期): '-'}</p>
                      <p><strong>平均：</strong>$${(m.捐款次數>0)? numberFmt(Math.round(m.總捐款金額/m.捐款次數)):0}</p>
                    </div>
                  </div>
                  <hr>
                  <h6>最近捐款</h6>
                  <div class="table-responsive mb-3">
                    <table class="table table-sm">
                      <thead><tr><th>日期</th><th>金額</th><th>類別</th><th>收據</th></tr></thead>
                      <tbody>${donations}</tbody>
                    </table>
                  </div>
                  <h6>活動參與</h6>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead><tr><th>活動名稱</th><th>日期</th><th>狀態</th></tr></thead>
                      <tbody>${acts}</tbody>
                    </table>
                  </div>
                </div>
                <div class="modal-footer">
                  ${m.是否會員
                    ? `<button class="btn btn-warning btn-sm" id="btnDowngrade"><i class="bi bi-person-dash"></i> 取消會員資格</button>`
                    : `<button class="btn btn-success btn-sm" id="btnUpgrade"><i class="bi bi-person-check"></i> 升級為會員</button>`}
                  <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
                </div>
              </div>
            </div>
          </div>`;
        $('#dynamicModal').innerHTML = modalHtml;
        const modal = new bootstrap.Modal($('#modalMemberDetail'));
        modal.show();

        $('#btnUpgrade')?.addEventListener('click',()=> updateMemberStatus(memberId,true, modal));
        $('#btnDowngrade')?.addEventListener('click',()=> updateMemberStatus(memberId,false, modal));
      } catch(e) {
        notify('載入會員詳情失敗','error');
      }
    }

    async function updateMemberStatus(memberId,isMember, modal) {
      if(!confirm('確定要'+ (isMember?'升級為會員':'取消會員資格') +'？')) return;
      try {
        await callAPI(ACTION_MAP.updateMemberStatus,{
          memberId,
          isMember,
          updaterId: liffProfile.userId
        });
        notify('已更新','success');
        modal.hide();
        loadMemberList();
        loadAdminDashboard();
      } catch(e) {
        notify('更新失敗：'+e.message,'error');
      }
    }

    /*********************************************************
     * 活動管理（後台）
     *********************************************************/
    async function loadAdminActivities() {
      const list = $('#adminActList');
      list.innerHTML = '<div class="col-12 text-center text-muted py-4">載入中...</div>';
      try {
        const res = await callAPI(ACTION_MAP.getActivityList,{}, {silent:true});
        const data = res.data || res || [];
        if(!data.length) {
          list.innerHTML='<div class="col-12 text-center text-muted py-4">尚無活動</div>';
          return;
        }
        list.innerHTML = data.map(a=>{
          const ratio = a.人數上限 ? Math.min(100, ((Number(a.報名人數||0))/a.人數上限)*100):0;
          return `<div class="col-md-4">
            <div class="activity-card">
              <div class="d-flex justify-content-between">
                <strong>${escapeHtml(a.活動名稱||'活動')}</strong>
                <span class="badge ${actStatusBadge(a.活動狀態)}">${escapeHtml(a.活動狀態||'')}</span>
              </div>
              <div class="small text-muted">
                日期：${fmtDate(a.活動日期)} ${a.活動時間||''}<br>
                報名：${a.報名人數||0}/${a.人數上限||'∞'}
              </div>
              <div class="progress mt-2" style="height:5px;">
                <div class="progress-bar" style="width:${ratio}%"></div>
              </div>
              <div class="d-flex gap-2 mt-2">
                <button class="btn btn-sm btn-outline-primary" data-actview="${a.活動ID}"><i class="bi bi-eye"></i></button>
                <button class="btn btn-sm btn-outline-success" data-actexp="${a.活動ID}"><i class="bi bi-download"></i></button>
              </div>
            </div>
          </div>`;
        }).join('');
        list.querySelectorAll('button[data-actexp]').forEach(b=>{
          b.addEventListener('click',()=> exportActivityMembers(b.getAttribute('data-actexp')));
        });
        list.querySelectorAll('button[data-actview]').forEach(b=>{
          b.addEventListener('click',()=> viewActivityDetailAdmin(b.getAttribute('data-actview')));
        });
      } catch(e) {
        list.innerHTML='<div class="col-12 text-center text-danger py-4">載入失敗</div>';
      }
    }
    function actStatusBadge(status) {
      switch(status) {
        case '報名中':
        case '開放報名': return 'bg-success text-white';
        case '進行中': return 'bg-primary text-white';
        case '已結束': return 'bg-secondary text-white';
        case '已取消': return 'bg-danger text-white';
        default: return 'bg-light text-dark';
      }
    }
    async function exportActivityMembers(id) {
      try {
        const res = await callAPI(ACTION_MAP.exportActivityMembers,{ activityId:id });
        const csv = res.data || res.csv || '無資料';
        downloadCsv(csv, '活動名單_'+id+'_'+Date.now()+'.csv');
        notify('名單已匯出','success');
      } catch(e) {
        notify('匯出失敗：'+e.message,'error');
      }
    }
    function viewActivityDetailAdmin(id) {
      notify('活動詳情(可擴充) ID:'+id,'info');
    }

    $('#formAdminActivity').addEventListener('submit', async e=>{
      e.preventDefault();
      try {
        await callAPI(ACTION_MAP.addActivity,{
          活動名稱: $('#admActName').value.trim(),
          活動類型: $('#admActType').value,
          活動日期: $('#admActDate').value,
          活動時間: $('#admActTime').value,
          活動地點: $('#admActLocation').value.trim(),
          人數上限: parseInt($('#admActMax').value)||50,
          活動描述: $('#admActDesc').value.trim(),
          建立者: liffProfile.userId
        });
        notify('活動已建立','success');
        $('#formAdminActivity').reset();
        $('#adminActFormWrap').classList.add('hidden');
        loadAdminActivities();
        loadAdminDashboard();
      } catch(e2) {
        notify('建立失敗：'+e2.message,'error');
      }
    });

    /*********************************************************
     * 提案
     *********************************************************/
    async function loadProposals() {
      const list = $('#proposalList');
      list.innerHTML = '<div class="text-center py-4 text-muted">載入中...</div>';
      try {
        const res = await callAPI(ACTION_MAP.getProposalList,{}, {silent:true});
        const data = res.data || res || [];
        if(!data.length) {
          list.innerHTML = '<div class="text-center py-4 text-muted">尚無提案</div>';
          return;
        }
        list.innerHTML = data.map(p=>{
          return `<div class="activity-card">
            <div class="d-flex justify-content-between">
              <strong>${escapeHtml(p.提案標題||'')}</strong>
              <span class="badge ${proposalStatusBadge(p.審查狀態)}">${escapeHtml(p.審查狀態||'')}</span>
            </div>
            <div class="small text-muted">
              類型：${escapeHtml(p.提案類型||'')} | 提案人：${escapeHtml(p.提案人姓名||'')}
            </div>
            <div class="small mt-1">${escapeHtml(p.提案內容||'')}</div>
            ${p.預算金額? `<div class="small text-muted">預算：$${numberFmt(p.預算金額)}</div>`:''}
            <div class="small text-muted">提案：${fmtDateTime(p.提案時間)}</div>
            ${renderProposalVoteButtons(p)}
            ${renderProposalVoteStats(p)}
          </div>`;
        }).join('');
        // 綁定投票按鈕
        list.querySelectorAll('button[data-vote]').forEach(b=>{
          b.addEventListener('click',()=>{
            voteProposal(b.getAttribute('data-id'), b.getAttribute('data-vote'));
          });
        });
      } catch(e) {
        list.innerHTML = '<div class="text-center text-danger py-4">載入失敗</div>';
      }
    }
    function proposalStatusBadge(st) {
      switch(st) {
        case '待審查': return 'bg-warning text-dark';
        case '審查中': return 'bg-info';
        case '已通過': return 'bg-success';
        case '已否決': return 'bg-danger';
        case '需修正': return 'bg-secondary';
        default: return 'bg-light text-dark';
      }
    }
    function renderProposalVoteButtons(p){
      if(p.審查狀態==='待審查' && isAdmin) {
        return `
          <div class="mt-2 d-flex gap-2">
            <button class="btn btn-sm btn-success" data-vote="通過" data-id="${p.提案ID}"><i class="bi bi-check2-circle"></i></button>
            <button class="btn btn-sm btn-danger" data-vote="否決" data-id="${p.提案ID}"><i class="bi bi-x-circle"></i></button>
            <button class="btn btn-sm btn-warning" data-vote="修正" data-id="${p.提案ID}"><i class="bi bi-pencil"></i></button>
          </div>
        `;
      }
      return '';
    }
    function renderProposalVoteStats(p){
      if(!p.投票結果) return '';
      return `<div class="small mt-2 p-2 border rounded">
        <strong>投票結果</strong><br>
        贊成：${p.投票結果.贊成||0}　反對：${p.投票結果.反對||0}　修正：${p.投票結果.修正||0}
        <div class="text-muted">總：${p.投票結果.總投票數}/${p.投票結果.應投票數}</div>
      </div>`;
    }
    async function voteProposal(id,vote) {
      let comment = '';
      if(vote==='修正') {
        comment = prompt('請輸入修正建議：');
        if(!comment) return notify('需提供修正建議','warn');
      } else {
        comment = prompt('投票理由（可空）') || '';
      }
      try {
        await callAPI(ACTION_MAP.voteProposal,{
          proposalId: id,
          vote,
          comment,
          voterId: liffProfile.userId
        });
        notify('投票完成','success');
        loadProposals();
        loadAdminDashboard();
      } catch(e) {
        notify('投票失敗：'+e.message,'error');
      }
    }
    $('#formProposal').addEventListener('submit', async e=>{
      e.preventDefault();
      try {
        await callAPI(ACTION_MAP.addProposal,{
          提案標題: $('#propTitle').value.trim(),
          提案類型: $('#propType').value,
          提案內容: $('#propContent').value.trim(),
          預算金額: parseInt($('#propBudget').value)||0,
          執行期限: $('#propDeadline').value,
          提案人: liffProfile.userId
        });
        notify('提案已提交','success');
        $('#formProposal').reset();
        $('#proposalFormWrap').classList.add('hidden');
        loadProposals();
        loadAdminDashboard();
      } catch(e2) {
        notify('提交失敗：'+e2.message,'error');
      }
    });

    /*********************************************************
     * 支出審核 (後台)
     *********************************************************/
    async function loadExpenses() {
      const list = $('#expenseList');
      list.innerHTML = '<div class="text-center py-4 text-muted">載入中...</div>';
      try {
        const res = await callAPI(ACTION_MAP.getExpenseList,{}, {silent:true});
        const data = res.data || res || [];
        if(!data.length) {
          list.innerHTML = '<div class="text-center py-4 text-muted">尚無憑證</div>';
          return;
        }
        list.innerHTML = data.slice(0,80).map(e=>{
          return `<div class="activity-card">
            <div class="d-flex justify-content-between">
              <strong>${escapeHtml(e.廠商店家||'')}-${numberFmt(e.支出金額||0)}</strong>
              <span class="badge ${expenseStatusBadge(e.審核狀態)}">${escapeHtml(e.審核狀態||'')}</span>
            </div>
            <div class="small text-muted mb-1">
              日期：${fmtDate(e.支出日期)} | 類別：${escapeHtml(e.支出類別||'')}
            </div>
            <div class="small">${escapeHtml(e.支出說明||'')}</div>
            ${e.憑證圖片連結? `<div class="mt-2"><img src="${e.憑證圖片連結}" style="max-width:140px;border-radius:8px;cursor:pointer;" onclick="window.open('${e.憑證圖片連結}','_blank')"></div>`:''}
            <div class="small text-muted mt-1">
              提交：${escapeHtml(e.提交人姓名||'')} | ${fmtDateTime(e.提交時間)}
            </div>
            ${renderExpenseActions(e)}
            ${e.審核意見? `<div class="small mt-2 p-2 border rounded">
              <strong>審核意見：</strong>${escapeHtml(e.審核意見)}<br>
              <span class="text-muted">審核人：${escapeHtml(e.審核人姓名||'')} | ${fmtDateTime(e.審核時間)}</span>
            </div>`:''}
          </div>`;
        }).join('');
// --- 繼續 (接續 loadExpenses() 內被截斷的部分) ---
        list.querySelectorAll('button[data-expdec]').forEach(b=>{
          b.addEventListener('click',()=>{
            const [id, decision] = (b.getAttribute('data-expdec')||'').split('|');
            if(!id || !decision) return notify('資料異常','warn');
            approveExpense(id, decision);
          });
        });
      } catch(e) {
        list.innerHTML = '<div class="text-center text-danger py-4">載入失敗</div>';
      }
    }

    function expenseStatusBadge(st){
      switch(st){
        case '待審核': return 'bg-warning text-dark';
        case '已核准': return 'bg-success';
        case '已退回': return 'bg-danger';
        default: return 'bg-secondary';
      }
    }

    function renderExpenseActions(e){
      if(e.審核狀態 === '待審核' && isAdmin){
        return `<div class="mt-2 d-flex gap-2">
          <button class="btn btn-sm btn-success" data-expdec="${e.支出ID}|核准">
            <i class="bi bi-check2-circle"></i>
          </button>
          <button class="btn btn-sm btn-danger" data-expdec="${e.支出ID}|退回">
            <i class="bi bi-x-circle"></i>
          </button>
        </div>`;
      }
      return '';
    }

    async function approveExpense(expenseId, decision){
      let comment = '';
      if(decision === '退回'){
        comment = prompt('請輸入退回原因：') || '';
        if(!comment.trim()) return notify('需提供退回原因','warn');
      } else {
        comment = prompt('審核意見（可空）') || '';
      }
      try {
        await callAPI(ACTION_MAP.approveExpense,{
          expenseId,
          decision,        // '核准' / '退回'
          comment,
          reviewerId: liffProfile.userId
        });
        notify('憑證已處理','success');
        loadExpenses();
        loadAdminDashboard();
      } catch(e) {
        notify('處理失敗：'+e.message,'error');
      }
    }

    /*********************************************************
     * 臨時動議 (後台)
     *********************************************************/
    async function loadMotions(){
      const list = $('#motionList');
      list.innerHTML = '<div class="text-center py-4 text-muted">載入中...</div>';
      try {
        const res = await callAPI(ACTION_MAP.getMotionList,{}, {silent:true});
        const data = res.data || res || [];
        if(!data.length){
          list.innerHTML = '<div class="text-center py-4 text-muted">尚無動議</div>';
          return;
        }
        list.innerHTML = data.slice(0,80).map(m=>{
          return `<div class="activity-card">
            <div class="d-flex justify-content-between">
              <strong>${escapeHtml(m.動議標題||'')}</strong>
              <span class="badge ${motionStatusBadge(m.處理狀態)}">${escapeHtml(m.處理狀態||'')}</span>
            </div>
            <div class="small text-muted">
              提出：${escapeHtml(m.提議人姓名||'')} | ${fmtDateTime(m.提出時間)}
            </div>
            <div class="small mt-1">${escapeHtml(m.動議內容||'')}</div>
            <div class="small text-muted mt-1">理由：${escapeHtml(m.提出理由||'')}</div>
            ${m.決議期限? `<div class="small text-muted">期限：${fmtDate(m.決議期限)}</div>`:''}
            ${renderMotionActions(m)}
            ${m.處理結果? `<div class="small mt-2 p-2 border rounded">
              <strong>結果：</strong>${escapeHtml(m.處理結果)}<br>
              <span class="text-muted">處理人：${escapeHtml(m.處理人姓名||'')} | ${fmtDateTime(m.處理時間)}</span>
            </div>`:''}
          </div>`;
        }).join('');
        list.querySelectorAll('button[data-motion]').forEach(b=>{
          b.addEventListener('click',()=>{
            const [id, decision] = b.getAttribute('data-motion').split('|');
            processMotion(id, decision);
          });
        });
      } catch(e) {
        list.innerHTML = '<div class="text-center text-danger py-4">載入失敗</div>';
      }
    }

    function motionStatusBadge(st){
      switch(st){
        case '待處理': return 'bg-warning text-dark';
        case '已通過': return 'bg-success';
        case '不通過': return 'bg-danger';
        case '延後討論': return 'bg-secondary';
        default: return 'bg-light text-dark';
      }
    }

    function renderMotionActions(m){
      if(m.處理狀態==='待處理' && isAdmin){
        return `<div class="mt-2 d-flex gap-2">
          <button class="btn btn-sm btn-success" data-motion="${m.動議ID}|通過"><i class="bi bi-check2-circle"></i></button>
          <button class="btn btn-sm btn-danger" data-motion="${m.動議ID}|不通過"><i class="bi bi-x-circle"></i></button>
          <button class="btn btn-sm btn-secondary" data-motion="${m.動議ID}|延後"><i class="bi bi-clock-history"></i></button>
        </div>`;
      }
      return '';
    }

    async function processMotion(motionId, decision){
      let resultNote = '';
      if(decision==='延後'){
        resultNote = prompt('延後理由（可空）') || '';
        decision = '延後討論';
      } else if(decision==='不通過'){
        resultNote = prompt('不通過理由（可空）') || '';
      } else {
        resultNote = prompt('通過備註（可空）') || '';
      }
      try {
        await callAPI(ACTION_MAP.processMotion,{
          motionId,
            decision,
          resultNote,
          reviewerId: liffProfile.userId
        });
        notify('動議已處理','success');
        loadMotions();
        loadAdminDashboard();
      } catch(e) {
        notify('處理失敗：'+e.message,'error');
      }
    }

    /*********************************************************
     * 系統工具 / 匯出
     *********************************************************/
    function downloadCsv(content, filename){
      const blob = new Blob([content], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=> {
        URL.revokeObjectURL(url);
        a.remove();
      }, 0);
    }

    // 個別匯出按鈕（系統工具區域）
    $all('.export-btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const type = btn.getAttribute('data-type');
        try {
          const res = await callAPI(ACTION_MAP.exportData,{ dataset:type });
          const csv = res.data || res.csv || '';
          if(!csv) return notify('無資料可匯出','warn');
          downloadCsv(csv, `${type}_${Date.now()}.csv`);
          notify(type+' 已匯出','success');
        } catch(e) {
          notify(type+' 匯出失敗：'+e.message,'error');
        }
      });
    });

    // 全部匯出
    $('#btnExportDataAll').addEventListener('click', async ()=>{
      if(!confirm('確定匯出全部資料？')) return;
      try {
        const res = await callAPI(ACTION_MAP.exportData,{ dataset:'ALL' });
        const zip = res.data || res.zip || '';
        if(!zip) {
          notify('後端尚未提供 ZIP，嘗試改為多 CSV','warn');
          // 可擴充：多次呼叫 exportData
        } else {
          // 假設後端返回 base64 ZIP
          const link = document.createElement('a');
          link.href = 'data:application/zip;base64,'+zip;
          link.download = 'ALL_EXPORT_'+Date.now()+'.zip';
          document.body.appendChild(link);
          link.click();
          link.remove();
        }
        notify('匯出完成','success');
      } catch(e) {
        notify('全部匯出失敗：'+e.message,'error');
      }
    });

    // 備份
    $('#btnBackupSystem').addEventListener('click', async ()=>{
      if(!confirm('執行系統備份？')) return;
      try {
        await callAPI(ACTION_MAP.backupSystem,{ operator:liffProfile.userId });
        notify('備份已啟動（請稍後於後端確認）','success');
      } catch(e) {
        notify('備份失敗：'+e.message,'error');
      }
    });

    // 系統通知
    $('#btnSendSystemNotice').addEventListener('click', async ()=>{
      const msg = prompt('輸入要發送的系統通知內容：');
      if(!msg) return;
      try {
        await callAPI(ACTION_MAP.sendSystemNotification,{
          message: msg,
          sender: liffProfile.userId
        });
        notify('通知已送出','success');
      } catch(e) {
        notify('發送失敗：'+e.message,'error');
      }
    });

    // 交易匯出（財務管理頁）
    $('#btnExportTransactions').addEventListener('click', async ()=>{
      try {
        const res = await callAPI(ACTION_MAP.exportData,{ dataset:'交易記錄' });
        const csv = res.data || res.csv || '';
        if(!csv) return notify('無資料','warn');
        downloadCsv(csv,'交易記錄_'+Date.now()+'.csv');
        notify('交易已匯出','success');
      } catch(e) {
        notify('匯出失敗：'+e.message,'error');
      }
    });

    // 會員匯出（會員管理頁）
    $('#btnExportMembers').addEventListener('click', async ()=>{
      try {
        const res = await callAPI(ACTION_MAP.exportData,{ dataset:'會員資料' });
        const csv = res.data || res.csv || '';
        if(!csv) return notify('無資料','warn');
        downloadCsv(csv,'會員資料_'+Date.now()+'.csv');
        notify('會員已匯出','success');
      } catch(e) {
        notify('匯出失敗：'+e.message,'error');
      }
    });

    /*********************************************************
     * 入口 / 後台切換
     *********************************************************/
    function switchToAdmin(){
      if(!isAdmin) return notify('您不是管理員','warn');
      $('#memberSections').classList.add('hidden');
      $('#adminSections').classList.remove('hidden');
      $('#memberNav').classList.add('hidden');
      $('#adminNav').classList.remove('hidden');
      showSection('admin-dashboard');
      handleFabVisibility();
    }

    function switchToMember(){
      $('#adminSections').classList.add('hidden');
      $('#memberSections').classList.remove('hidden');
      $('#adminNav').classList.add('hidden');
      $('#memberNav').classList.remove('hidden');
      showSection('member-dashboard');
      handleFabVisibility();
    }

    $('#navToAdmin').addEventListener('click', switchToAdmin);
    $('#btnSwitchPortal').addEventListener('click', ()=>{
      if($('#adminSections').classList.contains('hidden')) switchToAdmin();
      else switchToMember();
    });
    $('#navBackToMember').addEventListener('click', switchToMember);

    /*********************************************************
     * 導航按鈕事件
     *********************************************************/
    $all('.nav-btn[data-section]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const sec = btn.getAttribute('data-section');
        showSection(sec);
      });
    });

    /*********************************************************
     * 活動篩選事件
     *********************************************************/
    $('#btnApplyActFilter').addEventListener('click', applyActivityFilter);
    $('#btnReloadActs').addEventListener('click', loadActivities);

    /*********************************************************
     * 儀表板重新整理
     *********************************************************/
    $('#btnRefreshMemberDash').addEventListener('click', loadMemberDashboard);
    $('#btnRefreshAdminDashboard').addEventListener('click', loadAdminDashboard);

    /*********************************************************
     * Profile 儲存 / 重新載入
     *********************************************************/
    $('#btnSaveProfile').addEventListener('click', async ()=>{
      if(!currentUser) return;
      try {
        await callAPI(ACTION_MAP.updateProfile,{
          lineId: liffProfile.userId,
          realName: $('#pfRealName').value.trim(),
          phone: $('#pfPhone').value.trim(),
          email: $('#pfEmail').value.trim(),
          birthday: $('#pfBirthday').value,
          memberType: $('#pfMemberType').value,
          address: $('#pfAddress').value.trim()
        });
        notify('個人資料已更新','success');
        loadUserProfile();
      } catch(e) {
        notify('更新失敗：'+e.message,'error');
      }
    });

    $('#btnReloadProfile').addEventListener('click', loadUserProfile);

    /*********************************************************
     * 主題切換
     *********************************************************/
    $('#btnTheme').addEventListener('click', toggleTheme);

    /*********************************************************
     * 後台：表單顯示/隱藏
     *********************************************************/
    // 交易表單
    $('#btnShowTransactionForm').addEventListener('click', ()=> $('#transactionFormWrap').classList.remove('hidden'));
    $('#btnHideTransactionForm').addEventListener('click', ()=> $('#transactionFormWrap').classList.add('hidden'));

    // 活動表單
    $('#btnShowActForm').addEventListener('click', ()=>{
      $('#adminActFormWrap').classList.remove('hidden');
      $('#admActDate').value = new Date().toISOString().split('T')[0];
    });
    $('#btnCloseActForm').addEventListener('click', ()=>{
      $('#adminActFormWrap').classList.add('hidden');
      $('#formAdminActivity').reset();
    });

    // 提案表單
    $('#btnShowProposalForm').addEventListener('click', ()=> {
      $('#proposalFormWrap').classList.remove('hidden');
      $('#propDeadline').value='';
    });
    $('#btnCloseProposalForm').addEventListener('click', ()=> {
      $('#proposalFormWrap').classList.add('hidden');
      $('#formProposal').reset();
    });

    // 支出憑證提交
    $('#btnShowExpenseSubmit').addEventListener('click', ()=>{
      $('#expenseSubmitWrap').classList.remove('hidden');
      $('#exDate').value = new Date().toISOString().split('T')[0];
    });
    $('#btnCloseExpenseSubmit').addEventListener('click', ()=>{
      $('#expenseSubmitWrap').classList.add('hidden');
      $('#formExpenseSubmit').reset();
    });

    // 動議表單
    $('#btnShowMotionForm').addEventListener('click', ()=>{
      $('#motionFormWrap').classList.remove('hidden');
      $('#moDeadline').value='';
    });
    $('#btnCloseMotionForm').addEventListener('click', ()=>{
      $('#motionFormWrap').classList.add('hidden');
      $('#formMotion').reset();
    });

    /*********************************************************
     * 動議提交
     *********************************************************/
    $('#formMotion').addEventListener('submit', async e=>{
      e.preventDefault();
      try {
        await callAPI(ACTION_MAP.addMotion,{
          動議標題: $('#moTitle').value.trim(),
          動議內容: $('#moContent').value.trim(),
          提出理由: $('#moReason').value.trim(),
          緊急程度: $('#moUrgency').value,
          決議期限: $('#moDeadline').value,
          提議人: liffProfile.userId
        });
        notify('動議已提交','success');
        $('#formMotion').reset();
        $('#motionFormWrap').classList.add('hidden');
        loadMotions();
        loadAdminDashboard();
      } catch(e2){
        notify('提交失敗：'+e2.message,'error');
      }
    });

    /*********************************************************
     * 支出憑證（提交）（會員或管理員共用此後端?）
     *********************************************************/
    $('#formExpenseSubmit').addEventListener('submit', async e=>{
      e.preventDefault();
      const fileInput = $('#exFile');
      const file = fileInput.files[0];
      if(!file) return notify('請選擇圖片','warn');

      // 上傳圖片（若後端尚未實作，需自行補 Apps Script 圖片端點）
      try {
        // 假設後端支援 Base64 字串
        const b64 = await fileToBase64(file);
        await callAPI(ACTION_MAP.addExpense,{
          支出日期: $('#exDate').value,
          支出類別: $('#exCategory').value,
          支出金額: parseInt($('#exAmount').value),
          廠商店家: $('#exVendor').value.trim(),
          支出說明: $('#exDesc').value.trim(),
          憑證圖片: b64,
          申請人: liffProfile.userId
        });
        notify('憑證已提交','success');
        $('#formExpenseSubmit').reset();
        $('#expenseSubmitWrap').classList.add('hidden');
        if(currentSection==='admin-expenses') loadExpenses();
        loadAdminDashboard();
      } catch(e2){
        notify('提交失敗：'+e2.message,'error');
      }
    });

    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = ()=> resolve(reader.result.split(',')[1]);
        reader.onerror = ()=> reject(reader.error);
        reader.readAsDataURL(file);
      });
    }

    /*********************************************************
     * 浮動操作按鈕 (FAB)
     *********************************************************/
    function handleFabVisibility(){
      // 活動快速新增：管理員且在活動管理頁
      $('#fabAddActivity').classList.toggle('hidden', !(isAdmin && (currentSection==='admin-activities')));
      // 捐款快速：會員財務頁或儀表板
      const showDonation = ['member-finance','member-dashboard'].includes(currentSection);
      $('#fabAddDonation').classList.toggle('hidden', !showDonation);
    }

    $('#fabAddDonation').addEventListener('click', ()=>{
      const modal = new bootstrap.Modal($('#modalDonation'));
      $('#donDate').value = new Date().toISOString().split('T')[0];
      modal.show();
    });
    $('#fabAddActivity').addEventListener('click', ()=>{
      if(!isAdmin) return;
      if($('#adminActFormWrap').classList.contains('hidden')){
        $('#adminActFormWrap').classList.remove('hidden');
        $('#admActDate').value = new Date().toISOString().split('T')[0];
        window.scrollTo({top:0,behavior:'smooth'});
      } else {
        $('#adminActFormWrap').classList.add('hidden');
      }
    });
    $('#fabScrollTop').addEventListener('click', ()=>{
      window.scrollTo({top:0,behavior:'smooth'});
    });

    window.addEventListener('scroll', ()=>{
      const y = window.scrollY || document.documentElement.scrollTop;
      $('#fabScrollTop').style.opacity = y>180? '1':'0.25';
    });

    /*********************************************************
     * 登出
     *********************************************************/
    $('#btnLogout').addEventListener('click', ()=>{
      if(confirm('確定要登出 LINE LIFF？')){
        try {
          liff.logout();
        } catch(e){}
        location.reload();
      }
    });

    /*********************************************************
     * 初始化
     *********************************************************/
    function initTheme() {
      const saved = localStorage.getItem('appTheme');
      if(saved) {
        document.body.setAttribute('data-theme', saved);
        if(saved==='dark') {
          $('#btnTheme i').className='bi bi-sun';
          $('#btnTheme span').textContent='淺色模式';
        }
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      initTheme();
      handleFabVisibility();
      initApp();
    });
  </script>
</body>
</html>
