<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #667eea;
      --secondary-color: #764ba2;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #4a5568;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .user-info {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .admin-nav {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
    }

    .nav-pills .nav-link {
      border-radius: 10px;
      margin: 0 5px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .nav-pills .nav-link.active {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .content-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .stat-card {
      background: linear-gradient(135deg, var(--success-color), #20c997);
      color: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
      transition: transform 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
    }

    .stat-card h3 {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .btn {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success-color), #20c997);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger-color), #c82333);
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning-color), #e0a800);
      color: #212529;
    }

    .btn-info {
      background: linear-gradient(135deg, var(--info-color), #138496);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #4a5568;
    }

    .form-control,
    .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-left: 4px solid var(--primary-color);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .activity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: white;
      border-radius: 10px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
    }

    .activity-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .table-container {
      max-height: 430px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      background: white;
    }

    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status.registered {
      background: #c6f6d5;
      color: #22543d;
    }

    .status.approved {
      background: #c6f6d5;
      color: #22543d;
    }

    .status.pending {
      background: #feebc8;
      color: #7b341e;
    }

    .status.rejected {
      background: #fed7d7;
      color: #742a2a;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #718096;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid #e2e8f0;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 300px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: #c6f6d5;
      color: #22543d;
      border-left: 4px solid #48bb78;
    }

    .notification.error {
      background: #fed7d7;
      color: #742a2a;
      border-left: 4px solid #f56565;
    }

    .notification.warning {
      background: #feebc8;
      color: #7b341e;
      border-left: 4px solid #ed8936;
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .quick-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #e2e8f0;
      padding: 15px 10px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      color: #4a5568;
      text-decoration: none;
    }

    .quick-btn:hover {
      border-color: var(--primary-color);
      background: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      color: #4a5568;
      text-decoration: none;
    }

    .quick-btn .icon {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
    }

    .proposal-card,
    .receipt-card,
    .expense-receipt {
      border: 1px solid #dee2e6;
      border-radius: 15px;
      margin-bottom: 20px;
      overflow: hidden;
      background: white;
    }

    .proposal-card .card-header {
      background: linear-gradient(135deg, #6c757d, #495057);
      color: white;
      font-weight: 600;
      padding: 15px;
    }

    .receipt-card .card-header {
      background: linear-gradient(135deg, var(--info-color), #138496);
      color: white;
      font-weight: 600;
      padding: 15px;
    }

    .vote-buttons,
    .receipt-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .receipt-image {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin-top: 8px;
      cursor: pointer;
    }

    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      border-radius: 15px;
      border: none;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      border-bottom: 1px solid #e9ecef;
      border-radius: 15px 15px 0 0;
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .pagination button:hover {
      background: #f7fafc;
      border-color: var(--primary-color);
    }

    .pagination button.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .header {
        padding: 20px;
      }

      .header h1 {
        font-size: 24px;
      }

      .activity-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .quick-actions {
        grid-template-columns: repeat(2, 1fr);
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .table-container {
        max-height: 300px;
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .btn:focus,
    .nav-link:focus,
    .quick-btn:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    .validation-message {
      color: #e53e3e;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }

    .form-group.error input,
    .form-group.error select,
    .form-group.error textarea {
      border-color: #e53e3e;
    }

    .form-group.error .validation-message {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ç³»çµ±æ¨™é¡Œ -->
    <div class="header">
      <h1>ğŸ¥ å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</h1>
      <p class="subtitle">å®Œæ•´ç‰ˆç®¡ç†å¹³å°</p>
    </div>

    <!-- å…¨åŸŸè¨Šæ¯ -->
    <div id="errorAlert" class="alert alert-danger d-none">
      <i class="bi bi-exclamation-triangle me-2"></i><span id="errorMessage"></span>
    </div>
    <div id="successAlert" class="alert alert-success d-none">
      <i class="bi bi-check-circle me-2"></i><span id="successMessage"></span>
    </div>

    <!-- ä½¿ç”¨è€…è³‡è¨Š -->
    <div id="user-info" class="user-info" style="display: none;">
      <h3>ğŸ‘¤ å€‹äººè³‡è¨Š</h3>
      <div id="user-details"></div>
    </div>

    <!-- å¿«é€Ÿæ“ä½œ -->
    <div class="quick-actions">
      <div class="quick-btn" onclick="showTab('profile')" tabindex="0" role="button">
        <span class="icon">ğŸ‘¤</span>
        å€‹äººæª”æ¡ˆ
      </div>
      <div class="quick-btn" onclick="showTab('activities')" tabindex="0" role="button">
        <span class="icon">ğŸ¯</span>
        æ´»å‹•å ±å
      </div>
      <div class="quick-btn" onclick="showTab('donations')" tabindex="0" role="button">
        <span class="icon">ğŸ’°</span>
        ææ¬¾è¨˜éŒ„
      </div>
      <div class="quick-btn" onclick="showTab('finance')" tabindex="0" role="button">
        <span class="icon">ğŸ“Š</span>
        è²¡å‹™ç®¡ç†
      </div>
      <div class="quick-btn admin-only" onclick="showTab('admin')" tabindex="0" role="button" style="display: none;">
        <span class="icon">ğŸ”§</span>
        ç®¡ç†åŠŸèƒ½
      </div>
    </div>

    <!-- ä¸»å°èˆª -->
    <div class="admin-nav">
      <ul class="nav nav-pills justify-content-center flex-wrap" id="mainTabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" data-bs-toggle="pill" href="#profile-tab" role="tab">
            <i class="bi bi-person me-1"></i>å€‹äººæª”æ¡ˆ
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="pill" href="#activities-tab" role="tab">
            <i class="bi bi-calendar-event me-1"></i>æ´»å‹•ç®¡ç†
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="pill" href="#donations-tab" role="tab">
            <i class="bi bi-heart me-1"></i>ææ¬¾è¨˜éŒ„
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="pill" href="#finance-tab" role="tab">
            <i class="bi bi-cash-coin me-1"></i>è²¡å‹™ç®¡ç†
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="pill" href="#feedback-tab" role="tab">
            <i class="bi bi-chat-dots me-1"></i>æ´»å‹•å›é¥‹
          </a>
        </li>
        <li class="nav-item admin-only" style="display: none;">
          <a class="nav-link" data-bs-toggle="pill" href="#admin-tab" role="tab">
            <i class="bi bi-gear me-1"></i>ç®¡ç†å°ˆå€
          </a>
        </li>
      </ul>
    </div>

    <!-- åˆ†é å…§å®¹ -->
    <div class="tab-content">
      <!-- å€‹äººæª”æ¡ˆ -->
      <div class="tab-pane fade show active" id="profile-tab" role="tabpanel">
        <div class="content-card">
          <h3>ğŸ“ æœƒå“¡è¨»å†Š / å€‹äººè³‡æ–™</h3>
          
          <div id="registration-form">
            <div class="form-group">
              <label for="realName">çœŸå¯¦å§“å *</label>
              <input type="text" id="realName" class="form-control" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å" required>
              <div class="validation-message">è«‹è¼¸å…¥æœ‰æ•ˆçš„å§“å</div>
            </div>
            
            <div class="form-group">
              <label for="memberType">æœƒå“¡é¡åˆ¥ *</label>
              <select id="memberType" class="form-select" required>
                <option value="">è«‹é¸æ“‡æœƒå“¡é¡åˆ¥</option>
                <option value="ç—…å‹">ç—…å‹</option>
                <option value="å®¶å±¬">å®¶å±¬</option>
                <option value="å¿—å·¥">å¿—å·¥</option>
                <option value="é†«è­·">é†«è­·äººå“¡</option>
              </select>
              <div class="validation-message">è«‹é¸æ“‡æœƒå“¡é¡åˆ¥</div>
            </div>
            
            <button class="btn" onclick="registerUser()" id="register-btn">
              <span class="btn-text">è¨»å†Šæœƒå“¡</span>
            </button>
          </div>

          <div id="contact-form" style="display: none;">
            <h4>ğŸ“ è¯çµ¡è³‡è¨Šæ›´æ–°</h4>
            <div class="row g-3">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="phone">é›»è©±</label>
                  <input type="tel" id="phone" class="form-control" placeholder="ä¾‹ï¼š0912345678">
                  <div class="validation-message">è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="email">é›»å­éƒµä»¶</label>
                  <input type="email" id="email" class="form-control" placeholder="ä¾‹ï¼šuser@example.com">
                  <div class="validation-message">è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="birthday">ç”Ÿæ—¥</label>
                  <input type="date" id="birthday" class="form-control">
                </div>
              </div>
              <div class="col-12">
                <div class="form-group">
                  <label for="address">åœ°å€</label>
                  <textarea id="address" class="form-control" rows="2" placeholder="è«‹è¼¸å…¥åœ°å€"></textarea>
                </div>
              </div>
            </div>
            
            <button class="btn" onclick="updateContact()" id="update-btn">
              <span class="btn-text">æ›´æ–°è¯çµ¡è³‡è¨Š</span>
            </button>
          </div>
        </div>
      </div>

      <!-- æ´»å‹•ç®¡ç† -->
      <div class="tab-pane fade" id="activities-tab" role="tabpanel">
        <div class="content-card">
          <h3>ğŸ¯ æ´»å‹•å ±åç®¡ç†</h3>
          
          <div class="grid">
            <div class="stat-card">
              <h3 id="total-activities">0</h3>
              <p>å¯å ±åæ´»å‹•</p>
            </div>
            <div class="stat-card">
              <h3 id="my-registrations">0</h3>
              <p>æˆ‘çš„å ±å</p>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-3">
              <select id="activity-status-filter" class="form-select">
                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                <option value="é–‹æ”¾å ±å">é–‹æ”¾å ±å</option>
                <option value="å·²çµæŸ">å·²çµæŸ</option>
              </select>
            </div>
            <div class="col-md-3">
              <input type="date" id="activity-date-filter" class="form-control">
            </div>
            <div class="col-md-4">
              <input type="text" id="activity-search" class="form-control" placeholder="æœå°‹æ´»å‹•...">
            </div>
            <div class="col-md-2">
              <button class="btn w-100" onclick="filterActivities()">
                <i class="bi bi-search me-1"></i>æœå°‹
              </button>
            </div>
          </div>

          <h4>ğŸ“… å¯å ±åæ´»å‹•</h4>
          <div id="activities-list" class="loading">è¼‰å…¥ä¸­...</div>
          <div id="activities-pagination" class="pagination"></div>

          <h4>ğŸ“‹ æˆ‘çš„æ´»å‹•å ±å</h4>
          <div id="my-activities-list" class="loading">è¼‰å…¥ä¸­...</div>
        </div>
      </div>

      <!-- ææ¬¾è¨˜éŒ„ -->
      <div class="tab-pane fade" id="donations-tab" role="tabpanel">
        <div class="content-card">
          <h3>ğŸ’° ææ¬¾è¨˜éŒ„</h3>
          
          <div class="grid">
            <div class="stat-card">
              <h3 id="total-donations">0</h3>
              <p>ææ¬¾ç­†æ•¸</p>
            </div>
            <div class="stat-card">
              <h3 id="total-amount">NT$ 0</h3>
              <p>ææ¬¾ç¸½é¡</p>
            </div>
          </div>

          <div class="mb-3">
            <button class="btn btn-success" onclick="showDonationForm()">
              <i class="bi bi-plus-circle me-1"></i>æ–°å¢ææ¬¾
            </button>
          </div>

          <!-- ææ¬¾è¡¨å–® -->
          <div id="donation-form" style="display: none;">
            <div class="card border-success mb-4">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0">æ–°å¢ææ¬¾è¨˜éŒ„</h6>
              </div>
              <div class="card-body">
                <form id="donation-form-element">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <div class="form-group">
                        <label for="donation-amount">ææ¬¾é‡‘é¡ *</label>
                        <input type="number" id="donation-amount" class="form-control" min="1" required>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-group">
                        <label for="donation-method">ææ¬¾æ–¹å¼</label>
                        <select id="donation-method" class="form-select">
                          <option value="ç¾é‡‘">ç¾é‡‘</option>
                          <option value="è½‰å¸³">è½‰å¸³</option>
                          <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                          <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-group">
                        <label for="donation-date">ææ¬¾æ—¥æœŸ</label>
                        <input type="date" id="donation-date" class="form-control">
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-group">
                        <label for="donation-note">å‚™è¨»</label>
                        <textarea id="donation-note" class="form-control" rows="2"></textarea>
                      </div>
                    </div>
                  </div>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-success me-2">
                      <i class="bi bi-check-circle me-1"></i>æäº¤
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideDonationForm()">
                      <i class="bi bi-x-circle me-1"></i>å–æ¶ˆ
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div id="donations-list" class="loading">è¼‰å…¥ä¸­...</div>
        </div>
      </div>

      <!-- è²¡å‹™ç®¡ç† -->
      <div class="tab-pane fade" id="finance-tab" role="tabpanel">
        <div class="content-card">
          <h3>ğŸ“Š è²¡å‹™ç®¡ç†</h3>
          
          <div class="grid">
            <div class="stat-card">
              <h3 id="account-balance">NT$ 0</h3>
              <p>å¸³æˆ¶é¤˜é¡</p>
            </div>
            <div class="stat-card">
              <h3 id="monthly-income">NT$ 0</h3>
              <p>æœ¬æœˆæ”¶å…¥</p>
            </div>
            <div class="stat-card">
              <h3 id="monthly-expense">NT$ 0</h3>
              <p>æœ¬æœˆæ”¯å‡º</p>
            </div>
          </div>

          <div class="mb-3">
            <button class="btn btn-warning" onclick="showExpenseForm()">
              <i class="bi bi-plus-circle me-1"></i>æ”¯å‡ºç”³è«‹
            </button>
          </div>

          <!-- æ”¯å‡ºç”³è«‹è¡¨å–® -->
          <div id="expense-form" style="display: none;">
            <div class="card border-warning mb-4">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">æ”¯å‡ºç”³è«‹</h6>
              </div>
              <div class="card-body">
                <form id="expense-form-element">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <div class="form-group">
                        <label for="expense-category">æ”¯å‡ºé¡åˆ¥ *</label>
                        <select id="expense-category" class="form-select" required>
                          <option value="">è«‹é¸æ“‡</option>
                          <option value="æ´»å‹•æ”¯å‡º">æ´»å‹•æ”¯å‡º</option>
                          <option value="è¾¦å…¬è²»ç”¨">è¾¦å…¬è²»ç”¨</option>
                          <option value="å®£å‚³è²»ç”¨">å®£å‚³è²»ç”¨</option>
                          <option value="è¨­å‚™è²»ç”¨">è¨­å‚™è²»ç”¨</option>
                          <option value="ç¦åˆ©æ”¯å‡º">ç¦åˆ©æ”¯å‡º</option>
                          <option value="é†«ç™‚æ”¯æ´">é†«ç™‚æ”¯æ´</option>
                          <option value="å¿—å·¥è²»ç”¨">å¿—å·¥è²»ç”¨</option>
                          <option value="å…¶ä»–æ”¯å‡º">å…¶ä»–æ”¯å‡º</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-group">
                        <label for="expense-amount">é‡‘é¡ *</label>
                        <input type="number" id="expense-amount" class="form-control" min="0" required>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-group">
                        <label for="expense-date">æ”¯å‡ºæ—¥æœŸ</label>
                        <input type="date" id="expense-date" class="form-control">
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-group">
                        <label for="expense-description">èªªæ˜ *</label>
                        <textarea id="expense-description" class="form-control" rows="3" required></textarea>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-group">
                        <label for="expense-receipt">ä¸Šå‚³æ†‘è­‰</label>
                        <input type="file" id="expense-receipt" class="form-control" accept="image/*">
                      </div>
                    </div>
                  </div>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-warning me-2">
                      <i class="bi bi-check-circle me-1"></i>æäº¤ç”³è«‹
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideExpenseForm()">
                      <i class="bi bi-x-circle me-1"></i>å–æ¶ˆ
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <h4>ğŸ“‹ æˆ‘çš„æ”¯å‡ºç”³è«‹</h4>
          <div id="my-expenses" class="loading">è¼‰å…¥ä¸­...</div>

          <!-- ç®¡ç†å“¡è²¡å‹™æ¦‚è¦½ -->
          <div id="admin-finance-overview" class="admin-only" style="display: none;">
            <hr>
            <h4>ğŸ’¼ è²¡å‹™æ¦‚è¦½ï¼ˆç®¡ç†å“¡ï¼‰</h4>
            <div class="table-container">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>æ—¥æœŸ</th>
                    <th>é¡å‹</th>
                    <th>é¡åˆ¥</th>
                    <th>é‡‘é¡</th>
                    <th>å°è±¡</th>
                    <th>æ”¶æ“š</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="admin-transaction-list">
                  <tr><td colspan="7" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- æ´»å‹•å›é¥‹ -->
      <div class="tab-pane fade" id="feedback-tab" role="tabpanel">
        <div class="content-card">
          <h3>ğŸ“ æ´»å‹•å›é¥‹</h3>
          
          <div class="form-group">
            <label for="feedback-activity">é¸æ“‡æ´»å‹•</label>
            <select id="feedback-activity" class="form-select">
              <option value="">è«‹é¸æ“‡å·²åƒèˆ‡çš„æ´»å‹•</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="feedback-rating">è©•åˆ† (1-5åˆ†)</label>
            <select id="feedback-rating" class="form-select">
              <option value="">è«‹é¸æ“‡è©•åˆ†</option>
              <option value="1">1åˆ† - å¾ˆä¸æ»¿æ„</option>
              <option value="2">2åˆ† - ä¸æ»¿æ„</option>
              <option value="3">3åˆ† - æ™®é€š</option>
              <option value="4">4åˆ† - æ»¿æ„</option>
              <option value="5">5åˆ† - éå¸¸æ»¿æ„</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="feedback-comment">æ„è¦‹èˆ‡å»ºè­°</label>
            <textarea id="feedback-comment" class="form-control" rows="4" placeholder="è«‹åˆ†äº«æ‚¨çš„åƒèˆ‡å¿ƒå¾—èˆ‡å»ºè­°"></textarea>
          </div>
          
          <button class="btn" onclick="submitFeedback()">
            <i class="bi bi-send me-1"></i>æäº¤å›é¥‹
          </button>

          <h4>ğŸ“Š æˆ‘çš„å›é¥‹è¨˜éŒ„</h4>
          <div id="my-feedback" class="loading">è¼‰å…¥ä¸­...</div>
        </div>
      </div>

      <!-- ç®¡ç†å°ˆå€ -->
      <div class="tab-pane fade" id="admin-tab" role="tabpanel">
        <div class="content-card">
          <h3>ğŸ”§ ç®¡ç†å°ˆå€</h3>
          
          <!-- ç®¡ç†å“¡çµ±è¨ˆ -->
          <div class="grid">
            <div class="stat-card">
              <h3 id="admin-total-members">0</h3>
              <p>ç¸½æœƒå“¡æ•¸</p>
            </div>
            <div class="stat-card">
              <h3 id="admin-active-members">0</h3>
              <p>æ´»èºæœƒå“¡</p>
            </div>
            <div class="stat-card">
              <h3 id="admin-pending-approvals">0</h3>
              <p>å¾…å¯©æ ¸é …ç›®</p>
            </div>
            <div class="stat-card">
              <h3 id="admin-monthly-donations">0</h3>
              <p>æœ¬æœˆææ¬¾</p>
            </div>
          </div>

          <!-- ç®¡ç†åŠŸèƒ½å°èˆª -->
          <div class="row mb-4">
            <div class="col-md-3">
              <button class="btn w-100 mb-2" onclick="showAdminSection('members')">
                <i class="bi bi-people me-1"></i>æœƒå“¡ç®¡ç†
              </button>
            </div>
            <div class="col-md-3">
              <button class="btn w-100 mb-2" onclick="showAdminSection('activities')">
                <i class="bi bi-calendar-event me-1"></i>æ´»å‹•ç®¡ç†
              </button>
            </div>
            <div class="col-md-3">
              <button class="btn w-100 mb-2" onclick="showAdminSection('finances')">
                <i class="bi bi-cash-coin me-1"></i>è²¡å‹™å¯©æ ¸
              </button>
            </div>
            <div class="col-md-3">
              <button class="btn w-100 mb-2" onclick="showAdminSection('reports')">
                <i class="bi bi-graph-up me-1"></i>å ±è¡¨åˆ†æ
              </button>
            </div>
          </div>

          <!-- æœƒå“¡ç®¡ç† -->
          <div id="admin-members" class="admin-section">
            <h4>ğŸ‘¥ æœƒå“¡ç®¡ç†</h4>
            <div class="row mb-3">
              <div class="col-md-4">
                <input type="text" id="member-search" class="form-control" placeholder="æœå°‹æœƒå“¡ï¼ˆå§“åæˆ–LINE IDï¼‰">
              </div>
              <div class="col-md-3">
                <select id="member-type-filter" class="form-select">
                  <option value="">æ‰€æœ‰æœƒå“¡é¡åˆ¥</option>
                  <option value="ç—…å‹">ç—…å‹</option>
                  <option value="å®¶å±¬">å®¶å±¬</option>
                  <option value="å¿—å·¥">å¿—å·¥</option>
                  <option value="é†«è­·">é†«è­·äººå“¡</option>
                </select>
              </div>
              <div class="col-md-3">
                <button class="btn w-100" onclick="searchMembers()">
                  <i class="bi bi-search me-1"></i>æœå°‹
                </button>
              </div>
              <div class="col-md-2">
                <button class="btn btn-success w-100" onclick="exportMembers()">
                  <i class="bi bi-download me-1"></i>åŒ¯å‡º
                </button>
              </div>
            </div>
            
            <div class="table-container">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>å§“å</th>
                    <th>é¡åˆ¥</th>
                    <th>é›»è©±</th>
                    <th>ç‹€æ…‹</th>
                    <th>åŠ å…¥æ—¥æœŸ</th>
                    <th>æœ€å¾Œæ´»å‹•</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="admin-member-list">
                  <tr><td colspan="7" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- æ´»å‹•ç®¡ç† -->
          <div id="admin-activities" class="admin-section" style="display: none;">
            <h4>ğŸ¯ æ´»å‹•ç®¡ç†</h4>
            <div class="mb-3">
              <button class="btn btn-success" onclick="showActivityForm()">
                <i class="bi bi-plus-circle me-1"></i>æ–°å¢æ´»å‹•
              </button>
            </div>

            <!-- æ´»å‹•è¡¨å–® -->
            <div id="activity-form" style="display: none;">
              <div class="card border-success mb-4">
                <div class="card-header bg-success text-white">
                  <h6 class="mb-0">æ–°å¢æ´»å‹•</h6>
                </div>
                <div class="card-body">
                  <form id="activity-form-element">
                    <div class="row g-3">
                      <div class="col-md-8">
                        <div class="form-group">
                          <label for="activity-name">æ´»å‹•åç¨± *</label>
                          <input type="text" id="activity-name" class="form-control" required>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="activity-type">æ´»å‹•é¡å‹ *</label>
                          <select id="activity-type" class="form-select" required>
                            <option value="">é¸æ“‡</option>
                            <option value="è¬›åº§">è¬›åº§</option>
                            <option value="èšæœƒ">èšæœƒ</option>
                            <option value="æ—…éŠ">æ—…éŠ</option>
                            <option value="é‹å‹•">é‹å‹•</option>
                            <option value="å¿—å·¥æœå‹™">å¿—å·¥æœå‹™</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="activity-date">æ´»å‹•æ—¥æœŸ *</label>
                          <input type="date" id="activity-date" class="form-control" required>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="activity-time">æ´»å‹•æ™‚é–“</label>
                          <input type="time" id="activity-time" class="form-control">
                        </div>
                      </div>
                      <div class="col-md-8">
                        <div class="form-group">
                          <label for="activity-location">æ´»å‹•åœ°é»</label>
                          <input type="text" id="activity-location" class="form-control">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="activity-max-people">äººæ•¸ä¸Šé™</label>
                          <input type="number" id="activity-max-people" class="form-control" min="1" value="50">
                        </div>
                      </div>
                      <div class="col-12">
                        <div class="form-group">
                          <label for="activity-description">æ´»å‹•æè¿°</label>
                          <textarea id="activity-description" class="form-control" rows="3"></textarea>
                        </div>
                      </div>
                    </div>
                    <div class="mt-3">
                      <button type="submit" class="btn btn-success me-2">
                        <i class="bi bi-check-circle me-1"></i>å»ºç«‹æ´»å‹•
                      </button>
                      <button type="button" class="btn btn-secondary" onclick="hideActivityForm()">
                        <i class="bi bi-x-circle me-1"></i>å–æ¶ˆ
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div id="admin-activity-list" class="loading">è¼‰å…¥ä¸­...</div>
          </div>

          <!-- è²¡å‹™å¯©æ ¸ -->
          <div id="admin-finances" class="admin-section" style="display: none;">
            <h4>ğŸ’° è²¡å‹™å¯©æ ¸</h4>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <h5>å¾…å¯©æ ¸æ”¯å‡º</h5>
                <div id="pending-expenses" class="loading">è¼‰å…¥ä¸­...</div>
              </div>
              <div class="col-md-6">
                <h5>æ”¶æ“šç®¡ç†</h5>
                <div class="mb-2">
                  <button class="btn btn-info btn-sm" onclick="showReceiptForm()">
                    <i class="bi bi-plus-circle me-1"></i>æ‰‹å‹•é–‹ç«‹æ”¶æ“š
                  </button>
                </div>
                <div id="recent-receipts" class="loading">è¼‰å…¥ä¸­...</div>
              </div>
            </div>
          </div>

          <!-- å ±è¡¨åˆ†æ -->
          <div id="admin-reports" class="admin-section" style="display: none;">
            <h4>ğŸ“Š å ±è¡¨åˆ†æ</h4>
            
            <div class="row mb-3">
              <div class="col-md-3">
                <div class="form-group">
                  <label for="report-year">å¹´ä»½</label>
                  <input type="number" id="report-year" class="form-control" value="2024" min="2020" max="2030">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label for="report-month">æœˆä»½</label>
                  <select id="report-month" class="form-select">
                    <option value="1">1æœˆ</option>
                    <option value="2">2æœˆ</option>
                    <option value="3">3æœˆ</option>
                    <option value="4">4æœˆ</option>
                    <option value="5">5æœˆ</option>
                    <option value="6">6æœˆ</option>
                    <option value="7">7æœˆ</option>
                    <option value="8">8æœˆ</option>
                    <option value="9">9æœˆ</option>
                    <option value="10">10æœˆ</option>
                    <option value="11">11æœˆ</option>
                    <option value="12">12æœˆ</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <button class="btn w-100" onclick="generateReport()">
                  <i class="bi bi-graph-up me-1"></i>ç”¢ç”Ÿå ±è¡¨
                </button>
              </div>
              <div class="col-md-3">
                <button class="btn btn-success w-100" onclick="exportAllData()">
                  <i class="bi bi-download me-1"></i>åŒ¯å‡ºè³‡æ–™
                </button>
              </div>
            </div>
            
            <div id="finance-report" class="loading">è¼‰å…¥ä¸­...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å‹•æ…‹ Modal å®¹å™¨ -->
  <div id="dynamic-modal-container"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ç³»çµ±é…ç½®
    const CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycby2DGS645Kubn8x4EVmhRz5v86lmkFgsBf9xYRSBryTzVHHV20jmpz_DglULgIvVtOgDg/exec',
      API_KEY: 'AAbb8520258185202581',
      STRICT_SIGN: false
    };

    // å…¨åŸŸè®Šæ•¸
    let currentUser = null;
    let isAdmin = false;
    let currentPage = 1;
    let itemsPerPage = 10;

    // LIFF åˆå§‹åŒ–
    async function initializeLiff() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        await createUserIfNotExist(profile.userId, profile.displayName);
        await loadUserInfo();
        
        showNotification('ç³»çµ±åˆå§‹åŒ–æˆåŠŸ', 'success');
      } catch (error) {
        console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
        showNotification('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
      }
    }

    // API å‘¼å«å‡½å¼
    async function callAPI(action, data = {}, retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          const payload = {
            action,
            ...data,
            apiKey: CONFIG.API_KEY,
            ts: Date.now(),
            nonce: Math.random().toString(36).substring(2)
          };

          if (CONFIG.STRICT_SIGN) {
            const baseString = `${action}|${payload.ts}|${payload.nonce}|${CONFIG.API_KEY}`;
            const signature = CryptoJS.HmacSHA256(baseString, CONFIG.API_KEY).toString();
            payload.sign = signature;
          }

          const response = await fetch(CONFIG.API_BASE_URL, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Cache-Control': 'no-cache'
            },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          return await response.json();
        } catch (error) {
          console.error(`API å‘¼å«å¤±æ•— (å˜—è©¦ ${i + 1}/${retries}):`, error);
          if (i === retries - 1) throw error;
          await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        }
      }
    }

    // å»ºç«‹ä½¿ç”¨è€…ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    async function createUserIfNotExist(lineId, lineName) {
      try {
        await callAPI('register', {
          lineId: lineId,
          lineName: lineName,
          realName: lineName
        });
      } catch (error) {
        console.error('å»ºç«‹ä½¿ç”¨è€…å¤±æ•—:', error);
      }
    }

    // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
    async function loadUserInfo() {
      try {
        const profile = await liff.getProfile();
        const result = await callAPI('getUserInfo', { lineId: profile.userId });
        
        if (result.error) {
          showNotification('ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š', 'error');
          return;
        }

        currentUser = result;
        isAdmin = result.isAdmin || false;
        
        updateUserInfoDisplay();
        updateUIBasedOnUserStatus();
        
      } catch (error) {
        console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—:', error);
        showNotification('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—', 'error');
      }
    }

    // æ›´æ–°ä½¿ç”¨è€…è³‡è¨Šé¡¯ç¤º
    function updateUserInfoDisplay() {
      if (!currentUser) return;

      const userInfoDiv = document.getElementById('user-info');
      const userDetailsDiv = document.getElementById('user-details');
      
      userDetailsDiv.innerHTML = `
        <div class="row g-3">
          <div class="col-md-3">
            <strong>å§“å:</strong> ${currentUser.realName || 'æœªè¨­å®š'}
          </div>
          <div class="col-md-3">
            <strong>LINE åç¨±:</strong> ${currentUser.lineName || 'æœªçŸ¥'}
          </div>
          <div class="col-md-3">
            <strong>ç‹€æ…‹:</strong> <span class="status ${currentUser.status === 'å·²è¨»å†Š' ? 'registered' : 'pending'}">${currentUser.status}</span>
          </div>
          <div class="col-md-3">
            <strong>æœƒå“¡é¡åˆ¥:</strong> ${currentUser.memberType || 'æœªè¨­å®š'}
          </div>
          ${isAdmin ? '<div class="col-md-12"><strong>æ¬Šé™:</strong> <span class="status approved">ç®¡ç†å“¡</span></div>' : ''}
        </div>
      `;
      
      userInfoDiv.style.display = 'block';
      userInfoDiv.classList.add('fade-in');
    }

    // æ ¹æ“šä½¿ç”¨è€…ç‹€æ…‹æ›´æ–°UI
    function updateUIBasedOnUserStatus() {
      const registrationForm = document.getElementById('registration-form');
      const contactForm = document.getElementById('contact-form');
      const adminElements = document.querySelectorAll('.admin-only');

      if (currentUser.status === 'å·²è¨»å†Š') {
        registrationForm.style.display = 'none';
        contactForm.style.display = 'block';
        
        // å¡«å…¥ç¾æœ‰è¯çµ¡è³‡è¨Š
        document.getElementById('phone').value = currentUser.phone || '';
        document.getElementById('email').value = currentUser.email || '';
        document.getElementById('address').value = currentUser.address || '';
        document.getElementById('birthday').value = currentUser.birthday || '';
      } else {
        registrationForm.style.display = 'block';
        contactForm.style.display = 'none';
      }

      if (isAdmin) {
        adminElements.forEach(el => el.style.display = 'block');
      }
    }

    // è¡¨å–®é©—è­‰
    function validateForm(formElement) {
      const inputs = formElement.querySelectorAll('input[required], select[required]');
      let isValid = true;

      inputs.forEach(input => {
        const formGroup = input.closest('.form-group');
        const errorMessage = formGroup?.querySelector('.validation-message');
        
        if (!input.value.trim()) {
          formGroup?.classList.add('error');
          if (errorMessage) errorMessage.style.display = 'block';
          isValid = false;
        } else {
          formGroup?.classList.remove('error');
          if (errorMessage) errorMessage.style.display = 'none';
          
          // ç‰¹å®šæ¬„ä½é©—è­‰
          if (input.type === 'email' && !isValidEmail(input.value)) {
            formGroup?.classList.add('error');
            if (errorMessage) errorMessage.style.display = 'block';
            isValid = false;
          }
          
          if (input.type === 'tel' && !isValidPhone(input.value)) {
            formGroup?.classList.add('error');
            if (errorMessage) errorMessage.style.display = 'block';
            isValid = false;
          }
        }
      });

      return isValid;
    }

    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function isValidPhone(phone) {
      const phoneRegex = /^[0-9]{10}$/;
      return phoneRegex.test(phone.replace(/\D/g, ''));
    }

    // æŒ‰éˆ•è¼‰å…¥ç‹€æ…‹
    function setButtonLoading(buttonId, loading = true) {
      const button = document.getElementById(buttonId);
      if (!button) return;

      if (loading) {
        button.classList.add('loading');
        button.disabled = true;
        const text = button.querySelector('.btn-text');
        if (text) text.style.opacity = '0';
      } else {
        button.classList.remove('loading');
        button.disabled = false;
        const text = button.querySelector('.btn-text');
        if (text) text.style.opacity = '1';
      }
    }

    // é€šçŸ¥ç³»çµ±
    function showNotification(message, type = 'info', duration = 3000) {
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span>${message}</span>
          <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 18px; margin-left: 10px;">&times;</button>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => notification.classList.add('show'), 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, duration);
    }

    // æœƒå“¡è¨»å†Š
    async function registerUser() {
      const form = document.getElementById('registration-form');
      if (!validateForm(form)) {
        showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
        return;
      }

      const realName = document.getElementById('realName').value.trim();
      const memberType = document.getElementById('memberType').value;

      setButtonLoading('register-btn', true);

      try {
        const profile = await liff.getProfile();
        const result = await callAPI('register', {
          lineId: profile.userId,
          realName,
          memberType
        });

        if (result.success) {
          showNotification('è¨»å†ŠæˆåŠŸï¼', 'success');
          await loadUserInfo();
        } else {
          showNotification(`è¨»å†Šå¤±æ•—ï¼š${result.message}`, 'error');
        }
      } catch (error) {
        console.error('è¨»å†Šå¤±æ•—:', error);
        showNotification('è¨»å†Šéç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
      } finally {
        setButtonLoading('register-btn', false);
      }
    }

    // æ›´æ–°è¯çµ¡è³‡è¨Š
    async function updateContact() {
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const address = document.getElementById('address').value.trim();
      const birthday = document.getElementById('birthday').value;

      if (phone && !isValidPhone(phone)) {
        showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼', 'error');
        return;
      }

      if (email && !isValidEmail(email)) {
        showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€', 'error');
        return;
      }

      setButtonLoading('update-btn', true);

      try {
        const profile = await liff.getProfile();
        const result = await callAPI('updateUserContact', {
          operatorLineId: profile.userId,
          targetLineId: profile.userId,
          phone,
          email,
          address,
          birthday
        });

        if (result.success) {
          showNotification('è¯çµ¡è³‡è¨Šæ›´æ–°æˆåŠŸï¼', 'success');
          await loadUserInfo();
        } else {
          showNotification(`æ›´æ–°å¤±æ•—ï¼š${result.message}`, 'error');
        }
      } catch (error) {
        console.error('æ›´æ–°è¯çµ¡è³‡è¨Šå¤±æ•—:', error);
        showNotification('æ›´æ–°éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
      } finally {
        setButtonLoading('update-btn', false);
      }
    }

    // åˆ†é åˆ‡æ›
    function showTab(tabName) {
      const tabs = document.querySelectorAll('.nav-link');
      tabs.forEach(tab => {
        tab.classList.remove('active');
      });
      
      const tabContents = document.querySelectorAll('.tab-pane');
      tabContents.forEach(content => {
        content.classList.remove('show', 'active');
      });
      
      const targetTab = document.querySelector(`a[href="#${tabName}-tab"]`);
      const targetContent = document.getElementById(`${tabName}-tab`);
      
      if (targetTab && targetContent) {
        targetTab.classList.add('active');
        targetContent.classList.add('show', 'active', 'fade-in');
      }
      
      loadTabData(tabName);
    }

    async function loadTabData(tabName) {
      switch (tabName) {
        case 'activities':
          await Promise.all([loadActivities(), loadMyActivities()]);
          break;
        case 'donations':
          await loadDonations();
          break;
        case 'finance':
          await loadFinanceData();
          break;
        case 'feedback':
          await loadFeedbackData();
          break;
        case 'admin':
          if (isAdmin) {
            await loadAdminData();
          }
          break;
      }
    }

    // æ´»å‹•ç›¸é—œåŠŸèƒ½
    async function loadActivities() {
      try {
        const result = await callAPI('getActivities');
        const activitiesList = document.getElementById('activities-list');
        
        if (!result || result.length === 0) {
          activitiesList.innerHTML = '<div class="card"><p>ç›®å‰æ²’æœ‰é–‹æ”¾çš„æ´»å‹•</p></div>';
          return;
        }

        document.getElementById('total-activities').textContent = result.length;
        renderActivities(result);
        
      } catch (error) {
        console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', error);
        document.getElementById('activities-list').innerHTML = '<div class="alert alert-danger">è¼‰å…¥æ´»å‹•å¤±æ•—</div>';
      }
    }

    function renderActivities(activities, page = 1) {
      const activitiesList = document.getElementById('activities-list');
      const startIndex = (page - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedActivities = activities.slice(startIndex, endIndex);

      let html = '';
      paginatedActivities.forEach(activity => {
        const dateStr = activity.date ? new Date(activity.date).toLocaleDateString('zh-TW') : 'å¾…å®š';
        const participantsText = `${activity.currentParticipants || 0}/${activity.maxParticipants || 'ä¸é™'}`;
        const isFull = activity.maxParticipants && (activity.currentParticipants || 0) >= activity.maxParticipants;
        
        html += `
          <div class="activity-item">
            <div class="activity-info">
              <h4>${activity.name}</h4>
              <p><i class="bi bi-calendar me-1"></i>${dateStr} | <i class="bi bi-geo-alt me-1"></i>${activity.location || 'å¾…å®š'}</p>
              <p>${activity.description || ''}</p>
              ${activity.fee ? `<p><i class="bi bi-currency-dollar me-1"></i>è²»ç”¨ï¼šNT$ ${activity.fee}</p>` : ''}
            </div>
            <div style="text-align: right;">
              <div class="participants mb-2">${participantsText}</div>
              ${!isFull ? `<button class="btn btn-sm" onclick="registerActivity('${activity.id}')">å ±å</button>` : '<span class="status rejected">å·²é¡æ»¿</span>'}
            </div>
          </div>
        `;
      });

      activitiesList.innerHTML = html;
      renderPagination('activities-pagination', activities.length, page, (newPage) => renderActivities(activities, newPage));
    }

    function renderPagination(containerId, totalItems, currentPage, onPageChange) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const totalPages = Math.ceil(totalItems / itemsPerPage);
      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      let html = '';
      
      if (currentPage > 1) {
        html += `<button onclick="changePage(${currentPage - 1})">ä¸Šä¸€é </button>`;
      }
      
      for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
          html += `<button class="active">${i}</button>`;
        } else if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
          html += `<button onclick="changePage(${i})">${i}</button>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<span>...</span>';
        }
      }
      
      if (currentPage < totalPages) {
        html += `<button onclick="changePage(${currentPage + 1})">ä¸‹ä¸€é </button>`;
      }

      container.innerHTML = html;
      window.changePage = onPageChange;
    }

    async function registerActivity(activityId) {
      if (!currentUser || currentUser.status !== 'å·²è¨»å†Š') {
        showNotification('è«‹å…ˆå®Œæˆæœƒå“¡è¨»å†Š', 'warning');
        return;
      }

      try {
        const profile = await liff.getProfile();
        const result = await callAPI('registerActivity', {
          lineId: profile.userId,
          activityId: activityId,
          participantName: currentUser.realName
        });

        if (result.success) {
          showNotification('æ´»å‹•å ±åæˆåŠŸï¼', 'success');
          await loadActivities();
          await loadMyActivities();
        } else {
          showNotification(`å ±åå¤±æ•—ï¼š${result.message}`, 'error');
        }
      } catch (error) {
        console.error('æ´»å‹•å ±åå¤±æ•—:', error);
        showNotification('å ±åéç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
      }
    }

    async function loadMyActivities() {
      try {
        const profile = await liff.getProfile();
        const result = await callAPI('getUserActivities', { lineId: profile.userId });
        const myActivitiesList = document.getElementById('my-activities-list');
        
        if (!result || result.length === 0) {
          myActivitiesList.innerHTML = '<div class="card"><p>æ‚¨ç›®å‰æ²’æœ‰å ±åä»»ä½•æ´»å‹•</p></div>';
          document.getElementById('my-registrations').textContent = '0';
          return;
        }

        document.getElementById('my-registrations').textContent = result.length;

        let html = '';
        result.forEach(registration => {
          const dateStr = registration.date ? new Date(registration.date).toLocaleDateString('zh-TW') : 'å¾…å®š';
          
          html += `
            <div class="card">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h4>${registration.activityName}</h4>
                  <p><i class="bi bi-calendar me-1"></i>${dateStr}</p>
                  <p><i class="bi bi-geo-alt me-1"></i>${registration.location || 'å¾…å®š'}</p>
                  <p><i class="bi bi-person me-1"></i>åƒèˆ‡è€…ï¼š${registration.participantName}</p>
                </div>
                <div style="text-align: right;">
                  <span class="status registered">${registration.status}</span>
                  ${registration.status === 'å·²å ±å' ? `<br><button class="btn btn-danger btn-sm mt-2" onclick="cancelActivity('${registration.id}')">å–æ¶ˆå ±å</button>` : ''}
                </div>
              </div>
            </div>
          `;
        });

        myActivitiesList.innerHTML = html;
        loadActivitiesForFeedback(result);
        
      } catch (error) {
        console.error('è¼‰å…¥æˆ‘çš„æ´»å‹•å¤±æ•—:', error);
        document.getElementById('my-activities-list').innerHTML = '<div class="alert alert-danger">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function cancelActivity(registrationId) {
      if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™å€‹æ´»å‹•çš„å ±åå—ï¼Ÿ')) {
        return;
      }

      try {
        const profile = await liff.getProfile();
        const result = await callAPI('cancelActivity', {
          lineId: profile.userId,
          registrationId: registrationId
        });

        if (result.success) {
          showNotification('å·²å–æ¶ˆå ±å', 'success');
          await loadActivities();
          await loadMyActivities();
        } else {
          showNotification(`å–æ¶ˆå¤±æ•—ï¼š${result.message}`, 'error');
        }
      } catch (error) {
        console.error('å–æ¶ˆå ±åå¤±æ•—:', error);
        showNotification('å–æ¶ˆéç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
      }
    }

    function loadActivitiesForFeedback(activities) {
      const select = document.getElementById('feedback-activity');
      select.innerHTML = '<option value="">è«‹é¸æ“‡å·²åƒèˆ‡çš„æ´»å‹•</option>';
      
      activities.forEach(activity => {
        const option = document.createElement('option');
        option.value = activity.activityId;
        option.textContent = activity.activityName;
        select.appendChild(option);
      });
    }

    async function filterActivities() {
      const status = document.getElementById('activity-status-filter').value;
      const date = document.getElementById('activity-date-filter').value;
      const search = document.getElementById('activity-search').value.toLowerCase();

      try {
        const result = await callAPI('getActivities', { status, date, search });
        const filteredActivities = result.filter(activity => {
          let matches = true;
          
          if (search) {
            matches = matches && (
              activity.name.toLowerCase().includes(search) ||
              (activity.description && activity.description.toLowerCase().includes(search)) ||
              (activity.location && activity.location.toLowerCase().includes(search))
            );
          }
          
          return matches;
        });
        
        renderActivities(filteredActivities);
      } catch (error) {
        console.error('ç¯©é¸æ´»å‹•å¤±æ•—:', error);
      }
    }

    // ææ¬¾ç›¸é—œåŠŸèƒ½
    function showDonationForm() {
      document.getElementById('donation-form').style.display = 'block';
      document.getElementById('donation-date').value = new Date().toISOString().split('T')[0];
    }

    function hideDonationForm() {
      document.getElementById('donation-form').style.display = 'none';
      document.getElementById('donation-form-element').reset();
    }

    async function loadDonations() {
      try {
        const profile = await liff.getProfile();
        const result = await callAPI('getDonations', { lineId: profile.userId });
        const donationsList = document.getElementById('donations-list');
        
        if (!result || result.length === 0) {
          donationsList.innerHTML = '<div class="card"><p>æ‚¨ç›®å‰æ²’æœ‰ææ¬¾è¨˜éŒ„</p></div>';
          document.getElementById('total-donations').textContent = '0';
          document.getElementById('total-amount').textContent = 'NT$ 0';
          return;
        }

        document.getElementById('total-donations').textContent = result.length;
        const totalAmount = result.reduce((sum, donation) => sum + (donation.amount || 0), 0);
        document.getElementById('total-amount').textContent = `NT$ ${totalAmount.toLocaleString()}`;

        let html = '';
        result.forEach(donation => {
          const dateStr = donation.date ? new Date(donation.date).toLocaleDateString('zh-TW') : 'æœªçŸ¥';
          
          html += `
            <div class="card">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h5>NT$ ${(donation.amount || 0).toLocaleString()}</h5>
                  <p><i class="bi bi-calendar me-1"></i>${dateStr}</p>
                  <p><i class="bi bi-credit-card me-1"></i>${donation.method || 'æœªçŸ¥'}</p>
                  ${donation.note ? `<p><i class="bi bi-chat-dots me-1"></i>${donation.note}</p>` : ''}
                </div>
                <div>
                  <span class="status approved">å·²å®Œæˆ</span>
                </div>
              </div>
            </div>
          `;
        });

        donationsList.innerHTML = html;
        
      } catch (error) {
        console.error('è¼‰å…¥ææ¬¾è¨˜éŒ„å¤±æ•—:', error);
        document.getElementById('donations-list').innerHTML = '<div class="alert alert-danger">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // æ”¯å‡ºç”³è«‹ç›¸é—œåŠŸèƒ½
    function showExpenseForm() {
      document.getElementById('expense-form').style.display = 'block';
      document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
    }

    function hideExpenseForm() {
      document.getElementById('expense-form').style.display = 'none';
      document.getElementById('expense-form-element').reset();
    }

    async function loadFinanceData() {
      try {
        const profile = await liff.getProfile();
        const result = await callAPI('getFinanceData', { lineId: profile.userId });
        
        if (result) {
          document.getElementById('account-balance').textContent = `NT$ ${(result.balance || 0).toLocaleString()}`;
          document.getElementById('monthly-income').textContent = `NT$ ${(result.monthlyIncome || 0).toLocaleString()}`;
          document.getElementById('monthly-expense').textContent = `NT$ ${(result.monthlyExpense || 0).toLocaleString()}`;
        }

        await loadMyExpenses();
        
        if (isAdmin) {
          document.getElementById('admin-finance-overview').style.display = 'block';
          await loadAdminTransactions();
        }
        
      } catch (error) {
        console.error('è¼‰å…¥è²¡å‹™è³‡æ–™å¤±æ•—:', error);
      }
    }

    async function loadMyExpenses() {
      try {
        const profile = await liff.getProfile();
        const result = await callAPI('getMyExpenses', { lineId: profile.userId });
        const expensesList = document.getElementById('my-expenses');
        
        if (!result || result.length === 0) {
          expensesList.innerHTML = '<div class="card"><p>æ‚¨ç›®å‰æ²’æœ‰æ”¯å‡ºç”³è«‹è¨˜éŒ„</p></div>';
          return;
        }

        let html = '';
        result.forEach(expense => {
          const dateStr = expense.date ? new Date(expense.date).toLocaleDateString('zh-TW') : 'æœªçŸ¥';
          
          html += `
            <div class="card">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h5>${expense.category} - NT$ ${(expense.amount || 0).toLocaleString()}</h5>
                  <p><i class="bi bi-calendar me-1"></i>${dateStr}</p>
                  <p>${expense.description}</p>
                </div>
                <div>
                  <span class="status ${getExpenseStatusClass(expense.status)}">${expense.status}</span>
                </div>
              </div>
            </div>
          `;
        });

        expensesList.innerHTML = html;
        
      } catch (error) {
        console.error('è¼‰å…¥æ”¯å‡ºè¨˜éŒ„å¤±æ•—:', error);
        document.getElementById('my-expenses').innerHTML = '<div class="alert alert-danger">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    function getExpenseStatusClass(status) {
      switch (status) {
        case 'å·²é€šé': return 'approved';
        case 'å¾…å¯©æ ¸': return 'pending';
        case 'å·²é§å›': return 'rejected';
        default: return 'pending';
      }
    }

    // å›é¥‹ç›¸é—œåŠŸèƒ½
    async function submitFeedback() {
      const activityId = document.getElementById('feedback-activity').value;
      const rating = document.getElementById('feedback-rating').value;
      const comment = document.getElementById('feedback-comment').value.trim();

      if (!activityId) {
        showNotification('è«‹é¸æ“‡æ´»å‹•', 'error');
        return;
      }

      if (!rating) {
        showNotification('è«‹é¸æ“‡è©•åˆ†', 'error');
        return;
      }

      try {
        const profile = await liff.getProfile();
        const result = await callAPI('submitFeedback', {
          lineId: profile.userId,
          activityId,
          rating: parseInt(rating),
          comment
        });

        if (result.success) {
          showNotification('å›é¥‹æäº¤æˆåŠŸï¼', 'success');
          document.getElementById('feedback-activity').value = '';
          document.getElementById('feedback-rating').value = '';
          document.getElementById('feedback-comment').value = '';
          await loadFeedbackData();
        } else {
          showNotification(`æäº¤å¤±æ•—ï¼š${result.message}`, 'error');
        }
      } catch (error) {
        console.error('æäº¤å›é¥‹å¤±æ•—:', error);
        showNotification('æäº¤éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
      }
    }

    async function loadFeedbackData() {
      try {
        const profile = await liff.getProfile();
        const result = await callAPI('getMyFeedback', { lineId: profile.userId });
        const feedbackList = document.getElementById('my-feedback');
        
        if (!result || result.length === 0) {
          feedbackList.innerHTML = '<div class="card"><p>æ‚¨ç›®å‰æ²’æœ‰å›é¥‹è¨˜éŒ„</p></div>';
          return;
        }

        let html = '';
        result.forEach(feedback => {
          const dateStr = feedback.date ? new Date(feedback.date).toLocaleDateString('zh-TW') : 'æœªçŸ¥';
          const stars = 'â˜…'.repeat(feedback.rating) + 'â˜†'.repeat(5 - feedback.rating);
          
          html += `
            <div class="card">
              <h5>${feedback.activityName}</h5>
              <p><i class="bi bi-star-fill me-1"></i>${stars} (${feedback.rating}/5)</p>
              <p>${feedback.comment}</p>
              <p class="text-muted small"><i class="bi bi-calendar me-1"></i>${dateStr}</p>
            </div>
          `;
        });

        feedbackList.innerHTML = html;
        
      } catch (error) {
        console.error('è¼‰å…¥å›é¥‹è¨˜éŒ„å¤±æ•—:', error);
        document.getElementById('my-feedback').innerHTML = '<div class="alert alert-danger">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // ç®¡ç†å“¡åŠŸèƒ½
    function showAdminSection(sectionName) {
      const sections = document.querySelectorAll('.admin-section');
      sections.forEach(section => section.style.display = 'none');
      
      const targetSection = document.getElementById(`admin-${sectionName}`);
      if (targetSection) {
        targetSection.style.display = 'block';
      }
      
      switch (sectionName) {
        case 'members':
          loadAdminMembers();
          break;
        case 'activities':
          loadAdminActivities();
          break;
        case 'finances':
          loadAdminFinances();
          break;
        case 'reports':
          loadAdminReports();
          break;
      }
    }

    async function loadAdminData() {
      try {
        const result = await callAPI('getAdminDashboard');
        
        if (result) {
          document.getElementById('admin-total-members').textContent = result.totalMembers || 0;
          document.getElementById('admin-active-members').textContent = result.activeMembers || 0;
          document.getElementById('admin-pending-approvals').textContent = result.pendingApprovals || 0;
          document.getElementById('admin-monthly-donations').textContent = result.monthlyDonations || 0;
        }
        
        // é è¨­é¡¯ç¤ºæœƒå“¡ç®¡ç†
        showAdminSection('members');
        
      } catch (error) {
        console.error('è¼‰å…¥ç®¡ç†å“¡è³‡æ–™å¤±æ•—:', error);
      }
    }

    async function loadAdminMembers() {
      try {
        const result = await callAPI('getAllMembers');
        const memberList = document.getElementById('admin-member-list');
        
        if (!result || result.length === 0) {
          memberList.innerHTML = '<tr><td colspan="7" class="text-center text-muted">å°šç„¡æœƒå“¡</td></tr>';
          return;
        }

        let html = '';
        result.forEach(member => {
          const joinDate = member.joinDate ? new Date(member.joinDate).toLocaleDateString('zh-TW') : 'æœªçŸ¥';
          const lastActivity = member.lastActivity ? new Date(member.lastActivity).toLocaleDateString('zh-TW') : 'ç„¡';
          
          html += `
            <tr>
              <td>${member.realName || member.lineName || '-'}</td>
              <td><span class="badge bg-${getMemberTypeBadge(member.memberType)}">${member.memberType || 'æœªè¨­å®š'}</span></td>
              <td>${member.phone || '-'}</td>
              <td><span class="status ${member.status === 'å·²è¨»å†Š' ? 'registered' : 'pending'}">${member.status}</span></td>
              <td>${joinDate}</td>
              <td>${lastActivity}</td>
              <td>
                <button class="btn btn-outline-primary btn-sm" onclick="viewMemberDetail('${member.lineId}')">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-warning btn-sm" onclick="editMember('${member.lineId}')">
                  <i class="bi bi-pencil"></i>
                </button>
              </td>
            </tr>
          `;
        });

        memberList.innerHTML = html;
        
      } catch (error) {
        console.error('è¼‰å…¥æœƒå“¡åˆ—è¡¨å¤±æ•—:', error);
        document.getElementById('admin-member-list').innerHTML = '<tr><td colspan="7" class="text-center text-danger">è¼‰å…¥å¤±æ•—</td></tr>';
      }
    }

    function getMemberTypeBadge(type) {
      switch (type) {
        case 'ç—…å‹': return 'primary';
        case 'å®¶å±¬': return 'success';
        case 'å¿—å·¥': return 'warning';
        case 'é†«è­·': return 'info';
        default: return 'secondary';
      }
    }

    // è¡¨å–®æäº¤äº‹ä»¶
    document.addEventListener('DOMContentLoaded', () => {
      // ææ¬¾è¡¨å–®æäº¤
      document.getElementById('donation-form-element').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const amount = parseInt(document.getElementById('donation-amount').value);
        const method = document.getElementById('donation-method').value;
        const date = document.getElementById('donation-date').value;
        const note = document.getElementById('donation-note').value.trim();

        try {
          const profile = await liff.getProfile();
          const result = await callAPI('addDonation', {
            lineId: profile.userId,
            amount,
            method,
            date,
            note
          });

          if (result.success) {
            showNotification('ææ¬¾è¨˜éŒ„å·²æ–°å¢', 'success');
            hideDonationForm();
            await loadDonations();
          } else {
            showNotification(`æ–°å¢å¤±æ•—ï¼š${result.message}`, 'error');
          }
        } catch (error) {
          console.error('æ–°å¢ææ¬¾å¤±æ•—:', error);
          showNotification('æ–°å¢éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
        }
      });

      // æ”¯å‡ºç”³è«‹è¡¨å–®æäº¤
      document.getElementById('expense-form-element').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const category = document.getElementById('expense-category').value;
        const amount = parseInt(document.getElementById('expense-amount').value);
        const date = document.getElementById('expense-date').value;
        const description = document.getElementById('expense-description').value.trim();
        const receiptFile = document.getElementById('expense-receipt').files[0];

        try {
          const profile = await liff.getProfile();
          let receiptData = null;
          
          if (receiptFile) {
            receiptData = await fileToBase64(receiptFile);
          }

          const result = await callAPI('submitExpense', {
            lineId: profile.userId,
            category,
            amount,
            date,
            description,
            receipt: receiptData
          });

          if (result.success) {
            showNotification('æ”¯å‡ºç”³è«‹å·²æäº¤', 'success');
            hideExpenseForm();
            await loadMyExpenses();
          } else {
            showNotification(`æäº¤å¤±æ•—ï¼š${result.message}`, 'error');
          }
        } catch (error) {
          console.error('æäº¤æ”¯å‡ºç”³è«‹å¤±æ•—:', error);
          showNotification('æäº¤éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
        }
      });

      // æ´»å‹•è¡¨å–®æäº¤
      document.getElementById('activity-form-element').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!isAdmin) {
          showNotification('æ¬Šé™ä¸è¶³', 'error');
          return;
        }

        const name = document.getElementById('activity-name').value.trim();
        const type = document.getElementById('activity-type').value;
        const date = document.getElementById('activity-date').value;
        const time = document.getElementById('activity-time').value;
        const location = document.getElementById('activity-location').value.trim();
        const maxPeople = parseInt(document.getElementById('activity-max-people').value);
        const description = document.getElementById('activity-description').value.trim();

        try {
          const profile = await liff.getProfile();
          const result = await callAPI('addActivity', {
            operatorLineId: profile.userId,
            name,
            type,
            date,
            time,
            location,
            maxPeople,
            description
          });

          if (result.success) {
            showNotification('æ´»å‹•å·²å»ºç«‹', 'success');
            hideActivityForm();
            await loadAdminActivities();
          } else {
            showNotification(`å»ºç«‹å¤±æ•—ï¼š${result.message}`, 'error');
          }
        } catch (error) {
          console.error('å»ºç«‹æ´»å‹•å¤±æ•—:', error);
          showNotification('å»ºç«‹éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
        }
      });
    });

    // å·¥å…·å‡½å¼
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    function showActivityForm() {
      document.getElementById('activity-form').style.display = 'block';
      document.getElementById('activity-date').value = new Date().toISOString().split('T')[0];
    }

    function hideActivityForm() {
      document.getElementById('activity-form').style.display = 'none';
      document.getElementById('activity-form-element').reset();
    }

    // å…¶ä»–ç®¡ç†å“¡åŠŸèƒ½çš„ç©ºå¯¦ç¾
    async function loadAdminActivities() {
      document.getElementById('admin-activity-list').innerHTML = '<div class="alert alert-info">æ´»å‹•ç®¡ç†åŠŸèƒ½é–‹ç™¼ä¸­...</div>';
    }

    async function loadAdminFinances() {
      document.getElementById('pending-expenses').innerHTML = '<div class="alert alert-info">è²¡å‹™å¯©æ ¸åŠŸèƒ½é–‹ç™¼ä¸­...</div>';
      document.getElementById('recent-receipts').innerHTML = '<div class="alert alert-info">æ”¶æ“šç®¡ç†åŠŸèƒ½é–‹ç™¼ä¸­...</div>';
    }

    async function loadAdminReports() {
      document.getElementById('finance-report').innerHTML = '<div class="alert alert-info">å ±è¡¨åˆ†æåŠŸèƒ½é–‹ç™¼ä¸­...</div>';
    }

    async function loadAdminTransactions() {
      document.getElementById('admin-transaction-list').innerHTML = '<tr><td colspan="7" class="text-center text-muted">äº¤æ˜“è¨˜éŒ„åŠŸèƒ½é–‹ç™¼ä¸­...</td></tr>';
    }

    function searchMembers() {
      showNotification('æœƒå“¡æœå°‹åŠŸèƒ½é–‹ç™¼ä¸­', 'warning');
    }

    function exportMembers() {
      showNotification('æœƒå“¡åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­', 'warning');
    }

    function viewMemberDetail(lineId) {
      showNotification('æœƒå“¡è©³æƒ…åŠŸèƒ½é–‹ç™¼ä¸­', 'warning');
    }

    function editMember(lineId) {
      showNotification('æœƒå“¡ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­', 'warning');
    }

    function generateReport() {
      showNotification('å ±è¡¨ç”¢ç”ŸåŠŸèƒ½é–‹ç™¼ä¸­', 'warning');
    }

    function exportAllData() {
      showNotification('è³‡æ–™åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­', 'warning');
    }

    function showReceiptForm() {
      showNotification('æ”¶æ“šé–‹ç«‹åŠŸèƒ½é–‹ç™¼ä¸­', 'warning');
    }

    // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await initializeLiff();
        
        // è¨­å®šç•¶å‰æœˆä»½ç‚ºé è¨­å€¼
        const currentDate = new Date();
        const reportMonth = document.getElementById('report-month');
        if (reportMonth) {
          reportMonth.value = currentDate.getMonth() + 1;
        }
        
        // è¼‰å…¥é è¨­åˆ†é è³‡æ–™
        await loadTabData('profile');
        
      } catch (error) {
        console.error('é é¢åˆå§‹åŒ–å¤±æ•—:', error);
        showNotification('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
      }
    });

    // é˜²æ­¢è¡¨å–®æäº¤æ™‚é é¢é‡æ–°è¼‰å…¥
    document.addEventListener('submit', (e) => {
      e.preventDefault();
    });

    // Service Worker æ”¯æ´ï¼ˆPWAï¼‰
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
              .then(reg => console.log('Service Worker registered:', reg.scope))
              .catch(err => console.warn('Service Worker registration failed:', err));
          });
        }
  </script>
</body>
</html>
