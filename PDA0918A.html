<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>帕金森病友會整合系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="theme-color" content="#5563c1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <style>
    :root {
      --brand-grad: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --brand-accent: #667eea;
      --radius: 16px;
      --transition: .25s cubic-bezier(.4,0,.2,1);
    }
    [data-theme="dark"] {
      --bs-body-bg: #1f2430;
      --panel-bg: #2b3242;
      --panel-border: #394255;
      --text-color: #e6e9ef;
      --muted: #9aa4b4;
    }
    [data-theme="light"] {
      --bs-body-bg: #f5f7fb;
      --panel-bg: #ffffff;
      --panel-border: #e2e8f0;
      --text-color: #2d3748;
      --muted: #6b7280;
    }
    body {
      background: var(--bs-body-bg);
      color: var(--text-color);
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    .app-shell {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px 12px 60px;
    }
    .panel {
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius);
      padding: 20px 22px;
      margin-bottom: 20px;
      position: relative;
      transition: var(--transition);
    }
    .panel-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .stat-grid { display:grid; gap:14px; grid-template-columns: repeat(auto-fit,minmax(150px,1fr)); }
    .stat { background: var(--panel-bg); border:1px solid var(--panel-border); border-radius:12px; padding:16px 14px; position:relative; overflow:hidden; }
    .stat .label { font-size:.75rem; letter-spacing:.5px; text-transform:uppercase; color: var(--muted); font-weight:600; }
    .stat .value { font-size:1.8rem; font-weight:700; margin-top:4px; line-height:1.1; }
    .nav-main { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:18px; }
    .nav-main .nav-btn {
      border:1px solid var(--panel-border);
      background:var(--panel-bg);
      border-radius:50px;
      padding:8px 18px;
      font-size:.9rem;
      font-weight:500;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      transition:var(--transition);
    }
    .nav-main .nav-btn.active,
    .nav-main .nav-btn:hover {
      background: var(--brand-grad);
      color:#fff;
      border-color: transparent;
      box-shadow:0 4px 12px rgba(102,126,234,.35);
    }
    .divider { height:1px; background:var(--panel-border); margin:20px 0; }
    .table thead th { font-size:.75rem; text-transform:uppercase; letter-spacing:.5px; }
    .activity-card {
      border:1px solid var(--panel-border);
      border-radius:14px;
      padding:14px 16px;
      margin-bottom:12px;
      position:relative;
      background: var(--panel-bg);
      transition:var(--transition);
    }
    .activity-card:hover { transform:translateY(-2px); box-shadow:0 6px 18px rgba(0,0,0,.08); }
    .status-pill {
      font-size:.65rem;
      border-radius:10px;
      padding:4px 8px;
      font-weight:600;
      letter-spacing:.5px;
    }
    .status-open { background:#d1fae5; color:#065f46; }
    .status-full { background:#fee2e2; color:#991b1b; }
    .status-closed { background:#e5e7eb; color:#374151; }
    [data-theme="dark"] .status-open { background:#064e3b; color:#10b981; }
    [data-theme="dark"] .status-full { background:#7f1d1d; color:#fca5a5; }
    [data-theme="dark"] .status-closed { background:#374151; color:#d1d5db; }
    .pagination { display:flex; gap:6px; flex-wrap:wrap; justify-content:center; margin-top:12px; }
    .pagination button {
      border:1px solid var(--panel-border);
      background:var(--panel-bg);
      padding:4px 12px;
      font-size:.8rem;
      border-radius:8px;
      cursor:pointer;
      transition:var(--transition);
    }
    .pagination button.active,
    .pagination button:hover {
      background:var(--brand-grad);
      color:#fff;
      border-color:transparent;
    }
    .notification-container {
      position:fixed;
      top:16px;
      right:16px;
      z-index:2000;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-width:380px;
    }
    .toast-msg {
      background:#fff;
      border-radius:14px;
      padding:14px 16px;
      box-shadow:0 10px 24px -4px rgba(0,0,0,.18);
      display:flex;
      gap:12px;
      animation: slideIn .4s ease;
      border-left:6px solid #667eea;
    }
    [data-theme="dark"] .toast-msg { background:#2b3242; }
    .toast-msg.success { border-left-color:#16a34a; }
    .toast-msg.error { border-left-color:#dc2626; }
    .toast-msg.warn { border-left-color:#d97706; }
    .toast-msg .close {
      background:transparent;
      border:none;
      color:inherit;
      margin-left:auto;
      font-size:1.05rem;
      cursor:pointer;
    }
    @keyframes slideIn {
      from { transform:translateX(40px); opacity:0; }
      to { transform:translateX(0); opacity:1; }
    }
    .skeleton {
      background:linear-gradient(90deg,#e5e7eb 25%,#f3f4f6 37%,#e5e7eb 63%);
      background-size:400% 100%;
      animation: shimmer 1.4s ease infinite;
      border-radius:8px;
      min-height:14px;
    }
    @keyframes shimmer {
      0% { background-position:100% 0; }
      100% { background-position:0 0; }
    }
    .hidden { display:none!important; }
    .tab-section { display:none; }
    .tab-section.active { display:block; animation:fade .35s ease; }
    @keyframes fade {
      from { opacity:0; transform:translateY(8px); }
      to { opacity:1; transform:translateY(0); }
    }
    .floating-action {
      position:fixed;
      bottom:24px;
      right:24px;
      z-index:900;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .floating-action button {
      border-radius:50%;
      width:54px;
      height:54px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--brand-grad);
      color:#fff;
      border:none;
      box-shadow:0 6px 18px rgba(102,126,234,.4);
      font-size:1.3rem;
      transition:var(--transition);
    }
    .floating-action button:hover { transform:scale(1.08); }
    footer { margin-top:50px; text-align:center; font-size:.7rem; color:var(--muted); }
    .theme-toggle { cursor:pointer; padding:6px 10px; border-radius:10px; border:1px solid var(--panel-border); background:var(--panel-bg); display:flex; align-items:center; gap:6px; font-size:.75rem; font-weight:500; }
    @media (max-width: 768px) {
      .nav-main { overflow-x:auto; scrollbar-width:none; }
      .nav-main::-webkit-scrollbar { display:none; }
      .stat .value { font-size:1.5rem; }
    }
    /* 可選：非 LIFF 模式警示條 */
    #nonLiffBanner {
      position:fixed; left:0; right:0; top:0;
      background:#d97706; color:#fff;
      padding:6px 12px; font-size:.8rem;
      z-index:3000;
      display:none;
    }
  </style>
</head>
<body data-theme="light">
  <div id="nonLiffBanner">目前非 LINE LIFF 環境（Debug 模式），請勿在正式版使用假登入。</div>
  <div class="notification-container" id="notify"></div>
  <div class="app-shell">
    <div class="panel flex-between wrap" style="align-items:flex-start; gap:14px;">
      <div>
        <h4 class="mb-1 d-flex align-items-center gap-2">
          <span>🏥 帕金森病友會整合系統</span>
          <span class="badge bg-primary">Unified</span>
        </h4>
        <div class="text-muted small">
          會員服務 · 活動 · 志工 · 財務/收據 · 提案/動議 · 後台管理
        </div>
        <div id="currentUserLine" class="mt-2 small text-secondary">
          使用者狀態載入中...
        </div>
      </div>
      <div class="d-flex flex-column align-items-end gap-2">
        <div class="d-flex gap-2">
          <button class="theme-toggle" id="btnTheme">
            <i class="bi bi-moon-stars"></i><span>深色模式</span>
          </button>
          <button class="btn btn-sm btn-outline-primary" id="btnReloadProfile">
            <i class="bi bi-arrow-clockwise me-1"></i>重新載入資料
          </button>
        </div>
        <div class="d-flex gap-2">
          <button id="btnSwitchPortal" class="btn btn-sm btn-outline-secondary hidden">切換：管理後台</button>
          <button id="btnLogout" class="btn btn-sm btn-outline-danger"><i class="bi bi-box-arrow-right me-1"></i>登出</button>
        </div>
        <div id="debugLoginBox" class="text-end mt-1 hidden">
          <input id="debugLineId" class="form-control form-control-sm mb-1" placeholder="測試 lineId (debug)">
          <button class="btn btn-sm btn-warning" id="btnDebugLogin">測試登入</button>
        </div>
      </div>
    </div>

    <!-- Member Nav -->
    <div class="nav-main" id="memberNav">
      <button class="nav-btn active" data-section="member-dashboard"><i class="bi bi-speedometer2"></i>儀表板</button>
      <button class="nav-btn" data-section="member-profile"><i class="bi bi-person-badge"></i>個人資料</button>
      <button class="nav-btn" data-section="member-activities"><i class="bi bi-calendar-event"></i>活動</button>
      <button class="nav-btn" data-section="member-volunteer"><i class="bi bi-heart"></i>志工</button>
      <button class="nav-btn" data-section="member-finance"><i class="bi bi-wallet2"></i>財務</button>
      <button class="nav-btn" data-section="member-feedback"><i class="bi bi-chat-dots"></i>回饋</button>
      <button class="nav-btn hidden" id="navToAdmin"><i class="bi bi-shield-lock"></i>後台</button>
    </div>

    <!-- Admin Nav -->
    <div class="nav-main hidden" id="adminNav">
      <button class="nav-btn active" data-section="admin-dashboard"><i class="bi bi-speedometer2"></i>後台儀表板</button>
      <button class="nav-btn" data-section="admin-finance"><i class="bi bi-cash-coin"></i>財務管理</button>
      <button class="nav-btn" data-section="admin-receipts"><i class="bi bi-receipt-cutoff"></i>收據</button>
      <button class="nav-btn" data-section="admin-members"><i class="bi bi-people"></i>會員</button>
      <button class="nav-btn" data-section="admin-activities"><i class="bi bi-calendar3"></i>活動管理</button>
      <button class="nav-btn" data-section="admin-proposals"><i class="bi bi-file-text"></i>提案</button>
      <button class="nav-btn" data-section="admin-expenses"><i class="bi bi-receipt"></i>支出審核</button>
      <button class="nav-btn" data-section="admin-motions"><i class="bi bi-lightning"></i>臨時動議</button>
      <button class="nav-btn" data-section="admin-system"><i class="bi bi-gear-wide-connected"></i>系統工具</button>
      <button class="nav-btn" id="navBackToMember"><i class="bi bi-arrow-return-left"></i>返回會員</button>
    </div>

    <!-- ========== MEMBER SECTIONS ========== -->
    <div id="memberSections">
      <section id="member-dashboard" class="tab-section active">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">會員儀表板</h5>
            <div>
              <button class="btn btn-sm btn-outline-primary" id="btnRefreshMemberDash"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
          </div>
          <div class="stat-grid" id="memberStatsSkeleton">
            <div class="skeleton" style="height:90px;"></div>
            <div class="skeleton" style="height:90px;"></div>
            <div class="skeleton" style="height:90px;"></div>
            <div class="skeleton" style="height:90px;"></div>
          </div>
          <div class="stat-grid d-none" id="memberStats">
            <div class="stat">
              <div class="label">開放活動</div>
              <div class="value" id="stOpenActs">0</div>
            </div>
            <div class="stat">
              <div class="label">我的報名</div>
              <div class="value" id="stMyRegs">0</div>
            </div>
            <div class="stat">
              <div class="label">志工時數</div>
              <div class="value" id="stVolHours">0</div>
            </div>
            <div class="stat">
              <div class="label">捐款次數</div>
              <div class="value" id="stDonCount">0</div>
            </div>
          </div>
          <div class="divider"></div>
          <h6 class="mb-2">最新活動</h6>
          <div id="latestActivities" class="row g-3">
            <div class="col-12 skeleton" style="height:48px;"></div>
          </div>
        </div>
      </section>

      <section id="member-profile" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">個人資料</h5>
            <button class="btn btn-sm btn-outline-success" id="btnSaveProfile"><i class="bi bi-save me-1"></i>儲存</button>
          </div>
          <form id="profileForm" class="row g-3">
            <div class="col-md-4">
              <div class="form-floating">
                <input type="text" id="pfLineName" class="form-control" disabled>
                <label>LINE 名稱</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="text" id="pfRealName" class="form-control" required>
                <label>真實姓名 *</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <select id="pfMemberType" class="form-select">
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                  <option value="醫護">醫護人員</option>
                  <option value="一般會員">一般會員</option>
                  <option value="VIP會員">VIP會員</option>
                </select>
                <label>會員類別</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="tel" id="pfPhone" class="form-control">
                <label>電話</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="email" id="pfEmail" class="form-control">
                <label>Email</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="date" id="pfBirthday" class="form-control">
                <label>生日</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea id="pfAddress" class="form-control" style="height:80px;"></textarea>
                <label>地址</label>
              </div>
            </div>
          </form>
          <div class="divider"></div>
          <h6>統計資訊</h6>
          <ul class="list-group small" id="profileStats"></ul>
        </div>
      </section>

      <section id="member-activities" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">活動列表 / 報名</h5>
            <div>
              <button class="btn btn-sm btn-outline-primary" id="btnReloadActs"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
          </div>
          <div class="row g-3 mb-2">
            <div class="col-md-2">
              <select id="actFilterStatus" class="form-select form-select-sm">
                <option value="">全部狀態</option>
                <option value="開放報名">開放報名</option>
                <option value="已結束">已結束</option>
              </select>
            </div>
            <div class="col-md-2">
              <input type="date" id="actFilterDate" class="form-control form-control-sm">
            </div>
            <div class="col-md-3">
              <input type="text" id="actFilterSearch" class="form-control form-control-sm" placeholder="搜尋活動名稱/地點/描述">
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-sm btn-outline-secondary" id="btnApplyActFilter">篩選</button>
            </div>
          </div>
          <div id="activitiesList" class="mb-4"></div>
          <div id="activitiesPagination" class="pagination"></div>
          <div class="divider"></div>
          <h6 class="mb-2">我的報名</h6>
          <div id="myRegistrations"></div>
        </div>
      </section>

      <section id="member-volunteer" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">志工服務</h5>
            <button class="btn btn-sm btn-outline-primary" id="btnReloadVolunteer"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
          <h6 class="mb-2">志工需求</h6>
          <div id="volNeedsList" class="mb-3"></div>
          <div class="divider"></div>
          <h6 class="mb-2">我的志工紀錄</h6>
          <div id="volRecordsList"></div>
        </div>
      </section>

      <section id="member-finance" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">財務互動（個人）</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalDonation">
                <i class="bi bi-cash-coin me-1"></i>新增捐款
              </button>
              <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalExpense">
                <i class="bi bi-receipt me-1"></i>支出申請
              </button>
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <div class="stat">
                <div class="label">總捐款次數</div>
                <div class="value" id="finDonCountMember">0</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat">
                <div class="label">總捐款額</div>
                <div class="value" id="finDonAmountMember">0</div>
              </div>
            </div>
          </div>
          <h6>捐款紀錄</h6>
          <div id="memberDonationList" class="mb-3"></div>
          <div class="divider"></div>
          <h6>支出申請紀錄</h6>
          <div id="memberExpenseList"></div>
          <div class="divider d-none" id="memberFinAdminDivider"></div>
          <div id="financeOverviewAdmin" class="d-none">
            <h6>（管理員）組織財務概覽</h6>
            <div class="row g-3">
              <div class="col-md-3"><div class="stat"><div class="label">總收入</div><div class="value" id="ovIncome">0</div></div></div>
              <div class="col-md-3"><div class="stat"><div class="label">總支出</div><div class="value" id="ovExpense">0</div></div></div>
              <div class="col-md-3"><div class="stat"><div class="label">餘額</div><div class="value" id="ovBalance">0</div></div></div>
              <div class="col-md-3"><div class="stat"><div class="label">捐款筆數</div><div class="value" id="ovDonationCount">0</div></div></div>
            </div>
          </div>
        </div>
      </section>

      <section id="member-feedback" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">活動回饋</h5>
            <button class="btn btn-sm btn-outline-primary" id="btnReloadFeedback"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <div class="form-floating">
                <select id="fbActivitySelect" class="form-select">
                  <option value="">選擇活動</option>
                </select>
                <label>已參與活動</label>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-floating">
                <select id="fbRating" class="form-select">
                  <option value="">選擇</option>
                  <option value="5">5 - 極好</option>
                  <option value="4">4 - 很好</option>
                  <option value="3">3 - 普通</option>
                  <option value="2">2 - 待改善</option>
                  <option value="1">1 - 不滿意</option>
                </select>
                <label>評分</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <textarea id="fbComment" class="form-control" style="height:90px;"></textarea>
                <label>意見 / 建議</label>
              </div>
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-sm btn-success" id="btnSubmitFeedback"><i class="bi bi-send me-1"></i>提交回饋</button>
            </div>
          </div>
          <div class="divider"></div>
          <h6>我的回饋紀錄</h6>
          <div id="myFeedbackList">尚無資料</div>
        </div>
      </section>
    </div>

    <!-- ========== ADMIN SECTIONS ========== -->
    <div id="adminSections" class="hidden">
      <section id="admin-dashboard" class="tab-section active">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">管理儀表板</h5>
            <button class="btn btn-sm btn-outline-primary" id="btnRefreshAdminDashboard"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
          <div class="stat-grid" id="adminDashStats">
            <div class="skeleton" style="height:110px;"></div>
            <div class="skeleton" style="height:110px;"></div>
            <div class="skeleton" style="height:110px;"></div>
            <div class="skeleton" style="height:110px;"></div>
            <div class="skeleton" style="height:110px;"></div>
            <div class="skeleton" style="height:110px;"></div>
          </div>
          <div class="divider"></div>
          <h6>提醒 / 系統訊息</h6>
          <ul class="list-group small" id="systemAlerts"></ul>
        </div>
      </section>

      <section id="admin-finance" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">財務管理</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-success" id="btnShowTransactionForm"><i class="bi bi-plus-circle"></i> 交易</button>
              <button class="btn btn-sm btn-outline-secondary" id="btnExportTransactions"><i class="bi bi-download"></i> 匯出</button>
            </div>
          </div>
          <div id="transactionFormWrap" class="mb-3 hidden">
            <div class="card border-primary">
              <div class="card-header py-2 bg-primary text-white d-flex justify-content-between">
                <span>新增交易</span>
                <button class="btn btn-sm btn-light" id="btnHideTransactionForm">關閉</button>
              </div>
              <div class="card-body">
                <form id="formTransaction" class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="txDate" class="form-control" required>
                      <label>日期</label>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-floating">
                      <select id="txType" class="form-select" required>
                        <option value="">選擇</option>
                        <option value="收入">收入</option>
                        <option value="支出">支出</option>
                      </select>
                      <label>類型</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="txCategory" class="form-select" required>
                        <option value="">請先選擇類型</option>
                      </select>
                      <label>類別</label>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-floating">
                      <input type="number" id="txAmount" min="1" class="form-control" required>
                      <label>金額</label>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-floating">
                      <select id="txAccount" class="form-select">
                        <option value="現金">現金</option>
                        <option value="銀行">銀行</option>
                      </select>
                      <label>帳戶</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="text" id="txTarget" class="form-control">
                      <label>對象 / 捐款人</label>
                    </div>
                  </div>
                  <div class="col-md-8">
                    <div class="form-floating">
                      <input type="text" id="txDesc" class="form-control">
                      <label>說明</label>
                    </div>
                  </div>
                  <div class="col-12" id="txReceiptBlock" class="hidden">
                    <div class="border rounded p-3">
                      <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" id="txNeedReceipt">
                        <label class="form-check-label" for="txNeedReceipt">開立收據</label>
                      </div>
                      <div id="txReceiptDetails" class="row g-3 hidden">
                        <div class="col-md-4">
                          <div class="form-floating">
                            <input type="text" id="rcName" class="form-control">
                            <label>收據抬頭</label>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-floating">
                            <input type="email" id="rcEmail" class="form-control">
                            <label>Email（選填）</label>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-floating">
                            <input type="text" id="rcPhone" class="form-control">
                            <label>聯絡電話</label>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-floating">
                            <input type="text" id="rcTaxId" class="form-control">
                            <label>統一編號</label>
                          </div>
                        </div>
                        <div class="col-md-8">
                          <div class="form-floating">
                            <textarea id="rcAddress" class="form-control" style="height:70px;"></textarea>
                            <label>地址</label>
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="rcSendNow">
                            <label for="rcSendNow" class="form-check-label">立即寄送 Email</label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-primary btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>儲存</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>交易清單</h6>
          <div class="table-responsive mb-3" style="max-height:400px;">
            <table class="table table-hover table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>日期</th><th>類型</th><th>類別</th><th>金額</th><th>對象</th><th>收據</th><th></th>
                </tr>
              </thead>
              <tbody id="txList"><tr><td colspan="7" class="text-center text-muted">載入中...</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="admin-receipts" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">收據管理</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-info" id="btnOpenReceiptTemplate"><i class="bi bi-file-earmark-text"></i> 模板設定</button>
              <button class="btn btn-sm btn-outline-success" id="btnManualReceipt"><i class="bi bi-plus-circle"></i> 手動開立</button>
            </div>
          </div>
          <div id="manualReceiptForm" class="hidden mb-3">
            <div class="card border-success">
              <div class="card-header bg-success text-white py-2 d-flex justify-content-between">
                <span>手動開立收據</span>
                <button class="btn btn-sm btn-light" id="btnCloseManualReceipt">關閉</button>
              </div>
              <div class="card-body">
                <form id="formManualReceipt" class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="mrDate" class="form-control" required>
                      <label>日期</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="number" id="mrAmount" class="form-control" min="1" required>
                      <label>金額</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="mrCategory" class="form-select" required>
                        <option value="">選擇</option>
                        <option value="會費">會費</option>
                        <option value="捐款">捐款</option>
                        <option value="活動收入">活動收入</option>
                        <option value="其他收入">其他收入</option>
                      </select>
                      <label>類別</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="text" id="mrTitle" class="form-control" required>
                      <label>收據抬頭</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="email" id="mrEmail" class="form-control">
                      <label>Email（可空）</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="text" id="mrPhone" class="form-control">
                      <label>電話</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="text" id="mrTaxId" class="form-control">
                      <label>統編</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="mrAddress" class="form-control" style="height:70px;"></textarea>
                      <label>地址（可空）</label>
                    </div>
                  </div>
                  <div class="col-12 d-flex justify-content-between align-items-center">
                    <div class="form-check">
                      <input type="checkbox" id="mrSendNow" class="form-check-input">
                      <label for="mrSendNow" class="form-check-label">立即寄送（需 Email）</label>
                    </div>
                    <button class="btn btn-success btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>開立</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>收據列表</h6>
          <div id="receiptList"><div class="text-center py-4 text-muted">載入中...</div></div>
        </div>
      </section>

      <section id="admin-members" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">會員管理</h5>
            <button class="btn btn-sm btn-outline-primary" id="btnExportMembers"><i class="bi bi-download"></i> 匯出</button>
          </div>
          <div class="row g-2 mb-2">
            <div class="col-md-3">
              <input type="text" id="memberSearch" class="form-control form-control-sm" placeholder="搜尋姓名 / LINE ID">
            </div>
            <div class="col-md-2">
              <select id="memberTypeFilter" class="form-select form-select-sm">
                <option value="">所有類別</option>
                <option value="志工">志工</option>
                <option value="病友">病友</option>
                <option value="家屬">家屬</option>
                <option value="一般會員">一般會員</option>
                <option value="VIP會員">VIP會員</option>
              </select>
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-sm btn-outline-secondary" id="btnSearchMembers">搜尋</button>
            </div>
          </div>
          <div class="table-responsive" style="max-height:420px;">
            <table class="table table-sm table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>姓名</th><th>電話</th><th>會員狀態</th><th>加入日期</th><th>最後捐款</th><th></th>
                </tr>
              </thead>
              <tbody id="memberList"><tr><td colspan="6" class="text-center text-muted">載入中...</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="admin-activities" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">活動管理</h5>
            <button class="btn btn-sm btn-outline-success" id="btnShowActForm"><i class="bi bi-plus-circle"></i> 新增活動</button>
          </div>
          <div id="adminActFormWrap" class="hidden mb-3">
            <div class="card border-success">
              <div class="card-header bg-success text-white py-2 d-flex justify-content-between">
                <span>新增活動</span>
                <button class="btn btn-sm btn-light" id="btnCloseActForm">關閉</button>
              </div>
              <div class="card-body">
                <form id="formAdminActivity" class="row g-3">
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" id="admActName" class="form-control" required>
                      <label>活動名稱</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="admActType" class="form-select" required>
                        <option value="">選擇</option>
                        <option value="講座">講座</option>
                        <option value="聚會">聚會</option>
                        <option value="旅遊">旅遊</option>
                        <option value="運動">運動</option>
                        <option value="志工服務">志工服務</option>
                        <option value="其他">其他</option>
                      </select>
                      <label>活動類型</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="number" id="admActMax" class="form-control" value="50">
                      <label>人數上限</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="admActDate" class="form-control" required>
                      <label>日期</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="time" id="admActTime" class="form-control">
                      <label>時間</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" id="admActLocation" class="form-control">
                      <label>地點</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="admActDesc" class="form-control" style="height:80px;"></textarea>
                      <label>描述</label>
                    </div>
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-success btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>建立</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>活動清單</h6>
          <div id="adminActList" class="row g-3">
            <div class="col-12 text-center text-muted py-4">載入中...</div>
          </div>
        </div>
      </section>

      <section id="admin-proposals" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">提案審查</h5>
            <button class="btn btn-sm btn-outline-success" id="btnShowProposalForm"><i class="bi bi-plus-circle"></i> 新增提案</button>
          </div>
          <div id="proposalFormWrap" class="hidden mb-3">
            <div class="card border-success">
              <div class="card-header bg-success text-white py-2 d-flex justify-content-between">
                <span>新增提案</span>
                <button class="btn btn-sm btn-light" id="btnCloseProposalForm">關閉</button>
              </div>
              <div class="card-body">
                <form id="formProposal" class="row g-3">
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" id="propTitle" class="form-control" required>
                      <label>標題</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="propType" class="form-select" required>
                        <option value="">類型</option>
                        <option value="預算提案">預算提案</option>
                        <option value="活動提案">活動提案</option>
                        <option value="制度提案">制度提案</option>
                        <option value="人事提案">人事提案</option>
                        <option value="其他提案">其他提案</option>
                      </select>
                      <label>提案類型</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="number" id="propBudget" class="form-control" min="0">
                      <label>預算（可空）</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="propDeadline" class="form-control">
                      <label>執行期限</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="propContent" class="form-control" style="height:120px;" required></textarea>
                      <label>內容</label>
                    </div>
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-success btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>提交</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>提案列表</h6>
          <div id="proposalList"><div class="text-center py-4 text-muted">載入中...</div></div>
        </div>
      </section>

      <section id="admin-expenses" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">支出憑證審核</h5>
            <button class="btn btn-sm btn-outline-warning" id="btnShowExpenseSubmit"><i class="bi bi-plus-circle"></i> 提交憑證</button>
          </div>
          <div id="expenseSubmitWrap" class="hidden mb-3">
            <div class="card border-warning">
              <div class="card-header bg-warning py-2 d-flex justify-content-between">
                <span class="fw-bold">提交支出憑證</span>
                <button class="btn btn-sm btn-light" id="btnCloseExpenseSubmit">關閉</button>
              </div>
              <div class="card-body">
                <form id="formExpenseSubmit" class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="exDate" class="form-control" required>
                      <label>日期</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="exCategory" class="form-select" required>
                        <option value="">選擇</option>
                        <option value="活動費用">活動費用</option>
                        <option value="辦公費用">辦公費用</option>
                        <option value="交通費">交通費</option>
                        <option value="餐費">餐費</option>
                        <option value="場地費">場地費</option>
                        <option value="其他支出">其他支出</option>
                      </select>
                      <label>類別</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="number" id="exAmount" class="form-control" min="1" required>
                      <label>金額</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="text" id="exVendor" class="form-control" required>
                      <label>廠商 / 店家</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="exDesc" class="form-control" style="height:90px;" required></textarea>
                      <label>支出說明</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label fw-semibold">憑證圖片 (jpg/png)</label>
                    <input type="file" id="exFile" class="form-control" accept="image/*" required>
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-warning btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>提交</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>支出列表</h6>
          <div id="expenseList"><div class="text-center py-4 text-muted">載入中...</div></div>
        </div>
      </section>

      <section id="admin-motions" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">臨時動議</h5>
            <button class="btn btn-sm btn-outline-danger" id="btnShowMotionForm"><i class="bi bi-plus-circle"></i> 提出動議</button>
          </div>
          <div id="motionFormWrap" class="hidden mb-3">
            <div class="card border-danger">
              <div class="card-header bg-danger text-white py-2 d-flex justify-content-between">
                <span>提出臨時動議</span>
                <button class="btn btn-sm btn-light" id="btnCloseMotionForm">關閉</button>
              </div>
              <div class="card-body">
                <form id="formMotion" class="row g-3">
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" id="moTitle" class="form-control" required>
                      <label>標題</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="moUrgency" class="form-select" required>
                        <option value="">緊急程度</option>
                        <option value="緊急">緊急</option>
                        <option value="重要">重要</option>
                        <option value="一般">一般</option>
                      </select>
                      <label>緊急程度</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="moDeadline" class="form-control">
                      <label>決議期限</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="moContent" class="form-control" style="height:100px;" required></textarea>
                      <label>動議內容</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="moReason" class="form-control" style="height:70px;" required></textarea>
                      <label>提出理由</label>
                    </div>
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-danger btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>送出</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>動議列表</h6>
          <div id="motionList"><div class="text-center py-4 text-muted">載入中...</div></div>
        </div>
      </section>

      <section id="admin-system" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">系統工具 / 匯出 / 通知</h5>
          </div>
          <div class="row g-3">
            <div class="col-md-4">
              <div class="stat">
                <div class="label">備份</div>
                <div class="value" style="font-size:1.4rem;">System</div>
                <button class="btn btn-sm btn-outline-secondary mt-2 w-100" id="btnBackupSystem">
                  <i class="bi bi-hdd-stack me-1"></i>開始備份
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat">
                <div class="label">匯出</div>
                <div class="value" style="font-size:1.4rem;">Data</div>
                <button class="btn btn-sm btn-outline-secondary mt-2 w-100" id="btnExportDataAll">
                  <i class="bi bi-download me-1"></i>匯出資料
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat">
                <div class="label">通知</div>
                <div class="value" style="font-size:1.4rem;">Push</div>
                <button class="btn btn-sm btn-outline-secondary mt-2 w-100" id="btnSendSystemNotice">
                  <i class="bi bi-megaphone me-1"></i>發送通知
                </button>
              </div>
            </div>
          </div>
          <div class="divider"></div>
          <h6>匯出工具</h6>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-primary btn-sm export-btn" data-type="會員資料">會員</button>
            <button class="btn btn-outline-primary btn-sm export-btn" data-type="交易記錄">交易</button>
            <button class="btn btn-outline-primary btn-sm export-btn" data-type="收據記錄">收據</button>
            <button class="btn btn-outline-primary btn-sm export-btn" data-type="活動資料">活動</button>
          </div>
        </div>
      </section>
    </div>

    <footer class="mt-5">
      Unified Parkinson Association System | Front-end v2 (form-urlencoded) | 由 GPT-5 協助產出
    </footer>
  </div>

  <!-- Floating Action Buttons -->
  <div class="floating-action" id="floatingActions">
    <button id="fabAddDonation" class="hidden" title="快速捐款"><i class="bi bi-cash-stack"></i></button>
    <button id="fabAddActivity" class="hidden" title="快速活動 (管理員)"><i class="bi bi-calendar-plus"></i></button>
    <button id="fabScrollTop" title="回到頂部"><i class="bi bi-arrow-up-short"></i></button>
  </div>

  <!-- Donation Modal -->
  <div class="modal fade" id="modalDonation" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="formDonation">
        <div class="modal-header">
          <h5 class="modal-title">新增捐款</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-3">
          <div class="col-md-6">
            <div class="form-floating">
              <input type="number" min="1" id="donAmount" class="form-control" required>
              <label>金額 *</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <select id="donMethod" class="form-select">
                <option value="現金">現金</option>
                <option value="轉帳">轉帳</option>
                <option value="信用卡">信用卡</option>
                <option value="其他">其他</option>
              </select>
              <label>方式</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <input type="date" id="donDate" class="form-control">
              <label>日期</label>
            </div>
          </div>
          <div class="col-12">
            <div class="form-floating">
              <textarea id="donNote" class="form-control" style="height:80px;"></textarea>
              <label>備註</label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal" type="button">取消</button>
          <button class="btn btn-primary btn-sm" type="submit">送出</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Member Expense Modal -->
  <div class="modal fade" id="modalExpense" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="formMemberExpense">
        <div class="modal-header">
          <h5 class="modal-title">支出申請</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
          <div class="modal-body row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" id="memExpItem" class="form-control" required>
                <label>項目 *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="number" id="memExpAmount" class="form-control" min="1" required>
                <label>金額 *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <select id="memExpCategory" class="form-select">
                  <option value="活動費用">活動費用</option>
                  <option value="交通費">交通費</option>
                  <option value="餐飲費">餐飲費</option>
                  <option value="設備費">設備費</option>
                  <option value="其他">其他</option>
                </select>
                <label>類別</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="date" id="memExpDate" class="form-control">
                <label>日期</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea id="memExpDesc" class="form-control" style="height:80px;"></textarea>
                <label>說明</label>
              </div>
            </div>
          </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal" type="button">取消</button>
          <button class="btn btn-primary btn-sm" type="submit">送出</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Receipt Template Modal -->
  <div class="modal fade" id="modalReceiptTemplate" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-file-earmark-text me-1"></i>收據模板設定</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formReceiptTemplate" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" id="tplDocId" class="form-control">
                <label>Google 文件模板 ID</label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-floating">
                <input type="text" id="tplPrefix" class="form-control" value="RCP">
                <label>收據前綴</label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-floating">
                <input type="text" id="tplOrgName" class="form-control">
                <label>機構名稱</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" id="tplOrgPhone" class="form-control">
                <label>機構電話</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <textarea id="tplOrgAddress" class="form-control" style="height:80px;"></textarea>
                <label>機構地址</label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary btn-sm" id="btnSaveReceiptTemplate"><i class="bi bi-save me-1"></i>儲存</button>
        </div>
      </div>
    </div>
  </div>

  <div id="dynamicModal"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /*********************************************************
     * CONFIG
     *********************************************************/
    const CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',   // 必填：你的 liffId
      API_BASE: 'https://script.google.com/macros/s/AKfycbwfrbQ3j3HrGYqerqUBy5_Epvc6JCIwMq2YDS8N7RHUnUxPp8H-qmmhBl3rfpeC9vLzGQ/exec', // 必填：後端 doPost Web App URL（/exec）
      API_KEY: 'AAbb8520258185202581',
      USE_SIGNATURE: false,    // 若啟用請同步後端
      RETRIES: 2,
      ACTIVITY_PAGE_SIZE: 8,
      DEBUG_NON_LIFF: false    // 設 true 可在普通瀏覽器用假 lineId 測試
    };

    const ACTION_MAP = {
      register: 'register',
      getProfile: 'getProfile',
      updateProfile: 'updateProfile',
      getUserInfo: 'getUserInfo',
      updateUserContact: 'updateUserContact',

      getActivities: 'getActivities',
      registerActivity: 'registerActivity',
      getMyRegistrations: 'getMyRegistrations',
      cancelActivity: 'cancelActivity',
      getUserActivities: 'getUserActivities',

      getVolunteerNeeds: 'getVolunteerNeeds',
      getMyVolunteerRecords: 'getMyVolunteerRecords',
      registerVolunteer: 'registerVolunteer',

      getDonations: 'getDonations',
      addDonation: 'addDonation',
      getMyExpenses: 'getMyExpenses',
      submitExpense: 'submitExpense',

      getFinanceOverview: 'getFinanceOverview',

      getDashboardData: 'getDashboardData',
      exportData: 'exportData',
      backupSystem: 'backupSystem',
      sendSystemNotification: 'sendSystemNotification',

      getTransactionList: 'getTransactionList',
      addTransactionWithReceipt: 'addTransactionWithReceipt',
      deleteTransaction: 'deleteTransaction',
      createReceiptForTransaction: 'createReceiptForTransaction',

      getReceiptTemplate: 'getReceiptTemplate',
      saveReceiptTemplate: 'saveReceiptTemplate',
      getReceiptList: 'getReceiptList',
      createManualReceipt: 'createManualReceipt',
      sendReceipt: 'sendReceipt',
      regenerateReceiptPDF: 'regenerateReceiptPDF',

      getMemberList: 'getMemberList',
      getMemberDetail: 'getMemberDetail',
      updateMemberStatus: 'updateMemberStatus',

      addActivity: 'addActivity',
      getActivityList: 'getActivityList',
      exportActivityMembers: 'exportActivityMembers',

      addProposal: 'addProposal',
      getProposalList: 'getProposalList',
      voteProposal: 'voteProposal',

      addExpense: 'addExpense',
      getExpenseList: 'getExpenseList',
      approveExpense: 'approveExpense',

      addMotion: 'addMotion',
      getMotionList: 'getMotionList',
      processMotion: 'processMotion',

      submitFeedback: 'submitFeedback',
      getMyFeedback: 'getMyFeedback'
    };

    /*********************************************************
     * 全域狀態
     *********************************************************/
    let currentUser = null;
    let isAdmin = false;
    let currentSection = 'member-dashboard';
    let activityCache = [];
    let filteredActivities = [];
    let currentActPage = 1;
    let liffProfile = null;
    let debugLineId = null;

    /*********************************************************
     * DOM 工具
     *********************************************************/
    const $ = sel => document.querySelector(sel);
    const $all = sel => document.querySelectorAll(sel);

    function escapeHtml(s=''){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
    function fmtDate(d){
      if(!d) return '-';
      const dt = new Date(d);
      if(isNaN(dt)) return '-';
      return dt.getFullYear() + '/' + String(dt.getMonth()+1).padStart(2,'0') + '/' + String(dt.getDate()).padStart(2,'0');
    }
    function fmtDateTime(d){
      if(!d) return '-';
      const dt = new Date(d);
      if(isNaN(dt)) return '-';
      return dt.toLocaleString('zh-TW');
    }
    function numberFmt(n){ return (Number(n)||0).toLocaleString(); }

    /*********************************************************
     * 通知
     *********************************************************/
    function notify(msg, type='info', ms=4000){
      const cont = $('#notify');
      const div = document.createElement('div');
      div.className = 'toast-msg '+ (type==='error'?'error': type==='success'?'success': type==='warn'?'warn':'');
      div.innerHTML = `
        <div>
          <strong>${type==='error'?'錯誤': type==='success'?'成功': type==='warn'?'提醒':'訊息'}</strong><br>
          <span>${escapeHtml(msg)}</span>
        </div>
        <button class="close" aria-label="關閉">&times;</button>
      `;
      div.querySelector('.close').addEventListener('click', ()=> div.remove());
      cont.appendChild(div);
      if(ms) setTimeout(()=> div.remove(), ms);
    }

    /*********************************************************
     * API - form-urlencoded 版本
     *********************************************************/
    async function callAPI(action, data={}, opt={silent:false}){
      const payload = {
        action,
        apiKey: CONFIG.API_KEY,
        ts: Date.now(),
        nonce: Math.random().toString(36).slice(2),
        ...data
      };
      if(CONFIG.USE_SIGNATURE){
        const baseString = `${action}|${payload.ts}|${payload.nonce}|${CONFIG.API_KEY}`;
        payload.sign = CryptoJS.HmacSHA256(baseString, CONFIG.API_KEY).toString();
      }

      const form = new URLSearchParams();
      Object.keys(payload).forEach(k=>{
        let v = payload[k];
        if(v && typeof v === 'object'){
          v = JSON.stringify(v);
        }
          form.append(k, v==null?'':v);
      });

      let attempt=0;
      while(attempt <= CONFIG.RETRIES){
        try {
          const res = await fetch(CONFIG.API_BASE, {
            method:'POST',
            body: form,
            cache:'no-store'
          });
          if(!res.ok) throw new Error('HTTP '+res.status);
          const json = await res.json();
          if(json.success === false) throw new Error(json.message || '操作失敗');
          return json;
        } catch(err){
          attempt++;
          if(attempt>CONFIG.RETRIES){
            if(!opt.silent) notify(`API(${action}) 失敗：${err.message}`,'error',6000);
            throw err;
          }
          await new Promise(r=> setTimeout(r, 400 * attempt));
        }
      }
    }

    /*********************************************************
     * LIFF 初始化
     *********************************************************/
    async function initApp(){
      if(CONFIG.DEBUG_NON_LIFF && !isInLiff()){
        // 顯示 debug 假登入
        $('#nonLiffBanner').style.display='block';
        $('#debugLoginBox').classList.remove('hidden');
        notify('Debug 模式，請輸入 lineId 進行測試登入','warn',8000);
        return;
      }
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if(!liff.isLoggedIn()){
          liff.login();
          return;
        }
        liffProfile = await liff.getProfile();
        await safeRegister();
        await loadUserProfile();
        setupUIByRole();
        loadMemberDashboard();
      } catch(e){
        notify('LIFF 初始化失敗: '+e.message,'error',8000);
        console.error(e);
      }
    }

    function isInLiff(){
      return (typeof liff !== 'undefined') && !!liff.getOS && !CONFIG.DEBUG_NON_LIFF_FORCE;
    }

    // Debug 假登入
    $('#btnDebugLogin')?.addEventListener('click', async ()=>{
      const v = $('#debugLineId').value.trim();
      if(!v) return notify('請輸入測試 lineId','warn');
      debugLineId = v;
      notify('使用偽 lineId: '+v,'success');
      await safeRegister(true);
      await loadUserProfile(true);
      setupUIByRole();
      loadMemberDashboard();
    });

    async function safeRegister(isDebug=false){
      try {
        await callAPI(ACTION_MAP.register, {
          lineId: isDebug? debugLineId : liffProfile.userId,
          lineName: isDebug? ('DebugUser_'+debugLineId) : (liffProfile.displayName||'LINE使用者'),
          realName: isDebug? ('DebugUser_'+debugLineId) : (liffProfile.displayName||'')
        }, {silent:true});
      } catch(e){
        console.warn('register skipped:', e.message);
      }
    }

    async function loadUserProfile(isDebug=false){
      try {
        const res = await callAPI(ACTION_MAP.getProfile,{
          lineId: isDebug? debugLineId : liffProfile.userId
        },{silent:true});
        currentUser = res.data || res;
      } catch(e){
        notify('取得使用者資料失敗: '+e.message,'error');
        currentUser = null;
      }
      isAdmin = !!(currentUser && (currentUser.isAdmin==='TRUE' || currentUser.isAdmin===true ||
         ['admin','chairman','director','supervisor'].includes(String(currentUser.role).toLowerCase())));
      updateUserLine();
      fillProfileForm();
    }

    function updateUserLine(){
      const el = $('#currentUserLine');
      if(!currentUser){
        el.textContent = '尚未載入使用者資料';
        return;
      }
      el.innerHTML = `
        <span class="me-2"><i class="bi bi-person-circle"></i> ${escapeHtml(currentUser.realName || currentUser.lineName || '用戶')}</span>
        <span class="badge bg-secondary me-2">${escapeHtml(currentUser.memberType || '會員')}</span>
        ${isAdmin ? '<span class="badge bg-danger">管理員</span>':''}
      `;
      if(isAdmin){
        $('#navToAdmin').classList.remove('hidden');
        $('#btnSwitchPortal').classList.remove('hidden');
      }
    }

    function fillProfileForm(){
      if(!currentUser) return;
      $('#pfLineName').value = currentUser.lineName || '';
      $('#pfRealName').value = currentUser.realName || '';
      $('#pfPhone').value = currentUser.phone || '';
      $('#pfEmail').value = currentUser.email || '';
      $('#pfBirthday').value = currentUser.birthday || '';
      $('#pfMemberType').value = currentUser.memberType || '病友';
      $('#pfAddress').value = currentUser.address || '';
      const stats = [
        '狀態：' + (currentUser.status || '-'),
        '註冊：' + (currentUser.registerDate ? fmtDate(currentUser.registerDate) : '-'),
        '最後活動：' + (currentUser.lastActive ? fmtDate(currentUser.lastActive) : '-'),
        '志工時數：' + (currentUser.volunteerHours || 0),
        '活動次數：' + (currentUser.activityCount || 0)
      ];
      $('#profileStats').innerHTML = stats.map(s=>`<li class="list-group-item">${escapeHtml(s)}</li>`).join('');
    }

    function setupUIByRole(){
      $('#memberSections').classList.remove('hidden');
      $('#adminSections').classList.add('hidden');
      $('#memberNav').classList.remove('hidden');
      $('#adminNav').classList.add('hidden');
    }

    /*********************************************************
     * 導航 / Section 切換
     *********************************************************/
    function showSection(id){
      currentSection = id;
      $all('.tab-section').forEach(sec=> sec.classList.remove('active'));
      const el = document.getElementById(id);
      if(el) el.classList.add('active');
      $all('.nav-btn').forEach(b=> b.classList.remove('active'));
      const navBtn = document.querySelector(`.nav-btn[data-section="${id}"]`);
      if(navBtn) navBtn.classList.add('active');
      handleFabVisibility();

      switch(id){
        case 'member-activities': loadActivities(); break;
        case 'member-volunteer': loadVolunteer(); break;
        case 'member-finance': loadMemberFinance(); break;
        case 'member-feedback': loadFeedbackModule(); break;
        case 'admin-dashboard': loadAdminDashboard(); break;
        case 'admin-finance': loadTransactions(); break;
        case 'admin-receipts': loadReceipts(); break;
        case 'admin-members': loadMemberList(); break;
        case 'admin-activities': loadAdminActivities(); break;
        case 'admin-proposals': loadProposals(); break;
        case 'admin-expenses': loadExpenses(); break;
        case 'admin-motions': loadMotions(); break;
      }
    }

    $all('.nav-btn[data-section]').forEach(btn=>{
      btn.addEventListener('click', ()=> showSection(btn.getAttribute('data-section')));
    });

    /*********************************************************
     * 主題
     *********************************************************/
    function toggleTheme(){
      const body = document.body;
      const cur = body.getAttribute('data-theme');
      const next = cur==='light'?'dark':'light';
      body.setAttribute('data-theme', next);
      const icon = $('#btnTheme i');
      const label = $('#btnTheme span');
      if(next==='dark'){
        icon.className='bi bi-sun';
        label.textContent='淺色模式';
      } else {
        icon.className='bi bi-moon-stars';
        label.textContent='深色模式';
      }
      localStorage.setItem('appTheme', next);
    }
    $('#btnTheme').addEventListener('click', toggleTheme);

    function initTheme(){
      const saved = localStorage.getItem('appTheme');
      if(saved){
        document.body.setAttribute('data-theme', saved);
        if(saved==='dark'){
          $('#btnTheme i').className='bi bi-sun';
          $('#btnTheme span').textContent='淺色模式';
        }
      }
    }

    /*********************************************************
     * 會員儀表板
     *********************************************************/
    async function loadMemberDashboard(){
      try {
        $('#memberStatsSkeleton').classList.remove('d-none');
        $('#memberStats').classList.add('d-none');
        const lineId = debugLineId || (liffProfile && liffProfile.userId);
        const [actsRes, regsRes, volsRes, donsRes] = await Promise.allSettled([
          callAPI(ACTION_MAP.getActivities,{}, {silent:true}),
          callAPI(ACTION_MAP.getMyRegistrations,{ lineId },{silent:true}),
          callAPI(ACTION_MAP.getMyVolunteerRecords,{ lineId },{silent:true}),
          callAPI(ACTION_MAP.getDonations,{ lineId },{silent:true})
        ]);
        const acts = actsRes.value?.data || actsRes.value || [];
        const regs = regsRes.value?.data || regsRes.value || [];
        const vols = volsRes.value?.data || volsRes.value || [];
        const dons = donsRes.value?.data || donsRes.value || [];

        $('#stOpenActs').textContent = acts.filter(a=> a.status==='開放報名' || a.status==='報名中').length;
        $('#stMyRegs').textContent = regs.filter(r=> r.status==='已報名' || r.status==='報名中').length;
        const volHours = vols.filter(v=> v.status==='已核准' || v.status==='通過')
          .reduce((s,v)=> s + (Number(v.hours||0)),0);
        $('#stVolHours').textContent = volHours;
        $('#stDonCount').textContent = dons.length;

        const latest = acts.slice(0,4);
        const container = $('#latestActivities');
        if(!latest.length){
          container.innerHTML = '<div class="col-12 small text-muted">目前沒有活動</div>';
        } else {
          container.innerHTML = latest.map(a=>`
            <div class="col-md-6">
              <div class="activity-card">
                <div class="d-flex justify-content-between">
                  <strong>${escapeHtml(a.name||'未命名')}</strong>
                  <span class="status-pill ${
                    a.status==='開放報名'
                      ? 'status-open'
                      : (a.currentCount && a.maxParticipants && a.currentCount>=a.maxParticipants ? 'status-full':'status-closed')
                  }">${escapeHtml(a.status||'')}</span>
                </div>
                <div class="small text-muted">
                  日期：${fmtDate(a.date)}<br>
                  地點：${escapeHtml(a.location||'待定')}
                </div>
              </div>
            </div>
          `).join('');
        }
        $('#memberStatsSkeleton').classList.add('d-none');
        $('#memberStats').classList.remove('d-none');
      } catch(e){
        notify('載入儀表板失敗：'+e.message,'error');
      }
    }

    /*********************************************************
     * 活動
     *********************************************************/
    function buildActivityFilter(){
      return {
        status: $('#actFilterStatus').value,
        date: $('#actFilterDate').value,
        search: $('#actFilterSearch').value.trim()
      };
    }

    async function loadActivities(){
      try {
        const res = await callAPI(ACTION_MAP.getActivities, buildActivityFilter(), {silent:true});
        activityCache = res.data || res;
        applyActivityFilter();
      } catch(e){
        $('#activitiesList').innerHTML = '<div class="text-danger small">載入活動失敗: '+escapeHtml(e.message)+'</div>';
      }
      loadMyRegistrations();
    }

    function applyActivityFilter(){
      const { status, date, search } = buildActivityFilter();
      filteredActivities = activityCache.filter(a=>{
        const matchStatus = !status || a.status===status;
          const matchDate = !date || (a.date||'').startsWith(date);
        const lower = (search||'').toLowerCase();
        const matchSearch = !search || (
          (a.name||'').toLowerCase().includes(lower) ||
          (a.description||'').toLowerCase().includes(lower) ||
          (a.location||'').toLowerCase().includes(lower)
        );
        return matchStatus && matchDate && matchSearch;
      });
      currentActPage = 1;
      renderActivitiesPage();
    }

    function renderActivitiesPage(){
      const wrap = $('#activitiesList');
      const pag = $('#activitiesPagination');
      const size = CONFIG.ACTIVITY_PAGE_SIZE;
      const total = filteredActivities.length;
      const pages = Math.ceil(total/size)||1;
      if(currentActPage>pages) currentActPage = pages;
      const start = (currentActPage-1)*size;
      const pageData = filteredActivities.slice(start, start+size);
      if(!pageData.length){
        wrap.innerHTML = '<div class="small text-muted">無符合活動</div>';
        pag.innerHTML = '';
        return;
      }
      wrap.innerHTML = pageData.map(a=>{
        const max = Number(a.maxParticipants)||0;
        const cur = Number(a.currentCount)||0;
        const full = max>0 && cur>=max;
        const canReg = (a.status==='開放報名' || a.status==='報名中') && !full;
        return `
          <div class="activity-card">
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-bold">${escapeHtml(a.name||'未命名')}</div>
              <span class="status-pill ${full?'status-full': canReg?'status-open':'status-closed'}">${full?'額滿':escapeHtml(a.status||'')}</span>
            </div>
            <div class="small text-muted">日期：${fmtDate(a.date)}　地點：${escapeHtml(a.location||'待定')}</div>
            <div class="small mt-1">人數：${cur}/${max||'∞'}</div>
            <div class="mt-2">${canReg? `<button class="btn btn-sm btn-primary" data-act="${a.activityId}"><i class="bi bi-check2-circle me-1"></i>報名</button>`:''}</div>
          </div>
        `;
      }).join('');

      let pagHtml='';
      for(let i=1;i<=pages;i++){
        pagHtml += `<button class="${i===currentActPage?'active':''}" data-page="${i}">${i}</button>`;
      }
      pag.innerHTML = pagHtml;

      wrap.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.addEventListener('click',()=> registerActivity(btn.getAttribute('data-act')));
      });
      pag.querySelectorAll('button[data-page]').forEach(b=>{
        b.addEventListener('click',()=>{
          currentActPage = Number(b.getAttribute('data-page'));
          renderActivitiesPage();
        });
      });
    }

    async function registerActivity(activityId){
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      if(!lineId) return notify('尚未登入','warn');
      try {
        await callAPI(ACTION_MAP.registerActivity,{
          lineId,
          activityId
        });
        notify('活動報名成功','success');
        loadActivities();
      } catch(e){
        notify('報名失敗：'+e.message,'error');
      }
    }

    async function loadMyRegistrations(){
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      if(!lineId){ $('#myRegistrations').innerHTML=''; return; }
      try {
        const res = await callAPI(ACTION_MAP.getMyRegistrations,{ lineId },{silent:true});
        const regs = res.data || res;
        const container = $('#myRegistrations');
        if(!regs.length){
          container.innerHTML = '<div class="small text-muted">尚未報名任何活動</div>';
          return;
        }
        container.innerHTML = `
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light"><tr><th>活動</th><th>日期</th><th>狀態</th><th></th></tr></thead>
              <tbody>
                ${regs.map(r=>{
                  const cancel = r.status==='已報名' ? `<button class="btn btn-sm btn-outline-danger" data-reg="${r.registrationId}"><i class="bi bi-x-circle"></i></button>`:'';
                  return `<tr>
                    <td>${escapeHtml(r.activityName||'')}</td>
                    <td>${fmtDate(r.activityDate)}</td>
                    <td>${escapeHtml(r.status||'')}</td>
                    <td>${cancel}</td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
        container.querySelectorAll('button[data-reg]').forEach(b=>{
          b.addEventListener('click',()=>{
            if(confirm('確定取消？')) cancelRegistration(b.getAttribute('data-reg'));
          });
        });
        loadActivitiesForFeedback(regs);
      } catch(e){
        $('#myRegistrations').innerHTML = '<div class="text-danger small">讀取失敗</div>';
      }
    }

    async function cancelRegistration(regId){
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        await callAPI(ACTION_MAP.cancelActivity,{ lineId, registrationId: regId });
        notify('已取消報名','success');
        loadActivities();
      } catch(e){
        notify('取消失敗：'+e.message,'error');
      }
    }

    /*********************************************************
     * 志工
     *********************************************************/
    async function loadVolunteer(){
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        const [needsRes, recordsRes] = await Promise.allSettled([
          callAPI(ACTION_MAP.getVolunteerNeeds,{}, {silent:true}),
          callAPI(ACTION_MAP.getMyVolunteerRecords,{ lineId }, {silent:true})
        ]);
        const needs = needsRes.value?.data || needsRes.value || [];
        $('#volNeedsList').innerHTML = needs.length ? needs.map(n=>`
          <div class="activity-card">
            <div class="d-flex justify-content-between">
              <strong>${escapeHtml(n.name||n.activityName||'志工需求')}</strong>
              <span class="badge bg-primary">${fmtDate(n.date)}</span>
            </div>
            <div class="small text-muted">${escapeHtml(n.description||'')}</div>
            <div class="mt-2">
              <button class="btn btn-sm btn-outline-primary" data-vol="${n.activityId}"><i class="bi bi-person-plus"></i> 報名志工</button>
            </div>
          </div>
        `).join('') : '<div class="small text-muted">目前無志工需求</div>';
        $('#volNeedsList').querySelectorAll('button[data-vol]').forEach(b=>{
          b.addEventListener('click',()=> registerVolunteer(b.getAttribute('data-vol')));
        });
        const records = recordsRes.value?.data || recordsRes.value || [];
        $('#volRecordsList').innerHTML = records.length
          ? `<div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead class="table-light">
                  <tr><th>活動</th><th>時數</th><th>狀態</th><th>日期</th></tr>
                </thead>
                <tbody>
                  ${records.map(r=>`
                    <tr>
                      <td>${escapeHtml(r.activityName||'')}</td>
                      <td>${r.hours||0}</td>
                      <td>${escapeHtml(r.status||'')}</td>
                      <td>${fmtDate(r.serviceDate)}</td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </div>`
          : '<div class="small text-muted">尚無志工紀錄</div>';
      } catch(e){
        notify('載入志工資料失敗','error');
      }
    }

    async function registerVolunteer(activityId){
      const hours = prompt('請輸入預估服務時數');
      if(!hours) return;
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        await callAPI(ACTION_MAP.registerVolunteer,{
          lineId,
          activityId,
          hours: parseFloat(hours)
        });
        notify('志工登記成功（待審核）','success');
        loadVolunteer();
      } catch(e){
        notify('登記失敗：'+e.message,'error');
      }
    }

    /*********************************************************
     * 個人財務
     *********************************************************/
    async function loadMemberFinance(){
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        const [donRes, expRes] = await Promise.allSettled([
          callAPI(ACTION_MAP.getDonations,{ lineId },{silent:true}),
          callAPI(ACTION_MAP.getMyExpenses,{ lineId },{silent:true})
        ]);
        const dons = donRes.value?.data || donRes.value || [];
        const exps = expRes.value?.data || expRes.value || [];
        let totalAmount = 0;
        dons.forEach(d=> totalAmount += Number(d.amount||0));
        $('#finDonCountMember').textContent = dons.length;
        $('#finDonAmountMember').textContent = numberFmt(totalAmount);

        $('#memberDonationList').innerHTML = dons.length
          ? `<div class="table-responsive"><table class="table table-sm table-hover align-middle">
              <thead class="table-light"><tr><th>日期</th><th>金額</th><th>方式</th></tr></thead>
              <tbody>
                ${dons.map(d=> `<tr>
                  <td>${fmtDate(d.donationDate)}</td>
                  <td>${numberFmt(d.amount)}</td>
                  <td>${escapeHtml(d.method||'')}</td>
                </tr>`).join('')}
              </tbody>
            </table></div>`
          : '<div class="small text-muted">無捐款紀錄</div>';

        $('#memberExpenseList').innerHTML = exps.length
          ? `<div class="table-responsive"><table class="table table-sm table-hover align-middle">
              <thead class="table-light"><tr><th>日期</th><th>項目</th><th>金額</th><th>狀態</th></tr></thead>
              <tbody>
                ${exps.map(e=> `<tr>
                  <td>${fmtDate(e.expenseDate)}</td>
                  <td>${escapeHtml(e.item||'')}</td>
                  <td>${numberFmt(e.amount)}</td>
                  <td>${escapeHtml(e.status||'')}</td>
                </tr>`).join('')}
              </tbody>
            </table></div>`
          : '<div class="small text-muted">無支出申請</div>';

        if(isAdmin){
          $('#memberFinAdminDivider').classList.remove('d-none');
          $('#financeOverviewAdmin').classList.remove('d-none');
          try {
            const ovRes = await callAPI(ACTION_MAP.getFinanceOverview,{ operatorLineId: lineId },{silent:true});
            const ov = ovRes.data || ovRes;
            $('#ovIncome').textContent = numberFmt(ov.totalIncome||0);
            $('#ovExpense').textContent = numberFmt(ov.totalExpense||0);
            $('#ovBalance').textContent = numberFmt(ov.balance||0);
            $('#ovDonationCount').textContent = numberFmt(ov.donationCount||0);
          } catch(e){
            notify('無法載入財務總覽','warn');
          }
        } else {
          $('#memberFinAdminDivider').classList.add('d-none');
          $('#financeOverviewAdmin').classList.add('d-none');
        }
      } catch(e){
        notify('載入財務資料失敗','error');
      }
    }

    $('#formDonation').addEventListener('submit', async e=>{
      e.preventDefault();
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        await callAPI(ACTION_MAP.addDonation,{
          lineId,
          amount: parseInt($('#donAmount').value),
          method: $('#donMethod').value,
          donationDate: $('#donDate').value,
          note: $('#donNote').value
        });
        notify('捐款已記錄','success');
        bootstrap.Modal.getInstance($('#modalDonation')).hide();
        $('#formDonation').reset();
        if(currentSection==='member-finance') loadMemberFinance();
      } catch(err){
        notify(err.message,'error');
      }
    });

    $('#formMemberExpense').addEventListener('submit', async e=>{
      e.preventDefault();
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        await callAPI(ACTION_MAP.submitExpense,{
          lineId,
          item: $('#memExpItem').value,
          amount: parseInt($('#memExpAmount').value),
          category: $('#memExpCategory').value,
          description: $('#memExpDesc').value,
          expenseDate: $('#memExpDate').value
        });
        notify('支出申請已送出','success');
        bootstrap.Modal.getInstance($('#modalExpense')).hide();
        $('#formMemberExpense').reset();
        if(currentSection==='member-finance') loadMemberFinance();
      } catch(err){
        notify(err.message,'error');
      }
    });

    /*********************************************************
     * 回饋
     *********************************************************/
    function loadActivitiesForFeedback(regs){
      const sel = $('#fbActivitySelect');
      sel.innerHTML = '<option value="">選擇活動</option>';
      regs.forEach(r=>{
        const opt = document.createElement('option');
        opt.value = r.activityId;
        opt.textContent = r.activityName || '活動';
        sel.appendChild(opt);
      });
    }

    async function loadFeedbackModule(){
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        const regsRes = await callAPI(ACTION_MAP.getMyRegistrations,{ lineId },{silent:true});
        loadActivitiesForFeedback(regsRes.data || regsRes || []);
      } catch(e){
        console.warn('回饋活動載入失敗');
      }
      try {
        const fbRes = await callAPI(ACTION_MAP.getMyFeedback,{ lineId },{silent:true});
        const arr = fbRes.data || fbRes || [];
        $('#myFeedbackList').innerHTML = arr.length
          ? arr.map(f=>`
            <div class="activity-card">
              <div class="d-flex justify-content-between">
                <strong>${escapeHtml(f.activityName||'')}</strong>
                <span class="badge bg-warning text-dark">${f.rating||''}★</span>
              </div>
              <div class="small text-muted">${fmtDate(f.createDate)}</div>
              <div class="mt-1 small">${escapeHtml(f.comment||'')}</div>
            </div>`).join('')
          : '<div class="small text-muted">尚無回饋</div>';
      } catch(e){
        $('#myFeedbackList').innerHTML = '<div class="small text-muted">尚未實作回饋 API</div>';
      }
    }

    $('#btnSubmitFeedback').addEventListener('click', async ()=>{
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      const actId = $('#fbActivitySelect').value;
      const rating = $('#fbRating').value;
      const comment = $('#fbComment').value.trim();
      if(!actId || !rating) return notify('請選擇活動與評分','warn');
      try {
        await callAPI(ACTION_MAP.submitFeedback,{ lineId, activityId: actId, rating, comment });
        notify('回饋已送出','success');
        $('#fbRating').value='';
        $('#fbComment').value='';
        loadFeedbackModule();
      } catch(e){
        notify('回饋提交失敗：'+e.message,'error');
      }
    });

    /*********************************************************
     * 後台儀表板
     *********************************************************/
    async function loadAdminDashboard(){
      const statsWrap = $('#adminDashStats');
      statsWrap.innerHTML = `
        <div class="skeleton" style="height:110px;"></div>
        <div class="skeleton" style="height:110px;"></div>
        <div class="skeleton" style="height:110px;"></div>
        <div class="skeleton" style="height:110px;"></div>
        <div class="skeleton" style="height:110px;"></div>
        <div class="skeleton" style="height:110px;"></div>`;
      try {
        const res = await callAPI(ACTION_MAP.getDashboardData,{}, {silent:true});
        const d = res.data || res;
        const statTpl = (label,val,icon,grad) => `
          <div class="stat" style="border:0;background:linear-gradient(135deg,${grad});color:#fff;">
            <div class="label" style="color:rgba(255,255,255,.85)">${label}</div>
            <div class="value" style="font-size:1.7rem;">${escapeHtml(String(val||0))}</div>
            <div style="position:absolute;right:8px;top:8px;font-size:1.3rem;opacity:.25;"><i class="${icon}"></i></div>
          </div>`;
        statsWrap.innerHTML = `
          ${statTpl('總會員數', d.總會員數 ,'bi bi-people-fill','#28a745,#20c997')}
          ${statTpl('本月捐款', d.本月捐款總額 ,'bi bi-heart-fill','#dc3545,#b91c1c')}
          ${statTpl('捐款次數', d.本月捐款次數 ,'bi bi-cash-coin','#f59e0b,#d97706')}
          ${statTpl('進行中活動', d.進行中活動 ,'bi bi-calendar-event','#6366f1,#4338ca')}
          ${statTpl('待審提案', d.待審提案 ,'bi bi-file-text','#0ea5e9,#0369a1')}
          ${statTpl('待審憑證', d.待審憑證 ,'bi bi-receipt','#ec4899,#be185d')}
        `;
        $('#systemAlerts').innerHTML = `
          <li class="list-group-item small">最後更新：${fmtDateTime(new Date())}</li>
          <li class="list-group-item small">本月收據：${d.本月收據數 || 0}</li>
          <li class="list-group-item small text-muted">若某數字顯示 0，請確認後端欄位是否返回。</li>
        `;
      } catch(e){
        statsWrap.innerHTML = '<div class="col-12 text-danger small">載入失敗</div>';
      }
    }

    /*********************************************************
     * 財務交易 / 收據
     *********************************************************/
    $('#txType').addEventListener('change', e=>{
      const val = e.target.value;
      const cat = $('#txCategory');
      if(val==='收入'){
        cat.innerHTML = `
          <option value="">選擇</option>
          <option value="會費">會費</option>
          <option value="捐款">捐款</option>
          <option value="活動收入">活動收入</option>
          <option value="政府補助">政府補助</option>
          <option value="其他收入">其他收入</option>`;
        $('#txReceiptBlock').classList.remove('hidden');
      } else if(val==='支出'){
        cat.innerHTML = `
          <option value="">選擇</option>
          <option value="活動費用">活動費用</option>
          <option value="辦公費用">辦公費用</option>
          <option value="交通費">交通費</option>
          <option value="餐費">餐費</option>
          <option value="場地費">場地費</option>
          <option value="其他支出">其他支出</option>`;
        $('#txReceiptBlock').classList.add('hidden');
      } else {
        cat.innerHTML = `<option value="">選擇</option>`;
        $('#txReceiptBlock').classList.add('hidden');
      }
    });

    // 開立收據需求切換
    $('#txNeedReceipt').addEventListener('change', e=>{
      if(e.target.checked){
        $('#txReceiptDetails').classList.remove('hidden');
      } else {
        $('#txReceiptDetails').classList.add('hidden');
      }
    });

    /*********************************************************
     * 交易表單送出
     *********************************************************/
    $('#formTransaction').addEventListener('submit', async e=>{
      e.preventDefault();
      const type = $('#txType').value;
      if(!type) return notify('請選擇交易類型','warn');
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      const payload = {
        lineId,
        txDate: $('#txDate').value,
        txType: type,
        category: $('#txCategory').value,
        amount: parseInt($('#txAmount').value,10)||0,
        account: $('#txAccount').value,
        target: $('#txTarget').value.trim(),
        description: $('#txDesc').value.trim()
      };

      // 收入且有勾選開立收據
      if(type==='收入' && $('#txNeedReceipt').checked){
        payload.needReceipt = true;
        payload.receipt = {
          title: $('#rcName').value.trim(),
            email: $('#rcEmail').value.trim(),
            phone: $('#rcPhone').value.trim(),
            taxId: $('#rcTaxId').value.trim(),
            address: $('#rcAddress').value.trim(),
            sendNow: $('#rcSendNow').checked
        };
        // 基本欄位簡易驗證
        if(!payload.receipt.title){
          return notify('收據抬頭不可空白','warn');
        }
      }

      try {
        await callAPI(ACTION_MAP.addTransactionWithReceipt, payload);
        notify('交易已新增','success');
        $('#formTransaction').reset();
        $('#txCategory').innerHTML = '<option value="">請先選擇類型</option>';
        $('#txReceiptDetails').classList.add('hidden');
        loadTransactions();
      } catch(err){
        notify('新增失敗：'+err.message,'error');
      }
    });

    $('#btnShowTransactionForm').addEventListener('click',()=>{
      $('#transactionFormWrap').classList.remove('hidden');
    });
    $('#btnHideTransactionForm').addEventListener('click',()=>{
      $('#transactionFormWrap').classList.add('hidden');
    });

    async function loadTransactions(){
      try {
        const res = await callAPI(ACTION_MAP.getTransactionList, {}, {silent:true});
        const list = res.data || res || [];
        const tbody = $('#txList');
        if(!list.length){
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">無資料</td></tr>';
          return;
        }
        tbody.innerHTML = list.map(t=>{
          const receiptBtn = t.receiptId
            ? `<button class="btn btn-sm btn-outline-info" data-view-receipt="${t.transactionId}"><i class="bi bi-file-earmark-text"></i></button>`
            : (t.txType==='收入'
               ? `<button class="btn btn-sm btn-outline-success" data-gen-receipt="${t.transactionId}"><i class="bi bi-receipt-cutoff"></i></button>`
               : '');
          return `<tr>
            <td>${fmtDate(t.txDate)}</td>
            <td>${escapeHtml(t.txType||'')}</td>
            <td>${escapeHtml(t.category||'')}</td>
            <td class="${t.txType==='支出'?'text-danger':'text-success'}">${numberFmt(t.amount)}</td>
            <td>${escapeHtml(t.target||'')}</td>
            <td>${t.receiptId? `<span class="badge bg-primary">${escapeHtml(t.receiptId)}</span>`:''}</td>
            <td class="text-nowrap d-flex gap-1">
              ${receiptBtn}
              <button class="btn btn-sm btn-outline-danger" data-del-tx="${t.transactionId}"><i class="bi bi-trash"></i></button>
            </td>
          </tr>`;
        }).join('');
        tbody.querySelectorAll('[data-del-tx]').forEach(b=>{
          b.addEventListener('click',()=>{
            if(confirm('確定刪除此交易？')) deleteTransaction(b.getAttribute('data-del-tx'));
          });
        });
        tbody.querySelectorAll('[data-gen-receipt]').forEach(b=>{
          b.addEventListener('click',()=> generateReceiptForTx(b.getAttribute('data-gen-receipt')));
        });
        tbody.querySelectorAll('[data-view-receipt]').forEach(b=>{
          b.addEventListener('click',()=> viewReceiptModal(b.getAttribute('data-view-receipt')));
        });
      } catch(e){
        $('#txList').innerHTML = '<tr><td colspan="7" class="text-center text-danger">載入失敗</td></tr>';
      }
    }

    async function deleteTransaction(transactionId){
      try {
        await callAPI(ACTION_MAP.deleteTransaction,{ transactionId });
        notify('已刪除','success');
        loadTransactions();
      } catch(e){
        notify('刪除失敗：'+e.message,'error');
      }
    }

    async function generateReceiptForTx(transactionId){
      try {
        await callAPI(ACTION_MAP.createReceiptForTransaction,{ transactionId });
        notify('收據已建立','success');
        loadTransactions();
      } catch(e){
        notify('建立收據失敗：'+e.message,'error');
      }
    }

    function viewReceiptModal(transactionId){
      // 簡易：直接重新整理收據列表，或可呼叫單筆 API（此處略）
      notify('可在收據管理中下載或寄送此收據','info');
    }

    /*********************************************************
     * 收據管理
     *********************************************************/
    $('#btnOpenReceiptTemplate').addEventListener('click', ()=>{
      const m = new bootstrap.Modal($('#modalReceiptTemplate'));
      loadReceiptTemplate();
      m.show();
    });

    async function loadReceiptTemplate(){
      try {
        const res = await callAPI(ACTION_MAP.getReceiptTemplate, {}, {silent:true});
        const tpl = res.data || res || {};
        $('#tplDocId').value = tpl.docId || '';
        $('#tplPrefix').value = tpl.prefix || 'RCP';
        $('#tplOrgName').value = tpl.orgName || '';
        $('#tplOrgPhone').value = tpl.orgPhone || '';
        $('#tplOrgAddress').value = tpl.orgAddress || '';
      } catch(e){
        notify('讀取模板失敗','warn');
      }
    }

    $('#btnSaveReceiptTemplate').addEventListener('click', async ()=>{
      try {
        await callAPI(ACTION_MAP.saveReceiptTemplate,{
          docId: $('#tplDocId').value.trim(),
          prefix: $('#tplPrefix').value.trim(),
          orgName: $('#tplOrgName').value.trim(),
          orgPhone: $('#tplOrgPhone').value.trim(),
          orgAddress: $('#tplOrgAddress').value.trim()
        });
        notify('模板已儲存','success');
        bootstrap.Modal.getInstance($('#modalReceiptTemplate')).hide();
      } catch(e){
        notify('儲存失敗：'+e.message,'error');
      }
    });

    $('#btnManualReceipt').addEventListener('click',()=>{
      $('#manualReceiptForm').classList.remove('hidden');
    });
    $('#btnCloseManualReceipt').addEventListener('click',()=>{
      $('#manualReceiptForm').classList.add('hidden');
    });

    $('#formManualReceipt').addEventListener('submit', async e=>{
      e.preventDefault();
      try {
        await callAPI(ACTION_MAP.createManualReceipt,{
          date: $('#mrDate').value,
          amount: parseInt($('#mrAmount').value,10)||0,
          category: $('#mrCategory').value,
          title: $('#mrTitle').value.trim(),
          email: $('#mrEmail').value.trim(),
          phone: $('#mrPhone').value.trim(),
          taxId: $('#mrTaxId').value.trim(),
          address: $('#mrAddress').value.trim(),
          sendNow: $('#mrSendNow').checked
        });
        notify('手動收據已建立','success');
        $('#formManualReceipt').reset();
        loadReceipts();
      } catch(e){
        notify('建立失敗：'+e.message,'error');
      }
    });

    async function loadReceipts(){
      try {
        const res = await callAPI(ACTION_MAP.getReceiptList, {}, {silent:true});
        const arr = res.data || res || [];
        const wrap = $('#receiptList');
        if(!arr.length){
          wrap.innerHTML = '<div class="text-muted small py-3">無收據資料</div>';
          return;
        }
        wrap.innerHTML = `<div class="table-responsive" style="max-height:430px;">
          <table class="table table-sm table-hover align-middle">
            <thead class="table-light">
              <tr><th>收據號</th><th>日期</th><th>金額</th><th>抬頭</th><th>Email</th><th>狀態</th><th></th></tr>
            </thead>
            <tbody>
              ${arr.map(r=>`
                <tr>
                  <td>${escapeHtml(r.receiptNo||'')}</td>
                  <td>${fmtDate(r.date)}</td>
                  <td>${numberFmt(r.amount)}</td>
                  <td>${escapeHtml(r.title||'')}</td>
                  <td>${escapeHtml(r.email||'')}</td>
                  <td>${escapeHtml(r.status||'')}</td>
                  <td class="text-nowrap d-flex gap-1">
                    <button class="btn btn-sm btn-outline-secondary" data-send-receipt="${r.receiptId}"><i class="bi bi-envelope"></i></button>
                    <button class="btn btn-sm btn-outline-primary" data-regenerate-receipt="${r.receiptId}"><i class="bi bi-arrow-repeat"></i></button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>`;
        wrap.querySelectorAll('[data-send-receipt]').forEach(b=>{
          b.addEventListener('click',()=> sendReceipt(b.getAttribute('data-send-receipt')));
        });
        wrap.querySelectorAll('[data-regenerate-receipt]').forEach(b=>{
          b.addEventListener('click',()=> regenerateReceipt(b.getAttribute('data-regenerate-receipt')));
        });
      } catch(e){
        $('#receiptList').innerHTML = '<div class="text-danger small">載入失敗</div>';
      }
    }

    async function sendReceipt(receiptId){
      try {
        await callAPI(ACTION_MAP.sendReceipt,{ receiptId });
        notify('收據已寄送','success');
      } catch(e){
        notify('寄送失敗：'+e.message,'error');
      }
    }

    async function regenerateReceipt(receiptId){
      try {
        await callAPI(ACTION_MAP.regenerateReceiptPDF,{ receiptId });
        notify('PDF 已重新產生','success');
      } catch(e){
        notify('重新產生失敗：'+e.message,'error');
      }
    }

    /*********************************************************
     * 會員管理
     *********************************************************/
    async function loadMemberList(){
      try {
        const kw = $('#memberSearch').value.trim();
        const type = $('#memberTypeFilter').value;
        const res = await callAPI(ACTION_MAP.getMemberList,{
          keyword: kw,
          memberType: type
        }, {silent:true});
        const arr = res.data || res || [];
        const tbody = $('#memberList');
        if(!arr.length){
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">無符合資料</td></tr>';
          return;
        }
        tbody.innerHTML = arr.map(m=>`
          <tr>
            <td>${escapeHtml(m.realName||m.lineName||'')}</td>
            <td>${escapeHtml(m.phone||'')}</td>
            <td>${escapeHtml(m.memberType||'')}</td>
            <td>${fmtDate(m.registerDate)}</td>
            <td>${fmtDate(m.lastDonationDate)}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" data-view-member="${m.lineId}"><i class="bi bi-eye"></i></button>
            </td>
          </tr>
        `).join('');
        tbody.querySelectorAll('[data-view-member]').forEach(b=>{
          b.addEventListener('click', ()=> openMemberDetail(b.getAttribute('data-view-member')));
        });
      } catch(e){
        $('#memberList').innerHTML = '<tr><td colspan="6" class="text-danger text-center">載入失敗</td></tr>';
      }
    }

    async function openMemberDetail(lineId){
      try {
        const res = await callAPI(ACTION_MAP.getMemberDetail,{ lineId },{silent:true});
        const d = res.data || res || {};
        const html = `
          <div class="modal fade" id="modalMemberDetail" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="bi bi-person-badge me-1"></i>${escapeHtml(d.realName||d.lineName||'會員')}</h5>
                  <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <div class="border rounded p-2 small">
                        <strong>基本資料</strong><br>
                        LINE ID：${escapeHtml(d.lineId||'')}<br>
                        類別：${escapeHtml(d.memberType||'')}<br>
                        電話：${escapeHtml(d.phone||'')}<br>
                        Email：${escapeHtml(d.email||'')}<br>
                        地址：${escapeHtml(d.address||'')}<br>
                      </div>
                    </div>
                    <div class="col-md-8">
                      <div class="border rounded p-2 small mb-2">
                        <strong>統計</strong><br>
                        活動次數：${d.activityCount||0}　志工時數：${d.volunteerHours||0}　捐款次數：${d.donationCount||0}
                      </div>
                      <div class="border rounded p-2 small">
                        <strong>狀態調整</strong><br>
                        <div class="d-flex gap-2 align-items-center mt-1">
                          <select id="mdStatus" class="form-select form-select-sm" style="max-width:160px;">
                            <option value="">選擇狀態</option>
                            <option value="active">active</option>
                            <option value="inactive">inactive</option>
                            <option value="blacklist">blacklist</option>
                          </select>
                          <button class="btn btn-sm btn-primary" id="btnSaveMemberStatus"><i class="bi bi-save me-1"></i>儲存</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
                </div>
              </div>
            </div>
          </div>`;
        $('#dynamicModal').innerHTML = html;
        const modalEl = document.getElementById('modalMemberDetail');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        document.getElementById('btnSaveMemberStatus').addEventListener('click', async ()=>{
          const newStatus = document.getElementById('mdStatus').value;
          if(!newStatus) return notify('請選擇狀態','warn');
          try {
            await callAPI(ACTION_MAP.updateMemberStatus,{ lineId, status: newStatus });
            notify('會員狀態已更新','success');
            modal.hide();
            loadMemberList();
          } catch(e){
            notify('更新失敗：'+e.message,'error');
          }
        });
      } catch(e){
        notify('讀取會員詳細失敗：'+e.message,'error');
      }
    }

    $('#btnSearchMembers').addEventListener('click', loadMemberList);
    $('#btnExportMembers').addEventListener('click', ()=> exportData('會員資料'));

    /*********************************************************
     * 活動管理（後台）
     *********************************************************/
    $('#btnShowActForm').addEventListener('click',()=>{
      $('#adminActFormWrap').classList.remove('hidden');
    });
    $('#btnCloseActForm').addEventListener('click',()=>{
      $('#adminActFormWrap').classList.add('hidden');
    });

    $('#formAdminActivity').addEventListener('submit', async e=>{
      e.preventDefault();
      try {
        await callAPI(ACTION_MAP.addActivity,{
          name: $('#admActName').value.trim(),
          type: $('#admActType').value,
          maxParticipants: parseInt($('#admActMax').value,10)||0,
          date: $('#admActDate').value,
          time: $('#admActTime').value,
          location: $('#admActLocation').value.trim(),
          description: $('#admActDesc').value.trim()
        });
        notify('活動已建立','success');
        $('#formAdminActivity').reset();
        loadAdminActivities();
      } catch(e){
        notify('建立活動失敗：'+e.message,'error');
      }
    });

    async function loadAdminActivities(){
      try {
        const res = await callAPI(ACTION_MAP.getActivityList, {}, {silent:true});
        const arr = res.data || res || [];
        const wrap = $('#adminActList');
        if(!arr.length){
          wrap.innerHTML = '<div class="col-12 text-muted small py-3">尚無活動</div>';
          return;
        }
        wrap.innerHTML = arr.map(a=>`
          <div class="col-md-4">
            <div class="activity-card">
              <div class="d-flex justify-content-between">
                <strong>${escapeHtml(a.name||'未命名')}</strong>
                <span class="badge ${a.status==='開放報名'?'bg-success':'bg-secondary'}">${escapeHtml(a.status||'')}</span>
              </div>
              <div class="small text-muted">
                日期：${fmtDate(a.date)}<br>
                類型：${escapeHtml(a.type||'')}<br>
                人數：${a.currentCount||0}/${a.maxParticipants||'∞'}
              </div>
              <div class="mt-2 d-flex gap-1">
                <button class="btn btn-sm btn-outline-primary" data-exp-act="${a.activityId}"><i class="bi bi-download"></i></button>
              </div>
            </div>
          </div>
        `).join('');
        wrap.querySelectorAll('[data-exp-act]').forEach(b=>{
          b.addEventListener('click',()=> exportActivityMembers(b.getAttribute('data-exp-act')));
        });
      } catch(e){
        $('#adminActList').innerHTML = '<div class="col-12 text-danger small">載入失敗</div>';
      }
    }

    async function exportActivityMembers(activityId){
      try {
        const res = await callAPI(ACTION_MAP.exportActivityMembers,{ activityId });
        if(res && res.url){
          window.open(res.url,'_blank');
          notify('匯出已開始','success');
        } else {
          notify('已匯出（請檢查後端生成位置）','info');
        }
      } catch(e){
        notify('匯出失敗：'+e.message,'error');
      }
    }

    /*********************************************************
     * 提案
     *********************************************************/
    $('#btnShowProposalForm').addEventListener('click',()=>{
      $('#proposalFormWrap').classList.remove('hidden');
    });
    $('#btnCloseProposalForm').addEventListener('click',()=>{
      $('#proposalFormWrap').classList.add('hidden');
    });

    $('#formProposal').addEventListener('submit', async e=>{
      e.preventDefault();
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        await callAPI(ACTION_MAP.addProposal,{
          lineId,
          title: $('#propTitle').value.trim(),
          type: $('#propType').value,
          budget: $('#propBudget').value,
          deadline: $('#propDeadline').value,
          content: $('#propContent').value.trim()
        });
        notify('提案已提交','success');
        $('#formProposal').reset();
        loadProposals();
      } catch(e){
        notify('提交失敗：'+e.message,'error');
      }
    });

    async function loadProposals(){
      try {
        const res = await callAPI(ACTION_MAP.getProposalList, {}, {silent:true});
        const arr = res.data || res || [];
        const wrap = $('#proposalList');
        if(!arr.length){
          wrap.innerHTML = '<div class="text-muted small py-3">無提案</div>';
          return;
        }
        wrap.innerHTML = arr.map(p=>`
          <div class="activity-card">
            <div class="d-flex justify-content-between">
              <strong>${escapeHtml(p.title||'')}</strong>
              <span class="badge bg-${p.status==='審核中'?'warning text-dark':'secondary'}">${escapeHtml(p.status||'')}</span>
            </div>
            <div class="small text-muted">
              類型：${escapeHtml(p.type||'')}　
              預算：${numberFmt(p.budget||0)}　
              建立：${fmtDate(p.createDate)}
            </div>
            <div class="mt-1 small">${escapeHtml(p.content||'')}</div>
            <div class="mt-2 d-flex gap-2">
              <button class="btn btn-sm btn-outline-success" data-vote="yes" data-prop="${p.proposalId}">贊成 (${p.yes||0})</button>
              <button class="btn btn-sm btn-outline-danger" data-vote="no" data-prop="${p.proposalId}">反對 (${p.no||0})</button>
              <button class="btn btn-sm btn-outline-secondary" data-vote="abstain" data-prop="${p.proposalId}">棄權 (${p.abstain||0})</button>
            </div>
          </div>
        `).join('');
        wrap.querySelectorAll('[data-vote]').forEach(btn=>{
          btn.addEventListener('click',()=> voteProposal(btn.getAttribute('data-prop'), btn.getAttribute('data-vote')));
        });
      } catch(e){
        $('#proposalList').innerHTML = '<div class="text-danger small">載入失敗</div>';
      }
    }

    async function voteProposal(proposalId, vote){
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        await callAPI(ACTION_MAP.voteProposal,{ lineId, proposalId, vote });
        notify('投票成功','success');
        loadProposals();
      } catch(e){
        notify('投票失敗：'+e.message,'error');
      }
    }

    /*********************************************************
     * 支出審核（後台）
     *********************************************************/
    $('#btnShowExpenseSubmit').addEventListener('click',()=>{
      $('#expenseSubmitWrap').classList.remove('hidden');
    });
    $('#btnCloseExpenseSubmit').addEventListener('click',()=>{
      $('#expenseSubmitWrap').classList.add('hidden');
    });

    $('#formExpenseSubmit').addEventListener('submit', async e=>{
      e.preventDefault();
      const f = document.getElementById('exFile');
      const file = f.files[0];
      try {
        // 若後端支援 base64 上傳
        let fileData = '';
        if(file){
          fileData = await fileToBase64(file);
        }
        await callAPI(ACTION_MAP.addExpense,{
          date: $('#exDate').value,
          category: $('#exCategory').value,
          amount: parseInt($('#exAmount').value,10)||0,
          vendor: $('#exVendor').value.trim(),
          description: $('#exDesc').value.trim(),
          fileName: file? file.name : '',
          fileData
        });
        notify('支出憑證已提交','success');
        $('#formExpenseSubmit').reset();
        loadExpenses();
      } catch(e){
        notify('提交失敗：'+e.message,'error');
      }
    });

    async function loadExpenses(){
      try {
        const res = await callAPI(ACTION_MAP.getExpenseList, {}, {silent:true});
        const arr = res.data || res || [];
        const wrap = $('#expenseList');
        if(!arr.length){
          wrap.innerHTML = '<div class="text-muted small py-3">無支出憑證</div>';
          return;
        }
        wrap.innerHTML = arr.map(ex=>`
          <div class="activity-card">
            <div class="d-flex justify-content-between">
              <strong>${escapeHtml(ex.category||'支出')}</strong>
              <span class="badge bg-${ex.status==='待審核'?'warning text-dark': ex.status==='已核准'?'success':'secondary'}">${escapeHtml(ex.status||'')}</span>
            </div>
            <div class="small text-muted">
              日期：${fmtDate(ex.date)}　金額：${numberFmt(ex.amount)}　廠商：${escapeHtml(ex.vendor||'')}
            </div>
            <div class="mt-1 small">${escapeHtml(ex.description||'')}</div>
            <div class="mt-2 d-flex gap-2">
              ${ex.status==='待審核'
                ? `<button class="btn btn-sm btn-outline-success" data-approve-exp="${ex.expenseId}"><i class="bi bi-check2-circle"></i></button>`
                : ''}
            </div>
          </div>
        `).join('');
        wrap.querySelectorAll('[data-approve-exp]').forEach(b=>{
          b.addEventListener('click',()=> approveExpense(b.getAttribute('data-approve-exp')));
        });
      } catch(e){
        $('#expenseList').innerHTML = '<div class="text-danger small">載入失敗</div>';
      }
    }

    async function approveExpense(expenseId){
      try {
        await callAPI(ACTION_MAP.approveExpense,{ expenseId });
        notify('已核准','success');
        loadExpenses();
      } catch(e){
        notify('核准失敗：'+e.message,'error');
      }
    }

    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = ()=> resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /*********************************************************
     * 臨時動議
     *********************************************************/
    $('#btnShowMotionForm').addEventListener('click',()=>{
      $('#motionFormWrap').classList.remove('hidden');
    });
    $('#btnCloseMotionForm').addEventListener('click',()=>{
      $('#motionFormWrap').classList.add('hidden');
    });

    $('#formMotion').addEventListener('submit', async e=>{
      e.preventDefault();
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        await callAPI(ACTION_MAP.addMotion,{
          lineId,
          title: $('#moTitle').value.trim(),
          urgency: $('#moUrgency').value,
          deadline: $('#moDeadline').value,
          content: $('#moContent').value.trim(),
          reason: $('#moReason').value.trim()
        });
        notify('動議已提出','success');
        $('#formMotion').reset();
        loadMotions();
      } catch(e){
        notify('提出失敗：'+e.message,'error');
      }
    });

    async function loadMotions(){
      try {
        const res = await callAPI(ACTION_MAP.getMotionList, {}, {silent:true});
        const arr = res.data || res || [];
        const wrap = $('#motionList');
        if(!arr.length){
          wrap.innerHTML = '<div class="text-muted small py-3">無動議</div>';
          return;
        }
        wrap.innerHTML = arr.map(m=>`
          <div class="activity-card">
            <div class="d-flex justify-content-between">
              <strong>${escapeHtml(m.title||'')}</strong>
              <span class="badge bg-${m.urgency==='緊急'?'danger': m.urgency==='重要'?'warning text-dark':'secondary'}">${escapeHtml(m.urgency||'')}</span>
            </div>
            <div class="small text-muted">
              決議期限：${fmtDate(m.deadline)}　狀態：${escapeHtml(m.status||'')}
            </div>
            <div class="mt-1 small">${escapeHtml(m.content||'')}</div>
            <div class="mt-1 small text-muted">理由：${escapeHtml(m.reason||'')}</div>
            ${m.status==='待處理'
              ? `<div class="mt-2 d-flex gap-2">
                  <button class="btn btn-sm btn-outline-success" data-motion-proc="pass" data-motion="${m.motionId}">通過</button>
                  <button class="btn btn-sm btn-outline-danger" data-motion-proc="reject" data-motion="${m.motionId}">否決</button>
                </div>`
              : ''}
          </div>
        `).join('');
        wrap.querySelectorAll('[data-motion-proc]').forEach(b=>{
          b.addEventListener('click',()=> processMotion(b.getAttribute('data-motion'), b.getAttribute('data-motion-proc')));
        });
      } catch(e){
        $('#motionList').innerHTML = '<div class="text-danger small">載入失敗</div>';
      }
    }

    async function processMotion(motionId, decision){
      try {
        await callAPI(ACTION_MAP.processMotion,{ motionId, decision });
        notify('已處理','success');
        loadMotions();
      } catch(e){
        notify('處理失敗：'+e.message,'error');
      }
    }

    /*********************************************************
     * 系統工具
     *********************************************************/
    $('#btnBackupSystem').addEventListener('click', async ()=>{
      try {
        await callAPI(ACTION_MAP.backupSystem,{});
        notify('系統備份已啟動','success');
      } catch(e){
        notify('備份失敗：'+e.message,'error');
      }
    });

    $('#btnExportDataAll').addEventListener('click', ()=> exportData('全部資料'));
    document.querySelectorAll('.export-btn').forEach(b=>{
      b.addEventListener('click',()=> exportData(b.getAttribute('data-type')));
    });

    async function exportData(dataType){
      try {
        const res = await callAPI(ACTION_MAP.exportData,{ dataType });
        if(res && res.url){
          window.open(res.url,'_blank');
          notify('匯出完成','success');
        } else {
          notify('匯出請求已送出','info');
        }
      } catch(e){
        notify('匯出失敗：'+e.message,'error');
      }
    }

    $('#btnSendSystemNotice').addEventListener('click', async ()=>{
      const msg = prompt('輸入要發送的系統通知內容');
      if(!msg) return;
      try {
        await callAPI(ACTION_MAP.sendSystemNotification,{ message: msg });
        notify('通知已發送','success');
      } catch(e){
        notify('發送失敗：'+e.message,'error');
      }
    });

    /*********************************************************
     * 個人資料儲存
     *********************************************************/
    $('#btnSaveProfile').addEventListener('click', async ()=>{
      if(!currentUser) return;
      const payload = {
        lineId: currentUser.lineId,
        realName: $('#pfRealName').value.trim(),
        memberType: $('#pfMemberType').value,
        phone: $('#pfPhone').value.trim(),
        email: $('#pfEmail').value.trim(),
        birthday: $('#pfBirthday').value,
        address: $('#pfAddress').value.trim()
      };
      if(!payload.realName){
        return notify('真實姓名為必填','warn');
      }
      try {
        await callAPI(ACTION_MAP.updateProfile, payload);
        notify('資料已更新','success');
        loadUserProfile(!!debugLineId);
      } catch(e){
        notify('更新失敗：'+e.message,'error');
      }
    });

    $('#btnReloadProfile').addEventListener('click', ()=>{
      loadUserProfile(!!debugLineId);
    });

    /*********************************************************
     * Portal 切換
     *********************************************************/
    function switchToAdmin(){
      if(!isAdmin){
        return notify('您沒有後台權限','warn');
      }
      $('#memberSections').classList.add('hidden');
      $('#adminSections').classList.remove('hidden');
      $('#memberNav').classList.add('hidden');
      $('#adminNav').classList.remove('hidden');
      showSection('admin-dashboard');
    }

    function switchToMember(){
      $('#memberSections').classList.remove('hidden');
      $('#adminSections').classList.add('hidden');
      $('#memberNav').classList.remove('hidden');
      $('#adminNav').classList.add('hidden');
      showSection('member-dashboard');
    }

    $('#navToAdmin').addEventListener('click', switchToAdmin);
    $('#btnSwitchPortal').addEventListener('click', ()=>{
      if(document.getElementById('adminSections').classList.contains('hidden')){
        switchToAdmin();
      } else {
        switchToMember();
      }
    });
    $('#navBackToMember').addEventListener('click', switchToMember);

    /*********************************************************
     * FABS / 捲動
     *********************************************************/
    function handleFabVisibility(){
      const fabDonation = $('#fabAddDonation');
      const fabActivity = $('#fabAddActivity');
      if(currentSection==='member-finance'){
        fabDonation.classList.remove('hidden');
      } else {
        fabDonation.classList.add('hidden');
      }
      if(isAdmin && currentSection==='admin-activities'){
        fabActivity.classList.remove('hidden');
      } else {
        fabActivity.classList.add('hidden');
      }
    }

    $('#fabAddDonation').addEventListener('click', ()=>{
      new bootstrap.Modal($('#modalDonation')).show();
    });
    $('#fabAddActivity').addEventListener('click', ()=>{
      if(currentSection!=='admin-activities') return;
      $('#adminActFormWrap').classList.remove('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    });
    $('#fabScrollTop').addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));

    /*********************************************************
     * 重新載入按鈕
     *********************************************************/
    $('#btnRefreshMemberDash').addEventListener('click', loadMemberDashboard);
    $('#btnReloadActs').addEventListener('click', loadActivities);
    $('#btnReloadVolunteer').addEventListener('click', loadVolunteer);
    $('#btnReloadFeedback').addEventListener('click', loadFeedbackModule);
    $('#btnRefreshAdminDashboard').addEventListener('click', loadAdminDashboard);

    /*********************************************************
     * 登出
     *********************************************************/
    $('#btnLogout').addEventListener('click', ()=>{
      if(CONFIG.DEBUG_NON_LIFF){
        debugLineId = null;
        currentUser = null;
        notify('已登出（Debug）','success');
        location.reload();
        return;
      }
      if(typeof liff !== 'undefined' && liff.isLoggedIn()){
        liff.logout();
      }
      location.reload();
    });

    /*********************************************************
     * 初始化
     *********************************************************/
    initTheme();
    document.addEventListener('DOMContentLoaded', ()=>{
      initApp();
    });
  </script>
</body>
</html>

       
