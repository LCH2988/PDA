<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å¸•é‡‘æ£®ç—…å‹æœƒæ•´åˆç³»çµ±</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="theme-color" content="#5563c1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <style>
    :root {
      --brand-grad: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --brand-accent: #667eea;
      --radius: 16px;
      --transition: .25s cubic-bezier(.4,0,.2,1);
    }
    [data-theme="dark"] {
      --bs-body-bg: #1f2430;
      --panel-bg: #2b3242;
      --panel-border: #394255;
      --text-color: #e6e9ef;
      --muted: #9aa4b4;
    }
    [data-theme="light"] {
      --bs-body-bg: #f5f7fb;
      --panel-bg: #ffffff;
      --panel-border: #e2e8f0;
      --text-color: #2d3748;
      --muted: #6b7280;
    }
    body {
      background: var(--bs-body-bg);
      color: var(--text-color);
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    .app-shell {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px 12px 60px;
    }
    .panel {
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius);
      padding: 20px 22px;
      margin-bottom: 20px;
      position: relative;
      transition: var(--transition);
    }
    .panel-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .stat-grid { display:grid; gap:14px; grid-template-columns: repeat(auto-fit,minmax(150px,1fr)); }
    .stat { background: var(--panel-bg); border:1px solid var(--panel-border); border-radius:12px; padding:16px 14px; position:relative; overflow:hidden; }
    .stat .label { font-size:.75rem; letter-spacing:.5px; text-transform:uppercase; color: var(--muted); font-weight:600; }
    .stat .value { font-size:1.8rem; font-weight:700; margin-top:4px; line-height:1.1; }
    .nav-main { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:18px; }
    .nav-main .nav-btn {
      border:1px solid var(--panel-border);
      background:var(--panel-bg);
      border-radius:50px;
      padding:8px 18px;
      font-size:.9rem;
      font-weight:500;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      transition:var(--transition);
    }
    .nav-main .nav-btn.active,
    .nav-main .nav-btn:hover {
      background: var(--brand-grad);
      color:#fff;
      border-color: transparent;
      box-shadow:0 4px 12px rgba(102,126,234,.35);
    }
    .divider { height:1px; background:var(--panel-border); margin:20px 0; }
    .table thead th { font-size:.75rem; text-transform:uppercase; letter-spacing:.5px; }
    .activity-card {
      border:1px solid var(--panel-border);
      border-radius:14px;
      padding:14px 16px;
      margin-bottom:12px;
      position:relative;
      background: var(--panel-bg);
      transition:var(--transition);
    }
    .activity-card:hover { transform:translateY(-2px); box-shadow:0 6px 18px rgba(0,0,0,.08); }
    .status-pill {
      font-size:.65rem;
      border-radius:10px;
      padding:4px 8px;
      font-weight:600;
      letter-spacing:.5px;
    }
    .status-open { background:#d1fae5; color:#065f46; }
    .status-full { background:#fee2e2; color:#991b1b; }
    .status-closed { background:#e5e7eb; color:#374151; }
    [data-theme="dark"] .status-open { background:#064e3b; color:#10b981; }
    [data-theme="dark"] .status-full { background:#7f1d1d; color:#fca5a5; }
    [data-theme="dark"] .status-closed { background:#374151; color:#d1d5db; }
    .pagination { display:flex; gap:6px; flex-wrap:wrap; justify-content:center; margin-top:12px; }
    .pagination button {
      border:1px solid var(--panel-border);
      background:var(--panel-bg);
      padding:4px 12px;
      font-size:.8rem;
      border-radius:8px;
      cursor:pointer;
      transition:var(--transition);
    }
    .pagination button.active,
    .pagination button:hover {
      background:var(--brand-grad);
      color:#fff;
      border-color:transparent;
    }
    .notification-container {
      position:fixed;
      top:16px;
      right:16px;
      z-index:2000;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-width:380px;
    }
    .toast-msg {
      background:#fff;
      border-radius:14px;
      padding:14px 16px;
      box-shadow:0 10px 24px -4px rgba(0,0,0,.18);
      display:flex;
      gap:12px;
      animation: slideIn .4s ease;
      border-left:6px solid #667eea;
    }
    [data-theme="dark"] .toast-msg { background:#2b3242; }
    .toast-msg.success { border-left-color:#16a34a; }
    .toast-msg.error { border-left-color:#dc2626; }
    .toast-msg.warn { border-left-color:#d97706; }
    .toast-msg .close {
      background:transparent;
      border:none;
      color:inherit;
      margin-left:auto;
      font-size:1.05rem;
      cursor:pointer;
    }
    @keyframes slideIn {
      from { transform:translateX(40px); opacity:0; }
      to { transform:translateX(0); opacity:1; }
    }
    .skeleton {
      background:linear-gradient(90deg,#e5e7eb 25%,#f3f4f6 37%,#e5e7eb 63%);
      background-size:400% 100%;
      animation: shimmer 1.4s ease infinite;
      border-radius:8px;
      min-height:14px;
    }
    @keyframes shimmer {
      0% { background-position:100% 0; }
      100% { background-position:0 0; }
    }
    .hidden { display:none!important; }
    .tab-section { display:none; }
    .tab-section.active { display:block; animation:fade .35s ease; }
    @keyframes fade {
      from { opacity:0; transform:translateY(8px); }
      to { opacity:1; transform:translateY(0); }
    }
    .floating-action {
      position:fixed;
      bottom:24px;
      right:24px;
      z-index:900;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .floating-action button {
      border-radius:50%;
      width:54px;
      height:54px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--brand-grad);
      color:#fff;
      border:none;
      box-shadow:0 6px 18px rgba(102,126,234,.4);
      font-size:1.3rem;
      transition:var(--transition);
    }
    .floating-action button:hover { transform:scale(1.08); }
    footer { margin-top:50px; text-align:center; font-size:.7rem; color:var(--muted); }
    .theme-toggle { cursor:pointer; padding:6px 10px; border-radius:10px; border:1px solid var(--panel-border); background:var(--panel-bg); display:flex; align-items:center; gap:6px; font-size:.75rem; font-weight:500; }
    @media (max-width: 768px) {
      .nav-main { overflow-x:auto; scrollbar-width:none; }
      .nav-main::-webkit-scrollbar { display:none; }
      .stat .value { font-size:1.5rem; }
    }
    /* å¯é¸ï¼šé LIFF æ¨¡å¼è­¦ç¤ºæ¢ */
    #nonLiffBanner {
      position:fixed; left:0; right:0; top:0;
      background:#d97706; color:#fff;
      padding:6px 12px; font-size:.8rem;
      z-index:3000;
      display:none;
    }
  </style>
</head>
<body data-theme="light">
  <div id="nonLiffBanner">ç›®å‰é LINE LIFF ç’°å¢ƒï¼ˆDebug æ¨¡å¼ï¼‰ï¼Œè«‹å‹¿åœ¨æ­£å¼ç‰ˆä½¿ç”¨å‡ç™»å…¥ã€‚</div>
  <div class="notification-container" id="notify"></div>
  <div class="app-shell">
    <div class="panel flex-between wrap" style="align-items:flex-start; gap:14px;">
      <div>
        <h4 class="mb-1 d-flex align-items-center gap-2">
          <span>ğŸ¥ å¸•é‡‘æ£®ç—…å‹æœƒæ•´åˆç³»çµ±</span>
          <span class="badge bg-primary">Unified</span>
        </h4>
        <div class="text-muted small">
          æœƒå“¡æœå‹™ Â· æ´»å‹• Â· å¿—å·¥ Â· è²¡å‹™/æ”¶æ“š Â· ææ¡ˆ/å‹•è­° Â· å¾Œå°ç®¡ç†
        </div>
        <div id="currentUserLine" class="mt-2 small text-secondary">
          ä½¿ç”¨è€…ç‹€æ…‹è¼‰å…¥ä¸­...
        </div>
      </div>
      <div class="d-flex flex-column align-items-end gap-2">
        <div class="d-flex gap-2">
          <button class="theme-toggle" id="btnTheme">
            <i class="bi bi-moon-stars"></i><span>æ·±è‰²æ¨¡å¼</span>
          </button>
          <button class="btn btn-sm btn-outline-primary" id="btnReloadProfile">
            <i class="bi bi-arrow-clockwise me-1"></i>é‡æ–°è¼‰å…¥è³‡æ–™
          </button>
        </div>
        <div class="d-flex gap-2">
          <button id="btnSwitchPortal" class="btn btn-sm btn-outline-secondary hidden">åˆ‡æ›ï¼šç®¡ç†å¾Œå°</button>
          <button id="btnLogout" class="btn btn-sm btn-outline-danger"><i class="bi bi-box-arrow-right me-1"></i>ç™»å‡º</button>
        </div>
        <div id="debugLoginBox" class="text-end mt-1 hidden">
          <input id="debugLineId" class="form-control form-control-sm mb-1" placeholder="æ¸¬è©¦ lineId (debug)">
          <button class="btn btn-sm btn-warning" id="btnDebugLogin">æ¸¬è©¦ç™»å…¥</button>
        </div>
      </div>
    </div>

    <!-- Member Nav -->
    <div class="nav-main" id="memberNav">
      <button class="nav-btn active" data-section="member-dashboard"><i class="bi bi-speedometer2"></i>å„€è¡¨æ¿</button>
      <button class="nav-btn" data-section="member-profile"><i class="bi bi-person-badge"></i>å€‹äººè³‡æ–™</button>
      <button class="nav-btn" data-section="member-activities"><i class="bi bi-calendar-event"></i>æ´»å‹•</button>
      <button class="nav-btn" data-section="member-volunteer"><i class="bi bi-heart"></i>å¿—å·¥</button>
      <button class="nav-btn" data-section="member-finance"><i class="bi bi-wallet2"></i>è²¡å‹™</button>
      <button class="nav-btn" data-section="member-feedback"><i class="bi bi-chat-dots"></i>å›é¥‹</button>
      <button class="nav-btn hidden" id="navToAdmin"><i class="bi bi-shield-lock"></i>å¾Œå°</button>
    </div>

    <!-- Admin Nav -->
    <div class="nav-main hidden" id="adminNav">
      <button class="nav-btn active" data-section="admin-dashboard"><i class="bi bi-speedometer2"></i>å¾Œå°å„€è¡¨æ¿</button>
      <button class="nav-btn" data-section="admin-finance"><i class="bi bi-cash-coin"></i>è²¡å‹™ç®¡ç†</button>
      <button class="nav-btn" data-section="admin-receipts"><i class="bi bi-receipt-cutoff"></i>æ”¶æ“š</button>
      <button class="nav-btn" data-section="admin-members"><i class="bi bi-people"></i>æœƒå“¡</button>
      <button class="nav-btn" data-section="admin-activities"><i class="bi bi-calendar3"></i>æ´»å‹•ç®¡ç†</button>
      <button class="nav-btn" data-section="admin-proposals"><i class="bi bi-file-text"></i>ææ¡ˆ</button>
      <button class="nav-btn" data-section="admin-expenses"><i class="bi bi-receipt"></i>æ”¯å‡ºå¯©æ ¸</button>
      <button class="nav-btn" data-section="admin-motions"><i class="bi bi-lightning"></i>è‡¨æ™‚å‹•è­°</button>
      <button class="nav-btn" data-section="admin-system"><i class="bi bi-gear-wide-connected"></i>ç³»çµ±å·¥å…·</button>
      <button class="nav-btn" id="navBackToMember"><i class="bi bi-arrow-return-left"></i>è¿”å›æœƒå“¡</button>
    </div>

    <!-- ========== MEMBER SECTIONS ========== -->
    <div id="memberSections">
      <section id="member-dashboard" class="tab-section active">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">æœƒå“¡å„€è¡¨æ¿</h5>
            <div>
              <button class="btn btn-sm btn-outline-primary" id="btnRefreshMemberDash"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
          </div>
          <div class="stat-grid" id="memberStatsSkeleton">
            <div class="skeleton" style="height:90px;"></div>
            <div class="skeleton" style="height:90px;"></div>
            <div class="skeleton" style="height:90px;"></div>
            <div class="skeleton" style="height:90px;"></div>
          </div>
          <div class="stat-grid d-none" id="memberStats">
            <div class="stat">
              <div class="label">é–‹æ”¾æ´»å‹•</div>
              <div class="value" id="stOpenActs">0</div>
            </div>
            <div class="stat">
              <div class="label">æˆ‘çš„å ±å</div>
              <div class="value" id="stMyRegs">0</div>
            </div>
            <div class="stat">
              <div class="label">å¿—å·¥æ™‚æ•¸</div>
              <div class="value" id="stVolHours">0</div>
            </div>
            <div class="stat">
              <div class="label">ææ¬¾æ¬¡æ•¸</div>
              <div class="value" id="stDonCount">0</div>
            </div>
          </div>
          <div class="divider"></div>
          <h6 class="mb-2">æœ€æ–°æ´»å‹•</h6>
          <div id="latestActivities" class="row g-3">
            <div class="col-12 skeleton" style="height:48px;"></div>
          </div>
        </div>
      </section>

      <section id="member-profile" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">å€‹äººè³‡æ–™</h5>
            <button class="btn btn-sm btn-outline-success" id="btnSaveProfile"><i class="bi bi-save me-1"></i>å„²å­˜</button>
          </div>
          <form id="profileForm" class="row g-3">
            <div class="col-md-4">
              <div class="form-floating">
                <input type="text" id="pfLineName" class="form-control" disabled>
                <label>LINE åç¨±</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="text" id="pfRealName" class="form-control" required>
                <label>çœŸå¯¦å§“å *</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <select id="pfMemberType" class="form-select">
                  <option value="ç—…å‹">ç—…å‹</option>
                  <option value="å®¶å±¬">å®¶å±¬</option>
                  <option value="å¿—å·¥">å¿—å·¥</option>
                  <option value="é†«è­·">é†«è­·äººå“¡</option>
                  <option value="ä¸€èˆ¬æœƒå“¡">ä¸€èˆ¬æœƒå“¡</option>
                  <option value="VIPæœƒå“¡">VIPæœƒå“¡</option>
                </select>
                <label>æœƒå“¡é¡åˆ¥</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="tel" id="pfPhone" class="form-control">
                <label>é›»è©±</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="email" id="pfEmail" class="form-control">
                <label>Email</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="date" id="pfBirthday" class="form-control">
                <label>ç”Ÿæ—¥</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea id="pfAddress" class="form-control" style="height:80px;"></textarea>
                <label>åœ°å€</label>
              </div>
            </div>
          </form>
          <div class="divider"></div>
          <h6>çµ±è¨ˆè³‡è¨Š</h6>
          <ul class="list-group small" id="profileStats"></ul>
        </div>
      </section>

      <section id="member-activities" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">æ´»å‹•åˆ—è¡¨ / å ±å</h5>
            <div>
              <button class="btn btn-sm btn-outline-primary" id="btnReloadActs"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
          </div>
          <div class="row g-3 mb-2">
            <div class="col-md-2">
              <select id="actFilterStatus" class="form-select form-select-sm">
                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                <option value="é–‹æ”¾å ±å">é–‹æ”¾å ±å</option>
                <option value="å·²çµæŸ">å·²çµæŸ</option>
              </select>
            </div>
            <div class="col-md-2">
              <input type="date" id="actFilterDate" class="form-control form-control-sm">
            </div>
            <div class="col-md-3">
              <input type="text" id="actFilterSearch" class="form-control form-control-sm" placeholder="æœå°‹æ´»å‹•åç¨±/åœ°é»/æè¿°">
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-sm btn-outline-secondary" id="btnApplyActFilter">ç¯©é¸</button>
            </div>
          </div>
          <div id="activitiesList" class="mb-4"></div>
          <div id="activitiesPagination" class="pagination"></div>
          <div class="divider"></div>
          <h6 class="mb-2">æˆ‘çš„å ±å</h6>
          <div id="myRegistrations"></div>
        </div>
      </section>

      <section id="member-volunteer" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">å¿—å·¥æœå‹™</h5>
            <button class="btn btn-sm btn-outline-primary" id="btnReloadVolunteer"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
          <h6 class="mb-2">å¿—å·¥éœ€æ±‚</h6>
          <div id="volNeedsList" class="mb-3"></div>
          <div class="divider"></div>
          <h6 class="mb-2">æˆ‘çš„å¿—å·¥ç´€éŒ„</h6>
          <div id="volRecordsList"></div>
        </div>
      </section>

      <section id="member-finance" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">è²¡å‹™äº’å‹•ï¼ˆå€‹äººï¼‰</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalDonation">
                <i class="bi bi-cash-coin me-1"></i>æ–°å¢ææ¬¾
              </button>
              <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalExpense">
                <i class="bi bi-receipt me-1"></i>æ”¯å‡ºç”³è«‹
              </button>
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <div class="stat">
                <div class="label">ç¸½ææ¬¾æ¬¡æ•¸</div>
                <div class="value" id="finDonCountMember">0</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat">
                <div class="label">ç¸½ææ¬¾é¡</div>
                <div class="value" id="finDonAmountMember">0</div>
              </div>
            </div>
          </div>
          <h6>ææ¬¾ç´€éŒ„</h6>
          <div id="memberDonationList" class="mb-3"></div>
          <div class="divider"></div>
          <h6>æ”¯å‡ºç”³è«‹ç´€éŒ„</h6>
          <div id="memberExpenseList"></div>
          <div class="divider d-none" id="memberFinAdminDivider"></div>
          <div id="financeOverviewAdmin" class="d-none">
            <h6>ï¼ˆç®¡ç†å“¡ï¼‰çµ„ç¹”è²¡å‹™æ¦‚è¦½</h6>
            <div class="row g-3">
              <div class="col-md-3"><div class="stat"><div class="label">ç¸½æ”¶å…¥</div><div class="value" id="ovIncome">0</div></div></div>
              <div class="col-md-3"><div class="stat"><div class="label">ç¸½æ”¯å‡º</div><div class="value" id="ovExpense">0</div></div></div>
              <div class="col-md-3"><div class="stat"><div class="label">é¤˜é¡</div><div class="value" id="ovBalance">0</div></div></div>
              <div class="col-md-3"><div class="stat"><div class="label">ææ¬¾ç­†æ•¸</div><div class="value" id="ovDonationCount">0</div></div></div>
            </div>
          </div>
        </div>
      </section>

      <section id="member-feedback" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">æ´»å‹•å›é¥‹</h5>
            <button class="btn btn-sm btn-outline-primary" id="btnReloadFeedback"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <div class="form-floating">
                <select id="fbActivitySelect" class="form-select">
                  <option value="">é¸æ“‡æ´»å‹•</option>
                </select>
                <label>å·²åƒèˆ‡æ´»å‹•</label>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-floating">
                <select id="fbRating" class="form-select">
                  <option value="">é¸æ“‡</option>
                  <option value="5">5 - æ¥µå¥½</option>
                  <option value="4">4 - å¾ˆå¥½</option>
                  <option value="3">3 - æ™®é€š</option>
                  <option value="2">2 - å¾…æ”¹å–„</option>
                  <option value="1">1 - ä¸æ»¿æ„</option>
                </select>
                <label>è©•åˆ†</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <textarea id="fbComment" class="form-control" style="height:90px;"></textarea>
                <label>æ„è¦‹ / å»ºè­°</label>
              </div>
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-sm btn-success" id="btnSubmitFeedback"><i class="bi bi-send me-1"></i>æäº¤å›é¥‹</button>
            </div>
          </div>
          <div class="divider"></div>
          <h6>æˆ‘çš„å›é¥‹ç´€éŒ„</h6>
          <div id="myFeedbackList">å°šç„¡è³‡æ–™</div>
        </div>
      </section>
    </div>

    <!-- ========== ADMIN SECTIONS ========== -->
    <div id="adminSections" class="hidden">
      <section id="admin-dashboard" class="tab-section active">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">ç®¡ç†å„€è¡¨æ¿</h5>
            <button class="btn btn-sm btn-outline-primary" id="btnRefreshAdminDashboard"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
          <div class="stat-grid" id="adminDashStats">
            <div class="skeleton" style="height:110px;"></div>
            <div class="skeleton" style="height:110px;"></div>
            <div class="skeleton" style="height:110px;"></div>
            <div class="skeleton" style="height:110px;"></div>
            <div class="skeleton" style="height:110px;"></div>
            <div class="skeleton" style="height:110px;"></div>
          </div>
          <div class="divider"></div>
          <h6>æé†’ / ç³»çµ±è¨Šæ¯</h6>
          <ul class="list-group small" id="systemAlerts"></ul>
        </div>
      </section>

      <section id="admin-finance" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">è²¡å‹™ç®¡ç†</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-success" id="btnShowTransactionForm"><i class="bi bi-plus-circle"></i> äº¤æ˜“</button>
              <button class="btn btn-sm btn-outline-secondary" id="btnExportTransactions"><i class="bi bi-download"></i> åŒ¯å‡º</button>
            </div>
          </div>
          <div id="transactionFormWrap" class="mb-3 hidden">
            <div class="card border-primary">
              <div class="card-header py-2 bg-primary text-white d-flex justify-content-between">
                <span>æ–°å¢äº¤æ˜“</span>
                <button class="btn btn-sm btn-light" id="btnHideTransactionForm">é—œé–‰</button>
              </div>
              <div class="card-body">
                <form id="formTransaction" class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="txDate" class="form-control" required>
                      <label>æ—¥æœŸ</label>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-floating">
                      <select id="txType" class="form-select" required>
                        <option value="">é¸æ“‡</option>
                        <option value="æ”¶å…¥">æ”¶å…¥</option>
                        <option value="æ”¯å‡º">æ”¯å‡º</option>
                      </select>
                      <label>é¡å‹</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="txCategory" class="form-select" required>
                        <option value="">è«‹å…ˆé¸æ“‡é¡å‹</option>
                      </select>
                      <label>é¡åˆ¥</label>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-floating">
                      <input type="number" id="txAmount" min="1" class="form-control" required>
                      <label>é‡‘é¡</label>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-floating">
                      <select id="txAccount" class="form-select">
                        <option value="ç¾é‡‘">ç¾é‡‘</option>
                        <option value="éŠ€è¡Œ">éŠ€è¡Œ</option>
                      </select>
                      <label>å¸³æˆ¶</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="text" id="txTarget" class="form-control">
                      <label>å°è±¡ / ææ¬¾äºº</label>
                    </div>
                  </div>
                  <div class="col-md-8">
                    <div class="form-floating">
                      <input type="text" id="txDesc" class="form-control">
                      <label>èªªæ˜</label>
                    </div>
                  </div>
                  <div class="col-12" id="txReceiptBlock" class="hidden">
                    <div class="border rounded p-3">
                      <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" id="txNeedReceipt">
                        <label class="form-check-label" for="txNeedReceipt">é–‹ç«‹æ”¶æ“š</label>
                      </div>
                      <div id="txReceiptDetails" class="row g-3 hidden">
                        <div class="col-md-4">
                          <div class="form-floating">
                            <input type="text" id="rcName" class="form-control">
                            <label>æ”¶æ“šæŠ¬é ­</label>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-floating">
                            <input type="email" id="rcEmail" class="form-control">
                            <label>Emailï¼ˆé¸å¡«ï¼‰</label>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-floating">
                            <input type="text" id="rcPhone" class="form-control">
                            <label>è¯çµ¡é›»è©±</label>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-floating">
                            <input type="text" id="rcTaxId" class="form-control">
                            <label>çµ±ä¸€ç·¨è™Ÿ</label>
                          </div>
                        </div>
                        <div class="col-md-8">
                          <div class="form-floating">
                            <textarea id="rcAddress" class="form-control" style="height:70px;"></textarea>
                            <label>åœ°å€</label>
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="rcSendNow">
                            <label for="rcSendNow" class="form-check-label">ç«‹å³å¯„é€ Email</label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-primary btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>å„²å­˜</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>äº¤æ˜“æ¸…å–®</h6>
          <div class="table-responsive mb-3" style="max-height:400px;">
            <table class="table table-hover table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>æ—¥æœŸ</th><th>é¡å‹</th><th>é¡åˆ¥</th><th>é‡‘é¡</th><th>å°è±¡</th><th>æ”¶æ“š</th><th></th>
                </tr>
              </thead>
              <tbody id="txList"><tr><td colspan="7" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="admin-receipts" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">æ”¶æ“šç®¡ç†</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-info" id="btnOpenReceiptTemplate"><i class="bi bi-file-earmark-text"></i> æ¨¡æ¿è¨­å®š</button>
              <button class="btn btn-sm btn-outline-success" id="btnManualReceipt"><i class="bi bi-plus-circle"></i> æ‰‹å‹•é–‹ç«‹</button>
            </div>
          </div>
          <div id="manualReceiptForm" class="hidden mb-3">
            <div class="card border-success">
              <div class="card-header bg-success text-white py-2 d-flex justify-content-between">
                <span>æ‰‹å‹•é–‹ç«‹æ”¶æ“š</span>
                <button class="btn btn-sm btn-light" id="btnCloseManualReceipt">é—œé–‰</button>
              </div>
              <div class="card-body">
                <form id="formManualReceipt" class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="mrDate" class="form-control" required>
                      <label>æ—¥æœŸ</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="number" id="mrAmount" class="form-control" min="1" required>
                      <label>é‡‘é¡</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="mrCategory" class="form-select" required>
                        <option value="">é¸æ“‡</option>
                        <option value="æœƒè²»">æœƒè²»</option>
                        <option value="ææ¬¾">ææ¬¾</option>
                        <option value="æ´»å‹•æ”¶å…¥">æ´»å‹•æ”¶å…¥</option>
                        <option value="å…¶ä»–æ”¶å…¥">å…¶ä»–æ”¶å…¥</option>
                      </select>
                      <label>é¡åˆ¥</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="text" id="mrTitle" class="form-control" required>
                      <label>æ”¶æ“šæŠ¬é ­</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="email" id="mrEmail" class="form-control">
                      <label>Emailï¼ˆå¯ç©ºï¼‰</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="text" id="mrPhone" class="form-control">
                      <label>é›»è©±</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="text" id="mrTaxId" class="form-control">
                      <label>çµ±ç·¨</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="mrAddress" class="form-control" style="height:70px;"></textarea>
                      <label>åœ°å€ï¼ˆå¯ç©ºï¼‰</label>
                    </div>
                  </div>
                  <div class="col-12 d-flex justify-content-between align-items-center">
                    <div class="form-check">
                      <input type="checkbox" id="mrSendNow" class="form-check-input">
                      <label for="mrSendNow" class="form-check-label">ç«‹å³å¯„é€ï¼ˆéœ€ Emailï¼‰</label>
                    </div>
                    <button class="btn btn-success btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>é–‹ç«‹</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>æ”¶æ“šåˆ—è¡¨</h6>
          <div id="receiptList"><div class="text-center py-4 text-muted">è¼‰å…¥ä¸­...</div></div>
        </div>
      </section>

      <section id="admin-members" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">æœƒå“¡ç®¡ç†</h5>
            <button class="btn btn-sm btn-outline-primary" id="btnExportMembers"><i class="bi bi-download"></i> åŒ¯å‡º</button>
          </div>
          <div class="row g-2 mb-2">
            <div class="col-md-3">
              <input type="text" id="memberSearch" class="form-control form-control-sm" placeholder="æœå°‹å§“å / LINE ID">
            </div>
            <div class="col-md-2">
              <select id="memberTypeFilter" class="form-select form-select-sm">
                <option value="">æ‰€æœ‰é¡åˆ¥</option>
                <option value="å¿—å·¥">å¿—å·¥</option>
                <option value="ç—…å‹">ç—…å‹</option>
                <option value="å®¶å±¬">å®¶å±¬</option>
                <option value="ä¸€èˆ¬æœƒå“¡">ä¸€èˆ¬æœƒå“¡</option>
                <option value="VIPæœƒå“¡">VIPæœƒå“¡</option>
              </select>
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-sm btn-outline-secondary" id="btnSearchMembers">æœå°‹</button>
            </div>
          </div>
          <div class="table-responsive" style="max-height:420px;">
            <table class="table table-sm table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>å§“å</th><th>é›»è©±</th><th>æœƒå“¡ç‹€æ…‹</th><th>åŠ å…¥æ—¥æœŸ</th><th>æœ€å¾Œææ¬¾</th><th></th>
                </tr>
              </thead>
              <tbody id="memberList"><tr><td colspan="6" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="admin-activities" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">æ´»å‹•ç®¡ç†</h5>
            <button class="btn btn-sm btn-outline-success" id="btnShowActForm"><i class="bi bi-plus-circle"></i> æ–°å¢æ´»å‹•</button>
          </div>
          <div id="adminActFormWrap" class="hidden mb-3">
            <div class="card border-success">
              <div class="card-header bg-success text-white py-2 d-flex justify-content-between">
                <span>æ–°å¢æ´»å‹•</span>
                <button class="btn btn-sm btn-light" id="btnCloseActForm">é—œé–‰</button>
              </div>
              <div class="card-body">
                <form id="formAdminActivity" class="row g-3">
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" id="admActName" class="form-control" required>
                      <label>æ´»å‹•åç¨±</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="admActType" class="form-select" required>
                        <option value="">é¸æ“‡</option>
                        <option value="è¬›åº§">è¬›åº§</option>
                        <option value="èšæœƒ">èšæœƒ</option>
                        <option value="æ—…éŠ">æ—…éŠ</option>
                        <option value="é‹å‹•">é‹å‹•</option>
                        <option value="å¿—å·¥æœå‹™">å¿—å·¥æœå‹™</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                      </select>
                      <label>æ´»å‹•é¡å‹</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="number" id="admActMax" class="form-control" value="50">
                      <label>äººæ•¸ä¸Šé™</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="admActDate" class="form-control" required>
                      <label>æ—¥æœŸ</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="time" id="admActTime" class="form-control">
                      <label>æ™‚é–“</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" id="admActLocation" class="form-control">
                      <label>åœ°é»</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="admActDesc" class="form-control" style="height:80px;"></textarea>
                      <label>æè¿°</label>
                    </div>
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-success btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>å»ºç«‹</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>æ´»å‹•æ¸…å–®</h6>
          <div id="adminActList" class="row g-3">
            <div class="col-12 text-center text-muted py-4">è¼‰å…¥ä¸­...</div>
          </div>
        </div>
      </section>

      <section id="admin-proposals" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">ææ¡ˆå¯©æŸ¥</h5>
            <button class="btn btn-sm btn-outline-success" id="btnShowProposalForm"><i class="bi bi-plus-circle"></i> æ–°å¢ææ¡ˆ</button>
          </div>
          <div id="proposalFormWrap" class="hidden mb-3">
            <div class="card border-success">
              <div class="card-header bg-success text-white py-2 d-flex justify-content-between">
                <span>æ–°å¢ææ¡ˆ</span>
                <button class="btn btn-sm btn-light" id="btnCloseProposalForm">é—œé–‰</button>
              </div>
              <div class="card-body">
                <form id="formProposal" class="row g-3">
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" id="propTitle" class="form-control" required>
                      <label>æ¨™é¡Œ</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="propType" class="form-select" required>
                        <option value="">é¡å‹</option>
                        <option value="é ç®—ææ¡ˆ">é ç®—ææ¡ˆ</option>
                        <option value="æ´»å‹•ææ¡ˆ">æ´»å‹•ææ¡ˆ</option>
                        <option value="åˆ¶åº¦ææ¡ˆ">åˆ¶åº¦ææ¡ˆ</option>
                        <option value="äººäº‹ææ¡ˆ">äººäº‹ææ¡ˆ</option>
                        <option value="å…¶ä»–ææ¡ˆ">å…¶ä»–ææ¡ˆ</option>
                      </select>
                      <label>ææ¡ˆé¡å‹</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="number" id="propBudget" class="form-control" min="0">
                      <label>é ç®—ï¼ˆå¯ç©ºï¼‰</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="propDeadline" class="form-control">
                      <label>åŸ·è¡ŒæœŸé™</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="propContent" class="form-control" style="height:120px;" required></textarea>
                      <label>å…§å®¹</label>
                    </div>
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-success btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>æäº¤</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>ææ¡ˆåˆ—è¡¨</h6>
          <div id="proposalList"><div class="text-center py-4 text-muted">è¼‰å…¥ä¸­...</div></div>
        </div>
      </section>

      <section id="admin-expenses" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">æ”¯å‡ºæ†‘è­‰å¯©æ ¸</h5>
            <button class="btn btn-sm btn-outline-warning" id="btnShowExpenseSubmit"><i class="bi bi-plus-circle"></i> æäº¤æ†‘è­‰</button>
          </div>
          <div id="expenseSubmitWrap" class="hidden mb-3">
            <div class="card border-warning">
              <div class="card-header bg-warning py-2 d-flex justify-content-between">
                <span class="fw-bold">æäº¤æ”¯å‡ºæ†‘è­‰</span>
                <button class="btn btn-sm btn-light" id="btnCloseExpenseSubmit">é—œé–‰</button>
              </div>
              <div class="card-body">
                <form id="formExpenseSubmit" class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="exDate" class="form-control" required>
                      <label>æ—¥æœŸ</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="exCategory" class="form-select" required>
                        <option value="">é¸æ“‡</option>
                        <option value="æ´»å‹•è²»ç”¨">æ´»å‹•è²»ç”¨</option>
                        <option value="è¾¦å…¬è²»ç”¨">è¾¦å…¬è²»ç”¨</option>
                        <option value="äº¤é€šè²»">äº¤é€šè²»</option>
                        <option value="é¤è²»">é¤è²»</option>
                        <option value="å ´åœ°è²»">å ´åœ°è²»</option>
                        <option value="å…¶ä»–æ”¯å‡º">å…¶ä»–æ”¯å‡º</option>
                      </select>
                      <label>é¡åˆ¥</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="number" id="exAmount" class="form-control" min="1" required>
                      <label>é‡‘é¡</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="text" id="exVendor" class="form-control" required>
                      <label>å» å•† / åº—å®¶</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="exDesc" class="form-control" style="height:90px;" required></textarea>
                      <label>æ”¯å‡ºèªªæ˜</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label fw-semibold">æ†‘è­‰åœ–ç‰‡ (jpg/png)</label>
                    <input type="file" id="exFile" class="form-control" accept="image/*" required>
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-warning btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>æäº¤</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>æ”¯å‡ºåˆ—è¡¨</h6>
          <div id="expenseList"><div class="text-center py-4 text-muted">è¼‰å…¥ä¸­...</div></div>
        </div>
      </section>

      <section id="admin-motions" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">è‡¨æ™‚å‹•è­°</h5>
            <button class="btn btn-sm btn-outline-danger" id="btnShowMotionForm"><i class="bi bi-plus-circle"></i> æå‡ºå‹•è­°</button>
          </div>
          <div id="motionFormWrap" class="hidden mb-3">
            <div class="card border-danger">
              <div class="card-header bg-danger text-white py-2 d-flex justify-content-between">
                <span>æå‡ºè‡¨æ™‚å‹•è­°</span>
                <button class="btn btn-sm btn-light" id="btnCloseMotionForm">é—œé–‰</button>
              </div>
              <div class="card-body">
                <form id="formMotion" class="row g-3">
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" id="moTitle" class="form-control" required>
                      <label>æ¨™é¡Œ</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select id="moUrgency" class="form-select" required>
                        <option value="">ç·Šæ€¥ç¨‹åº¦</option>
                        <option value="ç·Šæ€¥">ç·Šæ€¥</option>
                        <option value="é‡è¦">é‡è¦</option>
                        <option value="ä¸€èˆ¬">ä¸€èˆ¬</option>
                      </select>
                      <label>ç·Šæ€¥ç¨‹åº¦</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" id="moDeadline" class="form-control">
                      <label>æ±ºè­°æœŸé™</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="moContent" class="form-control" style="height:100px;" required></textarea>
                      <label>å‹•è­°å…§å®¹</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="moReason" class="form-control" style="height:70px;" required></textarea>
                      <label>æå‡ºç†ç”±</label>
                    </div>
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-danger btn-sm" type="submit"><i class="bi bi-check-circle me-1"></i>é€å‡º</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <h6>å‹•è­°åˆ—è¡¨</h6>
          <div id="motionList"><div class="text-center py-4 text-muted">è¼‰å…¥ä¸­...</div></div>
        </div>
      </section>

      <section id="admin-system" class="tab-section">
        <div class="panel">
          <div class="panel-header">
            <h5 class="mb-0">ç³»çµ±å·¥å…· / åŒ¯å‡º / é€šçŸ¥</h5>
          </div>
          <div class="row g-3">
            <div class="col-md-4">
              <div class="stat">
                <div class="label">å‚™ä»½</div>
                <div class="value" style="font-size:1.4rem;">System</div>
                <button class="btn btn-sm btn-outline-secondary mt-2 w-100" id="btnBackupSystem">
                  <i class="bi bi-hdd-stack me-1"></i>é–‹å§‹å‚™ä»½
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat">
                <div class="label">åŒ¯å‡º</div>
                <div class="value" style="font-size:1.4rem;">Data</div>
                <button class="btn btn-sm btn-outline-secondary mt-2 w-100" id="btnExportDataAll">
                  <i class="bi bi-download me-1"></i>åŒ¯å‡ºè³‡æ–™
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat">
                <div class="label">é€šçŸ¥</div>
                <div class="value" style="font-size:1.4rem;">Push</div>
                <button class="btn btn-sm btn-outline-secondary mt-2 w-100" id="btnSendSystemNotice">
                  <i class="bi bi-megaphone me-1"></i>ç™¼é€é€šçŸ¥
                </button>
              </div>
            </div>
          </div>
          <div class="divider"></div>
          <h6>åŒ¯å‡ºå·¥å…·</h6>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-primary btn-sm export-btn" data-type="æœƒå“¡è³‡æ–™">æœƒå“¡</button>
            <button class="btn btn-outline-primary btn-sm export-btn" data-type="äº¤æ˜“è¨˜éŒ„">äº¤æ˜“</button>
            <button class="btn btn-outline-primary btn-sm export-btn" data-type="æ”¶æ“šè¨˜éŒ„">æ”¶æ“š</button>
            <button class="btn btn-outline-primary btn-sm export-btn" data-type="æ´»å‹•è³‡æ–™">æ´»å‹•</button>
          </div>
        </div>
      </section>
    </div>

    <footer class="mt-5">
      Unified Parkinson Association System | Front-end v2 (form-urlencoded) | ç”± GPT-5 å”åŠ©ç”¢å‡º
    </footer>
  </div>

  <!-- Floating Action Buttons -->
  <div class="floating-action" id="floatingActions">
    <button id="fabAddDonation" class="hidden" title="å¿«é€Ÿææ¬¾"><i class="bi bi-cash-stack"></i></button>
    <button id="fabAddActivity" class="hidden" title="å¿«é€Ÿæ´»å‹• (ç®¡ç†å“¡)"><i class="bi bi-calendar-plus"></i></button>
    <button id="fabScrollTop" title="å›åˆ°é ‚éƒ¨"><i class="bi bi-arrow-up-short"></i></button>
  </div>

  <!-- Donation Modal -->
  <div class="modal fade" id="modalDonation" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="formDonation">
        <div class="modal-header">
          <h5 class="modal-title">æ–°å¢ææ¬¾</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-3">
          <div class="col-md-6">
            <div class="form-floating">
              <input type="number" min="1" id="donAmount" class="form-control" required>
              <label>é‡‘é¡ *</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <select id="donMethod" class="form-select">
                <option value="ç¾é‡‘">ç¾é‡‘</option>
                <option value="è½‰å¸³">è½‰å¸³</option>
                <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
              </select>
              <label>æ–¹å¼</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <input type="date" id="donDate" class="form-control">
              <label>æ—¥æœŸ</label>
            </div>
          </div>
          <div class="col-12">
            <div class="form-floating">
              <textarea id="donNote" class="form-control" style="height:80px;"></textarea>
              <label>å‚™è¨»</label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal" type="button">å–æ¶ˆ</button>
          <button class="btn btn-primary btn-sm" type="submit">é€å‡º</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Member Expense Modal -->
  <div class="modal fade" id="modalExpense" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="formMemberExpense">
        <div class="modal-header">
          <h5 class="modal-title">æ”¯å‡ºç”³è«‹</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
          <div class="modal-body row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" id="memExpItem" class="form-control" required>
                <label>é …ç›® *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="number" id="memExpAmount" class="form-control" min="1" required>
                <label>é‡‘é¡ *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <select id="memExpCategory" class="form-select">
                  <option value="æ´»å‹•è²»ç”¨">æ´»å‹•è²»ç”¨</option>
                  <option value="äº¤é€šè²»">äº¤é€šè²»</option>
                  <option value="é¤é£²è²»">é¤é£²è²»</option>
                  <option value="è¨­å‚™è²»">è¨­å‚™è²»</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <label>é¡åˆ¥</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="date" id="memExpDate" class="form-control">
                <label>æ—¥æœŸ</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea id="memExpDesc" class="form-control" style="height:80px;"></textarea>
                <label>èªªæ˜</label>
              </div>
            </div>
          </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal" type="button">å–æ¶ˆ</button>
          <button class="btn btn-primary btn-sm" type="submit">é€å‡º</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Receipt Template Modal -->
  <div class="modal fade" id="modalReceiptTemplate" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-file-earmark-text me-1"></i>æ”¶æ“šæ¨¡æ¿è¨­å®š</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formReceiptTemplate" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" id="tplDocId" class="form-control">
                <label>Google æ–‡ä»¶æ¨¡æ¿ ID</label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-floating">
                <input type="text" id="tplPrefix" class="form-control" value="RCP">
                <label>æ”¶æ“šå‰ç¶´</label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-floating">
                <input type="text" id="tplOrgName" class="form-control">
                <label>æ©Ÿæ§‹åç¨±</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" id="tplOrgPhone" class="form-control">
                <label>æ©Ÿæ§‹é›»è©±</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <textarea id="tplOrgAddress" class="form-control" style="height:80px;"></textarea>
                <label>æ©Ÿæ§‹åœ°å€</label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button class="btn btn-primary btn-sm" id="btnSaveReceiptTemplate"><i class="bi bi-save me-1"></i>å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <div id="dynamicModal"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /*********************************************************
     * CONFIG
     *********************************************************/
    const CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',   // å¿…å¡«ï¼šä½ çš„ liffId
      API_BASE: 'https://script.google.com/macros/s/AKfycbwfrbQ3j3HrGYqerqUBy5_Epvc6JCIwMq2YDS8N7RHUnUxPp8H-qmmhBl3rfpeC9vLzGQ/exec', // å¿…å¡«ï¼šå¾Œç«¯ doPost Web App URLï¼ˆ/execï¼‰
      API_KEY: 'AAbb8520258185202581',
      USE_SIGNATURE: false,    // è‹¥å•Ÿç”¨è«‹åŒæ­¥å¾Œç«¯
      RETRIES: 2,
      ACTIVITY_PAGE_SIZE: 8,
      DEBUG_NON_LIFF: false    // è¨­ true å¯åœ¨æ™®é€šç€è¦½å™¨ç”¨å‡ lineId æ¸¬è©¦
    };

    const ACTION_MAP = {
      register: 'register',
      getProfile: 'getProfile',
      updateProfile: 'updateProfile',
      getUserInfo: 'getUserInfo',
      updateUserContact: 'updateUserContact',

      getActivities: 'getActivities',
      registerActivity: 'registerActivity',
      getMyRegistrations: 'getMyRegistrations',
      cancelActivity: 'cancelActivity',
      getUserActivities: 'getUserActivities',

      getVolunteerNeeds: 'getVolunteerNeeds',
      getMyVolunteerRecords: 'getMyVolunteerRecords',
      registerVolunteer: 'registerVolunteer',

      getDonations: 'getDonations',
      addDonation: 'addDonation',
      getMyExpenses: 'getMyExpenses',
      submitExpense: 'submitExpense',

      getFinanceOverview: 'getFinanceOverview',

      getDashboardData: 'getDashboardData',
      exportData: 'exportData',
      backupSystem: 'backupSystem',
      sendSystemNotification: 'sendSystemNotification',

      getTransactionList: 'getTransactionList',
      addTransactionWithReceipt: 'addTransactionWithReceipt',
      deleteTransaction: 'deleteTransaction',
      createReceiptForTransaction: 'createReceiptForTransaction',

      getReceiptTemplate: 'getReceiptTemplate',
      saveReceiptTemplate: 'saveReceiptTemplate',
      getReceiptList: 'getReceiptList',
      createManualReceipt: 'createManualReceipt',
      sendReceipt: 'sendReceipt',
      regenerateReceiptPDF: 'regenerateReceiptPDF',

      getMemberList: 'getMemberList',
      getMemberDetail: 'getMemberDetail',
      updateMemberStatus: 'updateMemberStatus',

      addActivity: 'addActivity',
      getActivityList: 'getActivityList',
      exportActivityMembers: 'exportActivityMembers',

      addProposal: 'addProposal',
      getProposalList: 'getProposalList',
      voteProposal: 'voteProposal',

      addExpense: 'addExpense',
      getExpenseList: 'getExpenseList',
      approveExpense: 'approveExpense',

      addMotion: 'addMotion',
      getMotionList: 'getMotionList',
      processMotion: 'processMotion',

      submitFeedback: 'submitFeedback',
      getMyFeedback: 'getMyFeedback'
    };

    /*********************************************************
     * å…¨åŸŸç‹€æ…‹
     *********************************************************/
    let currentUser = null;
    let isAdmin = false;
    let currentSection = 'member-dashboard';
    let activityCache = [];
    let filteredActivities = [];
    let currentActPage = 1;
    let liffProfile = null;
    let debugLineId = null;

    /*********************************************************
     * DOM å·¥å…·
     *********************************************************/
    const $ = sel => document.querySelector(sel);
    const $all = sel => document.querySelectorAll(sel);

    function escapeHtml(s=''){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
    function fmtDate(d){
      if(!d) return '-';
      const dt = new Date(d);
      if(isNaN(dt)) return '-';
      return dt.getFullYear() + '/' + String(dt.getMonth()+1).padStart(2,'0') + '/' + String(dt.getDate()).padStart(2,'0');
    }
    function fmtDateTime(d){
      if(!d) return '-';
      const dt = new Date(d);
      if(isNaN(dt)) return '-';
      return dt.toLocaleString('zh-TW');
    }
    function numberFmt(n){ return (Number(n)||0).toLocaleString(); }

    /*********************************************************
     * é€šçŸ¥
     *********************************************************/
    function notify(msg, type='info', ms=4000){
      const cont = $('#notify');
      const div = document.createElement('div');
      div.className = 'toast-msg '+ (type==='error'?'error': type==='success'?'success': type==='warn'?'warn':'');
      div.innerHTML = `
        <div>
          <strong>${type==='error'?'éŒ¯èª¤': type==='success'?'æˆåŠŸ': type==='warn'?'æé†’':'è¨Šæ¯'}</strong><br>
          <span>${escapeHtml(msg)}</span>
        </div>
        <button class="close" aria-label="é—œé–‰">&times;</button>
      `;
      div.querySelector('.close').addEventListener('click', ()=> div.remove());
      cont.appendChild(div);
      if(ms) setTimeout(()=> div.remove(), ms);
    }

    /*********************************************************
     * API - form-urlencoded ç‰ˆæœ¬
     *********************************************************/
    async function callAPI(action, data={}, opt={silent:false}){
      const payload = {
        action,
        apiKey: CONFIG.API_KEY,
        ts: Date.now(),
        nonce: Math.random().toString(36).slice(2),
        ...data
      };
      if(CONFIG.USE_SIGNATURE){
        const baseString = `${action}|${payload.ts}|${payload.nonce}|${CONFIG.API_KEY}`;
        payload.sign = CryptoJS.HmacSHA256(baseString, CONFIG.API_KEY).toString();
      }

      const form = new URLSearchParams();
      Object.keys(payload).forEach(k=>{
        let v = payload[k];
        if(v && typeof v === 'object'){
          v = JSON.stringify(v);
        }
          form.append(k, v==null?'':v);
      });

      let attempt=0;
      while(attempt <= CONFIG.RETRIES){
        try {
          const res = await fetch(CONFIG.API_BASE, {
            method:'POST',
            body: form,
            cache:'no-store'
          });
          if(!res.ok) throw new Error('HTTP '+res.status);
          const json = await res.json();
          if(json.success === false) throw new Error(json.message || 'æ“ä½œå¤±æ•—');
          return json;
        } catch(err){
          attempt++;
          if(attempt>CONFIG.RETRIES){
            if(!opt.silent) notify(`API(${action}) å¤±æ•—ï¼š${err.message}`,'error',6000);
            throw err;
          }
          await new Promise(r=> setTimeout(r, 400 * attempt));
        }
      }
    }

    /*********************************************************
     * LIFF åˆå§‹åŒ–
     *********************************************************/
    async function initApp(){
      if(CONFIG.DEBUG_NON_LIFF && !isInLiff()){
        // é¡¯ç¤º debug å‡ç™»å…¥
        $('#nonLiffBanner').style.display='block';
        $('#debugLoginBox').classList.remove('hidden');
        notify('Debug æ¨¡å¼ï¼Œè«‹è¼¸å…¥ lineId é€²è¡Œæ¸¬è©¦ç™»å…¥','warn',8000);
        return;
      }
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if(!liff.isLoggedIn()){
          liff.login();
          return;
        }
        liffProfile = await liff.getProfile();
        await safeRegister();
        await loadUserProfile();
        setupUIByRole();
        loadMemberDashboard();
      } catch(e){
        notify('LIFF åˆå§‹åŒ–å¤±æ•—: '+e.message,'error',8000);
        console.error(e);
      }
    }

    function isInLiff(){
      return (typeof liff !== 'undefined') && !!liff.getOS && !CONFIG.DEBUG_NON_LIFF_FORCE;
    }

    // Debug å‡ç™»å…¥
    $('#btnDebugLogin')?.addEventListener('click', async ()=>{
      const v = $('#debugLineId').value.trim();
      if(!v) return notify('è«‹è¼¸å…¥æ¸¬è©¦ lineId','warn');
      debugLineId = v;
      notify('ä½¿ç”¨å½ lineId: '+v,'success');
      await safeRegister(true);
      await loadUserProfile(true);
      setupUIByRole();
      loadMemberDashboard();
    });

    async function safeRegister(isDebug=false){
      try {
        await callAPI(ACTION_MAP.register, {
          lineId: isDebug? debugLineId : liffProfile.userId,
          lineName: isDebug? ('DebugUser_'+debugLineId) : (liffProfile.displayName||'LINEä½¿ç”¨è€…'),
          realName: isDebug? ('DebugUser_'+debugLineId) : (liffProfile.displayName||'')
        }, {silent:true});
      } catch(e){
        console.warn('register skipped:', e.message);
      }
    }

    async function loadUserProfile(isDebug=false){
      try {
        const res = await callAPI(ACTION_MAP.getProfile,{
          lineId: isDebug? debugLineId : liffProfile.userId
        },{silent:true});
        currentUser = res.data || res;
      } catch(e){
        notify('å–å¾—ä½¿ç”¨è€…è³‡æ–™å¤±æ•—: '+e.message,'error');
        currentUser = null;
      }
      isAdmin = !!(currentUser && (currentUser.isAdmin==='TRUE' || currentUser.isAdmin===true ||
         ['admin','chairman','director','supervisor'].includes(String(currentUser.role).toLowerCase())));
      updateUserLine();
      fillProfileForm();
    }

    function updateUserLine(){
      const el = $('#currentUserLine');
      if(!currentUser){
        el.textContent = 'å°šæœªè¼‰å…¥ä½¿ç”¨è€…è³‡æ–™';
        return;
      }
      el.innerHTML = `
        <span class="me-2"><i class="bi bi-person-circle"></i> ${escapeHtml(currentUser.realName || currentUser.lineName || 'ç”¨æˆ¶')}</span>
        <span class="badge bg-secondary me-2">${escapeHtml(currentUser.memberType || 'æœƒå“¡')}</span>
        ${isAdmin ? '<span class="badge bg-danger">ç®¡ç†å“¡</span>':''}
      `;
      if(isAdmin){
        $('#navToAdmin').classList.remove('hidden');
        $('#btnSwitchPortal').classList.remove('hidden');
      }
    }

    function fillProfileForm(){
      if(!currentUser) return;
      $('#pfLineName').value = currentUser.lineName || '';
      $('#pfRealName').value = currentUser.realName || '';
      $('#pfPhone').value = currentUser.phone || '';
      $('#pfEmail').value = currentUser.email || '';
      $('#pfBirthday').value = currentUser.birthday || '';
      $('#pfMemberType').value = currentUser.memberType || 'ç—…å‹';
      $('#pfAddress').value = currentUser.address || '';
      const stats = [
        'ç‹€æ…‹ï¼š' + (currentUser.status || '-'),
        'è¨»å†Šï¼š' + (currentUser.registerDate ? fmtDate(currentUser.registerDate) : '-'),
        'æœ€å¾Œæ´»å‹•ï¼š' + (currentUser.lastActive ? fmtDate(currentUser.lastActive) : '-'),
        'å¿—å·¥æ™‚æ•¸ï¼š' + (currentUser.volunteerHours || 0),
        'æ´»å‹•æ¬¡æ•¸ï¼š' + (currentUser.activityCount || 0)
      ];
      $('#profileStats').innerHTML = stats.map(s=>`<li class="list-group-item">${escapeHtml(s)}</li>`).join('');
    }

    function setupUIByRole(){
      $('#memberSections').classList.remove('hidden');
      $('#adminSections').classList.add('hidden');
      $('#memberNav').classList.remove('hidden');
      $('#adminNav').classList.add('hidden');
    }

    /*********************************************************
     * å°èˆª / Section åˆ‡æ›
     *********************************************************/
    function showSection(id){
      currentSection = id;
      $all('.tab-section').forEach(sec=> sec.classList.remove('active'));
      const el = document.getElementById(id);
      if(el) el.classList.add('active');
      $all('.nav-btn').forEach(b=> b.classList.remove('active'));
      const navBtn = document.querySelector(`.nav-btn[data-section="${id}"]`);
      if(navBtn) navBtn.classList.add('active');
      handleFabVisibility();

      switch(id){
        case 'member-activities': loadActivities(); break;
        case 'member-volunteer': loadVolunteer(); break;
        case 'member-finance': loadMemberFinance(); break;
        case 'member-feedback': loadFeedbackModule(); break;
        case 'admin-dashboard': loadAdminDashboard(); break;
        case 'admin-finance': loadTransactions(); break;
        case 'admin-receipts': loadReceipts(); break;
        case 'admin-members': loadMemberList(); break;
        case 'admin-activities': loadAdminActivities(); break;
        case 'admin-proposals': loadProposals(); break;
        case 'admin-expenses': loadExpenses(); break;
        case 'admin-motions': loadMotions(); break;
      }
    }

    $all('.nav-btn[data-section]').forEach(btn=>{
      btn.addEventListener('click', ()=> showSection(btn.getAttribute('data-section')));
    });

    /*********************************************************
     * ä¸»é¡Œ
     *********************************************************/
    function toggleTheme(){
      const body = document.body;
      const cur = body.getAttribute('data-theme');
      const next = cur==='light'?'dark':'light';
      body.setAttribute('data-theme', next);
      const icon = $('#btnTheme i');
      const label = $('#btnTheme span');
      if(next==='dark'){
        icon.className='bi bi-sun';
        label.textContent='æ·ºè‰²æ¨¡å¼';
      } else {
        icon.className='bi bi-moon-stars';
        label.textContent='æ·±è‰²æ¨¡å¼';
      }
      localStorage.setItem('appTheme', next);
    }
    $('#btnTheme').addEventListener('click', toggleTheme);

    function initTheme(){
      const saved = localStorage.getItem('appTheme');
      if(saved){
        document.body.setAttribute('data-theme', saved);
        if(saved==='dark'){
          $('#btnTheme i').className='bi bi-sun';
          $('#btnTheme span').textContent='æ·ºè‰²æ¨¡å¼';
        }
      }
    }

    /*********************************************************
     * æœƒå“¡å„€è¡¨æ¿
     *********************************************************/
    async function loadMemberDashboard(){
      try {
        $('#memberStatsSkeleton').classList.remove('d-none');
        $('#memberStats').classList.add('d-none');
        const lineId = debugLineId || (liffProfile && liffProfile.userId);
        const [actsRes, regsRes, volsRes, donsRes] = await Promise.allSettled([
          callAPI(ACTION_MAP.getActivities,{}, {silent:true}),
          callAPI(ACTION_MAP.getMyRegistrations,{ lineId },{silent:true}),
          callAPI(ACTION_MAP.getMyVolunteerRecords,{ lineId },{silent:true}),
          callAPI(ACTION_MAP.getDonations,{ lineId },{silent:true})
        ]);
        const acts = actsRes.value?.data || actsRes.value || [];
        const regs = regsRes.value?.data || regsRes.value || [];
        const vols = volsRes.value?.data || volsRes.value || [];
        const dons = donsRes.value?.data || donsRes.value || [];

        $('#stOpenActs').textContent = acts.filter(a=> a.status==='é–‹æ”¾å ±å' || a.status==='å ±åä¸­').length;
        $('#stMyRegs').textContent = regs.filter(r=> r.status==='å·²å ±å' || r.status==='å ±åä¸­').length;
        const volHours = vols.filter(v=> v.status==='å·²æ ¸å‡†' || v.status==='é€šé')
          .reduce((s,v)=> s + (Number(v.hours||0)),0);
        $('#stVolHours').textContent = volHours;
        $('#stDonCount').textContent = dons.length;

        const latest = acts.slice(0,4);
        const container = $('#latestActivities');
        if(!latest.length){
          container.innerHTML = '<div class="col-12 small text-muted">ç›®å‰æ²’æœ‰æ´»å‹•</div>';
        } else {
          container.innerHTML = latest.map(a=>`
            <div class="col-md-6">
              <div class="activity-card">
                <div class="d-flex justify-content-between">
                  <strong>${escapeHtml(a.name||'æœªå‘½å')}</strong>
                  <span class="status-pill ${
                    a.status==='é–‹æ”¾å ±å'
                      ? 'status-open'
                      : (a.currentCount && a.maxParticipants && a.currentCount>=a.maxParticipants ? 'status-full':'status-closed')
                  }">${escapeHtml(a.status||'')}</span>
                </div>
                <div class="small text-muted">
                  æ—¥æœŸï¼š${fmtDate(a.date)}<br>
                  åœ°é»ï¼š${escapeHtml(a.location||'å¾…å®š')}
                </div>
              </div>
            </div>
          `).join('');
        }
        $('#memberStatsSkeleton').classList.add('d-none');
        $('#memberStats').classList.remove('d-none');
      } catch(e){
        notify('è¼‰å…¥å„€è¡¨æ¿å¤±æ•—ï¼š'+e.message,'error');
      }
    }

    /*********************************************************
     * æ´»å‹•
     *********************************************************/
    function buildActivityFilter(){
      return {
        status: $('#actFilterStatus').value,
        date: $('#actFilterDate').value,
        search: $('#actFilterSearch').value.trim()
      };
    }

    async function loadActivities(){
      try {
        const res = await callAPI(ACTION_MAP.getActivities, buildActivityFilter(), {silent:true});
        activityCache = res.data || res;
        applyActivityFilter();
      } catch(e){
        $('#activitiesList').innerHTML = '<div class="text-danger small">è¼‰å…¥æ´»å‹•å¤±æ•—: '+escapeHtml(e.message)+'</div>';
      }
      loadMyRegistrations();
    }

    function applyActivityFilter(){
      const { status, date, search } = buildActivityFilter();
      filteredActivities = activityCache.filter(a=>{
        const matchStatus = !status || a.status===status;
          const matchDate = !date || (a.date||'').startsWith(date);
        const lower = (search||'').toLowerCase();
        const matchSearch = !search || (
          (a.name||'').toLowerCase().includes(lower) ||
          (a.description||'').toLowerCase().includes(lower) ||
          (a.location||'').toLowerCase().includes(lower)
        );
        return matchStatus && matchDate && matchSearch;
      });
      currentActPage = 1;
      renderActivitiesPage();
    }

    function renderActivitiesPage(){
      const wrap = $('#activitiesList');
      const pag = $('#activitiesPagination');
      const size = CONFIG.ACTIVITY_PAGE_SIZE;
      const total = filteredActivities.length;
      const pages = Math.ceil(total/size)||1;
      if(currentActPage>pages) currentActPage = pages;
      const start = (currentActPage-1)*size;
      const pageData = filteredActivities.slice(start, start+size);
      if(!pageData.length){
        wrap.innerHTML = '<div class="small text-muted">ç„¡ç¬¦åˆæ´»å‹•</div>';
        pag.innerHTML = '';
        return;
      }
      wrap.innerHTML = pageData.map(a=>{
        const max = Number(a.maxParticipants)||0;
        const cur = Number(a.currentCount)||0;
        const full = max>0 && cur>=max;
        const canReg = (a.status==='é–‹æ”¾å ±å' || a.status==='å ±åä¸­') && !full;
        return `
          <div class="activity-card">
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-bold">${escapeHtml(a.name||'æœªå‘½å')}</div>
              <span class="status-pill ${full?'status-full': canReg?'status-open':'status-closed'}">${full?'é¡æ»¿':escapeHtml(a.status||'')}</span>
            </div>
            <div class="small text-muted">æ—¥æœŸï¼š${fmtDate(a.date)}ã€€åœ°é»ï¼š${escapeHtml(a.location||'å¾…å®š')}</div>
            <div class="small mt-1">äººæ•¸ï¼š${cur}/${max||'âˆ'}</div>
            <div class="mt-2">${canReg? `<button class="btn btn-sm btn-primary" data-act="${a.activityId}"><i class="bi bi-check2-circle me-1"></i>å ±å</button>`:''}</div>
          </div>
        `;
      }).join('');

      let pagHtml='';
      for(let i=1;i<=pages;i++){
        pagHtml += `<button class="${i===currentActPage?'active':''}" data-page="${i}">${i}</button>`;
      }
      pag.innerHTML = pagHtml;

      wrap.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.addEventListener('click',()=> registerActivity(btn.getAttribute('data-act')));
      });
      pag.querySelectorAll('button[data-page]').forEach(b=>{
        b.addEventListener('click',()=>{
          currentActPage = Number(b.getAttribute('data-page'));
          renderActivitiesPage();
        });
      });
    }

    async function registerActivity(activityId){
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      if(!lineId) return notify('å°šæœªç™»å…¥','warn');
      try {
        await callAPI(ACTION_MAP.registerActivity,{
          lineId,
          activityId
        });
        notify('æ´»å‹•å ±åæˆåŠŸ','success');
        loadActivities();
      } catch(e){
        notify('å ±åå¤±æ•—ï¼š'+e.message,'error');
      }
    }

    async function loadMyRegistrations(){
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      if(!lineId){ $('#myRegistrations').innerHTML=''; return; }
      try {
        const res = await callAPI(ACTION_MAP.getMyRegistrations,{ lineId },{silent:true});
        const regs = res.data || res;
        const container = $('#myRegistrations');
        if(!regs.length){
          container.innerHTML = '<div class="small text-muted">å°šæœªå ±åä»»ä½•æ´»å‹•</div>';
          return;
        }
        container.innerHTML = `
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light"><tr><th>æ´»å‹•</th><th>æ—¥æœŸ</th><th>ç‹€æ…‹</th><th></th></tr></thead>
              <tbody>
                ${regs.map(r=>{
                  const cancel = r.status==='å·²å ±å' ? `<button class="btn btn-sm btn-outline-danger" data-reg="${r.registrationId}"><i class="bi bi-x-circle"></i></button>`:'';
                  return `<tr>
                    <td>${escapeHtml(r.activityName||'')}</td>
                    <td>${fmtDate(r.activityDate)}</td>
                    <td>${escapeHtml(r.status||'')}</td>
                    <td>${cancel}</td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
        container.querySelectorAll('button[data-reg]').forEach(b=>{
          b.addEventListener('click',()=>{
            if(confirm('ç¢ºå®šå–æ¶ˆï¼Ÿ')) cancelRegistration(b.getAttribute('data-reg'));
          });
        });
        loadActivitiesForFeedback(regs);
      } catch(e){
        $('#myRegistrations').innerHTML = '<div class="text-danger small">è®€å–å¤±æ•—</div>';
      }
    }

    async function cancelRegistration(regId){
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        await callAPI(ACTION_MAP.cancelActivity,{ lineId, registrationId: regId });
        notify('å·²å–æ¶ˆå ±å','success');
        loadActivities();
      } catch(e){
        notify('å–æ¶ˆå¤±æ•—ï¼š'+e.message,'error');
      }
    }

    /*********************************************************
     * å¿—å·¥
     *********************************************************/
    async function loadVolunteer(){
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        const [needsRes, recordsRes] = await Promise.allSettled([
          callAPI(ACTION_MAP.getVolunteerNeeds,{}, {silent:true}),
          callAPI(ACTION_MAP.getMyVolunteerRecords,{ lineId }, {silent:true})
        ]);
        const needs = needsRes.value?.data || needsRes.value || [];
        $('#volNeedsList').innerHTML = needs.length ? needs.map(n=>`
          <div class="activity-card">
            <div class="d-flex justify-content-between">
              <strong>${escapeHtml(n.name||n.activityName||'å¿—å·¥éœ€æ±‚')}</strong>
              <span class="badge bg-primary">${fmtDate(n.date)}</span>
            </div>
            <div class="small text-muted">${escapeHtml(n.description||'')}</div>
            <div class="mt-2">
              <button class="btn btn-sm btn-outline-primary" data-vol="${n.activityId}"><i class="bi bi-person-plus"></i> å ±åå¿—å·¥</button>
            </div>
          </div>
        `).join('') : '<div class="small text-muted">ç›®å‰ç„¡å¿—å·¥éœ€æ±‚</div>';
        $('#volNeedsList').querySelectorAll('button[data-vol]').forEach(b=>{
          b.addEventListener('click',()=> registerVolunteer(b.getAttribute('data-vol')));
        });
        const records = recordsRes.value?.data || recordsRes.value || [];
        $('#volRecordsList').innerHTML = records.length
          ? `<div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead class="table-light">
                  <tr><th>æ´»å‹•</th><th>æ™‚æ•¸</th><th>ç‹€æ…‹</th><th>æ—¥æœŸ</th></tr>
                </thead>
                <tbody>
                  ${records.map(r=>`
                    <tr>
                      <td>${escapeHtml(r.activityName||'')}</td>
                      <td>${r.hours||0}</td>
                      <td>${escapeHtml(r.status||'')}</td>
                      <td>${fmtDate(r.serviceDate)}</td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </div>`
          : '<div class="small text-muted">å°šç„¡å¿—å·¥ç´€éŒ„</div>';
      } catch(e){
        notify('è¼‰å…¥å¿—å·¥è³‡æ–™å¤±æ•—','error');
      }
    }

    async function registerVolunteer(activityId){
      const hours = prompt('è«‹è¼¸å…¥é ä¼°æœå‹™æ™‚æ•¸');
      if(!hours) return;
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        await callAPI(ACTION_MAP.registerVolunteer,{
          lineId,
          activityId,
          hours: parseFloat(hours)
        });
        notify('å¿—å·¥ç™»è¨˜æˆåŠŸï¼ˆå¾…å¯©æ ¸ï¼‰','success');
        loadVolunteer();
      } catch(e){
        notify('ç™»è¨˜å¤±æ•—ï¼š'+e.message,'error');
      }
    }

    /*********************************************************
     * å€‹äººè²¡å‹™
     *********************************************************/
    async function loadMemberFinance(){
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        const [donRes, expRes] = await Promise.allSettled([
          callAPI(ACTION_MAP.getDonations,{ lineId },{silent:true}),
          callAPI(ACTION_MAP.getMyExpenses,{ lineId },{silent:true})
        ]);
        const dons = donRes.value?.data || donRes.value || [];
        const exps = expRes.value?.data || expRes.value || [];
        let totalAmount = 0;
        dons.forEach(d=> totalAmount += Number(d.amount||0));
        $('#finDonCountMember').textContent = dons.length;
        $('#finDonAmountMember').textContent = numberFmt(totalAmount);

        $('#memberDonationList').innerHTML = dons.length
          ? `<div class="table-responsive"><table class="table table-sm table-hover align-middle">
              <thead class="table-light"><tr><th>æ—¥æœŸ</th><th>é‡‘é¡</th><th>æ–¹å¼</th></tr></thead>
              <tbody>
                ${dons.map(d=> `<tr>
                  <td>${fmtDate(d.donationDate)}</td>
                  <td>${numberFmt(d.amount)}</td>
                  <td>${escapeHtml(d.method||'')}</td>
                </tr>`).join('')}
              </tbody>
            </table></div>`
          : '<div class="small text-muted">ç„¡ææ¬¾ç´€éŒ„</div>';

        $('#memberExpenseList').innerHTML = exps.length
          ? `<div class="table-responsive"><table class="table table-sm table-hover align-middle">
              <thead class="table-light"><tr><th>æ—¥æœŸ</th><th>é …ç›®</th><th>é‡‘é¡</th><th>ç‹€æ…‹</th></tr></thead>
              <tbody>
                ${exps.map(e=> `<tr>
                  <td>${fmtDate(e.expenseDate)}</td>
                  <td>${escapeHtml(e.item||'')}</td>
                  <td>${numberFmt(e.amount)}</td>
                  <td>${escapeHtml(e.status||'')}</td>
                </tr>`).join('')}
              </tbody>
            </table></div>`
          : '<div class="small text-muted">ç„¡æ”¯å‡ºç”³è«‹</div>';

        if(isAdmin){
          $('#memberFinAdminDivider').classList.remove('d-none');
          $('#financeOverviewAdmin').classList.remove('d-none');
          try {
            const ovRes = await callAPI(ACTION_MAP.getFinanceOverview,{ operatorLineId: lineId },{silent:true});
            const ov = ovRes.data || ovRes;
            $('#ovIncome').textContent = numberFmt(ov.totalIncome||0);
            $('#ovExpense').textContent = numberFmt(ov.totalExpense||0);
            $('#ovBalance').textContent = numberFmt(ov.balance||0);
            $('#ovDonationCount').textContent = numberFmt(ov.donationCount||0);
          } catch(e){
            notify('ç„¡æ³•è¼‰å…¥è²¡å‹™ç¸½è¦½','warn');
          }
        } else {
          $('#memberFinAdminDivider').classList.add('d-none');
          $('#financeOverviewAdmin').classList.add('d-none');
        }
      } catch(e){
        notify('è¼‰å…¥è²¡å‹™è³‡æ–™å¤±æ•—','error');
      }
    }

    $('#formDonation').addEventListener('submit', async e=>{
      e.preventDefault();
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        await callAPI(ACTION_MAP.addDonation,{
          lineId,
          amount: parseInt($('#donAmount').value),
          method: $('#donMethod').value,
          donationDate: $('#donDate').value,
          note: $('#donNote').value
        });
        notify('ææ¬¾å·²è¨˜éŒ„','success');
        bootstrap.Modal.getInstance($('#modalDonation')).hide();
        $('#formDonation').reset();
        if(currentSection==='member-finance') loadMemberFinance();
      } catch(err){
        notify(err.message,'error');
      }
    });

    $('#formMemberExpense').addEventListener('submit', async e=>{
      e.preventDefault();
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        await callAPI(ACTION_MAP.submitExpense,{
          lineId,
          item: $('#memExpItem').value,
          amount: parseInt($('#memExpAmount').value),
          category: $('#memExpCategory').value,
          description: $('#memExpDesc').value,
          expenseDate: $('#memExpDate').value
        });
        notify('æ”¯å‡ºç”³è«‹å·²é€å‡º','success');
        bootstrap.Modal.getInstance($('#modalExpense')).hide();
        $('#formMemberExpense').reset();
        if(currentSection==='member-finance') loadMemberFinance();
      } catch(err){
        notify(err.message,'error');
      }
    });

    /*********************************************************
     * å›é¥‹
     *********************************************************/
    function loadActivitiesForFeedback(regs){
      const sel = $('#fbActivitySelect');
      sel.innerHTML = '<option value="">é¸æ“‡æ´»å‹•</option>';
      regs.forEach(r=>{
        const opt = document.createElement('option');
        opt.value = r.activityId;
        opt.textContent = r.activityName || 'æ´»å‹•';
        sel.appendChild(opt);
      });
    }

    async function loadFeedbackModule(){
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        const regsRes = await callAPI(ACTION_MAP.getMyRegistrations,{ lineId },{silent:true});
        loadActivitiesForFeedback(regsRes.data || regsRes || []);
      } catch(e){
        console.warn('å›é¥‹æ´»å‹•è¼‰å…¥å¤±æ•—');
      }
      try {
        const fbRes = await callAPI(ACTION_MAP.getMyFeedback,{ lineId },{silent:true});
        const arr = fbRes.data || fbRes || [];
        $('#myFeedbackList').innerHTML = arr.length
          ? arr.map(f=>`
            <div class="activity-card">
              <div class="d-flex justify-content-between">
                <strong>${escapeHtml(f.activityName||'')}</strong>
                <span class="badge bg-warning text-dark">${f.rating||''}â˜…</span>
              </div>
              <div class="small text-muted">${fmtDate(f.createDate)}</div>
              <div class="mt-1 small">${escapeHtml(f.comment||'')}</div>
            </div>`).join('')
          : '<div class="small text-muted">å°šç„¡å›é¥‹</div>';
      } catch(e){
        $('#myFeedbackList').innerHTML = '<div class="small text-muted">å°šæœªå¯¦ä½œå›é¥‹ API</div>';
      }
    }

    $('#btnSubmitFeedback').addEventListener('click', async ()=>{
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      const actId = $('#fbActivitySelect').value;
      const rating = $('#fbRating').value;
      const comment = $('#fbComment').value.trim();
      if(!actId || !rating) return notify('è«‹é¸æ“‡æ´»å‹•èˆ‡è©•åˆ†','warn');
      try {
        await callAPI(ACTION_MAP.submitFeedback,{ lineId, activityId: actId, rating, comment });
        notify('å›é¥‹å·²é€å‡º','success');
        $('#fbRating').value='';
        $('#fbComment').value='';
        loadFeedbackModule();
      } catch(e){
        notify('å›é¥‹æäº¤å¤±æ•—ï¼š'+e.message,'error');
      }
    });

    /*********************************************************
     * å¾Œå°å„€è¡¨æ¿
     *********************************************************/
    async function loadAdminDashboard(){
      const statsWrap = $('#adminDashStats');
      statsWrap.innerHTML = `
        <div class="skeleton" style="height:110px;"></div>
        <div class="skeleton" style="height:110px;"></div>
        <div class="skeleton" style="height:110px;"></div>
        <div class="skeleton" style="height:110px;"></div>
        <div class="skeleton" style="height:110px;"></div>
        <div class="skeleton" style="height:110px;"></div>`;
      try {
        const res = await callAPI(ACTION_MAP.getDashboardData,{}, {silent:true});
        const d = res.data || res;
        const statTpl = (label,val,icon,grad) => `
          <div class="stat" style="border:0;background:linear-gradient(135deg,${grad});color:#fff;">
            <div class="label" style="color:rgba(255,255,255,.85)">${label}</div>
            <div class="value" style="font-size:1.7rem;">${escapeHtml(String(val||0))}</div>
            <div style="position:absolute;right:8px;top:8px;font-size:1.3rem;opacity:.25;"><i class="${icon}"></i></div>
          </div>`;
        statsWrap.innerHTML = `
          ${statTpl('ç¸½æœƒå“¡æ•¸', d.ç¸½æœƒå“¡æ•¸ ,'bi bi-people-fill','#28a745,#20c997')}
          ${statTpl('æœ¬æœˆææ¬¾', d.æœ¬æœˆææ¬¾ç¸½é¡ ,'bi bi-heart-fill','#dc3545,#b91c1c')}
          ${statTpl('ææ¬¾æ¬¡æ•¸', d.æœ¬æœˆææ¬¾æ¬¡æ•¸ ,'bi bi-cash-coin','#f59e0b,#d97706')}
          ${statTpl('é€²è¡Œä¸­æ´»å‹•', d.é€²è¡Œä¸­æ´»å‹• ,'bi bi-calendar-event','#6366f1,#4338ca')}
          ${statTpl('å¾…å¯©ææ¡ˆ', d.å¾…å¯©ææ¡ˆ ,'bi bi-file-text','#0ea5e9,#0369a1')}
          ${statTpl('å¾…å¯©æ†‘è­‰', d.å¾…å¯©æ†‘è­‰ ,'bi bi-receipt','#ec4899,#be185d')}
        `;
        $('#systemAlerts').innerHTML = `
          <li class="list-group-item small">æœ€å¾Œæ›´æ–°ï¼š${fmtDateTime(new Date())}</li>
          <li class="list-group-item small">æœ¬æœˆæ”¶æ“šï¼š${d.æœ¬æœˆæ”¶æ“šæ•¸ || 0}</li>
          <li class="list-group-item small text-muted">è‹¥æŸæ•¸å­—é¡¯ç¤º 0ï¼Œè«‹ç¢ºèªå¾Œç«¯æ¬„ä½æ˜¯å¦è¿”å›ã€‚</li>
        `;
      } catch(e){
        statsWrap.innerHTML = '<div class="col-12 text-danger small">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    /*********************************************************
     * è²¡å‹™äº¤æ˜“ / æ”¶æ“š
     *********************************************************/
    $('#txType').addEventListener('change', e=>{
      const val = e.target.value;
      const cat = $('#txCategory');
      if(val==='æ”¶å…¥'){
        cat.innerHTML = `
          <option value="">é¸æ“‡</option>
          <option value="æœƒè²»">æœƒè²»</option>
          <option value="ææ¬¾">ææ¬¾</option>
          <option value="æ´»å‹•æ”¶å…¥">æ´»å‹•æ”¶å…¥</option>
          <option value="æ”¿åºœè£œåŠ©">æ”¿åºœè£œåŠ©</option>
          <option value="å…¶ä»–æ”¶å…¥">å…¶ä»–æ”¶å…¥</option>`;
        $('#txReceiptBlock').classList.remove('hidden');
      } else if(val==='æ”¯å‡º'){
        cat.innerHTML = `
          <option value="">é¸æ“‡</option>
          <option value="æ´»å‹•è²»ç”¨">æ´»å‹•è²»ç”¨</option>
          <option value="è¾¦å…¬è²»ç”¨">è¾¦å…¬è²»ç”¨</option>
          <option value="äº¤é€šè²»">äº¤é€šè²»</option>
          <option value="é¤è²»">é¤è²»</option>
          <option value="å ´åœ°è²»">å ´åœ°è²»</option>
          <option value="å…¶ä»–æ”¯å‡º">å…¶ä»–æ”¯å‡º</option>`;
        $('#txReceiptBlock').classList.add('hidden');
      } else {
        cat.innerHTML = `<option value="">é¸æ“‡</option>`;
        $('#txReceiptBlock').classList.add('hidden');
      }
    });

    // é–‹ç«‹æ”¶æ“šéœ€æ±‚åˆ‡æ›
    $('#txNeedReceipt').addEventListener('change', e=>{
      if(e.target.checked){
        $('#txReceiptDetails').classList.remove('hidden');
      } else {
        $('#txReceiptDetails').classList.add('hidden');
      }
    });

    /*********************************************************
     * äº¤æ˜“è¡¨å–®é€å‡º
     *********************************************************/
    $('#formTransaction').addEventListener('submit', async e=>{
      e.preventDefault();
      const type = $('#txType').value;
      if(!type) return notify('è«‹é¸æ“‡äº¤æ˜“é¡å‹','warn');
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      const payload = {
        lineId,
        txDate: $('#txDate').value,
        txType: type,
        category: $('#txCategory').value,
        amount: parseInt($('#txAmount').value,10)||0,
        account: $('#txAccount').value,
        target: $('#txTarget').value.trim(),
        description: $('#txDesc').value.trim()
      };

      // æ”¶å…¥ä¸”æœ‰å‹¾é¸é–‹ç«‹æ”¶æ“š
      if(type==='æ”¶å…¥' && $('#txNeedReceipt').checked){
        payload.needReceipt = true;
        payload.receipt = {
          title: $('#rcName').value.trim(),
            email: $('#rcEmail').value.trim(),
            phone: $('#rcPhone').value.trim(),
            taxId: $('#rcTaxId').value.trim(),
            address: $('#rcAddress').value.trim(),
            sendNow: $('#rcSendNow').checked
        };
        // åŸºæœ¬æ¬„ä½ç°¡æ˜“é©—è­‰
        if(!payload.receipt.title){
          return notify('æ”¶æ“šæŠ¬é ­ä¸å¯ç©ºç™½','warn');
        }
      }

      try {
        await callAPI(ACTION_MAP.addTransactionWithReceipt, payload);
        notify('äº¤æ˜“å·²æ–°å¢','success');
        $('#formTransaction').reset();
        $('#txCategory').innerHTML = '<option value="">è«‹å…ˆé¸æ“‡é¡å‹</option>';
        $('#txReceiptDetails').classList.add('hidden');
        loadTransactions();
      } catch(err){
        notify('æ–°å¢å¤±æ•—ï¼š'+err.message,'error');
      }
    });

    $('#btnShowTransactionForm').addEventListener('click',()=>{
      $('#transactionFormWrap').classList.remove('hidden');
    });
    $('#btnHideTransactionForm').addEventListener('click',()=>{
      $('#transactionFormWrap').classList.add('hidden');
    });

    async function loadTransactions(){
      try {
        const res = await callAPI(ACTION_MAP.getTransactionList, {}, {silent:true});
        const list = res.data || res || [];
        const tbody = $('#txList');
        if(!list.length){
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">ç„¡è³‡æ–™</td></tr>';
          return;
        }
        tbody.innerHTML = list.map(t=>{
          const receiptBtn = t.receiptId
            ? `<button class="btn btn-sm btn-outline-info" data-view-receipt="${t.transactionId}"><i class="bi bi-file-earmark-text"></i></button>`
            : (t.txType==='æ”¶å…¥'
               ? `<button class="btn btn-sm btn-outline-success" data-gen-receipt="${t.transactionId}"><i class="bi bi-receipt-cutoff"></i></button>`
               : '');
          return `<tr>
            <td>${fmtDate(t.txDate)}</td>
            <td>${escapeHtml(t.txType||'')}</td>
            <td>${escapeHtml(t.category||'')}</td>
            <td class="${t.txType==='æ”¯å‡º'?'text-danger':'text-success'}">${numberFmt(t.amount)}</td>
            <td>${escapeHtml(t.target||'')}</td>
            <td>${t.receiptId? `<span class="badge bg-primary">${escapeHtml(t.receiptId)}</span>`:''}</td>
            <td class="text-nowrap d-flex gap-1">
              ${receiptBtn}
              <button class="btn btn-sm btn-outline-danger" data-del-tx="${t.transactionId}"><i class="bi bi-trash"></i></button>
            </td>
          </tr>`;
        }).join('');
        tbody.querySelectorAll('[data-del-tx]').forEach(b=>{
          b.addEventListener('click',()=>{
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤äº¤æ˜“ï¼Ÿ')) deleteTransaction(b.getAttribute('data-del-tx'));
          });
        });
        tbody.querySelectorAll('[data-gen-receipt]').forEach(b=>{
          b.addEventListener('click',()=> generateReceiptForTx(b.getAttribute('data-gen-receipt')));
        });
        tbody.querySelectorAll('[data-view-receipt]').forEach(b=>{
          b.addEventListener('click',()=> viewReceiptModal(b.getAttribute('data-view-receipt')));
        });
      } catch(e){
        $('#txList').innerHTML = '<tr><td colspan="7" class="text-center text-danger">è¼‰å…¥å¤±æ•—</td></tr>';
      }
    }

    async function deleteTransaction(transactionId){
      try {
        await callAPI(ACTION_MAP.deleteTransaction,{ transactionId });
        notify('å·²åˆªé™¤','success');
        loadTransactions();
      } catch(e){
        notify('åˆªé™¤å¤±æ•—ï¼š'+e.message,'error');
      }
    }

    async function generateReceiptForTx(transactionId){
      try {
        await callAPI(ACTION_MAP.createReceiptForTransaction,{ transactionId });
        notify('æ”¶æ“šå·²å»ºç«‹','success');
        loadTransactions();
      } catch(e){
        notify('å»ºç«‹æ”¶æ“šå¤±æ•—ï¼š'+e.message,'error');
      }
    }

    function viewReceiptModal(transactionId){
      // ç°¡æ˜“ï¼šç›´æ¥é‡æ–°æ•´ç†æ”¶æ“šåˆ—è¡¨ï¼Œæˆ–å¯å‘¼å«å–®ç­† APIï¼ˆæ­¤è™•ç•¥ï¼‰
      notify('å¯åœ¨æ”¶æ“šç®¡ç†ä¸­ä¸‹è¼‰æˆ–å¯„é€æ­¤æ”¶æ“š','info');
    }

    /*********************************************************
     * æ”¶æ“šç®¡ç†
     *********************************************************/
    $('#btnOpenReceiptTemplate').addEventListener('click', ()=>{
      const m = new bootstrap.Modal($('#modalReceiptTemplate'));
      loadReceiptTemplate();
      m.show();
    });

    async function loadReceiptTemplate(){
      try {
        const res = await callAPI(ACTION_MAP.getReceiptTemplate, {}, {silent:true});
        const tpl = res.data || res || {};
        $('#tplDocId').value = tpl.docId || '';
        $('#tplPrefix').value = tpl.prefix || 'RCP';
        $('#tplOrgName').value = tpl.orgName || '';
        $('#tplOrgPhone').value = tpl.orgPhone || '';
        $('#tplOrgAddress').value = tpl.orgAddress || '';
      } catch(e){
        notify('è®€å–æ¨¡æ¿å¤±æ•—','warn');
      }
    }

    $('#btnSaveReceiptTemplate').addEventListener('click', async ()=>{
      try {
        await callAPI(ACTION_MAP.saveReceiptTemplate,{
          docId: $('#tplDocId').value.trim(),
          prefix: $('#tplPrefix').value.trim(),
          orgName: $('#tplOrgName').value.trim(),
          orgPhone: $('#tplOrgPhone').value.trim(),
          orgAddress: $('#tplOrgAddress').value.trim()
        });
        notify('æ¨¡æ¿å·²å„²å­˜','success');
        bootstrap.Modal.getInstance($('#modalReceiptTemplate')).hide();
      } catch(e){
        notify('å„²å­˜å¤±æ•—ï¼š'+e.message,'error');
      }
    });

    $('#btnManualReceipt').addEventListener('click',()=>{
      $('#manualReceiptForm').classList.remove('hidden');
    });
    $('#btnCloseManualReceipt').addEventListener('click',()=>{
      $('#manualReceiptForm').classList.add('hidden');
    });

    $('#formManualReceipt').addEventListener('submit', async e=>{
      e.preventDefault();
      try {
        await callAPI(ACTION_MAP.createManualReceipt,{
          date: $('#mrDate').value,
          amount: parseInt($('#mrAmount').value,10)||0,
          category: $('#mrCategory').value,
          title: $('#mrTitle').value.trim(),
          email: $('#mrEmail').value.trim(),
          phone: $('#mrPhone').value.trim(),
          taxId: $('#mrTaxId').value.trim(),
          address: $('#mrAddress').value.trim(),
          sendNow: $('#mrSendNow').checked
        });
        notify('æ‰‹å‹•æ”¶æ“šå·²å»ºç«‹','success');
        $('#formManualReceipt').reset();
        loadReceipts();
      } catch(e){
        notify('å»ºç«‹å¤±æ•—ï¼š'+e.message,'error');
      }
    });

    async function loadReceipts(){
      try {
        const res = await callAPI(ACTION_MAP.getReceiptList, {}, {silent:true});
        const arr = res.data || res || [];
        const wrap = $('#receiptList');
        if(!arr.length){
          wrap.innerHTML = '<div class="text-muted small py-3">ç„¡æ”¶æ“šè³‡æ–™</div>';
          return;
        }
        wrap.innerHTML = `<div class="table-responsive" style="max-height:430px;">
          <table class="table table-sm table-hover align-middle">
            <thead class="table-light">
              <tr><th>æ”¶æ“šè™Ÿ</th><th>æ—¥æœŸ</th><th>é‡‘é¡</th><th>æŠ¬é ­</th><th>Email</th><th>ç‹€æ…‹</th><th></th></tr>
            </thead>
            <tbody>
              ${arr.map(r=>`
                <tr>
                  <td>${escapeHtml(r.receiptNo||'')}</td>
                  <td>${fmtDate(r.date)}</td>
                  <td>${numberFmt(r.amount)}</td>
                  <td>${escapeHtml(r.title||'')}</td>
                  <td>${escapeHtml(r.email||'')}</td>
                  <td>${escapeHtml(r.status||'')}</td>
                  <td class="text-nowrap d-flex gap-1">
                    <button class="btn btn-sm btn-outline-secondary" data-send-receipt="${r.receiptId}"><i class="bi bi-envelope"></i></button>
                    <button class="btn btn-sm btn-outline-primary" data-regenerate-receipt="${r.receiptId}"><i class="bi bi-arrow-repeat"></i></button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>`;
        wrap.querySelectorAll('[data-send-receipt]').forEach(b=>{
          b.addEventListener('click',()=> sendReceipt(b.getAttribute('data-send-receipt')));
        });
        wrap.querySelectorAll('[data-regenerate-receipt]').forEach(b=>{
          b.addEventListener('click',()=> regenerateReceipt(b.getAttribute('data-regenerate-receipt')));
        });
      } catch(e){
        $('#receiptList').innerHTML = '<div class="text-danger small">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function sendReceipt(receiptId){
      try {
        await callAPI(ACTION_MAP.sendReceipt,{ receiptId });
        notify('æ”¶æ“šå·²å¯„é€','success');
      } catch(e){
        notify('å¯„é€å¤±æ•—ï¼š'+e.message,'error');
      }
    }

    async function regenerateReceipt(receiptId){
      try {
        await callAPI(ACTION_MAP.regenerateReceiptPDF,{ receiptId });
        notify('PDF å·²é‡æ–°ç”¢ç”Ÿ','success');
      } catch(e){
        notify('é‡æ–°ç”¢ç”Ÿå¤±æ•—ï¼š'+e.message,'error');
      }
    }

    /*********************************************************
     * æœƒå“¡ç®¡ç†
     *********************************************************/
    async function loadMemberList(){
      try {
        const kw = $('#memberSearch').value.trim();
        const type = $('#memberTypeFilter').value;
        const res = await callAPI(ACTION_MAP.getMemberList,{
          keyword: kw,
          memberType: type
        }, {silent:true});
        const arr = res.data || res || [];
        const tbody = $('#memberList');
        if(!arr.length){
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ç„¡ç¬¦åˆè³‡æ–™</td></tr>';
          return;
        }
        tbody.innerHTML = arr.map(m=>`
          <tr>
            <td>${escapeHtml(m.realName||m.lineName||'')}</td>
            <td>${escapeHtml(m.phone||'')}</td>
            <td>${escapeHtml(m.memberType||'')}</td>
            <td>${fmtDate(m.registerDate)}</td>
            <td>${fmtDate(m.lastDonationDate)}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" data-view-member="${m.lineId}"><i class="bi bi-eye"></i></button>
            </td>
          </tr>
        `).join('');
        tbody.querySelectorAll('[data-view-member]').forEach(b=>{
          b.addEventListener('click', ()=> openMemberDetail(b.getAttribute('data-view-member')));
        });
      } catch(e){
        $('#memberList').innerHTML = '<tr><td colspan="6" class="text-danger text-center">è¼‰å…¥å¤±æ•—</td></tr>';
      }
    }

    async function openMemberDetail(lineId){
      try {
        const res = await callAPI(ACTION_MAP.getMemberDetail,{ lineId },{silent:true});
        const d = res.data || res || {};
        const html = `
          <div class="modal fade" id="modalMemberDetail" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="bi bi-person-badge me-1"></i>${escapeHtml(d.realName||d.lineName||'æœƒå“¡')}</h5>
                  <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <div class="border rounded p-2 small">
                        <strong>åŸºæœ¬è³‡æ–™</strong><br>
                        LINE IDï¼š${escapeHtml(d.lineId||'')}<br>
                        é¡åˆ¥ï¼š${escapeHtml(d.memberType||'')}<br>
                        é›»è©±ï¼š${escapeHtml(d.phone||'')}<br>
                        Emailï¼š${escapeHtml(d.email||'')}<br>
                        åœ°å€ï¼š${escapeHtml(d.address||'')}<br>
                      </div>
                    </div>
                    <div class="col-md-8">
                      <div class="border rounded p-2 small mb-2">
                        <strong>çµ±è¨ˆ</strong><br>
                        æ´»å‹•æ¬¡æ•¸ï¼š${d.activityCount||0}ã€€å¿—å·¥æ™‚æ•¸ï¼š${d.volunteerHours||0}ã€€ææ¬¾æ¬¡æ•¸ï¼š${d.donationCount||0}
                      </div>
                      <div class="border rounded p-2 small">
                        <strong>ç‹€æ…‹èª¿æ•´</strong><br>
                        <div class="d-flex gap-2 align-items-center mt-1">
                          <select id="mdStatus" class="form-select form-select-sm" style="max-width:160px;">
                            <option value="">é¸æ“‡ç‹€æ…‹</option>
                            <option value="active">active</option>
                            <option value="inactive">inactive</option>
                            <option value="blacklist">blacklist</option>
                          </select>
                          <button class="btn btn-sm btn-primary" id="btnSaveMemberStatus"><i class="bi bi-save me-1"></i>å„²å­˜</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">é—œé–‰</button>
                </div>
              </div>
            </div>
          </div>`;
        $('#dynamicModal').innerHTML = html;
        const modalEl = document.getElementById('modalMemberDetail');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        document.getElementById('btnSaveMemberStatus').addEventListener('click', async ()=>{
          const newStatus = document.getElementById('mdStatus').value;
          if(!newStatus) return notify('è«‹é¸æ“‡ç‹€æ…‹','warn');
          try {
            await callAPI(ACTION_MAP.updateMemberStatus,{ lineId, status: newStatus });
            notify('æœƒå“¡ç‹€æ…‹å·²æ›´æ–°','success');
            modal.hide();
            loadMemberList();
          } catch(e){
            notify('æ›´æ–°å¤±æ•—ï¼š'+e.message,'error');
          }
        });
      } catch(e){
        notify('è®€å–æœƒå“¡è©³ç´°å¤±æ•—ï¼š'+e.message,'error');
      }
    }

    $('#btnSearchMembers').addEventListener('click', loadMemberList);
    $('#btnExportMembers').addEventListener('click', ()=> exportData('æœƒå“¡è³‡æ–™'));

    /*********************************************************
     * æ´»å‹•ç®¡ç†ï¼ˆå¾Œå°ï¼‰
     *********************************************************/
    $('#btnShowActForm').addEventListener('click',()=>{
      $('#adminActFormWrap').classList.remove('hidden');
    });
    $('#btnCloseActForm').addEventListener('click',()=>{
      $('#adminActFormWrap').classList.add('hidden');
    });

    $('#formAdminActivity').addEventListener('submit', async e=>{
      e.preventDefault();
      try {
        await callAPI(ACTION_MAP.addActivity,{
          name: $('#admActName').value.trim(),
          type: $('#admActType').value,
          maxParticipants: parseInt($('#admActMax').value,10)||0,
          date: $('#admActDate').value,
          time: $('#admActTime').value,
          location: $('#admActLocation').value.trim(),
          description: $('#admActDesc').value.trim()
        });
        notify('æ´»å‹•å·²å»ºç«‹','success');
        $('#formAdminActivity').reset();
        loadAdminActivities();
      } catch(e){
        notify('å»ºç«‹æ´»å‹•å¤±æ•—ï¼š'+e.message,'error');
      }
    });

    async function loadAdminActivities(){
      try {
        const res = await callAPI(ACTION_MAP.getActivityList, {}, {silent:true});
        const arr = res.data || res || [];
        const wrap = $('#adminActList');
        if(!arr.length){
          wrap.innerHTML = '<div class="col-12 text-muted small py-3">å°šç„¡æ´»å‹•</div>';
          return;
        }
        wrap.innerHTML = arr.map(a=>`
          <div class="col-md-4">
            <div class="activity-card">
              <div class="d-flex justify-content-between">
                <strong>${escapeHtml(a.name||'æœªå‘½å')}</strong>
                <span class="badge ${a.status==='é–‹æ”¾å ±å'?'bg-success':'bg-secondary'}">${escapeHtml(a.status||'')}</span>
              </div>
              <div class="small text-muted">
                æ—¥æœŸï¼š${fmtDate(a.date)}<br>
                é¡å‹ï¼š${escapeHtml(a.type||'')}<br>
                äººæ•¸ï¼š${a.currentCount||0}/${a.maxParticipants||'âˆ'}
              </div>
              <div class="mt-2 d-flex gap-1">
                <button class="btn btn-sm btn-outline-primary" data-exp-act="${a.activityId}"><i class="bi bi-download"></i></button>
              </div>
            </div>
          </div>
        `).join('');
        wrap.querySelectorAll('[data-exp-act]').forEach(b=>{
          b.addEventListener('click',()=> exportActivityMembers(b.getAttribute('data-exp-act')));
        });
      } catch(e){
        $('#adminActList').innerHTML = '<div class="col-12 text-danger small">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function exportActivityMembers(activityId){
      try {
        const res = await callAPI(ACTION_MAP.exportActivityMembers,{ activityId });
        if(res && res.url){
          window.open(res.url,'_blank');
          notify('åŒ¯å‡ºå·²é–‹å§‹','success');
        } else {
          notify('å·²åŒ¯å‡ºï¼ˆè«‹æª¢æŸ¥å¾Œç«¯ç”Ÿæˆä½ç½®ï¼‰','info');
        }
      } catch(e){
        notify('åŒ¯å‡ºå¤±æ•—ï¼š'+e.message,'error');
      }
    }

    /*********************************************************
     * ææ¡ˆ
     *********************************************************/
    $('#btnShowProposalForm').addEventListener('click',()=>{
      $('#proposalFormWrap').classList.remove('hidden');
    });
    $('#btnCloseProposalForm').addEventListener('click',()=>{
      $('#proposalFormWrap').classList.add('hidden');
    });

    $('#formProposal').addEventListener('submit', async e=>{
      e.preventDefault();
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        await callAPI(ACTION_MAP.addProposal,{
          lineId,
          title: $('#propTitle').value.trim(),
          type: $('#propType').value,
          budget: $('#propBudget').value,
          deadline: $('#propDeadline').value,
          content: $('#propContent').value.trim()
        });
        notify('ææ¡ˆå·²æäº¤','success');
        $('#formProposal').reset();
        loadProposals();
      } catch(e){
        notify('æäº¤å¤±æ•—ï¼š'+e.message,'error');
      }
    });

    async function loadProposals(){
      try {
        const res = await callAPI(ACTION_MAP.getProposalList, {}, {silent:true});
        const arr = res.data || res || [];
        const wrap = $('#proposalList');
        if(!arr.length){
          wrap.innerHTML = '<div class="text-muted small py-3">ç„¡ææ¡ˆ</div>';
          return;
        }
        wrap.innerHTML = arr.map(p=>`
          <div class="activity-card">
            <div class="d-flex justify-content-between">
              <strong>${escapeHtml(p.title||'')}</strong>
              <span class="badge bg-${p.status==='å¯©æ ¸ä¸­'?'warning text-dark':'secondary'}">${escapeHtml(p.status||'')}</span>
            </div>
            <div class="small text-muted">
              é¡å‹ï¼š${escapeHtml(p.type||'')}ã€€
              é ç®—ï¼š${numberFmt(p.budget||0)}ã€€
              å»ºç«‹ï¼š${fmtDate(p.createDate)}
            </div>
            <div class="mt-1 small">${escapeHtml(p.content||'')}</div>
            <div class="mt-2 d-flex gap-2">
              <button class="btn btn-sm btn-outline-success" data-vote="yes" data-prop="${p.proposalId}">è´Šæˆ (${p.yes||0})</button>
              <button class="btn btn-sm btn-outline-danger" data-vote="no" data-prop="${p.proposalId}">åå° (${p.no||0})</button>
              <button class="btn btn-sm btn-outline-secondary" data-vote="abstain" data-prop="${p.proposalId}">æ£„æ¬Š (${p.abstain||0})</button>
            </div>
          </div>
        `).join('');
        wrap.querySelectorAll('[data-vote]').forEach(btn=>{
          btn.addEventListener('click',()=> voteProposal(btn.getAttribute('data-prop'), btn.getAttribute('data-vote')));
        });
      } catch(e){
        $('#proposalList').innerHTML = '<div class="text-danger small">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function voteProposal(proposalId, vote){
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        await callAPI(ACTION_MAP.voteProposal,{ lineId, proposalId, vote });
        notify('æŠ•ç¥¨æˆåŠŸ','success');
        loadProposals();
      } catch(e){
        notify('æŠ•ç¥¨å¤±æ•—ï¼š'+e.message,'error');
      }
    }

    /*********************************************************
     * æ”¯å‡ºå¯©æ ¸ï¼ˆå¾Œå°ï¼‰
     *********************************************************/
    $('#btnShowExpenseSubmit').addEventListener('click',()=>{
      $('#expenseSubmitWrap').classList.remove('hidden');
    });
    $('#btnCloseExpenseSubmit').addEventListener('click',()=>{
      $('#expenseSubmitWrap').classList.add('hidden');
    });

    $('#formExpenseSubmit').addEventListener('submit', async e=>{
      e.preventDefault();
      const f = document.getElementById('exFile');
      const file = f.files[0];
      try {
        // è‹¥å¾Œç«¯æ”¯æ´ base64 ä¸Šå‚³
        let fileData = '';
        if(file){
          fileData = await fileToBase64(file);
        }
        await callAPI(ACTION_MAP.addExpense,{
          date: $('#exDate').value,
          category: $('#exCategory').value,
          amount: parseInt($('#exAmount').value,10)||0,
          vendor: $('#exVendor').value.trim(),
          description: $('#exDesc').value.trim(),
          fileName: file? file.name : '',
          fileData
        });
        notify('æ”¯å‡ºæ†‘è­‰å·²æäº¤','success');
        $('#formExpenseSubmit').reset();
        loadExpenses();
      } catch(e){
        notify('æäº¤å¤±æ•—ï¼š'+e.message,'error');
      }
    });

    async function loadExpenses(){
      try {
        const res = await callAPI(ACTION_MAP.getExpenseList, {}, {silent:true});
        const arr = res.data || res || [];
        const wrap = $('#expenseList');
        if(!arr.length){
          wrap.innerHTML = '<div class="text-muted small py-3">ç„¡æ”¯å‡ºæ†‘è­‰</div>';
          return;
        }
        wrap.innerHTML = arr.map(ex=>`
          <div class="activity-card">
            <div class="d-flex justify-content-between">
              <strong>${escapeHtml(ex.category||'æ”¯å‡º')}</strong>
              <span class="badge bg-${ex.status==='å¾…å¯©æ ¸'?'warning text-dark': ex.status==='å·²æ ¸å‡†'?'success':'secondary'}">${escapeHtml(ex.status||'')}</span>
            </div>
            <div class="small text-muted">
              æ—¥æœŸï¼š${fmtDate(ex.date)}ã€€é‡‘é¡ï¼š${numberFmt(ex.amount)}ã€€å» å•†ï¼š${escapeHtml(ex.vendor||'')}
            </div>
            <div class="mt-1 small">${escapeHtml(ex.description||'')}</div>
            <div class="mt-2 d-flex gap-2">
              ${ex.status==='å¾…å¯©æ ¸'
                ? `<button class="btn btn-sm btn-outline-success" data-approve-exp="${ex.expenseId}"><i class="bi bi-check2-circle"></i></button>`
                : ''}
            </div>
          </div>
        `).join('');
        wrap.querySelectorAll('[data-approve-exp]').forEach(b=>{
          b.addEventListener('click',()=> approveExpense(b.getAttribute('data-approve-exp')));
        });
      } catch(e){
        $('#expenseList').innerHTML = '<div class="text-danger small">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function approveExpense(expenseId){
      try {
        await callAPI(ACTION_MAP.approveExpense,{ expenseId });
        notify('å·²æ ¸å‡†','success');
        loadExpenses();
      } catch(e){
        notify('æ ¸å‡†å¤±æ•—ï¼š'+e.message,'error');
      }
    }

    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = ()=> resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /*********************************************************
     * è‡¨æ™‚å‹•è­°
     *********************************************************/
    $('#btnShowMotionForm').addEventListener('click',()=>{
      $('#motionFormWrap').classList.remove('hidden');
    });
    $('#btnCloseMotionForm').addEventListener('click',()=>{
      $('#motionFormWrap').classList.add('hidden');
    });

    $('#formMotion').addEventListener('submit', async e=>{
      e.preventDefault();
      const lineId = debugLineId || (liffProfile && liffProfile.userId);
      try {
        await callAPI(ACTION_MAP.addMotion,{
          lineId,
          title: $('#moTitle').value.trim(),
          urgency: $('#moUrgency').value,
          deadline: $('#moDeadline').value,
          content: $('#moContent').value.trim(),
          reason: $('#moReason').value.trim()
        });
        notify('å‹•è­°å·²æå‡º','success');
        $('#formMotion').reset();
        loadMotions();
      } catch(e){
        notify('æå‡ºå¤±æ•—ï¼š'+e.message,'error');
      }
    });

    async function loadMotions(){
      try {
        const res = await callAPI(ACTION_MAP.getMotionList, {}, {silent:true});
        const arr = res.data || res || [];
        const wrap = $('#motionList');
        if(!arr.length){
          wrap.innerHTML = '<div class="text-muted small py-3">ç„¡å‹•è­°</div>';
          return;
        }
        wrap.innerHTML = arr.map(m=>`
          <div class="activity-card">
            <div class="d-flex justify-content-between">
              <strong>${escapeHtml(m.title||'')}</strong>
              <span class="badge bg-${m.urgency==='ç·Šæ€¥'?'danger': m.urgency==='é‡è¦'?'warning text-dark':'secondary'}">${escapeHtml(m.urgency||'')}</span>
            </div>
            <div class="small text-muted">
              æ±ºè­°æœŸé™ï¼š${fmtDate(m.deadline)}ã€€ç‹€æ…‹ï¼š${escapeHtml(m.status||'')}
            </div>
            <div class="mt-1 small">${escapeHtml(m.content||'')}</div>
            <div class="mt-1 small text-muted">ç†ç”±ï¼š${escapeHtml(m.reason||'')}</div>
            ${m.status==='å¾…è™•ç†'
              ? `<div class="mt-2 d-flex gap-2">
                  <button class="btn btn-sm btn-outline-success" data-motion-proc="pass" data-motion="${m.motionId}">é€šé</button>
                  <button class="btn btn-sm btn-outline-danger" data-motion-proc="reject" data-motion="${m.motionId}">å¦æ±º</button>
                </div>`
              : ''}
          </div>
        `).join('');
        wrap.querySelectorAll('[data-motion-proc]').forEach(b=>{
          b.addEventListener('click',()=> processMotion(b.getAttribute('data-motion'), b.getAttribute('data-motion-proc')));
        });
      } catch(e){
        $('#motionList').innerHTML = '<div class="text-danger small">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function processMotion(motionId, decision){
      try {
        await callAPI(ACTION_MAP.processMotion,{ motionId, decision });
        notify('å·²è™•ç†','success');
        loadMotions();
      } catch(e){
        notify('è™•ç†å¤±æ•—ï¼š'+e.message,'error');
      }
    }

    /*********************************************************
     * ç³»çµ±å·¥å…·
     *********************************************************/
    $('#btnBackupSystem').addEventListener('click', async ()=>{
      try {
        await callAPI(ACTION_MAP.backupSystem,{});
        notify('ç³»çµ±å‚™ä»½å·²å•Ÿå‹•','success');
      } catch(e){
        notify('å‚™ä»½å¤±æ•—ï¼š'+e.message,'error');
      }
    });

    $('#btnExportDataAll').addEventListener('click', ()=> exportData('å…¨éƒ¨è³‡æ–™'));
    document.querySelectorAll('.export-btn').forEach(b=>{
      b.addEventListener('click',()=> exportData(b.getAttribute('data-type')));
    });

    async function exportData(dataType){
      try {
        const res = await callAPI(ACTION_MAP.exportData,{ dataType });
        if(res && res.url){
          window.open(res.url,'_blank');
          notify('åŒ¯å‡ºå®Œæˆ','success');
        } else {
          notify('åŒ¯å‡ºè«‹æ±‚å·²é€å‡º','info');
        }
      } catch(e){
        notify('åŒ¯å‡ºå¤±æ•—ï¼š'+e.message,'error');
      }
    }

    $('#btnSendSystemNotice').addEventListener('click', async ()=>{
      const msg = prompt('è¼¸å…¥è¦ç™¼é€çš„ç³»çµ±é€šçŸ¥å…§å®¹');
      if(!msg) return;
      try {
        await callAPI(ACTION_MAP.sendSystemNotification,{ message: msg });
        notify('é€šçŸ¥å·²ç™¼é€','success');
      } catch(e){
        notify('ç™¼é€å¤±æ•—ï¼š'+e.message,'error');
      }
    });

    /*********************************************************
     * å€‹äººè³‡æ–™å„²å­˜
     *********************************************************/
    $('#btnSaveProfile').addEventListener('click', async ()=>{
      if(!currentUser) return;
      const payload = {
        lineId: currentUser.lineId,
        realName: $('#pfRealName').value.trim(),
        memberType: $('#pfMemberType').value,
        phone: $('#pfPhone').value.trim(),
        email: $('#pfEmail').value.trim(),
        birthday: $('#pfBirthday').value,
        address: $('#pfAddress').value.trim()
      };
      if(!payload.realName){
        return notify('çœŸå¯¦å§“åç‚ºå¿…å¡«','warn');
      }
      try {
        await callAPI(ACTION_MAP.updateProfile, payload);
        notify('è³‡æ–™å·²æ›´æ–°','success');
        loadUserProfile(!!debugLineId);
      } catch(e){
        notify('æ›´æ–°å¤±æ•—ï¼š'+e.message,'error');
      }
    });

    $('#btnReloadProfile').addEventListener('click', ()=>{
      loadUserProfile(!!debugLineId);
    });

    /*********************************************************
     * Portal åˆ‡æ›
     *********************************************************/
    function switchToAdmin(){
      if(!isAdmin){
        return notify('æ‚¨æ²’æœ‰å¾Œå°æ¬Šé™','warn');
      }
      $('#memberSections').classList.add('hidden');
      $('#adminSections').classList.remove('hidden');
      $('#memberNav').classList.add('hidden');
      $('#adminNav').classList.remove('hidden');
      showSection('admin-dashboard');
    }

    function switchToMember(){
      $('#memberSections').classList.remove('hidden');
      $('#adminSections').classList.add('hidden');
      $('#memberNav').classList.remove('hidden');
      $('#adminNav').classList.add('hidden');
      showSection('member-dashboard');
    }

    $('#navToAdmin').addEventListener('click', switchToAdmin);
    $('#btnSwitchPortal').addEventListener('click', ()=>{
      if(document.getElementById('adminSections').classList.contains('hidden')){
        switchToAdmin();
      } else {
        switchToMember();
      }
    });
    $('#navBackToMember').addEventListener('click', switchToMember);

    /*********************************************************
     * FABS / æ²å‹•
     *********************************************************/
    function handleFabVisibility(){
      const fabDonation = $('#fabAddDonation');
      const fabActivity = $('#fabAddActivity');
      if(currentSection==='member-finance'){
        fabDonation.classList.remove('hidden');
      } else {
        fabDonation.classList.add('hidden');
      }
      if(isAdmin && currentSection==='admin-activities'){
        fabActivity.classList.remove('hidden');
      } else {
        fabActivity.classList.add('hidden');
      }
    }

    $('#fabAddDonation').addEventListener('click', ()=>{
      new bootstrap.Modal($('#modalDonation')).show();
    });
    $('#fabAddActivity').addEventListener('click', ()=>{
      if(currentSection!=='admin-activities') return;
      $('#adminActFormWrap').classList.remove('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    });
    $('#fabScrollTop').addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));

    /*********************************************************
     * é‡æ–°è¼‰å…¥æŒ‰éˆ•
     *********************************************************/
    $('#btnRefreshMemberDash').addEventListener('click', loadMemberDashboard);
    $('#btnReloadActs').addEventListener('click', loadActivities);
    $('#btnReloadVolunteer').addEventListener('click', loadVolunteer);
    $('#btnReloadFeedback').addEventListener('click', loadFeedbackModule);
    $('#btnRefreshAdminDashboard').addEventListener('click', loadAdminDashboard);

    /*********************************************************
     * ç™»å‡º
     *********************************************************/
    $('#btnLogout').addEventListener('click', ()=>{
      if(CONFIG.DEBUG_NON_LIFF){
        debugLineId = null;
        currentUser = null;
        notify('å·²ç™»å‡ºï¼ˆDebugï¼‰','success');
        location.reload();
        return;
      }
      if(typeof liff !== 'undefined' && liff.isLoggedIn()){
        liff.logout();
      }
      location.reload();
    });

    /*********************************************************
     * åˆå§‹åŒ–
     *********************************************************/
    initTheme();
    document.addEventListener('DOMContentLoaded', ()=>{
      initApp();
    });
  </script>
</body>
</html>

       
