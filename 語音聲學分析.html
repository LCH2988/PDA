<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>èªéŸ³åˆ†æ APP</title>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
        background: #0a0e27;
        color: #fff;
        overflow-x: hidden;
        -webkit-user-select: none;
        user-select: none;
    }

    /* APP å®¹å™¨ */
    .app-container {
        max-width: 100vw;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* é ‚éƒ¨ç‹€æ…‹åˆ— */
    .status-bar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .status-bar h1 {
        font-size: 1.2em;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #28a745;
        box-shadow: 0 0 10px #28a745;
        animation: pulse 2s infinite;
    }

    .status-indicator.recording {
        background: #dc3545;
        box-shadow: 0 0 10px #dc3545;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* ä¸»è¦å…§å®¹å€ */
    .main-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 15px;
        padding-bottom: 80px;
        -webkit-overflow-scrolling: touch;
    }

    /* æ‚£è€…è³‡è¨Šå¡ç‰‡ */
    .patient-card {
        background: linear-gradient(135deg, #1a1f3a 0%, #2a2f4a 100%);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 15px;
        border: 2px solid #3a3f5a;
    }

    .patient-card h3 {
        color: #667eea;
        margin-bottom: 12px;
        font-size: 1em;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .patient-input {
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        border: 2px solid #3a3f5a;
        border-radius: 10px;
        background: #0f1329;
        color: white;
        font-size: 1em;
    }

    .patient-input:focus {
        outline: none;
        border-color: #667eea;
    }

    /* éŒ„éŸ³æ§åˆ¶å€ */
    .recording-control {
        background: linear-gradient(135deg, #1a1f3a 0%, #2a2f4a 100%);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 15px;
        text-align: center;
        border: 2px solid #3a3f5a;
    }

    .recording-timer {
        font-size: 2.5em;
        color: #667eea;
        font-weight: bold;
        margin-bottom: 15px;
        display: none;
    }

    .recording-timer.active {
        display: block;
        color: #dc3545;
        animation: pulse 1s infinite;
    }

    .record-button {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        font-size: 3em;
        cursor: pointer;
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
        transition: all 0.3s;
        margin: 0 auto 15px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .record-button:active {
        transform: scale(0.95);
    }

    .record-button.recording {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        animation: recordPulse 1.5s infinite;
    }

    @keyframes recordPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .control-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .control-btn {
        flex: 1;
        padding: 15px;
        border: none;
        border-radius: 12px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .control-btn.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .control-btn.success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .control-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .control-btn:active:not(:disabled) {
        transform: scale(0.95);
    }

    /* è³ªé‡è©•åˆ†åœ“ç’° */
    .quality-score {
        background: linear-gradient(135deg, #1a1f3a 0%, #2a2f4a 100%);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 15px;
        text-align: center;
        border: 2px solid #3a3f5a;
    }

    .quality-score h3 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 1.1em;
    }

    .score-ring {
        position: relative;
        width: 180px;
        height: 180px;
        margin: 0 auto 15px;
    }

    .score-ring svg {
        transform: rotate(-90deg);
    }

    .score-ring-bg {
        fill: none;
        stroke: #3a3f5a;
        stroke-width: 15;
    }

    .score-ring-progress {
        fill: none;
        stroke: url(#scoreGradient);
        stroke-width: 15;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.5s ease;
    }

    .score-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3em;
        font-weight: bold;
        color: #fff;
    }

    .score-label {
        font-size: 1.2em;
        color: #a0a5c0;
        margin-top: 10px;
    }

    /* æŒ‡æ¨™å¡ç‰‡ç¶²æ ¼ */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 15px;
    }

    .metric-card {
        background: linear-gradient(135deg, #1a1f3a 0%, #2a2f4a 100%);
        padding: 15px;
        border-radius: 12px;
        border: 2px solid #3a3f5a;
        position: relative;
        overflow: hidden;
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }

    .metric-card.warning::before {
        background: linear-gradient(90deg, #ffc107 0%, #ff9800 100%);
    }

    .metric-card.danger::before {
        background: linear-gradient(90deg, #dc3545 0%, #c82333 100%);
    }

    .metric-card.success::before {
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
    }

    .metric-icon {
        font-size: 1.8em;
        margin-bottom: 8px;
    }

    .metric-label {
        font-size: 0.85em;
        color: #a0a5c0;
        margin-bottom: 8px;
    }

    .metric-value {
        font-size: 2em;
        font-weight: bold;
        color: #fff;
        line-height: 1;
    }

    .metric-unit {
        font-size: 0.5em;
        color: #667eea;
        margin-left: 3px;
    }

    .metric-status {
        font-size: 0.8em;
        padding: 3px 10px;
        border-radius: 15px;
        display: inline-block;
        margin-top: 8px;
    }

    .metric-status.normal {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
        border: 1px solid #28a745;
    }

    .metric-status.warning {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border: 1px solid #ffc107;
    }

    .metric-status.danger {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
        border: 1px solid #dc3545;
    }

    /* æ³¢å½¢é¡¯ç¤º */
    .waveform-container {
        background: #1a1f3a;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 15px;
        border: 2px solid #3a3f5a;
    }

    .waveform-container h3 {
        color: #667eea;
        margin-bottom: 12px;
        font-size: 1em;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    canvas {
        width: 100% !important;
        height: 150px !important;
        background: #0f1329;
        border-radius: 10px;
    }

    /* é »è­œé¡¯ç¤º */
    .spectrum-container {
        background: #1a1f3a;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 15px;
        border: 2px solid #3a3f5a;
    }

    .spectrum-container h3 {
        color: #667eea;
        margin-bottom: 12px;
        font-size: 1em;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* é »ç‡å¸¶ */
    .frequency-bands {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-top: 12px;
    }

    .frequency-band {
        text-align: center;
        padding: 8px;
        background: #0f1329;
        border-radius: 8px;
    }

    .frequency-band-label {
        font-size: 0.7em;
        color: #a0a5c0;
        margin-bottom: 5px;
    }

    .frequency-band-value {
        font-size: 1em;
        font-weight: bold;
        color: #667eea;
    }

    .frequency-band-bar {
        height: 40px;
        background: #1a1f3a;
        border-radius: 4px;
        margin-top: 6px;
        position: relative;
        overflow: hidden;
    }

    .frequency-band-fill {
        position: absolute;
        bottom: 0;
        width: 100%;
        background: linear-gradient(to top, #667eea, #764ba2);
        transition: height 0.2s;
    }

    /* å»ºè­°é¢æ¿ */
    .suggestions-panel {
        background: linear-gradient(135deg, #1a1f3a 0%, #2a2f4a 100%);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 15px;
        border: 2px solid #667eea;
    }

    .suggestions-panel h3 {
        color: #667eea;
        margin-bottom: 12px;
        font-size: 1em;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .suggestion-item {
        background: rgba(102, 126, 234, 0.1);
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 10px;
        border-left: 3px solid #667eea;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        animation: slideIn 0.5s ease;
    }

    .suggestion-item.warning {
        border-left-color: #ffc107;
        background: rgba(255, 193, 7, 0.1);
    }

    .suggestion-item.danger {
        border-left-color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
    }

    .suggestion-item.success {
        border-left-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .suggestion-icon {
        font-size: 1.3em;
        flex-shrink: 0;
    }

    .suggestion-text {
        flex: 1;
        line-height: 1.5;
        font-size: 0.9em;
    }

    /* åº•éƒ¨å°èˆªåˆ— */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #1a1f3a 0%, #2a2f4a 100%);
        padding: 12px 20px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        border-top: 2px solid #3a3f5a;
        z-index: 100;
    }

    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        transition: all 0.3s;
        padding: 8px 15px;
        border-radius: 10px;
    }

    .nav-item:active {
        transform: scale(0.95);
    }

    .nav-item.active {
        background: rgba(102, 126, 234, 0.2);
    }

    .nav-icon {
        font-size: 1.5em;
    }

    .nav-label {
        font-size: 0.75em;
        color: #a0a5c0;
    }

    .nav-item.active .nav-label {
        color: #667eea;
    }

    /* é é¢åˆ‡æ› */
    .page {
        display: none;
    }

    .page.active {
        display: block;
    }

    /* é€²åº¦æ¢ */
    .progress-bar {
        background: #0f1329;
        height: 8px;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.3s;
        border-radius: 10px;
    }

    /* è¨­å®šé é¢ */
    .settings-item {
        background: #1a1f3a;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 2px solid #3a3f5a;
    }

    .settings-label {
        font-size: 1em;
        color: #a0a5c0;
    }

    .settings-value {
        color: #667eea;
        font-weight: bold;
    }

    /* æ­·å²è¨˜éŒ„å¡ç‰‡ */
    .history-card {
        background: #1a1f3a;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 12px;
        border: 2px solid #3a3f5a;
    }

    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .history-date {
        color: #667eea;
        font-weight: bold;
    }

    .history-score {
        font-size: 1.5em;
        font-weight: bold;
        color: #28a745;
    }

    .history-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-top: 10px;
    }

    .history-metric {
        text-align: center;
        padding: 8px;
        background: #0f1329;
        border-radius: 8px;
    }

    .history-metric-label {
        font-size: 0.75em;
        color: #a0a5c0;
    }

    .history-metric-value {
        font-size: 1.1em;
        font-weight: bold;
        color: #fff;
        margin-top: 3px;
    }

    /* è¼‰å…¥å‹•ç•« */
    .loading {
        display: none;
        text-align: center;
        padding: 20px;
    }

    .loading.active {
        display: block;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #3a3f5a;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Toast é€šçŸ¥ */
    .toast {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(102, 126, 234, 0.95);
        color: white;
        padding: 12px 20px;
        border-radius: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        z-index: 1000;
        display: none;
        animation: toastIn 0.3s ease;
    }

    .toast.show {
        display: block;
    }

    @keyframes toastIn {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    /* ç©ºç‹€æ…‹ */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #a0a5c0;
    }

    .empty-icon {
        font-size: 4em;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    .empty-text {
        font-size: 1.1em;
        margin-bottom: 10px;
    }

    .empty-subtext {
        font-size: 0.9em;
        opacity: 0.7;
    }

    /* å°è¢å¹•å„ªåŒ– */
    @media (max-width: 375px) {
        .metrics-grid {
            grid-template-columns: 1fr;
        }

        .metric-value {
            font-size: 1.8em;
        }

        .score-ring {
            width: 150px;
            height: 150px;
        }

        .score-value {
            font-size: 2.5em;
        }
    }

    /* æ©«å±æ¨¡å¼ */
    @media (orientation: landscape) and (max-height: 500px) {
        .record-button {
            width: 80px;
            height: 80px;
            font-size: 2em;
        }

        .recording-timer {
            font-size: 1.8em;
        }

        .score-ring {
            width: 120px;
            height: 120px;
        }
    }
</style>
</head>
<body>
<!-- Toast é€šçŸ¥ -->
<div class="toast" id="toast"></div>

<div class="app-container">
    <!-- é ‚éƒ¨ç‹€æ…‹åˆ— -->
    <div class="status-bar">
        <h1>
            <span>ğŸ™ï¸</span>
            <span>èªéŸ³åˆ†æ</span>
        </h1>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText" style="font-size: 0.9em;">å°±ç·’</span>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <div class="main-content">
        <!-- é¦–é  -->
        <div class="page active" id="homePage">
            <!-- æ‚£è€…è³‡è¨Š -->
            <div class="patient-card">
                <h3>ğŸ‘¤ æ‚£è€…è³‡è¨Š</h3>
                <input type="text" class="patient-input" id="patientName" placeholder="å§“å">
                <select class="patient-input" id="patientGender">
                    <option value="">é¸æ“‡æ€§åˆ¥</option>
                    <option value="male">ç”·æ€§</option>
                    <option value="female">å¥³æ€§</option>
                </select>
                <input type="number" class="patient-input" id="patientAge" placeholder="å¹´é½¡">
            </div>

            <!-- éŒ„éŸ³æ§åˆ¶ -->
            <div class="recording-control">
                <div class="recording-timer" id="recordingTimer">00:00</div>
                <button class="record-button" id="recordBtn">
                    <span id="recordIcon">ğŸ”´</span>
                </button>
                <div style="color: #a0a5c0; margin-bottom: 15px;" id="recordHint">
                    é»æ“Šé–‹å§‹éŒ„éŸ³
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="recordProgress" style="width: 0%"></div>
                </div>
                <div class="control-buttons">
                    <button class="control-btn primary" id="playBtn" disabled>
                        <span>â–¶ï¸</span> æ’­æ”¾
                    </button>
                    <button class="control-btn success" id="analyzeBtn" disabled>
                        <span>ğŸ“Š</span> åˆ†æ
                    </button>
                </div>
            </div>

            <!-- è³ªé‡è©•åˆ† -->
            <div class="quality-score">
                <h3>ğŸ¯ èªéŸ³è³ªé‡è©•åˆ†</h3>
                <div class="score-ring">
                    <svg width="180" height="180">
                        <defs>
                            <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle class="score-ring-bg" cx="90" cy="90" r="75"></circle>
                        <circle class="score-ring-progress" id="scoreProgress" cx="90" cy="90" r="75" 
                                stroke-dasharray="471.24" stroke-dashoffset="471.24"></circle>
                    </svg>
                    <div class="score-value" id="scoreValue">--</div>
                </div>
                <div class="score-label" id="scoreLabel">ç­‰å¾…æ¸¬é‡</div>
            </div>

            <!-- å»ºè­°é¢æ¿ -->
            <div class="suggestions-panel">
                <h3>ğŸ’¡ å³æ™‚å»ºè­°</h3>
                <div id="suggestionsContainer">
                    <div class="suggestion-item">
                        <div class="suggestion-icon">â„¹ï¸</div>
                        <div class="suggestion-text">
                            è«‹åœ¨å®‰éœç’°å¢ƒä¸­é€²è¡Œæ¸¬è©¦ï¼Œéº¥å…‹é¢¨è·é›¢å˜´å·´ç´„ 30 å…¬åˆ†
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•¸æ“šé é¢ -->
        <div class="page" id="dataPage">
            <h2 style="color: #667eea; margin-bottom: 15px; font-size: 1.3em;">ğŸ“Š è²å­¸æ•¸æ“š</h2>
            
            <!-- æŒ‡æ¨™å¡ç‰‡ -->
            <div class="metrics-grid">
                <div class="metric-card" id="f0Card">
                    <div class="metric-icon">ğŸµ</div>
                    <div class="metric-label">åŸºæœ¬é »ç‡ (F0)</div>
                    <div class="metric-value">
                        <span id="f0Value">--</span>
                        <span class="metric-unit">Hz</span>
                    </div>
                    <span class="metric-status normal" id="f0Status">å¾…æ¸¬é‡</span>
                </div>

                <div class="metric-card" id="splCard">
                    <div class="metric-icon">ğŸ”Š</div>
                    <div class="metric-label">è²éŸ³éŸ¿åº¦ (SPL)</div>
                    <div class="metric-value">
                        <span id="splValue">--</span>
                        <span class="metric-unit">dB</span>
                    </div>
                    <span class="metric-status normal" id="splStatus">å¾…æ¸¬é‡</span>
                </div>

                <div class="metric-card" id="jitterCard">
                    <div class="metric-icon">ã€°ï¸</div>
                    <div class="metric-label">å—“éŸ³æ“¾å‹•</div>
                    <div class="metric-value">
                        <span id="jitterValue">--</span>
                        <span class="metric-unit">%</span>
                    </div>
                    <span class="metric-status normal" id="jitterStatus">å¾…æ¸¬é‡</span>
                </div>

                <div class="metric-card" id="shimmerCard">
                    <div class="metric-icon">ğŸ“¶</div>
                    <div class="metric-label">æŒ¯å¹…æ“¾å‹•</div>
                    <div class="metric-value">
                        <span id="shimmerValue">--</span>
                        <span class="metric-unit">%</span>
                    </div>
                    <span class="metric-status normal" id="shimmerStatus">å¾…æ¸¬é‡</span>
                </div>

                <div class="metric-card" id="hnrCard">
                    <div class="metric-icon">âœ¨</div>
                    <div class="metric-label">è«§å™ªæ¯” (HNR)</div>
                    <div class="metric-value">
                        <span id="hnrValue">--</span>
                        <span class="metric-unit">dB</span>
                    </div>
                    <span class="metric-status normal" id="hnrStatus">å¾…æ¸¬é‡</span>
                </div>

                <div class="metric-card" id="mptCard">
                    <div class="metric-icon">â±ï¸</div>
                    <div class="metric-label">ç™¼è²æ™‚é–“</div>
                    <div class="metric-value">
                        <span id="mptValue">--</span>
                        <span class="metric-unit">ç§’</span>
                    </div>
                    <span class="metric-status normal" id="mptStatus">å¾…æ¸¬é‡</span>
                </div>
            </div>

            <!-- æ³¢å½¢åœ– -->
            <div class="waveform-container">
                <h3>ğŸ“Š å³æ™‚æ³¢å½¢</h3>
                <canvas id="waveformCanvas"></canvas>
            </div>

            <!-- é »è­œåœ– -->
            <div class="spectrum-container">
                <h3>ğŸŒˆ é »è­œåˆ†æ</h3>
                <canvas id="spectrumCanvas"></canvas>
                <div class="frequency-bands">
                    <div class="frequency-band">
                        <div class="frequency-band-label">ä½é »</div>
                        <div class="frequency-band-value" id="lowFreq">0</div>
                        <div class="frequency-band-bar">
                            <div class="frequency-band-fill" id="lowFreqBar"></div>
                        </div>
                    </div>
                    <div class="frequency-band">
                        <div class="frequency-band-label">ä¸­ä½</div>
                        <div class="frequency-band-value" id="midLowFreq">0</div>
                        <div class="frequency-band-bar">
                            <div class="frequency-band-fill" id="midLowFreqBar"></div>
                        </div>
                    </div>
                    <div class="frequency-band">
                        <div class="frequency-band-label">ä¸­é«˜</div>
                        <div class="frequency-band-value" id="midHighFreq">0</div>
                        <div class="frequency-band-bar">
                            <div class="frequency-band-fill" id="midHighFreqBar"></div>
                        </div>
                    </div>
                    <div class="frequency-band">
                        <div class="frequency-band-label">é«˜é »</div>
                        <div class="frequency-band-value" id="highFreq">0</div>
                        <div class="frequency-band-bar">
                            <div class="frequency-band-fill" id="highFreqBar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­·å²è¨˜éŒ„é é¢ -->
        <div class="page" id="historyPage">
            <h2 style="color: #667eea; margin-bottom: 15px; font-size: 1.3em;">ğŸ“‹ æ­·å²è¨˜éŒ„</h2>
            <div id="historyContainer">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“­</div>
                    <div class="empty-text">å°šç„¡æ­·å²è¨˜éŒ„</div>
                    <div class="empty-subtext">å®Œæˆæ¸¬é‡å¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
                </div>
            </div>
        </div>

        <!-- è¨­å®šé é¢ -->
        <div class="page" id="settingsPage">
            <h2 style="color: #667eea; margin-bottom: 15px; font-size: 1.3em;">âš™ï¸ è¨­å®š</h2>
            
            <div class="settings-item">
                <div class="settings-label">æ¡æ¨£ç‡</div>
                <select class="patient-input" id="sampleRateSelect" style="width: auto; padding: 8px;">
                    <option value="44100">44.1 kHz</option>
                    <option value="48000" selected>48 kHz</option>
                </select>
            </div>

            <div class="settings-item">
                <div class="settings-label">è‡ªå‹•å„²å­˜</div>
                <label style="position: relative; display: inline-block; width: 50px; height: 26px;">
                    <input type="checkbox" id="autoSave" style="opacity: 0; width: 0; height: 0;">
                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a3f5a; transition: .4s; border-radius: 26px;"></span>
                    <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                </label>
            </div>

            <div class="settings-item">
                <div class="settings-label">éœ‡å‹•å›é¥‹</div>
                <label style="position: relative; display: inline-block; width: 50px; height: 26px;">
                    <input type="checkbox" id="vibration" checked style="opacity: 0; width: 0; height: 0;">
                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #667eea; transition: .4s; border-radius: 26px;"></span>
                    <span style="position: absolute; content: ''; height: 20px; width: 20px; right: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                </label>
            </div>

            <button class="control-btn primary" onclick="resetApp()" style="width: 100%; margin-top: 15px;">
                <span>ğŸ”„</span> é‡ç½®æ‡‰ç”¨ç¨‹å¼
            </button>

            <button class="control-btn success" onclick="exportData()" style="width: 100%; margin-top: 10px;">
                <span>ğŸ“¤</span> åŒ¯å‡ºè³‡æ–™
            </button>

            <div style="text-align: center; margin-top: 30px; color: #a0a5c0; font-size: 0.85em;">
                <p>èªéŸ³è²å­¸åˆ†æ APP v1.0</p>
                <p style="margin-top: 5px;">Â© 2025 All Rights Reserved</p>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªåˆ— -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('home')">
            <div class="nav-icon">ğŸ </div>
            <div class="nav-label">é¦–é </div>
        </div>
        <div class="nav-item" onclick="switchPage('data')">
            <div class="nav-icon">ğŸ“Š</div>
            <div class="nav-label">æ•¸æ“š</div>
        </div>
        <div class="nav-item" onclick="switchPage('history')">
            <div class="nav-icon">ğŸ“‹</div>
            <div class="nav-label">è¨˜éŒ„</div>
        </div>
        <div class="nav-item" onclick="switchPage('settings')">
            <div class="nav-icon">âš™ï¸</div>
            <div class="nav-label">è¨­å®š</div>
        </div>
    </div>
</div>

<script>
    // å…¨åŸŸè®Šæ•¸
    let audioContext;
    let analyser;
    let microphone;
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let isPlaying = false;
    let animationId;
    let recordingStartTime;
    let recordingInterval;
    let audioBuffer;
    let source;
    let historyData = [];

    // Canvas å…ƒç´ 
    const waveformCanvas = document.getElementById('waveformCanvas');
    const waveformCtx = waveformCanvas.getContext('2d');
    const spectrumCanvas = document.getElementById('spectrumCanvas');
    const spectrumCtx = spectrumCanvas.getContext('2d');

    // å³æ™‚æŒ‡æ¨™
    let realtimeMetrics = {
        f0: 0,
        spl: 0,
        jitter: 0,
        shimmer: 0,
        hnr: 0,
        mpt: 0
    };

    // åˆå§‹åŒ–
    window.onload = function() {
        resizeCanvas();
        initializeVisualizations();
        loadHistory();
        
        // é˜²æ­¢ä¸‹æ‹‰åˆ·æ–°
        document.body.addEventListener('touchmove', function(e) {
            if (e.target.closest('.main-content')) return;
            e.preventDefault();
        }, { passive: false });
    };

    window.onresize = resizeCanvas;

    function resizeCanvas() {
        waveformCanvas.width = waveformCanvas.offsetWidth;
        waveformCanvas.height = 150;
        spectrumCanvas.width = spectrumCanvas.offsetWidth;
        spectrumCanvas.height = 150;
    }

    function initializeVisualizations() {
        drawWaveform([]);
        drawSpectrum([]);
    }

    // é é¢åˆ‡æ›
    function switchPage(page) {
        const pages = document.querySelectorAll('.page');
        const navItems = document.querySelectorAll('.nav-item');
        
        pages.forEach(p => p.classList.remove('active'));
        navItems.forEach(n => n.classList.remove('active'));
        
        document.getElementById(page + 'Page').classList.add('active');
        event.currentTarget.classList.add('active');
        
        // éœ‡å‹•å›é¥‹
        if (navigator.vibrate && document.getElementById('vibration').checked) {
            navigator.vibrate(10);
        }
    }

    // Toast é€šçŸ¥
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 2000);
    }

    // éŒ„éŸ³æ§åˆ¶
    document.getElementById('recordBtn').addEventListener('click', async () => {
        if (!isRecording) {
            await startRecording();
        } else {
            stopRecording();
        }
    });

    async function startRecording() {
        try {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const stream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false
                }
            });

            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const arrayBuffer = await audioBlob.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                document.getElementById('playBtn').disabled = false;
                document.getElementById('analyzeBtn').disabled = false;
                
                stream.getTracks().forEach(track => track.stop());
                showToast('éŒ„éŸ³å®Œæˆï¼');
            };

            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);

            mediaRecorder.start();
            isRecording = true;
            recordingStartTime = Date.now();

            // æ›´æ–° UI
            document.getElementById('recordBtn').classList.add('recording');
            document.getElementById('recordIcon').textContent = 'â¹';
            document.getElementById('recordHint').textContent = 'éŒ„éŸ³ä¸­...';
            document.getElementById('statusIndicator').classList.add('recording');
            document.getElementById('statusText').textContent = 'éŒ„éŸ³ä¸­';
            document.getElementById('recordingTimer').classList.add('active');

            // éœ‡å‹•å›é¥‹
            if (navigator.vibrate && document.getElementById('vibration').checked) {
                navigator.vibrate(50);
            }

            visualizeRecording();
            startRealtimeAnalysis();
            startRecordingTimer();

        } catch (err) {
            showToast('ç„¡æ³•å­˜å–éº¥å…‹é¢¨');
            console.error(err);
        }
    }

    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            microphone.disconnect();
            isRecording = false;

            document.getElementById('recordBtn').classList.remove('recording');
            document.getElementById('recordIcon').textContent = 'ğŸ”´';
            document.getElementById('recordHint').textContent = 'é»æ“Šé–‹å§‹éŒ„éŸ³';
            document.getElementById('statusIndicator').classList.remove('recording');
            document.getElementById('statusText').textContent = 'å°±ç·’';
            document.getElementById('recordingTimer').classList.remove('active');

            cancelAnimationFrame(animationId);
            clearInterval(recordingInterval);
            stopRealtimeAnalysis();

            const duration = (Date.now() - recordingStartTime) / 1000;
            realtimeMetrics.mpt = duration;
            updateMetricCard('mpt', duration);

            // éœ‡å‹•å›é¥‹
            if (navigator.vibrate && document.getElementById('vibration').checked) {
                navigator.vibrate([50, 100, 50]);
            }
        }
    }

    function startRecordingTimer() {
        recordingInterval = setInterval(() => {
            const elapsed = (Date.now() - recordingStartTime) / 1000;
            const minutes = Math.floor(elapsed / 60);
            const seconds = Math.floor(elapsed % 60);
            document.getElementById('recordingTimer').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            const maxTime = 30;
            const progress = Math.min((elapsed / maxTime) * 100, 100);
            document.getElementById('recordProgress').style.width = progress + '%';
        }, 100);
    }

    function visualizeRecording() {
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        const freqArray = new Uint8Array(bufferLength);

        function draw() {
            if (!isRecording) return;
            animationId = requestAnimationFrame(draw);

            analyser.getByteTimeDomainData(dataArray);
            analyser.getByteFrequencyData(freqArray);

            drawWaveform(dataArray);
            drawSpectrum(freqArray);
            updateFrequencyBands(freqArray);
        }

        draw();
    }

    function drawWaveform(dataArray) {
        waveformCtx.fillStyle = '#0f1329';
        waveformCtx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);

        if (dataArray.length === 0) {
            waveformCtx.strokeStyle = '#3a3f5a';
            waveformCtx.lineWidth = 2;
            waveformCtx.beginPath();
            waveformCtx.moveTo(0, waveformCanvas.height / 2);
            waveformCtx.lineTo(waveformCanvas.width, waveformCanvas.height / 2);
            waveformCtx.stroke();
            return;
        }

        waveformCtx.lineWidth = 2;
        waveformCtx.strokeStyle = '#667eea';
        waveformCtx.beginPath();

        const sliceWidth = waveformCanvas.width / dataArray.length;
        let x = 0;

        for (let i = 0; i < dataArray.length; i++) {
            const v = dataArray[i] / 128.0;
            const y = v * waveformCanvas.height / 2;

            if (i === 0) {
                waveformCtx.moveTo(x, y);
            } else {
                waveformCtx.lineTo(x, y);
            }

            x += sliceWidth;
        }

        waveformCtx.lineTo(waveformCanvas.width, waveformCanvas.height / 2);
        waveformCtx.stroke();
    }

    function drawSpectrum(freqArray) {
        spectrumCtx.fillStyle = '#0f1329';
        spectrumCtx.fillRect(0, 0, spectrumCanvas.width, spectrumCanvas.height);

        if (freqArray.length === 0) return;

        const barWidth = (spectrumCanvas.width / freqArray.length) * 2.5;
        let x = 0;

        for (let i = 0; i < freqArray.length; i++) {
            const barHeight = (freqArray[i] / 255) * spectrumCanvas.height;
            
            const hue = (i / freqArray.length) * 360;
            spectrumCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
            spectrumCtx.fillRect(x, spectrumCanvas.height - barHeight, barWidth, barHeight);

            x += barWidth + 1;
        }
    }

    function updateFrequencyBands(freqArray) {
        if (freqArray.length === 0) return;

        const bands = [
            { id: 'low', start: 0, end: Math.floor(freqArray.length * 0.1) },
            { id: 'midLow', start: Math.floor(freqArray.length * 0.1), end: Math.floor(freqArray.length * 0.3) },
            { id: 'midHigh', start: Math.floor(freqArray.length * 0.3), end: Math.floor(freqArray.length * 0.6) },
            { id: 'high', start: Math.floor(freqArray.length * 0.6), end: freqArray.length }
        ];

        bands.forEach(band => {
            let sum = 0;
            for (let i = band.start; i < band.end; i++) {
                sum += freqArray[i];
            }
            const avg = Math.round(sum / (band.end - band.start));
            const percentage = (avg / 255) * 100;

            document.getElementById(`${band.id}Freq`).textContent = avg;
            document.getElementById(`${band.id}FreqBar`).style.height = percentage + '%';
        });
    }

    let analysisInterval;

    function startRealtimeAnalysis() {
        analysisInterval = setInterval(() => {
            if (!isRecording || !analyser) return;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const freqArray = new Uint8Array(bufferLength);

            analyser.getByteTimeDomainData(dataArray);
            analyser.getByteFrequencyData(freqArray);

            calculateRealtimeMetrics(dataArray, freqArray);
            updateAllMetrics();
            updateSuggestions();
        }, 200);
    }

    function stopRealtimeAnalysis() {
        if (analysisInterval) {
            clearInterval(analysisInterval);
        }
    }

    function calculateRealtimeMetrics(dataArray, freqArray) {
        const gender = document.getElementById('patientGender').value;

        let sum = 0, count = 0;
        for (let i = 0; i < freqArray.length; i++) {
            if (freqArray[i] > 0) {
                sum += i * freqArray[i];
                count += freqArray[i];
            }
        }
        if (count > 0 && audioContext) {
            const avgBin = sum / count;
            const nyquist = audioContext.sampleRate / 2;
            realtimeMetrics.f0 = (avgBin / freqArray.length) * nyquist;
        }

        let rmsSum = 0;
        for (let i = 0; i < dataArray.length; i++) {
            const normalized = (dataArray[i] - 128) / 128;
            rmsSum += normalized * normalized;
        }
        const rms = Math.sqrt(rmsSum / dataArray.length);
        realtimeMetrics.spl = Math.max(0, Math.min(120, 20 * Math.log10(rms / 0.00002) + 94));

        let variance = 0;
        const mean = dataArray.reduce((a, b) => a + b) / dataArray.length;
        for (let i = 0; i < dataArray.length; i++) {
            variance += Math.pow(dataArray[i] - mean, 2);
        }
        const stdDev = Math.sqrt(variance / dataArray.length);
        const stability = Math.max(0, 100 - (stdDev / mean * 100));

        let periodDiffs = 0;
        for (let i = 1; i < dataArray.length; i++) {
            if (dataArray[i-1] < 128 && dataArray[i] >= 128) {
                periodDiffs++;
            }
        }
        realtimeMetrics.jitter = Math.min(5, periodDiffs / dataArray.length * 100);

        const signalPower = rms * rms;
        const noisePower = variance / (dataArray.length * dataArray.length);
        realtimeMetrics.hnr = noisePower > 0 ? Math.min(40, 10 * Math.log10(signalPower / noisePower)) : 40;

        realtimeMetrics.shimmer = Math.min(10, (100 - stability) / 10);
    }

    function updateAllMetrics() {
        updateMetricCard('f0', realtimeMetrics.f0);
        updateMetricCard('spl', realtimeMetrics.spl);
        updateMetricCard('jitter', realtimeMetrics.jitter);
        updateMetricCard('shimmer', realtimeMetrics.shimmer);
        updateMetricCard('hnr', realtimeMetrics.hnr);

        updateQualityGauge();
    }

    function updateMetricCard(metric, value) {
        const valueElement = document.getElementById(`${metric}Value`);
        const statusElement = document.getElementById(`${metric}Status`);
        const cardElement = document.getElementById(`${metric}Card`);

        valueElement.textContent = value.toFixed(metric === 'mpt' ? 2 : 1);

        const gender = document.getElementById('patientGender').value;
        let status = 'normal';
        let statusText = 'æ­£å¸¸';

        switch(metric) {
            case 'f0':
                const f0Range = gender === 'male' ? [100, 150] : [180, 250];
                if (value < f0Range[0] || value > f0Range[1]) {
                    status = value < f0Range[0] * 0.8 || value > f0Range[1] * 1.2 ? 'danger' : 'warning';
                    statusText = status === 'danger' ? 'ç•°å¸¸' : 'æ³¨æ„';
                }
                break;
            case 'spl':
                const splRange = gender === 'male' ? [65, 75] : [60, 70];
                if (value < splRange[0] || value > splRange[1]) {
                    status = value < splRange[0] - 10 || value > splRange[1] + 10 ? 'danger' : 'warning';
                    statusText = status === 'danger' ? 'ç•°å¸¸' : 'æ³¨æ„';
                }
                break;
            case 'jitter':
                if (value >= 1.04) {
                    status = value > 2 ? 'danger' : 'warning';
                    statusText = status === 'danger' ? 'ç•°å¸¸' : 'æ³¨æ„';
                }
                break;
            case 'shimmer':
                if (value >= 3.81) {
                    status = value > 6 ? 'danger' : 'warning';
                    statusText = status === 'danger' ? 'ç•°å¸¸' : 'æ³¨æ„';
                }
                break;
            case 'hnr':
                if (value < 20) {
                    status = value < 10 ? 'danger' : 'warning';
                    statusText = status === 'danger' ? 'ä¸ä½³' : 'å°šå¯';
                } else {
                    statusText = 'å„ªè‰¯';
                }
                break;
            case 'mpt':
                const mptMin = gender === 'male' ? 20 : 15;
                if (value < mptMin) {
                    status = value < mptMin * 0.7 ? 'danger' : 'warning';
                    statusText = status === 'danger' ? 'ä¸è¶³' : 'åä½';
                }
                break;
        }

        statusElement.textContent = statusText;
        statusElement.className = `metric-status ${status}`;
        cardElement.className = `metric-card ${status}`;
    }

    function updateQualityGauge() {
        const gender = document.getElementById('patientGender').value;
        if (!gender) return;

        const f0Range = gender === 'male' ? [100, 150] : [180, 250];
        const splRange = gender === 'male' ? [65, 75] : [60, 70];

        let score = 0;

        if (realtimeMetrics.f0 >= f0Range[0] && realtimeMetrics.f0 <= f0Range[1]) {
            score += 20;
        } else {
            const deviation = Math.min(
                Math.abs(realtimeMetrics.f0 - f0Range[0]),
                Math.abs(realtimeMetrics.f0 - f0Range[1])
            );
            score += Math.max(0, 20 - deviation / 10);
        }

        if (realtimeMetrics.spl >= splRange[0] && realtimeMetrics.spl <= splRange[1]) {
            score += 20;
        } else {
            const deviation = Math.min(
                Math.abs(realtimeMetrics.spl - splRange[0]),
                Math.abs(realtimeMetrics.spl - splRange[1])
            );
            score += Math.max(0, 20 - deviation * 2);
        }

        score += Math.min(20, realtimeMetrics.hnr / 2);
        score += Math.max(0, 20 - realtimeMetrics.jitter * 10);
        score += Math.max(0, 20 - realtimeMetrics.shimmer * 2);

        score = Math.round(score);

        const scoreProgress = document.getElementById('scoreProgress');
        const scoreValue = document.getElementById('scoreValue');
        const scoreLabel = document.getElementById('scoreLabel');

        const circumference = 471.24;
        const offset = circumference - (score / 100) * circumference;

        scoreProgress.style.strokeDashoffset = offset;
        scoreValue.textContent = score;

        let label = '';
        if (score >= 90) label = 'å„ªç§€';
        else if (score >= 80) label = 'è‰¯å¥½';
        else if (score >= 70) label = 'ä¸­ç­‰';
        else if (score >= 60) label = 'åŠæ ¼';
        else label = 'éœ€æ”¹å–„';

        scoreLabel.textContent = label;
    }

    function updateSuggestions() {
        const container = document.getElementById('suggestionsContainer');
        const suggestions = [];
        const gender = document.getElementById('patientGender').value;

        if (!gender) return;

        const f0Range = gender === 'male' ? [100, 150] : [180, 250];
        const splRange = gender === 'male' ? [65, 75] : [60, 70];

        if (realtimeMetrics.f0 < f0Range[0]) {
            suggestions.push({
                type: 'warning',
                icon: 'â¬†ï¸',
                text: 'éŸ³é«˜åä½ï¼Œè«‹å˜—è©¦ç¨å¾®æé«˜éŸ³èª¿'
            });
        } else if (realtimeMetrics.f0 > f0Range[1]) {
            suggestions.push({
                type: 'warning',
                icon: 'â¬‡ï¸',
                text: 'éŸ³é«˜åé«˜ï¼Œè«‹å˜—è©¦æ”¾é¬†å–‰åš¨'
            });
        } else {
            suggestions.push({
                type: 'success',
                icon: 'âœ…',
                text: 'éŸ³é«˜æ§åˆ¶è‰¯å¥½'
            });
        }

        if (realtimeMetrics.spl < splRange[0]) {
            suggestions.push({
                type: 'warning',
                icon: 'ğŸ”Š',
                text: 'éŸ³é‡åå°ï¼Œè«‹ç¨å¾®å¢åŠ éŸ³é‡'
            });
        } else if (realtimeMetrics.spl > splRange[1]) {
            suggestions.push({
                type: 'warning',
                icon: 'ğŸ”‰',
                text: 'éŸ³é‡åå¤§ï¼Œè«‹é©åº¦é™ä½'
            });
        }

        if (realtimeMetrics.hnr < 15) {
            suggestions.push({
                type: 'danger',
                icon: 'âš ï¸',
                text: 'è²éŸ³å“è³ªéœ€æ”¹å–„ï¼Œè«‹ç¢ºä¿å–‰åš¨æ”¾é¬†'
            });
        }

        container.innerHTML = suggestions.map(s => `
            <div class="suggestion-item ${s.type}">
                <div class="suggestion-icon">${s.icon}</div>
                <div class="suggestion-text">${s.text}</div>
            </div>
        `).join('');
    }

    // æ’­æ”¾åŠŸèƒ½
    document.getElementById('playBtn').addEventListener('click', () => {
        if (!isPlaying && audioBuffer) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            source = audioContext.createBufferSource();
            source.buffer = audioBuffer;

            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;

            source.connect(analyser);
            analyser.connect(audioContext.destination);

            source.start(0);
            isPlaying = true;
            document.getElementById('playBtn').innerHTML = '<span>â¹</span> åœæ­¢';

              visualizePlaying();

              source.onended = () => {
                  isPlaying = false;
                  document.getElementById('playBtn').innerHTML = '<span>â–¶ï¸</span> æ’­æ”¾';
                  cancelAnimationFrame(animationId);
              };
          } else if (isPlaying) {
              source.stop();
              isPlaying = false;
              document.getElementById('playBtn').innerHTML = '<span>â–¶ï¸</span> æ’­æ”¾';
              cancelAnimationFrame(animationId);
          }
      });

      function visualizePlaying() {
          const bufferLength = analyser.frequencyBinCount;
          const dataArray = new Uint8Array(bufferLength);
          const freqArray = new Uint8Array(bufferLength);

          function draw() {
              if (!isPlaying) return;
              animationId = requestAnimationFrame(draw);

              analyser.getByteTimeDomainData(dataArray);
              analyser.getByteFrequencyData(freqArray);

              drawWaveform(dataArray);
              drawSpectrum(freqArray);
              updateFrequencyBands(freqArray);
          }

          draw();
      }

      // åˆ†æåŠŸèƒ½
      document.getElementById('analyzeBtn').addEventListener('click', () => {
          if (!audioBuffer) {
              showToast('è«‹å…ˆå®ŒæˆéŒ„éŸ³');
              return;
          }

          performFullAnalysis();
      });

      function performFullAnalysis() {
          const data = audioBuffer.getChannelData(0);
          const sampleRate = audioBuffer.sampleRate;

          const f0 = calculateF0(data, sampleRate);
          const spl = calculateSPL(data);
          const mpt = audioBuffer.duration;
          const jitter = calculateJitter(data, sampleRate);
          const shimmer = calculateShimmer(data);
          const hnr = calculateHNR(data, sampleRate);

          realtimeMetrics.f0 = f0;
          realtimeMetrics.spl = spl;
          realtimeMetrics.mpt = mpt;
          realtimeMetrics.jitter = jitter;
          realtimeMetrics.shimmer = shimmer;
          realtimeMetrics.hnr = hnr;

          updateAllMetrics();
          updateSuggestions();

          // å„²å­˜åˆ°æ­·å²è¨˜éŒ„
          saveToHistory();

          showToast('åˆ†æå®Œæˆï¼');

          // éœ‡å‹•å›é¥‹
          if (navigator.vibrate && document.getElementById('vibration').checked) {
              navigator.vibrate([100, 50, 100]);
          }
      }

      function calculateF0(data, sampleRate) {
          const minFreq = 50;
          const maxFreq = 500;
          const minPeriod = Math.floor(sampleRate / maxFreq);
          const maxPeriod = Math.floor(sampleRate / minFreq);

          let maxCorr = 0;
          let bestPeriod = 0;

          for (let period = minPeriod; period < maxPeriod; period++) {
              let corr = 0;
              for (let i = 0; i < data.length - period; i++) {
                  corr += data[i] * data[i + period];
              }
              if (corr > maxCorr) {
                  maxCorr = corr;
                  bestPeriod = period;
              }
          }

          return bestPeriod > 0 ? sampleRate / bestPeriod : 0;
      }

      function calculateSPL(data) {
          let sum = 0;
          for (let i = 0; i < data.length; i++) {
              sum += data[i] * data[i];
          }
          const rms = Math.sqrt(sum / data.length);
          const spl = 20 * Math.log10(rms / 0.00002) + 94;
          return Math.max(0, Math.min(120, spl));
      }

      function calculateJitter(data, sampleRate) {
          const periods = extractPeriods(data, sampleRate);
          if (periods.length < 2) return 0;

          let sum = 0;
          for (let i = 1; i < periods.length; i++) {
              sum += Math.abs(periods[i] - periods[i - 1]);
          }
          const avgDiff = sum / (periods.length - 1);
          const avgPeriod = periods.reduce((a, b) => a + b) / periods.length;
          
          return (avgDiff / avgPeriod) * 100;
      }

      function calculateShimmer(data) {
          const windowSize = 1024;
          const amplitudes = [];

          for (let i = 0; i < data.length - windowSize; i += windowSize) {
              let max = 0;
              for (let j = 0; j < windowSize; j++) {
                  max = Math.max(max, Math.abs(data[i + j]));
              }
              amplitudes.push(max);
          }

          if (amplitudes.length < 2) return 0;

          let sum = 0;
          for (let i = 1; i < amplitudes.length; i++) {
              sum += Math.abs(amplitudes[i] - amplitudes[i - 1]);
          }
          const avgDiff = sum / (amplitudes.length - 1);
          const avgAmp = amplitudes.reduce((a, b) => a + b) / amplitudes.length;

          return (avgDiff / avgAmp) * 100;
      }

      function calculateHNR(data, sampleRate) {
          const f0 = calculateF0(data, sampleRate);
          if (f0 === 0) return 0;

          const period = Math.floor(sampleRate / f0);
          let harmonicPower = 0;
          let noisePower = 0;

          for (let i = 0; i < data.length - period; i++) {
              const predicted = data[i + period];
              const actual = data[i];
              harmonicPower += predicted * predicted;
              noisePower += (actual - predicted) * (actual - predicted);
          }

          if (noisePower === 0) return 40;
          const hnr = 10 * Math.log10(harmonicPower / noisePower);
          return Math.max(0, Math.min(40, hnr));
      }

      function extractPeriods(data, sampleRate) {
          const periods = [];
          const threshold = 0.3;
          let lastZeroCrossing = 0;

          for (let i = 1; i < data.length; i++) {
              if (data[i - 1] < 0 && data[i] >= 0 && Math.abs(data[i]) > threshold) {
                  if (lastZeroCrossing > 0) {
                      periods.push(i - lastZeroCrossing);
                  }
                  lastZeroCrossing = i;
              }
          }

          return periods;
      }

      // æ­·å²è¨˜éŒ„åŠŸèƒ½
      function saveToHistory() {
          const gender = document.getElementById('patientGender').value;
          if (!gender) {
              showToast('è«‹å…ˆå¡«å¯«æ€§åˆ¥');
              return;
          }

          const f0Range = gender === 'male' ? [100, 150] : [180, 250];
          const splRange = gender === 'male' ? [65, 75] : [60, 70];

          let score = 0;
          if (realtimeMetrics.f0 >= f0Range[0] && realtimeMetrics.f0 <= f0Range[1]) score += 20;
          if (realtimeMetrics.spl >= splRange[0] && realtimeMetrics.spl <= splRange[1]) score += 20;
          score += Math.min(20, realtimeMetrics.hnr / 2);
          score += Math.max(0, 20 - realtimeMetrics.jitter * 10);
          score += Math.max(0, 20 - realtimeMetrics.shimmer * 2);

          const record = {
              id: Date.now(),
              date: new Date().toLocaleString('zh-TW'),
              name: document.getElementById('patientName').value || 'æœªå‘½å',
              gender: gender,
              age: document.getElementById('patientAge').value || '--',
              score: Math.round(score),
              metrics: { ...realtimeMetrics }
          };

          historyData.unshift(record);
          
          // é™åˆ¶æœ€å¤šä¿å­˜ 20 ç­†è¨˜éŒ„
          if (historyData.length > 20) {
              historyData = historyData.slice(0, 20);
          }

          localStorage.setItem('voiceAnalysisHistory', JSON.stringify(historyData));
          displayHistory();
      }

      function loadHistory() {
          const saved = localStorage.getItem('voiceAnalysisHistory');
          if (saved) {
              historyData = JSON.parse(saved);
              displayHistory();
          }
      }

      function displayHistory() {
          const container = document.getElementById('historyContainer');
          
          if (historyData.length === 0) {
              container.innerHTML = `
                  <div class="empty-state">
                      <div class="empty-icon">ğŸ“­</div>
                      <div class="empty-text">å°šç„¡æ­·å²è¨˜éŒ„</div>
                      <div class="empty-subtext">å®Œæˆæ¸¬é‡å¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
                  </div>
              `;
              return;
          }

          container.innerHTML = historyData.map(record => `
              <div class="history-card">
                  <div class="history-header">
                      <div>
                          <div class="history-date">${record.date}</div>
                          <div style="color: #a0a5c0; font-size: 0.9em; margin-top: 3px;">
                              ${record.name} | ${record.gender === 'male' ? 'ç”·' : 'å¥³'} | ${record.age}æ­²
                          </div>
                      </div>
                      <div class="history-score">${record.score}</div>
                  </div>
                  <div class="history-metrics">
                      <div class="history-metric">
                          <div class="history-metric-label">F0</div>
                          <div class="history-metric-value">${record.metrics.f0.toFixed(1)}</div>
                      </div>
                      <div class="history-metric">
                          <div class="history-metric-label">SPL</div>
                          <div class="history-metric-value">${record.metrics.spl.toFixed(1)}</div>
                      </div>
                      <div class="history-metric">
                          <div class="history-metric-label">HNR</div>
                          <div class="history-metric-value">${record.metrics.hnr.toFixed(1)}</div>
                      </div>
                      <div class="history-metric">
                          <div class="history-metric-label">Jitter</div>
                          <div class="history-metric-value">${record.metrics.jitter.toFixed(2)}</div>
                      </div>
                      <div class="history-metric">
                          <div class="history-metric-label">Shimmer</div>
                          <div class="history-metric-value">${record.metrics.shimmer.toFixed(2)}</div>
                      </div>
                      <div class="history-metric">
                          <div class="history-metric-label">MPT</div>
                          <div class="history-metric-value">${record.metrics.mpt.toFixed(1)}</div>
                      </div>
                  </div>
              </div>
          `).join('');
      }

      // é‡ç½®æ‡‰ç”¨ç¨‹å¼
      function resetApp() {
          if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
              if (isRecording) stopRecording();
              if (isPlaying) source.stop();

              audioBuffer = null;
              audioChunks = [];
              realtimeMetrics = { f0: 0, spl: 0, jitter: 0, shimmer: 0, hnr: 0, mpt: 0 };

              document.getElementById('patientName').value = '';
              document.getElementById('patientGender').value = '';
              document.getElementById('patientAge').value = '';
              document.getElementById('playBtn').disabled = true;
              document.getElementById('analyzeBtn').disabled = true;

              ['f0', 'spl', 'jitter', 'shimmer', 'hnr', 'mpt'].forEach(metric => {
                  document.getElementById(`${metric}Value`).textContent = '--';
                  document.getElementById(`${metric}Status`).textContent = 'å¾…æ¸¬é‡';
                  document.getElementById(`${metric}Status`).className = 'metric-status normal';
                  document.getElementById(`${metric}Card`).className = 'metric-card';
              });

              document.getElementById('scoreProgress').style.strokeDashoffset = '471.24';
              document.getElementById('scoreValue').textContent = '--';
              document.getElementById('scoreLabel').textContent = 'ç­‰å¾…æ¸¬é‡';
              document.getElementById('recordProgress').style.width = '0%';

              document.getElementById('suggestionsContainer').innerHTML = `
                  <div class="suggestion-item">
                      <div class="suggestion-icon">â„¹ï¸</div>
                      <div class="suggestion-text">
                          è«‹åœ¨å®‰éœç’°å¢ƒä¸­é€²è¡Œæ¸¬è©¦ï¼Œéº¥å…‹é¢¨è·é›¢å˜´å·´ç´„ 30 å…¬åˆ†
                      </div>
                  </div>
              `;

              initializeVisualizations();

              ['low', 'midLow', 'midHigh', 'high'].forEach(band => {
                  document.getElementById(`${band}Freq`).textContent = '0';
                  document.getElementById(`${band}FreqBar`).style.height = '0%';
              });

              showToast('æ‡‰ç”¨ç¨‹å¼å·²é‡ç½®');
          }
      }

      // åŒ¯å‡ºè³‡æ–™
      function exportData() {
          if (historyData.length === 0) {
              showToast('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
              return;
          }

          const data = {
              exportDate: new Date().toISOString(),
              totalRecords: historyData.length,
              records: historyData
          };

          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `voice_analysis_${Date.now()}.json`;
          a.click();
          URL.revokeObjectURL(url);

          showToast('è³‡æ–™å·²åŒ¯å‡º');
      }

      // é˜²æ­¢è¢å¹•ä¼‘çœ 
      let wakeLock = null;

      async function requestWakeLock() {
          try {
              if ('wakeLock' in navigator) {
                  wakeLock = await navigator.wakeLock.request('screen');
              }
          } catch (err) {
              console.log('Wake Lock error:', err);
          }
      }

      // éŒ„éŸ³æ™‚é˜²æ­¢ä¼‘çœ 
      document.getElementById('recordBtn').addEventListener('click', () => {
          if (!isRecording) {
              requestWakeLock();
          } else if (wakeLock) {
              wakeLock.release();
              wakeLock = null;
          }
      });

      // é é¢å¯è¦‹æ€§è®ŠåŒ–è™•ç†
      document.addEventListener('visibilitychange', () => {
          if (document.hidden && isRecording) {
              // é é¢éš±è—æ™‚ç¹¼çºŒéŒ„éŸ³
              console.log('App in background, recording continues');
          }
      });

      // é–‹é—œåˆ‡æ›æ•ˆæœ
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
              const slider = this.nextElementSibling;
              if (this.checked) {
                  slider.style.backgroundColor = '#667eea';
                  slider.nextElementSibling.style.transform = 'translateX(24px)';
              } else {
                  slider.style.backgroundColor = '#3a3f5a';
                  slider.nextElementSibling.style.transform = 'translateX(0)';
              }
          });
      });

      // åˆå§‹åŒ–é–‹é—œç‹€æ…‹
      document.getElementById('vibration').dispatchEvent(new Event('change'));

      console.log('%cğŸ™ï¸ èªéŸ³åˆ†æ APP å·²å•Ÿå‹•', 'font-size: 16px; font-weight: bold; color: #667eea;');
      console.log('ç‰ˆæœ¬: 1.0 | æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ');
  </script>
</body>
</html>
