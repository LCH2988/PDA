<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èªéŸ³è²å­¸åˆ†æç³»çµ± - å¢å¼·ç‰ˆ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px;
          font-size: 18px;
      }

      .container {
          max-width: 1400px;
          margin: 0 auto;
          background: white;
          border-radius: 20px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          overflow: hidden;
      }

      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 40px;
          text-align: center;
      }

      .header h1 {
          font-size: 3em;
          margin-bottom: 15px;
      }

      .header p {
          font-size: 1.4em;
          opacity: 0.9;
      }

      .content {
          padding: 40px;
      }

      .steps {
          display: flex;
          justify-content: space-between;
          margin-bottom: 50px;
          position: relative;
      }

      .steps::before {
          content: '';
          position: absolute;
          top: 30px;
          left: 0;
          right: 0;
          height: 3px;
          background: #e9ecef;
          z-index: 0;
      }

      .step {
          flex: 1;
          text-align: center;
          position: relative;
          z-index: 1;
      }

      .step-circle {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background: #e9ecef;
          color: #6c757d;
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 auto 15px;
          font-weight: bold;
          font-size: 1.5em;
          transition: all 0.3s;
      }

      .step.active .step-circle {
          background: #667eea;
          color: white;
          transform: scale(1.15);
      }

      .step.completed .step-circle {
          background: #28a745;
          color: white;
      }

      .step-label {
          font-size: 1.1em;
          color: #6c757d;
          font-weight: 600;
      }

      .step.active .step-label {
          color: #667eea;
          font-weight: bold;
      }

      .step-content {
          display: none;
          animation: fadeIn 0.5s;
      }

      .step-content.active {
          display: block;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .form-group {
          margin-bottom: 30px;
      }

      .form-group label {
          display: block;
          margin-bottom: 12px;
          color: #495057;
          font-weight: 700;
          font-size: 1.2em;
      }

      .form-group input,
      .form-group select {
          width: 100%;
          padding: 18px;
          border: 3px solid #e9ecef;
          border-radius: 10px;
          font-size: 1.2em;
          transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus {
          outline: none;
          border-color: #667eea;
      }

      .btn {
          padding: 18px 40px;
          font-size: 1.2em;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          transition: all 0.3s;
          font-weight: 700;
          margin-right: 15px;
          margin-bottom: 10px;
      }

      .btn-primary {
          background: #667eea;
          color: white;
      }

      .btn-primary:hover {
          background: #5568d3;
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
          background: #6c757d;
          color: white;
      }

      .btn-secondary:hover {
          background: #5a6268;
      }

      .btn-success {
          background: #28a745;
          color: white;
      }

      .btn-success:hover {
          background: #218838;
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
      }

      .btn-danger {
          background: #dc3545;
          color: white;
      }

      .btn-danger:hover {
          background: #c82333;
      }

      .btn:disabled {
          background: #6c757d;
          cursor: not-allowed;
          transform: none;
          opacity: 0.6;
      }

      .instruction-cards {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 25px;
          margin-bottom: 40px;
      }

      .instruction-card {
          background: #f8f9fa;
          border-left: 5px solid #667eea;
          padding: 25px;
          border-radius: 10px;
      }

      .instruction-card h3 {
          color: #667eea;
          margin-bottom: 20px;
          display: flex;
          align-items: center;
          gap: 10px;
          font-size: 1.4em;
      }

      .instruction-card ul {
          list-style: none;
          padding-left: 0;
      }

      .instruction-card li {
          padding: 12px 0;
          padding-left: 30px;
          position: relative;
          font-size: 1.1em;
          line-height: 1.6;
      }

      .instruction-card li::before {
          content: 'âœ“';
          position: absolute;
          left: 0;
          color: #28a745;
          font-weight: bold;
          font-size: 1.2em;
      }

      .instruction-card p {
          font-size: 1.1em;
          line-height: 1.8;
      }

      .measurement-panel {
          background: #f8f9fa;
          padding: 35px;
          border-radius: 12px;
          margin-bottom: 35px;
      }

      .control-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 25px;
          margin-bottom: 25px;
      }

      .control-box {
          background: white;
          padding: 25px;
          border-radius: 10px;
          border: 3px solid #e9ecef;
      }

      .control-box h4 {
          color: #495057;
          margin-bottom: 18px;
          font-size: 1.3em;
          font-weight: 700;
      }

      .canvas-container {
          margin: 25px 0;
          background: white;
          border-radius: 12px;
          padding: 25px;
          border: 3px solid #e9ecef;
      }

      .canvas-container h3 {
          color: #495057;
          margin-bottom: 20px;
          font-size: 1.4em;
          font-weight: 700;
      }

      canvas {
          width: 100%;
          height: 250px;
          background: white;
          border-radius: 10px;
          border: 2px solid #dee2e6;
      }

      .realtime-data {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
          gap: 20px;
          margin: 25px 0;
      }

      .data-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 25px;
          border-radius: 12px;
          text-align: center;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          transition: transform 0.3s;
      }

      .data-card:hover {
          transform: translateY(-5px);
      }

      .data-card h4 {
          font-size: 1.1em;
          opacity: 0.95;
          margin-bottom: 12px;
          font-weight: 600;
      }

      .data-card .value {
          font-size: 2.2em;
          font-weight: bold;
      }

      .data-card.warning {
          background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
      }

      .data-card.danger {
          background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      }

      .data-card.success {
          background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      }

      /* æ–°å¢ï¼šå³æ™‚åˆ†æé¢æ¿ */
      .realtime-analysis {
          background: white;
          border-radius: 12px;
          padding: 30px;
          margin: 25px 0;
          border: 3px solid #667eea;
      }

      .realtime-analysis h3 {
          color: #667eea;
          margin-bottom: 25px;
          font-size: 1.6em;
          display: flex;
          align-items: center;
          gap: 10px;
      }

      .analysis-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
      }

      .analysis-item {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 10px;
          border-left: 5px solid #667eea;
      }

      .analysis-item.warning {
          border-left-color: #ffc107;
          background: #fff3cd;
      }

      .analysis-item.danger {
          border-left-color: #dc3545;
          background: #f8d7da;
      }

      .analysis-item.success {
          border-left-color: #28a745;
          background: #d4edda;
      }

      .analysis-item h4 {
          font-size: 1.2em;
          margin-bottom: 10px;
          color: #495057;
      }

      .analysis-item .metric {
          font-size: 1.8em;
          font-weight: bold;
          color: #667eea;
          margin: 10px 0;
      }

      .analysis-item.warning .metric {
          color: #856404;
      }

      .analysis-item.danger .metric {
          color: #721c24;
      }

      .analysis-item.success .metric {
          color: #155724;
      }

      .analysis-item .status {
          font-size: 1em;
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 8px;
      }

      .analysis-item .suggestion {
          margin-top: 12px;
          font-size: 0.95em;
          line-height: 1.6;
          color: #6c757d;
      }

      /* æ–°å¢ï¼šå³æ™‚å»ºè­°é¢æ¿ */
      .live-suggestions {
          background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
          border-radius: 12px;
          padding: 25px;
          margin: 25px 0;
          border: 3px solid #2196f3;
      }

      .live-suggestions h3 {
          color: #1565c0;
          margin-bottom: 20px;
          font-size: 1.5em;
          display: flex;
          align-items: center;
          gap: 10px;
      }

      .suggestion-list {
          list-style: none;
          padding: 0;
      }

      .suggestion-list li {
          background: white;
          padding: 15px;
          margin-bottom: 12px;
          border-radius: 8px;
          border-left: 4px solid #2196f3;
          font-size: 1.1em;
          line-height: 1.6;
          display: flex;
          align-items: flex-start;
          gap: 12px;
      }

      .suggestion-list li::before {
          content: 'ğŸ’¡';
          font-size: 1.3em;
          flex-shrink: 0;
      }

      /* æ–°å¢ï¼šé€²åº¦æŒ‡ç¤ºå™¨ */
      .progress-indicator {
          background: white;
          border-radius: 12px;
          padding: 25px;
          margin: 25px 0;
          border: 3px solid #e9ecef;
      }

      .progress-indicator h4 {
          color: #495057;
          margin-bottom: 15px;
          font-size: 1.3em;
      }

      .progress-bar-container {
          background: #e9ecef;
          height: 30px;
          border-radius: 15px;
          overflow: hidden;
          position: relative;
      }

      .progress-bar {
          height: 100%;
          background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
          transition: width 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: bold;
      }

      .progress-bar.warning {
          background: linear-gradient(90deg, #ffc107 0%, #ff9800 100%);
      }

      .progress-bar.danger {
          background: linear-gradient(90deg, #dc3545 0%, #c82333 100%);
      }

      .progress-bar.success {
          background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
      }

      /* æ–°å¢ï¼šè³ªé‡è©•åˆ†å¡ */
      .quality-score {
          background: white;
          border-radius: 12px;
          padding: 30px;
          margin: 25px 0;
          text-align: center;
          border: 3px solid #667eea;
      }

      .quality-score h3 {
          color: #667eea;
          margin-bottom: 20px;
          font-size: 1.6em;
      }

      .score-circle {
          width: 200px;
          height: 200px;
          border-radius: 50%;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          margin: 0 auto 20px;
          color: white;
          box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }

      .score-circle .score {
          font-size: 4em;
          font-weight: bold;
      }

      .score-circle .label {
          font-size: 1.2em;
          opacity: 0.9;
      }

      .score-description {
          font-size: 1.2em;
          color: #6c757d;
          line-height: 1.8;
      }

      .results-table {
          width: 100%;
          border-collapse: collapse;
          margin: 25px 0;
          background: white;
          border-radius: 10px;
          overflow: hidden;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          font-size: 1.1em;
      }

      .results-table th,
      .results-table td {
          padding: 20px;
          text-align: left;
          border-bottom: 2px solid #e9ecef;
      }

      .results-table th {
          background: #667eea;
          color: white;
          font-weight: 700;
          font-size: 1.2em;
      }

      .results-table tr:hover {
          background: #f8f9fa;
      }

      .status-normal {
          color: #28a745;
          font-weight: bold;
          font-size: 1.2em;
      }

      .status-abnormal {
          color: #dc3545;
          font-weight: bold;
          font-size: 1.2em;
      }

      .status-banner {
          padding: 20px;
          border-radius: 10px;
          margin-bottom: 25px;
          font-weight: 700;
          text-align: center;
          font-size: 1.3em;
      }

      .status-banner.recording {
          background: #d4edda;
          color: #155724;
          border: 3px solid #c3e6cb;
      }

      .status-banner.analyzing {
          background: #d1ecf1;
          color: #0c5460;
          border: 3px solid #bee5eb;
      }

      .status-banner.completed {
          background: #d4edda;
          color: #155724;
          border: 3px solid #c3e6cb;
      }

      .measurement-stage {
          background: white;
          padding: 30px;
          border-radius: 12px;
          margin-bottom: 25px;
          border: 3px solid #667eea;
      }

      .measurement-stage h3 {
          color: #667eea;
          margin-bottom: 20px;
          font-size: 1.6em;
          font-weight: 700;
      }

      .measurement-stage .instruction {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 1.2em;
          line-height: 1.8;
      }

      .measurement-result {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin-top: 20px;
      }

      .result-item {
          background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
          color: white;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
      }

      .result-item h4 {
          font-size: 1.1em;
          margin-bottom: 10px;
          opacity: 0.95;
      }

      .result-item .value {
          font-size: 2em;
          font-weight: bold;
      }

      input[type="range"] {
          width: 100%;
          margin: 15px 0;
          height: 10px;
          border-radius: 5px;
          background: #d3d3d3;
          outline: none;
          -webkit-appearance: none;
      }

      input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          width: 25px;
          height: 25px;
          border-radius: 50%;
          background: #667eea;
          cursor: pointer;
      }

      input[type="range"]::-moz-range-thumb {
          width: 25px;
          height: 25px;
          border-radius: 50%;
          background: #667eea;
          cursor: pointer;
          border: none;
      }

      .value-display {
          text-align: center;
          font-size: 1.3em;
          color: #667eea;
          font-weight: bold;
          margin-top: 8px;
      }

      input[type="file"] {
          display: none;
      }

      .recommendation-box {
          background: #fff3cd;
          border-left: 5px solid #ffc107;
          padding: 25px;
          border-radius: 10px;
          margin: 35px 0;
      }

      .recommendation-box h3 {
          color: #856404;
          margin-bottom: 20px;
          font-size: 1.5em;
          font-weight: 700;
      }

      .recommendation-box div {
          line-height: 2;
          color: #856404;
          font-size: 1.15em;
      }

      @media (max-width: 768px) {
          body {
              font-size: 16px;
          }

          .header h1 {
              font-size: 2em;
          }

          .steps {
              flex-direction: column;
              gap: 20px;
          }

          .steps::before {
              display: none;
          }

          .score-circle {
              width: 150px;
              height: 150px;
          }

          .score-circle .score {
              font-size: 3em;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>ğŸ™ï¸ èªéŸ³è²å­¸åˆ†æç³»çµ±</h1>
          <p>å°ˆæ¥­èªéŸ³è©•ä¼° | å³æ™‚åˆ†æåé¥‹ | æ™ºèƒ½å»ºè­°ç³»çµ±</p>
      </div>

      <div class="content">
          <div class="steps">
              <div class="step active" data-step="1">
                  <div class="step-circle">1</div>
                  <div class="step-label">åŸºæœ¬è³‡æ–™</div>
              </div>
              <div class="step" data-step="2">
                  <div class="step-circle">2</div>
                  <div class="step-label">æ¸¬é‡èªªæ˜</div>
              </div>
              <div class="step" data-step="3">
                  <div class="step-circle">3</div>
                  <div class="step-label">èªéŸ³æ¸¬é‡</div>
              </div>
              <div class="step" data-step="4">
                  <div class="step-circle">4</div>
                  <div class="step-label">åˆ†æå ±å‘Š</div>
              </div>
          </div>

          <!-- æ­¥é©Ÿ 1: åŸºæœ¬è³‡æ–™ -->
          <div class="step-content active" data-step="1">
              <h2 style="margin-bottom: 40px; color: #495057; font-size: 2em;">ğŸ“‹ è«‹è¼¸å…¥å—æ¸¬è€…åŸºæœ¬è³‡æ–™</h2>
              
              <div style="max-width: 700px; margin: 0 auto;">
                  <div class="form-group">
                      <label>å§“å *</label>
                      <input type="text" id="patientName" placeholder="è«‹è¼¸å…¥å§“å" required>
                  </div>

                  <div class="form-group">
                      <label>æ€§åˆ¥ *</label>
                      <select id="patientGender" required>
                          <option value="">è«‹é¸æ“‡</option>
                          <option value="male">ç”·æ€§</option>
                          <option value="female">å¥³æ€§</option>
                      </select>
                  </div>

                  <div class="form-group">
                      <label>å¹´é½¡</label>
                      <input type="number" id="patientAge" placeholder="è«‹è¼¸å…¥å¹´é½¡" min="1" max="120">
                  </div>

                  <div class="form-group">
                      <label>æ¸¬é‡æ—¥æœŸ</label>
                      <input type="date" id="measurementDate">
                  </div>

                  <div class="form-group">
                      <label>å‚™è¨»</label>
                      <input type="text" id="notes" placeholder="å…¶ä»–éœ€è¦è¨˜éŒ„çš„è³‡è¨Š">
                  </div>

                  <div style="text-align: center; margin-top: 40px;">
                      <button class="btn btn-primary" onclick="goToStep(2)">ä¸‹ä¸€æ­¥ â†’</button>
                  </div>
              </div>
          </div>

          <!-- æ­¥é©Ÿ 2: æ¸¬é‡èªªæ˜ -->
          <div class="step-content" data-step="2">
              <h2 style="margin-bottom: 40px; color: #495057; font-size: 2em;">ğŸ“– æ¸¬é‡æ–¹æ³•èˆ‡èªªæ˜</h2>

              <div class="instruction-cards">
                  <div class="instruction-card">
                      <h3>ğŸ¯ æ¸¬é‡ç›®çš„</h3>
                      <p>
                          æœ¬ç³»çµ±ä¾æ“šè¡›ç”Ÿç¦åˆ©éƒ¨ã€Œèªè¨€æ²»ç™‚æœå‹™æ¨™æº–ä½œæ¥­è¦ç¯„ã€åŠå°ç£èªè¨€æ²»ç™‚å­¸æœƒåˆ¶å®šä¹‹æ¨™æº–ï¼Œ
                          å°å—æ¸¬è€…çš„å—“éŸ³é€²è¡Œå…¨é¢æ€§è²å­¸åˆ†æï¼Œè©•ä¼°è²å¸¶åŠŸèƒ½èˆ‡ç™¼è²å“è³ªã€‚
                      </p>
                  </div>

                  <div class="instruction-card">
                      <h3>ğŸ“ æ¸¬é‡é …ç›®</h3>
                      <ul>
                          <li>åŸºæœ¬é »ç‡ (F0): 100-250 Hz</li>
                          <li>è²éŸ³éŸ¿åº¦ (SPL): 60-75 dB</li>
                          <li>æœ€å¤§ç™¼è²æ™‚é–“ (MPT): â‰¥15-20ç§’</li>
                          <li>å—“éŸ³æ“¾å‹• (Jitter): <1.04%</li>
                          <li>æŒ¯å¹…æ“¾å‹• (Shimmer): <3.81%</li>
                          <li>è«§å™ªæ¯” (HNR): â‰¥20 dB</li>
                      </ul>
                  </div>

                  <div class="instruction-card">
                      <h3>ğŸ¤ æ¸¬é‡æ­¥é©Ÿ</h3>
                      <ul>
                          <li>ä¿æŒç’°å¢ƒå®‰éœï¼Œæ¸›å°‘èƒŒæ™¯å™ªéŸ³</li>
                          <li>éº¥å…‹é¢¨è·é›¢å˜´å·´ç´„ 30 å…¬åˆ†</li>
                          <li>ä»¥èˆ’é©éŸ³é‡æŒçºŒç™¼ã€Œå•Šã€éŸ³</li>
                          <li>ç›¡å¯èƒ½ç¶­æŒç©©å®šçš„éŸ³é«˜èˆ‡éŸ³é‡</li>
                          <li>ç³»çµ±å°‡åˆ†éšæ®µå¼•å°æ¸¬é‡</li>
                      </ul>
                  </div>

                  <div class="instruction-card">
                      <h3>âš ï¸ æ³¨æ„äº‹é …</h3>
                      <ul>
                          <li>æ¸¬é‡å‰é¿å…å¤§è²èªªè©±æˆ–å”±æ­Œ</li>
                          <li>èº«é«”ä¿æŒæ”¾é¬†ï¼Œè‡ªç„¶å‘¼å¸</li>
                          <li>å¦‚æ„Ÿåˆ°ä¸é©è«‹ç«‹å³åœæ­¢</li>
                          <li>æ¸¬é‡æ™‚ä¿æŒå§¿å‹¢ç©©å®š</li>
                          <li>ä¾ç…§æŒ‡ç¤ºå®Œæˆæ‰€æœ‰æ¸¬è©¦é …ç›®</li>
                      </ul>
                  </div>
              </div>

              <div style="text-align: center; margin-top: 40px;">
                  <button class="btn btn-secondary" onclick="goToStep(1)">â† ä¸Šä¸€æ­¥</button>
                  <button class="btn btn-primary" onclick="goToStep(3)">é–‹å§‹æ¸¬é‡ â†’</button>
              </div>
          </div>

          <!-- æ­¥é©Ÿ 3: èªéŸ³æ¸¬é‡ -->
          <div class="step-content" data-step="3">
              <h2 style="margin-bottom: 30px; color: #495057; font-size: 2em;">ğŸ™ï¸ èªéŸ³æ¸¬é‡</h2>

              <div id="statusBanner" class="status-banner" style="display: none;"></div>

              <!-- æ–°å¢ï¼šå³æ™‚è³ªé‡è©•åˆ† -->
              <div class="quality-score" id="qualityScore" style="display: none;">
                  <h3>ğŸ¯ å³æ™‚èªéŸ³è³ªé‡è©•åˆ†</h3>
                  <div class="score-circle" id="scoreCircle">
                      <div class="score" id="scoreValue">--</div>
                      <div class="label">åˆ†</div>
                  </div>
                  <div class="score-description" id="scoreDescription">
                      é–‹å§‹éŒ„éŸ³å¾Œå°‡é¡¯ç¤ºå³æ™‚è©•åˆ†
                  </div>
              </div>

              <!-- æ–°å¢ï¼šå³æ™‚åˆ†æé¢æ¿ -->
              <div class="realtime-analysis" id="realtimeAnalysis" style="display: none;">
                  <h3>ğŸ“Š å³æ™‚è²å­¸åˆ†æ</h3>
                  <div class="analysis-grid" id="analysisGrid">
                      <!-- å‹•æ…‹ç”Ÿæˆåˆ†æé …ç›® -->
                  </div>
              </div>

              <!-- æ–°å¢ï¼šå³æ™‚å»ºè­° -->
              <div class="live-suggestions" id="liveSuggestions" style="display: none;">
                  <h3>ğŸ’¡ å³æ™‚å»ºè­°èˆ‡æŒ‡å°</h3>
                  <ul class="suggestion-list" id="suggestionList">
                      <!-- å‹•æ…‹ç”Ÿæˆå»ºè­° -->
                  </ul>
              </div>

              <!-- æ¸¬é‡éšæ®µ -->
              <div id="stageContainer"></div>

              <div class="measurement-panel">
                  <div class="control-grid">
                      <div class="control-box">
                          <h4>ğŸ“¹ éŒ„éŸ³æ§åˆ¶</h4>
                          <button id="recordBtn" class="btn btn-danger" style="width: 100%;">é–‹å§‹éŒ„éŸ³</button>
                          <button id="playBtn" class="btn btn-primary" style="width: 100%; margin-top: 15px;" disabled>æ’­æ”¾éŒ„éŸ³</button>
                          <button id="downloadBtn" class="btn btn-success" style="width: 100%; margin-top: 15px;" disabled>ä¸‹è¼‰éŒ„éŸ³</button>
                      </div>

                      <div class="control-box">
                          <h4>ğŸ“ æª”æ¡ˆä¸Šå‚³</h4>
                          <button class="btn btn-primary" style="width: 100%;" onclick="document.getElementById('fileInput').click()">
                              ä¸Šå‚³éŸ³è¨Šæª”æ¡ˆ
                          </button>
                          <input type="file" id="fileInput" accept="audio/*">
                          <p style="margin-top: 15px; font-size: 1em; color: #6c757d;">
                              æ”¯æ´: MP3, WAV, OGG
                          </p>
                      </div>

                      <div class="control-box">
                          <h4>âš¡ æ’­æ”¾é€Ÿåº¦</h4>
                          <input type="range" id="speedControl" min="0.5" max="2" step="0.25" value="1">
                          <div class="value-display"><span id="speedValue">1.0</span>x</div>
                      </div>

                      <div class="control-box">
                          <h4>ğŸ”Š éŸ³é‡æ§åˆ¶</h4>
                          <input type="range" id="volumeControl" min="0" max="100" value="80">
                          <div class="value-display"><span id="volumeValue">80</span>%</div>
                      </div>
                  </div>

                  <div class="canvas-container">
                      <h3>ğŸ“Š æ³¢å½¢åœ– (Waveform)</h3>
                      <canvas id="waveformCanvas"></canvas>
                  </div>

                  <div class="canvas-container">
                      <h3>ğŸŒˆ é »è­œåœ– (Frequency Spectrum)</h3>
                      <canvas id="spectrumCanvas"></canvas>
                  </div>

                  <div class="realtime-data">
                      <div class="data-card" id="durationCard">
                          <h4>éŒ„éŸ³æ™‚é•·</h4>
                          <div class="value" id="duration">0.0s</div>
                      </div>
                      <div class="data-card">
                          <h4>æ¡æ¨£ç‡</h4>
                          <div class="value" id="sampleRate">-</div>
                      </div>
                      <div class="data-card" id="freqCard">
                          <h4>å³æ™‚é »ç‡</h4>
                          <div class="value" id="avgFreq">- Hz</div>
                      </div>
                      <div class="data-card" id="ampCard">
                          <h4>å³°å€¼æŒ¯å¹…</h4>
                          <div class="value" id="peakAmp">-</div>
                      </div>
                  </div>
              </div>

              <div style="text-align: center; margin-top: 40px;">
                  <button class="btn btn-secondary" onclick="goToStep(2)">â† ä¸Šä¸€æ­¥</button>
                  <button class="btn btn-success" onclick="analyzeAudio()">å®Œæˆæ¸¬é‡ä¸¦åˆ†æ â†’</button>
              </div>
          </div>

          <!-- æ­¥é©Ÿ 4: åˆ†æå ±å‘Š -->
          <div class="step-content" data-step="4">
              <h2 style="margin-bottom: 40px; color: #495057; font-size: 2em;">ğŸ“Š è²å­¸åˆ†æå ±å‘Š</h2>

              <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 35px;">
                  <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.5em;">å—æ¸¬è€…è³‡è¨Š</h3>
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; font-size: 1.15em;">
                      <div><strong>å§“å:</strong> <span id="reportName">-</span></div>
                      <div><strong>æ€§åˆ¥:</strong> <span id="reportGender">-</span></div>
                      <div><strong>å¹´é½¡:</strong> <span id="reportAge">-</span></div>
                      <div><strong>æ¸¬é‡æ—¥æœŸ:</strong> <span id="reportDate">-</span></div>
                  </div>
              </div>

              <!-- æ–°å¢ï¼šç¸½é«”è³ªé‡è©•åˆ† -->
              <div class="quality-score">
                  <h3>ğŸ† æ•´é«”èªéŸ³è³ªé‡è©•åˆ†</h3>
                  <div class="score-circle" id="finalScoreCircle">
                      <div class="score" id="finalScoreValue">--</div>
                      <div class="label">åˆ†</div>
                  </div>
                  <div class="score-description" id="finalScoreDescription">
                      ç¶œåˆè©•ä¼°çµæœ
                  </div>
              </div>

              <table class="results-table">
                  <thead>
                      <tr>
                          <th>è©•ä¼°é …ç›®</th>
                          <th>æ¸¬é‡å€¼</th>
                          <th>æ­£å¸¸ç¯„åœ</th>
                          <th>å–®ä½</th>
                          <th>è©•ä¼°çµæœ</th>
                      </tr>
                  </thead>
                  <tbody>
                      <tr>
                          <td>åŸºæœ¬é »ç‡ (F0)</td>
                          <td id="result_f0">-</td>
                          <td id="range_f0">-</td>
                          <td>Hz</td>
                          <td id="status_f0">-</td>
                      </tr>
                      <tr>
                          <td>è²éŸ³éŸ¿åº¦ (SPL)</td>
                          <td id="result_spl">-</td>
                          <td id="range_spl">-</td>
                          <td>dB</td>
                          <td id="status_spl">-</td>
                      </tr>
                      <tr>
                          <td>æœ€å¤§ç™¼è²æ™‚é–“ (MPT)</td>
                          <td id="result_mpt">-</td>
                          <td id="range_mpt">-</td>
                          <td>ç§’</td>
                          <td id="status_mpt">-</td>
                      </tr>
                      <tr>
                          <td>å—“éŸ³æ“¾å‹• (Jitter)</td>
                          <td id="result_jitter">-</td>
                          <td>< 1.04</td>
                          <td>%</td>
                          <td id="status_jitter">-</td>
                      </tr>
                      <tr>
                          <td>æŒ¯å¹…æ“¾å‹• (Shimmer)</td>
                          <td id="result_shimmer">-</td>
                          <td>< 3.81</td>
                          <td>%</td>
                          <td id="status_shimmer">-</td>
                      </tr>
                      <tr>
                          <td>è«§å™ªæ¯” (HNR)</td>
                          <td id="result_hnr">-</td>
                          <td>â‰¥ 20</td>
                          <td>dB</td>
                          <td id="status_hnr">-</td>
                      </tr>
                  </tbody>
              </table>

              <div class="recommendation-box">
                  <h3>ğŸ“ å°ˆæ¥­è©•ä¼°å»ºè­°</h3>
                  <div id="recommendations">
                      åˆ†æå®Œæˆå¾Œå°‡é¡¯ç¤ºå°ˆæ¥­å»ºè­°...
                  </div>
              </div>

              <div style="text-align: center; margin-top: 40px;">
                
              <button class="btn btn-secondary" onclick="goToStep(3)">â† è¿”å›æ¸¬é‡</button>
              <button class="btn btn-success" onclick="saveToGAS()">ğŸ’¾ å„²å­˜åˆ°é›²ç«¯</button>
              <button class="btn btn-success" onclick="generatePDF()">ğŸ“„ ç”Ÿæˆ PDF å ±å‘Š</button>
              <button class="btn btn-primary" onclick="searchPatient()">ğŸ” æœå°‹æ‚£è€…</button>
              <button class="btn btn-primary" onclick="resetSystem()">ğŸ”„ é–‹å§‹æ–°æ¸¬é‡</button>
              <div style="text-align: center; margin-top: 40px;">
              </div>

              </div>
          </div>
      </div>
  </div>

  <script>
        // ==================== API é€£æ¥è¨­å®š ====================
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzg68g10-xS8WyiTZK6274GTP4k_cMV2KJhtP86ekw4U_RN5nfjFp0frZSdXHnsRC7qaw/exec'; // éƒ¨ç½²å¾Œçš„ Web App URL

    // ========== API å‘¼å«å‡½æ•¸ ==========

    /**
     * å„²å­˜å®Œæ•´çš„åˆ†æçµæœåˆ° GAS
     */
    async function saveToGAS() {
        try {
            showStatus('ğŸ“¤ æ­£åœ¨å„²å­˜è³‡æ–™åˆ°é›²ç«¯...', 'analyzing');
            
            const patientData = {
                name: document.getElementById('patientName').value,
                gender: document.getElementById('patientGender').value,
                age: document.getElementById('patientAge').value,
                notes: document.getElementById('notes').value
            };
            
            // 1. å„²å­˜æ‚£è€…è³‡æ–™
            const patientResponse = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'savePatient',
                    data: patientData
                })
            });
            
            const patientResult = await patientResponse.json();
            
            if (!patientResult.success) {
                throw new Error(patientResult.message);
            }
            
            const patientId = patientResult.patientId;
            
            // 2. å„²å­˜æ¸¬é‡è¨˜éŒ„
            const measurementData = {
                patientId: patientId,
                measurementDate: document.getElementById('measurementDate').value,
                duration: audioBuffer ? audioBuffer.duration : 0,
                sampleRate: audioContext ? audioContext.sampleRate : 0
            };
            
            const measurementResponse = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'saveMeasurement',
                    data: measurementData
                })
            });
            
            const measurementResult = await measurementResponse.json();
            
            if (!measurementResult.success) {
                throw new Error(measurementResult.message);
            }
            
            const recordId = measurementResult.recordId;
            
            // 3. å„²å­˜åˆ†æçµæœ
            const analysisData = {
                recordId: recordId,
                patientId: patientId,
                measurementDate: document.getElementById('measurementDate').value,
                gender: patientData.gender,
                f0: measurementResults.f0,
                spl: measurementResults.spl,
                mpt: measurementResults.mpt,
                jitter: measurementResults.jitter,
                shimmer: measurementResults.shimmer,
                hnr: measurementResults.hnr,
                recommendations: document.getElementById('recommendations').innerText
            };
            
            const analysisResponse = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'saveAnalysis',
                    data: analysisData
                })
            });
            
            const analysisResult = await analysisResponse.json();
            
            if (!analysisResult.success) {
                throw new Error(analysisResult.message);
            }
            
            showStatus('âœ… è³‡æ–™å·²æˆåŠŸå„²å­˜åˆ°é›²ç«¯ï¼', 'completed');
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            alert(`è³‡æ–™å·²å„²å­˜ï¼\næ‚£è€…ID: ${patientId}\nè¨˜éŒ„ID: ${recordId}\nè©•åˆ†: ${analysisResult.score} / 100`);
            
            setTimeout(() => hideStatus(), 3000);
            
            return {
                success: true,
                patientId: patientId,
                recordId: recordId,
                analysisId: analysisResult.analysisId
            };
            
        } catch (error) {
            showStatus('âŒ å„²å­˜å¤±æ•—: ' + error.message, 'analyzing');
            alert('å„²å­˜è³‡æ–™å¤±æ•—: ' + error.message);
            setTimeout(() => hideStatus(), 5000);
            return { success: false, error: error.message };
        }
    }

    /**
     * å–å¾—æ‚£è€…æ­·å²è¨˜éŒ„
     */
    async function loadPatientHistory(patientId) {
        try {
            const response = await fetch(`${GAS_WEB_APP_URL}?action=getPatientHistory&patientId=${patientId}`);
            const result = await response.json();
            
            if (result.success) {
                displayHistory(result.data);
            } else {
                alert('è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—: ' + result.message);
            }
        } catch (error) {
            alert('è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—: ' + error.message);
        }
    }

    /**
     * æœå°‹æ‚£è€…
     */
    async function searchPatient() {
        const keyword = prompt('è«‹è¼¸å…¥æ‚£è€…å§“å:');
        if (!keyword) return;
        
        try {
            const response = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'searchPatients',
                    keyword: keyword
                })
            });
            
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                displaySearchResults(result.data);
            } else {
                alert('æ‰¾ä¸åˆ°ç¬¦åˆçš„æ‚£è€…');
            }
        } catch (error) {
            alert('æœå°‹å¤±æ•—: ' + error.message);
        }
    }

    /**
     * åŒ¯å‡ºå ±å‘Šåˆ° Google Docs
     */
    async function exportToGoogleDocs(recordId) {
        try {
            showStatus('ğŸ“„ æ­£åœ¨åŒ¯å‡ºå ±å‘Šåˆ° Google Docs...', 'analyzing');
            
            const response = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'exportReport',
                    recordId: recordId
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showStatus('âœ… å ±å‘Šå·²åŒ¯å‡ºï¼', 'completed');
                window.open(result.url, '_blank');
            } else {
                throw new Error(result.message);
            }
            
            setTimeout(() => hideStatus(), 3000);
            
        } catch (error) {
            showStatus('âŒ åŒ¯å‡ºå¤±æ•—: ' + error.message, 'analyzing');
            alert('åŒ¯å‡ºå ±å‘Šå¤±æ•—: ' + error.message);
            setTimeout(() => hideStatus(), 5000);
        }
    }

    /**
     * å–å¾—çµ±è¨ˆæ•¸æ“š
     */
    async function loadStatistics(patientId = null) {
        try {
            const url = patientId 
                ? `${GAS_WEB_APP_URL}?action=getStatistics&patientId=${patientId}`
                : `${GAS_WEB_APP_URL}?action=getStatistics`;
                
            const response = await fetch(url);
            const result = await response.json();
            
            if (result.success) {
                displayStatistics(result.data);
            } else {
                alert('è¼‰å…¥çµ±è¨ˆæ•¸æ“šå¤±æ•—: ' + result.message);
            }
        } catch (error) {
            alert('è¼‰å…¥çµ±è¨ˆæ•¸æ“šå¤±æ•—: ' + error.message);
        }
    }

    // ========== é¡¯ç¤ºå‡½æ•¸ ==========

    function displayHistory(history) {
        // åœ¨é é¢ä¸Šé¡¯ç¤ºæ­·å²è¨˜éŒ„
        const historyHtml = history.map(record => `
            <div class="history-item">
                <h4>${record['æ¸¬é‡æ—¥æœŸ']}</h4>
                <p>è©•åˆ†: ${record['ç¸½é«”è©•åˆ†']} / 100 (${record['è©•ä¼°ç­‰ç´š']})</p>
                <p>F0: ${record['F0 (Hz)']} Hz | SPL: ${record['SPL (dB)']} dB | MPT: ${record['MPT (ç§’)']} ç§’</p>
            </div>
        `).join('');
        
        // å¯ä»¥åœ¨å½ˆå‡ºè¦–çª—æˆ–ç‰¹å®šå€åŸŸé¡¯ç¤º
        alert('æ­·å²è¨˜éŒ„:\n' + JSON.stringify(history, null, 2));
    }

    function displaySearchResults(results) {
        const resultHtml = results.map(patient => `
            æ‚£è€…ID: ${patient['æ‚£è€…ID']}
            å§“å: ${patient['å§“å']}
            æ€§åˆ¥: ${patient['æ€§åˆ¥']}
            å¹´é½¡: ${patient['å¹´é½¡']}
        `).join('\n---\n');
        
        alert('æœå°‹çµæœ:\n' + resultHtml);
    }

    function displayStatistics(stats) {
        const statsHtml = `
    çµ±è¨ˆæ•¸æ“š:
    ç¸½è¨˜éŒ„æ•¸: ${stats.totalRecords}
    å¹³å‡è©•åˆ†: ${stats.averageScore}
    è¶¨å‹¢: ${stats.trend}

    å¹³å‡å€¼:
    - F0: ${stats.averages.f0} Hz
    - SPL: ${stats.averages.spl} dB
    - MPT: ${stats.averages.mpt} ç§’
    - Jitter: ${stats.averages.jitter} %
    - Shimmer: ${stats.averages.shimmer} %
    - HNR: ${stats.averages.hnr} dB
        `;
        
        alert(statsHtml);
    }

      let currentStep = 1;
      let audioContext;
      let mediaRecorder;
      let audioChunks = [];
      let audioBlob;
      let audioBuffer;
      let isRecording = false;
      let isPlaying = false;
      let source;
      let analyser;
      let microphone;
      let animationId;
      let recordingStartTime;
      let currentStage = 0;
      let stageResults = {};
      let realtimeMetrics = {
          f0: 0,
          spl: 0,
          jitter: 0,
          shimmer: 0,
          hnr: 0,
          stability: 0
      };

      const waveformCanvas = document.getElementById('waveformCanvas');
      const waveformCtx = waveformCanvas.getContext('2d');
      const spectrumCanvas = document.getElementById('spectrumCanvas');
      const spectrumCtx = spectrumCanvas.getContext('2d');
      const statusBanner = document.getElementById('statusBanner');
      const recordBtn = document.getElementById('recordBtn');
      const playBtn = document.getElementById('playBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const fileInput = document.getElementById('fileInput');
      const speedControl = document.getElementById('speedControl');
      const speedValue = document.getElementById('speedValue');
      const volumeControl = document.getElementById('volumeControl');
      const volumeValue = document.getElementById('volumeValue');

      let measurementResults = {
          f0: 0,
          spl: 0,
          mpt: 0,
          jitter: 0,
          shimmer: 0,
          hnr: 0
      };

      const measurementStages = [
          {
              title: 'éšæ®µ 1: åŸºæœ¬é »ç‡æ¸¬è©¦',
              instruction: 'è«‹ä»¥èˆ’é©çš„éŸ³é«˜æŒçºŒç™¼ã€Œå•Šã€éŸ³ 3 ç§’é˜',
              duration: 3,
              parameter: 'f0'
          },
          {
              title: 'éšæ®µ 2: éŸ¿åº¦æ¸¬è©¦',
              instruction: 'è«‹ä»¥æ­£å¸¸èªªè©±çš„éŸ³é‡æŒçºŒç™¼ã€Œå•Šã€éŸ³ 3 ç§’é˜',
              duration: 3,
              parameter: 'spl'
          },
          {
              title: 'éšæ®µ 3: æœ€å¤§ç™¼è²æ™‚é–“æ¸¬è©¦',
              instruction: 'æ·±å¸ä¸€å£æ°£ï¼Œç›¡å¯èƒ½é•·æ™‚é–“æŒçºŒç™¼ã€Œå•Šã€éŸ³ï¼Œç›´åˆ°ç„¡æ³•ç¹¼çºŒ',
              duration: 30,
              parameter: 'mpt'
          }
      ];

      window.onload = function() {
          document.getElementById('measurementDate').valueAsDate = new Date();
          resizeCanvas();
          initStages();
      };

      window.onresize = resizeCanvas;

      function resizeCanvas() {
          if (waveformCanvas) {
              waveformCanvas.width = waveformCanvas.offsetWidth;
              waveformCanvas.height = 250;
          }
          if (spectrumCanvas) {
              spectrumCanvas.width = spectrumCanvas.offsetWidth;
              spectrumCanvas.height = 250;
          }
      }

      function initStages() {
          const container = document.getElementById('stageContainer');
          measurementStages.forEach((stage, index) => {
              const stageDiv = document.createElement('div');
              stageDiv.className = 'measurement-stage';
              stageDiv.id = `stage-${index}`;
              stageDiv.style.display = index === 0 ? 'block' : 'none';
              
              stageDiv.innerHTML = `
                  <h3>${stage.title}</h3>
                  <div class="instruction">
                      <strong>ğŸ“‹ æ¸¬è©¦èªªæ˜ï¼š</strong><br>
                      ${stage.instruction}
                  </div>
                  <div style="text-align: center; margin: 25px 0;">
                      <button class="btn btn-danger" onclick="startStageRecording(${index})" id="stageBtn-${index}">
                          é–‹å§‹æ­¤éšæ®µæ¸¬è©¦
                      </button>
                  </div>
                  <div class="measurement-result" id="stageResult-${index}" style="display: none;"></div>
              `;
              
              container.appendChild(stageDiv);
          });
      }

      async function startStageRecording(stageIndex) {
          const stage = measurementStages[stageIndex];
          const btn = document.getElementById(`stageBtn-${stageIndex}`);
          
          if (!isRecording) {
              try {
                  initAudioContext();
                  const stream = await navigator.mediaDevices.getUserMedia({ 
                      audio: {
                          echoCancellation: false,
                          noiseSuppression: false,
                          autoGainControl: false
                      } 
                  });
                  
                  mediaRecorder = new MediaRecorder(stream);
                  audioChunks = [];
                  recordingStartTime = Date.now();

                  mediaRecorder.ondataavailable = (event) => {
                      audioChunks.push(event.data);
                  };

                  mediaRecorder.onstop = async () => {
                      audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                      const arrayBuffer = await audioBlob.arrayBuffer();
                      audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                      
                      analyzeStage(stageIndex);
                      
                      stream.getTracks().forEach(track => track.stop());
                      
                      if (stageIndex < measurementStages.length - 1) {
                          document.getElementById(`stage-${stageIndex}`).style.display = 'none';
                          document.getElementById(`stage-${stageIndex + 1}`).style.display = 'block';
                      }
                  };

                  analyser = audioContext.createAnalyser();
                  analyser.fftSize = 2048;
                  microphone = audioContext.createMediaStreamSource(stream);
                  microphone.connect(analyser);

                  mediaRecorder.start();
                  isRecording = true;
                  btn.textContent = 'â¹ åœæ­¢æ¸¬è©¦';
                  btn.style.background = '#28a745';
                  showStatus(`ğŸ”´ ${stage.title} é€²è¡Œä¸­... ${stage.instruction}`, 'recording');
                  
                  // é¡¯ç¤ºå³æ™‚åˆ†æé¢æ¿
                  document.getElementById('qualityScore').style.display = 'block';
                  document.getElementById('realtimeAnalysis').style.display = 'block';
                  document.getElementById('liveSuggestions').style.display = 'block';
                  
                  visualizeRecording();
                  startRealtimeAnalysis();
                  
                  if (stage.parameter !== 'mpt') {
                      setTimeout(() => {
                          if (isRecording) {
                              stopStageRecording(stageIndex);
                          }
                      }, stage.duration * 1000);
                  }
                  
              } catch (err) {
                  alert('ç„¡æ³•å­˜å–éº¥å…‹é¢¨: ' + err.message);
              }
          } else {
              stopStageRecording(stageIndex);
          }
      }

      function stopStageRecording(stageIndex) {
          if (mediaRecorder && isRecording) {
              mediaRecorder.stop();
              microphone.disconnect();
              isRecording = false;
              const btn = document.getElementById(`stageBtn-${stageIndex}`);
              btn.textContent = 'âœ“ æ¸¬è©¦å®Œæˆ';
              btn.disabled = true;
              btn.style.background = '#6c757d';
              cancelAnimationFrame(animationId);
              stopRealtimeAnalysis();
          }
      }

      // æ–°å¢ï¼šå³æ™‚åˆ†æåŠŸèƒ½
      let realtimeInterval;
      function startRealtimeAnalysis() {
          realtimeInterval = setInterval(() => {
              if (!isRecording || !analyser) return;
              
              const bufferLength = analyser.frequencyBinCount;
              const dataArray = new Uint8Array(bufferLength);
              const freqArray = new Uint8Array(bufferLength);
              
              analyser.getByteTimeDomainData(dataArray);
              analyser.getByteFrequencyData(freqArray);
              
              // è¨ˆç®—å³æ™‚æŒ‡æ¨™
              updateRealtimeMetrics(dataArray, freqArray);
              updateRealtimeDisplay();
              updateLiveSuggestions();
              
          }, 200); // æ¯200msæ›´æ–°ä¸€æ¬¡
      }

      function stopRealtimeAnalysis() {
          if (realtimeInterval) {
              clearInterval(realtimeInterval);
          }
      }

      function updateRealtimeMetrics(dataArray, freqArray) {
          const gender = document.getElementById('patientGender').value;
          
          // è¨ˆç®—å³æ™‚é »ç‡
          let sum = 0, count = 0;
          for (let i = 0; i < freqArray.length; i++) {
              if (freqArray[i] > 0) {
                  sum += i * freqArray[i];
                  count += freqArray[i];
              }
          }
          if (count > 0 && audioContext) {
              const avgBin = sum / count;
              const nyquist = audioContext.sampleRate / 2;
              realtimeMetrics.f0 = (avgBin / freqArray.length) * nyquist;
          }
          
          // è¨ˆç®—å³æ™‚éŸ¿åº¦
          let rmsSum = 0;
          for (let i = 0; i < dataArray.length; i++) {
              const normalized = (dataArray[i] - 128) / 128;
              rmsSum += normalized * normalized;
          }
          const rms = Math.sqrt(rmsSum / dataArray.length);
          realtimeMetrics.spl = Math.max(0, Math.min(120, 20 * Math.log10(rms / 0.00002) + 94));
          
          // è¨ˆç®—ç©©å®šæ€§ï¼ˆè®Šç•°ä¿‚æ•¸ï¼‰
          let variance = 0;
          const mean = dataArray.reduce((a, b) => a + b) / dataArray.length;
          for (let i = 0; i < dataArray.length; i++) {
              variance += Math.pow(dataArray[i] - mean, 2);
          }
          const stdDev = Math.sqrt(variance / dataArray.length);
          realtimeMetrics.stability = Math.max(0, 100 - (stdDev / mean * 100));
          
          // ç°¡åŒ–çš„ Jitter ä¼°ç®—
          let periodDiffs = 0;
          let periodCount = 0;
          for (let i = 1; i < dataArray.length; i++) {
              if (dataArray[i-1] < 128 && dataArray[i] >= 128) {
                  periodDiffs++;
              }
          }
          realtimeMetrics.jitter = Math.min(5, periodDiffs / dataArray.length * 100);
          
          // ç°¡åŒ–çš„ HNR ä¼°ç®—
          const signalPower = rms * rms;
          const noisePower = variance / (dataArray.length * dataArray.length);
          realtimeMetrics.hnr = noisePower > 0 ? Math.min(40, 10 * Math.log10(signalPower / noisePower)) : 40;
      }

      function updateRealtimeDisplay() {
          const gender = document.getElementById('patientGender').value;
          const f0Range = gender === 'male' ? [100, 150] : [180, 250];
          const splRange = gender === 'male' ? [65, 75] : [60, 70];
          
          // æ›´æ–°åˆ†æç¶²æ ¼
          const analysisGrid = document.getElementById('analysisGrid');
          analysisGrid.innerHTML = `
              <div class="analysis-item ${getStatusClass(realtimeMetrics.f0, f0Range[0], f0Range[1])}">
                  <h4>åŸºæœ¬é »ç‡ (F0)</h4>
                  <div class="metric">${realtimeMetrics.f0.toFixed(1)} Hz</div>
                  <div class="status">${getStatusIcon(realtimeMetrics.f0, f0Range[0], f0Range[1])} ${getStatusText(realtimeMetrics.f0, f0Range[0], f0Range[1])}</div>
                  <div class="suggestion">${getF0Suggestion(realtimeMetrics.f0, f0Range)}</div>
              </div>
              
              <div class="analysis-item ${getStatusClass(realtimeMetrics.spl, splRange[0], splRange[1])}">
                  <h4>è²éŸ³éŸ¿åº¦ (SPL)</h4>
                  <div class="metric">${realtimeMetrics.spl.toFixed(1)} dB</div>
                  <div class="status">${getStatusIcon(realtimeMetrics.spl, splRange[0], splRange[1])} ${getStatusText(realtimeMetrics.spl, splRange[0], splRange[1])}</div>
                  <div class="suggestion">${getSPLSuggestion(realtimeMetrics.spl, splRange)}</div>
              </div>
              
              <div class="analysis-item ${getJitterStatusClass(realtimeMetrics.jitter)}">
                  <h4>å—“éŸ³ç©©å®šæ€§</h4>
                  <div class="metric">${realtimeMetrics.stability.toFixed(1)}%</div>
                  <div class="status">${getStabilityIcon(realtimeMetrics.stability)} ${getStabilityText(realtimeMetrics.stability)}</div>
                  <div class="suggestion">${getStabilitySuggestion(realtimeMetrics.stability)}</div>
              </div>
              
              <div class="analysis-item ${getHNRStatusClass(realtimeMetrics.hnr)}">
                  <h4>è²éŸ³å“è³ª (HNR)</h4>
                  <div class="metric">${realtimeMetrics.hnr.toFixed(1)} dB</div>
                  <div class="status">${getHNRIcon(realtimeMetrics.hnr)} ${getHNRText(realtimeMetrics.hnr)}</div>
                  <div class="suggestion">${getHNRSuggestion(realtimeMetrics.hnr)}</div>
              </div>
          `;
          
          // æ›´æ–°è³ªé‡è©•åˆ†
          const score = calculateQualityScore();
          document.getElementById('scoreValue').textContent = score;
          document.getElementById('scoreDescription').textContent = getScoreDescription(score);
          
          // æ›´æ–°æ•¸æ“šå¡é¡è‰²
          updateDataCardColors();
      }

      function calculateQualityScore() {
          const gender = document.getElementById('patientGender').value;
          const f0Range = gender === 'male' ? [100, 150] : [180, 250];
          const splRange = gender === 'male' ? [65, 75] : [60, 70];
          
          let score = 0;
          
          // F0 è©•åˆ† (25åˆ†)
          if (realtimeMetrics.f0 >= f0Range[0] && realtimeMetrics.f0 <= f0Range[1]) {
              score += 25;
          } else {
              const deviation = Math.min(
                  Math.abs(realtimeMetrics.f0 - f0Range[0]),
                  Math.abs(realtimeMetrics.f0 - f0Range[1])
              );
              score += Math.max(0, 25 - deviation / 10);
          }
          
          // SPL è©•åˆ† (25åˆ†)
          if (realtimeMetrics.spl >= splRange[0] && realtimeMetrics.spl <= splRange[1]) {
              score += 25;
          } else {
              const deviation = Math.min(
                  Math.abs(realtimeMetrics.spl - splRange[0]),
                  Math.abs(realtimeMetrics.spl - splRange[1])
              );
              score += Math.max(0, 25 - deviation * 2);
          }
          
          // ç©©å®šæ€§è©•åˆ† (25åˆ†)
          score += realtimeMetrics.stability / 4;
          
          // HNR è©•åˆ† (25åˆ†)
          score += Math.min(25, realtimeMetrics.hnr / 40 * 25);
          
          return Math.round(score);
      }

      function getScoreDescription(score) {
          if (score >= 90) return 'å„ªç§€ - èªéŸ³è³ªé‡éå¸¸å¥½ï¼';
          if (score >= 80) return 'è‰¯å¥½ - èªéŸ³è³ªé‡ä¸éŒ¯ï¼Œç¹¼çºŒä¿æŒ';
          if (score >= 70) return 'ä¸­ç­‰ - èªéŸ³è³ªé‡å°šå¯ï¼Œæœ‰æ”¹å–„ç©ºé–“';
          if (score >= 60) return 'åŠæ ¼ - å»ºè­°åŠ å¼·ç·´ç¿’';
          return 'éœ€æ”¹å–„ - å»ºè­°å°‹æ±‚å°ˆæ¥­å”åŠ©';
      }

      function updateDataCardColors() {
          const gender = document.getElementById('patientGender').value;
          const f0Range = gender === 'male' ? [100, 150] : [180, 250];
          const splRange = gender === 'male' ? [65, 75] : [60, 70];
          
          const freqCard = document.getElementById('freqCard');
          freqCard.className = 'data-card ' + getStatusClass(realtimeMetrics.f0, f0Range[0], f0Range[1]);
      }

      function updateLiveSuggestions() {
          const suggestions = [];
          const gender = document.getElementById('patientGender').value;
          const f0Range = gender === 'male' ? [100, 150] : [180, 250];
          const splRange = gender === 'male' ? [65, 75] : [60, 70];
          
          // æ ¹æ“šå³æ™‚æ•¸æ“šç”Ÿæˆå»ºè­°
          if (realtimeMetrics.f0 < f0Range[0]) {
              suggestions.push('éŸ³é«˜åä½ï¼Œè«‹å˜—è©¦ç¨å¾®æé«˜éŸ³èª¿');
          } else if (realtimeMetrics.f0 > f0Range[1]) {
              suggestions.push('éŸ³é«˜åé«˜ï¼Œè«‹å˜—è©¦æ”¾é¬†å–‰åš¨ï¼Œé™ä½éŸ³èª¿');
          } else {
              suggestions.push('éŸ³é«˜æ§åˆ¶è‰¯å¥½ï¼Œè«‹ä¿æŒ');
          }
          
          if (realtimeMetrics.spl < splRange[0]) {
              suggestions.push('éŸ³é‡åå°ï¼Œè«‹ç¨å¾®å¢åŠ éŸ³é‡');
          } else if (realtimeMetrics.spl > splRange[1]) {
              suggestions.push('éŸ³é‡åå¤§ï¼Œè«‹é©åº¦é™ä½éŸ³é‡');
          } else {
              suggestions.push('éŸ³é‡æ§åˆ¶è‰¯å¥½ï¼Œè«‹ä¿æŒ');
          }
          
          if (realtimeMetrics.stability < 70) {
              suggestions.push('è²éŸ³ä¸å¤ ç©©å®šï¼Œè«‹ä¿æŒå‡å‹»çš„æ°£æµå’ŒéŸ³é‡');
          } else {
              suggestions.push('è²éŸ³ç©©å®šæ€§è‰¯å¥½');
          }
          
          if (realtimeMetrics.hnr < 15) {
              suggestions.push('è²éŸ³å“è³ªéœ€æ”¹å–„ï¼Œè«‹ç¢ºä¿ç™¼è²æ™‚å–‰åš¨æ”¾é¬†');
          }
          
          // æ›´æ–°å»ºè­°åˆ—è¡¨
          const suggestionList = document.getElementById('suggestionList');
          suggestionList.innerHTML = suggestions.map(s => `<li>${s}</li>`).join('');
      }

      // è¼”åŠ©å‡½æ•¸
      function getStatusClass(value, min, max) {
          if (value >= min && value <= max) return 'success';
          if (value < min * 0.8 || value > max * 1.2) return 'danger';
          return 'warning';
      }

      function getStatusIcon(value, min, max) {
          if (value >= min && value <= max) return 'âœ“';
          if (value < min * 0.8 || value > max * 1.2) return 'âœ—';
          return 'âš ';
      }

      function getStatusText(value, min, max) {
          if (value >= min && value <= max) return 'æ­£å¸¸';
          if (value < min * 0.8 || value > max * 1.2) return 'ç•°å¸¸';
          return 'æ³¨æ„';
      }

      function getJitterStatusClass(jitter) {
          if (jitter < 1.04) return 'success';
          if (jitter > 2) return 'danger';
          return 'warning';
      }

      function getHNRStatusClass(hnr) {
          if (hnr >= 20) return 'success';
          if (hnr < 10) return 'danger';
          return 'warning';
      }

      function getStabilityIcon(stability) {
          if (stability >= 80) return 'âœ“';
          if (stability < 60) return 'âœ—';
          return 'âš ';
      }

      function getStabilityText(stability) {
          if (stability >= 80) return 'ç©©å®š';
          if (stability < 60) return 'ä¸ç©©å®š';
          return 'å°šå¯';
      }

      function getHNRIcon(hnr) {
          if (hnr >= 20) return 'âœ“';
          if (hnr < 10) return 'âœ—';
          return 'âš ';
      }

      function getHNRText(hnr) {
            if (hnr >= 20) return 'å„ªè‰¯';
            if (hnr < 10) return 'ä¸ä½³';
            return 'å°šå¯';
        }

        function getF0Suggestion(f0, range) {
            if (f0 < range[0]) return 'å»ºè­°ï¼šæé«˜éŸ³èª¿ï¼Œå¯ä»¥æƒ³åƒèªªè©±å°è±¡åœ¨è¼ƒé çš„åœ°æ–¹';
            if (f0 > range[1]) return 'å»ºè­°ï¼šé™ä½éŸ³èª¿ï¼Œæ”¾é¬†å–‰éƒ¨è‚Œè‚‰';
            return 'éŸ³é«˜ç¯„åœç†æƒ³ï¼Œè«‹ç¹¼çºŒä¿æŒ';
        }

        function getSPLSuggestion(spl, range) {
            if (spl < range[0]) return 'å»ºè­°ï¼šå¢åŠ éŸ³é‡ï¼Œä½¿ç”¨æ›´å¤šçš„å‘¼å¸æ”¯æŒ';
            if (spl > range[1]) return 'å»ºè­°ï¼šé™ä½éŸ³é‡ï¼Œé¿å…éåº¦ç”¨åŠ›';
            return 'éŸ³é‡é©ä¸­ï¼Œè«‹ç¹¼çºŒä¿æŒ';
        }

        function getStabilitySuggestion(stability) {
            if (stability < 60) return 'å»ºè­°ï¼šä¿æŒç©©å®šçš„æ°£æµï¼Œé¿å…è²éŸ³é¡«æŠ–';
            if (stability < 80) return 'å»ºè­°ï¼šç¹¼çºŒç·´ç¿’ç©©å®šç™¼è²';
            return 'ç©©å®šæ€§è‰¯å¥½';
        }

        function getHNRSuggestion(hnr) {
            if (hnr < 10) return 'å»ºè­°ï¼šæ”¾é¬†å–‰åš¨ï¼Œç¢ºä¿è²å¸¶å……åˆ†é–‰åˆ';
            if (hnr < 20) return 'å»ºè­°ï¼šæ”¹å–„ç™¼è²æŠ€å·§ï¼Œæ¸›å°‘æ°£è²';
            return 'è²éŸ³å“è³ªå„ªè‰¯';
        }

        function analyzeStage(stageIndex) {
            const stage = measurementStages[stageIndex];
            const data = audioBuffer.getChannelData(0);
            const sampleRate = audioBuffer.sampleRate;
            
            let result = {};
            
            switch(stage.parameter) {
                case 'f0':
                    result.value = calculateF0(data, sampleRate);
                    result.unit = 'Hz';
                    result.label = 'åŸºæœ¬é »ç‡';
                    stageResults.f0 = result.value;
                    break;
                case 'spl':
                    result.value = calculateSPL(data);
                    result.unit = 'dB';
                    result.label = 'è²éŸ³éŸ¿åº¦';
                    stageResults.spl = result.value;
                    break;
                case 'mpt':
                    result.value = audioBuffer.duration;
                    result.unit = 'ç§’';
                    result.label = 'æœ€å¤§ç™¼è²æ™‚é–“';
                    stageResults.mpt = result.value;
                    stageResults.jitter = calculateJitter(data, sampleRate);
                    stageResults.shimmer = calculateShimmer(data);
                    stageResults.hnr = calculateHNR(data, sampleRate);
                    break;
            }
            
            const resultDiv = document.getElementById(`stageResult-${stageIndex}`);
            resultDiv.style.display = 'grid';
            resultDiv.innerHTML = `
                <div class="result-item">
                    <h4>${result.label}</h4>
                    <div class="value">${result.value.toFixed(2)} ${result.unit}</div>
                </div>
            `;
            
            showStatus(`âœ… ${stage.title} å®Œæˆï¼`, 'completed');
            setTimeout(() => hideStatus(), 2000);
            
            updateDuration();
            visualizeWaveform(audioBuffer);
        }

        function goToStep(step) {
            if (currentStep === 1 && step > 1) {
                const name = document.getElementById('patientName').value;
                const gender = document.getElementById('patientGender').value;
                
                if (!name || !gender) {
                    alert('è«‹å¡«å¯«å§“åå’Œæ€§åˆ¥');
                    return;
                }
            }

            document.querySelectorAll('.step').forEach(s => {
                const stepNum = parseInt(s.dataset.step);
                s.classList.remove('active', 'completed');
                if (stepNum === step) {
                    s.classList.add('active');
                } else if (stepNum < step) {
                    s.classList.add('completed');
                }
            });

            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelector(`.step-content[data-step="${step}"]`).classList.add('active');

            currentStep = step;
        }

        function showStatus(message, type) {
            statusBanner.textContent = message;
            statusBanner.className = `status-banner ${type}`;
            statusBanner.style.display = 'block';
        }

        function hideStatus() {
            statusBanner.style.display = 'none';
        }

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                document.getElementById('sampleRate').textContent = 
                    (audioContext.sampleRate / 1000).toFixed(1) + 'kHz';
            }
        }

        recordBtn.addEventListener('click', async () => {
            if (!isRecording) {
                try {
                    initAudioContext();
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        } 
                    });
                    
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    recordingStartTime = Date.now();

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const arrayBuffer = await audioBlob.arrayBuffer();
                        audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        playBtn.disabled = false;
                        downloadBtn.disabled = false;
                        updateDuration();
                        visualizeWaveform(audioBuffer);
                        stream.getTracks().forEach(track => track.stop());
                    };

                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 2048;
                    microphone = audioContext.createMediaStreamSource(stream);
                    microphone.connect(analyser);

                    mediaRecorder.start();
                    isRecording = true;
                    recordBtn.textContent = 'â¹ åœæ­¢éŒ„éŸ³';
                    recordBtn.style.background = '#28a745';
                    showStatus('ğŸ”´ éŒ„éŸ³ä¸­... è«‹æŒçºŒç™¼ã€Œå•Šã€éŸ³', 'recording');
                    
                    document.getElementById('qualityScore').style.display = 'block';
                    document.getElementById('realtimeAnalysis').style.display = 'block';
                    document.getElementById('liveSuggestions').style.display = 'block';
                    
                    visualizeRecording();
                    startRealtimeAnalysis();
                } catch (err) {
                    alert('ç„¡æ³•å­˜å–éº¥å…‹é¢¨: ' + err.message);
                }
            } else {
                mediaRecorder.stop();
                microphone.disconnect();
                isRecording = false;
                recordBtn.textContent = 'é–‹å§‹éŒ„éŸ³';
                recordBtn.style.background = '#dc3545';
                showStatus('âœ… éŒ„éŸ³å®Œæˆ', 'completed');
                cancelAnimationFrame(animationId);
                stopRealtimeAnalysis();
                
                setTimeout(() => hideStatus(), 3000);
            }
        });

        playBtn.addEventListener('click', () => {
            if (!isPlaying && audioBuffer) {
                initAudioContext();
                
                source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                
                const gainNode = audioContext.createGain();
                gainNode.gain.value = volumeControl.value / 100;
                
                source.playbackRate.value = parseFloat(speedControl.value);
                
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                
                source.connect(gainNode);
                gainNode.connect(analyser);
                analyser.connect(audioContext.destination);
                
                source.start(0);
                isPlaying = true;
                playBtn.textContent = 'â¹ åœæ­¢æ’­æ”¾';
                showStatus('â–¶ï¸ æ’­æ”¾ä¸­...', 'analyzing');
                
                visualizePlaying();
                
                source.onended = () => {
                    isPlaying = false;
                    playBtn.textContent = 'æ’­æ”¾éŒ„éŸ³';
                    hideStatus();
                    cancelAnimationFrame(animationId);
                    visualizeWaveform(audioBuffer);
                };
            } else if (isPlaying) {
                source.stop();
                isPlaying = false;
                playBtn.textContent = 'æ’­æ”¾éŒ„éŸ³';
                hideStatus();
                cancelAnimationFrame(animationId);
            }
        });

        downloadBtn.addEventListener('click', () => {
            if (audioBlob) {
                const url = URL.createObjectURL(audioBlob);
                const a = document.createElement('a');
                a.href = url;
                const name = document.getElementById('patientName').value || 'recording';
                a.download = `${name}_voice_recording_${Date.now()}.wav`;
                a.click();
                URL.revokeObjectURL(url);
            }
        });

        speedControl.addEventListener('input', (e) => {
            const speed = parseFloat(e.target.value);
            speedValue.textContent = speed.toFixed(2);
            if (source && isPlaying) {
                source.playbackRate.value = speed;
            }
        });

        volumeControl.addEventListener('input', (e) => {
            volumeValue.textContent = e.target.value;
        });

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                initAudioContext();
                const arrayBuffer = await file.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                audioBlob = file;
                playBtn.disabled = false;
                downloadBtn.disabled = false;
                showStatus('âœ… æª”æ¡ˆè¼‰å…¥æˆåŠŸ', 'completed');
                updateDuration();
                visualizeWaveform(audioBuffer);
                setTimeout(() => hideStatus(), 3000);
            }
        });

        function updateDuration() {
            if (audioBuffer) {
                const duration = audioBuffer.duration;
                document.getElementById('duration').textContent = duration.toFixed(2) + 's';
            }
        }

        function visualizeRecording() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const freqArray = new Uint8Array(bufferLength);

            function draw() {
                if (!isRecording) return;
                animationId = requestAnimationFrame(draw);

                analyser.getByteTimeDomainData(dataArray);
                analyser.getByteFrequencyData(freqArray);

                waveformCtx.fillStyle = 'rgb(255, 255, 255)';
                waveformCtx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);
                waveformCtx.lineWidth = 3;
                waveformCtx.strokeStyle = 'rgb(102, 126, 234)';
                waveformCtx.beginPath();

                const sliceWidth = waveformCanvas.width / bufferLength;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * waveformCanvas.height / 2;

                    if (i === 0) {
                        waveformCtx.moveTo(x, y);
                    } else {
                        waveformCtx.lineTo(x, y);
                    }

                    x += sliceWidth;
                }

                waveformCtx.lineTo(waveformCanvas.width, waveformCanvas.height / 2);
                waveformCtx.stroke();

                drawSpectrum(freqArray);
                updateFrequencyInfo(freqArray);
            }

            draw();
        }

        function visualizePlaying() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const freqArray = new Uint8Array(bufferLength);

            function draw() {
                if (!isPlaying) return;
                animationId = requestAnimationFrame(draw);

                analyser.getByteTimeDomainData(dataArray);
                analyser.getByteFrequencyData(freqArray);

                waveformCtx.fillStyle = 'rgb(255, 255, 255)';
                waveformCtx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);
                waveformCtx.lineWidth = 3;
                waveformCtx.strokeStyle = 'rgb(102, 126, 234)';
                waveformCtx.beginPath();

                const sliceWidth = waveformCanvas.width / bufferLength;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * waveformCanvas.height / 2;

                    if (i === 0) {
                        waveformCtx.moveTo(x, y);
                    } else {
                        waveformCtx.lineTo(x, y);
                    }

                    x += sliceWidth;
                }

                waveformCtx.lineTo(waveformCanvas.width, waveformCanvas.height / 2);
                waveformCtx.stroke();

                drawSpectrum(freqArray);
                updateFrequencyInfo(freqArray);
            }

            draw();
        }

        function visualizeWaveform(buffer) {
            const data = buffer.getChannelData(0);
            const step = Math.ceil(data.length / waveformCanvas.width);
            const amp = waveformCanvas.height / 2;

            waveformCtx.fillStyle = 'rgb(255, 255, 255)';
            waveformCtx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);
            waveformCtx.lineWidth = 2;
            waveformCtx.strokeStyle = 'rgb(102, 126, 234)';
            waveformCtx.beginPath();

            let maxAmp = 0;

            for (let i = 0; i < waveformCanvas.width; i++) {
                let min = 1.0;
                let max = -1.0;

                for (let j = 0; j < step; j++) {
                    const datum = data[(i * step) + j];
                    if (datum < min) min = datum;
                    if (datum > max) max = datum;
                }

                maxAmp = Math.max(maxAmp, Math.abs(max), Math.abs(min));

                const yLow = (1 + min) * amp;
                const yHigh = (1 + max) * amp;

                waveformCtx.moveTo(i, yLow);
                waveformCtx.lineTo(i, yHigh);
            }

            waveformCtx.stroke();
            document.getElementById('peakAmp').textContent = maxAmp.toFixed(3);
        }

        function drawSpectrum(freqArray) {
            spectrumCtx.fillStyle = 'rgb(255, 255, 255)';
            spectrumCtx.fillRect(0, 0, spectrumCanvas.width, spectrumCanvas.height);

            const barWidth = (spectrumCanvas.width / freqArray.length) * 2.5;
            let x = 0;

            for (let i = 0; i < freqArray.length; i++) {
                const barHeight = (freqArray[i] / 255) * spectrumCanvas.height;
                
                const hue = (i / freqArray.length) * 360;
                spectrumCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                spectrumCtx.fillRect(x, spectrumCanvas.height - barHeight, barWidth, barHeight);

                x += barWidth + 1;
            }
        }

        function updateFrequencyInfo(freqArray) {
            let sum = 0;
            let count = 0;

            for (let i = 0; i < freqArray.length; i++) {
                if (freqArray[i] > 0) {
                    sum += i * freqArray[i];
                    count += freqArray[i];
                }
            }

            if (count > 0 && audioContext) {
                const avgBin = sum / count;
                const nyquist = audioContext.sampleRate / 2;
                const avgFreq = (avgBin / freqArray.length) * nyquist;
                document.getElementById('avgFreq').textContent = Math.round(avgFreq) + ' Hz';
            }
        }

        function analyzeAudio() {
            if (Object.keys(stageResults).length === 0) {
                alert('è«‹å…ˆå®Œæˆè‡³å°‘ä¸€å€‹éšæ®µçš„æ¸¬é‡');
                return;
            }

            showStatus('ğŸ” æ­£åœ¨æ•´åˆåˆ†æçµæœ...', 'analyzing');

            setTimeout(() => {
                measurementResults = {
                    f0: stageResults.f0 || 0,
                    spl: stageResults.spl || 0,
                    mpt: stageResults.mpt || 0,
                    jitter: stageResults.jitter || 0,
                    shimmer: stageResults.shimmer || 0,
                    hnr: stageResults.hnr || 0
                };
                
                goToStep(4);
                displayResults();
                hideStatus();
            }, 1500);
        }

        function calculateF0(data, sampleRate) {
            const minFreq = 50;
            const maxFreq = 500;
            const minPeriod = Math.floor(sampleRate / maxFreq);
            const maxPeriod = Math.floor(sampleRate / minFreq);

            let maxCorr = 0;
            let bestPeriod = 0;

            for (let period = minPeriod; period < maxPeriod; period++) {
                let corr = 0;
                for (let i = 0; i < data.length - period; i++) {
                    corr += data[i] * data[i + period];
                }
                if (corr > maxCorr) {
                    maxCorr = corr;
                    bestPeriod = period;
                }
            }

            return bestPeriod > 0 ? sampleRate / bestPeriod : 0;
        }

        function calculateSPL(data) {
            let sum = 0;
            for (let i = 0; i < data.length; i++) {
                sum += data[i] * data[i];
            }
            const rms = Math.sqrt(sum / data.length);
            const spl = 20 * Math.log10(rms / 0.00002) + 94;
            return Math.max(0, Math.min(120, spl));
        }

        function calculateJitter(data, sampleRate) {
            const periods = extractPeriods(data, sampleRate);
            if (periods.length < 2) return 0;

            let sum = 0;
            for (let i = 1; i < periods.length; i++) {
                sum += Math.abs(periods[i] - periods[i - 1]);
            }
            const avgDiff = sum / (periods.length - 1);
            const avgPeriod = periods.reduce((a, b) => a + b) / periods.length;
            
            return (avgDiff / avgPeriod) * 100;
        }

        function calculateShimmer(data) {
            const windowSize = 1024;
            const amplitudes = [];

            for (let i = 0; i < data.length - windowSize; i += windowSize) {
                let max = 0;
                for (let j = 0; j < windowSize; j++) {
                    max = Math.max(max, Math.abs(data[i + j]));
                }
                amplitudes.push(max);
            }

            if (amplitudes.length < 2) return 0;

            let sum = 0;
            for (let i = 1; i < amplitudes.length; i++) {
                sum += Math.abs(amplitudes[i] - amplitudes[i - 1]);
            }
            const avgDiff = sum / (amplitudes.length - 1);
            const avgAmp = amplitudes.reduce((a, b) => a + b) / amplitudes.length;

            return (avgDiff / avgAmp) * 100;
        }

        function calculateHNR(data, sampleRate) {
            const f0 = calculateF0(data, sampleRate);
            if (f0 === 0) return 0;

            const period = Math.floor(sampleRate / f0);
            let harmonicPower = 0;
            let noisePower = 0;

            for (let i = 0; i < data.length - period; i++) {
                const predicted = data[i + period];
                const actual = data[i];
                harmonicPower += predicted * predicted;
                noisePower += (actual - predicted) * (actual - predicted);
            }

            if (noisePower === 0) return 40;
            const hnr = 10 * Math.log10(harmonicPower / noisePower);
            return Math.max(0, Math.min(40, hnr));
        }

        function extractPeriods(data, sampleRate) {
            const periods = [];
            const threshold = 0.3;
            let lastZeroCrossing = 0;

            for (let i = 1; i < data.length; i++) {
                if (data[i - 1] < 0 && data[i] >= 0 && Math.abs(data[i]) > threshold) {
                    if (lastZeroCrossing > 0) {
                        periods.push(i - lastZeroCrossing);
                    }
                    lastZeroCrossing = i;
                }
            }

            return periods;
        }

        function displayResults() {
            const gender = document.getElementById('patientGender').value;
            
            document.getElementById('reportName').textContent = document.getElementById('patientName').value;
            document.getElementById('reportGender').textContent = gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§';
            document.getElementById('reportAge').textContent = document.getElementById('patientAge').value || '-';
            document.getElementById('reportDate').textContent = document.getElementById('measurementDate').value;

            const ranges = {
                f0: gender === 'male' ? '100-150' : '180-250',
                spl: gender === 'male' ? '65-75' : '60-70',
                mpt: gender === 'male' ? 'â‰¥ 20' : 'â‰¥ 15'
            };

            document.getElementById('result_f0').textContent = measurementResults.f0.toFixed(1);
            document.getElementById('result_spl').textContent = measurementResults.spl.toFixed(1);
            document.getElementById('result_mpt').textContent = measurementResults.mpt.toFixed(2);
            document.getElementById('result_jitter').textContent = measurementResults.jitter.toFixed(2);
            document.getElementById('result_shimmer').textContent = measurementResults.shimmer.toFixed(2);
            document.getElementById('result_hnr').textContent = measurementResults.hnr.toFixed(1);

            document.getElementById('range_f0').textContent = ranges.f0;
            document.getElementById('range_spl').textContent = ranges.spl;
            document.getElementById('range_mpt').textContent = ranges.mpt;

            const f0Range = gender === 'male' ? [100, 150] : [180, 250];
            const splRange = gender === 'male' ? [65, 75] : [60, 70];
            const mptMin = gender === 'male' ? 20 : 15;

            const isF0Normal = measurementResults.f0 >= f0Range[0] && measurementResults.f0 <= f0Range[1];
            const isSplNormal = measurementResults.spl >= splRange[0] && measurementResults.spl <= splRange[1];
            const isMptNormal = measurementResults.mpt >= mptMin;
            const isJitterNormal = measurementResults.jitter < 1.04;
            const isShimmerNormal = measurementResults.shimmer < 3.81;
            const isHnrNormal = measurementResults.hnr >= 20;

            document.getElementById('status_f0').innerHTML = isF0Normal ? 
                '<span class="status-normal">âœ“ æ­£å¸¸</span>' : '<span class="status-abnormal">âœ— ç•°å¸¸</span>';
            document.getElementById('status_spl').innerHTML = isSplNormal ? 
                '<span class="status-normal">âœ“ æ­£å¸¸</span>' : '<span class="status-abnormal">âœ— ç•°å¸¸</span>';
            document.getElementById('status_mpt').innerHTML = isMptNormal ? 
                '<span class="status-normal">âœ“ æ­£å¸¸</span>' : '<span class="status-abnormal">âœ— ç•°å¸¸</span>';
            document.getElementById('status_jitter').innerHTML = isJitterNormal ? 
                '<span class="status-normal">âœ“ æ­£å¸¸</span>' : '<span class="status-abnormal">âœ— ç•°å¸¸</span>';
            document.getElementById('status_shimmer').innerHTML = isShimmerNormal ? 
                '<span class="status-normal">âœ“ æ­£å¸¸</span>' : '<span class="status-abnormal">âœ— ç•°å¸¸</span>';
            document.getElementById('status_hnr').innerHTML = isHnrNormal ? 
                '<span class="status-normal">âœ“ æ­£å¸¸</span>' : '<span class="status-abnormal">âœ— ç•°å¸¸</span>';

            // è¨ˆç®—ä¸¦é¡¯ç¤ºæœ€çµ‚è©•åˆ†
            const finalScore = calculateFinalScore(isF0Normal, isSplNormal, isMptNormal, isJitterNormal, isShimmerNormal, isHnrNormal);
            document.getElementById('finalScoreValue').textContent = finalScore;
            document.getElementById('finalScoreDescription').textContent = getFinalScoreDescription(finalScore);

            generateRecommendations(isF0Normal, isSplNormal, isMptNormal, isJitterNormal, isShimmerNormal, isHnrNormal);
        }

        function calculateFinalScore(isF0Normal, isSplNormal, isMptNormal, isJitterNormal, isShimmerNormal, isHnrNormal) {
            let score = 0;
            const weights = {
                f0: 15,
                spl: 15,
                mpt: 20,
                jitter: 15,
                shimmer: 15,
                hnr: 20
            };

            if (isF0Normal) score += weights.f0;
            if (isSplNormal) score += weights.spl;
            if (isMptNormal) score += weights.mpt;
            if (isJitterNormal) score += weights.jitter;
            if (isShimmerNormal) score += weights.shimmer;
            if (isHnrNormal) score += weights.hnr;

            return score;
        }

        function getFinalScoreDescription(score) {
            if (score >= 90) return 'å„ªç§€ - èªéŸ³åŠŸèƒ½éå¸¸å¥åº·';
            if (score >= 75) return 'è‰¯å¥½ - èªéŸ³åŠŸèƒ½æ­£å¸¸';
            if (score >= 60) return 'å°šå¯ - éƒ¨åˆ†æŒ‡æ¨™éœ€æ³¨æ„';
            if (score >= 45) return 'éœ€æ”¹å–„ - å»ºè­°é€²è¡ŒèªéŸ³è¨“ç·´';
            return 'ç•°å¸¸ - å¼·çƒˆå»ºè­°å°‹æ±‚å°ˆæ¥­é†«ç™‚å”åŠ©';
        }

        function generateRecommendations(isF0Normal, isSplNormal, isMptNormal, isJitterNormal, isShimmerNormal, isHnrNormal) {
            let recommendations = [];

            const allNormal = isF0Normal && isSplNormal && isMptNormal && isJitterNormal && isShimmerNormal && isHnrNormal;

            if (allNormal) {
                recommendations.push('âœ… <strong>ç¶œåˆè©•ä¼°ï¼šå„ªè‰¯</strong>');
                recommendations.push('æ‰€æœ‰æ¸¬é‡é …ç›®å‡åœ¨æ­£å¸¸ç¯„åœå…§ï¼Œå—“éŸ³åŠŸèƒ½è‰¯å¥½ã€‚');
                recommendations.push('');
                recommendations.push('ğŸ’¡ <strong>ä¿é¤Šå»ºè­°ï¼š</strong>');
                recommendations.push('â€¢ ç¶­æŒè‰¯å¥½çš„ç™¼è²ç¿’æ…£ï¼Œé¿å…éåº¦ç”¨è²');
                recommendations.push('â€¢ ä¿æŒå……è¶³æ°´åˆ†æ”å–ï¼ˆæ¯æ—¥è‡³å°‘ 2000ccï¼‰');
                recommendations.push('â€¢ é©åº¦ä¼‘æ¯ï¼Œé¿å…é€£çºŒé•·æ™‚é–“èªªè©±');
                recommendations.push('â€¢ å®šæœŸé€²è¡Œå—“éŸ³ä¿å¥æª¢æŸ¥');
            } else {
                recommendations.push('âš ï¸ <strong>ç¶œåˆè©•ä¼°ï¼šéœ€è¦é—œæ³¨</strong>');
                recommendations.push('éƒ¨åˆ†æ¸¬é‡é …ç›®ç•°å¸¸ï¼Œå»ºè­°æ¡å–ä»¥ä¸‹æªæ–½ï¼š');
                recommendations.push('');
                
                if (!isF0Normal) {
                    const f0 = measurementResults.f0;
                    const gender = document.getElementById('patientGender').value;
                    const range = gender === 'male' ? [100, 150] : [180, 250];
                    
                    recommendations.push('ğŸ”´ <strong>åŸºæœ¬é »ç‡ç•°å¸¸</strong>');
                    if (f0 < range[0]) {
                        recommendations.push(`â€¢ æ¸¬é‡å€¼ ${f0.toFixed(1)} Hz åä½ï¼ˆæ­£å¸¸ç¯„åœï¼š${range[0]}-${range[1]} Hzï¼‰`);
                        recommendations.push('â€¢ å¯èƒ½åŸå› ï¼šè²å¸¶æ°´è…«ã€å…§åˆ†æ³Œå› ç´ ã€ç™¼è²ç¿’æ…£ä¸ç•¶');
                        recommendations.push('â€¢ å»ºè­°ï¼šé€²è¡Œå–‰éƒ¨æª¢æŸ¥ï¼Œè©•ä¼°è²å¸¶ç‹€æ³');
                    } else {
                        recommendations.push(`â€¢ æ¸¬é‡å€¼ ${f0.toFixed(1)} Hz åé«˜ï¼ˆæ­£å¸¸ç¯„åœï¼š${range[0]}-${range[1]} Hzï¼‰`);
                        recommendations.push('â€¢ å¯èƒ½åŸå› ï¼šè²å¸¶ç·Šå¼µã€å£“åŠ›ã€ç™¼è²æ–¹å¼ä¸ç•¶');
                        recommendations.push('â€¢ å»ºè­°ï¼šå­¸ç¿’æ”¾é¬†æŠ€å·§ï¼Œèª¿æ•´ç™¼è²æ–¹å¼');
                    }
                    recommendations.push('');
                }
                
                if (!isSplNormal) {
                    const spl = measurementResults.spl;
                    const gender = document.getElementById('patientGender').value;
                    const range = gender === 'male' ? [65, 75] : [60, 70];
                    
                    recommendations.push('ğŸ”´ <strong>è²éŸ³éŸ¿åº¦ç•°å¸¸</strong>');
                    if (spl < range[0]) {
                        recommendations.push(`â€¢ æ¸¬é‡å€¼ ${spl.toFixed(1)} dB åä½ï¼ˆæ­£å¸¸ç¯„åœï¼š${range[0]}-${range[1]} dBï¼‰`);
                        recommendations.push('â€¢ å¯èƒ½åŸå› ï¼šå‘¼å¸æ”¯æŒä¸è¶³ã€è²å¸¶é–‰åˆä¸å…¨');
                        recommendations.push('â€¢ å»ºè­°ï¼šåŠ å¼·å‘¼å¸è¨“ç·´ï¼Œæ”¹å–„è²å¸¶é–‰åˆ');
                    } else {
                        recommendations.push(`â€¢ æ¸¬é‡å€¼ ${spl.toFixed(1)} dB åé«˜ï¼ˆæ­£å¸¸ç¯„åœï¼š${range[0]}-${range[1]} dBï¼‰`);
                        recommendations.push('â€¢ å¯èƒ½åŸå› ï¼šéåº¦ç”¨åŠ›ç™¼è²ã€ç·Šå¼µ');
                        recommendations.push('â€¢ å»ºè­°ï¼šå­¸ç¿’æ”¾é¬†ç™¼è²ï¼Œé¿å…å–‰éƒ¨ç·Šå¼µ');
                    }
                    recommendations.push('');
                }
                
                if (!isMptNormal) {
                    const mpt = measurementResults.mpt;
                    const gender = document.getElementById('patientGender').value;
                    const min = gender === 'male' ? 20 : 15;
                    
                    recommendations.push('ğŸ”´ <strong>æœ€å¤§ç™¼è²æ™‚é–“ä¸è¶³</strong>');
                    recommendations.push(`â€¢ æ¸¬é‡å€¼ ${mpt.toFixed(2)} ç§’ï¼ˆæ­£å¸¸ï¼šâ‰¥${min} ç§’ï¼‰`);
                    recommendations.push('â€¢ å¯èƒ½åŸå› ï¼šå‘¼å¸æ§åˆ¶ä¸ä½³ã€è²å¸¶é–‰åˆå•é¡Œã€è‚ºæ´»é‡ä¸è¶³');
                    recommendations.push('â€¢ å»ºè­°ï¼š');
                    recommendations.push('  - é€²è¡Œå‘¼å¸è¨“ç·´ï¼Œå¢å¼·å‘¼å¸æ”¯æŒ');
                    recommendations.push('  - ç·´ç¿’æŒçºŒç™¼è²ï¼Œé€æ­¥å»¶é•·æ™‚é–“');
                    recommendations.push('  - è©•ä¼°æ˜¯å¦æœ‰å‘¼å¸ç³»çµ±å•é¡Œ');
                    recommendations.push('');
                }
                
                if (!isJitterNormal) {
                    const jitter = measurementResults.jitter;
                    recommendations.push('ğŸ”´ <strong>å—“éŸ³æ“¾å‹•éé«˜</strong>');
                    recommendations.push(`â€¢ æ¸¬é‡å€¼ ${jitter.toFixed(2)}%ï¼ˆæ­£å¸¸ï¼š<1.04%ï¼‰`);
                    recommendations.push('â€¢ æ„ç¾©ï¼šè²å¸¶æŒ¯å‹•ä¸è¦å‰‡ï¼Œå¯èƒ½æœ‰è²å¸¶ç—…è®Š');
                    recommendations.push('â€¢ å»ºè­°ï¼š');
                    recommendations.push('  - <strong>å„˜é€Ÿå°±é†«é€²è¡Œè€³é¼»å–‰ç§‘æª¢æŸ¥</strong>');
                    recommendations.push('  - è©•ä¼°è²å¸¶çµæ§‹æ˜¯å¦æ­£å¸¸');
                    recommendations.push('  - é¿å…éåº¦ç”¨è²ï¼Œè®“è²å¸¶å……åˆ†ä¼‘æ¯');
                    recommendations.push('');
                }
                
                if (!isShimmerNormal) {
                    const shimmer = measurementResults.shimmer;
                    recommendations.push('ğŸ”´ <strong>æŒ¯å¹…æ“¾å‹•éé«˜</strong>');
                    recommendations.push(`â€¢ æ¸¬é‡å€¼ ${shimmer.toFixed(2)}%ï¼ˆæ­£å¸¸ï¼š<3.81%ï¼‰`);
                    recommendations.push('â€¢ æ„ç¾©ï¼šè²éŸ³å¼·åº¦ä¸ç©©å®šï¼Œå¯èƒ½åæ˜ è²å¸¶è³ªé‡æˆ–å¼µåŠ›å•é¡Œ');
                    recommendations.push('â€¢ å»ºè­°ï¼š');
                    recommendations.push('  - é€²è¡Œå°ˆæ¥­èªéŸ³è©•ä¼°');
                    recommendations.push('  - å¯èƒ½éœ€è¦èªè¨€æ²»ç™‚ä»‹å…¥');
                    recommendations.push('  - æ”¹å–„ç™¼è²æŠ€å·§ï¼Œç©©å®šæ°£æµ');
                    recommendations.push('');
                }
                
                if (!isHnrNormal) {
                    const hnr = measurementResults.hnr;
                    recommendations.push('ğŸ”´ <strong>è«§å™ªæ¯”åä½</strong>');
                    recommendations.push(`â€¢ æ¸¬é‡å€¼ ${hnr.toFixed(1)} dBï¼ˆæ­£å¸¸ï¼šâ‰¥20 dBï¼‰`);
                    recommendations.push('â€¢ æ„ç¾©ï¼šå—“éŸ³å“è³ªä¸‹é™ï¼Œè²éŸ³ä¸­é›œéŸ³æˆåˆ†è¼ƒå¤š');
                    recommendations.push('â€¢ å¯èƒ½åŸå› ï¼šè²å¸¶é–‰åˆä¸å…¨ã€è²å¸¶æ°´è…«ã€ç™¼ç‚');
                    recommendations.push('â€¢ å»ºè­°ï¼š');
                    recommendations.push('  - æ¸›å°‘ç”¨è²ï¼Œè®“è²å¸¶ä¼‘æ¯');
                    recommendations.push('  - é¿å…åˆºæ¿€æ€§é£Ÿç‰©å’Œè¸é…’');
                    recommendations.push('  - å°‹æ±‚èªè¨€æ²»ç™‚å¸«å”åŠ©');
                    recommendations.push('');
                }
                
                recommendations.push('ğŸ“Œ <strong>ä¸€èˆ¬ä¿é¤Šå»ºè­°ï¼š</strong>');
                recommendations.push('â€¢ é¿å…é•·æ™‚é–“å¤§è²èªªè©±æˆ–åœ¨åµé›œç’°å¢ƒä¸­ç”¨åŠ›ç™¼è²');
                recommendations.push('â€¢ ä¿æŒå……è¶³çš„æ°´åˆ†æ”å–ï¼ˆæ¯æ—¥è‡³å°‘ 2000ccï¼‰');
                recommendations.push('â€¢ é¿å…è¸é…’åŠåˆºæ¿€æ€§é£Ÿç‰©ï¼ˆè¾£ã€å†°ã€ç‚¸ï¼‰');
                recommendations.push('â€¢ å……è¶³ç¡çœ ï¼Œé¿å…ç†¬å¤œ');
                recommendations.push('â€¢ é©åº¦é‹å‹•ï¼Œå¢å¼·é«”èƒ½');
                recommendations.push('â€¢ å­¸ç¿’æ­£ç¢ºçš„ç™¼è²æŠ€å·§');
                recommendations.push('');
                recommendations.push('âš•ï¸ <strong>å°±é†«å»ºè­°ï¼š</strong>');
                recommendations.push('â€¢ å¦‚ç—‡ç‹€æŒçºŒè¶…é 2 é€±ï¼Œè«‹å„˜é€Ÿå°±é†«');
                recommendations.push('â€¢ å»ºè­°æ›è™Ÿï¼šè€³é¼»å–‰ç§‘ã€èªè¨€æ²»ç™‚ç§‘');
                recommendations.push('â€¢ æ”œå¸¶æœ¬å ±å‘Šä¾›é†«å¸«åƒè€ƒ');
            }

            document.getElementById('recommendations').innerHTML = recommendations.join('<br>');
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFont('helvetica');
            
            const name = document.getElementById('patientName').value;
            const gender = document.getElementById('patientGender').value === 'male' ? 'Male' : 'Female';
            const age = document.getElementById('patientAge').value || '-';
            const date = document.getElementById('measurementDate').value;

            doc.setFontSize(24);
            doc.setTextColor(102, 126, 234);
            doc.text('Voice Acoustic Analysis Report', 105, 20, { align: 'center' });

            doc.setDrawColor(102, 126, 234);
            doc.setLineWidth(0.5);
            doc.line(20, 25, 190, 25);

            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Patient Information', 20, 35);
            
            doc.setFontSize(11);
            doc.text(`Name: ${name}`, 20, 45);
            doc.text(`Gender: ${gender}`, 20, 52);
            doc.text(`Age: ${age}`, 20, 59);
            doc.text(`Date: ${date}`, 20, 66);

            // è³ªé‡è©•åˆ†
            const finalScore = document.getElementById('finalScoreValue').textContent;
            doc.setFontSize(14);
            doc.text('Overall Quality Score', 20, 80);
            doc.setFontSize(24);
            doc.setTextColor(102, 126, 234);
            doc.text(`${finalScore} / 100`, 20, 90);

            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Measurement Results', 20, 105);

            const tableData = [
                ['Parameter', 'Value', 'Normal Range', 'Status'],
                ['F0 (Hz)', measurementResults.f0.toFixed(1), 
                 gender === 'Male' ? '100-150' : '180-250',
                 document.getElementById('status_f0').textContent],
                ['SPL (dB)', measurementResults.spl.toFixed(1),
                 gender === 'Male' ? '65-75' : '60-70',
                 document.getElementById('status_spl').textContent],
                ['MPT (sec)', measurementResults.mpt.toFixed(2),
                 gender === 'Male' ? '>=20' : '>=15',
                 document.getElementById('status_mpt').textContent],
                ['Jitter (%)', measurementResults.jitter.toFixed(2), '<1.04',
                 document.getElementById('status_jitter').textContent],
                ['Shimmer (%)', measurementResults.shimmer.toFixed(2), '<3.81',
                 document.getElementById('status_shimmer').textContent],
                ['HNR (dB)', measurementResults.hnr.toFixed(1), '>=20',
                 document.getElementById('status_hnr').textContent]
            ];

            doc.autoTable({
                startY: 110,
                head: [tableData[0]],
                body: tableData.slice(1),
                theme: 'grid',
                headStyles: { fillColor: [102, 126, 234], fontSize: 11 },
                bodyStyles: { fontSize: 10 },
                columnStyles: {
                    0: { cellWidth: 40 },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 45 },
                    3: { cellWidth: 35 }
                }
            });

            let finalY = doc.lastAutoTable.finalY + 15;
            doc.setFontSize(14);
            doc.text('Recommendations', 20, finalY);
            
            finalY += 7;
            doc.setFontSize(9);
            const recText = document.getElementById('recommendations').innerText;
            const splitText = doc.splitTextToSize(recText, 170);
            
            // è™•ç†å¤šé 
            const pageHeight = doc.internal.pageSize.height;
            const lineHeight = 5;
            
            splitText.forEach((line, index) => {
                if (finalY + lineHeight > pageHeight - 20) {
                    doc.addPage();
                    finalY = 20;
                }
                doc.text(line, 20, finalY);
                finalY += lineHeight;
            });

            doc.setFontSize(9);
            doc.setTextColor(128, 128, 128);
            const footerY = doc.internal.pageSize.height - 15;
            doc.text('Generated by Voice Acoustic Analysis System (Enhanced)', 105, footerY, { align: 'center' });
            doc.text(`Report Date: ${new Date().toLocaleDateString()}`, 105, footerY + 5, { align: 'center' });

            doc.save(`Voice_Analysis_${name}_${Date.now()}.pdf`);
        }

        function resetSystem() {
            if (confirm('ç¢ºå®šè¦é–‹å§‹æ–°çš„æ¸¬é‡å—ï¼Ÿç›®å‰çš„è³‡æ–™å°‡æœƒæ¸…é™¤ã€‚')) {
                document.getElementById('patientName').value = '';
                document.getElementById('patientGender').value = '';
                document.getElementById('patientAge').value = '';
                document.getElementById('measurementDate').valueAsDate = new Date();
                document.getElementById('notes').value = '';

                audioBuffer = null;
                audioBlob = null;
                playBtn.disabled = true;
                downloadBtn.disabled = true;

                waveformCtx.clearRect(0, 0, waveformCanvas.width, waveformCanvas.height);
                spectrumCtx.clearRect(0, 0, spectrumCanvas.width, spectrumCanvas.height);

                document.getElementById('duration').textContent = '0.0s';
                document.getElementById('avgFreq').textContent = '- Hz';
                document.getElementById('peakAmp').textContent = '-';

                measurementResults = {
                    f0: 0,
                    spl: 0,
                    mpt: 0,
                    jitter: 0,
                    shimmer: 0,
                    hnr: 0
                };

                stageResults = {};
                currentStage = 0;
                
                document.getElementById('stageContainer').innerHTML = '';
                initStages();

                document.getElementById('qualityScore').style.display = 'none';
                document.getElementById('realtimeAnalysis').style.display = 'none';
                document.getElementById('liveSuggestions').style.display = 'none';

                goToStep(1);
                hideStatus();
            }
        }
    </script>
</body>
</html>
