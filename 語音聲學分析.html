<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å³æ™‚èªéŸ³è²å­¸åˆ†æå„€éŒ¶æ¿</title>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
        background: #0a0e27;
        color: #fff;
        overflow-x: hidden;
    }

    .dashboard {
        display: grid;
        grid-template-columns: 300px 1fr;
        grid-template-rows: auto 1fr;
        height: 100vh;
        gap: 0;
    }

    /* é ‚éƒ¨æ¨™é¡Œåˆ— */
    .header {
        grid-column: 1 / -1;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .header h1 {
        font-size: 1.8em;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .header-controls {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .status-indicator {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background: #28a745;
        box-shadow: 0 0 15px #28a745;
        animation: pulse 2s infinite;
    }

    .status-indicator.recording {
        background: #dc3545;
        box-shadow: 0 0 15px #dc3545;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* å·¦å´æ§åˆ¶é¢æ¿ */
    .control-panel {
        background: #1a1f3a;
        padding: 25px;
        overflow-y: auto;
        border-right: 2px solid #2a2f4a;
    }

    .control-section {
        margin-bottom: 30px;
    }

    .control-section h3 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid #2a2f4a;
    }

    .control-btn {
        width: 100%;
        padding: 15px;
        margin-bottom: 10px;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .control-btn.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .control-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .control-btn.danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }

    .control-btn.danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(220, 53, 69, 0.4);
    }

    .control-btn.success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .control-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    .patient-info {
        background: #2a2f4a;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .patient-info label {
        display: block;
        margin-bottom: 8px;
        color: #a0a5c0;
        font-size: 0.9em;
    }

    .patient-info input,
    .patient-info select {
        width: 100%;
        padding: 10px;
        border: 2px solid #3a3f5a;
        border-radius: 5px;
        background: #1a1f3a;
        color: white;
        font-size: 0.95em;
    }

    .patient-info input:focus,
    .patient-info select:focus {
        outline: none;
        border-color: #667eea;
    }

    /* ä¸»è¦å„€éŒ¶æ¿å€åŸŸ */
    .main-dashboard {
        padding: 25px;
        overflow-y: auto;
        background: #0f1329;
    }

    /* å³æ™‚æŒ‡æ¨™å¡ç‰‡ç¶²æ ¼ */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .metric-card {
        background: linear-gradient(135deg, #1a1f3a 0%, #2a2f4a 100%);
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #3a3f5a;
        position: relative;
        overflow: hidden;
        transition: all 0.3s;
    }

    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }

    .metric-card.warning::before {
        background: linear-gradient(90deg, #ffc107 0%, #ff9800 100%);
    }

    .metric-card.danger::before {
        background: linear-gradient(90deg, #dc3545 0%, #c82333 100%);
    }

    .metric-card.success::before {
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
    }

    .metric-label {
        font-size: 0.9em;
        color: #a0a5c0;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .metric-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #fff;
        line-height: 1;
        margin-bottom: 8px;
    }

    .metric-unit {
        font-size: 0.5em;
        color: #667eea;
        margin-left: 5px;
    }

    .metric-status {
        font-size: 0.85em;
        padding: 4px 12px;
        border-radius: 20px;
        display: inline-block;
        margin-top: 8px;
    }

    .metric-status.normal {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
        border: 1px solid #28a745;
    }

    .metric-status.warning {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border: 1px solid #ffc107;
    }

    .metric-status.danger {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
        border: 1px solid #dc3545;
    }

    .metric-trend {
        position: absolute;
        bottom: 10px;
        right: 15px;
        font-size: 1.5em;
        opacity: 0.3;
    }

    /* è¦–è¦ºåŒ–åœ–è¡¨å€åŸŸ */
    .visualization-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 25px;
    }

    .chart-container {
        background: #1a1f3a;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #3a3f5a;
    }

    .chart-container h3 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    canvas {
        width: 100% !important;
        height: 250px !important;
        background: #0f1329;
        border-radius: 8px;
    }

    /* åœ“å½¢é€²åº¦æŒ‡ç¤ºå™¨ */
    .circular-progress-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .circular-progress {
        background: #1a1f3a;
        padding: 25px;
        border-radius: 12px;
        border: 2px solid #3a3f5a;
        text-align: center;
    }

    .progress-ring {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 15px;
    }

    .progress-ring svg {
        transform: rotate(-90deg);
    }

    .progress-ring-circle {
        transition: stroke-dashoffset 0.5s ease;
        stroke: #3a3f5a;
        fill: transparent;
    }

    .progress-ring-progress {
        transition: stroke-dashoffset 0.5s ease;
        stroke: url(#gradient);
        fill: transparent;
        stroke-linecap: round;
    }

    .progress-ring-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.8em;
        font-weight: bold;
        color: #fff;
    }

    .progress-label {
        color: #a0a5c0;
        font-size: 0.95em;
        margin-bottom: 5px;
    }

    .progress-status {
        font-size: 0.85em;
        color: #667eea;
        font-weight: bold;
    }

    /* å³æ™‚å»ºè­°é¢æ¿ */
    .suggestions-panel {
        background: linear-gradient(135deg, #1a1f3a 0%, #2a2f4a 100%);
        padding: 25px;
        border-radius: 12px;
        border: 2px solid #667eea;
        margin-bottom: 25px;
    }

    .suggestions-panel h3 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 1.2em;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .suggestion-item {
        background: rgba(102, 126, 234, 0.1);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 12px;
        border-left: 4px solid #667eea;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        animation: slideIn 0.5s ease;
    }

    .suggestion-item.warning {
        border-left-color: #ffc107;
        background: rgba(255, 193, 7, 0.1);
    }

    .suggestion-item.danger {
        border-left-color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
    }

    .suggestion-item.success {
        border-left-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .suggestion-icon {
        font-size: 1.5em;
        flex-shrink: 0;
    }

    .suggestion-text {
        flex: 1;
        line-height: 1.6;
    }

    /* é »è­œåˆ†æå™¨ */
    .spectrum-analyzer {
        background: #1a1f3a;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #3a3f5a;
        margin-bottom: 25px;
    }

    .spectrum-analyzer h3 {
        color: #667eea;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    #spectrumCanvas {
        height: 300px !important;
    }

    /* æ³¢å½¢é¡¯ç¤º */
    .waveform-display {
        background: #1a1f3a;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #3a3f5a;
    }

    .waveform-display h3 {
        color: #667eea;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 1200px) {
        .visualization-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .dashboard {
            grid-template-columns: 1fr;
        }

        .control-panel {
            border-right: none;
            border-bottom: 2px solid #2a2f4a;
        }

        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .circular-progress-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* æ™‚é–“è»¸ */
    .timeline {
        background: #1a1f3a;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #3a3f5a;
        margin-bottom: 25px;
    }

    .timeline h3 {
        color: #667eea;
        margin-bottom: 15px;
    }

    .timeline-bar {
        background: #0f1329;
        height: 40px;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
    }

    .timeline-progress {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 15px;
        color: white;
        font-weight: bold;
    }

    /* è³ªé‡è©•åˆ†å„€è¡¨ */
    .quality-gauge {
        background: #1a1f3a;
        padding: 30px;
        border-radius: 12px;
        border: 2px solid #3a3f5a;
        text-align: center;
    }

    .quality-gauge h3 {
        color: #667eea;
        margin-bottom: 20px;
    }

    .gauge-container {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto;
    }

    .gauge-svg {
        transform: rotate(-90deg);
    }

    .gauge-background {
        fill: none;
        stroke: #3a3f5a;
        stroke-width: 15;
    }

    .gauge-progress {
        fill: none;
        stroke: url(#gaugeGradient);
        stroke-width: 15;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.5s ease;
    }

    .gauge-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3em;
        font-weight: bold;
        color: #fff;
    }

    .gauge-label {
        margin-top: 15px;
        font-size: 1.1em;
        color: #a0a5c0;
    }

    /* éŒ„éŸ³æ™‚é–“é¡¯ç¤º */
    .recording-timer {
        font-size: 2em;
        color: #dc3545;
        font-weight: bold;
        text-align: center;
        padding: 15px;
        background: rgba(220, 53, 69, 0.1);
        border-radius: 8px;
        margin-bottom: 15px;
        display: none;
    }

    .recording-timer.active {
        display: block;
        animation: pulse 1s infinite;
    }

    /* é »ç‡ç¯„åœæŒ‡ç¤ºå™¨ */
    .frequency-bands {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-top: 15px;
    }

    .frequency-band {
        text-align: center;
        padding: 10px;
        background: #0f1329;
        border-radius: 6px;
    }

    .frequency-band-label {
        font-size: 0.8em;
        color: #a0a5c0;
        margin-bottom: 5px;
    }

    .frequency-band-value {
        font-size: 1.2em;
        font-weight: bold;
        color: #667eea;
    }

    .frequency-band-bar {
        height: 60px;
        background: #1a1f3a;
        border-radius: 4px;
        margin-top: 8px;
        position: relative;
        overflow: hidden;
    }

    .frequency-band-fill {
        position: absolute;
        bottom: 0;
        width: 100%;
        background: linear-gradient(to top, #667eea, #764ba2);
        transition: height 0.2s;
    }
</style>
</head>
<body>
<div class="dashboard">
    <!-- é ‚éƒ¨æ¨™é¡Œåˆ— -->
    <div class="header">
        <h1>
            <span>ğŸ™ï¸</span>
            å³æ™‚èªéŸ³è²å­¸åˆ†æå„€éŒ¶æ¿
        </h1>
        <div class="header-controls">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">å°±ç·’</span>
        </div>
    </div>

    <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <div class="control-section">
            <h3>ğŸ‘¤ æ‚£è€…è³‡è¨Š</h3>
            <div class="patient-info">
                <label>å§“å</label>
                <input type="text" id="patientName" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            <div class="patient-info">
                <label>æ€§åˆ¥</label>
                <select id="patientGender">
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="male">ç”·æ€§</option>
                    <option value="female">å¥³æ€§</option>
                </select>
            </div>
            <div class="patient-info">
                <label>å¹´é½¡</label>
                <input type="number" id="patientAge" placeholder="è«‹è¼¸å…¥å¹´é½¡">
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸ›ï¸ éŒ„éŸ³æ§åˆ¶</h3>
            <div class="recording-timer" id="recordingTimer">00:00</div>
            <button class="control-btn danger" id="recordBtn">
                <span>ğŸ”´</span> é–‹å§‹éŒ„éŸ³
            </button>
            <button class="control-btn primary" id="playBtn" disabled>
                <span>â–¶ï¸</span> æ’­æ”¾éŒ„éŸ³
            </button>
            <button class="control-btn success" id="analyzeBtn" disabled>
                <span>ğŸ“Š</span> åˆ†æçµæœ
            </button>
        </div>

        <div class="control-section">
            <h3>âš™ï¸ è¨­å®š</h3>
            <div class="patient-info">
                <label>æ¡æ¨£ç‡</label>
                <select id="sampleRateSelect">
                    <option value="44100">44.1 kHz</option>
                    <option value="48000" selected>48 kHz</option>
                </select>
            </div>
            <div class="patient-info">
                <label>éˆæ•åº¦</label>
                <input type="range" id="sensitivity" min="0" max="100" value="80">
            </div>
        </div>

        <div class="control-section">
            <button class="control-btn primary" onclick="resetDashboard()">
                <span>ğŸ”„</span> é‡ç½®å„€éŒ¶æ¿
            </button>
        </div>
    </div>

    <!-- ä¸»è¦å„€éŒ¶æ¿å€åŸŸ -->
    <div class="main-dashboard">
        <!-- å³æ™‚æŒ‡æ¨™å¡ç‰‡ -->
        <div class="metrics-grid">
            <div class="metric-card" id="f0Card">
                <div class="metric-label">
                    <span>ğŸµ</span> åŸºæœ¬é »ç‡ (F0)
                </div>
                <div class="metric-value">
                    <span id="f0Value">--</span>
                    <span class="metric-unit">Hz</span>
                </div>
                <span class="metric-status normal" id="f0Status">å¾…æ¸¬é‡</span>
                <div class="metric-trend">ğŸ“ˆ</div>
            </div>

            <div class="metric-card" id="splCard">
                <div class="metric-label">
                    <span>ğŸ”Š</span> è²éŸ³éŸ¿åº¦ (SPL)
                </div>
                <div class="metric-value">
                    <span id="splValue">--</span>
                    <span class="metric-unit">dB</span>
                </div>
                <span class="metric-status normal" id="splStatus">å¾…æ¸¬é‡</span>
                <div class="metric-trend">ğŸ“Š</div>
            </div>

            <div class="metric-card" id="jitterCard">
                <div class="metric-label">
                    <span>ã€°ï¸</span> å—“éŸ³æ“¾å‹• (Jitter)
                </div>
                <div class="metric-value">
                    <span id="jitterValue">--</span>
                    <span class="metric-unit">%</span>
                </div>
                <span class="metric-status normal" id="jitterStatus">å¾…æ¸¬é‡</span>
                <div class="metric-trend">ğŸ“‰</div>
            </div>

            <div class="metric-card" id="shimmerCard">
                <div class="metric-label">
                    <span>ğŸ“¶</span> æŒ¯å¹…æ“¾å‹• (Shimmer)
                </div>
                <div class="metric-value">
                    <span id="shimmerValue">--</span>
                    <span class="metric-unit">%</span>
                </div>
                <span class="metric-status normal" id="shimmerStatus">å¾…æ¸¬é‡</span>
                <div class="metric-trend">ğŸ“‰</div>
            </div>

            <div class="metric-card" id="hnrCard">
                <div class="metric-label">
                    <span>âœ¨</span> è«§å™ªæ¯” (HNR)
                </div>
                <div class="metric-value">
                    <span id="hnrValue">--</span>
                    <span class="metric-unit">dB</span>
                </div>
                <span class="metric-status normal" id="hnrStatus">å¾…æ¸¬é‡</span>
                <div class="metric-trend">ğŸ“ˆ</div>
            </div>

            <div class="metric-card" id="mptCard">
                <div class="metric-label">
                    <span>â±ï¸</span> ç™¼è²æ™‚é–“ (MPT)
                </div>
                <div class="metric-value">
                    <span id="mptValue">--</span>
                    <span class="metric-unit">ç§’</span>
                </div>
                <span class="metric-status normal" id="mptStatus">å¾…æ¸¬é‡</span>
                <div class="metric-trend">â³</div>
            </div>
        </div>

        <!-- è³ªé‡è©•åˆ†å„€è¡¨ -->
        <div class="quality-gauge">
            <h3>ğŸ¯ å³æ™‚èªéŸ³è³ªé‡è©•åˆ†</h3>
            <div class="gauge-container">
                <svg class="gauge-svg" width="200" height="200">
                    <defs>
                        <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="gauge-background" cx="100" cy="100" r="85" stroke-width="15"></circle>
                    <circle class="gauge-progress" id="gaugeProgress" cx="100" cy="100" r="85" 
                            stroke-width="15" stroke-dasharray="534.07" stroke-dashoffset="534.07"></circle>
                </svg>
                <div class="gauge-text" id="gaugeText">--</div>
            </div>
            <div class="gauge-label" id="gaugeLabel">ç­‰å¾…æ¸¬é‡</div>
        </div>

        <!-- æ™‚é–“è»¸ -->
        <div class="timeline">
            <h3>â±ï¸ éŒ„éŸ³æ™‚é–“è»¸</h3>
            <div class="timeline-bar">
                <div class="timeline-progress" id="timelineProgress" style="width: 0%">
                    <span id="timelineText">0.0s</span>
                </div>
            </div>
        </div>

        <!-- è¦–è¦ºåŒ–åœ–è¡¨ -->
        <div class="visualization-grid">
            <div class="chart-container waveform-display">
                <h3>ğŸ“Š å³æ™‚æ³¢å½¢åœ–</h3>
                <canvas id="waveformCanvas"></canvas>
            </div>

            <div class="chart-container spectrum-analyzer">
                <h3>ğŸŒˆ é »è­œåˆ†æ</h3>
                <canvas id="spectrumCanvas"></canvas>
                <div class="frequency-bands">
                    <div class="frequency-band">
                        <div class="frequency-band-label">ä½é »</div>
                        <div class="frequency-band-value" id="lowFreq">0</div>
                        <div class="frequency-band-bar">
                            <div class="frequency-band-fill" id="lowFreqBar"></div>
                        </div>
                    </div>
                    <div class="frequency-band">
                        <div class="frequency-band-label">ä¸­ä½é »</div>
                        <div class="frequency-band-value" id="midLowFreq">0</div>
                        <div class="frequency-band-bar">
                            <div class="frequency-band-fill" id="midLowFreqBar"></div>
                        </div>
                    </div>
                    <div class="frequency-band">
                        <div class="frequency-band-label">ä¸­é«˜é »</div>
                        <div class="frequency-band-value" id="midHighFreq">0</div>
                        <div class="frequency-band-bar">
                            <div class="frequency-band-fill" id="midHighFreqBar"></div>
                        </div>
                    </div>
                    <div class="frequency-band">
                        <div class="frequency-band-label">é«˜é »</div>
                        <div class="frequency-band-value" id="highFreq">0</div>
                        <div class="frequency-band-bar">
                            <div class="frequency-band-fill" id="highFreqBar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åœ“å½¢é€²åº¦æŒ‡ç¤ºå™¨ -->
        <div class="circular-progress-grid">
            <div class="circular-progress">
                <div class="progress-ring">
                    <svg width="120" height="120">
                        <defs>
                            <linearGradient id="gradient1">
                                <stop offset="0%" stop-color="#667eea"/>
                                <stop offset="100%" stop-color="#764ba2"/>
                            </linearGradient>
                        </defs>
                        <circle class="progress-ring-circle" cx="60" cy="60" r="52" stroke-width="8"></circle>
                        <circle class="progress-ring-progress" id="stabilityProgress" cx="60" cy="60" r="52" 
                                stroke-width="8" stroke-dasharray="326.73" stroke-dashoffset="326.73"></circle>
                    </svg>
                    <div class="progress-ring-text" id="stabilityText">--</div>
                </div>
                <div class="progress-label">è²éŸ³ç©©å®šæ€§</div>
                <div class="progress-status" id="stabilityStatus">å¾…æ¸¬é‡</div>
            </div>

            <div class="circular-progress">
                <div class="progress-ring">
                    <svg width="120" height="120">
                        <circle class="progress-ring-circle" cx="60" cy="60" r="52" stroke-width="8"></circle>
                        <circle class="progress-ring-progress" id="clarityProgress" cx="60" cy="60" r="52" 
                                stroke-width="8" stroke-dasharray="326.73" stroke-dashoffset="326.73"></circle>
                    </svg>
                    <div class="progress-ring-text" id="clarityText">--</div>
                </div>
                <div class="progress-label">è²éŸ³æ¸…æ™°åº¦</div>
                <div class="progress-status" id="clarityStatus">å¾…æ¸¬é‡</div>
            </div>

            <div class="circular-progress">
                <div class="progress-ring">
                    <svg width="120" height="120">
                        <circle class="progress-ring-circle" cx="60" cy="60" r="52" stroke-width="8"></circle>
                        <circle class="progress-ring-progress" id="strengthProgress" cx="60" cy="60" r="52" 
                                stroke-width="8" stroke-dasharray="326.73" stroke-dashoffset="326.73"></circle>
                    </svg>
                    <div class="progress-ring-text" id="strengthText">--</div>
                </div>
                <div class="progress-label">è²éŸ³å¼·åº¦</div>
                <div class="progress-status" id="strengthStatus">å¾…æ¸¬é‡</div>
            </div>

            <div class="circular-progress">
                <div class="progress-ring">
                    <svg width="120" height="120">
                        <circle class="progress-ring-circle" cx="60" cy="60" r="52" stroke-width="8"></circle>
                        <circle class="progress-ring-progress" id="consistencyProgress" cx="60" cy="60" r="52" 
                                stroke-width="8" stroke-dasharray="326.73" stroke-dashoffset="326.73"></circle>
                    </svg>
                    <div class="progress-ring-text" id="consistencyText">--</div>
                </div>
                <div class="progress-label">ä¸€è‡´æ€§</div>
                <div class="progress-status" id="consistencyStatus">å¾…æ¸¬é‡</div>
            </div>
        </div>

        <!-- å³æ™‚å»ºè­°é¢æ¿ -->
        <div class="suggestions-panel">
            <h3>ğŸ’¡ å³æ™‚å»ºè­°èˆ‡æŒ‡å°</h3>
            <div id="suggestionsContainer">
                <div class="suggestion-item">
                    <div class="suggestion-icon">â„¹ï¸</div>
                    <div class="suggestion-text">
                        è«‹é»æ“Šã€Œé–‹å§‹éŒ„éŸ³ã€æŒ‰éˆ•é–‹å§‹èªéŸ³åˆ†æã€‚å»ºè­°åœ¨å®‰éœçš„ç’°å¢ƒä¸­é€²è¡Œæ¸¬è©¦ï¼Œéº¥å…‹é¢¨è·é›¢å˜´å·´ç´„ 30 å…¬åˆ†ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // å…¨åŸŸè®Šæ•¸
    let audioContext;
    let analyser;
    let microphone;
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let isPlaying = false;
    let animationId;
    let recordingStartTime;
    let recordingInterval;
    let audioBuffer;
    let source;

    // Canvas å…ƒç´ 
    const waveformCanvas = document.getElementById('waveformCanvas');
    const waveformCtx = waveformCanvas.getContext('2d');
    const spectrumCanvas = document.getElementById('spectrumCanvas');
    const spectrumCtx = spectrumCanvas.getContext('2d');

    // æ§åˆ¶æŒ‰éˆ•
    const recordBtn = document.getElementById('recordBtn');
    const playBtn = document.getElementById('playBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');

    // å³æ™‚æŒ‡æ¨™
    let realtimeMetrics = {
        f0: 0,
        spl: 0,
        jitter: 0,
        shimmer: 0,
        hnr: 0,
        mpt: 0,
        stability: 0,
        clarity: 0,
        strength: 0,
        consistency: 0
    };

    // åˆå§‹åŒ–
    window.onload = function() {
        resizeCanvas();
        initializeVisualizations();
    };

    window.onresize = resizeCanvas;

    function resizeCanvas() {
        waveformCanvas.width = waveformCanvas.offsetWidth;
        waveformCanvas.height = 250;
        spectrumCanvas.width = spectrumCanvas.offsetWidth;
        spectrumCanvas.height = 250;
    }

    function initializeVisualizations() {
        // ç¹ªè£½åˆå§‹ç‹€æ…‹
        drawWaveform([]);
        drawSpectrum([]);
    }

    // éŒ„éŸ³æ§åˆ¶
    recordBtn.addEventListener('click', async () => {
        if (!isRecording) {
            await startRecording();
        } else {
            stopRecording();
        }
    });

    async function startRecording() {
        try {
            // åˆå§‹åŒ–éŸ³è¨Šä¸Šä¸‹æ–‡
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // è«‹æ±‚éº¥å…‹é¢¨æ¬Šé™
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false
                }
            });

            // è¨­å®š MediaRecorder
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const arrayBuffer = await audioBlob.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                playBtn.disabled = false;
                analyzeBtn.disabled = false;
                
                stream.getTracks().forEach(track => track.stop());
            };

            // è¨­å®šåˆ†æå™¨
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);

            // é–‹å§‹éŒ„éŸ³
            mediaRecorder.start();
            isRecording = true;
            recordingStartTime = Date.now();

            // æ›´æ–° UI
            recordBtn.innerHTML = '<span>â¹</span> åœæ­¢éŒ„éŸ³';
            recordBtn.classList.remove('danger');
            recordBtn.classList.add('success');
            document.getElementById('statusIndicator').classList.add('recording');
            document.getElementById('statusText').textContent = 'éŒ„éŸ³ä¸­';
            document.getElementById('recordingTimer').classList.add('active');

            // é–‹å§‹è¦–è¦ºåŒ–å’Œåˆ†æ
            visualizeRecording();
            startRealtimeAnalysis();
            startRecordingTimer();

        } catch (err) {
            alert('ç„¡æ³•å­˜å–éº¥å…‹é¢¨: ' + err.message);
        }
    }

    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            microphone.disconnect();
            isRecording = false;

            // æ›´æ–° UI
            recordBtn.innerHTML = '<span>ğŸ”´</span> é–‹å§‹éŒ„éŸ³';
            recordBtn.classList.remove('success');
            recordBtn.classList.add('danger');
            document.getElementById('statusIndicator').classList.remove('recording');
            document.getElementById('statusText').textContent = 'å°±ç·’';
            document.getElementById('recordingTimer').classList.remove('active');

            // åœæ­¢å‹•ç•«å’Œè¨ˆæ™‚å™¨
            cancelAnimationFrame(animationId);
            clearInterval(recordingInterval);
            stopRealtimeAnalysis();

            // è¨ˆç®— MPT
            const duration = (Date.now() - recordingStartTime) / 1000;
            realtimeMetrics.mpt = duration;
            updateMetricCard('mpt', duration);
        }
    }

    // éŒ„éŸ³è¨ˆæ™‚å™¨
    function startRecordingTimer() {
        recordingInterval = setInterval(() => {
            const elapsed = (Date.now() - recordingStartTime) / 1000;
            const minutes = Math.floor(elapsed / 60);
            const seconds = Math.floor(elapsed % 60);
            document.getElementById('recordingTimer').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            // æ›´æ–°æ™‚é–“è»¸
            const maxTime = 30; // æœ€å¤§30ç§’
            const progress = Math.min((elapsed / maxTime) * 100, 100);
            document.getElementById('timelineProgress').style.width = progress + '%';
            document.getElementById('timelineText').textContent = elapsed.toFixed(1) + 's';
        }, 100);
    }

    // å³æ™‚è¦–è¦ºåŒ–
    function visualizeRecording() {
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        const freqArray = new Uint8Array(bufferLength);

        function draw() {
            if (!isRecording) return;
            animationId = requestAnimationFrame(draw);

            analyser.getByteTimeDomainData(dataArray);
            analyser.getByteFrequencyData(freqArray);

            drawWaveform(dataArray);
            drawSpectrum(freqArray);
            updateFrequencyBands(freqArray);
        }

        draw();
    }

    // ç¹ªè£½æ³¢å½¢
    function drawWaveform(dataArray) {
        waveformCtx.fillStyle = '#0f1329';
        waveformCtx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);

        if (dataArray.length === 0) {
            // ç¹ªè£½ä¸­ç·š
            waveformCtx.strokeStyle = '#3a3f5a';
            waveformCtx.lineWidth = 2;
            waveformCtx.beginPath();
            waveformCtx.moveTo(0, waveformCanvas.height / 2);
            waveformCtx.lineTo(waveformCanvas.width, waveformCanvas.height / 2);
            waveformCtx.stroke();
            return;
        }

        waveformCtx.lineWidth = 3;
        waveformCtx.strokeStyle = '#667eea';
        waveformCtx.beginPath();

        const sliceWidth = waveformCanvas.width / dataArray.length;
        let x = 0;

        for (let i = 0; i < dataArray.length; i++) {
            const v = dataArray[i] / 128.0;
            const y = v * waveformCanvas.height / 2;

            if (i === 0) {
                waveformCtx.moveTo(x, y);
            } else {
                waveformCtx.lineTo(x, y);
            }

            x += sliceWidth;
        }

        waveformCtx.lineTo(waveformCanvas.width, waveformCanvas.height / 2);
        waveformCtx.stroke();
    }

    // ç¹ªè£½é »è­œ
    function drawSpectrum(freqArray) {
        spectrumCtx.fillStyle = '#0f1329';
        spectrumCtx.fillRect(0, 0, spectrumCanvas.width, spectrumCanvas.height);

        if (freqArray.length === 0) return;

        const barWidth = (spectrumCanvas.width / freqArray.length) * 2.5;
        let x = 0;

        for (let i = 0; i < freqArray.length; i++) {
            const barHeight = (freqArray[i] / 255) * spectrumCanvas.height;
            
            // å½©è™¹æ¼¸å±¤
            const hue = (i / freqArray.length) * 360;
            spectrumCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
            spectrumCtx.fillRect(x, spectrumCanvas.height - barHeight, barWidth, barHeight);

            x += barWidth + 1;
        }
    }

    // æ›´æ–°é »ç‡å¸¶
    function updateFrequencyBands(freqArray) {
        if (freqArray.length === 0) return;

        const bands = [
            { id: 'low', start: 0, end: Math.floor(freqArray.length * 0.1) },
            { id: 'midLow', start: Math.floor(freqArray.length * 0.1), end: Math.floor(freqArray.length * 0.3) },
            { id: 'midHigh', start: Math.floor(freqArray.length * 0.3), end: Math.floor(freqArray.length * 0.6) },
            { id: 'high', start: Math.floor(freqArray.length * 0.6), end: freqArray.length }
        ];

        bands.forEach(band => {
            let sum = 0;
            for (let i = band.start; i < band.end; i++) {
                sum += freqArray[i];
            }
            const avg = Math.round(sum / (band.end - band.start));
            const percentage = (avg / 255) * 100;

            document.getElementById(`${band.id}Freq`).textContent = avg;
            document.getElementById(`${band.id}FreqBar`).style.height = percentage + '%';
        });
    }

    // å³æ™‚åˆ†æ
    let analysisInterval;

    function startRealtimeAnalysis() {
        analysisInterval = setInterval(() => {
            if (!isRecording || !analyser) return;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const freqArray = new Uint8Array(bufferLength);

            analyser.getByteTimeDomainData(dataArray);
            analyser.getByteFrequencyData(freqArray);

            calculateRealtimeMetrics(dataArray, freqArray);
            updateAllMetrics();
            updateSuggestions();
        }, 200);
    }

    function stopRealtimeAnalysis() {
        if (analysisInterval) {
            clearInterval(analysisInterval);
        }
    }

    // è¨ˆç®—å³æ™‚æŒ‡æ¨™
    function calculateRealtimeMetrics(dataArray, freqArray) {
        const gender = document.getElementById('patientGender').value;

        // è¨ˆç®— F0
        let sum = 0, count = 0;
        for (let i = 0; i < freqArray.length; i++) {
            if (freqArray[i] > 0) {
                sum += i * freqArray[i];
                count += freqArray[i];
            }
        }
        if (count > 0 && audioContext) {
            const avgBin = sum / count;
            const nyquist = audioContext.sampleRate / 2;
            realtimeMetrics.f0 = (avgBin / freqArray.length) * nyquist;
        }

        // è¨ˆç®— SPL
        let rmsSum = 0;
        for (let i = 0; i < dataArray.length; i++) {
            const normalized = (dataArray[i] - 128) / 128;
            rmsSum += normalized * normalized;
        }
        const rms = Math.sqrt(rmsSum / dataArray.length);
        realtimeMetrics.spl = Math.max(0, Math.min(120, 20 * Math.log10(rms / 0.00002) + 94));

        // è¨ˆç®—ç©©å®šæ€§
        let variance = 0;
        const mean = dataArray.reduce((a, b) => a + b) / dataArray.length;
        for (let i = 0; i < dataArray.length; i++) {
            variance += Math.pow(dataArray[i] - mean, 2);
        }
        const stdDev = Math.sqrt(variance / dataArray.length);
        realtimeMetrics.stability = Math.max(0, 100 - (stdDev / mean * 100));

        // ç°¡åŒ–çš„ Jitter
        let periodDiffs = 0;
        for (let i = 1; i < dataArray.length; i++) {
            if (dataArray[i-1] < 128 && dataArray[i] >= 128) {
                periodDiffs++;
            }
        }
        realtimeMetrics.jitter = Math.min(5, periodDiffs / dataArray.length * 100);

        // ç°¡åŒ–çš„ HNR
        const signalPower = rms * rms;
        const noisePower = variance / (dataArray.length * dataArray.length);
        realtimeMetrics.hnr = noisePower > 0 ? Math.min(40, 10 * Math.log10(signalPower / noisePower)) : 40;

        // è¨ˆç®—æ¸…æ™°åº¦
        realtimeMetrics.clarity = Math.min(100, (realtimeMetrics.hnr / 40) * 100);

        // è¨ˆç®—å¼·åº¦
        realtimeMetrics.strength = Math.min(100, (realtimeMetrics.spl / 80) * 100);

        // è¨ˆç®—ä¸€è‡´æ€§
        realtimeMetrics.consistency = realtimeMetrics.stability;

        // Shimmer (ç°¡åŒ–ç‰ˆ)
        realtimeMetrics.shimmer = Math.min(10, (100 - realtimeMetrics.stability) / 10);
    }

    // æ›´æ–°æ‰€æœ‰æŒ‡æ¨™
    function updateAllMetrics() {
        updateMetricCard('f0', realtimeMetrics.f0);
        updateMetricCard('spl', realtimeMetrics.spl);
        updateMetricCard('jitter', realtimeMetrics.jitter);
        updateMetricCard('shimmer', realtimeMetrics.shimmer);
        updateMetricCard('hnr', realtimeMetrics.hnr);

        updateCircularProgress('stability', realtimeMetrics.stability);
        updateCircularProgress('clarity', realtimeMetrics.clarity);
        updateCircularProgress('strength', realtimeMetrics.strength);
        updateCircularProgress('consistency', realtimeMetrics.consistency);

        updateQualityGauge();
    }

    // æ›´æ–°æŒ‡æ¨™å¡ç‰‡
    function updateMetricCard(metric, value) {
        const valueElement = document.getElementById(`${metric}Value`);
        const statusElement = document.getElementById(`${metric}Status`);
        const cardElement = document.getElementById(`${metric}Card`);

        valueElement.textContent = value.toFixed(metric === 'mpt' ? 2 : 1);

        const gender = document.getElementById('patientGender').value;
        let status = 'normal';
        let statusText = 'æ­£å¸¸';

        switch(metric) {
            case 'f0':
                const f0Range = gender === 'male' ? [100, 150] : [180, 250];
                if (value < f0Range[0] || value > f0Range[1]) {
                    status = value < f0Range[0] * 0.8 || value > f0Range[1] * 1.2 ? 'danger' : 'warning';
                    statusText = status === 'danger' ? 'ç•°å¸¸' : 'æ³¨æ„';
                }
                break;
            case 'spl':
                const splRange = gender === 'male' ? [65, 75] : [60, 70];
                if (value < splRange[0] || value > splRange[1]) {
                    status = value < splRange[0] - 10 || value > splRange[1] + 10 ? 'danger' : 'warning';
                    statusText = status === 'danger' ? 'ç•°å¸¸' : 'æ³¨æ„';
                }
                break;
            case 'jitter':
                if (value >= 1.04) {
                    status = value > 2 ? 'danger' : 'warning';
                    statusText = status === 'danger' ? 'ç•°å¸¸' : 'æ³¨æ„';
                }
                break;
            case 'shimmer':
                if (value >= 3.81) {
                    status = value > 6 ? 'danger' : 'warning';
                    statusText = status === 'danger' ? 'ç•°å¸¸' : 'æ³¨æ„';
                }
                break;
            case 'hnr':
                if (value < 20) {
                    status = value < 10 ? 'danger' : 'warning';
                    statusText = status === 'danger' ? 'ä¸ä½³' : 'å°šå¯';
                } else {
                    statusText = 'å„ªè‰¯';
                }
                break;
            case 'mpt':
                const mptMin = gender === 'male' ? 20 : 15;
                if (value < mptMin) {
                    status = value < mptMin * 0.7 ? 'danger' : 'warning';
                    statusText = status === 'danger' ? 'ä¸è¶³' : 'åä½';
                }
                break;
        }

        statusElement.textContent = statusText;
        statusElement.className = `metric-status ${status}`;
        cardElement.className = `metric-card ${status}`;
    }

    // æ›´æ–°åœ“å½¢é€²åº¦
    function updateCircularProgress(id, value) {
        const progressElement = document.getElementById(`${id}Progress`);
        const textElement = document.getElementById(`${id}Text`);
        const statusElement = document.getElementById(`${id}Status`);

        const circumference = 326.73;
        const offset = circumference - (value / 100) * circumference;

        progressElement.style.strokeDashoffset = offset;
        textElement.textContent = Math.round(value);

        let statusText = 'å„ªè‰¯';
        if (value < 60) statusText = 'ä¸ä½³';
        else if (value < 80) statusText = 'å°šå¯';

        statusElement.textContent = statusText;
    }

    // æ›´æ–°è³ªé‡è©•åˆ†å„€è¡¨
    function updateQualityGauge() {
        const gender = document.getElementById('patientGender').value;
        if (!gender) return;

        const f0Range = gender === 'male' ? [100, 150] : [180, 250];
        const splRange = gender === 'male' ? [65, 75] : [60, 70];

        let score = 0;

        // F0 è©•åˆ† (20åˆ†)
        if (realtimeMetrics.f0 >= f0Range[0] && realtimeMetrics.f0 <= f0Range[1]) {
            score += 20;
        } else {
            const deviation = Math.min(
                Math.abs(realtimeMetrics.f0 - f0Range[0]),
                Math.abs(realtimeMetrics.f0 - f0Range[1])
            );
            score += Math.max(0, 20 - deviation / 10);
        }

        // SPL è©•åˆ† (20åˆ†)
        if (realtimeMetrics.spl >= splRange[0] && realtimeMetrics.spl <= splRange[1]) {
            score += 20;
        } else {
            const deviation = Math.min(
                Math.abs(realtimeMetrics.spl - splRange[0]),
                Math.abs(realtimeMetrics.spl - splRange[1])
            );
            score += Math.max(0, 20 - deviation * 2);
        }

        // ç©©å®šæ€§è©•åˆ† (20åˆ†)
        score += realtimeMetrics.stability / 5;

        // HNR è©•åˆ† (20åˆ†)
        score += Math.min(20, realtimeMetrics.hnr / 2);

        // Jitter è©•åˆ† (10åˆ†)
        score += Math.max(0, 10 - realtimeMetrics.jitter * 5);

        // Shimmer è©•åˆ† (10åˆ†)
        score += Math.max(0, 10 - realtimeMetrics.shimmer);

        score = Math.round(score);

        // æ›´æ–°å„€è¡¨
        const gaugeProgress = document.getElementById('gaugeProgress');
        const gaugeText = document.getElementById('gaugeText');
        const gaugeLabel = document.getElementById('gaugeLabel');

        const circumference = 534.07;
        const offset = circumference - (score / 100) * circumference;

        gaugeProgress.style.strokeDashoffset = offset;
        gaugeText.textContent = score;

        let label = '';
        if (score >= 90) label = 'å„ªç§€';
        else if (score >= 80) label = 'è‰¯å¥½';
        else if (score >= 70) label = 'ä¸­ç­‰';
        else if (score >= 60) label = 'åŠæ ¼';
        else label = 'éœ€æ”¹å–„';

        gaugeLabel.textContent = label;
    }

    // æ›´æ–°å»ºè­°
    function updateSuggestions() {
        const container = document.getElementById('suggestionsContainer');
        const suggestions = [];
        const gender = document.getElementById('patientGender').value;

        if (!gender) return;

        const f0Range = gender === 'male' ? [100, 150] : [180, 250];
        const splRange = gender === 'male' ? [65, 75] : [60, 70];

        // F0 å»ºè­°
        if (realtimeMetrics.f0 < f0Range[0]) {
            suggestions.push({
                type: 'warning',
                icon: 'â¬†ï¸',
                text: 'éŸ³é«˜åä½ï¼Œè«‹å˜—è©¦ç¨å¾®æé«˜éŸ³èª¿'
            });
        } else if (realtimeMetrics.f0 > f0Range[1]) {
            suggestions.push({
                type: 'warning',
                icon: 'â¬‡ï¸',
                text: 'éŸ³é«˜åé«˜ï¼Œè«‹å˜—è©¦æ”¾é¬†å–‰åš¨ï¼Œé™ä½éŸ³èª¿'
            });
        } else {
            suggestions.push({
                type: 'success',
                icon: 'âœ…',
                text: 'éŸ³é«˜æ§åˆ¶è‰¯å¥½ï¼Œè«‹ä¿æŒ'
            });
        }

        // SPL å»ºè­°
        if (realtimeMetrics.spl < splRange[0]) {
            suggestions.push({
                type: 'warning',
                icon: 'ğŸ”Š',
                text: 'éŸ³é‡åå°ï¼Œè«‹ç¨å¾®å¢åŠ éŸ³é‡'
            });
        } else if (realtimeMetrics.spl > splRange[1]) {
            suggestions.push({
                type: 'warning',
                icon: 'ğŸ”‰',
                text: 'éŸ³é‡åå¤§ï¼Œè«‹é©åº¦é™ä½éŸ³é‡'
            });
        } else {
            suggestions.push({
                type: 'success',
                icon: 'âœ…',
                text: 'éŸ³é‡æ§åˆ¶è‰¯å¥½ï¼Œè«‹ä¿æŒ'
            });
        }

        // ç©©å®šæ€§å»ºè­°
        if (realtimeMetrics.stability < 70) {
            suggestions.push({
                type: 'danger',
                icon: 'âš ï¸',
                text: 'è²éŸ³ä¸å¤ ç©©å®šï¼Œè«‹ä¿æŒå‡å‹»çš„æ°£æµå’ŒéŸ³é‡'
            });
        } else if (realtimeMetrics.stability < 85) {
            suggestions.push({
                type: 'warning',
                icon: 'ğŸ“Š',
                text: 'ç©©å®šæ€§å°šå¯ï¼Œç¹¼çºŒç·´ç¿’å¯ä»¥æ›´å¥½'
            });
        } else {
            suggestions.push({
                type: 'success',
                icon: 'ğŸ¯',
                text: 'è²éŸ³ç©©å®šæ€§å„ªè‰¯'
            });
        }

        // HNR å»ºè­°
        if (realtimeMetrics.hnr < 15) {
            suggestions.push({
                type: 'danger',
                icon: 'ğŸ”§',
                text: 'è²éŸ³å“è³ªéœ€æ”¹å–„ï¼Œè«‹ç¢ºä¿ç™¼è²æ™‚å–‰åš¨æ”¾é¬†'
            });
        }

        // æ›´æ–° UI
        container.innerHTML = suggestions.map(s => `
            <div class="suggestion-item ${s.type}">
                <div class="suggestion-icon">${s.icon}</div>
                <div class="suggestion-text">${s.text}</div>
            </div>
        `).join('');
    }

    // æ’­æ”¾éŒ„éŸ³
    playBtn.addEventListener('click', () => {
        if (!isPlaying && audioBuffer) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            source = audioContext.createBufferSource();
            source.buffer = audioBuffer;

            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;

            source.connect(analyser);
            analyser.connect(audioContext.destination);

            source.start(0);
            isPlaying = true;
            playBtn.innerHTML = '<span>â¹</span> åœæ­¢æ’­æ”¾';

            visualizePlaying();

            source.onended = () => {
                isPlaying = false;
                playBtn.innerHTML = '<span>â–¶ï¸</span> æ’­æ”¾éŒ„éŸ³';
                cancelAnimationFrame(animationId);
            };
        } else if (isPlaying) {
            source.stop();
            isPlaying = false;
            playBtn.innerHTML = '<span>â–¶ï¸</span> æ’­æ”¾éŒ„éŸ³';
              cancelAnimationFrame(animationId);
          }
      });

      function visualizePlaying() {
          const bufferLength = analyser.frequencyBinCount;
          const dataArray = new Uint8Array(bufferLength);
          const freqArray = new Uint8Array(bufferLength);

          function draw() {
              if (!isPlaying) return;
              animationId = requestAnimationFrame(draw);

              analyser.getByteTimeDomainData(dataArray);
              analyser.getByteFrequencyData(freqArray);

              drawWaveform(dataArray);
              drawSpectrum(freqArray);
              updateFrequencyBands(freqArray);
          }

          draw();
      }

      // åˆ†ææŒ‰éˆ•
      analyzeBtn.addEventListener('click', () => {
          if (!audioBuffer) {
              alert('è«‹å…ˆå®ŒæˆéŒ„éŸ³');
              return;
          }

          // åŸ·è¡Œå®Œæ•´åˆ†æ
          performFullAnalysis();
      });

      function performFullAnalysis() {
          const data = audioBuffer.getChannelData(0);
          const sampleRate = audioBuffer.sampleRate;

          // è¨ˆç®—æ‰€æœ‰åƒæ•¸
          const f0 = calculateF0(data, sampleRate);
          const spl = calculateSPL(data);
          const mpt = audioBuffer.duration;
          const jitter = calculateJitter(data, sampleRate);
          const shimmer = calculateShimmer(data);
          const hnr = calculateHNR(data, sampleRate);

          // æ›´æ–°é¡¯ç¤º
          realtimeMetrics.f0 = f0;
          realtimeMetrics.spl = spl;
          realtimeMetrics.mpt = mpt;
          realtimeMetrics.jitter = jitter;
          realtimeMetrics.shimmer = shimmer;
          realtimeMetrics.hnr = hnr;

          updateAllMetrics();
          updateSuggestions();

          alert('åˆ†æå®Œæˆï¼\n\n' +
              `F0: ${f0.toFixed(1)} Hz\n` +
              `SPL: ${spl.toFixed(1)} dB\n` +
              `MPT: ${mpt.toFixed(2)} ç§’\n` +
              `Jitter: ${jitter.toFixed(2)} %\n` +
              `Shimmer: ${shimmer.toFixed(2)} %\n` +
              `HNR: ${hnr.toFixed(1)} dB`
          );
      }

      // è²å­¸è¨ˆç®—å‡½æ•¸
      function calculateF0(data, sampleRate) {
          const minFreq = 50;
          const maxFreq = 500;
          const minPeriod = Math.floor(sampleRate / maxFreq);
          const maxPeriod = Math.floor(sampleRate / minFreq);

          let maxCorr = 0;
          let bestPeriod = 0;

          for (let period = minPeriod; period < maxPeriod; period++) {
              let corr = 0;
              for (let i = 0; i < data.length - period; i++) {
                  corr += data[i] * data[i + period];
              }
              if (corr > maxCorr) {
                  maxCorr = corr;
                  bestPeriod = period;
              }
          }

          return bestPeriod > 0 ? sampleRate / bestPeriod : 0;
      }

      function calculateSPL(data) {
          let sum = 0;
          for (let i = 0; i < data.length; i++) {
              sum += data[i] * data[i];
          }
          const rms = Math.sqrt(sum / data.length);
          const spl = 20 * Math.log10(rms / 0.00002) + 94;
          return Math.max(0, Math.min(120, spl));
      }

      function calculateJitter(data, sampleRate) {
          const periods = extractPeriods(data, sampleRate);
          if (periods.length < 2) return 0;

          let sum = 0;
          for (let i = 1; i < periods.length; i++) {
              sum += Math.abs(periods[i] - periods[i - 1]);
          }
          const avgDiff = sum / (periods.length - 1);
          const avgPeriod = periods.reduce((a, b) => a + b) / periods.length;
          
          return (avgDiff / avgPeriod) * 100;
      }

      function calculateShimmer(data) {
          const windowSize = 1024;
          const amplitudes = [];

          for (let i = 0; i < data.length - windowSize; i += windowSize) {
              let max = 0;
              for (let j = 0; j < windowSize; j++) {
                  max = Math.max(max, Math.abs(data[i + j]));
              }
              amplitudes.push(max);
          }

          if (amplitudes.length < 2) return 0;

          let sum = 0;
          for (let i = 1; i < amplitudes.length; i++) {
              sum += Math.abs(amplitudes[i] - amplitudes[i - 1]);
          }
          const avgDiff = sum / (amplitudes.length - 1);
          const avgAmp = amplitudes.reduce((a, b) => a + b) / amplitudes.length;

          return (avgDiff / avgAmp) * 100;
      }

      function calculateHNR(data, sampleRate) {
          const f0 = calculateF0(data, sampleRate);
          if (f0 === 0) return 0;

          const period = Math.floor(sampleRate / f0);
          let harmonicPower = 0;
          let noisePower = 0;

          for (let i = 0; i < data.length - period; i++) {
              const predicted = data[i + period];
              const actual = data[i];
              harmonicPower += predicted * predicted;
              noisePower += (actual - predicted) * (actual - predicted);
          }

          if (noisePower === 0) return 40;
          const hnr = 10 * Math.log10(harmonicPower / noisePower);
          return Math.max(0, Math.min(40, hnr));
      }

      function extractPeriods(data, sampleRate) {
          const periods = [];
          const threshold = 0.3;
          let lastZeroCrossing = 0;

          for (let i = 1; i < data.length; i++) {
              if (data[i - 1] < 0 && data[i] >= 0 && Math.abs(data[i]) > threshold) {
                  if (lastZeroCrossing > 0) {
                      periods.push(i - lastZeroCrossing);
                  }
                  lastZeroCrossing = i;
              }
          }

          return periods;
      }

      // é‡ç½®å„€éŒ¶æ¿
      function resetDashboard() {
          if (confirm('ç¢ºå®šè¦é‡ç½®å„€éŒ¶æ¿å—ï¼Ÿæ‰€æœ‰è³‡æ–™å°‡æœƒæ¸…é™¤ã€‚')) {
              // åœæ­¢éŒ„éŸ³
              if (isRecording) {
                  stopRecording();
              }

              // åœæ­¢æ’­æ”¾
              if (isPlaying) {
                  source.stop();
                  isPlaying = false;
              }

              // æ¸…é™¤è³‡æ–™
              audioBuffer = null;
              audioChunks = [];
              realtimeMetrics = {
                  f0: 0,
                  spl: 0,
                  jitter: 0,
                  shimmer: 0,
                  hnr: 0,
                  mpt: 0,
                  stability: 0,
                  clarity: 0,
                  strength: 0,
                  consistency: 0
              };

              // é‡ç½® UI
              document.getElementById('patientName').value = '';
              document.getElementById('patientGender').value = '';
              document.getElementById('patientAge').value = '';

              playBtn.disabled = true;
              analyzeBtn.disabled = true;

              // é‡ç½®æ‰€æœ‰é¡¯ç¤º
              ['f0', 'spl', 'jitter', 'shimmer', 'hnr', 'mpt'].forEach(metric => {
                  document.getElementById(`${metric}Value`).textContent = '--';
                  document.getElementById(`${metric}Status`).textContent = 'å¾…æ¸¬é‡';
                  document.getElementById(`${metric}Status`).className = 'metric-status normal';
                  document.getElementById(`${metric}Card`).className = 'metric-card';
              });

              ['stability', 'clarity', 'strength', 'consistency'].forEach(metric => {
                  document.getElementById(`${metric}Progress`).style.strokeDashoffset = '326.73';
                  document.getElementById(`${metric}Text`).textContent = '--';
                  document.getElementById(`${metric}Status`).textContent = 'å¾…æ¸¬é‡';
              });

              document.getElementById('gaugeProgress').style.strokeDashoffset = '534.07';
              document.getElementById('gaugeText').textContent = '--';
              document.getElementById('gaugeLabel').textContent = 'ç­‰å¾…æ¸¬é‡';

              document.getElementById('timelineProgress').style.width = '0%';
              document.getElementById('timelineText').textContent = '0.0s';

              // é‡ç½®å»ºè­°
              document.getElementById('suggestionsContainer').innerHTML = `
                  <div class="suggestion-item">
                      <div class="suggestion-icon">â„¹ï¸</div>
                      <div class="suggestion-text">
                          è«‹é»æ“Šã€Œé–‹å§‹éŒ„éŸ³ã€æŒ‰éˆ•é–‹å§‹èªéŸ³åˆ†æã€‚å»ºè­°åœ¨å®‰éœçš„ç’°å¢ƒä¸­é€²è¡Œæ¸¬è©¦ï¼Œéº¥å…‹é¢¨è·é›¢å˜´å·´ç´„ 30 å…¬åˆ†ã€‚
                      </div>
                  </div>
              `;

              // æ¸…é™¤ç•«å¸ƒ
              initializeVisualizations();

              // é‡ç½®é »ç‡å¸¶
              ['low', 'midLow', 'midHigh', 'high'].forEach(band => {
                  document.getElementById(`${band}Freq`).textContent = '0';
                  document.getElementById(`${band}FreqBar`).style.height = '0%';
              });

              alert('å„€éŒ¶æ¿å·²é‡ç½®ï¼');
          }
      }

      // éµç›¤å¿«æ·éµ
      document.addEventListener('keydown', (e) => {
          // Space: é–‹å§‹/åœæ­¢éŒ„éŸ³
          if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
              e.preventDefault();
              recordBtn.click();
          }
          // P: æ’­æ”¾/åœæ­¢
          if (e.code === 'KeyP' && !playBtn.disabled) {
              e.preventDefault();
              playBtn.click();
          }
          // A: åˆ†æ
          if (e.code === 'KeyA' && !analyzeBtn.disabled) {
              e.preventDefault();
              analyzeBtn.click();
          }
          // R: é‡ç½®
          if (e.code === 'KeyR' && e.ctrlKey) {
              e.preventDefault();
              resetDashboard();
          }
      });

      // è‡ªå‹•å„²å­˜åŠŸèƒ½ï¼ˆå¯é¸ï¼‰
      let autoSaveInterval;
      function startAutoSave() {
          autoSaveInterval = setInterval(() => {
              if (isRecording) {
                  const snapshot = {
                      timestamp: Date.now(),
                      metrics: { ...realtimeMetrics }
                  };
                  // é€™è£¡å¯ä»¥å°‡è³‡æ–™å„²å­˜åˆ° localStorage æˆ–ç™¼é€åˆ°ä¼ºæœå™¨
                  console.log('Auto-saved:', snapshot);
              }
          }, 5000); // æ¯5ç§’è‡ªå‹•å„²å­˜
      }

      // åŒ¯å‡ºè³‡æ–™åŠŸèƒ½
      function exportData() {
          const data = {
              patient: {
                  name: document.getElementById('patientName').value,
                  gender: document.getElementById('patientGender').value,
                  age: document.getElementById('patientAge').value
              },
              metrics: realtimeMetrics,
              timestamp: new Date().toISOString()
          };

          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `voice_analysis_${Date.now()}.json`;
          a.click();
          URL.revokeObjectURL(url);
      }

      // åˆå§‹åŒ–æç¤º
      console.log('%cğŸ™ï¸ å³æ™‚èªéŸ³è²å­¸åˆ†æå„€éŒ¶æ¿', 'font-size: 20px; font-weight: bold; color: #667eea;');
      console.log('%cå¿«æ·éµ:', 'font-size: 14px; font-weight: bold;');
      console.log('Space - é–‹å§‹/åœæ­¢éŒ„éŸ³');
      console.log('P - æ’­æ”¾/åœæ­¢');
      console.log('A - åˆ†æçµæœ');
      console.log('Ctrl+R - é‡ç½®å„€éŒ¶æ¿');
  </script>
</body>
</html>
