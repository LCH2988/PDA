<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>台灣帕金森病友權益促進會 - 會計管理系統 v4.0</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<style>
    :root {
        --primary-color: #2c5aa0;
        --secondary-color: #28a745;
        --accent-color: #ffc107;
        --danger-color: #dc3545;
        --light-bg: #f8f9fa;
        --dark-text: #343a40;
        --border-color: #dee2e6;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--light-bg);
        color: var(--dark-text);
        line-height: 1.6;
    }

    .header {
        background: linear-gradient(135deg, var(--primary-color), #1e4080);
        color: white;
        padding: 1rem 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .header p {
        opacity: 0.9;
        margin: 0;
    }

    .nav-tabs {
        background: white;
        border-bottom: 2px solid var(--primary-color);
        padding: 0 1rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .nav-tabs .nav-link {
        color: var(--dark-text);
        border: none;
        padding: 1rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
        position: relative;
    }

    .nav-tabs .nav-link:hover {
        color: var(--primary-color);
        background-color: rgba(44, 90, 160, 0.05);
    }

    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        background-color: white;
        border-bottom: 3px solid var(--primary-color);
    }

    .main-content {
        padding: 2rem 0;
        min-height: calc(100vh - 200px);
    }

    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        margin-bottom: 1.5rem;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }

    .card-header {
        background: linear-gradient(135deg, var(--primary-color), #1e4080);
        color: white;
        border-radius: 12px 12px 0 0 !important;
        padding: 1rem 1.5rem;
        border: none;
    }

    .card-header h5 {
        margin: 0;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        font-weight: 600;
        color: var(--dark-text);
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-control, .form-select {
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25);
    }

    .btn {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), #1e4080);
        color: white;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #1e4080, var(--primary-color));
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(44, 90, 160, 0.3);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--secondary-color), #1e7e34);
        color: white;
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #1e7e34, var(--secondary-color));
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .btn-warning {
        background: linear-gradient(135deg, var(--accent-color), #e0a800);
        color: #212529;
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--danger-color), #c82333);
        color: white;
    }

    .btn-outline-primary {
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        background: transparent;
    }

    .btn-outline-primary:hover {
        background: var(--primary-color);
        color: white;
    }

    .alert {
        border: none;
        border-radius: 10px;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid;
    }

    .alert-success {
        background-color: rgba(40, 167, 69, 0.1);
        border-left-color: var(--secondary-color);
        color: #155724;
    }

    .alert-danger {
        background-color: rgba(220, 53, 69, 0.1);
        border-left-color: var(--danger-color);
        color: #721c24;
    }

    .alert-warning {
        background-color: rgba(255, 193, 7, 0.1);
        border-left-color: var(--accent-color);
        color: #856404;
    }

    .alert-info {
        background-color: rgba(44, 90, 160, 0.1);
        border-left-color: var(--primary-color);
        color: #0c5460;
    }

    .table {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .table thead th {
        background: linear-gradient(135deg, var(--primary-color), #1e4080);
        color: white;
        font-weight: 600;
        border: none;
        padding: 1rem;
    }

    .table tbody td {
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--border-color);
        vertical-align: middle;
    }

    .table tbody tr:hover {
        background-color: rgba(44, 90, 160, 0.05);
    }

    .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-success {
        background-color: rgba(40, 167, 69, 0.1);
        color: var(--secondary-color);
        border: 1px solid var(--secondary-color);
    }

    .status-pending {
        background-color: rgba(255, 193, 7, 0.1);
        color: var(--accent-color);
        border: 1px solid var(--accent-color);
    }

    .status-danger {
        background-color: rgba(220, 53, 69, 0.1);
        color: var(--danger-color);
        border: 1px solid var(--danger-color);
    }

    .loading {
        display: none;
        text-align: center;
        padding: 2rem;
    }

    .loading .spinner-border {
        width: 3rem;
        height: 3rem;
        color: var(--primary-color);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        transition: transform 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    .stat-icon.income {
        background: rgba(40, 167, 69, 0.1);
        color: var(--secondary-color);
    }

    .stat-icon.expense {
        background: rgba(220, 53, 69, 0.1);
        color: var(--danger-color);
    }

    .stat-icon.receipt {
        background: rgba(44, 90, 160, 0.1);
        color: var(--primary-color);
    }

    .stat-icon.member {
        background: rgba(255, 193, 7, 0.1);
        color: var(--accent-color);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--dark-text);
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .footer {
        background: var(--dark-text);
        color: white;
        text-align: center;
        padding: 1.5rem 0;
        margin-top: 3rem;
    }

    .modal-content {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
        background: linear-gradient(135deg, var(--primary-color), #1e4080);
        color: white;
        border-radius: 15px 15px 0 0;
        border: none;
    }

    .modal-title {
        font-weight: 600;
    }

    .btn-close {
        filter: invert(1);
    }

    .search-box {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .search-box input {
        padding-left: 3rem;
    }

    .search-box .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }

    .action-buttons .btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
    }

    .tab-pane {
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .required {
        color: var(--danger-color);
    }

    .help-text {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    @media (max-width: 768px) {
        .header h1 {
            font-size: 1.5rem;
        }
        
        .nav-tabs .nav-link {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }
        
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .table-responsive {
            font-size: 0.85rem;
        }
    }

    .progress {
        height: 8px;
        border-radius: 10px;
        background-color: rgba(44, 90, 160, 0.1);
        margin-bottom: 1rem;
    }

    .progress-bar {
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        border-radius: 10px;
    }

    .badge {
        font-size: 0.75rem;
        padding: 0.4rem 0.6rem;
        border-radius: 6px;
    }

    .file-upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .file-upload-area:hover {
        border-color: var(--primary-color);
        background-color: rgba(44, 90, 160, 0.05);
    }

    .file-upload-area.dragover {
        border-color: var(--secondary-color);
        background-color: rgba(40, 167, 69, 0.05);
    }
</style>
</head>
<body>
<!-- 頁面標題 -->
<header class="header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-calculator me-2"></i>台灣帕金森病友權益促進會</h1>
                <p>增強版會計管理系統 v4.0 - 專業財務管理解決方案</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-flex align-items-center justify-content-end gap-3">
                    <span id="currentTime" class="small"></span>
                    <button class="btn btn-outline-light btn-sm" onclick="performSystemCheck()">
                        <i class="fas fa-heartbeat me-1"></i>系統檢查
                    </button>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- 導航選單 -->
<nav class="nav-tabs">
    <div class="container">
        <ul class="nav nav-tabs border-0" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                    <i class="fas fa-tachometer-alt me-1"></i>儀表板
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="transaction-tab" data-bs-toggle="tab" data-bs-target="#transaction" type="button" role="tab">
                    <i class="fas fa-exchange-alt me-1"></i>交易記錄
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="receipt-tab" data-bs-toggle="tab" data-bs-target="#receipt" type="button" role="tab">
                    <i class="fas fa-receipt me-1"></i>收據管理
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="voucher-tab" data-bs-toggle="tab" data-bs-target="#voucher" type="button" role="tab">
                    <i class="fas fa-file-invoice me-1"></i>支出憑證
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="member-tab" data-bs-toggle="tab" data-bs-target="#member" type="button" role="tab">
                    <i class="fas fa-users me-1"></i>會員管理
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" type="button" role="tab">
                    <i class="fas fa-chart-bar me-1"></i>報表分析
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                    <i class="fas fa-cog me-1"></i>系統設定
                </button>
            </li>
        </ul>
    </div>
</nav>

<!-- 主要內容區域 -->
<main class="main-content">
    <div class="container">
        <!-- 全域訊息顯示區 -->
        <div id="globalMessage"></div>
        
        <!-- 載入指示器 -->
        <div id="globalLoading" class="loading">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">載入中...</span>
            </div>
            <p class="mt-2">系統處理中，請稍候...</p>
        </div>

        <!-- 分頁內容 -->
        <div class="tab-content" id="mainTabContent">
            
            <!-- 儀表板 -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-tachometer-alt me-2"></i>系統概覽</h5>
                            </div>
                            <div class="card-body">
                                <!-- 統計卡片 -->
                                <div class="stats-grid" id="statsGrid">
                                    <div class="stat-card">
                                        <div class="stat-icon income">
                                            <i class="fas fa-arrow-up"></i>
                                        </div>
                                        <div class="stat-value" id="totalIncome">$0</div>
                                        <div class="stat-label">本月收入</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-icon expense">
                                            <i class="fas fa-arrow-down"></i>
                                        </div>
                                        <div class="stat-value" id="totalExpense">$0</div>
                                        <div class="stat-label">本月支出</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-icon receipt">
                                            <i class="fas fa-receipt"></i>
                                        </div>
                                        <div class="stat-value" id="receiptCount">0</div>
                                        <div class="stat-label">本月收據</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-icon member">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <div class="stat-value" id="memberCount">0</div>
                                        <div class="stat-label">會員總數</div>
                                    </div>
                                </div>

                                <!-- 快速操作 -->
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="fas fa-bolt me-2"></i>快速操作</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="d-grid gap-2">
                                                    <button class="btn btn-primary" onclick="showQuickTransaction()">
                                                        <i class="fas fa-plus me-2"></i>新增交易記錄
                                                    </button>
                                                    <button class="btn btn-success" onclick="showQuickReceipt()">
                                                        <i class="fas fa-receipt me-2"></i>開立收據
                                                    </button>
                                                    <button class="btn btn-warning" onclick="showQuickVoucher()">
                                                        <i class="fas fa-file-invoice me-2"></i>申請支出憑證
                                                    </button>
                                                    <button class="btn btn-info" onclick="showQuickMember()">
                                                        <i class="fas fa-user-plus me-2"></i>新增會員
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="fas fa-clock me-2"></i>最近活動</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="recentActivities">
                                                    <div class="text-center text-muted py-3">
                                                        <i class="fas fa-spinner fa-spin me-2"></i>載入中...
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 交易記錄 -->
            <div class="tab-pane fade" id="transaction" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-exchange-alt me-2"></i>交易記錄管理</h5>
                                <button class="btn btn-primary" onclick="showTransactionForm()">
                                    <i class="fas fa-plus me-1"></i>新增交易
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- 搜尋和篩選 -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="search-box">
                                            <i class="fas fa-search search-icon"></i>
                                            <input type="text" class="form-control" id="transactionSearch" placeholder="搜尋交易記錄...">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="transactionTypeFilter">
                                            <option value="">所有類型</option>
                                            <option value="收入">收入</option>
                                            <option value="支出">支出</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="date" class="form-control" id="transactionDateFrom" placeholder="開始日期">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="date" class="form-control" id="transactionDateTo" placeholder="結束日期">
                                    </div>
                                    <div class="col-md-3">
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-outline-primary" onclick="searchTransactions()">
                                                <i class="fas fa-search me-1"></i>搜尋
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="resetTransactionFilter()">
                                                <i class="fas fa-undo me-1"></i>重置
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 交易記錄表格 -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>日期</th>
                                                <th>姓名</th>
                                                <th>類型</th>
                                                <th>類別</th>
                                                <th>金額</th>
                                                <th>說明</th>
                                                <th>收據/憑證編號</th>
                                                <th>狀態</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transactionTableBody">
                                            <tr>
                                                <td colspan="9" class="text-center py-4">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>載入交易記錄中...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- 分頁 -->
                                <nav aria-label="交易記錄分頁">
                                    <ul class="pagination justify-content-center" id="transactionPagination">
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 收據管理 -->
            <div class="tab-pane fade" id="receipt" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-receipt me-2"></i>收據管理</h5>
                                <button class="btn btn-success" onclick="showReceiptForm()">
                                    <i class="fas fa-plus me-1"></i>開立收據
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- 收據搜尋 -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="search-box">
                                            <i class="fas fa-search search-icon"></i>
                                            <input type="text" class="form-control" id="receiptSearch" placeholder="輸入收據編號或付款人姓名...">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="receiptStatusFilter">
                                            <option value="">所有狀態</option>
                                            <option value="已開立">已開立</option>
                                            <option value="已寄送">已寄送</option>
                                            <option value="已列印">已列印</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-outline-primary" onclick="searchReceipts()">
                                                <i class="fas fa-search me-1"></i>搜尋
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="resetReceiptFilter()">
                                                <i class="fas fa-undo me-1"></i>重置
                                            </button>
                                            <button class="btn btn-outline-info" onclick="exportReceiptData()">
                                                <i class="fas fa-download me-1"></i>匯出
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 收據列表 -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>收據編號</th>
                                                <th>開立日期</th>
                                                <th>付款人</th>
                                                <th>聯絡方式</th>
                                                <th>類別</th>
                                                <th>金額</th>
                                                <th>狀態</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="receiptTableBody">
                                            <tr>
                                                <td colspan="8" class="text-center py-4">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>載入收據記錄中...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 支出憑證 -->
            <div class="tab-pane fade" id="voucher" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-file-invoice me-2"></i>支出憑證管理</h5>
                                <button class="btn btn-warning" onclick="showVoucherForm()">
                                    <i class="fas fa-plus me-1"></i>申請憑證
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- 憑證搜尋 -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="search-box">
                                            <i class="fas fa-search search-icon"></i>
                                            <input type="text" class="form-control" id="voucherSearch" placeholder="輸入憑證編號或申請人姓名...">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="voucherStatusFilter">
                                            <option value="">所有狀態</option>
                                            <option value="待審核">待審核</option>
                                            <option value="已核准">已核准</option>
                                            <option value="已駁回">已駁回</option>
                                            <option value="已付款">已付款</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-outline-primary" onclick="searchVouchers()">
                                                <i class="fas fa-search me-1"></i>搜尋
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="resetVoucherFilter()">
                                                <i class="fas fa-undo me-1"></i>重置
                                            </button>
                                            <button class="btn btn-outline-success" onclick="approveSelectedVouchers()">
                                                <i class="fas fa-check me-1"></i>批量核准
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 憑證列表 -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>
                                                    <input type="checkbox" id="selectAllVouchers" onchange="toggleAllVouchers()">
                                                </th>
                                                <th>憑證編號</th>
                                                <th>申請日期</th>
                                                <th>申請人</th>
                                                <th>支出類別</th>
                                                <th>金額</th>
                                                <th>用途說明</th>
                                                <th>狀態</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="voucherTableBody">
                                            <tr>
                                                <td colspan="9" class="text-center py-4">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>載入憑證記錄中...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 會員管理 -->
            <div class="tab-pane fade" id="member" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-users me-2"></i>會員管理</h5>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success" onclick="showMemberForm()">
                                        <i class="fas fa-user-plus me-1"></i>新增會員
                                    </button>
                                    <button class="btn btn-info" onclick="showMemberImport()">
                                        <i class="fas fa-upload me-1"></i>批量匯入
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- 會員統計 -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-icon member">
                                                <i class="fas fa-users"></i>
                                            </div>
                                            <div class="stat-value" id="totalMembers">0</div>
                                            <div class="stat-label">總會員數</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-icon income">
                                                <i class="fas fa-user-check"></i>
                                            </div>
                                            <div class="stat-value" id="activeMembers">0</div>
                                            <div class="stat-label">活躍會員</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-icon receipt">
                                                <i class="fas fa-calendar-check"></i>
                                            </div>
                                            <div class="stat-value" id="newMembersThisMonth">0</div>
                                            <div class="stat-label">本月新增</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-icon expense">
                                                <i class="fas fa-birthday-cake"></i>
                                            </div>
                                            <div class="stat-value" id="birthdayMembers">0</div>
                                            <div class="stat-label">本月壽星</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 會員搜尋 -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="search-box">
                                            <i class="fas fa-search search-icon"></i>
                                            <input type="text" class="form-control" id="memberSearch" placeholder="搜尋會員姓名、電話或電子郵件...">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="memberTypeFilter">
                                            <option value="">所有類型</option>
                                            <option value="一般會員">一般會員</option>
                                            <option value="贊助會員">贊助會員</option>
                                            <option value="榮譽會員">榮譽會員</option>
                                            <option value="終身會員">終身會員</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="memberStatusFilter">
                                            <option value="">所有狀態</option>
                                            <option value="正常">正常</option>
                                            <option value="暫停">暫停</option>
                                            <option value="退會">退會</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-outline-primary" onclick="searchMembers()">
                                                <i class="fas fa-search me-1"></i>搜尋
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="resetMemberFilter()">
                                                <i class="fas fa-undo me-1"></i>重置
                                            </button>
                                            <button class="btn btn-outline-info" onclick="exportMemberData()">
                                                <i class="fas fa-download me-1"></i>匯出
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 會員列表 -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>會員編號</th>
                                                <th>姓名</th>
                                                <th>性別</th>
                                                <th>電話</th>
                                                <th>電子郵件</th>
                                                <th>會員類型</th>
                                                <th>加入日期</th>
                                                <th>狀態</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="memberTableBody">
                                            <tr>
                                                <td colspan="9" class="text-center py-4">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>載入會員資料中...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 報表分析 -->
            <div class="tab-pane fade" id="report" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-bar me-2"></i>財務報表與分析</h5>
                            </div>
                            <div class="card-body">
                                <!-- 報表選擇 -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <label class="form-label">報表類型</label>
                                        <select class="form-select" id="reportType">
                                            <option value="monthly">月度財務報表</option>
                                            <option value="yearly">年度財務報表</option>
                                            <option value="category">類別分析報表</option>
                                            <option value="member">會員統計報表</option>
                                            <option value="donation">捐款分析報表</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">年份</label>
                                        <select class="form-select" id="reportYear">
                                            <option value="2024">2024</option>
                                            <option value="2023">2023</option>
                                            <option value="2022">2022</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">月份</label>
                                        <select class="form-select" id="reportMonth">
                                            <option value="">全年</option>
                                            <option value="1">1月</option>
                                            <option value="2">2月</option>
                                            <option value="3">3月</option>
                                            <option value="4">4月</option>
                                            <option value="5">5月</option>
                                            <option value="6">6月</option>
                                            <option value="7">7月</option>
                                            <option value="8">8月</option>
                                            <option value="9">9月</option>
                                            <option value="10">10月</option>
                                            <option value="11">11月</option>
                                            <option value="12">12月</option>
                                        </select>
                                    </div>
                                    <div class="col-md-5">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary" onclick="generateReport()">
                                                <i class="fas fa-chart-line me-1"></i>產生報表
                                            </button>
                                            <button class="btn btn-success" onclick="exportReport()">
                                                <i class="fas fa-file-excel me-1"></i>匯出Excel
                                            </button>
                                            <button class="btn btn-danger" onclick="exportReportPDF()">
                                                <i class="fas fa-file-pdf me-1"></i>匯出PDF
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 報表內容 -->
                                <div id="reportContent">
                                    <div class="text-center py-5">
                                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                                        <h6 class="text-muted">請選擇報表類型並點擊「產生報表」</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 系統設定 -->
            <div class="tab-pane fade" id="settings" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-building me-2"></i>組織資訊設定</h5>
                            </div>
                            <div class="card-body">
                                <form id="organizationForm">
                                    <div class="form-group">
                                        <label class="form-label">組織名稱 <span class="required">*</span></label>
                                        <input type="text" class="form-control" id="orgName" value="台灣帕金森病友權益促進會">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">統一編號 <span class="required">*</span></label>
                                        <input type="text" class="form-control" id="orgTaxId" placeholder="請輸入統一編號">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">聯絡地址</label>
                                        <textarea class="form-control" id="orgAddress" rows="3" placeholder="請輸入組織地址"></textarea>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">聯絡電話</label>
                                            <input type="tel" class="form-control" id="orgPhone" placeholder="請輸入聯絡電話">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">電子郵件</label>
                                            <input type="email" class="form-control" id="orgEmail" placeholder="請輸入電子郵件">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">負責人姓名</label>
                                        <input type="text" class="form-control" id="orgDirector" placeholder="請輸入負責人姓名">
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="saveOrganizationInfo()">
                                        <i class="fas fa-save me-1"></i>儲存設定
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-envelope me-2"></i>郵件設定</h5>
                            </div>
                            <div class="card-body">
                                <form id="emailForm">
                                    <div class="form-group">
                                        <label class="form-label">寄件者名稱</label>
                                        <input type="text" class="form-control" id="emailSenderName" value="台灣帕金森病友權益促進會">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">回覆郵件地址</label>
                                        <input type="email" class="form-control" id="emailReplyTo" placeholder="noreply@parkinson.org.tw">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">郵件簽名</label>
                                        <textarea class="form-control" id="emailSignature" rows="4" placeholder="請輸入郵件簽名"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="autoSendReceipt" checked>
                                            <label class="form-check-label" for="autoSendReceipt">
                                                自動寄送收據
                                            </label>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="emailNotification" checked>
                                            <label class="form-check-label" for="emailNotification">
                                                啟用郵件通知
                                            </label>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="saveEmailSettings()">
                                        <i class="fas fa-save me-1"></i>儲存設定
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="testEmailSettings()">
                                        <i class="fas fa-paper-plane me-1"></i>測試郵件
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-database me-2"></i>資料管理</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-info" onclick="createBackup()">
                                        <i class="fas fa-save me-2"></i>建立系統備份
                                    </button>
                                    <button class="btn btn-warning" onclick="showImportData()">
                                        <i class="fas fa-upload me-2"></i>匯入資料
                                    </button>
                                    <button class="btn btn-success" onclick="showExportData()">
                                        <i class="fas fa-download me-2"></i>匯出資料
                                    </button>
                                    <hr>
                                    <button class="btn btn-outline-danger" onclick="confirmDataCleanup()">
                                        <i class="fas fa-trash me-2"></i>清理舊資料
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-cogs me-2"></i>系統工具</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="performSystemCheck()">
                                        <i class="fas fa-heartbeat me-2"></i>系統健康檢查
                                    </button>
                                    <button class="btn btn-secondary" onclick="showSystemLog()">
                                        <i class="fas fa-list me-2"></i>查看系統記錄
                                    </button>
                                    <button class="btn btn-info" onclick="showSystemInfo()">
                                        <i class="fas fa-info-circle me-2"></i>系統資訊
                                    </button>
                                    <hr>
                                    <button class="btn btn-outline-warning" onclick="setupAutoBackup()">
                                        <i class="fas fa-clock me-2"></i>設定自動備份
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- 模態視窗區域 -->

<!-- 交易記錄表單模態視窗 -->
<div class="modal fade" id="transactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>
                    <span id="transactionModalTitle">新增交易記錄</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="transactionForm">
                    <input type="hidden" id="transactionId">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">日期 <span class="required">*</span></label>
                            <input type="date" class="form-control" id="transactionDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">姓名 <span class="required">*</span></label>
                            <input type="text" class="form-control" id="transactionName" required placeholder="請輸入姓名">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">類型 <span class="required">*</span></label>
                            <select class="form-select" id="transactionType" required onchange="updateTransactionCategories()">
                                <option value="">請選擇類型</option>
                                <option value="收入">收入</option>
                                <option value="支出">支出</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">類別 <span class="required">*</span></label>
                            <select class="form-select" id="transactionCategory" required>
                                <option value="">請先選擇類型</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">金額 <span class="required">*</span></label>
                            <input type="number" class="form-control" id="transactionAmount" required min="0" step="1" placeholder="請輸入金額">
                        </div>
                        <div class="form-group">
                            <label class="form-label">帳戶</label>
                            <select class="form-select" id="transactionAccount">
                                <option value="">請選擇帳戶</option>
                                <option value="現金">現金</option>
                                <option value="銀行帳戶">銀行帳戶</option>
                                <option value="郵局帳戶">郵局帳戶</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">說明</label>
                        <textarea class="form-control" id="transactionDescription" rows="3" placeholder="請輸入交易說明或備註"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="generateReceipt">
                            <label class="form-check-label" for="generateReceipt">
                                自動生成收據（收入類型）
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="generateVoucher">
                            <label class="form-check-label" for="generateVoucher">
                                自動生成支出憑證（支出類型）
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveTransaction()">
                    <i class="fas fa-save me-1"></i>儲存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 收據表單模態視窗 -->
<div class="modal fade" id="receiptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-receipt me-2"></i>開立收據
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="receiptForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">收據日期 <span class="required">*</span></label>
                            <input type="date" class="form-control" id="receiptDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">付款人姓名 <span class="required">*</span></label>
                            <input type="text" class="form-control" id="receiptPayer" required placeholder="請輸入付款人姓名">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">身份類別</label>
                            <select class="form-select" id="receiptIdentity">
                                <option value="會員">會員</option>
                                <option value="非會員">非會員</option>
                                <option value="企業">企業</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">聯絡電話</label>
                            <input type="tel" class="form-control" id="receiptPhone" placeholder="請輸入聯絡電話">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">電子郵件</label>
                        <input type="email" class="form-control" id="receiptEmail" placeholder="請輸入電子郵件（自動寄送收據）">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">收據類別 <span class="required">*</span></label>
                            <select class="form-select" id="receiptCategory" required>
                                <option value="">請選擇類別</option>
                                <option value="會費">會費</option>
                                <option value="捐款">捐款</option>
                                <option value="活動費用">活動費用</option>
                                <option value="其他收入">其他收入</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">金額 <span class="required">*</span></label>
                            <input type="number" class="form-control" id="receiptAmount" required min="0" step="1" placeholder="請輸入金額">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">收據用途</label>
                        <textarea class="form-control" id="receiptPurpose" rows="3" placeholder="請輸入收據用途或備註"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="receiptAutoSend" checked>
                            <label class="form-check-label" for="receiptAutoSend">
                                自動寄送電子收據（需填寫電子郵件）
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="saveReceipt()">
                    <i class="fas fa-receipt me-1"></i>開立收據
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 支出憑證表單模態視窗 -->
<div class="modal fade" id="voucherModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-invoice me-2"></i>申請支出憑證
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="voucherForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">申請日期 <span class="required">*</span></label>
                            <input type="date" class="form-control" id="voucherDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">申請人 <span class="required">*</span></label>
                            <input type="text" class="form-control" id="voucherApplicant" required placeholder="請輸入申請人姓名">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">支出類別 <span class="required">*</span></label>
                            <select class="form-select" id="voucherCategory" required>
                                <option value="">請選擇類別</option>
                                <option value="辦公費用">辦公費用</option>
                                <option value="活動支出">活動支出</option>
                                <option value="交通費">交通費</option>
                                <option value="餐費">餐費</option>
                                <option value="設備採購">設備採購</option>
                                <option value="其他支出">其他支出</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">申請金額 <span class="required">*</span></label>
                            <input type="number" class="form-control" id="voucherAmount" required min="0" step="1" placeholder="請輸入申請金額">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">用途說明 <span class="required">*</span></label>
                        <textarea class="form-control" id="voucherPurpose" rows="4" required placeholder="請詳細說明支出用途"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">附件上傳</label>
                        <div class="file-upload-area" onclick="document.getElementById('voucherFiles').click()">
                            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                            <p class="mb-1">點擊或拖拽檔案到此處</p>
                            <small class="text-muted">支援 PDF, JPG, PNG 格式，最大 10MB</small>
                            <input type="file" id="voucherFiles" multiple accept=".pdf,.jpg,.jpeg,.png" style="display: none;" onchange="handleFileUpload(this)">
                        </div>
                        <div id="uploadedFiles" class="mt-2"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning" onclick="saveVoucher()">
                    <i class="fas fa-paper-plane me-1"></i>提交申請
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 會員表單模態視窗 -->
<div class="modal fade" id="memberModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>
                    <span id="memberModalTitle">新增會員</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="memberForm">
                    <input type="hidden" id="memberId">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">姓名 <span class="required">*</span></label>
                            <input type="text" class="form-control" id="memberName" required placeholder="請輸入會員姓名">
                        </div>
                        <div class="form-group">
                            <label class="form-label">性別</label>
                            <select class="form-select" id="memberGender">
                                <option value="">請選擇</option>
                                <option value="男">男</option>
                                <option value="女">女</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">出生日期</label>
                            <input type="date" class="form-control" id="memberBirthDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">身份證字號</label>
                            <input type="text" class="form-control" id="memberIdCard" placeholder="請輸入身份證字號">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">聯絡電話 <span class="required">*</span></label>
                            <input type="tel" class="form-control" id="memberPhone" required placeholder="請輸入聯絡電話">
                        </div>
                        <div class="form-group">
                            <label class="form-label">電子郵件</label>
                            <input type="email" class="form-control" id="memberEmail" placeholder="請輸入電子郵件">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">聯絡地址</label>
                        <textarea class="form-control" id="memberAddress" rows="2" placeholder="請輸入聯絡地址"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">會員類型 <span class="required">*</span></label>
                            <select class="form-select" id="memberType" required>
                                <option value="">請選擇</option>
                                <option value="一般會員">一般會員</option>
                                <option value="贊助會員">贊助會員</option>
                                <option value="榮譽會員">榮譽會員</option>
                                <option value="終身會員">終身會員</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">加入日期 <span class="required">*</span></label>
                            <input type="date" class="form-control" id="memberJoinDate" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">備註</label>
                        <textarea class="form-control" id="memberNotes" rows="3" placeholder="請輸入備註資訊"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="saveMember()">
                    <i class="fas fa-save me-1"></i>儲存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 系統資訊模態視窗 -->
<div class="modal fade" id="systemInfoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>系統資訊
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-desktop me-2"></i>系統版本</h6>
                        <table class="table table-sm">
                            <tr><td>系統名稱</td><td>會計管理系統</td></tr>
                            <tr><td>版本號碼</td><td>v4.0.0</td></tr>
                            <tr><td>發布日期</td><td>2024-12-19</td></tr>
                            <tr><td>開發團隊</td><td>台灣帕金森病友權益促進會</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-cogs me-2"></i>技術規格</h6>
                        <table class="table table-sm">
                            <tr><td>前端框架</td><td>Bootstrap 5.3</td></tr>
                            <tr><td>後端平台</td><td>Google Apps Script</td></tr>
                            <tr><td>資料儲存</td><td>Google Sheets</td></tr>
                            <tr><td>檔案管理</td><td>Google Drive</td></tr>
                        </table>
                    </div>
                </div>
                <hr>
                <h6><i class="fas fa-list me-2"></i>功能特色</h6>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>會計記錄管理</li>
                            <li><i class="fas fa-check text-success me-2"></i>收據自動生成</li>
                            <li><i class="fas fa-check text-success me-2"></i>支出憑證管理</li>
                            <li><i class="fas fa-check text-success me-2"></i>會員管理系統</li>
                            <li><i class="fas fa-check text-success me-2"></i>郵件自動寄送</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>財務報表生成</li>
                            <li><i class="fas fa-check text-success me-2"></i>資料匯入匯出</li>
                            <li><i class="fas fa-check text-success me-2"></i>系統自動備份</li>
                            <li><i class="fas fa-check text-success me-2"></i>多重安全驗證</li>
                            <li><i class="fas fa-check text-success me-2"></i>響應式設計</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

<!-- 頁尾 -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <p>&copy; 2024 台灣帕金森病友權益促進會 - 增強版會計管理系統 v4.0</p>
            </div>
            <div class="col-md-6 text-end">
                <p>技術支援：<a href="mailto:tech@parkinson.org.tw" class="text-light">tech@parkinson.org.tw</a></p>
            </div>
        </div>
    </div>
</footer>

<!-- JavaScript 程式碼 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
    // ========================================
    // 全域變數與設定
    // ========================================
    
    let currentUser = null;
    let systemSettings = {};
    let isLoading = false;
    let currentFilters = {};
    
    // ========================================
    // 系統初始化
    // ========================================
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('系統初始化開始...');
        
        // 設定當前時間顯示
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        
        // 設定預設日期
        setDefaultDates();
        
        // 載入系統資料
        loadSystemData();
        
        // 設定事件監聽器
        setupEventListeners();
        
        console.log('系統初始化完成');
    });
    
    // 更新當前時間顯示
    function updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
            timeElement.textContent = timeString;
        }
    }
    
    // 設定預設日期
    function setDefaultDates() {
        const today = new Date().toISOString().split('T')[0];
        
        // 設定各表單的預設日期
        const dateFields = [
            'transactionDate',
            'receiptDate', 
            'voucherDate',
            'memberJoinDate'
        ];
        
        dateFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = today;
            }
        });
    }
    
    // 載入系統資料
    async function loadSystemData() {
        try {
            showLoading(true);
            
            // 載入儀表板統計資料
            await loadDashboardStats();
            
            // 載入最近活動
            await loadRecentActivities();
            
            // 載入系統設定
            await loadSystemSettings();
            
            showLoading(false);
        } catch (error) {
            console.error('載入系統資料失敗:', error);
            showMessage('載入系統資料失敗，請重新整理頁面', 'danger');
            showLoading(false);
        }
    }
    
    // ========================================
    // 載入與顯示功能 - 從Google Sheets載入實際資料
    // ========================================
    
    // 載入儀表板統計資料
    async function loadDashboardStats() {
        try {
            // 呼叫後端API取得統計資料
            const response = await callGoogleAppsScript('getDashboardStats');
            
            if (response.success) {
                const stats = response.data;
                
                // 更新統計顯示
                document.getElementById('totalIncome').textContent = `$${stats.totalIncome.toLocaleString()}`;
                document.getElementById('totalExpense').textContent = `$${stats.totalExpense.toLocaleString()}`;
                document.getElementById('receiptCount').textContent = stats.receiptCount;
                document.getElementById('memberCount').textContent = stats.memberCount;
                
                // 更新會員統計
                if (stats.memberStats) {
                    document.getElementById('totalMembers').textContent = stats.memberStats.total || 0;
                    document.getElementById('activeMembers').textContent = stats.memberStats.active || 0;
                    document.getElementById('newMembersThisMonth').textContent = stats.memberStats.newThisMonth || 0;
                    document.getElementById('birthdayMembers').textContent = stats.memberStats.birthdayThisMonth || 0;
                }
            } else {
                console.error('載入統計資料失敗:', response.error);
                showMessage('載入統計資料失敗', 'warning');
            }
            
        } catch (error) {
            console.error('載入統計資料失敗:', error);
            showMessage('載入統計資料失敗', 'danger');
        }
    }
    
    // 載入最近活動
    async function loadRecentActivities() {
        try {
            const response = await callGoogleAppsScript('getRecentActivities');
            
            if (response.success && response.data) {
                const activities = response.data;
                const container = document.getElementById('recentActivities');
                
                if (container) {
                    if (activities.length > 0) {
                        container.innerHTML = activities.map(activity => `
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-${getActivityIcon(activity.type)} text-primary me-2"></i>
                                <div class="flex-grow-1">
                                    <small class="d-block">${activity.message}</small>
                                    <small class="text-muted">${formatTimeAgo(activity.time)}</small>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="text-center text-muted py-3">暫無最近活動</div>';
                    }
                }
            } else {
                document.getElementById('recentActivities').innerHTML = '<div class="text-center text-muted py-3">載入活動記錄失敗</div>';
            }
            
        } catch (error) {
            console.error('載入最近活動失敗:', error);
            document.getElementById('recentActivities').innerHTML = '<div class="text-center text-muted py-3">載入活動記錄失敗</div>';
        }
    }
    
    // 取得活動圖示
    function getActivityIcon(type) {
        const icons = {
            'receipt': 'receipt',
            'transaction': 'exchange-alt',
            'member': 'user-plus',
            'voucher': 'file-invoice',
            'income': 'arrow-up',
            'expense': 'arrow-down'
        };
        return icons[type] || 'info-circle';
    }
    
    // 格式化時間
    function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInMs = now - date;
        const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
        const diffInDays = Math.floor(diffInHours / 24);
        
        if (diffInDays > 0) {
            return `${diffInDays}天前`;
        } else if (diffInHours > 0) {
            return `${diffInHours}小時前`;
        } else {
            const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
            return diffInMinutes > 0 ? `${diffInMinutes}分鐘前` : '剛剛';
        }
    }
    
    // 載入系統設定
    async function loadSystemSettings() {
        try {
            const response = await callGoogleAppsScript('getSystemSettings');
            
            if (response.success) {
                systemSettings = response.settings;
                updateSettingsForm();
            }
            
        } catch (error) {
            console.error('載入系統設定失敗:', error);
        }
    }
    
    // 更新設定表單
    function updateSettingsForm() {
        const fields = [
            'orgName', 'orgTaxId', 'orgAddress', 'orgPhone', 
            'orgEmail', 'orgDirector', 'emailSenderName', 
            'emailReplyTo', 'emailSignature'
        ];
        
        fields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && systemSettings[fieldId]) {
                field.value = systemSettings[fieldId];
            }
        });
        
        // 更新核取方塊
        const checkboxes = ['autoSendReceipt', 'emailNotification'];
        checkboxes.forEach(checkboxId => {
            const checkbox = document.getElementById(checkboxId);
            if (checkbox) {
                checkbox.checked = systemSettings[checkboxId] || false;
            }
        });
    }
    
    // ========================================
    // 表單處理功能 - 連接Google Apps Script
    // ========================================
    
    // 顯示交易記錄表單
    function showTransactionForm(transactionData = null) {
        const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
        const form = document.getElementById('transactionForm');
        
        // 重置表單
        form.reset();
        setDefaultDates();
        
        if (transactionData) {
            // 編輯模式
            document.getElementById('transactionModalTitle').textContent = '編輯交易記錄';
            populateTransactionForm(transactionData);
        } else {
            // 新增模式
            document.getElementById('transactionModalTitle').textContent = '新增交易記錄';
        }
        
        modal.show();
    }
    
    // 快速新增交易
    function showQuickTransaction() {
        showTransactionForm();
    }
    
    // 更新交易類別選項
    function updateTransactionCategories() {
        const typeSelect = document.getElementById('transactionType');
        const categorySelect = document.getElementById('transactionCategory');
        
        const categories = {
            '收入': ['會費', '捐款', '活動收入', '利息收入', '其他收入'],
            '支出': ['辦公費用', '活動支出', '交通費', '餐費', '設備採購', '其他支出']
        };
        
        categorySelect.innerHTML = '<option value="">請選擇類別</option>';
        
        if (typeSelect.value && categories[typeSelect.value]) {
            categories[typeSelect.value].forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }
    }
    
    // 儲存交易記錄
    async function saveTransaction() {
        try {
            const form = document.getElementById('transactionForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            showLoading(true);
            
            const transactionData = {
                id: document.getElementById('transactionId').value,
                date: document.getElementById('transactionDate').value,
                name: document.getElementById('transactionName').value,
                type: document.getElementById('transactionType').value,
                category: document.getElementById('transactionCategory').value,
                amount: parseInt(document.getElementById('transactionAmount').value),
                account: document.getElementById('transactionAccount').value,
                description: document.getElementById('transactionDescription').value,
                generateReceipt: document.getElementById('generateReceipt').checked ? 'true' : 'false',
                generateVoucher: document.getElementById('generateVoucher').checked ? 'true' : 'false'
            };
            
            // 呼叫後端API儲存交易記錄
            const response = await callGoogleAppsScript('processForm', transactionData);
            
            if (response.success) {
                showLoading(false);
                showMessage(response.message || '交易記錄已成功儲存', 'success');
                
                // 關閉模態視窗
                const modal = bootstrap.Modal.getInstance(document.getElementById('transactionModal'));
                modal.hide();
                
                // 重新載入資料
                await loadTransactionData();
                await loadDashboardStats();
            } else {
                showLoading(false);
                showMessage(response.error || '儲存失敗，請稍後再試', 'danger');
            }
            
        } catch (error) {
            console.error('儲存交易記錄失敗:', error);
            showMessage('儲存失敗，請稍後再試', 'danger');
            showLoading(false);
        }
    }
    
    // 顯示收據表單
    function showReceiptForm() {
        const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
        const form = document.getElementById('receiptForm');
        
        form.reset();
        setDefaultDates();
        modal.show();
    }
    
    // 快速開立收據
    function showQuickReceipt() {
        showReceiptForm();
    }
    
    // 儲存收據
    async function saveReceipt() {
        try {
            const form = document.getElementById('receiptForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            showLoading(true);
            
            const receiptData = {
                date: document.getElementById('receiptDate').value,
                payer: document.getElementById('receiptPayer').value,
                identity: document.getElementById('receiptIdentity').value,
                phone: document.getElementById('receiptPhone').value,
                email: document.getElementById('receiptEmail').value,
                category: document.getElementById('receiptCategory').value,
                amount: parseInt(document.getElementById('receiptAmount').value),
                purpose: document.getElementById('receiptPurpose').value,
                autoSend: document.getElementById('receiptAutoSend').checked ? 'true' : 'false'
            };
            
            // 呼叫後端API開立收據
            const response = await callGoogleAppsScript('issueReceipt', receiptData);
            
            if (response.success) {
                showLoading(false);
                showMessage(response.message || '收據已成功開立', 'success');
                
                // 關閉模態視窗
                const modal = bootstrap.Modal.getInstance(document.getElementById('receiptModal'));
                modal.hide();
                
                // 重新載入資料
                await loadReceiptData();
                await loadDashboardStats();
            } else {
                showLoading(false);
                showMessage(response.error || '開立收據失敗，請稍後再試', 'danger');
            }
            
        } catch (error) {
            console.error('開立收據失敗:', error);
            showMessage('開立收據失敗，請稍後再試', 'danger');
            showLoading(false);
        }
    }
    
    // 顯示支出憑證表單
    function showVoucherForm() {
        const modal = new bootstrap.Modal(document.getElementById('voucherModal'));
        const form = document.getElementById('voucherForm');
        
        form.reset();
        setDefaultDates();
        modal.show();
    }
    
    // 快速申請憑證
    function showQuickVoucher() {
        showVoucherForm();
    }
    
    // 處理檔案上傳
    function handleFileUpload(input) {
        const files = input.files;
        const container = document.getElementById('uploadedFiles');
        
        container.innerHTML = '';
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileItem = document.createElement('div');
            fileItem.className = 'alert alert-info d-flex justify-content-between align-items-center';
            fileItem.innerHTML = `
                <span><i class="fas fa-file me-2"></i>${file.name} (${formatFileSize(file.size)})</span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${i})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(fileItem);
        }
    }
    
    // 格式化檔案大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // 移除檔案
    function removeFile(index) {
        const input = document.getElementById('voucherFiles');
        const dt = new DataTransfer();
        
        for (let i = 0; i < input.files.length; i++) {
            if (i !== index) {
                dt.items.add(input.files[i]);
            }
        }
        
        input.files = dt.files;
        handleFileUpload(input);
    }
    
    // 儲存支出憑證
    async function saveVoucher() {
        try {
            const form = document.getElementById('voucherForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            showLoading(true);
            
            const voucherData = {
                date: document.getElementById('voucherDate').value,
                applicant: document.getElementById('voucherApplicant').value,
                category: document.getElementById('voucherCategory').value,
                amount: parseInt(document.getElementById('voucherAmount').value),
                purpose: document.getElementById('voucherPurpose').value
            };
            
            // 處理檔案上傳（如果有的話）
            const files = document.getElementById('voucherFiles').files;
            if (files.length > 0) {
                voucherData.hasAttachments = 'true';
                voucherData.attachmentCount = files.length;
            }
            
            // 呼叫後端API申請憑證
            const response = await callGoogleAppsScript('submitVoucher', voucherData);
            
            if (response.success) {
                showLoading(false);
                showMessage(response.message || '支出憑證申請已提交', 'success');
                
                // 關閉模態視窗
                const modal = bootstrap.Modal.getInstance(document.getElementById('voucherModal'));
                modal.hide();
                
                // 重新載入資料
                await loadVoucherData();
            } else {
                showLoading(false);
                showMessage(response.error || '申請失敗，請稍後再試', 'danger');
            }
            
        } catch (error) {
            console.error('申請支出憑證失敗:', error);
            showMessage('申請失敗，請稍後再試', 'danger');
            showLoading(false);
        }
    }
    
    // 顯示會員表單
    function showMemberForm(memberData = null) {
        const modal = new bootstrap.Modal(document.getElementById('memberModal'));
        const form = document.getElementById('memberForm');
        
        form.reset();
        setDefaultDates();
        
        if (memberData) {
            document.getElementById('memberModalTitle').textContent = '編輯會員資料';
            populateMemberForm(memberData);
        } else {
            document.getElementById('memberModalTitle').textContent = '新增會員';
        }
        
        modal.show();
    }
    
    // 快速新增會員
    function showQuickMember() {
        showMemberForm();
    }
    
    // 儲存會員資料
    async function saveMember() {
        try {
            const form = document.getElementById('memberForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            showLoading(true);
            
            const memberData = {
                id: document.getElementById('memberId').value,
                name: document.getElementById('memberName').value,
                gender: document.getElementById('memberGender').value,
                birthDate: document.getElementById('memberBirthDate').value,
                idCard: document.getElementById('memberIdCard').value,
                phone: document.getElementById('memberPhone').value,
                email: document.getElementById('memberEmail').value,
                address: document.getElementById('memberAddress').value,
                type: document.getElementById('memberType').value,
                joinDate: document.getElementById('memberJoinDate').value,
                notes: document.getElementById('memberNotes').value
            };
            
            // 呼叫後端API儲存會員資料
            const response = await callGoogleAppsScript('saveMember', memberData);
            
            if (response.success) {
                showLoading(false);
                showMessage(response.message || '會員資料已成功儲存', 'success');
                
                // 關閉模態視窗
                const modal = bootstrap.Modal.getInstance(document.getElementById('memberModal'));
                modal.hide();
                
                // 重新載入資料
                await loadMemberData();
                await loadDashboardStats();
            } else {
                showLoading(false);
                showMessage(response.error || '儲存失敗，請稍後再試', 'danger');
            }
            
        } catch (error) {
            console.error('儲存會員資料失敗:', error);
            showMessage('儲存失敗，請稍後再試', 'danger');
            showLoading(false);
        }
    }
    
    // ========================================
    // 資料載入與顯示功能
    // ========================================
    
    // 載入交易記錄資料
    async function loadTransactionData() {
        try {
            const response = await callGoogleAppsScript('getTransactions', currentFilters.transaction || {});
            
            if (response.success) {
                displayTransactionData(response.data);
            } else {
                showMessage('載入交易記錄失敗', 'warning');
            }
            
        } catch (error) {
            console.error('載入交易記錄失敗:', error);
            showMessage('載入交易記錄失敗', 'danger');
        }
    }
    
    // 顯示交易記錄資料
    function displayTransactionData(transactions) {
        const tbody = document.getElementById('transactionTableBody');
        
        if (!transactions || transactions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4">暫無交易記錄</td></tr>';
            return;
        }
        
        tbody.innerHTML = transactions.map(transaction => `
            <tr>
                <td>${formatDate(transaction.date)}</td>
                <td>${transaction.name}</td>
                <td>
                    <span class="badge ${transaction.type === '收入' ? 'bg-success' : 'bg-danger'}">
                        ${transaction.type}
                    </span>
                </td>
                <td>${transaction.category}</td>
                <td class="text-end">$${transaction.amount.toLocaleString()}</td>
                <td>${transaction.description || '-'}</td>
                <td>${transaction.receiptNumber || '-'}</td>
                <td>
                    <span class="status-badge status-success">已確認</span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary" onclick="editTransaction('${transaction.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction('${transaction.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    // 載入收據資料
    async function loadReceiptData() {
        try {
            const response = await callGoogleAppsScript('getReceipts', currentFilters.receipt || {});
            
            if (response.success) {
                displayReceiptData(response.data);
            } else {
                showMessage('載入收據記錄失敗', 'warning');
            }
            
        } catch (error) {
            console.error('載入收據記錄失敗:', error);
            showMessage('載入收據記錄失敗', 'danger');
        }
    }
    
    // 顯示收據資料
    function displayReceiptData(receipts) {
        const tbody = document.getElementById('receiptTableBody');
        
        if (!receipts || receipts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4">暫無收據記錄</td></tr>';
            return;
        }
        
        tbody.innerHTML = receipts.map(receipt => `
            <tr>
                <td>${receipt.receiptNumber}</td>
                <td>${formatDate(receipt.date)}</td>
                <td>${receipt.payer}</td>
                <td>${receipt.phone || '-'}</td>
                <td>${receipt.category}</td>
                <td class="text-end">$${receipt.amount.toLocaleString()}</td>
                <td>
                    <span class="status-badge status-success">已開立</span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-info" onclick="printReceipt('${receipt.id}')">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="sendReceipt('${receipt.id}')">
                            <i class="fas fa-envelope"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    // 載入憑證資料
    async function loadVoucherData() {
        try {
            const response = await callGoogleAppsScript('getVouchers', currentFilters.voucher || {});
            
            if (response.success) {
                displayVoucherData(response.data);
            } else {
                showMessage('載入憑證記錄失敗', 'warning');
            }
            
        } catch (error) {
            console.error('載入憑證記錄失敗:', error);
            showMessage('載入憑證記錄失敗', 'danger');
        }
    }
    
    // 顯示憑證資料
    function displayVoucherData(vouchers) {
        const tbody = document.getElementById('voucherTableBody');
        
        if (!vouchers || vouchers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4">暫無憑證記錄</td></tr>';
            return;
        }
        
        tbody.innerHTML = vouchers.map(voucher => `
            <tr>
                <td>
                    <input type="checkbox" class="voucher-checkbox" value="${voucher.id}">
                </td>
                <td>${voucher.voucherNumber}</td>
                <td>${formatDate(voucher.date)}</td>
                <td>${voucher.applicant}</td>
                <td>${voucher.category}</td>
                <td class="text-end">$${voucher.amount.toLocaleString()}</td>
                <td>${voucher.purpose}</td>
                <td>
                    <span class="status-badge ${getVoucherStatusClass(voucher.status)}">
                        ${voucher.status}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-success" onclick="approveVoucher('${voucher.id}')">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="rejectVoucher('${voucher.id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    // 取得憑證狀態樣式
    function getVoucherStatusClass(status) {
        const classes = {
            '待審核': 'status-pending',
            '已核准': 'status-success',
            '已駁回': 'status-danger',
            '已付款': 'status-success'
        };
        return classes[status] || 'status-pending';
    }
    
    // 載入會員資料
    async function loadMemberData() {
        try {
            const response = await callGoogleAppsScript('getMembers', currentFilters.member || {});
            
            if (response.success) {
                displayMemberData(response.data);
            } else {
                showMessage('載入會員資料失敗', 'warning');
            }
            
        } catch (error) {
            console.error('載入會員資料失敗:', error);
            showMessage('載入會員資料失敗', 'danger');
        }
    }
    
    // 顯示會員資料
    function displayMemberData(members) {
        const tbody = document.getElementById('memberTableBody');
        
        if (!members || members.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4">暫無會員資料</td></tr>';
            return;
        }
        
        tbody.innerHTML = members.map(member => `
            <tr>
                <td>${member.memberNumber}</td>
                <td>${member.name}</td>
                <td>${member.gender || '-'}</td>
                <td>${member.phone}</td>
                <td>${member.email || '-'}</td>
                <td>${member.type}</td>
                <td>${formatDate(member.joinDate)}</td>
                <td>
                    <span class="status-badge status-success">正常</span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary" onclick="editMember('${member.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewMemberDetails('${member.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    // ========================================
    // 搜尋與篩選功能
    // ========================================
    
    // 搜尋交易記錄
    function searchTransactions() {
        currentFilters.transaction = {
            search: document.getElementById('transactionSearch').value,
            type: document.getElementById('transactionTypeFilter').value,
            dateFrom: document.getElementById('transactionDateFrom').value,
            dateTo: document.getElementById('transactionDateTo').value
        };
        
        loadTransactionData();
    }
    
    // 重置交易篩選
    function resetTransactionFilter() {
        document.getElementById('transactionSearch').value = '';
        document.getElementById('transactionTypeFilter').value = '';
        document.getElementById('transactionDateFrom').value = '';
        document.getElementById('transactionDateTo').value = '';
        
        currentFilters.transaction = {};
        loadTransactionData();
    }
    
    // 搜尋收據
    function searchReceipts() {
        currentFilters.receipt = {
            search: document.getElementById('receiptSearch').value,
            status: document.getElementById('receiptStatusFilter').value
        };
        
        loadReceiptData();
    }
    
    // 重置收據篩選
    function resetReceiptFilter() {
        document.getElementById('receiptSearch').value = '';
        document.getElementById('receiptStatusFilter').value = '';
        
        currentFilters.receipt = {};
        loadReceiptData();
    }
    
    // 搜尋憑證
    function searchVouchers() {
        currentFilters.voucher = {
            search: document.getElementById('voucherSearch').value,
            status: document.getElementById('voucherStatusFilter').value
        };
        
        loadVoucherData();
    }
    
    // 重置憑證篩選
    function resetVoucherFilter() {
        document.getElementById('voucherSearch').value = '';
        document.getElementById('voucherStatusFilter').value = '';
        
        currentFilters.voucher = {};
        loadVoucherData();
    }
    
    // 搜尋會員
    function searchMembers() {
        currentFilters.member = {
            search: document.getElementById('memberSearch').value,
            type: document.getElementById('memberTypeFilter').value,
            status: document.getElementById('memberStatusFilter').value
        };
        
        loadMemberData();
    }
    
    // 重置會員篩選
    function resetMemberFilter() {
        document.getElementById('memberSearch').value = '';
        document.getElementById('memberTypeFilter').value = '';
        document.getElementById('memberStatusFilter').value = '';
        
        currentFilters.member = {};
        loadMemberData();
    }
    
    // ========================================
    // 報表功能
    // ========================================
    
    // 產生報表
    async function generateReport() {
        try {
            showLoading(true);
            
            const reportParams = {
                type: document.getElementById('reportType').value,
                year: document.getElementById('reportYear').value,
                month: document.getElementById('reportMonth').value
            };
            
            const response = await callGoogleAppsScript('generateReport', reportParams);
            
            if (response.success) {
                displayReport(response.data);
                showMessage('報表產生成功', 'success');
            } else {
                showMessage('報表產生失敗', 'danger');
            }
            
            showLoading(false);
            
        } catch (error) {
            console.error('產生報表失敗:', error);
            showMessage('產生報表失敗', 'danger');
            showLoading(false);
        }
    }
    
    // 顯示報表
    function displayReport(reportData) {
        const container = document.getElementById('reportContent');
        
        if (!reportData) {
            container.innerHTML = '<div class="text-center py-5"><h6 class="text-muted">無報表資料</h6></div>';
            return;
        }
        
        // 根據報表類型顯示不同內容
        let reportHtml = '';
        
        switch (reportData.type) {
            case 'monthly':
                reportHtml = generateMonthlyReport(reportData);
                break;
            case 'yearly':
                reportHtml = generateYearlyReport(reportData);
                break;
            case 'category':
                reportHtml = generateCategoryReport(reportData);
                break;
            case 'member':
                reportHtml = generateMemberReport(reportData);
                break;
            case 'donation':
                reportHtml = generateDonationReport(reportData);
                break;
            default:
                reportHtml = '<div class="text-center py-5"><h6 class="text-muted">未知的報表類型</h6></div>';
        }
        
        container.innerHTML = reportHtml;
    }
    
    // 產生月度報表
    function generateMonthlyReport(data) {
        return `
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-calendar-alt me-2"></i>${data.title}</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-icon income">
                                    <i class="fas fa-arrow-up"></i>
                                </div>
                                <div class="stat-value">$${data.totalIncome.toLocaleString()}</div>
                                <div class="stat-label">總收入</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-icon expense">
                                    <i class="fas fa-arrow-down"></i>
                                </div>
                                <div class="stat-value">$${data.totalExpense.toLocaleString()}</div>
                                <div class="stat-label">總支出</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-icon ${data.netAmount >= 0 ? 'income' : 'expense'}">
                                    <i class="fas fa-calculator"></i>
                                </div>
                                <div class="stat-value">$${data.netAmount.toLocaleString()}</div>
                                <div class="stat-label">淨額</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>類別</th>
                                    <th class="text-end">收入</th>
                                    <th class="text-end">支出</th>
                                    <th class="text-end">小計</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.categories.map(cat => `
                                    <tr>
                                        <td>${cat.name}</td>
                                        <td class="text-end">$${cat.income.toLocaleString()}</td>
                                        <td class="text-end">$${cat.expense.toLocaleString()}</td>
                                        <td class="text-end">$${(cat.income - cat.expense).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }
    
    // 產生年度報表
    function generateYearlyReport(data) {
        return `
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-chart-line me-2"></i>${data.title}</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-icon income">
                                    <i class="fas fa-arrow-up"></i>
                                </div>
                                <div class="stat-value">$${data.totalIncome.toLocaleString()}</div>
                                <div class="stat-label">年度總收入</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-icon expense">
                                    <i class="fas fa-arrow-down"></i>
                                </div>
                                <div class="stat-value">$${data.totalExpense.toLocaleString()}</div>
                                <div class="stat-label">年度總支出</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-icon receipt">
                                    <i class="fas fa-receipt"></i>
                                </div>
                                <div class="stat-value">${data.receiptCount}</div>
                                <div class="stat-label">收據總數</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-icon member">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-value">${data.memberCount}</div>
                                <div class="stat-label">會員總數</div>
                            </div>
                        </div>
                    </div>
                    
                    <h6><i class="fas fa-chart-bar me-2"></i>月度趨勢</h6>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>月份</th>
                                    <th class="text-end">收入</th>
                                    <th class="text-end">支出</th>
                                    <th class="text-end">淨額</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.monthlyData.map(month => `
                                    <tr>
                                        <td>${month.month}月</td>
                                        <td class="text-end">$${month.income.toLocaleString()}</td>
                                        <td class="text-end">$${month.expense.toLocaleString()}</td>
                                        <td class="text-end">$${(month.income - month.expense).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }
    
    // 產生類別報表
    function generateCategoryReport(data) {
        return `
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-tags me-2"></i>${data.title}</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>類別</th>
                                    <th class="text-end">交易次數</th>
                                    <th class="text-end">總金額</th>
                                    <th class="text-end">平均金額</th>
                                    <th class="text-end">佔比</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.categories.map(cat => `
                                    <tr>
                                        <td>${cat.name}</td>
                                        <td class="text-end">${cat.count}</td>
                                        <td class="text-end">$${cat.amount.toLocaleString()}</td>
                                        <td class="text-end">$${cat.average.toLocaleString()}</td>
                                        <td class="text-end">${cat.percentage}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }
    
    // 產生會員報表
    function generateMemberReport(data) {
        return `
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-users me-2"></i>${data.title}</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-icon member">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-value">${data.totalMembers}</div>
                                <div class="stat-label">總會員數</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-icon income">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                <div class="stat-value">${data.newMembers}</div>
                                <div class="stat-label">新增會員</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-icon receipt">
                                    <i class="fas fa-user-check"></i>
                                </div>
                                <div class="stat-value">${data.activeMembers}</div>
                                <div class="stat-label">活躍會員</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-icon expense">
                                    <i class="fas fa-birthday-cake"></i>
                                </div>
                                <div class="stat-value">${data.birthdayMembers}</div>
                                <div class="stat-label">本月壽星</div>
                            </div>
                        </div>
                    </div>
                    
                    <h6><i class="fas fa-chart-pie me-2"></i>會員類型分布</h6>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>會員類型</th>
                                    <th class="text-end">人數</th>
                                    <th class="text-end">佔比</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.memberTypes.map(type => `
                                    <tr>
                                        <td>${type.name}</td>
                                        <td class="text-end">${type.count}</td>
                                        <td class="text-end">${type.percentage}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }
    
    // 產生捐款報表
    function generateDonationReport(data) {
        return `
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-hand-holding-heart me-2"></i>${data.title}</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-icon income">
                                    <i class="fas fa-hand-holding-usd"></i>
                                </div>
                                <div class="stat-value">$${data.totalDonation.toLocaleString()}</div>
                                <div class="stat-label">總捐款金額</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-icon receipt">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-value">${data.donorCount}</div>
                                <div class="stat-label">捐款人數</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-icon member">
                                    <i class="fas fa-calculator"></i>
                                </div>
                                <div class="stat-value">$${data.averageDonation.toLocaleString()}</div>
                                <div class="stat-label">平均捐款</div>
                            </div>
                        </div>
                    </div>
                    
                    <h6><i class="fas fa-chart-bar me-2"></i>捐款統計</h6>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>捐款區間</th>
                                    <th class="text-end">人數</th>
                                    <th class="text-end">金額</th>
                                    <th class="text-end">佔比</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.donationRanges.map(range => `
                                    <tr>
                                        <td>${range.range}</td>
                                        <td class="text-end">${range.count}</td>
                                        <td class="text-end">$${range.amount.toLocaleString()}</td>
                                        <td class="text-end">${range.percentage}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }
    
    // 匯出報表Excel
    async function exportReport() {
        try {
            showLoading(true);
            
            const reportParams = {
                type: document.getElementById('reportType').value,
                year: document.getElementById('reportYear').value,
                month: document.getElementById('reportMonth').value,
                format: 'excel'
            };
            
            const response = await callGoogleAppsScript('exportReport', reportParams);
            
            if (response.success) {
                // 下載檔案
                const link = document.createElement('a');
                link.href = response.downloadUrl;
                link.download = response.filename;
                link.click();
                
                showMessage('報表匯出成功', 'success');
            } else {
                showMessage('報表匯出失敗', 'danger');
            }
            
            showLoading(false);
            
        } catch (error) {
            console.error('匯出報表失敗:', error);
            showMessage('匯出報表失敗', 'danger');
            showLoading(false);
        }
    }
    
    // 匯出報表PDF
    async function exportReportPDF() {
        try {
            showLoading(true);
            
            const reportParams = {
                type: document.getElementById('reportType').value,
                year: document.getElementById('reportYear').value,
                month: document.getElementById('reportMonth').value,
                format: 'pdf'
            };
            
            const response = await callGoogleAppsScript('exportReport', reportParams);
            
            if (response.success) {
                // 下載檔案
                const link = document.createElement('a');
                link.href = response.downloadUrl;
                link.download = response.filename;
                link.click();
                
                showMessage('報表匯出成功', 'success');
            } else {
                showMessage('報表匯出失敗', 'danger');
            }
            
            showLoading(false);
            
        } catch (error) {
            console.error('匯出報表失敗:', error);
            showMessage('匯出報表失敗', 'danger');
            showLoading(false);
        }
    }
    
    // ========================================
    // 系統設定功能
    // ========================================
    
    // 儲存組織資訊
    async function saveOrganizationInfo() {
        try {
            showLoading(true);
            
            const orgData = {
                name: document.getElementById('orgName').value,
                taxId: document.getElementById('orgTaxId').value,
                address: document.getElementById('orgAddress').value,
                phone: document.getElementById('orgPhone').value,
                email: document.getElementById('orgEmail').value,
                director: document.getElementById('orgDirector').value
            };
            
            const response = await callGoogleAppsScript('saveOrganizationInfo', orgData);
            
            if (response.success) {
                showMessage('組織資訊已成功儲存', 'success');
            } else {
                showMessage('儲存失敗，請稍後再試', 'danger');
            }
            
            showLoading(false);
            
        } catch (error) {
            console.error('儲存組織資訊失敗:', error);
            showMessage('儲存失敗，請稍後再試', 'danger');
            showLoading(false);
        }
    }
    
    // 儲存郵件設定
    async function saveEmailSettings() {
        try {
            showLoading(true);
            
            const emailData = {
                senderName: document.getElementById('emailSenderName').value,
                replyTo: document.getElementById('emailReplyTo').value,
                signature: document.getElementById('emailSignature').value,
                autoSendReceipt: document.getElementById('autoSendReceipt').checked,
                emailNotification: document.getElementById('emailNotification').checked
            };
            
            const response = await callGoogleAppsScript('saveEmailSettings', emailData);
            
            if (response.success) {
                showMessage('郵件設定已成功儲存', 'success');
            } else {
                showMessage('儲存失敗，請稍後再試', 'danger');
            }
            
            showLoading(false);
            
        } catch (error) {
            console.error('儲存郵件設定失敗:', error);
            showMessage('儲存失敗，請稍後再試', 'danger');
            showLoading(false);
        }
    }
    
    // 測試郵件設定
    async function testEmailSettings() {
        try {
            showLoading(true);
            
            const response = await callGoogleAppsScript('testEmailSettings');
            
            if (response.success) {
                showMessage('測試郵件已成功寄送', 'success');
            } else {
                showMessage('測試郵件寄送失敗', 'danger');
            }
            
            showLoading(false);
            
        } catch (error) {
            console.error('測試郵件失敗:', error);
            showMessage('測試郵件失敗', 'danger');
            showLoading(false);
        }
    }
    
    // 建立系統備份
    async function createBackup() {
        try {
            showLoading(true);
            
            const response = await callGoogleAppsScript('createBackup');
            
            if (response.success) {
                showMessage('系統備份已成功建立', 'success');
            } else {
                showMessage('建立備份失敗', 'danger');
            }
            
            showLoading(false);
            
        } catch (error) {
            console.error('建立備份失敗:', error);
            showMessage('建立備份失敗', 'danger');
            showLoading(false);
        }
    }
    
    // 執行系統健康檢查
    async function performSystemCheck() {
        try {
            showLoading(true);
            
            const response = await callGoogleAppsScript('performSystemCheck');
            
            if (response.success) {
                showMessage('系統健康檢查完成', 'success');
                
                // 顯示檢查結果
                const results = response.results;
                let message = '檢查結果：\n';
                results.forEach(result => {
                    message += `${result.item}: ${result.status}\n`;
                });
                
                alert(message);
            } else {
                showMessage('系統檢查失敗', 'danger');
            }
            
            showLoading(false);
            
        } catch (error) {
            console.error('系統檢查失敗:', error);
            showMessage('系統檢查失敗', 'danger');
            showLoading(false);
        }
    }
    
    // 顯示系統資訊
    function showSystemInfo() {
        const modal = new bootstrap.Modal(document.getElementById('systemInfoModal'));
        modal.show();
    }
    
    // ========================================
    // 資料匯出功能
    // ========================================
    
    // 匯出交易資料
    async function exportTransactionData() {
        try {
            showLoading(true);
            
            const response = await callGoogleAppsScript('exportTransactionData', currentFilters.transaction || {});
            
            if (response.success) {
                // 下載檔案
                const link = document.createElement('a');
                link.href = response.downloadUrl;
                link.download = response.filename;
                link.click();
                
                showMessage('交易資料匯出成功', 'success');
            } else {
                showMessage('匯出失敗', 'danger');
            }
            
            showLoading(false);
            
        } catch (error) {
            console.error('匯出交易資料失敗:', error);
            showMessage('匯出失敗', 'danger');
            showLoading(false);
        }
    }
    
    // 匯出收據資料
    async function exportReceiptData() {
        try {
            showLoading(true);
            
            const response = await callGoogleAppsScript('exportReceiptData', currentFilters.receipt || {});
            
            if (response.success) {
                // 下載檔案
                const link = document.createElement('a');
                link.href = response.downloadUrl;
                link.download = response.filename;
                link.click();
                
                showMessage('收據資料匯出成功', 'success');
            } else {
                showMessage('匯出失敗', 'danger');
            }
            
            showLoading(false);
            
        } catch (error) {
            console.error('匯出收據資料失敗:', error);
            showMessage('匯出失敗', 'danger');
            showLoading(false);
        }
    }
    
    // 匯出會員資料
    async function exportMemberData() {
        try {
            showLoading(true);
            
            const response = await callGoogleAppsScript('exportMemberData', currentFilters.member || {});
            
            if (response.success) {
                // 下載檔案
                const link = document.createElement('a');
                link.href = response.downloadUrl;
                link.download = response.filename;
                link.click();
                
                showMessage('會員資料匯出成功', 'success');
            } else {
                showMessage('匯出失敗', 'danger');
            }
            
            showLoading(false);
            
        } catch (error) {
            console.error('匯出會員資料失敗:', error);
            showMessage('匯出失敗', 'danger');
            showLoading(false);
        }
    }
    
    // ========================================
    // 操作功能
    // ========================================
    
    // 批量核准憑證
    function approveSelectedVouchers() {
        const checkboxes = document.querySelectorAll('.voucher-checkbox:checked');
        
        if (checkboxes.length === 0) {
            showMessage('請選擇要核准的憑證', 'warning');
            return;
        }
        
        const voucherIds = Array.from(checkboxes).map(cb => cb.value);
        
        if (confirm(`確定要核准 ${voucherIds.length} 筆憑證嗎？`)) {
            batchApproveVouchers(voucherIds);
        }
    }
    
    // 批量核准憑證API呼叫
    async function batchApproveVouchers(voucherIds) {
        try {
            showLoading(true);
            
            const response = await callGoogleAppsScript('batchApproveVouchers', { voucherIds });
            
            if (response.success) {
                showMessage(`成功核准 ${voucherIds.length} 筆憑證`, 'success');
                await loadVoucherData();
            } else {
                showMessage('批量核准失敗', 'danger');
            }
            
            showLoading(false);
            
        } catch (error) {
            console.error('批量核准失敗:', error);
            showMessage('批量核准失敗', 'danger');
            showLoading(false);
        }
    }
    
    // 切換全選憑證
    function toggleAllVouchers() {
        const selectAll = document.getElementById('selectAllVouchers');
        const checkboxes = document.querySelectorAll('.voucher-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
    }
    
    // 列印收據
    async function printReceipt(receiptId) {
        try {
            showLoading(true);
            
            const response = await callGoogleAppsScript('generateReceiptPDF', { receiptId });
            
            if (response.success) {
                // 開啟列印視窗
                window.open(response.pdfUrl, '_blank');
                showMessage('收據已產生，請列印', 'success');
            } else {
                showMessage('產生收據失敗', 'danger');
            }
            
            showLoading(false);
            
        } catch (error) {
            console.error('列印收據失敗:', error);
            showMessage('列印收據失敗', 'danger');
            showLoading(false);
        }
    }
    
    // 寄送收據
    async function sendReceipt(receiptId) {
        try {
            showLoading(true);
            
            const response = await callGoogleAppsScript('sendReceiptEmail', { receiptId });
            
            if (response.success) {
                showMessage('收據已成功寄送', 'success');
            } else {
                showMessage('寄送收據失敗', 'danger');
            }
            
            showLoading(false);
            
        } catch (error) {
            console.error('寄送收據失敗:', error);
            showMessage('寄送收據失敗', 'danger');
            showLoading(false);
        }
    }
    
    // ========================================
    // 工具函數
    // ========================================
    
    // 格式化日期
    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW');
    }
    
    // 顯示載入狀態
    function showLoading(show) {
        isLoading = show;
        const loadingElements = document.querySelectorAll('.loading-spinner');
        
        if (show) {
            document.body.style.cursor = 'wait';
            loadingElements.forEach(el => el.style.display = 'block');
        } else {
            document.body.style.cursor = 'default';
            loadingElements.forEach(el => el.style.display = 'none');
        }
    }
    
    // 顯示訊息
    function showMessage(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // 自動移除訊息
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
    }
    
    // 呼叫Google Apps Script API
    async function callGoogleAppsScript(functionName, parameters = {}) {
        try {
            // 這裡應該替換為實際的Google Apps Script Web App URL
            const scriptUrl = 'https://script.google.com/macros/s/AKfycbxk1vuPOtY-t9eaEpkQzFx0S8lZ-86M3DxbItzNh8fJOBbmQd61x7vy3tfWkTScOH2Rqw/exec';
            
            const response = await fetch(scriptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    function: functionName,
                    parameters: parameters
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            return data;
            
        } catch (error) {
            console.error('API呼叫失敗:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }
    
    // 設定事件監聽器
    function setupEventListeners() {
        // 標籤切換事件
        const tabLinks = document.querySelectorAll('[data-bs-toggle="tab"]');
        tabLinks.forEach(link => {
            link.addEventListener('shown.bs.tab', function(e) {
                const targetId = e.target.getAttribute('data-bs-target');
                
                // 根據切換的標籤載入對應資料
                switch(targetId) {
                    case '#transaction':
                        loadTransactionData();
                        break;
                    case '#receipt':
                        loadReceiptData();
                        break;
                    case '#voucher':
                        loadVoucherData();
                        break;
                    case '#member':
                        loadMemberData();
                        break;
                }
            });
        });
        
        // 搜尋框即時搜尋
        const searchInputs = document.querySelectorAll('[id$="Search"]');
        searchInputs.forEach(input => {
            input.addEventListener('input', debounce(function() {
                const searchType = this.id.replace('Search', '').toLowerCase();
                
                switch(searchType) {
                    case 'transaction':
                        searchTransactions();
                        break;
                    case 'receipt':
                        searchReceipts();
                        break;
                    case 'voucher':
                        searchVouchers();
                        break;
                    case 'member':
                        searchMembers();
                        break;
                }
            }, 500));
        });
    }
    
    // 防抖函數
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // 頁面載入完成後執行
    window.addEventListener('load', function() {
        console.log('頁面載入完成');
        
        // 預設載入儀表板資料
        loadDashboardStats();
        loadRecentActivities();
    });
    
    // 錯誤處理
    window.addEventListener('error', function(e) {
        console.error('頁面錯誤:', e.error);
        showMessage('系統發生錯誤，請重新整理頁面', 'danger');
    });
    
    // 離線檢測
    window.addEventListener('online', function() {
        showMessage('網路連線已恢復', 'success');
    });
    
    window.addEventListener('offline', function() {
        showMessage('網路連線中斷，部分功能可能無法使用', 'warning');
    });
    
</script>

<!-- 載入動畫 -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">載入中...</span>
        </div>
        <p class="mt-2">處理中，請稍候...</p>
    </div>
</div>

<style>
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
        color: white;
    }
</style>

</body>
</html>
