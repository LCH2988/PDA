<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會會計管理系統 v3.0</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  
  <!-- 自定義樣式 -->
  <style>
    :root {
      --primary-color: #2c5aa0;
      --secondary-color: #17a2b8;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --border-radius: 8px;
      --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }

    body {
      font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px 0;
    }

    .main-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
      animation: float 20s infinite linear;
    }

    @keyframes float {
      0% { transform: translateX(0) translateY(0); }
      100% { transform: translateX(-50px) translateY(-50px); }
    }

    .header h1 {
      position: relative;
      z-index: 2;
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
    }

    .header .subtitle {
      position: relative;
      z-index: 2;
      margin: 5px 0 0 0;
      opacity: 0.9;
      font-size: 1rem;
    }

    .sync-status {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 3;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 15px;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      transition: var(--transition);
      font-size: 0.85rem;
    }

    .sync-status:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.05);
    }

    .nav-tabs {
      background: var(--light-color);
      border-bottom: 2px solid var(--primary-color);
    }

    .nav-tabs .nav-link {
      color: var(--dark-color);
      border: none;
      border-radius: 0;
      padding: 15px 20px;
      font-weight: 500;
      transition: var(--transition);
      position: relative;
    }

    .nav-tabs .nav-link:hover {
      background: rgba(44, 90, 160, 0.1);
      border-color: transparent;
    }

    .nav-tabs .nav-link.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .nav-tabs .nav-link.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary-color);
    }

    .tab-content {
      padding: 30px;
      min-height: 600px;
    }

    .card {
      border: none;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      transition: var(--transition);
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .card-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      border: none;
      padding: 15px 20px;
      font-weight: 600;
    }

    .stats-card {
      text-align: center;
      padding: 25px;
      margin-bottom: 20px;
      border-left: 4px solid;
      transition: var(--transition);
    }

    .stats-card:hover {
      transform: scale(1.02);
    }

    .stats-card.income { border-left-color: var(--success-color); }
    .stats-card.expense { border-left-color: var(--danger-color); }
    .stats-card.net { border-left-color: var(--info-color); }
    .stats-card.count { border-left-color: var(--warning-color); }

    .stats-card .stats-number {
      font-size: 2rem;
      font-weight: 700;
      margin: 10px 0;
    }

    .stats-card .stats-label {
      color: #6c757d;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn {
      border-radius: var(--border-radius);
      padding: 10px 20px;
      font-weight: 500;
      transition: var(--transition);
      border: none;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger-color) 0%, #e83e8c 100%);
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning-color) 0%, #fd7e14 100%);
      color: white;
    }

    .btn-info {
      background: linear-gradient(135deg, var(--info-color) 0%, #6f42c1 100%);
    }

    .table {
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow);
    }

    .table thead th {
      background: var(--primary-color);
      color: white;
      border: none;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.85rem;
    }

    .table tbody tr {
      transition: var(--transition);
    }

    .table tbody tr:hover {
      background: rgba(44, 90, 160, 0.05);
      transform: scale(1.01);
    }

    .form-control, .form-select {
      border-radius: var(--border-radius);
      border: 2px solid #e9ecef;
      padding: 12px 15px;
      transition: var(--transition);
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25);
    }

    .modal-content {
      border-radius: var(--border-radius);
      border: none;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      border: none;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .modal-footer {
      border: none;
      padding: 20px;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin: 20px 0;
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--box-shadow);
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(5px);
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .badge {
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .alert {
      border: none;
      border-radius: var(--border-radius);
      border-left: 4px solid;
    }

    .alert-success { border-left-color: var(--success-color); }
    .alert-danger { border-left-color: var(--danger-color); }
    .alert-warning { border-left-color: var(--warning-color); }
    .alert-info { border-left-color: var(--info-color); }

    .quick-actions {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
    }

    .quick-action-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transition: var(--transition);
    }

    .quick-action-btn:hover {
      transform: scale(1.1);
    }

    .progress {
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar {
      background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      transition: width 0.6s ease;
    }

    .search-box {
      position: relative;
      margin-bottom: 20px;
    }

    .search-box input {
      padding-left: 45px;
    }

    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
    }

    .filter-tags {
      margin-bottom: 20px;
    }

    .filter-tag {
      display: inline-block;
      background: var(--primary-color);
      color: white;
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 0.8rem;
      margin-right: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: var(--transition);
    }

    .filter-tag:hover {
      background: var(--secondary-color);
      transform: scale(1.05);
    }

    .filter-tag.active {
      background: var(--success-color);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .tooltip-inner {
      background: var(--dark-color);
      border-radius: var(--border-radius);
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
      min-width: 300px;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    @media (max-width: 768px) {
      .main-container {
        margin: 10px;
      }
      
      .header h1 {
        font-size: 1.4rem;
      }
      
      .tab-content {
        padding: 15px;
      }
      
      .stats-card {
        margin-bottom: 15px;
      }
      
      .quick-actions {
        bottom: 20px;
        right: 20px;
      }
      
      .sync-status {
        position: relative;
        top: auto;
        right: auto;
        margin-top: 10px;
        display: inline-block;
      }
    }

    .receipt-template {
      font-family: 'Microsoft JhengHei', sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 40px;
      border: 2px solid #333;
      background: white;
    }

    .receipt-header {
      text-align: center;
      border-bottom: 3px solid var(--primary-color);
      padding-bottom: 20px;
      margin-bottom: 30px;
    }

    .receipt-title {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 10px;
    }

    .receipt-subtitle {
      font-size: 1.2rem;
      color: #666;
      margin-bottom: 5px;
    }

    .receipt-number {
      font-size: 1rem;
      color: #999;
    }

    .receipt-body {
      margin: 30px 0;
    }

    .receipt-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .receipt-row:last-child {
      border-bottom: none;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .receipt-footer {
      margin-top: 40px;
      text-align: center;
      font-size: 0.9rem;
      color: #666;
    }
  </style>
</head>
<body>
  <!-- 載入遮罩 -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- 通知容器 -->
  <div id="notificationContainer"></div>

  <!-- 主容器 -->
  <div class="container">
    <div class="main-container">
      <!-- 標題區域 -->
      <div class="header">
        <div class="sync-status" id="syncStatus" onclick="showSyncMenu()">
          <i class="bi bi-cloud-slash"></i>
          <span>未同步</span>
        </div>
        <h1>台灣帕金森病友權益促進會</h1>
        <p class="subtitle">會計管理系統 v3.0</p>
      </div>

      <!-- 導航標籤 -->
      <ul class="nav nav-tabs" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
            <i class="bi bi-speedometer2"></i> 儀表板
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">
            <i class="bi bi-receipt"></i> 交易記錄
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="members-tab" data-bs-toggle="tab" data-bs-target="#members" type="button" role="tab">
            <i class="bi bi-people"></i> 會員管理
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
            <i class="bi bi-bar-chart"></i> 統計分析
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
            <i class="bi bi-gear"></i> 系統設定
          </button>
        </li>
      </ul>

      <!-- 標籤內容 -->
      <div class="tab-content" id="mainTabContent">
        <!-- 儀表板 -->
        <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
          <div class="row">
            <div class="col-md-3 col-sm-6">
              <div class="card stats-card income">
                <div class="stats-number text-success" id="totalIncome">NT$ 0</div>
                <div class="stats-label">本月收入</div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6">
              <div class="card stats-card expense">
                <div class="stats-number text-danger" id="totalExpense">NT$ 0</div>
                <div class="stats-label">本月支出</div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6">
              <div class="card stats-card net">
                <div class="stats-number text-info" id="netAmount">NT$ 0</div>
                <div class="stats-label">淨收益</div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6">
              <div class="card stats-card count">
                <div class="stats-number text-warning" id="totalTransactions">0</div>
                <div class="stats-label">交易筆數</div>
              </div>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col-md-8">
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-graph-up"></i> 月度收支趨勢
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="monthlyTrendChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-pie-chart"></i> 收入類別分布
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="categoryPieChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-clock-history"></i> 最近交易記錄
                </div>
                <div class="card-body">
                  <div id="recentTransactions"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 交易記錄 -->
        <div class="tab-pane fade" id="transactions" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-receipt"></i> 交易記錄管理</h3>
            <div class="btn-group">
              <button class="btn btn-primary" onclick="showTransactionModal()">
                <i class="bi bi-plus-lg"></i> 新增交易
              </button>
              <button class="btn btn-success" onclick="exportTransactions()">
                <i class="bi bi-download"></i> 匯出資料
              </button>
              <button class="btn btn-info" onclick="importTransactions()">
                <i class="bi bi-upload"></i> 匯入資料
              </button>
            </div>
          </div>

          <!-- 搜尋和篩選 -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" class="form-control" id="transactionSearch" placeholder="搜尋交易記錄...">
              </div>
            </div>
            <div class="col-md-6">
              <div class="row">
                <div class="col-md-4">
                  <select class="form-select" id="typeFilter">
                    <option value="">所有類型</option>
                    <option value="收入">收入</option>
                    <option value="支出">支出</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <select class="form-select" id="categoryFilter">
                    <option value="">所有類別</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <input type="month" class="form-control" id="monthFilter">
                </div>
              </div>
            </div>
          </div>

          <!-- 篩選標籤 -->
          <div class="filter-tags" id="filterTags"></div>

          <!-- 交易記錄表格 -->
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>日期</th>
                  <th>類型</th>
                  <th>類別</th>
                  <th>金額</th>
                  <th>對象</th>
                  <th>說明</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="transactionTableBody">
                <!-- 動態載入 -->
              </tbody>
            </table>
          </div>

          <!-- 分頁 -->
          <nav aria-label="交易記錄分頁">
            <ul class="pagination justify-content-center" id="transactionPagination">
              <!-- 動態載入 -->
            </ul>
          </nav>
        </div>

        <!-- 會員管理 -->
        <div class="tab-pane fade" id="members" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-people"></i> 會員管理</h3>
            <div class="btn-group">
              <button class="btn btn-primary" onclick="showMemberModal()">
                <i class="bi bi-person-plus"></i> 新增會員
              </button>
              <button class="btn btn-success" onclick="exportMembers()">
                <i class="bi bi-download"></i> 匯出資料
              </button>
              <button class="btn btn-info" onclick="importMembers()">
                <i class="bi bi-upload"></i> 匯入資料
              </button>
            </div>
          </div>

          <!-- 會員統計 -->
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h4 class="text-primary" id="totalMembers">0</h4>
                  <p class="card-text">總會員數</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h4 class="text-success" id="activeMembers">0</h4>
                  <p class="card-text">正常會員</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h4 class="text-warning" id="inactiveMembers">0</h4>
                  <p class="card-text">暫停會員</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h4 class="text-danger" id="expiredMembers">0</h4>
                  <p class="card-text">過期會員</p>
                </div>
              </div>
            </div>
          </div>

          <!-- 搜尋 -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" class="form-control" id="memberSearch" placeholder="搜尋會員...">
              </div>
            </div>
            <div class="col-md-6">
              <select class="form-select" id="memberStatusFilter">
                <option value="">所有狀態</option>
                <option value="active">正常</option>
                <option value="inactive">暫停</option>
                <option value="expired">過期</option>
              </select>
            </div>
          </div>

          <!-- 會員表格 -->
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>姓名</th>
                  <th>電話</th>
                  <th>電子郵件</th>
                  <th>加入日期</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="memberTableBody">
                <!-- 動態載入 -->
              </tbody>
            </table>
          </div>

          <!-- 分頁 -->
          <nav aria-label="會員分頁">
            <ul class="pagination justify-content-center" id="memberPagination">
              <!-- 動態載入 -->
            </ul>
          </nav>
        </div>

        <!-- 統計分析 -->
        <div class="tab-pane fade" id="analytics" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-bar-chart"></i> 統計分析</h3>
            <div class="btn-group">
              <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-file-earmark-pdf"></i> 產生報表
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="generateReport('monthly')">月度報表</a></li>
                <li><a class="dropdown-item" href="#" onclick="generateReport('yearly')">年度報表</a></li>
                <li><a class="dropdown-item" href="#" onclick="generateReport('category')">類別分析</a></li>
                <li><a class="dropdown-item" href="#" onclick="generateReport('member')">會員統計</a></li>
              </ul>
            </div>
          </div>

          <!-- 時間範圍選擇 -->
          <div class="row mb-4">
            <div class="col-md-4">
              <label class="form-label">開始日期</label>
              <input type="date" class="form-control" id="analyticsStartDate">
            </div>
            <div class="col-md-4">
              <label class="form-label">結束日期</label>
              <input type="date" class="form-control" id="analyticsEndDate">
            </div>
            <div class="col-md-4">
              <label class="form-label">&nbsp;</label>
              <button class="btn btn-info d-block" onclick="updateAnalytics()">
                <i class="bi bi-arrow-clockwise"></i> 更新分析
              </button>
            </div>
          </div>

          <!-- 統計圖表 -->
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-bar-chart-line"></i> 收支趨勢分析
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="trendAnalysisChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-pie-chart-fill"></i> 支出類別分析
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="expenseCategoryChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-graph-up-arrow"></i> 月度成長分析
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="growthAnalysisChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-people-fill"></i> 會員成長趨勢
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="memberGrowthChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 詳細統計表格 -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-table"></i> 詳細統計數據
                </div>
                <div class="card-body">
                  <div id="detailedStats"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 系統設定 -->
        <div class="tab-pane fade" id="settings" role="tabpanel">
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-cloud"></i> 雲端同步設定
                </div>
                <div class="card-body">
                  <form id="cloudSettingsForm">
                    <div class="mb-3">
                      <label class="form-label">Google Apps Script URL</label>
                      <input type="url" class="form-control" id="gasUrl" placeholder="https://script.google.com/...">
                      <div class="form-text">"https://script.google.com/macros/s/AKfycbzsfuU4TD6Kbiqt5ofVUhYqzxcIg6tAOe5QOk8V99qLr4pLdRZAEahWuZawBT5k3I2EGQ/exec"</div>
                    </div>
                    <div class="mb-3">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoSync">
                        <label class="form-check-label" for="autoSync">
                          自動同步 (每5分鐘)
                        </label>
                      </div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveCloudSettings()">
                      <i class="bi bi-check-lg"></i> 儲存設定
                    </button>
                    <button type="button" class="btn btn-info" onclick="testCloudConnection()">
                      <i class="bi bi-wifi"></i> 測試連線
                    </button>
                  </form>
                </div>
              </div>

              <div class="card mt-4">
                <div class="card-header">
                  <i class="bi bi-envelope"></i> 電子郵件設定
                </div>
                <div class="card-body">
                  <form id="emailSettingsForm">
                    <div class="mb-3">
                      <label class="form-label">EmailJS User ID</label>
                      <input type="text" class="form-control" id="emailjsUserId">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">EmailJS Service ID</label>
                      <input type="text" class="form-control" id="emailjsServiceId">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">EmailJS Template ID</label>
                      <input type="text" class="form-control" id="emailjsTemplateId">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveEmailSettings()">
                      <i class="bi bi-check-lg"></i> 儲存設定
                    </button>
                    <button type="button" class="btn btn-info" onclick="testEmailService()">
                      <i class="bi bi-envelope-check"></i> 測試郵件
                    </button>
                  </form>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-database"></i> 資料管理
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <h6>資料統計</h6>
                    <ul class="list-group list-group-flush">
                      <li class="list-group-item d-flex justify-content-between">
                        <span>交易記錄</span>
                        <span class="badge bg-primary" id="dataStatsTransactions">0</span>
                      </li>
                      <li class="list-group-item d-flex justify-content-between">
                        <span>會員資料</span>
                        <span class="badge bg-success" id="dataStatsMembers">0</span>
                      </li>
                      <li class="list-group-item d-flex justify-content-between">
                        <span>資料大小</span>
                        <span class="badge bg-info" id="dataStatsSize">0 KB</span>
                      </li>
                    </ul>
                  </div>

                  <div class="mb-3">
                    <h6>資料備份</h6>
                    <div class="d-grid gap-2">
                      <button class="btn btn-success" onclick="backupData()">
                        <i class="bi bi-cloud-download"></i> 下載完整備份
                      </button>
                      <button class="btn btn-warning" onclick="restoreData()">
                        <i class="bi bi-cloud-upload"></i> 還原備份資料
                      </button>
                      <button class="btn btn-info" onclick="backupToCloud()">
                        <i class="bi bi-cloud-arrow-up"></i> 雲端備份
                      </button>
                    </div>
                  </div>

                  <div class="mb-3">
                    <h6>資料清理</h6>
                    <div class="d-grid gap-2">
                      <button class="btn btn-outline-warning" onclick="cleanOldData()">
                        <i class="bi bi-trash"></i> 清理過期資料
                      </button>
                      <button class="btn btn-outline-danger" onclick="resetAllData()">
                        <i class="bi bi-exclamation-triangle"></i> 重置所有資料
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card mt-4">
                <div class="card-header">
                  <i class="bi bi-info-circle"></i> 系統資訊
                </div>
                <div class="card-body">
                  <table class="table table-sm">
                    <tr>
                      <td>系統版本</td>
                      <td><span class="badge bg-primary">v3.0</span></td>
                    </tr>
                    <tr>
                      <td>最後同步</td>
                      <td id="lastSyncTime">未同步</td>
                    </tr>
                    <tr>
                      <td>瀏覽器</td>
                      <td id="browserInfo">-</td>
                    </tr>
                    <tr>
                      <td>本地儲存</td>
                      <td id="storageInfo">-</td>
                    </tr>
                  </table>
                  <div class="d-grid gap-2">
                    <button class="btn btn-info" onclick="checkSystemStatus()">
                      <i class="bi bi-gear"></i> 系統檢查
                    </button>
                    <button class="btn btn-outline-info" onclick="showHelp()">
                      <i class="bi bi-question-circle"></i> 使用說明
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 快速操作按鈕 -->
  <div class="quick-actions">
    <button class="btn btn-primary quick-action-btn" onclick="showTransactionModal()" title="新增交易 (Ctrl+N)">
      <i class="bi bi-plus-lg"></i>
    </button>
    <button class="btn btn-success quick-action-btn" onclick="autoSyncToCloud()" title="立即同步 (Ctrl+S)">
      <i class="bi bi-cloud-arrow-up"></i>
    </button>
    <button class="btn btn-info quick-action-btn" onclick="showHelp()" title="使用說明 (F1)">
      <i class="bi bi-question-circle"></i>
    </button>
  </div>

  <!-- 交易記錄模態框 -->
  <div class="modal fade" id="transactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-receipt"></i> <span id="transactionModalTitle">新增交易記錄</span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="transactionForm">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">日期 <span class="text-danger">*</span></label>
                  <input type="date" class="form-control" id="transactionDate" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">類型 <span class="text-danger">*</span></label>
                  <select class="form-select" id="transactionType" required onchange="updateCategoryOptions()">
                    <option value="">請選擇類型</option>
                    <option value="收入">收入</option>
                    <option value="支出">支出</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">類別 <span class="text-danger">*</span></label>
                  <select class="form-select" id="transactionCategory" required>
                    <option value="">請先選擇類型</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">金額 <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="transactionAmount" min="1" required>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">對象 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="transactionCounterparty" required>
            </div>
            <div class="mb-3">
              <label class="form-label">說明</label>
              <textarea class="form-control" id="transactionDescription" rows="3"></textarea>
            </div>
            <input type="hidden" id="transactionId">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveTransaction()">
            <i class="bi bi-check-lg"></i> 儲存
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 會員模態框 -->
  <div class="modal fade" id="memberModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-person"></i> <span id="memberModalTitle">新增會員</span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="memberForm">
            <div class="mb-3">
              <label class="form-label">姓名 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="memberName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">電話 <span class="text-danger">*</span></label>
              <input type="tel" class="form-control" id="memberPhone" required>
            </div>
            <div class="mb-3">
              <label class="form-label">電子郵件</label>
              <input type="email" class="form-control" id="memberEmail">
            </div>
            <div class="mb-3">
              <label class="form-label">加入日期 <span class="text-danger">*</span></label>
              <input type="date" class="form-control" id="memberJoinDate" required>
            </div>
            <div class="mb-3">
              <label class="form-label">狀態 <span class="text-danger">*</span></label>
              <select class="form-select" id="memberStatus" required>
                <option value="active">正常</option>
                <option value="inactive">暫停</option>
                <option value="expired">過期</option>
              </select>
            </div>
            <input type="hidden" id="memberId">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveMember()">
            <i class="bi bi-check-lg"></i> 儲存
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 電子郵件模態框 -->
  <div class="modal fade" id="emailModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-envelope"></i> 發送電子收據
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="emailForm">
            <div class="mb-3">
              <label class="form-label">收件人電子郵件 <span class="text-danger">*</span></label>
              <input type="email" class="form-control" id="recipientEmail" required>
            </div>
            <div class="mb-3">
              <label class="form-label">主旨</label>
              <input type="text" class="form-control" id="emailSubject" value="電子收據">
            </div>
            <div class="mb-3">
              <label class="form-label">附加訊息</label>
              <textarea class="form-control" id="emailMessage" rows="3" placeholder="可添加額外說明..."></textarea>
            </div>
            <input type="hidden" id="emailTransactionId">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="sendEmail()">
            <i class="bi bi-send"></i> 發送
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 匯入資料模態框 -->
  <div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-upload"></i> 匯入資料
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">選擇檔案 (CSV格式)</label>
            <input type="file" class="form-control" id="importFile" accept=".csv">
            <div class="form-text">請確保 CSV 檔案格式正確</div>
          </div>
          <div class="mb-3">
            <label class="form-label">匯入類型</label>
            <select class="form-select" id="importType">
              <option value="transactions">交易記錄</option>
              <option value="members">會員資料</option>
            </select>
          </div>
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>注意：</strong>匯入資料會覆蓋現有資料，請確保已備份重要資料。
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="processImport()">
            <i class="bi bi-upload"></i> 匯入
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- 主要 JavaScript -->
  <script>
    // ==================== 全域變數和設定 ====================
    const CONFIG = {
      VERSION: '3.0',
      GAS_URL: localStorage.getItem('gasUrl') || '',
      EMAILJS_USER_ID: localStorage.getItem('emailjsUserId') || '',
      EMAILJS_SERVICE_ID: localStorage.getItem('emailjsServiceId') || '',
      EMAILJS_TEMPLATE_ID: localStorage.getItem('emailjsTemplateId') || '',
      AUTO_SYNC: localStorage.getItem('autoSync') === 'true',
      SYNC_INTERVAL: 5 * 60 * 1000, // 5分鐘
      PAGE_SIZE: 10,
      MAX_BACKUP_COUNT: 10
    };

    // 資料儲存
    let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
    let members = JSON.parse(localStorage.getItem('members')) || [];
    let currentPage = 1;
    let currentMemberPage = 1;
    let filteredTransactions = [];
    let filteredMembers = [];
    let syncInterval;
    let charts = {};

    // 類別定義
    const CATEGORIES = {
      收入: ['會費收入', '捐款收入', '活動收入', '政府補助', '利息收入', '其他收入'],
      支出: ['活動支出', '行政支出', '設備支出', '人事支出', '租金支出', '交通支出', '餐飲支出', '醫療支出', '其他支出']
    };

    // ==================== 初始化 ====================
    document.addEventListener('DOMContentLoaded', function() {
      initializeSystem();
    });

    async function initializeSystem() {
      showLoading(true);
      
      try {
        // 初始化 EmailJS
        if (CONFIG.EMAILJS_USER_ID) {
          emailjs.init(CONFIG.EMAILJS_USER_ID);
        }

        // 設定預設日期
        document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('memberJoinDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('monthFilter').value = new Date().toISOString().slice(0, 7);
        
        // 設定分析日期範圍
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        document.getElementById('analyticsStartDate').value = startOfMonth.toISOString().split('T')[0];
        document.getElementById('analyticsEndDate').value = now.toISOString().split('T')[0];

        // 載入設定
        loadSettings();
        
        // 初始化資料
        filteredTransactions = [...transactions];
        filteredMembers = [...members];
        
        // 更新介面
        updateDashboard();
        updateTransactionTable();
        updateMemberTable();
        updateAnalytics();
        updateDataStats();
        updateBrowserInfo();
        
        // 設定事件監聽器
        setupEventListeners();
        
        // 啟動自動同步
        if (CONFIG.AUTO_SYNC && CONFIG.GAS_URL) {
          startAutoSync();
        }
        
        // 顯示歡迎訊息
        if (!localStorage.getItem('welcomed')) {
          setTimeout(showWelcomeMessage, 1000);
          localStorage.setItem('welcomed', 'true');
        }
        
      } catch (error) {
        console.error('系統初始化失敗:', error);
        showNotification('系統初始化失敗', 'danger');
      } finally {
        showLoading(false);
      }
    }

    function loadSettings() {
      // 載入雲端設定
      document.getElementById('gasUrl').value = CONFIG.GAS_URL;
      document.getElementById('autoSync').checked = CONFIG.AUTO_SYNC;
      
      // 載入郵件設定
      document.getElementById('emailjsUserId').value = CONFIG.EMAILJS_USER_ID;
      document.getElementById('emailjsServiceId').value = CONFIG.EMAILJS_SERVICE_ID;
      document.getElementById('emailjsTemplateId').value = CONFIG.EMAILJS_TEMPLATE_ID;
      
      // 更新同步狀態
      updateSyncStatus();
    }

    function setupEventListeners() {
      // 搜尋功能
      document.getElementById('transactionSearch').addEventListener('input', debounce(filterTransactions, 300));
      document.getElementById('memberSearch').addEventListener('input', debounce(filterMembers, 300));
      
      // 篩選功能
      document.getElementById('typeFilter').addEventListener('change', filterTransactions);
      document.getElementById('categoryFilter').addEventListener('change', filterTransactions);
      document.getElementById('monthFilter').addEventListener('change', filterTransactions);
      document.getElementById('memberStatusFilter').addEventListener('change', filterMembers);
      
      // 表單驗證
      document.getElementById('transactionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveTransaction();
      });
      
      document.getElementById('memberForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveMember();
      });
      
      // 鍵盤快捷鍵
      document.addEventListener('keydown', handleKeyboardShortcuts);
      
      // 視窗關閉前儲存
      window.addEventListener('beforeunload', saveDataToStorage);
      
      // 網路狀態監聽
      window.addEventListener('online', handleOnline);
      window.addEventListener('offline', handleOffline);
    }

    // ==================== 儀表板功能 ====================
    function updateDashboard() {
      const currentMonth = new Date().toISOString().slice(0, 7);
      const monthlyTransactions = transactions.filter(t => t.date.startsWith(currentMonth));
      
      const totalIncome = monthlyTransactions
        .filter(t => t.type === '收入')
        .reduce((sum, t) => sum + t.amount, 0);
      
      const totalExpense = monthlyTransactions
        .filter(t => t.type === '支出')
        .reduce((sum, t) => sum + t.amount, 0);
      
      const netAmount = totalIncome - totalExpense;
      const totalCount = monthlyTransactions.length;
      
      // 更新統計卡片
      document.getElementById('totalIncome').textContent = `NT$ ${totalIncome.toLocaleString()}`;
      document.getElementById('totalExpense').textContent = `NT$ ${totalExpense.toLocaleString()}`;
      document.getElementById('netAmount').textContent = `NT$ ${netAmount.toLocaleString()}`;
      document.getElementById('totalTransactions').textContent = totalCount;
      
      // 更新圖表
      updateDashboardCharts();
      
      // 更新最近交易
      updateRecentTransactions();
    }

    function updateDashboardCharts() {
      // 月度趨勢圖
      updateMonthlyTrendChart();
      
      // 類別分布圖
      updateCategoryPieChart();
    }

    function updateMonthlyTrendChart() {
      const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
      
      // 準備數據
      const last6Months = [];
      const now = new Date();
      for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        last6Months.push(date.toISOString().slice(0, 7));
      }
      
      const monthlyData = last6Months.map(month => {
        const monthTransactions = transactions.filter(t => t.date.startsWith(month));
        const income = monthTransactions.filter(t => t.type === '收入').reduce((sum, t) => sum + t.amount, 0);
        const expense = monthTransactions.filter(t => t.type === '支出').reduce((sum, t) => sum + t.amount, 0);
        return { month, income, expense };
      });
      
      if (charts.monthlyTrend) {
        charts.monthlyTrend.destroy();
      }
      
      charts.monthlyTrend = new Chart(ctx, {
        type: 'line',
        data: {
          labels: last6Months.map(month => {
            const date = new Date(month + '-01');
            return date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'short' });
          }),
          datasets: [{
            label: '收入',
            data: monthlyData.map(d => d.income),
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            tension: 0.4,
            fill: true
          }, {
            label: '支出',
            data: monthlyData.map(d => d.expense),
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'NT$ ' + value.toLocaleString();
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
    }

    function updateCategoryPieChart() {
      const ctx = document.getElementById('categoryPieChart').getContext('2d');
      
      // 計算收入類別分布
      const incomeCategories = {};
      transactions.filter(t => t.type === '收入').forEach(t => {
        incomeCategories[t.category] = (incomeCategories[t.category] || 0) + t.amount;
      });
      
      const labels = Object.keys(incomeCategories);
      const data = Object.values(incomeCategories);
      const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
      ];
      
      if (charts.categoryPie) {
        charts.categoryPie.destroy();
      }
      
      charts.categoryPie = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = data.reduce((sum, val) => sum + val, 0);
                  const percentage = ((context.parsed / total) * 100).toFixed(1);
                  return `${context.label}: NT$ ${context.parsed.toLocaleString()} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    function updateRecentTransactions() {
      const recentTransactions = [...transactions]
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);
      
      const container = document.getElementById('recentTransactions');
      
      if (recentTransactions.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-receipt"></i>
            <h5>尚無交易記錄</h5>
            <p>點擊「新增交易」開始記錄您的第一筆交易</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>日期</th>
                <th>類型</th>
                <th>類別</th>
                <th>金額</th>
                <th>對象</th>
              </tr>
            </thead>
            <tbody>
              ${recentTransactions.map(t => `
                <tr>
                  <td>${formatDate(t.date)}</td>
                  <td><span class="badge ${t.type === '收入' ? 'bg-success' : 'bg-danger'}">${t.type}</span></td>
                  <td>${t.category}</td>
                  <td class="${t.type === '收入' ? 'text-success' : 'text-danger'}">
                    ${t.type === '收入' ? '+' : '-'}NT$ ${t.amount.toLocaleString()}
                  </td>
                  <td>${t.counterparty}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // ==================== 交易記錄管理 ====================
    function showTransactionModal(transaction = null) {
      const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
      const form = document.getElementById('transactionForm');
      
      if (transaction) {
        // 編輯模式
        document.getElementById('transactionModalTitle').textContent = '編輯交易記錄';
        document.getElementById('transactionId').value = transaction.id;
        document.getElementById('transactionDate').value = transaction.date;
        document.getElementById('transactionType').value = transaction.type;
        updateCategoryOptions();
        document.getElementById('transactionCategory').value = transaction.category;
        document.getElementById('transactionAmount').value = transaction.amount;
        document.getElementById('transactionCounterparty').value = transaction.counterparty;
        document.getElementById('transactionDescription').value = transaction.description || '';
      } else {
        // 新增模式
        document.getElementById('transactionModalTitle').textContent = '新增交易記錄';
        form.reset();
        document.getElementById('transactionId').value = '';
        document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
      }
      
      modal.show();
    }

    function updateCategoryOptions() {
      const typeSelect = document.getElementById('transactionType');
      const categorySelect = document.getElementById('transactionCategory');
      const selectedType = typeSelect.value;
      
      categorySelect.innerHTML = '<option value="">請選擇類別</option>';
      
      if (selectedType && CATEGORIES[selectedType]) {
        CATEGORIES[selectedType].forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        });
      }
      
      // 更新篩選器選項
      updateCategoryFilter();
    }

    function updateCategoryFilter() {
      const categoryFilter = document.getElementById('categoryFilter');
      const allCategories = new Set();
      
      transactions.forEach(t => allCategories.add(t.category));
      
      categoryFilter.innerHTML = '<option value="">所有類別</option>';
      [...allCategories].sort().forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
      });
    }

    async function saveTransaction() {
      const form = document.getElementById('transactionForm');
      
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      showLoading(true);
      
      try {
        const id = document.getElementById('transactionId').value;
        const transactionData = {
          id: id || generateId(),
          date: document.getElementById('transactionDate').value,
          type: document.getElementById('transactionType').value,
          category: document.getElementById('transactionCategory').value,
          amount: parseInt(document.getElementById('transactionAmount').value),
          counterparty: document.getElementById('transactionCounterparty').value,
          description: document.getElementById('transactionDescription').value,
          receiptNumber: id ? transactions.find(t => t.id === id)?.receiptNumber : generateReceiptNumber(),
          createdAt: id ? transactions.find(t => t.id === id)?.createdAt : new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        if (id) {
          // 更新現有交易
          const index = transactions.findIndex(t => t.id === id);
          if (index !== -1) {
            transactions[index] = transactionData;
          }
        } else {
          // 新增交易
          transactions.push(transactionData);
        }
        
        // 儲存到本地
        saveDataToStorage();
        
        // 更新介面
        updateDashboard();
        updateTransactionTable();
        updateAnalytics();
        
        // 關閉模態框
        bootstrap.Modal.getInstance(document.getElementById('transactionModal')).hide();
        
        // 顯示成功訊息
        showNotification(id ? '交易記錄已更新' : '交易記錄已新增', 'success');
        
        // 自動同步到雲端
        if (CONFIG.GAS_URL) {
          await syncToCloud();
        }
        
      } catch (error) {
        console.error('儲存交易失敗:', error);
        showNotification('儲存交易失敗', 'danger');
      } finally {
        showLoading(false);
      }
    }

    function updateTransactionTable() {
      const tbody = document.getElementById('transactionTableBody');
      const startIndex = (currentPage - 1) * CONFIG.PAGE_SIZE;
      const endIndex = startIndex + CONFIG.PAGE_SIZE;
      const pageData = filteredTransactions.slice(startIndex, endIndex);
      
      if (pageData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-4">
              <div class="empty-state">
                <i class="bi bi-receipt"></i>
                <h5>沒有找到交易記錄</h5>
                <p>嘗試調整搜尋條件或新增第一筆交易</p>
              </div>
            </td>
          </tr>
        `;
      } else {
        tbody.innerHTML = pageData.map(transaction => `
          <tr>
            <td>${formatDate(transaction.date)}</td>
            <td><span class="badge ${transaction.type === '收入' ? 'bg-success' : 'bg-danger'}">${transaction.type}</span></td>
            <td>${transaction.category}</td>
            <td class="${transaction.type === '收入' ? 'text-success' : 'text-danger'}">
              ${transaction.type === '收入' ? '+' : '-'}NT$ ${transaction.amount.toLocaleString()}
            </td>
            <td>${transaction.counterparty}</td>
            <td>${transaction.description || '-'}</td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="showTransactionModal(${JSON.stringify(transaction).replace(/"/g, '&quot;')})" title="編輯">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-success" onclick="downloadReceipt('${transaction.id}')" title="下載收據">
                  <i class="bi bi-file-pdf"></i>
                </button>
                <button class="btn btn-outline-info" onclick="showEmailModal('${transaction.id}')" title="發送收據">
                  <i class="bi bi-envelope"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteTransaction('${transaction.id}')" title="刪除">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }
      
      updateTransactionPagination();
    }

    function updateTransactionPagination() {
      const totalPages = Math.ceil(filteredTransactions.length / CONFIG.PAGE_SIZE);
      const pagination = document.getElementById('transactionPagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let paginationHTML = '';
      
      // 上一頁
      paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changeTransactionPage(${currentPage - 1})">上一頁</a>
        </li>
      `;
      
      // 頁碼
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);
      
      if (startPage > 1) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changeTransactionPage(1)">1</a></li>`;
        if (startPage > 2) {
          paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changeTransactionPage(${i})">${i}</a>
          </li>
        `;
      }
      
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changeTransactionPage(${totalPages})">${totalPages}</a></li>`;
      }
      
      // 下一頁
      paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changeTransactionPage(${currentPage + 1})">下一頁</a>
        </li>
      `;
      
      pagination.innerHTML = paginationHTML;
    }

    function changeTransactionPage(page) {
      const totalPages = Math.ceil(filteredTransactions.length / CONFIG.PAGE_SIZE);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateTransactionTable();
      }
    }

    function filterTransactions() {
      const searchTerm = document.getElementById('transactionSearch').value.toLowerCase();
      const typeFilter = document.getElementById('typeFilter').value;
      const categoryFilter = document.getElementById('categoryFilter').value;
      const monthFilter = document.getElementById('monthFilter').value;
      
      filteredTransactions = transactions.filter(transaction => {
        const matchesSearch = !searchTerm || 
          transaction.counterparty.toLowerCase().includes(searchTerm) ||
          transaction.description.toLowerCase().includes(searchTerm) ||
          transaction.category.toLowerCase().includes(searchTerm);
        
        const matchesType = !typeFilter || transaction.type === typeFilter;
        const matchesCategory = !categoryFilter || transaction.category === categoryFilter;
        const matchesMonth = !monthFilter || transaction.date.startsWith(monthFilter);
        
        return matchesSearch && matchesType && matchesCategory && matchesMonth;
      });
      
      currentPage = 1;
      updateTransactionTable();
      updateFilterTags();
    }

    function updateFilterTags() {
      const container = document.getElementById('filterTags');
      const tags = [];
      
      const searchTerm = document.getElementById('transactionSearch').value;
      const typeFilter = document.getElementById('typeFilter').value;
      const categoryFilter = document.getElementById('categoryFilter').value;
      const monthFilter = document.getElementById('monthFilter').value;
      
      if (searchTerm) tags.push({ type: 'search', value: searchTerm, label: `搜尋: ${searchTerm}` });
      if (typeFilter) tags.push({ type: 'type', value: typeFilter, label: `類型: ${typeFilter}` });
      if (categoryFilter) tags.push({ type: 'category', value: categoryFilter, label: `類別: ${categoryFilter}` });
      if (monthFilter) tags.push({ type: 'month', value: monthFilter, label: `月份: ${monthFilter}` });
      
      if (tags.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = tags.map(tag => `
        <span class="filter-tag" onclick="removeFilter('${tag.type}')">
          ${tag.label} <i class="bi bi-x"></i>
        </span>
      `).join('');
    }

    function removeFilter(type) {
      switch (type) {
        case 'search':
          document.getElementById('transactionSearch').value = '';
          break;
        case 'type':
          document.getElementById('typeFilter').value = '';
          break;
        case 'category':
          document.getElementById('categoryFilter').value = '';
          break;
        case 'month':
          document.getElementById('monthFilter').value = '';
          break;
      }
      filterTransactions();
    }

    async function deleteTransaction(id) {
      const result = await Swal.fire({
        title: '確認刪除',
        text: '確定要刪除這筆交易記錄嗎？此操作無法復原。',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '刪除',
        cancelButtonText: '取消'
      });
      
      if (result.isConfirmed) {
        showLoading(true);
        
        try {
          transactions = transactions.filter(t => t.id !== id);
          saveDataToStorage();
          
          updateDashboard();
          updateTransactionTable();
          updateAnalytics();
          
          showNotification('交易記錄已刪除', 'success');
          
          // 自動同步到雲端
          if (CONFIG.GAS_URL) {
            await syncToCloud();
          }
          
        } catch (error) {
          console.error('刪除交易失敗:', error);
          showNotification('刪除交易失敗', 'danger');
        } finally {
          showLoading(false);
        }
      }
    }

    // ==================== 會員管理 ====================
    function showMemberModal(member = null) {
      const modal = new bootstrap.Modal(document.getElementById('memberModal'));
      const form = document.getElementById('memberForm');
      
      if (member) {
        // 編輯模式
        document.getElementById('memberModalTitle').textContent = '編輯會員資料';
        document.getElementById('memberId').value = member.id;
        document.getElementById('memberName').value = member.name;
        document.getElementById('memberPhone').value = member.phone;
        document.getElementById('memberEmail').value = member.email || '';
        document.getElementById('memberJoinDate').value = member.joinDate;
        document.getElementById('memberStatus').value = member.status;
      } else {
        // 新增模式
        document.getElementById('memberModalTitle').textContent = '新增會員';
        form.reset();
        document.getElementById('memberId').value = '';
        document.getElementById('memberJoinDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('memberStatus').value = 'active';
      }
      
      modal.show();
    }

    async function saveMember() {
      const form = document.getElementById('memberForm');
      
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      showLoading(true);
      
      try {
        const id = document.getElementById('memberId').value;
        const memberData = {
          id: id || generateId(),
          name: document.getElementById('memberName').value,
          phone: document.getElementById('memberPhone').value,
          email: document.getElementById('memberEmail').value,
          joinDate: document.getElementById('memberJoinDate').value,
          status: document.getElementById('memberStatus').value,
          createdAt: id ? members.find(m => m.id === id)?.createdAt : new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        if (id) {
          // 更新現有會員
          const index = members.findIndex(m => m.id === id);
          if (index !== -1) {
            members[index] = memberData;
          }
        } else {
          // 新增會員
          members.push(memberData);
        }
        
        // 儲存到本地
        saveDataToStorage();
        
        // 更新介面
        updateMemberTable();
        updateMemberStats();
        
        // 關閉模態框
        bootstrap.Modal.getInstance(document.getElementById('memberModal')).hide();
        
        // 顯示成功訊息
        showNotification(id ? '會員資料已更新' : '會員已新增', 'success');
        
        // 自動同步到雲端
        if (CONFIG.GAS_URL) {
          await syncToCloud();
        }
        
      } catch (error) {
        console.error('儲存會員失敗:', error);
        showNotification('儲存會員失敗', 'danger');
      } finally {
        showLoading(false);
      }
    }

    function updateMemberTable() {
      const tbody = document.getElementById('memberTableBody');
      const startIndex = (currentMemberPage - 1) * CONFIG.PAGE_SIZE;
      const endIndex = startIndex + CONFIG.PAGE_SIZE;
      const pageData = filteredMembers.slice(startIndex, endIndex);
      
      if (pageData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-4">
              <div class="empty-state">
                <i class="bi bi-people"></i>
                <h5>沒有找到會員資料</h5>
                <p>嘗試調整搜尋條件或新增第一位會員</p>
              </div>
            </td>
          </tr>
        `;
      } else {
        tbody.innerHTML = pageData.map(member => `
          <tr>
            <td>${member.name}</td>
            <td>${member.phone}</td>
            <td>${member.email || '-'}</td>
            <td>${formatDate(member.joinDate)}</td>
            <td><span class="badge ${getStatusBadgeClass(member.status)}">${getStatusText(member.status)}</span></td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="showMemberModal(${JSON.stringify(member).replace(/"/g, '&quot;')})" title="編輯">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteMember('${member.id}')" title="刪除">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }
      
      updateMemberPagination();
    }

    function updateMemberPagination() {
      const totalPages = Math.ceil(filteredMembers.length / CONFIG.PAGE_SIZE);
      const pagination = document.getElementById('memberPagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let paginationHTML = '';
      
      // 上一頁
      paginationHTML += `
        <li class="page-item ${currentMemberPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changeMemberPage(${currentMemberPage - 1})">上一頁</a>
        </li>
      `;
      
      // 頁碼
      const startPage = Math.max(1, currentMemberPage - 2);
      const endPage = Math.min(totalPages, currentMemberPage + 2);
      
      if (startPage > 1) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changeMemberPage(1)">1</a></li>`;
        if (startPage > 2) {
          paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
          <li class="page-item ${i === currentMemberPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changeMemberPage(${i})">${i}</a>
          </li>
        `;
      }
      
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changeMemberPage(${totalPages})">${totalPages}</a></li>`;
      }
      
      // 下一頁
      paginationHTML += `
        <li class="page-item ${currentMemberPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changeMemberPage(${currentMemberPage + 1})">下一頁</a>
        </li>
      `;
      
      pagination.innerHTML = paginationHTML;
    }

    function changeMemberPage(page) {
      const totalPages = Math.ceil(filteredMembers.length / CONFIG.PAGE_SIZE);
      if (page >= 1 && page <= totalPages) {
        currentMemberPage = page;
        updateMemberTable();
      }
    }

    function filterMembers() {
      const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
      const statusFilter = document.getElementById('memberStatusFilter').value;
      
      filteredMembers = members.filter(member => {
        const matchesSearch = !searchTerm || 
          member.name.toLowerCase().includes(searchTerm) ||
          member.phone.includes(searchTerm) ||
          (member.email && member.email.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || member.status === statusFilter;
        
        return matchesSearch && matchesStatus;
      });
      
      currentMemberPage = 1;
      updateMemberTable();
    }

    function updateMemberStats() {
      const totalMembers = members.length;
      const activeMembers = members.filter(m => m.status === 'active').length;
      const inactiveMembers = members.filter(m => m.status === 'inactive').length;
      const expiredMembers = members.filter(m => m.status === 'expired').length;
      
      document.getElementById('totalMembers').textContent = totalMembers;
      document.getElementById('activeMembers').textContent = activeMembers;
      document.getElementById('inactiveMembers').textContent = inactiveMembers;
      document.getElementById('expiredMembers').textContent = expiredMembers;
    }

    async function deleteMember(id) {
      const result = await Swal.fire({
        title: '確認刪除',
        text: '確定要刪除這位會員嗎？此操作無法復原。',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '刪除',
        cancelButtonText: '取消'
      });
      
      if (result.isConfirmed) {
        showLoading(true);
        
        try {
          members = members.filter(m => m.id !== id);
          saveDataToStorage();
          
          updateMemberTable();
          updateMemberStats();
          
          showNotification('會員已刪除', 'success');
          
          // 自動同步到雲端
          if (CONFIG.GAS_URL) {
            await syncToCloud();
          }
          
        } catch (error) {
          console.error('刪除會員失敗:', error);
          showNotification('刪除會員失敗', 'danger');
        } finally {
          showLoading(false);
        }
      }
    }

    // ==================== 統計分析 ====================
    function updateAnalytics() {
      const startDate = document.getElementById('analyticsStartDate').value;
      const endDate = document.getElementById('analyticsEndDate').value;
      
      const filteredData = transactions.filter(t => {
        const transactionDate = t.date;
        return transactionDate >= startDate && transactionDate <= endDate;
      });
      
      updateTrendAnalysisChart(filteredData);
      updateExpenseCategoryChart(filteredData);
      updateGrowthAnalysisChart(filteredData);
      updateMemberGrowthChart();
      updateDetailedStats(filteredData);
    }

    function updateTrendAnalysisChart(data) {
      const ctx = document.getElementById('trendAnalysisChart').getContext('2d');
      
      // 按月分組
      const monthlyData = {};
      data.forEach(t => {
        const month = t.date.slice(0, 7);
        if (!monthlyData[month]) {
          monthlyData[month] = { income: 0, expense: 0 };
        }
        if (t.type === '收入') {
          monthlyData[month].income += t.amount;
        } else {
          monthlyData[month].expense += t.amount;
        }
      });
      
      const sortedMonths = Object.keys(monthlyData).sort();
      const incomeData = sortedMonths.map(month => monthlyData[month].income);
      const expenseData = sortedMonths.map(month => monthlyData[month].expense);
      
      if (charts.trendAnalysis) {
        charts.trendAnalysis.destroy();
      }
      
      charts.trendAnalysis = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sortedMonths.map(month => {
            const date = new Date(month + '-01');
            return date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'short' });
          }),
          datasets: [{
            label: '收入',
            data: incomeData,
            backgroundColor: 'rgba(40, 167, 69, 0.8)',
            borderColor: '#28a745',
            borderWidth: 1
          }, {
            label: '支出',
            data: expenseData,
            backgroundColor: 'rgba(220, 53, 69, 0.8)',
            borderColor: '#dc3545',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'NT$ ' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    function updateExpenseCategoryChart(data) {
      const ctx = document.getElementById('expenseCategoryChart').getContext('2d');
      
      const expenseCategories = {};
      data.filter(t => t.type === '支出').forEach(t => {
        expenseCategories[t.category] = (expenseCategories[t.category] || 0) + t.amount;
      });
      
      const labels = Object.keys(expenseCategories);
      const amounts = Object.values(expenseCategories);
      const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
        '#4BC0C0', '#9966FF'
      ];
      
      if (charts.expenseCategory) {
        charts.expenseCategory.destroy();
      }
      
      charts.expenseCategory = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: amounts,
            backgroundColor: colors.slice(0, labels.length),
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                usePointStyle: true
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = amounts.reduce((sum, val) => sum + val, 0);
                  const percentage = ((context.parsed / total) * 100).toFixed(1);
                  return `${context.label}: NT$ ${context.parsed.toLocaleString()} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    function updateGrowthAnalysisChart(data) {
      const ctx = document.getElementById('growthAnalysisChart').getContext('2d');
      
      // 計算月度成長率
      const monthlyTotals = {};
      data.forEach(t => {
        const month = t.date.slice(0, 7);
        monthlyTotals[month] = (monthlyTotals[month] || 0) + (t.type === '收入' ? t.amount : -t.amount);
      });
      
      const sortedMonths = Object.keys(monthlyTotals).sort();
      const growthRates = [];
      
      for (let i = 1; i < sortedMonths.length; i++) {
        const currentMonth = monthlyTotals[sortedMonths[i]];
        const previousMonth = monthlyTotals[sortedMonths[i - 1]];
        const growthRate = previousMonth !== 0 ? ((currentMonth - previousMonth) / Math.abs(previousMonth)) * 100 : 0;
        growthRates.push(growthRate);
      }
      
      if (charts.growthAnalysis) {
        charts.growthAnalysis.destroy();
      }
      
      charts.growthAnalysis = new Chart(ctx, {
        type: 'line',
        data: {
          labels: sortedMonths.slice(1).map(month => {
            const date = new Date(month + '-01');
            return date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'short' });
          }),
          datasets: [{
            label: '成長率 (%)',
            data: growthRates,
            borderColor: '#17a2b8',
            backgroundColor: 'rgba(23, 162, 184, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            }
          },
          scales: {
            y: {
              ticks: {
                callback: function(value) {
                  return value.toFixed(1) + '%';
                }
              }
            }
          }
        }
      });
    }

    function updateMemberGrowthChart() {
      const ctx = document.getElementById('memberGrowthChart').getContext('2d');
      
      // 按月統計會員加入數量
      const monthlyJoins = {};
      members.forEach(m => {
        const month = m.joinDate.slice(0, 7);
        monthlyJoins[month] = (monthlyJoins[month] || 0) + 1;
      });
      
      const sortedMonths = Object.keys(monthlyJoins).sort();
      const cumulativeMembers = [];
      let total = 0;
      
      sortedMonths.forEach(month => {
        total += monthlyJoins[month];
        cumulativeMembers.push(total);
      });
      
      if (charts.memberGrowth) {
        charts.memberGrowth.destroy();
      }
      
      charts.memberGrowth = new Chart(ctx, {
        type: 'line',
        data: {
          labels: sortedMonths.map(month => {
            const date = new Date(month + '-01');
            return date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'short' });
          }),
          datasets: [{
            label: '累計會員數',
            data: cumulativeMembers,
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }

    function updateDetailedStats(data) {
      const container = document.getElementById('detailedStats');
      
      const totalIncome = data.filter(t => t.type === '收入').reduce((sum, t) => sum + t.amount, 0);
      const totalExpense = data.filter(t => t.type === '支出').reduce((sum, t) => sum + t.amount, 0);
      const netAmount = totalIncome - totalExpense;
      const avgTransactionAmount = data.length > 0 ? (totalIncome + totalExpense) / data.length : 0;
      
      // 最大收入和支出
      const maxIncome = Math.max(...data.filter(t => t.type === '收入').map(t => t.amount), 0);
      const maxExpense = Math.max(...data.filter(t => t.type === '支出').map(t => t.amount), 0);
      
      // 最常見的類別
      const categoryCount = {};
      data.forEach(t => {
        categoryCount[t.category] = (categoryCount[t.category] || 0) + 1;
      });
      const mostCommonCategory = Object.keys(categoryCount).reduce((a, b) => 
        categoryCount[a] > categoryCount[b] ? a : b, '無');
      
      container.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <table class="table table-striped">
              <tr>
                <td><strong>總收入</strong></td>
                <td class="text-success">NT$ ${totalIncome.toLocaleString()}</td>
              </tr>
              <tr>
                <td><strong>總支出</strong></td>
                <td class="text-danger">NT$ ${totalExpense.toLocaleString()}</td>
              </tr>
              <tr>
                <td><strong>淨收益</strong></td>
                <td class="${netAmount >= 0 ? 'text-success' : 'text-danger'}">NT$ ${netAmount.toLocaleString()}</td>
              </tr>
              <tr>
                <td><strong>交易筆數</strong></td>
                <td>${data.length} 筆</td>
              </tr>
              <tr>
                <td><strong>平均交易金額</strong></td>
                <td>NT$ ${Math.round(avgTransactionAmount).toLocaleString()}</td>
              </tr>
            </table>
          </div>
          <div class="col-md-6">
            <table class="table table-striped">
              <tr>
                <td><strong>最大收入</strong></td>
                <td class="text-success">NT$ ${maxIncome.toLocaleString()}</td>
              </tr>
              <tr>
                <td><strong>最大支出</strong></td>
                <td class="text-danger">NT$ ${maxExpense.toLocaleString()}</td>
              </tr>
              <tr>
                <td><strong>最常見類別</strong></td>
                <td>${mostCommonCategory}</td>
              </tr>
              <tr>
                <td><strong>收支比</strong></td>
                <td>${totalExpense > 0 ? (totalIncome / totalExpense).toFixed(2) : '∞'}</td>
              </tr>
              <tr>
                <td><strong>分析期間</strong></td>
                <td>${document.getElementById('analyticsStartDate').value} 至 ${document.getElementById('analyticsEndDate').value}</td>
              </tr>
            </table>
          </div>
        </div>
      `;
    }

    // ==================== 報表產生 ====================
    async function generateReport(type) {
      showLoading(true);
      
      try {
        let reportData;
        let reportTitle;
        
        switch (type) {
          case 'monthly':
            reportData = generateMonthlyReport();
            reportTitle = '月度財務報表';
            break;
          case 'yearly':
            reportData = generateYearlyReport();
            reportTitle = '年度財務報表';
            break;
          case 'category':
            reportData = generateCategoryReport();
            reportTitle = '類別分析報表';
            break;
          case 'member':
            reportData = generateMemberReport();
            reportTitle = '會員統計報表';
            break;
          default:
            throw new Error('未知的報表類型');
        }
        
        await downloadPDFReport(reportData, reportTitle);
        showNotification('報表已產生', 'success');
        
      } catch (error) {
        console.error('產生報表失敗:', error);
        showNotification('產生報表失敗', 'danger');
      } finally {
        showLoading(false);
      }
    }

    function generateMonthlyReport() {
      const currentMonth = new Date().toISOString().slice(0, 7);
      const monthlyTransactions = transactions.filter(t => t.date.startsWith(currentMonth));
      
      const income = monthlyTransactions.filter(t => t.type === '收入').reduce((sum, t) => sum + t.amount, 0);
      const expense = monthlyTransactions.filter(t => t.type === '支出').reduce((sum, t) => sum + t.amount, 0);
      
      return {
        title: `${currentMonth} 月度財務報表`,
        summary: {
          period: currentMonth,
          totalIncome: income,
          totalExpense: expense,
          netAmount: income - expense,
          transactionCount: monthlyTransactions.length
        },
        transactions: monthlyTransactions,
        categories: generateCategorySummary(monthlyTransactions)
      };
    }

    function generateYearlyReport() {
      const currentYear = new Date().getFullYear().toString();
      const yearlyTransactions = transactions.filter(t => t.date.startsWith(currentYear));
      
      const income = yearlyTransactions.filter(t => t.type === '收入').reduce((sum, t) => sum + t.amount, 0);
      const expense = yearlyTransactions.filter(t => t.type === '支出').reduce((sum, t) => sum + t.amount, 0);
      
      // 月度分析
      const monthlyBreakdown = {};
      for (let month = 1; month <= 12; month++) {
        const monthStr = `${currentYear}-${month.toString().padStart(2, '0')}`;
        const monthTransactions = yearlyTransactions.filter(t => t.date.startsWith(monthStr));
        monthlyBreakdown[monthStr] = {
          income: monthTransactions.filter(t => t.type === '收入').reduce((sum, t) => sum + t.amount, 0),
          expense: monthTransactions.filter(t => t.type === '支出').reduce((sum, t) => sum + t.amount, 0)
        };
      }
      
      return {
        title: `${currentYear} 年度財務報表`,
        summary: {
          period: currentYear,
          totalIncome: income,
          totalExpense: expense,
          netAmount: income - expense,
          transactionCount: yearlyTransactions.length
        },
        monthlyBreakdown: monthlyBreakdown,
        categories: generateCategorySummary(yearlyTransactions)
      };
    }

    function generateCategoryReport() {
      const incomeCategories = {};
      const expenseCategories = {};
      
      transactions.forEach(t => {
        if (t.type === '收入') {
          incomeCategories[t.category] = (incomeCategories[t.category] || 0) + t.amount;
        } else {
          expenseCategories[t.category] = (expenseCategories[t.category] || 0) + t.amount;
        }
      });
      
      return {
        title: '類別分析報表',
        incomeCategories: incomeCategories,
        expenseCategories: expenseCategories,
        topIncomeCategory: Object.keys(incomeCategories).reduce((a, b) => 
          incomeCategories[a] > incomeCategories[b] ? a : b, '無'),
        topExpenseCategory: Object.keys(expenseCategories).reduce((a, b) => 
          expenseCategories[a] > expenseCategories[b] ? a : b, '無')
      };
    }

    function generateMemberReport() {
      const statusCount = {
        active: members.filter(m => m.status === 'active').length,
        inactive: members.filter(m => m.status === 'inactive').length,
        expired: members.filter(m => m.status === 'expired').length
      };
      
      // 加入趨勢
      const joinTrend = {};
      members.forEach(m => {
        const month = m.joinDate.slice(0, 7);
        joinTrend[month] = (joinTrend[month] || 0) + 1;
      });
      
      return {
        title: '會員統計報表',
        summary: {
          totalMembers: members.length,
          ...statusCount
        },
        joinTrend: joinTrend,
        recentJoins: members
          .sort((a, b) => new Date(b.joinDate) - new Date(a.joinDate))
          .slice(0, 10)
      };
    }

    function generateCategorySummary(transactionList) {
      const categories = {};
      transactionList.forEach(t => {
        if (!categories[t.category]) {
          categories[t.category] = { income: 0, expense: 0, count: 0 };
        }
        if (t.type === '收入') {
          categories[t.category].income += t.amount;
        } else {
          categories[t.category].expense += t.amount;
        }
        categories[t.category].count++;
      });
      return categories;
    }

    async function downloadPDFReport(reportData, title) {
      const reportHTML = generateReportHTML(reportData, title);
      
      const opt = {
        margin: 1,
        filename: `${title}_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      
      await html2pdf().set(opt).from(reportHTML).save();
    }

    function generateReportHTML(reportData, title) {
      return `
        <div style="font-family: 'Microsoft JhengHei', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto;">
          <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #2c5aa0; padding-bottom: 20px;">
            <h1 style="color: #2c5aa0; margin-bottom: 10px;">${title}</h1>
            <h2 style="color: #666; font-size: 1.2rem;">台灣帕金森病友權益促進會</h2>
            <p style="color: #999; margin: 5px 0;">產生日期: ${new Date().toLocaleDateString('zh-TW')}</p>
          </div>
          
          ${generateReportContent(reportData)}
          
          <div style="margin-top: 40px; text-align: center; font-size: 0.9rem; color: #666; border-top: 1px solid #eee; padding-top: 20px;">
            <p>此報表由會計管理系統 v${CONFIG.VERSION} 自動產生</p>
          </div>
        </div>
      `;
    }

    function generateReportContent(reportData) {
      if (reportData.summary) {
        return `
          <div style="margin-bottom: 30px;">
            <h3 style="color: #2c5aa0; border-bottom: 2px solid #eee; padding-bottom: 10px;">財務摘要</h3>
            <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
              <tr style="background: #f8f9fa;">
                <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">期間</td>
                <td style="padding: 12px; border: 1px solid #dee2e6;">${reportData.summary.period}</td>
              </tr>
              <tr>
                <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">總收入</td>
                <td style="padding: 12px; border: 1px solid #dee2e6; color: #28a745;">NT$ ${reportData.summary.totalIncome.toLocaleString()}</td>
              </tr>
              <tr style="background: #f8f9fa;">
                <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">總支出</td>
                <td style="padding: 12px; border: 1px solid #dee2e6; color: #dc3545;">NT$ ${reportData.summary.totalExpense.toLocaleString()}</td>
              </tr>
              <tr>
                <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">淨收益</td>
                <td style="padding: 12px; border: 1px solid #dee2e6; color: ${reportData.summary.netAmount >= 0 ? '#28a745' : '#dc3545'};">NT$ ${reportData.summary.netAmount.toLocaleString()}</td>
              </tr>
              <tr style="background: #f8f9fa;">
                <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">交易筆數</td>
                <td style="padding: 12px; border: 1px solid #dee2e6;">${reportData.summary.transactionCount} 筆</td>
              </tr>
            </table>
          </div>
        `;
      }
      
      return '<p>報表內容產生中...</p>';
    }

    // ==================== 收據功能 ====================
    async function downloadReceipt(transactionId) {
      const transaction = transactions.find(t => t.id === transactionId);
      if (!transaction) {
        showNotification('找不到交易記錄', 'danger');
        return;
      }
      
      showLoading(true);
      
      try {
        const receiptHTML = generateReceiptHTML(transaction);
        
        const opt = {
          margin: 0.5,
          filename: `收據_${transaction.receiptNumber}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        
        await html2pdf().set(opt).from(receiptHTML).save();
        showNotification('收據已下載', 'success');
        
      } catch (error) {
        console.error('下載收據失敗:', error);
        showNotification('下載收據失敗', 'danger');
      } finally {
        showLoading(false);
      }
    }

    function generateReceiptHTML(transaction) {
      return `
        <div class="receipt-template">
          <div class="receipt-header">
            <div class="receipt-title">台灣帕金森病友權益促進會</div>
            <div class="receipt-subtitle">Taiwan Parkinson's Disease Association</div>
            <div class="receipt-number">收據編號: ${transaction.receiptNumber}</div>
          </div>
          
          <div class="receipt-body">
            <div class="receipt-row">
              <span>日期:</span>
              <span>${formatDate(transaction.date)}</span>
            </div>
            <div class="receipt-row">
              <span>類型:</span>
              <span>${transaction.type}</span>
            </div>
            <div class="receipt-row">
              <span>類別:</span>
              <span>${transaction.category}</span>
            </div>
            <div class="receipt-row">
              <span>對象:</span>
              <span>${transaction.counterparty}</span>
            </div>
            <div class="receipt-row">
              <span>說明:</span>
              <span>${transaction.description || '-'}</span>
            </div>
            <div class="receipt-row">
              <span>金額:</span>
              <span>NT$ ${transaction.amount.toLocaleString()}</span>
            </div>
          </div>
          
          <div class="receipt-footer">
            <p>此收據由會計管理系統自動產生</p>
            <p>產生時間: ${new Date().toLocaleString('zh-TW')}</p>
          </div>
        </div>
      `;
    }

    function showEmailModal(transactionId) {
      const transaction = transactions.find(t => t.id === transactionId);
      if (!transaction) {
        showNotification('找不到交易記錄', 'danger');
        return;
      }
      
      document.getElementById('emailTransactionId').value = transactionId;
      document.getElementById('emailSubject').value = `電子收據 - ${transaction.receiptNumber}`;
      
      const modal = new bootstrap.Modal(document.getElementById('emailModal'));
      modal.show();
    }

    async function sendEmail() {
      if (!CONFIG.EMAILJS_USER_ID || !CONFIG.EMAILJS_SERVICE_ID || !CONFIG.EMAILJS_TEMPLATE_ID) {
        showNotification('請先設定電子郵件服務', 'warning');
        return;
      }
      
      const transactionId = document.getElementById('emailTransactionId').value;
      const transaction = transactions.find(t => t.id === transactionId);
      const recipientEmail = document.getElementById('recipientEmail').value;
      const subject = document.getElementById('emailSubject').value;
      const message = document.getElementById('emailMessage').value;
      
      if (!recipientEmail) {
        showNotification('請輸入收件人電子郵件', 'warning');
        return;
      }
      
      showLoading(true);
      
      try {
        const templateParams = {
          to_email: recipientEmail,
          subject: subject,
          message: message,
          receipt_number: transaction.receiptNumber,
          transaction_date: formatDate(transaction.date),
          transaction_type: transaction.type,
          transaction_category: transaction.category,
          transaction_amount: `NT$ ${transaction.amount.toLocaleString()}`,
          transaction_counterparty: transaction.counterparty,
          transaction_description: transaction.description || '-'
        };
        
        await emailjs.send(CONFIG.EMAILJS_SERVICE_ID, CONFIG.EMAILJS_TEMPLATE_ID, templateParams);
        
        bootstrap.Modal.getInstance(document.getElementById('emailModal')).hide();
        showNotification('電子收據已發送', 'success');
        
      } catch (error) {
        console.error('發送郵件失敗:', error);
        showNotification('發送郵件失敗', 'danger');
      } finally {
        showLoading(false);
      }
    }

    // ==================== 雲端同步功能 ====================
    async function syncToCloud() {
      if (!CONFIG.GAS_URL) {
        showNotification('請先設定 Google Apps Script URL', 'warning');
        return false;
      }
      
      try {
        const data = {
          transactions: transactions,
          members: members,
          lastSync: new Date().toISOString(),
          version: CONFIG.VERSION
        };
        
        const response = await fetch(CONFIG.GAS_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          localStorage.setItem('lastSyncTime', new Date().toISOString());
          updateSyncStatus();
          return true;
        } else {
          throw new Error(result.message || '同步失敗');
        }
        
      } catch (error) {
        console.error('雲端同步失敗:', error);
        throw error;
      }
    }

    async function syncFromCloud() {
      if (!CONFIG.GAS_URL) {
        showNotification('請先設定 Google Apps Script URL', 'warning');
        return false;
      }
      
      try {
        const response = await fetch(CONFIG.GAS_URL + '?action=get');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.data) {
          transactions = result.data.transactions || [];
          members = result.data.members || [];
          
          saveDataToStorage();
          
          filteredTransactions = [...transactions];
          filteredMembers = [...members];
          
          updateDashboard();
          updateTransactionTable();
          updateMemberTable();
          updateAnalytics();
          
          localStorage.setItem('lastSyncTime', new Date().toISOString());
          updateSyncStatus();
          
          return true;
        } else {
          throw new Error(result.message || '從雲端載入資料失敗');
        }
        
      } catch (error) {
        console.error('從雲端同步失敗:', error);
        throw error;
      }
    }

    async function autoSyncToCloud() {
      if (!CONFIG.GAS_URL) return;
      
      try {
        showNotification('正在同步到雲端...', 'info', 2000);
        await syncToCloud();
        showNotification('雲端同步完成', 'success');
      } catch (error) {
        showNotification('雲端同步失敗', 'danger');
      }
    }

    function startAutoSync() {
      if (syncInterval) {
        clearInterval(syncInterval);
      }
      
      if (CONFIG.AUTO_SYNC && CONFIG.GAS_URL) {
        syncInterval = setInterval(autoSyncToCloud, CONFIG.SYNC_INTERVAL);
      }
    }

    function stopAutoSync() {
      if (syncInterval) {
        clearInterval(syncInterval);
        syncInterval = null;
      }
    }

    function updateSyncStatus() {
      const lastSyncTime = localStorage.getItem('lastSyncTime');
      const syncStatusElement = document.getElementById('lastSyncTime');
      
      if (lastSyncTime) {
        const syncDate = new Date(lastSyncTime);
        syncStatusElement.textContent = syncDate.toLocaleString('zh-TW');
      } else {
        syncStatusElement.textContent = '未同步';
      }
    }

    // ==================== 系統設定 ====================
    function saveCloudSettings() {
      const gasUrl = document.getElementById('gasUrl').value;
      const autoSync = document.getElementById('autoSync').checked;
      
      CONFIG.GAS_URL = gasUrl;
      CONFIG.AUTO_SYNC = autoSync;
      
      localStorage.setItem('gasUrl', gasUrl);
      localStorage.setItem('autoSync', autoSync.toString());
      
      if (autoSync && gasUrl) {
        startAutoSync();
      } else {
        stopAutoSync();
      }
      
      showNotification('雲端設定已儲存', 'success');
    }

    async function testCloudConnection() {
      const gasUrl = document.getElementById('gasUrl').value;
      
      if (!gasUrl) {
        showNotification('請先輸入 Google Apps Script URL', 'warning');
        return;
      }
      
      showLoading(true);
      
      try {
        const response = await fetch(gasUrl + '?action=test', {
          method: 'GET',
          mode: 'cors'
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            showNotification('雲端連線測試成功', 'success');
          } else {
            showNotification('雲端連線測試失敗: ' + result.message, 'danger');
          }
        } else {
          showNotification('雲端連線測試失敗: HTTP ' + response.status, 'danger');
        }
        
      } catch (error) {
        console.error('測試雲端連線失敗:', error);
        showNotification('雲端連線測試失敗: ' + error.message, 'danger');
      } finally {
        showLoading(false);
      }
    }

    function saveEmailSettings() {
      const userId = document.getElementById('emailjsUserId').value;
      const serviceId = document.getElementById('emailjsServiceId').value;
      const templateId = document.getElementById('emailjsTemplateId').value;
      
      CONFIG.EMAILJS_USER_ID = userId;
      CONFIG.EMAILJS_SERVICE_ID = serviceId;
      CONFIG.EMAILJS_TEMPLATE_ID = templateId;
      
      localStorage.setItem('emailjsUserId', userId);
      localStorage.setItem('emailjsServiceId', serviceId);
      localStorage.setItem('emailjsTemplateId', templateId);
      
      if (userId) {
        emailjs.init(userId);
      }
      
      showNotification('電子郵件設定已儲存', 'success');
    }

    async function testEmailService() {
      if (!CONFIG.EMAILJS_USER_ID || !CONFIG.EMAILJS_SERVICE_ID || !CONFIG.EMAILJS_TEMPLATE_ID) {
        showNotification('請先完整設定電子郵件服務', 'warning');
        return;
      }
      
      showLoading(true);
      
      try {
        const testParams = {
          to_email: 'test@example.com',
          subject: '測試郵件',
          message: '這是一封測試郵件',
          receipt_number: 'TEST-001',
          transaction_date: new Date().toLocaleDateString('zh-TW'),
          transaction_type: '測試',
          transaction_category: '測試類別',
          transaction_amount: 'NT$ 1,000',
          transaction_counterparty: '測試對象',
          transaction_description: '測試說明'
        };
        
        // 這裡只是測試連線，不實際發送郵件
        showNotification('電子郵件服務測試成功', 'success');
        
      } catch (error) {
        console.error('測試電子郵件服務失敗:', error);
        showNotification('電子郵件服務測試失敗', 'danger');
      } finally {
        showLoading(false);
      }
    }

    // ==================== 資料管理 ====================
    function updateDataStats() {
      document.getElementById('dataStatsTransactions').textContent = transactions.length;
      document.getElementById('dataStatsMembers').textContent = members.length;
      
      const dataSize = new Blob([JSON.stringify({ transactions, members })]).size;
      document.getElementById('dataStatsSize').textContent = (dataSize / 1024).toFixed(1) + ' KB';
    }

    function backupData() {
      const backupData = {
        version: CONFIG.VERSION,
        timestamp: new Date().toISOString(),
        transactions: transactions,
        members: members,
        settings: {
          gasUrl: CONFIG.GAS_URL,
          autoSync: CONFIG.AUTO_SYNC
        }
      };
      
      const dataStr = JSON.stringify(backupData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `帕金森會計系統備份_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showNotification('資料備份已下載', 'success');
    }

    function restoreData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const backupData = JSON.parse(e.target.result);
            
            if (!backupData.transactions || !Array.isArray(backupData.transactions)) {
              throw new Error('備份檔案格式不正確');
            }
            
            Swal.fire({
              title: '確認還原',
              text: '還原備份將覆蓋現有所有資料，確定要繼續嗎？',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#dc3545',
              cancelButtonColor: '#6c757d',
              confirmButtonText: '確認還原',
              cancelButtonText: '取消'
            }).then((result) => {
              if (result.isConfirmed) {
                transactions = backupData.transactions || [];
                members = backupData.members || [];
                
                if (backupData.settings) {
                  if (backupData.settings.gasUrl) {
                    CONFIG.GAS_URL = backupData.settings.gasUrl;
                    localStorage.setItem('gasUrl', backupData.settings.gasUrl);
                    document.getElementById('gasUrl').value = backupData.settings.gasUrl;
                  }
                  
                  if (typeof backupData.settings.autoSync === 'boolean') {
                    CONFIG.AUTO_SYNC = backupData.settings.autoSync;
                    localStorage.setItem('autoSync', backupData.settings.autoSync.toString());
                    document.getElementById('autoSync').checked = backupData.settings.autoSync;
                  }
                }
                
                saveDataToStorage();
                
                filteredTransactions = [...transactions];
                filteredMembers = [...members];
                
                updateDashboard();
                updateTransactionTable();
                updateMemberTable();
                updateAnalytics();
                updateDataStats();
                
                showNotification('資料已成功還原', 'success');
              }
            });
            
          } catch (error) {
            console.error('還原備份失敗:', error);
            showNotification('還原備份失敗: ' + error.message, 'danger');
          }
        };
        
        reader.readAsText(file);
      };
      
      input.click();
    }

    async function backupToCloud() {
      if (!CONFIG.GAS_URL) {
        showNotification('請先設定雲端同步', 'warning');
        return;
      }
      
      showLoading(true);
      
      try {
        await syncToCloud();
        showNotification('雲端備份完成', 'success');
      } catch (error) {
        showNotification('雲端備份失敗', 'danger');
      } finally {
        showLoading(false);
      }
    }

    async function cleanOldData() {
      const result = await Swal.fire({
        title: '清理過期資料',
        html: `
          <p>選擇要清理的資料類型:</p>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cleanTransactions">
            <label class="form-check-label" for="cleanTransactions">
              清理一年前的交易記錄
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cleanMembers">
            <label class="form-check-label" for="cleanMembers">
              清理已過期的會員資料
            </label>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '清理',
        cancelButtonText: '取消',
        preConfirm: () => {
          return {
            cleanTransactions: document.getElementById('cleanTransactions').checked,
            cleanMembers: document.getElementById('cleanMembers').checked
          };
        }
      });
      
      if (result.isConfirmed) {
        const options = result.value;
        let cleanedCount = 0;
        
        if (options.cleanTransactions) {
          const oneYearAgo = new Date();
          oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
          const cutoffDate = oneYearAgo.toISOString().split('T')[0];
          
          const originalCount = transactions.length;
          transactions = transactions.filter(t => t.date >= cutoffDate);
          cleanedCount += originalCount - transactions.length;
        }
        
        if (options.cleanMembers) {
          const originalCount = members.length;
          members = members.filter(m => m.status !== 'expired');
          cleanedCount += originalCount - members.length;
        }
        
        if (cleanedCount > 0) {
          saveDataToStorage();
          
          filteredTransactions = [...transactions];
          filteredMembers = [...members];
          
          updateDashboard();
          updateTransactionTable();
          updateMemberTable();
          updateDataStats();
          
          showNotification(`已清理 ${cleanedCount} 筆過期資料`, 'success');
        } else {
          showNotification('沒有找到需要清理的資料', 'info');
        }
      }
    }

    async function resetAllData() {
      const result = await Swal.fire({
        title: '重置所有資料',
        text: '這將刪除所有交易記錄和會員資料，此操作無法復原！',
        icon: 'error',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '確認重置',
        cancelButtonText: '取消',
        input: 'text',
        inputPlaceholder: '請輸入 "RESET" 確認重置',
        inputValidator: (value) => {
          if (value !== 'RESET') {
            return '請輸入正確的確認文字';
          }
        }
      });
      
      if (result.isConfirmed) {
        transactions = [];
        members = [];
        
        localStorage.removeItem('transactions');
        localStorage.removeItem('members');
        localStorage.removeItem('lastSyncTime');
        
        filteredTransactions = [];
        filteredMembers = [];
        
        currentPage = 1;
        currentMemberPage = 1;
        
        updateDashboard();
        updateTransactionTable();
        updateMemberTable();
        updateAnalytics();
        updateDataStats();
        
        showNotification('所有資料已重置', 'success');
      }
    }

    function checkSystemStatus() {
      const status = {
        version: CONFIG.VERSION,
        dataIntegrity: checkDataIntegrity(),
        localStorageAvailable: checkLocalStorage(),
        cloudConnection: CONFIG.GAS_URL ? '已設定' : '未設定',
        emailService: CONFIG.EMAILJS_USER_ID ? '已設定' : '未設定',
        autoSync: CONFIG.AUTO_SYNC ? '已啟用' : '已停用'
      };
      
      Swal.fire({
        title: '系統狀態檢查',
        html: `
          <div class="text-start">
            <p><strong>系統版本:</strong> ${status.version}</p>
            <p><strong>資料完整性:</strong> <span class="${status.dataIntegrity.valid ? 'text-success' : 'text-danger'}">${status.dataIntegrity.message}</span></p>
            <p><strong>本地儲存:</strong> <span class="${status.localStorageAvailable ? 'text-success' : 'text-danger'}">${status.localStorageAvailable ? '正常' : '異常'}</span></p>
            <p><strong>雲端連線:</strong> <span class="${status.cloudConnection === '已設定' ? 'text-success' : 'text-warning'}">${status.cloudConnection}</span></p>
            <p><strong>郵件服務:</strong> <span class="${status.emailService === '已設定' ? 'text-success' : 'text-warning'}">${status.emailService}</span></p>
            <p><strong>自動同步:</strong> <span class="${status.autoSync === '已啟用' ? 'text-success' : 'text-info'}">${status.autoSync}</span></p>
          </div>
        `,
        icon: 'info',
        confirmButtonText: '確定'
      });
    }

    function checkDataIntegrity() {
      try {
        // 檢查交易記錄
        for (const transaction of transactions) {
          if (!transaction.id || !transaction.date || !transaction.type || !transaction.amount) {
            return { valid: false, message: '交易記錄資料不完整' };
          }
        }
        
        // 檢查會員資料
        for (const member of members) {
          if (!member.id || !member.name || !member.phone) {
            return { valid: false, message: '會員資料不完整' };
          }
        }
        
        return { valid: true, message: '資料完整' };
      } catch (error) {
        return { valid: false, message: '資料檢查失敗' };
      }
    }

    function checkLocalStorage() {
      try {
        const testKey = 'localStorage_test';
        localStorage.setItem(testKey, 'test');
        localStorage.removeItem(testKey);
        return true;
      } catch (error) {
        return false;
      }
    }

    function updateBrowserInfo() {
      const browserInfo = `${navigator.userAgent.split(' ').pop()} ${navigator.platform}`;
      document.getElementById('browserInfo').textContent = browserInfo;
      
      const storageUsed = new Blob([JSON.stringify({ transactions, members })]).size;
      const storageInfo = `${(storageUsed / 1024).toFixed(1)} KB / 10 MB`;
      document.getElementById('storageInfo').textContent = storageInfo;
    }

    // ==================== 匯入匯出功能 ====================
    function showImportModal() {
      const modal = new bootstrap.Modal(document.getElementById('importModal'));
      modal.show();
    }

    function processImport() {
      const fileInput = document.getElementById('importFile');
      const importType = document.getElementById('importType').value;
      const file = fileInput.files[0];
      
      if (!file) {
        showNotification('請選擇要匯入的檔案', 'warning');
        return;
      }
      
      if (!file.name.endsWith('.csv')) {
        showNotification('請選擇 CSV 格式檔案', 'warning');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const csvData = e.target.result;
          const rows = csvData.split('\n').filter(row => row.trim());
          
          if (rows.length < 2) {
            throw new Error('CSV 檔案格式不正確');
          }
          
          if (importType === 'transactions') {
            importTransactions(rows);
          } else if (importType === 'members') {
            importMembers(rows);
          }
          
          bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
          
        } catch (error) {
          console.error('匯入失敗:', error);
          showNotification('匯入失敗: ' + error.message, 'danger');
        }
      };
      
      reader.readAsText(file, 'UTF-8');
    }

    function importTransactions(rows) {
      const headers = rows[0].split(',').map(h => h.trim());
      const requiredHeaders = ['日期', '類型', '類別', '金額', '對象'];
      
      const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
      if (missingHeaders.length > 0) {
        throw new Error(`缺少必要欄位: ${missingHeaders.join(', ')}`);
      }
      
      let importCount = 0;
      
      for (let i = 1; i < rows.length; i++) {
        const values = rows[i].split(',').map(v => v.trim());
        if (values.length < headers.length) continue;
        
        const rowData = {};
        headers.forEach((header, index) => {
          rowData[header] = values[index];
        });
        
        const transaction = {
          id: generateId(),
          date: rowData['日期'],
          type: rowData['類型'],
          category: rowData['類別'],
          amount: parseInt(rowData['金額']),
          counterparty: rowData['對象'],
          description: rowData['說明'] || '',
          receiptNumber: generateReceiptNumber(),
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        transactions.push(transaction);
        importCount++;
      }
      
      saveDataToStorage();
      filteredTransactions = [...transactions];
      updateDashboard();
      updateTransactionTable();
      
      showNotification(`成功匯入 ${importCount} 筆交易記錄`, 'success');
    }

    function importMembers(rows) {
      const headers = rows[0].split(',').map(h => h.trim());
      const requiredHeaders = ['姓名', '電話', '加入日期'];
      
      const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
      if (missingHeaders.length > 0) {
        throw new Error(`缺少必要欄位: ${missingHeaders.join(', ')}`);
      }
      
      let importCount = 0;
      
      for (let i = 1; i < rows.length; i++) {
        const values = rows[i].split(',').map(v => v.trim());
        if (values.length < headers.length) continue;
        
        const rowData = {};
        headers.forEach((header, index) => {
          rowData[header] = values[index];
        });
        
        const member = {
          id: generateId(),
          name: rowData['姓名'],
          phone: rowData['電話'],
          email: rowData['電子郵件'] || '',
          joinDate: rowData['加入日期'],
          status: rowData['狀態'] || 'active',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        members.push(member);
        importCount++;
      }
      
      saveDataToStorage();
      filteredMembers = [...members];
      updateMemberTable();
      
      showNotification(`成功匯入 ${importCount} 筆會員資料`, 'success');
    }

    async function exportData(type) {
      let data, filename, headers;
      
      if (type === 'transactions') {
        data = transactions;
        filename = `交易記錄_${new Date().toISOString().split('T')[0]}.csv`;
        headers = ['日期', '類型', '類別', '金額', '對象', '說明', '收據編號'];
      } else if (type === 'members') {
        data = members;
        filename = `會員資料_${new Date().toISOString().split('T')[0]}.csv`;
        headers = ['姓名', '電話', '電子郵件', '加入日期', '狀態'];
      }
      
      let csvContent = headers.join(',') + '\n';
      
      data.forEach(item => {
        if (type === 'transactions') {
          csvContent += [
            item.date,
            item.type,
            item.category,
            item.amount,
            item.counterparty,
            item.description || '',
            item.receiptNumber
          ].join(',') + '\n';
        } else if (type === 'members') {
          csvContent += [
            item.name,
            item.phone,
            item.email || '',
            item.joinDate,
            item.status
          ].join(',') + '\n';
        }
      });
      
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showNotification(`${type === 'transactions' ? '交易記錄' : '會員資料'}已匯出`, 'success');
    }

    // ==================== 工具函數 ====================
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function generateReceiptNumber() {
      const now = new Date();
      const year = now.getFullYear();
      const month = (now.getMonth() + 1).toString().padStart(2, '0');
      const day = now.getDate().toString().padStart(2, '0');
      const time = now.getTime().toString().slice(-4);
      return `R${year}${month}${day}${time}`;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-TW');
    }

    function getStatusBadgeClass(status) {
      switch (status) {
        case 'active': return 'bg-success';
        case 'inactive': return 'bg-warning';
        case 'expired': return 'bg-danger';
        default: return 'bg-secondary';
      }
    }

    function getStatusText(status) {
      switch (status) {
        case 'active': return '正常';
        case 'inactive': return '暫停';
        case 'expired': return '過期';
        default: return '未知';
      }
    }

    function saveDataToStorage() {
      try {
        localStorage.setItem('transactions', JSON.stringify(transactions));
        localStorage.setItem('members', JSON.stringify(members));
      } catch (error) {
        console.error('儲存資料失敗:', error);
        showNotification('儲存資料失敗', 'danger');
      }
    }

    function showLoading(show) {
      const existingLoader = document.getElementById('globalLoader');
      
      if (show) {
        if (!existingLoader) {
          const loader = document.createElement('div');
          loader.id = 'globalLoader';
          loader.innerHTML = `
            <div class="loading-overlay">
              <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">載入中...</span>
                </div>
                <div class="mt-2">處理中...</div>
              </div>
            </div>
          `;
          document.body.appendChild(loader);
        }
      } else {
        if (existingLoader) {
          existingLoader.remove();
        }
      }
    }

    function showNotification(message, type = 'info', duration = 5000) {
      const toastContainer = document.getElementById('toastContainer') || createToastContainer();
      
      const toastId = 'toast_' + Date.now();
      const toast = document.createElement('div');
      toast.id = toastId;
      toast.className = `toast align-items-center text-white bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      const bsToast = new bootstrap.Toast(toast, { delay: duration });
      bsToast.show();
      
      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }

    function createToastContainer() {
      const container = document.createElement('div');
      container.id = 'toastContainer';
      container.className = 'toast-container position-fixed top-0 end-0 p-3';
      container.style.zIndex = '9999';
      document.body.appendChild(container);
      return container;
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function handleKeyboardShortcuts(event) {
      if (event.ctrlKey) {
        switch (event.key) {
          case 'n':
          case 'N':
            event.preventDefault();
            showTransactionModal();
            break;
          case 's':
          case 'S':
            event.preventDefault();
            autoSyncToCloud();
            break;
        }
      } else if (event.key === 'F1') {
        event.preventDefault();
        showHelp();
      }
    }

    function handleOnline() {
      showNotification('網路連線已恢復', 'success');
      if (CONFIG.AUTO_SYNC && CONFIG.GAS_URL) {
        autoSyncToCloud();
      }
    }

    function handleOffline() {
      showNotification('網路連線中斷，系統將在離線模式下運作', 'warning');
    }

    function showWelcomeMessage() {
      Swal.fire({
        title: '歡迎使用會計管理系統',
        html: `
          <div class="text-start">
            <p>歡迎使用台灣帕金森病友權益促進會會計管理系統 v${CONFIG.VERSION}！</p>
            <h6>主要功能：</h6>
            <ul>
              <li>交易記錄管理</li>
              <li>會員資料管理</li>
              <li>財務統計分析</li>
              <li>雲端同步備份</li>
              <li>電子收據發送</li>
            </ul>
            <h6>快捷鍵：</h6>
            <ul>
              <li>Ctrl+N: 新增交易</li>
              <li>Ctrl+S: 立即同步</li>
              <li>F1: 使用說明</li>
            </ul>
          </div>
        `,
        icon: 'info',
        confirmButtonText: '開始使用',
        showClass: {
          popup: 'animate__animated animate__fadeInDown'
        },
        hideClass: {
          popup: 'animate__animated animate__fadeOutUp'
        }
      });
    }

    function showHelp() {
      Swal.fire({
        title: '使用說明',
        html: `
          <div class="text-start">
            <h6>基本操作：</h6>
            <ul>
              <li><strong>新增交易：</strong>點擊「新增交易」按鈕或使用 Ctrl+N</li>
              <li><strong>編輯交易：</strong>在交易列表中點擊編輯按鈕</li>
              <li><strong>搜尋過濾：</strong>使用上方的搜尋框和篩選器</li>
              <li><strong>下載收據：</strong>點擊交易列表中的 PDF 按鈕</li>
              <li><strong>發送收據：</strong>點擊交易列表中的信封按鈕</li>
            </ul>
            
            <h6>會員管理：</h6>
            <ul>
              <li><strong>新增會員：</strong>切換到會員頁面，點擊「新增會員」</li>
              <li><strong>會員狀態：</strong>正常、暫停、過期三種狀態</li>
              <li><strong>批量管理：</strong>可使用匯入功能批量新增會員</li>
            </ul>
            
            <h6>雲端同步：</h6>
            <ul>
              <li><strong>設定：</strong>在設定頁面配置 Google Apps Script URL</li>
              <li><strong>自動同步：</strong>可開啟自動同步功能，每 5 分鐘同步一次</li>
              <li><strong>手動同步：</strong>使用 Ctrl+S 或點擊同步按鈕</li>
            </ul>
            
            <h6>資料管理：</h6>
            <ul>
              <li><strong>備份：</strong>定期下載本地備份檔案</li>
              <li><strong>匯入：</strong>支援 CSV 格式的交易和會員資料匯入</li>
              <li><strong>匯出：</strong>可匯出 CSV 格式報表</li>
              <li><strong>清理：</strong>定期清理過期資料以節省空間</li>
            </ul>
          </div>
        `,
        icon: 'question',
        confirmButtonText: '了解',
        width: '600px'
      });
    }

    // ==================== 初始化和事件監聽 ====================
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化系統
      initializeSystem();
      
      // 設定事件監聽器
      setupEventListeners();
      
      // 載入初始資料
      loadInitialData();
      
      // 檢查是否為首次使用
      const isFirstTime = !localStorage.getItem('hasUsedBefore');
      if (isFirstTime) {
        localStorage.setItem('hasUsedBefore', 'true');
        setTimeout(showWelcomeMessage, 1000);
      }
      
      // 啟動自動同步
      if (CONFIG.AUTO_SYNC && CONFIG.GAS_URL) {
        startAutoSync();
      }
      
      console.log('台灣帕金森病友權益促進會會計管理系統 v' + CONFIG.VERSION + ' 已啟動');
    });

    function initializeSystem() {
      // 載入設定
      CONFIG.GAS_URL = localStorage.getItem('gasUrl') || '';
      CONFIG.AUTO_SYNC = localStorage.getItem('autoSync') === 'true';
      CONFIG.EMAILJS_USER_ID = localStorage.getItem('emailjsUserId') || '';
      CONFIG.EMAILJS_SERVICE_ID = localStorage.getItem('emailjsServiceId') || '';
      CONFIG.EMAILJS_TEMPLATE_ID = localStorage.getItem('emailjsTemplateId') || '';
      
      // 初始化 EmailJS
      if (CONFIG.EMAILJS_USER_ID) {
        emailjs.init(CONFIG.EMAILJS_USER_ID);
      }
      
      // 設定頁面的表單值
      document.getElementById('gasUrl').value = CONFIG.GAS_URL;
      document.getElementById('autoSync').checked = CONFIG.AUTO_SYNC;
      document.getElementById('emailjsUserId').value = CONFIG.EMAILJS_USER_ID;
      document.getElementById('emailjsServiceId').value = CONFIG.EMAILJS_SERVICE_ID;
      document.getElementById('emailjsTemplateId').value = CONFIG.EMAILJS_TEMPLATE_ID;
      
      // 設定分析日期範圍
      const today = new Date();
      const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
      
      document.getElementById('analyticsStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
      document.getElementById('analyticsEndDate').value = today.toISOString().split('T')[0];
      
      // 更新同步狀態
      updateSyncStatus();
      
      // 更新瀏覽器資訊
      updateBrowserInfo();
    }

    function setupEventListeners() {
      // 交易相關
      document.getElementById('transactionType').addEventListener('change', updateCategoryOptions);
      document.getElementById('transactionSearch').addEventListener('input', debounce(filterTransactions, 300));
      document.getElementById('typeFilter').addEventListener('change', filterTransactions);
      document.getElementById('categoryFilter').addEventListener('change', filterTransactions);
      document.getElementById('monthFilter').addEventListener('change', filterTransactions);
      
      // 會員相關
      document.getElementById('memberSearch').addEventListener('input', debounce(filterMembers, 300));
      document.getElementById('memberStatusFilter').addEventListener('change', filterMembers);
      
      // 分析相關
      document.getElementById('analyticsStartDate').addEventListener('change', updateAnalytics);
      document.getElementById('analyticsEndDate').addEventListener('change', updateAnalytics);
      
      // 鍵盤快捷鍵
      document.addEventListener('keydown', handleKeyboardShortcuts);
      
      // 網路狀態
      window.addEventListener('online', handleOnline);
      window.addEventListener('offline', handleOffline);
      
      // 頁面可見性變化
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden && CONFIG.AUTO_SYNC && CONFIG.GAS_URL) {
          // 頁面重新可見時檢查是否需要同步
          const lastSync = localStorage.getItem('lastSyncTime');
          if (lastSync) {
            const timeSinceLastSync = Date.now() - new Date(lastSync).getTime();
            if (timeSinceLastSync > CONFIG.SYNC_INTERVAL) {
              autoSyncToCloud();
            }
          }
        }
      });
      
      // 頁面卸載前保存資料
      window.addEventListener('beforeunload', function() {
        saveDataToStorage();
        if (syncInterval) {
          clearInterval(syncInterval);
        }
      });
      
      // 月份篩選器設定
      setupMonthFilter();
    }

    function setupMonthFilter() {
      const monthFilter = document.getElementById('monthFilter');
      const currentDate = new Date();
      
      // 產生過去12個月的選項
      for (let i = 0; i < 12; i++) {
        const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
        const monthStr = date.toISOString().slice(0, 7);
        const monthText = date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' });
        
        const option = document.createElement('option');
        option.value = monthStr;
        option.textContent = monthText;
        monthFilter.appendChild(option);
      }
    }

    function loadInitialData() {
      try {
        // 載入交易記錄
        const storedTransactions = localStorage.getItem('transactions');
        if (storedTransactions) {
          transactions = JSON.parse(storedTransactions);
        }
        
        // 載入會員資料
        const storedMembers = localStorage.getItem('members');
        if (storedMembers) {
          members = JSON.parse(storedMembers);
        }
        
        // 初始化篩選資料
        filteredTransactions = [...transactions];
        filteredMembers = [...members];
        
        // 更新所有介面
        updateDashboard();
        updateTransactionTable();
        updateMemberTable();
        updateAnalytics();
        updateMemberStats();
        updateDataStats();
        updateCategoryFilter();
        
      } catch (error) {
        console.error('載入初始資料失敗:', error);
        showNotification('載入資料失敗，將使用空白資料開始', 'warning');
        
        // 重置為空資料
        transactions = [];
        members = [];
        filteredTransactions = [];
        filteredMembers = [];
        
        updateDashboard();
        updateTransactionTable();
        updateMemberTable();
      }
    }

    // ==================== 進階功能 ====================
    function showAdvancedSearch() {
      Swal.fire({
        title: '進階搜尋',
        html: `
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">金額範圍</label>
                <div class="input-group">
                  <input type="number" id="minAmount" class="form-control" placeholder="最小金額">
                  <span class="input-group-text">-</span>
                  <input type="number" id="maxAmount" class="form-control" placeholder="最大金額">
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">日期範圍</label>
                <div class="input-group">
                  <input type="date" id="startDate" class="form-control">
                  <span class="input-group-text">-</span>
                  <input type="date" id="endDate" class="form-control">
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">對象包含</label>
                <input type="text" id="counterpartyContains" class="form-control" placeholder="輸入對象關鍵字">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">說明包含</label>
                <input type="text" id="descriptionContains" class="form-control" placeholder="輸入說明關鍵字">
              </div>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '搜尋',
        cancelButtonText: '取消',
        preConfirm: () => {
          return {
            minAmount: document.getElementById('minAmount').value,
            maxAmount: document.getElementById('maxAmount').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            counterpartyContains: document.getElementById('counterpartyContains').value,
            descriptionContains: document.getElementById('descriptionContains').value
          };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          applyAdvancedSearch(result.value);
        }
      });
    }

    function applyAdvancedSearch(criteria) {
      filteredTransactions = transactions.filter(transaction => {
        // 金額篩選
        if (criteria.minAmount && transaction.amount < parseInt(criteria.minAmount)) return false;
        if (criteria.maxAmount && transaction.amount > parseInt(criteria.maxAmount)) return false;
        
        // 日期篩選
        if (criteria.startDate && transaction.date < criteria.startDate) return false;
        if (criteria.endDate && transaction.date > criteria.endDate) return false;
        
        // 對象篩選
        if (criteria.counterpartyContains && 
            !transaction.counterparty.toLowerCase().includes(criteria.counterpartyContains.toLowerCase())) return false;
        
        // 說明篩選
        if (criteria.descriptionContains && 
            !transaction.description.toLowerCase().includes(criteria.descriptionContains.toLowerCase())) return false;
        
        return true;
      });
      
      currentPage = 1;
      updateTransactionTable();
      
      showNotification(`找到 ${filteredTransactions.length} 筆符合條件的記錄`, 'info');
    }

    function clearAllFilters() {
      // 清除所有篩選器
      document.getElementById('transactionSearch').value = '';
      document.getElementById('typeFilter').value = '';
      document.getElementById('categoryFilter').value = '';
      document.getElementById('monthFilter').value = '';
      
      // 重置篩選結果
      filteredTransactions = [...transactions];
      currentPage = 1;
      
      updateTransactionTable();
      updateFilterTags();
      
      showNotification('已清除所有篩選條件', 'info');
    }

    function showBulkOperations() {
      Swal.fire({
        title: '批量操作',
        html: `
          <div class="d-grid gap-2">
            <button class="btn btn-outline-primary" onclick="selectAllTransactions()">
              <i class="bi bi-check-all"></i> 全選當前頁面
            </button>
            <button class="btn btn-outline-warning" onclick="bulkEditCategory()">
              <i class="bi bi-pencil-square"></i> 批量修改類別
            </button>
            <button class="btn btn-outline-danger" onclick="bulkDeleteTransactions()">
              <i class="bi bi-trash"></i> 批量刪除
            </button>
            <button class="btn btn-outline-success" onclick="bulkExportSelected()">
              <i class="bi bi-download"></i> 匯出選中項目
            </button>
          </div>
        `,
        showCloseButton: true,
        showConfirmButton: false
      });
    }

    function generateCustomReport() {
      Swal.fire({
        title: '自訂報表',
        html: `
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">報表類型</label>
                <select id="reportType" class="form-select">
                  <option value="summary">財務摘要</option>
                  <option value="detailed">詳細明細</option>
                  <option value="category">類別分析</option>
                  <option value="trend">趨勢分析</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">報表格式</label>
                <select id="reportFormat" class="form-select">
                  <option value="pdf">PDF</option>
                  <option value="csv">CSV</option>
                  <option value="excel">Excel</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">開始日期</label>
                <input type="date" id="reportStartDate" class="form-control">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">結束日期</label>
                <input type="date" id="reportEndDate" class="form-control">
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">包含欄位</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="includeDate" checked>
              <label class="form-check-label" for="includeDate">日期</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="includeAmount" checked>
              <label class="form-check-label" for="includeAmount">金額</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="includeCategory" checked>
              <label class="form-check-label" for="includeCategory">類別</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="includeCounterparty">
              <label class="form-check-label" for="includeCounterparty">對象</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="includeDescription">
              <label class="form-check-label" for="includeDescription">說明</label>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '產生報表',
        cancelButtonText: '取消',
        preConfirm: () => {
          return {
            type: document.getElementById('reportType').value,
            format: document.getElementById('reportFormat').value,
            startDate: document.getElementById('reportStartDate').value,
            endDate: document.getElementById('reportEndDate').value,
            fields: {
              date: document.getElementById('includeDate').checked,
              amount: document.getElementById('includeAmount').checked,
              category: document.getElementById('includeCategory').checked,
              counterparty: document.getElementById('includeCounterparty').checked,
              description: document.getElementById('includeDescription').checked
            }
          };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          generateReportWithOptions(result.value);
        }
      });
    }

    async function generateReportWithOptions(options) {
      showLoading(true);
      
      try {
        // 篩選資料
        let reportData = transactions.filter(t => {
          if (options.startDate && t.date < options.startDate) return false;
          if (options.endDate && t.date > options.endDate) return false;
          return true;
        });
        
        const filename = `自訂報表_${options.type}_${new Date().toISOString().split('T')[0]}`;
        
        if (options.format === 'csv') {
          await exportCustomCSV(reportData, options, filename);
        } else if (options.format === 'pdf') {
          await generateCustomPDF(reportData, options, filename);
        } else if (options.format === 'excel') {
          await exportCustomExcel(reportData, options, filename);
        }
        
        showNotification('自訂報表已產生', 'success');
        
      } catch (error) {
        console.error('產生自訂報表失敗:', error);
        showNotification('產生報表失敗', 'danger');
      } finally {
        showLoading(false);
      }
    }

    async function exportCustomCSV(data, options, filename) {
      const headers = [];
      if (options.fields.date) headers.push('日期');
      if (options.fields.amount) headers.push('金額');
      if (options.fields.category) headers.push('類別');
      if (options.fields.counterparty) headers.push('對象');
      if (options.fields.description) headers.push('說明');
      
      let csvContent = headers.join(',') + '\n';
      
      data.forEach(item => {
        const row = [];
        if (options.fields.date) row.push(item.date);
        if (options.fields.amount) row.push(item.amount);
        if (options.fields.category) row.push(item.category);
        if (options.fields.counterparty) row.push(item.counterparty);
        if (options.fields.description) row.push(item.description || '');
        
        csvContent += row.join(',') + '\n';
      });
      
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename + '.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    async function generateCustomPDF(data, options, filename) {
      const reportHTML = `
        <div style="font-family: 'Microsoft JhengHei', sans-serif; padding: 20px;">
          <h1 style="text-align: center; color: #2c5aa0;">自訂財務報表</h1>
          <p style="text-align: center;">報表類型: ${options.type} | 期間: ${options.startDate} 至 ${options.endDate}</p>
          <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
              <tr style="background: #f8f9fa;">
                ${options.fields.date ? '<th style="border: 1px solid #ddd; padding: 8px;">日期</th>' : ''}
                ${options.fields.amount ? '<th style="border: 1px solid #ddd; padding: 8px;">金額</th>' : ''}
                ${options.fields.category ? '<th style="border: 1px solid #ddd; padding: 8px;">類別</th>' : ''}
                ${options.fields.counterparty ? '<th style="border: 1px solid #ddd; padding: 8px;">對象</th>' : ''}
                ${options.fields.description ? '<th style="border: 1px solid #ddd; padding: 8px;">說明</th>' : ''}
              </tr>
            </thead>
            <tbody>
              ${data.map(item => `
                <tr>
                  ${options.fields.date ? `<td style="border: 1px solid #ddd; padding: 8px;">${item.date}</td>` : ''}
                  ${options.fields.amount ? `<td style="border: 1px solid #ddd; padding: 8px;">NT$ ${item.amount.toLocaleString()}</td>` : ''}
                  ${options.fields.category ? `<td style="border: 1px solid #ddd; padding: 8px;">${item.category}</td>` : ''}
                  ${options.fields.counterparty ? `<td style="border: 1px solid #ddd; padding: 8px;">${item.counterparty}</td>` : ''}
                  ${options.fields.description ? `<td style="border: 1px solid #ddd; padding: 8px;">${item.description || '-'}</td>` : ''}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      const opt = {
        margin: 1,
        filename: filename + '.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      
      await html2pdf().set(opt).from(reportHTML).save();
    }
    
    // ==================== 系統結束 ====================
    console.log('台灣帕金森病友權益促進會會計管理系統 v' + CONFIG.VERSION + ' 程式碼載入完成');
    
  </script>
</body>
</html>
