<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會 - 會計管理系統 v5.0</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          color: #333;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 20px;
      }

      .header {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-radius: 15px;
          padding: 30px;
          margin-bottom: 30px;
          text-align: center;
          box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
          border: 1px solid rgba(255, 255, 255, 0.18);
      }

      .header h1 {
          color: #2c3e50;
          font-size: 2.5em;
          margin-bottom: 10px;
          font-weight: 700;
      }

      .header p {
          color: #7f8c8d;
          font-size: 1.2em;
          margin-bottom: 20px;
      }

      .version-info {
          display: inline-block;
          background: #3498db;
          color: white;
          padding: 8px 16px;
          border-radius: 20px;
          font-size: 0.9em;
          font-weight: 500;
      }

      .main-content {
          display: grid;
          grid-template-columns: 250px 1fr;
          gap: 30px;
          align-items: start;
      }

      .sidebar {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-radius: 15px;
          padding: 25px;
          box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
          border: 1px solid rgba(255, 255, 255, 0.18);
          position: sticky;
          top: 20px;
      }

      .nav-menu {
          list-style: none;
      }

      .nav-menu li {
          margin-bottom: 10px;
      }

      .nav-menu a {
          display: flex;
          align-items: center;
          padding: 12px 15px;
          color: #2c3e50;
          text-decoration: none;
          border-radius: 10px;
          transition: all 0.3s ease;
          font-weight: 500;
      }

      .nav-menu a:hover,
      .nav-menu a.active {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          transform: translateX(5px);
      }

      .nav-menu i {
          margin-right: 10px;
          width: 20px;
          text-align: center;
      }

      .content-area {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-radius: 15px;
          padding: 30px;
          box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
          border: 1px solid rgba(255, 255, 255, 0.18);
          min-height: 600px;
      }

      .page {
          display: none;
          animation: fadeIn 0.5s ease-in-out;
      }

      .page.active {
          display: block;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .dashboard-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
      }

      .stat-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 25px;
          border-radius: 15px;
          text-align: center;
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
          transition: transform 0.3s ease;
      }

      .stat-card:hover {
          transform: translateY(-5px);
      }

      .stat-card h3 {
          font-size: 2.5em;
          margin-bottom: 10px;
          font-weight: 700;
      }

      .stat-card p {
          font-size: 1.1em;
          opacity: 0.9;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #2c3e50;
      }

      .form-control {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e0e6ed;
          border-radius: 10px;
          font-size: 16px;
          transition: all 0.3s ease;
          background: #f8f9fa;
      }

      .form-control:focus {
          outline: none;
          border-color: #667eea;
          background: white;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
          padding: 12px 25px;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          text-decoration: none;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
      }

      .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
      }

      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }

      .btn-success {
          background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
          color: white;
      }

      .btn-danger {
          background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
          color: white;
      }

      .btn-info {
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
          color: white;
      }

      .table-responsive {
          overflow-x: auto;
          margin-top: 20px;
      }

      .table {
          width: 100%;
          border-collapse: collapse;
          background: white;
          border-radius: 10px;
          overflow: hidden;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .table th,
      .table td {
          padding: 15px;
          text-align: left;
          border-bottom: 1px solid #e0e6ed;
      }

      .table th {
          background: #f8f9fa;
          font-weight: 600;
          color: #2c3e50;
      }

      .table tbody tr:hover {
          background: #f8f9fa;
      }

      .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          backdrop-filter: blur(5px);
      }

      .modal-content {
          background: white;
          margin: 5% auto;
          padding: 30px;
          border-radius: 15px;
          width: 90%;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
          from {
              opacity: 0;
              transform: translateY(-50px) scale(0.9);
          }
          to {
              opacity: 1;
              transform: translateY(0) scale(1);
          }
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 25px;
          padding-bottom: 15px;
          border-bottom: 2px solid #e0e6ed;
      }

      .modal-header h2 {
          color: #2c3e50;
          font-size: 1.5em;
      }

      .close {
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
          color: #aaa;
          transition: color 0.3s ease;
      }

      .close:hover {
          color: #333;
      }

      .alert {
          padding: 15px 20px;
          margin-bottom: 20px;
          border-radius: 10px;
          font-weight: 500;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .alert-danger {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .alert-info {
          background: #cce7ff;
          color: #004085;
          border: 1px solid #b6d7ff;
      }

      .loading {
          display: none;
          text-align: center;
          padding: 20px;
      }

      .spinner {
          border: 4px solid #f3f3f3;
          border-top: 4px solid #667eea;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
          margin: 0 auto 15px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .search-bar {
          display: flex;
          gap: 15px;
          margin-bottom: 20px;
          flex-wrap: wrap;
      }

      .search-bar input,
      .search-bar select {
          flex: 1;
          min-width: 200px;
      }

      .pagination {
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 10px;
          margin-top: 20px;
      }

      .pagination button {
          padding: 8px 12px;
          border: 1px solid #ddd;
          background: white;
          border-radius: 5px;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .pagination button:hover:not(:disabled) {
          background: #667eea;
          color: white;
      }

      .pagination button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
      }

      .pagination .current-page {
          background: #667eea;
          color: white;
      }

      .status-badge {
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 0.85em;
          font-weight: 500;
      }

      .status-normal { background: #d4edda; color: #155724; }
      .status-pending { background: #fff3cd; color: #856404; }
      .status-approved { background: #d1ecf1; color: #0c5460; }
      .status-rejected { background: #f8d7da; color: #721c24; }

      @media (max-width: 768px) {
          .main-content {
              grid-template-columns: 1fr;
              gap: 20px;
          }

          .sidebar {
              position: static;
          }

          .dashboard-grid {
              grid-template-columns: 1fr;
          }

          .search-bar {
              flex-direction: column;
          }

          .search-bar input,
          .search-bar select {
              min-width: auto;
          }
      }

      .receipt-preview {
          background: white;
          border: 2px solid #333;
          padding: 30px;
          margin: 20px 0;
          font-family: 'Microsoft JhengHei', serif;
      }

      .receipt-header {
          text-align: center;
          margin-bottom: 30px;
      }

      .receipt-title {
          font-size: 24px;
          font-weight: bold;
          margin-bottom: 10px;
      }

      .receipt-subtitle {
          font-size: 18px;
          color: #666;
      }

      .receipt-content {
          line-height: 1.8;
      }

      .receipt-row {
          display: flex;
          margin-bottom: 15px;
      }

      .receipt-label {
          width: 120px;
          font-weight: bold;
      }

      .receipt-value {
          flex: 1;
      }

      .receipt-amount {
          font-size: 20px;
          font-weight: bold;
          color: #d32f2f;
      }

      .system-status {
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(255, 255, 255, 0.9);
          padding: 10px 15px;
          border-radius: 10px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
          font-size: 0.9em;
          z-index: 100;
      }

      .status-online {
          color: #28a745;
      }

      .status-offline {
          color: #dc3545;
      }
  </style>
</head>
<body>
  <div class="system-status" id="systemStatus">
      <i class="fas fa-circle status-offline"></i>
      <span>系統連線中...</span>
  </div>

  <div class="container">
      <div class="header animate__animated animate__fadeInDown">
          <h1><i class="fas fa-heartbeat"></i> 台灣帕金森病友權益促進會</h1>
          <p>會計管理系統</p>
          <div class="version-info">
              <i class="fas fa-code-branch"></i> 版本 5.0.0
          </div>
      </div>

      <div class="main-content">
          <div class="sidebar animate__animated animate__fadeInLeft">
              <nav>
                  <ul class="nav-menu">
                      <li><a href="#" onclick="showPage('dashboard')" class="active">
                          <i class="fas fa-tachometer-alt"></i> 儀表板
                      </a></li>
                      <li><a href="#" onclick="showPage('transactions')">
                          <i class="fas fa-exchange-alt"></i> 交易管理
                      </a></li>
                      <li><a href="#" onclick="showPage('receipts')">
                          <i class="fas fa-receipt"></i> 收據管理
                      </a></li>
                      <li><a href="#" onclick="showPage('vouchers')">
                          <i class="fas fa-file-invoice"></i> 憑證管理
                      </a></li>
                      <li><a href="#" onclick="showPage('members')">
                          <i class="fas fa-users"></i> 會員管理
                      </a></li>
                      <li><a href="#" onclick="showPage('reports')">
                          <i class="fas fa-chart-bar"></i> 報表系統
                      </a></li>
                      <li><a href="#" onclick="showPage('settings')">
                          <i class="fas fa-cog"></i> 系統設定
                      </a></li>
                  </ul>
              </nav>
          </div>

          <div class="content-area animate__animated animate__fadeInRight">
              <!-- 儀表板頁面 -->
              <div id="dashboard" class="page active">
                  <h2><i class="fas fa-tachometer-alt"></i> 系統儀表板</h2>
                  <div class="dashboard-grid" id="dashboardStats">
                      <div class="stat-card">
                          <h3 id="totalIncome">0</h3>
                          <p><i class="fas fa-arrow-up"></i> 本月收入</p>
                      </div>
                      <div class="stat-card">
                          <h3 id="totalExpense">0</h3>
                          <p><i class="fas fa-arrow-down"></i> 本月支出</p>
                      </div>
                      <div class="stat-card">
                          <h3 id="receiptCount">0</h3>
                          <p><i class="fas fa-receipt"></i> 本月收據</p>
                      </div>
                      <div class="stat-card">
                          <h3 id="memberCount">0</h3>
                          <p><i class="fas fa-users"></i> 會員總數</p>
                      </div>
                  </div>
                  
                  <div class="loading" id="dashboardLoading">
                      <div class="spinner"></div>
                      <p>載入儀表板資料中...</p>
                  </div>
              </div>

              <!-- 交易管理頁面 -->
              <div id="transactions" class="page">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                      <h2><i class="fas fa-exchange-alt"></i> 交易管理</h2>
                      <button class="btn btn-primary" onclick="showModal('transactionModal')">
                          <i class="fas fa-plus"></i> 新增交易
                      </button>
                  </div>

                  <div class="search-bar">
                      <input type="text" class="form-control" id="transactionSearch" placeholder="搜尋交易記錄...">
                      <select class="form-control" id="transactionTypeFilter">
                          <option value="">所有類型</option>
                          <option value="收入">收入</option>
                          <option value="支出">支出</option>
                      </select>
                      <input type="date" class="form-control" id="transactionDateFrom">
                      <input type="date" class="form-control" id="transactionDateTo">
                      <button class="btn btn-info" onclick="searchTransactions()">
                          <i class="fas fa-search"></i> 搜尋
                      </button>
                  </div>

                  <div class="table-responsive">
                      <table class="table" id="transactionTable">
                          <thead>
                              <tr>
                                  <th>日期</th>
                                  <th>類型</th>
                                  <th>類別</th>
                                  <th>交易對象</th>
                                  <th>金額</th>
                                  <th>狀態</th>
                                  <th>操作</th>
                              </tr>
                          </thead>
                          <tbody id="transactionTableBody">
                              <!-- 動態載入 -->
                          </tbody>
                      </table>
                  </div>

                  <div class="pagination" id="transactionPagination">
                      <!-- 動態載入 -->
                  </div>

                  <div class="loading" id="transactionLoading">
                      <div class="spinner"></div>
                      <p>載入交易記錄中...</p>
                  </div>
              </div>

              <!-- 收據管理頁面 -->
              <div id="receipts" class="page">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                      <h2><i class="fas fa-receipt"></i> 收據管理</h2>
                      <button class="btn btn-primary" onclick="showModal('receiptModal')">
                          <i class="fas fa-plus"></i> 開立收據
                      </button>
                  </div>

                  <div class="search-bar">
                      <input type="text" class="form-control" id="receiptSearch" placeholder="搜尋收據...">
                      <select class="form-control" id="receiptStatusFilter">
                          <option value="">所有狀態</option>
                          <option value="已開立">已開立</option>
                          <option value="已寄送">已寄送</option>
                      </select>
                      <button class="btn btn-info" onclick="searchReceipts()">
                          <i class="fas fa-search"></i> 搜尋
                      </button>
                  </div>

                  <div class="table-responsive">
                      <table class="table" id="receiptTable">
                          <thead>
                              <tr>
                                  <th>收據編號</th>
                                  <th>日期</th>
                                  <th>付款人</th>
                                  <th>身份類別</th>
                                  <th>金額</th>
                                  <th>狀態</th>
                                  <th>操作</th>
                              </tr>
                          </thead>
                          <tbody id="receiptTableBody">
                              <!-- 動態載入 -->
                          </tbody>
                      </table>
                  </div>

                  <div class="loading" id="receiptLoading">
                      <div class="spinner"></div>
                      <p>載入收據記錄中...</p>
                  </div>
              </div>

              <!-- 憑證管理頁面 -->
              <div id="vouchers" class="page">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                      <h2><i class="fas fa-file-invoice"></i> 憑證管理</h2>
                      <button class="btn btn-primary" onclick="showModal('voucherModal')">
                          <i class="fas fa-plus"></i> 提交憑證
                      </button>
                  </div>

                  <div class="table-responsive">
                      <table class="table" id="voucherTable">
                          <thead>
                              <tr>
                                  <th>憑證編號</th>
                                  <th>申請日期</th>
                                  <th>申請人</th>
                                  <th>類別</th>
                                  <th>金額</th>
                                  <th>狀態</th>
                                  <th>操作</th>
                              </tr>
                          </thead>
                          <tbody id="voucherTableBody">
                              <!-- 動態載入 -->
                          </tbody>
                      </table>
                  </div>

                  <div class="loading" id="voucherLoading">
                      <div class="spinner"></div>
                      <p>載入憑證記錄中...</p>
                  </div>
              </div>

              <!-- 會員管理頁面 -->
              <div id="members" class="page">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                      <h2><i class="fas fa-users"></i> 會員管理</h2>
                      <button class="btn btn-primary" onclick="showModal('memberModal')">
                          <i class="fas fa-plus"></i> 新增會員
                      </button>
                  </div>

                  <div class="search-bar">
                      <input type="text" class="form-control" id="memberSearch" placeholder="搜尋會員...">
                      <select class="form-control" id="memberTypeFilter">
                          <option value="">所有類型</option>
                          <option value="正式會員">正式會員</option>
                          <option value="榮譽會員">榮譽會員</option>
                          <option value="贊助會員">贊助會員</option>
                      </select>
                      <button class="btn btn-info" onclick="searchMembers()">
                          <i class="fas fa-search"></i> 搜尋
                      </button>
                  </div>

                  <div class="table-responsive">
                      <table class="table" id="memberTable">
                          <thead>
                              <tr>
                                  <th>會員編號</th>
                                  <th>姓名</th>
                                  <th>電話</th>
                                  <th>會員類型</th>
                                  <th>加入日期</th>
                                  <th>狀態</th>
                                  <th>操作</th>
                              </tr>
                          </thead>
                          <tbody id="memberTableBody">
                              <!-- 動態載入 -->
                          </tbody>
                      </table>
                  </div>

                  <div class="loading" id="memberLoading">
                      <div class="spinner"></div>
                      <p>載入會員資料中...</p>
                  </div>
              </div>

              <!-- 報表系統頁面 -->
              <div id="reports" class="page">
                  <h2><i class="fas fa-chart-bar"></i> 報表系統</h2>
                  
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                      <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                          <h3>財務報表</h3>
                          <div class="form-group">
                              <label>年份</label>
                              <select class="form-control" id="financialReportYear">
                                  <option value="2024">2024</option>
                                  <option value="2025" selected>2025</option>
                              </select>
                          </div>
                          <div class="form-group">
                              <label>月份（可選）</label>
                              <select class="form-control" id="financialReportMonth">
                                  <option value="">全年</option>
                                  <option value="1">1月</option>
                                  <option value="2">2月</option>
                                  <option value="3">3月</option>
                                  <option value="4">4月</option>
                                  <option value="5">5月</option>
                                  <option value="6">6月</option>
                                  <option value="7">7月</option>
                                  <option value="8">8月</option>
                                  <option value="9">9月</option>
                                  <option value="10">10月</option>
                                  <option value="11">11月</option>
                                  <option value="12">12月</option>
                              </select>
                          </div>
                          <button class="btn btn-primary" onclick="generateReport('financial')">
                              <i class="fas fa-chart-line"></i> 產生報表
                          </button>
                      </div>

                      <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                          <h3>收據報表</h3>
                          <div class="form-group">
                              <label>年份</label>
                              <select class="form-control" id="receiptReportYear">
                                  <option value="2024">2024</option>
                                  <option value="2025" selected>2025</option>
                              </select>
                          </div>
                          <div class="form-group">
                              <label>月份（可選）</label>
                              <select class="form-control" id="receiptReportMonth">
                                  <option value="">全年</option>
                                  <option value="1">1月</option>
                                  <option value="2">2月</option>
                                  <option value="3">3月</option>
                                  <option value="4">4月</option>
                                  <option value="5">5月</option>
                                  <option value="6">6月</option>
                                  <option value="7">7月</option>
                                  <option value="8">8月</option>
                                  <option value="9">9月</option>
                                  <option value="10">10月</option>
                                  <option value="11">11月</option>
                                  <option value="12">12月</option>
                              </select>
                          </div>
                          <button class="btn btn-primary" onclick="generateReport('receipt')">
                              <i class="fas fa-receipt"></i> 產生報表
                          </button>
                      </div>

                      <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                          <h3>會員報表</h3>
                          <div class="form-group">
                              <label>年份</label>
                              <select class="form-control" id="memberReportYear">
                                  <option value="2024">2024</option>
                                  <option value="2025" selected>2025</option>
                              </select>
                          </div>
                          <div class="form-group">
                              <label>月份（可選）</label>
                              <select class="form-control" id="memberReportMonth">
                                  <option value="">全年</option>
                                  <option value="1">1月</option>
                                  <option value="2">2月</option>
                                  <option value="3">3月</option>
                                  <option value="4">4月</option>
                                  <option value="5">5月</option>
                                  <option value="6">6月</option>
                                  <option value="7">7月</option>
                                  <option value="8">8月</option>
                                  <option value="9">9月</option>
                                  <option value="10">10月</option>
                                  <option value="11">11月</option>
                                  <option value="12">12月</option>
                              </select>
                          </div>
                          <button class="btn btn-primary" onclick="generateReport('member')">
                              <i class="fas fa-users"></i> 產生報表
                          </button>
                      </div>

                      <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                          <h3>憑證報表</h3>
                          <div class="form-group">
                              <label>年份</label>
                              <select class="form-control" id="voucherReportYear">
                                  <option value="2024">2024</option>
                                  <option value="2025" selected>2025</option>
                              </select>
                          </div>
                          <div class="form-group">
                              <label>月份（可選）</label>
                              <select class="form-control" id="voucherReportMonth">
                                  <option value="">全年</option>
                                  <option value="1">1月</option>
                                  <option value="2">2月</option>
                                  <option value="3">3月</option>
                                  <option value="4">4月</option>
                                  <option value="5">5月</option>
                                  <option value="6">6月</option>
                                  <option value="7">7月</option>
                                  <option value="8">8月</option>
                                  <option value="9">9月</option>
                                  <option value="10">10月</option>
                                  <option value="11">11月</option>
                                  <option value="12">12月</option>
                              </select>
                          </div>
                          <button class="btn btn-primary" onclick="generateReport('voucher')">
                              <i class="fas fa-file-invoice"></i> 產生報表
                          </button>
                      </div>
                  </div>

                  <div id="reportResult" style="display: none;">
                      <h3>報表結果</h3>
                      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                          <button class="btn btn-success" onclick="exportReport('csv')">
                              <i class="fas fa-file-csv"></i> 匯出CSV
                          </button>
                          <button class="btn btn-info" onclick="exportReport('excel')">
                              <i class="fas fa-file-excel"></i> 匯出Excel
                          </button>
                          <button class="btn btn-danger" onclick="exportReport('pdf')">
                              <i class="fas fa-file-pdf"></i> 匯出PDF
                          </button>
                      </div>
                      <div id="reportContent"></div>
                  </div>

                  <div class="loading" id="reportLoading">
                      <div class="spinner"></div>
                      <p>產生報表中...</p>
                  </div>
              </div>

              <!-- 系統設定頁面 -->
              <div id="settings" class="page">
                  <h2><i class="fas fa-cog"></i> 系統設定</h2>
                  
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px;">
                      <div style="background: #f8f9fa; padding: 25px; border-radius: 15px;">
                          <h3><i class="fas fa-building"></i> 組織資訊</h3>
                          <form id="organizationForm">
                              <div class="form-group">
                                  <label>組織名稱</label>
                                  <input type="text" class="form-control" id="organizationName" required>
                              </div>
                              <div class="form-group">
                                  <label>統一編號</label>
                                  <input type="text" class="form-control" id="taxId">
                              </div>
                              <div class="form-group">
                                  <label>負責人</label>
                                  <input type="text" class="form-control" id="representative">
                              </div>
                              <div class="form-group">
                                  <label>聯絡電話</label>
                                  <input type="tel" class="form-control" id="phone">
                              </div>
                              <div class="form-group">
                                  <label>電子郵件</label>
                                  <input type="email" class="form-control" id="email">
                              </div>
                              <div class="form-group">
                                  <label>組織地址</label>
                                  <textarea class="form-control" id="address" rows="3"></textarea>
                              </div>
                              <button type="submit" class="btn btn-primary">
                                  <i class="fas fa-save"></i> 儲存設定
                              </button>
                          </form>
                      </div>

                      <div style="background: #f8f9fa; padding: 25px; border-radius: 15px;">
                          <h3><i class="fas fa-tools"></i> 系統管理</h3>
                          <div style="display: flex; flex-direction: column; gap: 15px;">
                              <button class="btn btn-info" onclick="testConnection()">
                                  <i class="fas fa-wifi"></i> 測試連線
                              </button>
                              <button class="btn btn-success" onclick="createBackup()">
                                  <i class="fas fa-database"></i> 建立備份
                              </button>
                              <button class="btn btn-primary" onclick="validateData()">
                                  <i class="fas fa-check-circle"></i> 驗證資料
                              </button>
                              <button class="btn btn-danger" onclick="cleanupSystem()">
                                  <i class="fas fa-broom"></i> 系統清理
                              </button>
                          </div>
                      </div>

                      <div style="background: #f8f9fa; padding: 25px; border-radius: 15px;">
                          <h3><i class="fas fa-chart-pie"></i> 系統統計</h3>
                          <div id="systemStats">
                              <div class="loading">
                                  <div class="spinner"></div>
                                  <p>載入統計資料中...</p>
                              </div>
                          </div>
                      </div>

                      <div style="background: #f8f9fa; padding: 25px; border-radius: 15px;">
                          <h3><i class="fas fa-info-circle"></i> 系統資訊</h3>
                          <div style="line-height: 1.8;">
                              <p><strong>系統版本：</strong> v5.0.0</p>
                              <p><strong>最後更新：</strong> <span id="lastUpdate">載入中...</span></p>
                              <p><strong>系統狀態：</strong> <span id="systemStatusText">檢查中...</span></p>
                              <p><strong>資料庫連線：</strong> <span id="dbStatus">檢查中...</span></p>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- 交易新增/編輯模態框 -->
  <div id="transactionModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2><i class="fas fa-exchange-alt"></i> 交易資料</h2>
              <span class="close" onclick="hideModal('transactionModal')">&times;</span>
          </div>
          <form id="transactionForm">
              <div class="form-group">
                  <label>日期 *</label>
                  <input type="date" class="form-control" id="transactionDate" required>
              </div>
              <div class="form-group">
                  <label>類型 *</label>
                  <select class="form-control" id="transactionType" required>
                      <option value="">請選擇</option>
                      <option value="收入">收入</option>
                      <option value="支出">支出</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>類別 *</label>
                  <select class="form-control" id="transactionCategory" required>
                      <option value="">請選擇</option>
                      <option value="會費">會費</option>
                      <option value="捐款">捐款</option>
                      <option value="活動費">活動費</option>
                      <option value="辦公費">辦公費</option>
                      <option value="其他">其他</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>交易對象 *</label>
                  <input type="text" class="form-control" id="transactionName" required>
              </div>
              <div class="form-group">
                  <label>金額 *</label>
                  <input type="number" class="form-control" id="transactionAmount" min="0" step="1" required>
              </div>
              <div class="form-group">
                  <label>帳戶</label>
                  <select class="form-control" id="transactionAccount">
                      <option value="現金">現金</option>
                      <option value="銀行">銀行</option>
                      <option value="支票">支票</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>說明</label>
                  <textarea class="form-control" id="transactionDescription" rows="3"></textarea>
              </div>
              <div style="display: flex; gap: 10px; justify-content: flex-end;">
                  <button type="button" class="btn btn-secondary" onclick="hideModal('transactionModal')">取消</button>
                  <button type="submit" class="btn btn-primary">儲存</button>
              </div>
          </form>
      </div>
  </div>

  <!-- 收據新增/編輯模態框 -->
  <div id="receiptModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2><i class="fas fa-receipt"></i> 收據資料</h2>
              <span class="close" onclick="hideModal('receiptModal')">&times;</span>
          </div>
          <form id="receiptForm">
              <div class="form-group">
                  <label>日期 *</label>
                  <input type="date" class="form-control" id="receiptDate" required>
              </div>
              <div class="form-group">
                  <label>付款人 *</label>
                  <input type="text" class="form-control" id="receiptPayer" required>
              </div>
              <div class="form-group">
                  <label>身份類別 *</label>
                  <select class="form-control" id="receiptIdentity" required>
                      <option value="">請選擇</option>
                      <option value="個人">個人</option>
                      <option value="公司">公司</option>
                      <option value="機關">機關</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>聯絡電話</label>
                  <input type="tel" class="form-control" id="receiptPhone">
              </div>
              <div class="form-group">
                  <label>電子郵件</label>
                  <input type="email" class="form-control" id="receiptEmail">
              </div>
              <div class="form-group">
                  <label>收據類別 *</label>
                  <select class="form-control" id="receiptCategory" required>
                      <option value="">請選擇</option>
                      <option value="捐款">捐款</option>
                      <option value="會費">會費</option>
                      <option value="活動費">活動費</option>
                      <option value="其他">其他</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>金額 *</label>
                  <input type="number" class="form-control" id="receiptAmount" min="0" step="1" required>
              </div>
              <div class="form-group">
                  <label>用途說明</label>
                  <textarea class="form-control" id="receiptPurpose" rows="3"></textarea>
              </div>
              <div style="display: flex; gap: 10px; justify-content: flex-end;">
                  <button type="button" class="btn btn-secondary" onclick="hideModal('receiptModal')">取消</button>
                  <button type="submit" class="btn btn-primary">開立收據</button>
              </div>
          </form>
      </div>
  </div>

  <!-- 憑證新增/編輯模態框 -->
  <div id="voucherModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2><i class="fas fa-file-invoice"></i> 憑證資料</h2>
              <span class="close" onclick="hideModal('voucherModal')">&times;</span>
          </div>
          <form id="voucherForm">
              <div class="form-group">
                  <label>申請日期 *</label>
                  <input type="date" class="form-control" id="voucherDate" required>
              </div>
              <div class="form-group">
                  <label>申請人 *</label>
                  <input type="text" class="form-control" id="voucherApplicant" required>
              </div>
              <div class="form-group">
                  <label>支出類別 *</label>
                  <select class="form-control" id="voucherCategory" required>
                      <option value="">請選擇</option>
                      <option value="辦公費">辦公費</option>
                      <option value="活動費">活動費</option>
                      <option value="交通費">交通費</option>
                      <option value="餐費">餐費</option>
                      <option value="其他">其他</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>金額 *</label>
                  <input type="number" class="form-control" id="voucherAmount" min="0" step="1" required>
              </div>
              <div class="form-group">
                  <label>用途說明 *</label>
                  <textarea class="form-control" id="voucherPurpose" rows="3" required></textarea>
              </div>
              <div class="form-group">
                  <label>備註</label>
                  <textarea class="form-control" id="voucherNote" rows="2"></textarea>
              </div>
              <div style="display: flex; gap: 10px; justify-content: flex-end;">
                  <button type="button" class="btn btn-secondary" onclick="hideModal('voucherModal')">取消</button>
                  <button type="submit" class="btn btn-primary">提交憑證</button>
              </div>
          </form>
      </div>
  </div>

  <!-- 會員新增/編輯模態框 -->
  <div id="memberModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2><i class="fas fa-user"></i> 會員資料</h2>
              <span class="close" onclick="hideModal('memberModal')">&times;</span>
          </div>
          <form id="memberForm">
              <div class="form-group">
                  <label>姓名 *</label>
                  <input type="text" class="form-control" id="memberName" required>
              </div>
              <div class="form-group">
                  <label>性別</label>
                  <select class="form-control" id="memberGender">
                      <option value="">請選擇</option>
                      <option value="男">男</option>
                      <option value="女">女</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>出生日期</label>
                  <input type="date" class="form-control" id="memberBirthdate">
              </div>
              <div class="form-group">
                  <label>身份證字號</label>
                  <input type="text" class="form-control" id="memberIdNumber">
              </div>
              <div class="form-group">
                  <label>聯絡電話 *</label>
                  <input type="tel" class="form-control" id="memberPhone" required>
              </div>
              <div class="form-group">
                  <label>電子郵件</label>
                  <input type="email" class="form-control" id="memberEmail">
              </div>
              <div class="form-group">
                  <label>地址</label>
                  <textarea class="form-control" id="memberAddress" rows="3"></textarea>
              </div>
              <div class="form-group">
                  <label>會員類型 *</label>
                  <select class="form-control" id="memberType" required>
                      <option value="">請選擇</option>
                      <option value="正式會員">正式會員</option>
                      <option value="榮譽會員">榮譽會員</option>
                      <option value="贊助會員">贊助會員</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>加入日期 *</label>
                  <input type="date" class="form-control" id="memberJoinDate" required>
              </div>
              <div style="display: flex; gap: 10px; justify-content: flex-end;">
                  <button type="button" class="btn btn-secondary" onclick="hideModal('memberModal')">取消</button>
                  <button type="submit" class="btn btn-primary">儲存</button>
              </div>
          </form>
      </div>
  </div>

  <!-- 收據預覽模態框 -->
  <div id="receiptPreviewModal" class="modal">
      <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
              <h2><i class="fas fa-eye"></i> 收據預覽</h2>
              <span class="close" onclick="hideModal('receiptPreviewModal')">&times;</span>
          </div>
          <div id="receiptPreviewContent" class="receipt-preview">
              <!-- 收據內容將在此動態載入 -->
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
              <button class="btn btn-info" onclick="printReceipt()">
                  <i class="fas fa-print"></i> 列印
              </button>
              <button class="btn btn-success" onclick="emailReceipt()">
                  <i class="fas fa-envelope"></i> 寄送
              </button>
              <button class="btn btn-secondary" onclick="hideModal('receiptPreviewModal')">關閉</button>
          </div>
      </div>
  </div>

  <script>
      // 系統配置
      const CONFIG = {
          API_URL: 'https://script.google.com/macros/s/AKfycbx4tyyPc_0G1OKGI2agGmBKZaxBrA8ycJ5iMDjeNTbYOkw9ZDOkovkdsFkMlj43nkrX/exec', // 請替換為實際的 Google Apps Script URL
          VERSION: 'v5.0.0'
      };

      // 全域變數
      let currentPage = 'dashboard';
      let currentReportData = null;
      let currentEditingId = null;

      // 頁面載入完成後初始化
      document.addEventListener('DOMContentLoaded', function() {
          initializeSystem();
          loadDashboard();
          checkSystemStatus();
          
          // 設定表單提交事件
          setupFormHandlers();
          
          // 設定今天的日期為預設值
          setDefaultDates();
      });

      /**
       * 初始化系統
       */
      function initializeSystem() {
          console.log('台灣帕金森病友權益促進會會計系統 v5.0 初始化中...');
          
          // 載入組織資訊
          loadOrganizationInfo();
          
          // 載入系統統計
          loadSystemStatistics();
      }

      /**
       * 檢查系統狀態
       */
      async function checkSystemStatus() {
          try {
              const response = await apiCall('testConnection');
              updateSystemStatus(response.success);
              
              if (response.success) {
                  document.getElementById('systemStatusText').textContent = '正常運行';
                  document.getElementById('dbStatus').textContent = '連線正常';
              } else {
                  document.getElementById('systemStatusText').textContent = '異常';
                  document.getElementById('dbStatus').textContent = '連線失敗';
              }
          } catch (error) {
              updateSystemStatus(false);
              document.getElementById('systemStatusText').textContent = '異常';
              document.getElementById('dbStatus').textContent = '連線失敗';
          }
          
          document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-TW');
      }

      /**
       * 更新系統狀態顯示
       */
      function updateSystemStatus(isOnline) {
          const statusElement = document.getElementById('systemStatus');
          const icon = statusElement.querySelector('i');
          const text = statusElement.querySelector('span');
          
          if (isOnline) {
              icon.className = 'fas fa-circle status-online';
              text.textContent = '系統正常';
          } else {
              icon.className = 'fas fa-circle status-offline';
              text.textContent = '系統離線';
          }
      }

      /**
       * API 呼叫函數
       */
      async function apiCall(action, data = {}) {
          try {
              const response = await fetch(CONFIG.API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: action,
                      data: data
                  })
              });
              
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              const result = await response.json();
              return result;
          } catch (error) {
              console.error('API 呼叫錯誤:', error);
              showAlert('系統錯誤：' + error.message, 'danger');
              throw error;
          }
      }

      /**
       * 顯示頁面
       */
      function showPage(pageId) {
          // 隱藏所有頁面
          document.querySelectorAll('.page').forEach(page => {
              page.classList.remove('active');
          });
          
          // 更新導航選單
          document.querySelectorAll('.nav-menu a').forEach(link => {
              link.classList.remove('active');
          });
          
          // 顯示指定頁面
          document.getElementById(pageId).classList.add('active');
          event.target.classList.add('active');
          
          currentPage = pageId;
          
          // 載入頁面資料
          loadPageData(pageId);
      }

      /**
       * 載入頁面資料
       */
      function loadPageData(pageId) {
          switch(pageId) {
              case 'dashboard':
                  loadDashboard();
                  break;
              case 'transactions':
                  loadTransactions();
                  break;
              case 'receipts':
                  loadReceipts();
                  break;
              case 'vouchers':
                  loadVouchers();
                  break;
              case 'members':
                  loadMembers();
                  break;
              case 'settings':
                  loadSettings();
                  break;
          }
      }

      /**
       * 載入儀表板
       */
      async function loadDashboard() {
          showLoading('dashboardLoading');
          
          try {
              const stats = await apiCall('getDashboardStats');
              
              document.getElementById('totalIncome').textContent = formatCurrency(stats.totalIncome || 0);
              document.getElementById('totalExpense').textContent = formatCurrency(stats.totalExpense || 0);
              document.getElementById('receiptCount').textContent = stats.receiptCount || 0;
              document.getElementById('memberCount').textContent = stats.memberCount || 0;
              
          } catch (error) {
              console.error('載入儀表板失敗:', error);
          } finally {
              hideLoading('dashboardLoading');
          }
      }

      /**
       * 載入交易記錄
       */
      async function loadTransactions(page = 1, searchParams = {}) {
          showLoading('transactionLoading');
          
          try {
              const params = {
                  page: page,
                  limit: 20,
                  ...searchParams
              };
              
              const result = await apiCall('getTransactions', params);
              displayTransactions(result.data);
              displayPagination('transactionPagination', result.pagination, loadTransactions);
              
          } catch (error) {
              console.error('載入交易記錄失敗:', error);
          } finally {
              hideLoading('transactionLoading');
          }
      }

      /**
       * 顯示交易記錄
       */
      function displayTransactions(transactions) {
          const tbody = document.getElementById('transactionTableBody');
          tbody.innerHTML = '';
          
          transactions.forEach(transaction => {
              const row = document.createElement('tr');
              row.innerHTML = `
                  <td>${formatDate(transaction.date)}</td>
                  <td><span class="status-badge ${transaction.type === '收入' ? 'status-approved' : 'status-pending'}">${transaction.type}</span></td>
                  <td>${transaction.category}</td>
                  <td>${transaction.name}</td>
                  <td>${formatCurrency(transaction.amount)}</td>
                  <td><span class="status-badge status-normal">正常</span></td>
                  <td>
                      <button class="btn btn-sm btn-info" onclick="editTransaction('${transaction.id}')">
                          <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" onclick="deleteTransaction('${transaction.id}')">
                          <i class="fas fa-trash"></i>
                      </button>
                  </td>
              `;
              tbody.appendChild(row);
          });
      }

      /**
       * 載入收據記錄
       */
      async function loadReceipts(page = 1, searchParams = {}) {
          showLoading('receiptLoading');
          
          try {
              const params = {
                  page: page,
                  limit: 20,
                  ...searchParams
              };
              
              const result = await apiCall('getReceipts', params);
              displayReceipts(result.data);
              displayPagination('receiptPagination', result.pagination, loadReceipts);
              
          } catch (error) {
              console.error('載入收據記錄失敗:', error);
          } finally {
              hideLoading('receiptLoading');
          }
      }

      /**
       * 顯示收據記錄
       */
      function displayReceipts(receipts) {
          const tbody = document.getElementById('receiptTableBody');
          tbody.innerHTML = '';
          
          receipts.forEach(receipt => {
              const row = document.createElement('tr');
              row.innerHTML = `
                  <td>${receipt.receiptNumber}</td>
                  <td>${formatDate(receipt.date)}</td>
                  <td>${receipt.payer}</td>
                  <td>${receipt.identity}</td>
                  <td>${formatCurrency(receipt.amount)}</td>
                  <td><span class="status-badge status-approved">${receipt.status || '已開立'}</span></td>
                  <td>
                      <button class="btn btn-sm btn-info" onclick="previewReceipt('${receipt.id}')">
                          <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn btn-sm btn-success" onclick="emailReceipt('${receipt.id}')">
                          <i class="fas fa-envelope"></i>
                      </button>
                      <button class="btn btn-sm btn-primary" onclick="printReceipt('${receipt.id}')">
                          <i class="fas fa-print"></i>
                      </button>
                  </td>
              `;
              tbody.appendChild(row);
          });
      }

      /**
       * 載入憑證記錄
       */
      async function loadVouchers(page = 1, searchParams = {}) {
          showLoading('voucherLoading');
          
          try {
              const params = {
                  page: page,
                  limit: 20,
                  ...searchParams
              };
              
              const result = await apiCall('getVouchers', params);
              displayVouchers(result.data);
              displayPagination('voucherPagination', result.pagination, loadVouchers);
              
          } catch (error) {
              console.error('載入憑證記錄失敗:', error);
          } finally {
              hideLoading('voucherLoading');
          }
      }

      /**
       * 顯示憑證記錄
       */
      function displayVouchers(vouchers) {
          const tbody = document.getElementById('voucherTableBody');
          tbody.innerHTML = '';
          
          vouchers.forEach(voucher => {
              const row = document.createElement('tr');
              const statusClass = voucher.status === '已核准' ? 'status-approved' : 
                                voucher.status === '待審核' ? 'status-pending' : 'status-rejected';
              
              row.innerHTML = `
                  <td>${voucher.voucherNumber}</td>
                  <td>${formatDate(voucher.date)}</td>
                  <td>${voucher.applicant}</td>
                  <td>${voucher.category}</td>
                  <td>${formatCurrency(voucher.amount)}</td>
                  <td><span class="status-badge ${statusClass}">${voucher.status || '待審核'}</span></td>
                  <td>
                      <button class="btn btn-sm btn-info" onclick="editVoucher('${voucher.id}')">
                          <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-success" onclick="approveVoucher('${voucher.id}')">
                          <i class="fas fa-check"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" onclick="rejectVoucher('${voucher.id}')">
                          <i class="fas fa-times"></i>
                      </button>
                  </td>
              `;
              tbody.appendChild(row);
          });
      }

      /**
       * 載入會員記錄
       */
      async function loadMembers(page = 1, searchParams = {}) {
          showLoading('memberLoading');
          
          try {
              const params = {
                  page: page,
                  limit: 20,
                  ...searchParams
              };
              
              const result = await apiCall('getMembers', params);
              displayMembers(result.data);
              displayPagination('memberPagination', result.pagination, loadMembers);
              
          } catch (error) {
              console.error('載入會員記錄失敗:', error);
          } finally {
              hideLoading('memberLoading');
          }
      }

      /**
       * 顯示會員記錄
       */
      function displayMembers(members) {
          const tbody = document.getElementById('memberTableBody');
          tbody.innerHTML = '';
          
          members.forEach(member => {
              const row = document.createElement('tr');
              row.innerHTML = `
                  <td>${member.memberNumber}</td>
                  <td>${member.name}</td>
                  <td>${member.phone}</td>
                  <td>${member.type}</td>
                  <td>${formatDate(member.joinDate)}</td>
                  <td><span class="status-badge status-normal">正常</span></td>
                  <td>
                      <button class="btn btn-sm btn-info" onclick="editMember('${member.id}')">
                          <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" onclick="deleteMember('${member.id}')">
                          <i class="fas fa-trash"></i>
                      </button>
                  </td>
              `;
              tbody.appendChild(row);
          });
      }

      /**
       * 載入系統設定
       */
      async function loadSettings() {
          try {
              const settings = await apiCall('getSettings');
              
              // 填入組織資訊
              if (settings.organization) {
                  document.getElementById('organizationName').value = settings.organization.name || '';
                  document.getElementById('taxId').value = settings.organization.taxId || '';
                  document.getElementById('representative').value = settings.organization.representative || '';
                  document.getElementById('phone').value = settings.organization.phone || '';
                  document.getElementById('email').value = settings.organization.email || '';
                  document.getElementById('address').value = settings.organization.address || '';
              }
              
          } catch (error) {
              console.error('載入系統設定失敗:', error);
          }
      }

      /**
       * 載入組織資訊
       */
      async function loadOrganizationInfo() {
          try {
              const info = await apiCall('getOrganizationInfo');
              // 處理組織資訊
          } catch (error) {
              console.error('載入組織資訊失敗:', error);
          }
      }

      /**
       * 載入系統統計
       */
      async function loadSystemStatistics() {
          try {
              const stats = await apiCall('getSystemStatistics');
              const container = document.getElementById('systemStats');
              
              container.innerHTML = `
                  <div style="line-height: 1.8;">
                      <p><strong>總交易筆數：</strong> ${stats.totalTransactions || 0}</p>
                      <p><strong>總收據數量：</strong> ${stats.totalReceipts || 0}</p>
                      <p><strong>總憑證數量：</strong> ${stats.totalVouchers || 0}</p>
                      <p><strong>總會員數量：</strong> ${stats.totalMembers || 0}</p>
                      <p><strong>資料庫大小：</strong> ${stats.databaseSize || '未知'}</p>
                  </div>
              `;
          } catch (error) {
              console.error('載入系統統計失敗:', error);
              document.getElementById('systemStats').innerHTML = '<p>載入統計資料失敗</p>';
          }
      }

      /**
       * 搜尋功能
       */
      function searchTransactions() {
          const searchParams = {
              keyword: document.getElementById('transactionSearch').value,
              type: document.getElementById('transactionTypeFilter').value,
              dateFrom: document.getElementById('transactionDateFrom').value,
              dateTo: document.getElementById('transactionDateTo').value
          };
          loadTransactions(1, searchParams);
      }

      function searchReceipts() {
          const searchParams = {
              keyword: document.getElementById('receiptSearch').value,
              status: document.getElementById('receiptStatusFilter').value
          };
          loadReceipts(1, searchParams);
      }

      function searchMembers() {
          const searchParams = {
              keyword: document.getElementById('memberSearch').value,
              type: document.getElementById('memberTypeFilter').value
          };
          loadMembers(1, searchParams);
      }

      /**
       * 模態框控制
       */
      function showModal(modalId) {
          document.getElementById(modalId).style.display = 'block';
          document.body.style.overflow = 'hidden';
      }

      function hideModal(modalId) {
          document.getElementById(modalId).style.display = 'none';
          document.body.style.overflow = 'auto';
          
          // 清空表單
          const form = document.querySelector(`#${modalId} form`);
          if (form) {
              form.reset();
          }
          
          currentEditingId = null;
      }

      /**
       * 表單處理設定
       */
      function setupFormHandlers() {
          // 交易表單
          document.getElementById('transactionForm').addEventListener('submit', async function(e) {
              e.preventDefault();
              await saveTransaction();
          });

          // 收據表單
          document.getElementById('receiptForm').addEventListener('submit', async function(e) {
              e.preventDefault();
              await saveReceipt();
          });

          // 憑證表單
          document.getElementById('voucherForm').addEventListener('submit', async function(e) {
              e.preventDefault();
              await saveVoucher();
          });

          // 會員表單
          document.getElementById('memberForm').addEventListener('submit', async function(e) {
              e.preventDefault();
              await saveMember();
          });

          // 組織設定表單
          document.getElementById('organizationForm').addEventListener('submit', async function(e) {
              e.preventDefault();
              await saveOrganizationSettings();
          });
      }

      /**
       * 儲存交易
       */
      async function saveTransaction() {
          const formData = {
              date: document.getElementById('transactionDate').value,
              type: document.getElementById('transactionType').value,
              category: document.getElementById('transactionCategory').value,
              name: document.getElementById('transactionName').value,
              amount: parseFloat(document.getElementById('transactionAmount').value),
              account: document.getElementById('transactionAccount').value,
              description: document.getElementById('transactionDescription').value
          };

          try {
              const action = currentEditingId ? 'updateTransaction' : 'addTransaction';
              if (currentEditingId) {
                  formData.id = currentEditingId;
              }

              await apiCall(action, formData);
              showAlert('交易記錄已儲存', 'success');
              hideModal('transactionModal');
              loadTransactions();
          } catch (error) {
              console.error('儲存交易失敗:', error);
              showAlert('儲存失敗：' + error.message, 'danger');
          }
      }

      /**
       * 儲存收據
       */
      async function saveReceipt() {
          const formData = {
              date: document.getElementById('receiptDate').value,
              payer: document.getElementById('receiptPayer').value,
              identity: document.getElementById('receiptIdentity').value,
              phone: document.getElementById('receiptPhone').value,
              email: document.getElementById('receiptEmail').value,
              category: document.getElementById('receiptCategory').value,
              amount: parseFloat(document.getElementById('receiptAmount').value),
              purpose: document.getElementById('receiptPurpose').value
          };

          try {
              const result = await apiCall('addReceipt', formData);
              showAlert('收據已開立，編號：' + result.receiptNumber, 'success');
              hideModal('receiptModal');
              loadReceipts();
              
              // 顯示收據預覽
              if (result.receiptId) {
                  previewReceipt(result.receiptId);
              }
          } catch (error) {
              console.error('開立收據失敗:', error);
              showAlert('開立失敗：' + error.message, 'danger');
          }
      }

      /**
       * 儲存憑證
       */
      async function saveVoucher() {
          const formData = {
              date: document.getElementById('voucherDate').value,
              applicant: document.getElementById('voucherApplicant').value,
              category: document.getElementById('voucherCategory').value,
              amount: parseFloat(document.getElementById('voucherAmount').value),
              purpose: document.getElementById('voucherPurpose').value,
              note: document.getElementById('voucherNote').value
          };

          try {
              const action = currentEditingId ? 'updateVoucher' : 'addVoucher';
              if (currentEditingId) {
                  formData.id = currentEditingId;
              }

              const result = await apiCall(action, formData);
              showAlert('憑證已提交，編號：' + result.voucherNumber, 'success');
              hideModal('voucherModal');
              loadVouchers();
          } catch (error) {
              console.error('提交憑證失敗:', error);
              showAlert('提交失敗：' + error.message, 'danger');
          }
      }

      /**
       * 儲存會員
       */
      async function saveMember() {
          const formData = {
              name: document.getElementById('memberName').value,
              gender: document.getElementById('memberGender').value,
              birthdate: document.getElementById('memberBirthdate').value,
              idNumber: document.getElementById('memberIdNumber').value,
              phone: document.getElementById('memberPhone').value,
              email: document.getElementById('memberEmail').value,
              address: document.getElementById('memberAddress').value,
              type: document.getElementById('memberType').value,
              joinDate: document.getElementById('memberJoinDate').value
          };

          try {
              const action = currentEditingId ? 'updateMember' : 'addMember';
              if (currentEditingId) {
                  formData.id = currentEditingId;
              }

              const result = await apiCall(action, formData);
              showAlert('會員資料已儲存，編號：' + result.memberNumber, 'success');
              hideModal('memberModal');
              loadMembers();
          } catch (error) {
              console.error('儲存會員失敗:', error);
              showAlert('儲存失敗：' + error.message, 'danger');
          }
      }

      /**
       * 儲存組織設定
       */
      async function saveOrganizationSettings() {
          const formData = {
              name: document.getElementById('organizationName').value,
              taxId: document.getElementById('taxId').value,
              representative: document.getElementById('representative').value,
              phone: document.getElementById('phone').value,
              email: document.getElementById('email').value,
              address: document.getElementById('address').value
          };

          try {
              await apiCall('updateOrganizationSettings', formData);
              showAlert('組織設定已儲存', 'success');
          } catch (error) {
              console.error('儲存組織設定失敗:', error);
              showAlert('儲存失敗：' + error.message, 'danger');
          }
      }

      /**
       * 編輯功能
       */
      async function editTransaction(id) {
          try {
              const transaction = await apiCall('getTransaction', { id: id });
              
              document.getElementById('transactionDate').value = transaction.date;
              document.getElementById('transactionType').value = transaction.type;
              document.getElementById('transactionCategory').value = transaction.category;
              document.getElementById('transactionName').value = transaction.name;
              document.getElementById('transactionAmount').value = transaction.amount;
              document.getElementById('transactionAccount').value = transaction.account;
              document.getElementById('transactionDescription').value = transaction.description;
              
              currentEditingId = id;
              showModal('transactionModal');
          } catch (error) {
              console.error('載入交易資料失敗:', error);
              showAlert('載入資料失敗', 'danger');
          }
      }

      async function editVoucher(id) {
          try {
              const voucher = await apiCall('getVoucher', { id: id });
              
              document.getElementById('voucherDate').value = voucher.date;
              document.getElementById('voucherApplicant').value = voucher.applicant;
              document.getElementById('voucherCategory').value = voucher.category;
              document.getElementById('voucherAmount').value = voucher.amount;
              document.getElementById('voucherPurpose').value = voucher.purpose;
              document.getElementById('voucherNote').value = voucher.note;
              
              currentEditingId = id;
              showModal('voucherModal');
          } catch (error) {
              console.error('載入憑證資料失敗:', error);
              showAlert('載入資料失敗', 'danger');
          }
      }

      async function editMember(id) {
          try {
              const member = await apiCall('getMember', { id: id });
              
              document.getElementById('memberName').value = member.name;
              document.getElementById('memberGender').value = member.gender;
              document.getElementById('memberBirthdate').value = member.birthdate;
              document.getElementById('memberIdNumber').value = member.idNumber;
              document.getElementById('memberPhone').value = member.phone;
              document.getElementById('memberEmail').value = member.email;
              document.getElementById('memberAddress').value = member.address;
              document.getElementById('memberType').value = member.type;
              document.getElementById('memberJoinDate').value = member.joinDate;
              
              currentEditingId = id;
              showModal('memberModal');
          } catch (error) {
              console.error('載入會員資料失敗:', error);
              showAlert('載入資料失敗', 'danger');
          }
      }

      /**
       * 刪除功能
       */
      async function deleteTransaction(id) {
          if (confirm('確定要刪除此交易記錄嗎？')) {
              try {
                  await apiCall('deleteTransaction', { id: id });
                  showAlert('交易記錄已刪除', 'success');
                  loadTransactions();
              } catch (error) {
                  console.error('刪除交易失敗:', error);
                  showAlert('刪除失敗：' + error.message, 'danger');
              }
          }
      }

      async function deleteMember(id) {
          if (confirm('確定要刪除此會員資料嗎？')) {
              try {
                  await apiCall('deleteMember', { id: id });
                  showAlert('會員資料已刪除', 'success');
                  loadMembers();
              } catch (error) {
                  console.error('刪除會員失敗:', error);
                  showAlert('刪除失敗：' + error.message, 'danger');
              }
          }
      }

      /**
       * 憑證審核功能
       */
      async function approveVoucher(id) {
          if (confirm('確定要核准此憑證嗎？')) {
              try {
                  await apiCall('approveVoucher', { id: id });
                  showAlert('憑證已核准', 'success');
                  loadVouchers();
              } catch (error) {
                  console.error('核准憑證失敗:', error);
                  showAlert('核准失敗：' + error.message, 'danger');
              }
          }
      }

      async function rejectVoucher(id) {
          const reason = prompt('請輸入拒絕原因：');
          if (reason) {
              try {
                  await apiCall('rejectVoucher', { id: id, reason: reason });
                  showAlert('憑證已拒絕', 'success');
                  loadVouchers();
              } catch (error) {
                  console.error('拒絕憑證失敗:', error);
                  showAlert('拒絕失敗：' + error.message, 'danger');
              }
          }
      }

      /**
       * 收據預覽功能
       */
      async function previewReceipt(id) {
          try {
              const receipt = await apiCall('getReceiptData', { id: id });
              const previewContent = generateReceiptHTML(receipt);
              
              document.getElementById('receiptPreviewContent').innerHTML = previewContent;
              showModal('receiptPreviewModal');
          } catch (error) {
              console.error('載入收據資料失敗:', error);
              showAlert('載入收據失敗', 'danger');
          }
      }

      /**
       * 產生收據HTML
       */
      function generateReceiptHTML(receipt) {
          return `
              <div class="receipt-header">
                  <div class="receipt-title">台灣帕金森病友權益促進會</div>
                  <div class="receipt-subtitle">收據</div>
              </div>
              <div class="receipt-content">
                  <div class="receipt-row">
                      <div class="receipt-label">收據編號：</div>
                      <div class="receipt-value">${receipt.receiptNumber}</div>
                  </div>
                  <div class="receipt-row">
                      <div class="receipt-label">開立日期：</div>
                      <div class="receipt-value">${formatDate(receipt.date)}</div>
                  </div>
                  <div class="receipt-row">
                      <div class="receipt-label">付款人：</div>
                      <div class="receipt-value">${receipt.payer}</div>
                  </div>
                  <div class="receipt-row">
                      <div class="receipt-label">身份類別：</div>
                      <div class="receipt-value">${receipt.identity}</div>
                  </div>
                  <div class="receipt-row">
                      <div class="receipt-label">收據類別：</div>
                      <div class="receipt-value">${receipt.category}</div>
                  </div>
                  <div class="receipt-row">
                      <div class="receipt-label">金額：</div>
                      <div class="receipt-value receipt-amount">${formatCurrency(receipt.amount)}</div>
                  </div>
                  <div class="receipt-row">
                      <div class="receipt-label">用途：</div>
                      <div class="receipt-value">${receipt.purpose || ''}</div>
                  </div>
                  <div style="margin-top: 40px; text-align: right;">
                      <p>此致</p>
                      <p style="margin-top: 30px;">台灣帕金森病友權益促進會</p>
                      <p>負責人：_______________</p>
                  </div>
              </div>
          `;
      }

      /**
       * 列印收據
       */
      function printReceipt(id = null) {
          if (id) {
              previewReceipt(id).then(() => {
                  setTimeout(() => {
                      const printContent = document.getElementById('receiptPreviewContent').innerHTML;
                      const printWindow = window.open('', '_blank');
                      printWindow.document.write(`
                          <html>
                              <head>
                                  <title>收據列印</title>
                                  <style>
                                      body { font-family: 'Microsoft JhengHei', serif; }
                                      .receipt-preview { padding: 20px; }
                                      .receipt-header { text-align: center; margin-bottom: 30px; }
                                      .receipt-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
                                      .receipt-subtitle { font-size: 18px; color: #666; }
                                      .receipt-content { line-height: 1.8; }
                                      .receipt-row { display: flex; margin-bottom: 15px; }
                                      .receipt-label { width: 120px; font-weight: bold; }
                                      .receipt-value { flex: 1; }
                                      .receipt-amount { font-size: 20px; font-weight: bold; color: #d32f2f; }
                                  </style>
                              </head>
                              <body>
                                  <div class="receipt-preview">${printContent}</div>
                              </body>
                          </html>
                      `);
                      printWindow.document.close();
                      printWindow.print();
                  }, 500);
              });
          } else {
              const printContent = document.getElementById('receiptPreviewContent').innerHTML;
              const printWindow = window.open('', '_blank');
              printWindow.document.write(`
                  <html>
                      <head>
                          <title>收據列印</title>
                          <style>
                              body { font-family: 'Microsoft JhengHei', serif; }
                              .receipt-preview { padding: 20px; }
                              .receipt-header { text-align: center; margin-bottom: 30px; }
                              .receipt-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
                              .receipt-subtitle { font-size: 18px; color: #666; }
                              .receipt-content { line-height: 1.8; }
                              .receipt-row { display: flex; margin-bottom: 15px; }
                              .receipt-label { width: 120px; font-weight: bold; }
                              .receipt-value { flex: 1; }
                              .receipt-amount { font-size: 20px; font-weight: bold; color: #d32f2f; }
                          </style>
                      </head>
                      <body>
                          <div class="receipt-preview">${printContent}</div>
                      </body>
                  </html>
              `);
              printWindow.document.close();
              printWindow.print();
          }
      }

      /**
       * 寄送收據
       */
      async function emailReceipt(id = null) {
          try {
              const receiptId = id || getCurrentReceiptId();
              if (!receiptId) {
                  showAlert('找不到收據資料', 'danger');
                  return;
              }

              await apiCall('emailReceipt', { id: receiptId });
              showAlert('收據已寄送', 'success');
          } catch (error) {
              console.error('寄送收據失敗:', error);
              showAlert('寄送失敗：' + error.message, 'danger');
          }
      }

      /**
       * 報表功能
       */
      async function generateReport(type) {
          showLoading('reportLoading');
          
          try {
              let params = { type: type };
              
              switch(type) {
                  case 'financial':
                      params.year = document.getElementById('financialReportYear').value;
                      params.month = document.getElementById('financialReportMonth').value;
                      break;
                  case 'receipt':
                      params.year = document.getElementById('receiptReportYear').value;
                      params.month = document.getElementById('receiptReportMonth').value;
                      break;
                  case 'member':
                      params.year = document.getElementById('memberReportYear').value;
                      params.month = document.getElementById('memberReportMonth').value;
                      break;
                  case 'voucher':
                      params.year = document.getElementById('voucherReportYear').value;
                      params.month = document.getElementById('voucherReportMonth').value;
                      break;
              }
              
              const result = await apiCall('generateReport', params);
              currentReportData = result;
              
              displayReportResult(result);
              
          } catch (error) {
              console.error('產生報表失敗:', error);
              showAlert('產生報表失敗：' + error.message, 'danger');
          } finally {
              hideLoading('reportLoading');
          }
      }

      /**
       * 顯示報表結果
       */
      function displayReportResult(reportData) {
          const container = document.getElementById('reportContent');
          const resultDiv = document.getElementById('reportResult');
          
          let html = '<div class="table-responsive"><table class="table"><thead><tr>';
          
          // 產生表頭
          if (reportData.headers) {
              reportData.headers.forEach(header => {
                  html += `<th>${header}</th>`;
              });
          }
          html += '</tr></thead><tbody>';
          
          // 產生資料行
          if (reportData.data) {
              reportData.data.forEach(row => {
                  html += '<tr>';
                  Object.values(row).forEach(cell => {
                      html += `<td>${cell}</td>`;
                  });
                  html += '</tr>';
              });
          }
          
          html += '</tbody></table></div>';
          
          // 加入統計摘要
          if (reportData.summary) {
              html += '<div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">';
              html += '<h4>統計摘要</h4>';
              Object.entries(reportData.summary).forEach(([key, value]) => {
                  html += `<p><strong>${key}：</strong> ${value}</p>`;
              });
              html += '</div>';
          }
          
          container.innerHTML = html;
          resultDiv.style.display = 'block';
      }

      /**
       * 匯出報表
       */
      async function exportReport(format) {
          if (!currentReportData) {
              showAlert('請先產生報表', 'danger');
              return;
          }
          
          try {
              const params = {
                  format: format,
                  data: currentReportData
              };
              
              const result = await apiCall('exportReport', params);
              
              if (result.downloadUrl) {
                  // 建立下載連結
                  const link = document.createElement('a');
                  link.href = result.downloadUrl;
                  link.download = result.filename;
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
                  
                  showAlert('報表已匯出', 'success');
              } else {
                  showAlert('匯出失敗', 'danger');
              }
              
          } catch (error) {
              console.error('匯出報表失敗:', error);
              showAlert('匯出失敗：' + error.message, 'danger');
          }
      }

      /**
       * 系統管理功能
       */
      async function testConnection() {
          try {
              showAlert('測試連線中...', 'info');
              const result = await apiCall('testConnection');
              
              if (result.success) {
                  showAlert('連線測試成功', 'success');
                  updateSystemStatus(true);
              } else {
                  showAlert('連線測試失敗', 'danger');
                  updateSystemStatus(false);
              }
          } catch (error) {
              console.error('連線測試失敗:', error);
              showAlert('連線測試失敗：' + error.message, 'danger');
              updateSystemStatus(false);
          }
      }

      async function createBackup() {
          if (confirm('確定要建立系統備份嗎？此過程可能需要幾分鐘時間。')) {
              try {
                  showAlert('正在建立備份...', 'info');
                  const result = await apiCall('createBackup');
                  
                  if (result.success) {
                      showAlert('備份建立成功，檔案：' + result.filename, 'success');
                  } else {
                      showAlert('備份建立失敗', 'danger');
                  }
              } catch (error) {
                  console.error('建立備份失敗:', error);
                  showAlert('建立備份失敗：' + error.message, 'danger');
              }
          }
      }

      async function validateData() {
          try {
              showAlert('正在驗證資料...', 'info');
              const result = await apiCall('validateData');
              
              if (result.success) {
                  let message = '資料驗證完成';
                  if (result.issues && result.issues.length > 0) {
                      message += `，發現 ${result.issues.length} 個問題`;
                  }
                  showAlert(message, result.issues && result.issues.length > 0 ? 'warning' : 'success');
              } else {
                  showAlert('資料驗證失敗', 'danger');
              }
          } catch (error) {
              console.error('資料驗證失敗:', error);
              showAlert('資料驗證失敗：' + error.message, 'danger');
          }
      }

      async function cleanupSystem() {
          if (confirm('確定要執行系統清理嗎？這將清除暫存檔案和過期資料。')) {
              try {
                  showAlert('正在清理系統...', 'info');
                  const result = await apiCall('cleanupSystem');
                  
                  if (result.success) {
                      showAlert('系統清理完成', 'success');
                  } else {
                      showAlert('系統清理失敗', 'danger');
                  }
              } catch (error) {
                  console.error('系統清理失敗:', error);
                  showAlert('系統清理失敗：' + error.message, 'danger');
              }
          }
      }

      /**
       * 分頁功能
       */
      function displayPagination(containerId, pagination, loadFunction) {
          const container = document.getElementById(containerId);
          if (!container || !pagination) return;
          
          let html = '';
          
          // 上一頁按鈕
          html += `<button ${pagination.currentPage <= 1 ? 'disabled' : ''} 
                   onclick="${loadFunction.name}(${pagination.currentPage - 1})">
                   <i class="fas fa-chevron-left"></i> 上一頁
                   </button>`;
          
          // 頁碼按鈕
          for (let i = Math.max(1, pagination.currentPage - 2); 
               i <= Math.min(pagination.totalPages, pagination.currentPage + 2); 
               i++) {
              html += `<button class="${i === pagination.currentPage ? 'current-page' : ''}" 
                       onclick="${loadFunction.name}(${i})">${i}</button>`;
          }
          
          // 下一頁按鈕
          html += `<button ${pagination.currentPage >= pagination.totalPages ? 'disabled' : ''} 
                   onclick="${loadFunction.name}(${pagination.currentPage + 1})">
                   下一頁 <i class="fas fa-chevron-right"></i>
                   </button>`;
          
          container.innerHTML = html;
      }

      /**
       * 載入和隱藏載入動畫
       */
      function showLoading(loadingId) {
          const loading = document.getElementById(loadingId);
          if (loading) {
              loading.style.display = 'block';
          }
      }

      function hideLoading(loadingId) {
          const loading = document.getElementById(loadingId);
          if (loading) {
              loading.style.display = 'none';
          }
      }

      /**
       * 顯示警告訊息
       */
      function showAlert(message, type = 'info') {
          // 移除現有的警告
          const existingAlert = document.querySelector('.alert');
          if (existingAlert) {
              existingAlert.remove();
          }
          
          // 建立新的警告
          const alert = document.createElement('div');
          alert.className = `alert alert-${type}`;
          alert.innerHTML = `
              <i class="fas fa-${getAlertIcon(type)}"></i>
              ${message}
              <button type="button" class="close" onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
          `;
          
          // 插入到內容區域的頂部
          const contentArea = document.querySelector('.content-area');
          contentArea.insertBefore(alert, contentArea.firstChild);
          
          // 3秒後自動移除（除了錯誤訊息）
          if (type !== 'danger') {
              setTimeout(() => {
                  if (alert.parentElement) {
                      alert.remove();
                  }
              }, 3000);
          }
      }

      /**
       * 取得警告圖示
       */
      function getAlertIcon(type) {
          switch(type) {
              case 'success': return 'check-circle';
              case 'danger': return 'exclamation-triangle';
              case 'warning': return 'exclamation-circle';
              case 'info': return 'info-circle';
              default: return 'info-circle';
          }
      }

      /**
       * 格式化日期
       */
      function formatDate(dateString) {
          if (!dateString) return '';
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW');
      }

      /**
       * 格式化金額
       */
      function formatCurrency(amount) {
          if (amount === null || amount === undefined) return 'NT$ 0';
          return 'NT$ ' + Number(amount).toLocaleString();
      }

      /**
       * 設定預設日期
       */
      function setDefaultDates() {
          const today = new Date().toISOString().split('T')[0];
          
          // 設定所有日期欄位的預設值為今天
          const dateInputs = document.querySelectorAll('input[type="date"]');
          dateInputs.forEach(input => {
              if (!input.value) {
                  input.value = today;
              }
          });
      }

      /**
       * 取得當前收據ID（用於列印和寄送）
       */
      function getCurrentReceiptId() {
          // 這個函數需要根據實際情況實作
          // 可能從模態框或其他地方取得當前選中的收據ID
          return null;
      }

      /**
       * 鍵盤快捷鍵
       */
      document.addEventListener('keydown', function(e) {
          // ESC 關閉模態框
          if (e.key === 'Escape') {
              const modals = document.querySelectorAll('.modal');
              modals.forEach(modal => {
                  if (modal.style.display === 'block') {
                      modal.style.display = 'none';
                      document.body.style.overflow = 'auto';
                  }
              });
          }
          
          // Ctrl + S 儲存（防止瀏覽器預設行為）
          if (e.ctrlKey && e.key === 's') {
              e.preventDefault();
              // 可以在這裡加入儲存邏輯
          }
          
          // Ctrl + P 列印
          if (e.ctrlKey && e.key === 'p') {
              e.preventDefault();
              if (document.getElementById('receiptPreviewModal').style.display === 'block') {
                  printReceipt();
              }
          }
      });

      /**
       * 點擊模態框外部關閉
       */
      document.addEventListener('click', function(e) {
          if (e.target.classList.contains('modal')) {
              e.target.style.display = 'none';
              document.body.style.overflow = 'auto';
          }
      });

      /**
       * 自動儲存草稿功能（可選）
       */
      function setupAutoSave() {
          const forms = document.querySelectorAll('form');
          forms.forEach(form => {
              const inputs = form.querySelectorAll('input, select, textarea');
              inputs.forEach(input => {
                  input.addEventListener('input', function() {
                      // 可以在這裡實作自動儲存草稿的邏輯
                      const formData = new FormData(form);
                      const draftKey = `draft_${form.id}`;
                      const draftData = {};
                      
                      for (let [key, value] of formData.entries()) {
                          draftData[key] = value;
                      }
                      
                      localStorage.setItem(draftKey, JSON.stringify(draftData));
                  });
              });
          });
      }

      /**
       * 載入草稿功能（可選）
       */
      function loadDrafts() {
          const forms = document.querySelectorAll('form');
          forms.forEach(form => {
              const draftKey = `draft_${form.id}`;
              const draftData = localStorage.getItem(draftKey);
              
              if (draftData) {
                  try {
                      const data = JSON.parse(draftData);
                      Object.entries(data).forEach(([key, value]) => {
                          const input = form.querySelector(`[name="${key}"]`);
                          if (input) {
                              input.value = value;
                          }
                      });
                  } catch (error) {
                      console.error('載入草稿失敗:', error);
                  }
              }
          });
      }

      /**
       * 清除草稿
       */
      function clearDraft(formId) {
          const draftKey = `draft_${formId}`;
          localStorage.removeItem(draftKey);
      }

      /**
       * 匯出資料功能
       */
      async function exportData(type, format = 'csv') {
          try {
              showAlert('正在匯出資料...', 'info');
              
              const result = await apiCall('exportData', {
                  type: type,
                  format: format
              });
              
              if (result.success && result.downloadUrl) {
                  const link = document.createElement('a');
                  link.href = result.downloadUrl;
                  link.download = result.filename;
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
                  
                  showAlert('資料匯出成功', 'success');
              } else {
                  showAlert('資料匯出失敗', 'danger');
              }
          } catch (error) {
              console.error('匯出資料失敗:', error);
              showAlert('匯出失敗：' + error.message, 'danger');
          }
      }

      /**
       * 匯入資料功能
       */
      function setupDataImport() {
          const importButton = document.createElement('button');
          importButton.className = 'btn btn-info';
          importButton.innerHTML = '<i class="fas fa-upload"></i> 匯入資料';
          importButton.onclick = function() {
              const input = document.createElement('input');
              input.type = 'file';
              input.accept = '.csv,.xlsx,.xls';
              input.onchange = handleFileImport;
              input.click();
          };
          
          // 可以將按鈕加入到適當的位置
      }

      /**
       * 處理檔案匯入
       */
      async function handleFileImport(event) {
          const file = event.target.files[0];
          if (!file) return;
          
          try {
              showAlert('正在匯入資料...', 'info');
              
              const formData = new FormData();
              formData.append('file', file);
              
              const response = await fetch(CONFIG.API_URL + '?action=importData', {
                  method: 'POST',
                  body: formData
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showAlert(`資料匯入成功，共處理 ${result.recordCount} 筆記錄`, 'success');
                  // 重新載入當前頁面資料
                  loadPageData(currentPage);
              } else {
                  showAlert('資料匯入失敗：' + result.message, 'danger');
              }
          } catch (error) {
              console.error('匯入資料失敗:', error);
              showAlert('匯入失敗：' + error.message, 'danger');
          }
      }

      /**
       * 系統初始化完成後的最終設定
       */
      function finalizeSystemSetup() {
          // 設定自動儲存（如果需要）
          // setupAutoSave();
          
          // 載入草稿（如果需要）
          // loadDrafts();
          
          // 設定資料匯入功能（如果需要）
          // setupDataImport();
          
          // 定期檢查系統狀態
          setInterval(checkSystemStatus, 300000); // 每5分鐘檢查一次
          
          console.log('台灣帕金森病友權益促進會會計系統 v5.0 初始化完成');
          showAlert('系統載入完成', 'success');
      }

      // 在頁面載入完成後執行最終設定
      window.addEventListener('load', function() {
          setTimeout(finalizeSystemSetup, 1000);
      });

      /**
       * 錯誤處理和日誌記錄
       */
      window.addEventListener('error', function(e) {
          console.error('系統錯誤:', e.error);
          showAlert('系統發生錯誤，請重新整理頁面', 'danger');
      });

      /**
       * 離線檢測
       */
      window.addEventListener('online', function() {
          updateSystemStatus(true);
          showAlert('網路連線已恢復', 'success');
      });

      window.addEventListener('offline', function() {
          updateSystemStatus(false);
          showAlert('網路連線中斷', 'warning');
      });

      // 確保所有功能都已正確載入
      console.log('台灣帕金森病友權益促進會會計系統前端 v5.0 載入完成');
  </script>
</body>
</html>
