<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣帕金森病友權益促進會 - 會計管理系統 v4.0</title>
    
    <!-- CSS 框架 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #28a745;
            --accent-color: #ffc107;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --dark-text: #343a40;
            --border-color: #dee2e6;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
        }

        /* 頁面載入動畫 */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), #1e4080);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .page-loader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader-content {
            text-align: center;
            color: white;
        }

        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 主要佈局 */
        .main-header {
            background: linear-gradient(135deg, var(--primary-color), #1e4080);
            color: white;
            padding: 1rem 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .main-header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .main-header .subtitle {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .system-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.85rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* 導航選單 */
        .main-nav {
            background: white;
            border-bottom: 3px solid var(--primary-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 80px;
            z-index: 999;
        }

        .nav-tabs {
            border-bottom: none;
        }

        .nav-tabs .nav-link {
            color: var(--dark-text);
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            border-radius: 0;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
            background-color: rgba(44, 90, 160, 0.05);
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: white;
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }

        .nav-tabs .nav-link i {
            margin-right: 0.5rem;
        }

        /* 主要內容區 */
        .main-content {
            padding: 2rem 0;
            min-height: calc(100vh - 200px);
        }

        /* 卡片樣式 */
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), #1e4080);
            color: white;
            border: none;
            padding: 1.5rem;
            font-weight: 600;
        }

        .card-header h5 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body {
            padding: 2rem;
        }

        /* 統計卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .stat-icon::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            opacity: 0.1;
            transform: scale(1.2);
        }

        .stat-icon.income {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .stat-icon.expense {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            color: white;
        }

        .stat-icon.receipt {
            background: linear-gradient(135deg, var(--primary-color), #6f42c1);
            color: white;
        }

        .stat-icon.member {
            background: linear-gradient(135deg, var(--accent-color), #fd7e14);
            color: white;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark-text);
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .stat-label {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-change {
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive {
            color: var(--secondary-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        /* 表單樣式 */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-control, .form-select {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: white;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25);
            outline: none;
        }

        .form-control.is-invalid {
            border-color: var(--danger-color);
        }

        .form-control.is-valid {
            border-color: var(--secondary-color);
        }

        .invalid-feedback {
            display: block;
            color: var(--danger-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .required {
            color: var(--danger-color);
        }

        /* 按鈕樣式 */
        .btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #1e4080);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1e4080, var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 90, 160, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--secondary-color), #1e7e34);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #1e7e34, var(--secondary-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--accent-color), #e0a800);
            color: #212529;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #e0a800, var(--accent-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #c82333);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333, var(--danger-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        .btn-outline-primary {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.125rem;
        }

        /* 表格樣式 */
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .table {
            margin: 0;
            border-radius: 15px;
        }

        .table thead th {
            background: linear-gradient(135deg, var(--primary-color), #1e4080);
            color: white;
            font-weight: 600;
            border: none;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table tbody td {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .table tbody tr {
            transition: background-color 0.2s ease;
        }

        .table tbody tr:hover {
            background-color: rgba(44, 90, 160, 0.05);
        }

        .table tbody tr:nth-child(even) {
            background-color: rgba(248, 249, 250, 0.5);
        }

        /* 狀態標籤 */
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: currentColor;
        }

        .status-success {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--secondary-color);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .status-pending {
            background-color: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .status-danger {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .status-info {
            background-color: rgba(44, 90, 160, 0.1);
            color: var(--primary-color);
            border: 1px solid rgba(44, 90, 160, 0.3);
        }

        /* 操作按鈕組 */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            padding: 0.5rem;
            min-width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        /* 搜尋框 */
        .search-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-container input {
            padding-left: 3rem;
        }

        .search-container .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 5;
        }

        /* 提示訊息 */
        .alert {
            border: none;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid;
            position: relative;
            overflow: hidden;
        }

        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, currentColor, transparent);
        }

        .alert-success {
            background-color: rgba(40, 167, 69, 0.1);
            border-left-color: var(--secondary-color);
            color: #155724;
        }

        .alert-danger {
            background-color: rgba(220, 53, 69, 0.1);
            border-left-color: var(--danger-color);
            color: #721c24;
        }

        .alert-warning {
            background-color: rgba(255, 193, 7, 0.1);
            border-left-color: var(--accent-color);
            color: #856404;
        }

        .alert-info {
            background-color: rgba(44, 90, 160, 0.1);
            border-left-color: var(--primary-color);
            color: #0c5460;
        }

        .alert-dismissible {
            padding-right: 3rem;
        }

        .alert .btn-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.5rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            opacity: 0.7;
        }

        /* 模態視窗 */
        .modal-content {
            border: none;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #1e4080);
            color: white;
            border: none;
            padding: 1.5rem 2rem;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1.25rem;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            border-top: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            background-color: #f8f9fa;
        }

        .btn-close {
            filter: invert(1);
            opacity: 0.8;
        }

        .btn-close:hover {
            opacity: 1;
        }

        /* 載入動畫 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        /* 進度條 */
        .progress {
            height: 10px;
            border-radius: 10px;
            background-color: rgba(44, 90, 160, 0.1);
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        /* 檔案上傳區域 */
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 15px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: linear-gradient(45deg, #f8f9fa, #ffffff);
        }

        .file-upload-area:hover {
            border-color: var(--primary-color);
            background: linear-gradient(45deg, rgba(44, 90, 160, 0.05), rgba(44, 90, 160, 0.02));
        }

        .file-upload-area.dragover {
            border-color: var(--secondary-color);
            background: linear-gradient(45deg, rgba(40, 167, 69, 0.05), rgba(40, 167, 69, 0.02));
            transform: scale(1.02);
        }

        .file-upload-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .main-header h1 {
                font-size: 1.5rem;
            }
            
            .main-header .subtitle {
                font-size: 0.8rem;
            }
            
            .nav-tabs .nav-link {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1.5rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .table-responsive {
                font-size: 0.85rem;
            }
            
            .card-body {
                padding: 1.5rem;
            }
            
            .modal-body {
                padding: 1.5rem;
            }
        }

        @media (max-width: 576px) {
            .main-content {
                padding: 1rem 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .action-buttons .btn {
                width: auto;
                min-width: 40px;
            }
        }

        /* 動畫效果 */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(0);
            }
        }

        /* 工具提示 */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* 頁尾 */
        .main-footer {
            background: var(--dark-text);
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-top: 3rem;
        }

        .main-footer a {
            color: #adb5bd;
            text-decoration: none;
        }

        .main-footer a:hover {
            color: white;
        }

        /* 自定義滾動條 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #1e4080, #1e7e34);
        }

        /* 打印樣式 */
        @media print {
            .main-header,
            .main-nav,
            .main-footer,
            .btn,
            .action-buttons {
                display: none !important;
            }
            
            .main-content {
                padding: 0;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <!-- 頁面載入器 -->
    <div id="pageLoader" class="page-loader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <h4>系統載入中...</h4>
            <p>請稍候，正在初始化會計管理系統</p>
        </div>
    </div>

    <!-- 主要標題 -->
    <header class="main-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-calculator me-2"></i>台灣帕金森病友權益促進會</h1>
                    <p class="subtitle">增強版會計管理系統 v4.0 - 專業財務管理解決方案</p>
                </div>
                <div class="col-md-4">
                    <div class="system-status">
                        <div class="status-indicator"></div>
                        <span>系統運行正常</span>
                        <span id="currentTime" class="ms-3"></span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 主要導航 -->
    <nav class="main-nav">
        <div class="container">
            <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" 
                            data-bs-target="#dashboard" type="button" role="tab">
                        <i class="fas fa-tachometer-alt"></i>儀表板
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="transaction-tab" data-bs-toggle="tab" 
                            data-bs-target="#transaction" type="button" role="tab">
                        <i class="fas fa-exchange-alt"></i>交易記錄
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="receipt-tab" data-bs-toggle="tab" 
                            data-bs-target="#receipt" type="button" role="tab">
                        <i class="fas fa-receipt"></i>收據管理
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="member-tab" data-bs-toggle="tab" 
                            data-bs-target="#member" type="button" role="tab">
                        <i class="fas fa-users"></i>會員管理
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="report-tab" data-bs-toggle="tab" 
                            data-bs-target="#report" type="button" role="tab">
                        <i class="fas fa-chart-bar"></i>報表分析
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" 
                            data-bs-target="#settings" type="button" role="tab">
                        <i class="fas fa-cog"></i>系統設定
                    </button>
                </li>
            </ul>
        </div>
    </nav>

    <!-- 主要內容 -->
    <main class="main-content">
        <div class="container">
            <!-- 全域訊息顯示區 -->
            <div id="globalMessage"></div>
            
            <!-- 分頁內容 -->
            <div class="tab-content fade-in" id="mainTabContent">
                
                <!-- 儀表板 -->
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                    <!-- 統計卡片 -->
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <div class="stat-icon income">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <div class="stat-value" id="totalIncome">$0</div>
                            <div class="stat-label">本月收入</div>
                            <div class="stat-change positive" id="incomeChange">
                                <i class="fas fa-arrow-up"></i>
                                <span>+0%</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon expense">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                            <div class="stat-value" id="totalExpense">$0</div>
                            <div class="stat-label">本月支出</div>
                            <div class="stat-change negative" id="expenseChange">
                                <i class="fas fa-arrow-down"></i>
                                <span>-0%</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon receipt">
                                <i class="fas fa-file-invoice"></i>
                            </div>
                            <div class="stat-value" id="receiptCount">0</div>
                            <div class="stat-label">本月收據</div>
                            <div class="stat-change positive" id="receiptChange">
                                <i class="fas fa-plus"></i>
                                <span>+0</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon member">
                                <i class="fas fa-user-friends"></i>
                            </div>
                            <div class="stat-value" id="memberCount">0</div>
                            <div class="stat-label">會員總數</div>
                            <div class="stat-change positive" id="memberChange">
                                <i class="fas fa-user-plus"></i>
                                <span>+0</span>
                            </div>
                        </div>
                    </div>

                    <!-- 快速操作區 -->
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-clock me-2"></i>最近活動</h5>
                                </div>
                                <div class="card-body">
                                    <div id="recentActivities">
                                        <div class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                            <p>載入中...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-bolt me-2"></i>快速操作</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-3">
                                        <button class="btn btn-primary" onclick="showTransactionForm()">
                                            <i class="fas fa-plus me-2"></i>新增交易
                                        </button>
                                        <button class="btn btn-success" onclick="showReceiptForm()">
                                            <i class="fas fa-receipt me-2"></i>開立收據
                                        </button>
                                        <button class="btn btn-warning" onclick="showMemberForm()">
                                            <i class="fas fa-user-plus me-2"></i>新增會員
                                        </button>
                                        <button class="btn btn-info" onclick="generateReport()">
                                            <i class="fas fa-chart-line me-2"></i>生成報表
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 交易記錄 -->
                <div class="tab-pane fade" id="transaction" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-plus me-2"></i>新增交易記錄</h5>
                                </div>
                                <div class="card-body">
                                    <form id="transactionForm">
                                        <div class="form-group">
                                            <label class="form-label">交易日期 <span class="required">*</span></label>
                                            <input type="date" class="form-control" id="transactionDate" required>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">姓名 <span class="required">*</span></label>
                                            <input type="text" class="form-control" id="transactionName" 
                                                   placeholder="請輸入姓名" required>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">交易類型 <span class="required">*</span></label>
                                            <select class="form-select" id="transactionType" required>
                                                <option value="">請選擇類型</option>
                                                <option value="收入">收入</option>
                                                <option value="支出">支出</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">類別 <span class="required">*</span></label>
                                            <select class="form-select" id="transactionCategory" required>
                                                <option value="">請選擇類別</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">帳戶</label>
                                            <select class="form-select" id="transactionAccount">
                                                <option value="">請選擇帳戶</option>
                                                <option value="現金">現金</option>
                                                <option value="銀行-第一銀行">銀行-第一銀行</option>
                                                <option value="銀行-台灣銀行">銀行-台灣銀行</option>
                                                <option value="郵局">郵局</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">金額 <span class="required">*</span></label>
                                            <input type="number" class="form-control" id="transactionAmount" 
                                                   placeholder="請輸入金額" min="0" step="1" required>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">說明</label>
                                            <textarea class="form-control" id="transactionDescription" 
                                                      rows="3" placeholder="請輸入說明"></textarea>
                                        </div>

                                        <!-- 收入相關選項 -->
                                        <div id="incomeOptions" style="display: none;">
                                            <div class="form-group">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" 
                                                           id="generateReceipt" value="true">
                                                    <label class="form-check-label" for="generateReceipt">
                                                        自動開立收據
                                                    </label>
                                                </div>
                                            </div>

                                            <div id="receiptDetails" style="display: none;">
                                                <div class="form-group">
                                                    <label class="form-label">電子郵件</label>
                                                    <input type="email" class="form-control" id="payerEmail" 
                                                           placeholder="收據寄送信箱">
                                                </div>

                                                <div class="form-group">
                                                    <label class="form-label">電話</label>
                                                    <input type="tel" class="form-control" id="payerPhone" 
                                                           placeholder="聯絡電話">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 支出相關選項 -->
                                        <div id="expenseOptions" style="display: none;">
                                            <div class="form-group">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" 
                                                           id="generateVoucher" value="true">
                                                    <label class="form-check-label" for="generateVoucher">
                                                        生成支出憑證
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-primary btn-lg">
                                                <i class="fas fa-save me-2"></i>儲存交易記錄
                                            </button>
                                            <button type="button" class="btn btn-outline-primary" 
                                                    onclick="clearTransactionForm()">
                                                <i class="fas fa-eraser me-2"></i>清除表單
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-list me-2"></i>交易記錄列表</h5>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-primary btn-sm" onclick="refreshTransactions()">
                                            <i class="fas fa-sync-alt me-1"></i>重新整理
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="exportTransactions()">
                                            <i class="fas fa-download me-1"></i>匯出
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- 搜尋與篩選 -->
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <div class="search-container">
                                                <i class="fas fa-search search-icon"></i>
                                                <input type="text" class="form-control" id="transactionSearch" 
                                                       placeholder="搜尋姓名、說明或類別...">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-select" id="typeFilter">
                                                <option value="">全部類型</option>
                                                <option value="收入">收入</option>
                                                <option value="支出">支出</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="date" class="form-control" id="dateFromFilter">
                                        </div>
                                        <div class="col-md-3">
                                            <input type="date" class="form-control" id="dateToFilter">
                                        </div>
                                    </div>

                                    <!-- 交易記錄表格 -->
                                    <div class="table-responsive">
                                        <div id="transactionTableContainer">
                                            <div class="text-center py-4">
                                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                                <p>載入交易記錄中...</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 分頁導航 -->
                                    <nav aria-label="交易記錄分頁" class="mt-3">
                                        <ul class="pagination justify-content-center" id="transactionPagination">
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 收據管理 -->
                <div class="tab-pane fade" id="receipt" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-receipt me-2"></i>開立收據</h5>
                                </div>
                                <div class="card-body">
                                    <form id="receiptForm">
                                        <div class="form-group">
                                            <label class="form-label">收據日期 <span class="required">*</span></label>
                                            <input type="date" class="form-control" id="receiptDate" required>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">付款人 <span class="required">*</span></label>
                                            <input type="text" class="form-control" id="receiptPayer" 
                                                   placeholder="請輸入付款人姓名" required>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">身分</label>
                                            <select class="form-select" id="receiptIdentity">
                                                <option value="會員">會員</option>
                                                <option value="非會員">非會員</option>
                                                <option value="企業">企業</option>
                                                <option value="其他">其他</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">聯絡電話</label>
                                            <input type="tel" class="form-control" id="receiptPhone" 
                                                   placeholder="請輸入聯絡電話">
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">電子郵件</label>
                                            <input type="email" class="form-control" id="receiptEmail" 
                                                   placeholder="收據寄送信箱">
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">收款類別 <span class="required">*</span></label>
                                            <select class="form-select" id="receiptCategory" required>
                                                <option value="">請選擇類別</option>
                                                <option value="會費">會費</option>
                                                <option value="捐款">捐款</option>
                                                <option value="活動費用">活動費用</option>
                                                <option value="其他收入">其他收入</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">金額 <span class="required">*</span></label>
                                            <input type="number" class="form-control" id="receiptAmount" 
                                                   placeholder="請輸入金額" min="0" step="1" required>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">用途說明</label>
                                            <textarea class="form-control" id="receiptDescription" 
                                                      rows="3" placeholder="請輸入用途說明"></textarea>
                                        </div>

                                        <div class="form-group">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="autoSendEmail" checked>
                                                <label class="form-check-label" for="autoSendEmail">
                                                    自動寄送電子收據
                                                </label>
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-success btn-lg">
                                                <i class="fas fa-file-invoice me-2"></i>開立收據
                                            </button>
                                            <button type="button" class="btn btn-outline-primary" 
                                                    onclick="clearReceiptForm()">
                                                <i class="fas fa-eraser me-2"></i>清除表單
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-file-invoice me-2"></i>收據記錄</h5>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-primary btn-sm" onclick="refreshReceipts()">
                                            <i class="fas fa-sync-alt me-1"></i>重新整理
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="exportReceipts()">
                                            <i class="fas fa-download me-1"></i>匯出
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- 搜尋與篩選 -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="search-container">
                                                <i class="fas fa-search search-icon"></i>
                                                <input type="text" class="form-control" id="receiptSearch" 
                                                       placeholder="搜尋收據編號、付款人...">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" id="receiptStatusFilter">
                                                <option value="">全部狀態</option>
                                                <option value="已開立">已開立</option>
                                                <option value="已寄送">已寄送</option>
                                                <option value="已列印">已列印</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" id="receiptCategoryFilter">
                                                <option value="">全部類別</option>
                                                <option value="會費">會費</option>
                                                <option value="捐款">捐款</option>
                                                <option value="活動費用">活動費用</option>
                                                <option value="其他收入">其他收入</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- 收據記錄表格 -->
                                    <div class="table-responsive">
                                        <div id="receiptTableContainer">
                                            <div class="text-center py-4">
                                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                                <p>載入收據記錄中...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 會員管理 -->
                <div class="tab-pane fade" id="member" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-user-plus me-2"></i>新增會員</h5>
                                </div>
                                <div class="card-body">
                                    <form id="memberForm">
                                        <div class="form-group">
                                            <label class="form-label">姓名 <span class="required">*</span></label>
                                            <input type="text" class="form-control" id="memberName" 
                                                   placeholder="請輸入姓名" required>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label">性別</label>
                                                <select class="form-select" id="memberGender">
                                                    <option value="">請選擇</option>
                                                    <option value="男">男</option>
                                                    <option value="女">女</option>
                                                    <option value="其他">其他</option>
                                                </select>
                                            </div>

                                            <div class="form-group">
                                                <label class="form-label">生日</label>
                                                <input type="date" class="form-control" id="memberBirthDate">
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">身分證字號</label>
                                            <input type="text" class="form-control" id="memberIdCard" 
                                                   placeholder="請輸入身分證字號" maxlength="10">
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label">電話 <span class="required">*</span></label>
                                                <input type="tel" class="form-control" id="memberPhone" 
                                                       placeholder="請輸入電話" required>
                                            </div>

                                            <div class="form-group">
                                                <label class="form-label">手機</label>
                                                <input type="tel" class="form-control" id="memberMobile" 
                                                       placeholder="請輸入手機">
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">電子郵件</label>
                                            <input type="email" class="form-control" id="memberEmail" 
                                                   placeholder="請輸入電子郵件">
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">地址</label>
                                            <textarea class="form-control" id="memberAddress" 
                                                      rows="2" placeholder="請輸入地址"></textarea>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label">緊急聯絡人</label>
                                                <input type="text" class="form-control" id="memberEmergencyContact" 
                                                       placeholder="請輸入緊急聯絡人">
                                            </div>

                                            <div class="form-group">
                                                <label class="form-label">緊急聯絡電話</label>
                                                <input type="tel" class="form-control" id="memberEmergencyPhone" 
                                                       placeholder="請輸入緊急聯絡電話">
                                            </div>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label">入會日期</label>
                                                <input type="date" class="form-control" id="memberJoinDate">
                                            </div>

                                            <div class="form-group">
                                                <label class="form-label">會員類型 <span class="required">*</span></label>
                                                <select class="form-select" id="memberType" required>
                                                    <option value="">請選擇</option>
                                                    <option value="一般會員">一般會員</option>
                                                    <option value="贊助會員">贊助會員</option>
                                                    <option value="榮譽會員">榮譽會員</option>
                                                    <option value="終身會員">終身會員</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">會費狀態</label>
                                            <select class="form-select" id="memberFeeStatus">
                                                <option value="未繳費">未繳費</option>
                                                <option value="已繳費">已繳費</option>
                                                <option value="部分繳費">部分繳費</option>
                                                <option value="免繳費">免繳費</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">備註</label>
                                            <textarea class="form-control" id="memberNotes" 
                                                      rows="3" placeholder="請輸入備註"></textarea>
                                        </div>

                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-primary btn-lg">
                                                <i class="fas fa-user-plus me-2"></i>新增會員
                                            </button>
                                            <button type="button" class="btn btn-outline-primary" 
                                                    onclick="clearMemberForm()">
                                                <i class="fas fa-eraser me-2"></i>清除表單
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-users me-2"></i>會員列表</h5>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-primary btn-sm" onclick="refreshMembers()">
                                            <i class="fas fa-sync-alt me-1"></i>重新整理
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="exportMembers()">
                                            <i class="fas fa-download me-1"></i>匯出
                                        </button>
                                        <button class="btn btn-info btn-sm" onclick="importMembers()">
                                            <i class="fas fa-upload me-1"></i>匯入
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- 搜尋與篩選 -->
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <div class="search-container">
                                                <i class="fas fa-search search-icon"></i>
                                                <input type="text" class="form-control" id="memberSearch" 
                                                       placeholder="搜尋姓名、電話、郵件...">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" id="memberTypeFilter">
                                                <option value="">全部類型</option>
                                                <option value="一般會員">一般會員</option>
                                                <option value="贊助會員">贊助會員</option>
                                                <option value="榮譽會員">榮譽會員</option>
                                                <option value="終身會員">終身會員</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" id="memberStatusFilter">
                                                <option value="">全部狀態</option>
                                                <option value="已繳費">已繳費</option>
                                                <option value="未繳費">未繳費</option>
                                                <option value="部分繳費">部分繳費</option>
                                                <option value="免繳費">免繳費</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-outline-secondary w-100" onclick="clearMemberFilters()">
                                                <i class="fas fa-times me-1"></i>清除
                                            </button>
                                        </div>
                                    </div>

                                    <!-- 會員統計 -->
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="fw-bold text-primary" id="totalMembers">0</div>
                                                <small class="text-muted">總會員數</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="fw-bold text-success" id="paidMembers">0</div>
                                                <small class="text-muted">已繳費</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="fw-bold text-warning" id="unpaidMembers">0</div>
                                                <small class="text-muted">未繳費</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="fw-bold text-info" id="newMembers">0</div>
                                                <small class="text-muted">本月新增</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 會員列表表格 -->
                                    <div class="table-responsive">
                                        <div id="memberTableContainer">
                                            <div class="text-center py-4">
                                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                                <p>載入會員資料中...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 報表分析 -->
                <div class="tab-pane fade" id="report" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-bar me-2"></i>報表設定</h5>
                                </div>
                                <div class="card-body">
                                    <form id="reportForm">
                                        <div class="form-group">
                                            <label class="form-label">報表類型</label>
                                            <select class="form-select" id="reportType">
                                                <option value="monthly">月度財務報表</option>
                                                <option value="yearly">年度財務報表</option>
                                                <option value="category">類別分析報表</option>
                                                <option value="member">會員統計報表</option>
                                                <option value="receipt">收據統計報表</option>
                                            </select>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label">年度</label>
                                                <select class="form-select" id="reportYear">
                                                    <option value="2024">2024</option>
                                                    <option value="2023">2023</option>
                                                    <option value="2022">2022</option>
                                                </select>
                                            </div>

                                            <div class="form-group" id="monthGroup">
                                                <label class="form-label">月份</label>
                                                <select class="form-select" id="reportMonth">
                                                    <option value="1">1月</option>
                                                    <option value="2">2月</option>
                                                    <option value="3">3月</option>
                                                    <option value="4">4月</option>
                                                    <option value="5">5月</option>
                                                    <option value="6">6月</option>
                                                    <option value="7">7月</option>
                                                    <option value="8">8月</option>
                                                    <option value="9">9月</option>
                                                    <option value="10">10月</option>
                                                    <option value="11">11月</option>
                                                    <option value="12">12月</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">報表格式</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="reportFormat" 
                                                       id="formatHTML" value="html" checked>
                                                <label class="form-check-label" for="formatHTML">
                                                    網頁預覽
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="reportFormat" 
                                                       id="formatPDF" value="pdf">
                                                <label class="form-check-label" for="formatPDF">
                                                    PDF 下載
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="reportFormat" 
                                                       id="formatExcel" value="excel">
                                                <label class="form-check-label" for="formatExcel">
                                                    Excel 下載
                                                </label>
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-primary btn-lg">
                                                <i class="fas fa-chart-line me-2"></i>生成報表
                                            </button>
                                            <button type="button" class="btn btn-outline-success" onclick="scheduleReport()">
                                                <i class="fas fa-clock me-2"></i>排程報表
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- 快速統計 -->
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5><i class="fas fa-tachometer-alt me-2"></i>快速統計</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6 mb-3">
                                            <div class="p-2 bg-success bg-opacity-10 rounded">
                                                <div class="fw-bold text-success" id="quickTotalIncome">$0</div>
                                                <small class="text-muted">本月收入</small>
                                            </div>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <div class="p-2 bg-danger bg-opacity-10 rounded">
                                                <div class="fw-bold text-danger" id="quickTotalExpense">$0</div>
                                                <small class="text-muted">本月支出</small>
                                            </div>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <div class="p-2 bg-primary bg-opacity-10 rounded">
                                                <div class="fw-bold text-primary" id="quickNetAmount">$0</div>
                                                <small class="text-muted">淨收入</small>
                                            </div>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <div class="p-2 bg-warning bg-opacity-10 rounded">
                                                <div class="fw-bold text-warning" id="quickReceiptCount">0</div>
                                                <small class="text-muted">收據數量</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-chart-area me-2"></i>報表預覽</h5>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-primary btn-sm" onclick="refreshReport()">
                                            <i class="fas fa-sync-alt me-1"></i>重新整理
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="printReport()">
                                            <i class="fas fa-print me-1"></i>列印
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="reportContent">
                                        <div class="text-center py-5">
                                            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">請選擇報表類型並點擊「生成報表」</h5>
                                            <p class="text-muted">系統將為您生成詳細的財務分析報表</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系統設定 -->
                <div class="tab-pane fade" id="settings" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-building me-2"></i>機構資訊設定</h5>
                                </div>
                                <div class="card-body">
                                    <form id="organizationForm">
                                        <div class="form-group">
                                            <label class="form-label">機構名稱</label>
                                            <input type="text" class="form-control" id="orgName" 
                                                   value="台灣帕金森病友權益促進會">
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">統一編號</label>
                                            <input type="text" class="form-control" id="orgTaxId" 
                                                   placeholder="請輸入統一編號">
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">機構地址</label>
                                            <textarea class="form-control" id="orgAddress" 
                                                      rows="2" placeholder="請輸入機構地址"></textarea>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label">聯絡電話</label>
                                                <input type="tel" class="form-control" id="orgPhone" 
                                                       placeholder="請輸入聯絡電話">
                                            </div>

                                            <div class="form-group">
                                                <label class="form-label">傳真號碼</label>
                                                <input type="tel" class="form-control" id="orgFax" 
                                                       placeholder="請輸入傳真號碼">
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">電子郵件</label>
                                            <input type="email" class="form-control" id="orgEmail" 
                                                   placeholder="請輸入電子郵件">
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">網站網址</label>
                                            <input type="url" class="form-control" id="orgWebsite" 
                                                   placeholder="請輸入網站網址">
                                        </div>

                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>儲存設定
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5><i class="fas fa-envelope me-2"></i>郵件設定</h5>
                                </div>
                                <div class="card-body">
                                    <form id="emailForm">
                                        <div class="form-group">
                                            <label class="form-label">寄件人名稱</label>
                                            <input type="text" class="form-control" id="emailSenderName" 
                                                   value="台灣帕金森病友權益促進會">
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">寄件人信箱</label>
                                            <input type="email" class="form-control" id="emailSenderAddress" 
                                                   placeholder="請輸入寄件人信箱">
                                        </div>

                                        <div class="form-group">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="autoSendReceipt" checked>
                                                <label class="form-check-label" for="autoSendReceipt">
                                                    自動寄送收據
                                                </label>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="emailNotification" checked>
                                                <label class="form-check-label" for="emailNotification">
                                                    啟用郵件通知
                                                </label>
                                            </div>
                                        </div>

                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>儲存設定
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-tools me-2"></i>系統管理</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-3">
                                        <button class="btn btn-info" onclick="performSystemCheck()">
                                            <i class="fas fa-stethoscope me-2"></i>系統健康檢查
                                        </button>
                                        
                                        <button class="btn btn-warning" onclick="createBackup()">
                                            <i class="fas fa-database me-2"></i>建立系統備份
                                        </button>
                                        
                                        <button class="btn btn-success" onclick="exportAllData()">
                                            <i class="fas fa-download me-2"></i>匯出全部資料
                                        </button>
                                        
                                        <button class="btn btn-primary" onclick="importData()">
                                            <i class="fas fa-upload me-2"></i>匯入資料
                                        </button>
                                        
                                        <button class="btn btn-secondary" onclick="clearCache()">
                                            <i class="fas fa-broom me-2"></i>清除快取
                                        </button>
                                        
                                        <button class="btn btn-outline-danger" onclick="resetSystem()">
                                            <i class="fas fa-redo me-2"></i>重置系統
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5><i class="fas fa-info-circle me-2"></i>系統資訊</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>系統版本：</strong></td>
                                            <td>v4.0.0</td>
                                        </tr>
                                        <tr>
                                            <td><strong>發布日期：</strong></td>
                                            <td>2024-12-19</td>
                                        </tr>
                                        <tr>
                                            <td><strong>最後更新：</strong></td>
                                            <td id="lastUpdate">載入中...</td>
                                        </tr>
                                        <tr>
                                            <td><strong>資料庫狀態：</strong></td>
                                            <td><span class="status-badge status-success">正常</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>系統狀態：</strong></td>
                                            <td><span class="status-badge status-success">運行中</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>使用者權限：</strong></td>
                                            <td><span class="status-badge status-info">管理員</span></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5><i class="fas fa-question-circle me-2"></i>說明與支援</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" onclick="showUserManual()">
                                            <i class="fas fa-book me-2"></i>使用手冊
                                        </button>
                                        
                                        <button class="btn btn-outline-success" onclick="showSystemTutorial()">
                                            <i class="fas fa-graduation-cap me-2"></i>系統教學
                                        </button>
                                        
                                        <button class="btn btn-outline-info" onclick="contactSupport()">
                                            <i class="fas fa-headset me-2"></i>技術支援
                                        </button>
                                        
                                        <button class="btn btn-outline-warning" onclick="reportBug()">
                                            <i class="fas fa-bug me-2"></i>回報問題
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 頁尾 -->
    <footer class="main-footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p>&copy; 2024 台灣帕金森病友權益促進會. 版權所有.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>會計管理系統 v4.0 | 技術支援: <a href="mailto:support@example.com">support@example.com</a></p>
                </div>
            </div>
        </div>
    </footer>

    <!-- 載入覆蓋層 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h5>處理中...</h5>
            <p id="loadingMessage">請稍候</p>
        </div>
    </div>

    <!-- 模態視窗 -->
    <!-- 交易詳情模態 -->
    <div class="modal fade" id="transactionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">交易詳情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="transactionModalBody">
                    <!-- 動態內容 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    <button type="button" class="btn btn-primary" onclick="editTransaction()">編輯</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 收據詳情模態 -->
    <div class="modal fade" id="receiptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">收據詳情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="receiptModalBody">
                    <!-- 動態內容 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    <button type="button" class="btn btn-info" onclick="downloadReceipt()">下載PDF</button>
                    <button type="button" class="btn btn-success" onclick="resendReceipt()">重新寄送</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 會員詳情模態 -->
    <div class="modal fade" id="memberModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">會員詳情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="memberModalBody">
                    <!-- 動態內容 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    <button type="button" class="btn btn-primary" onclick="editMember()">編輯</button>
                    <button type="button" class="btn btn-warning" onclick="renewMembership()">續會</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 確認刪除模態 -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>確認刪除
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteConfirmMessage">您確定要刪除這筆記錄嗎？此操作無法復原。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">確認刪除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript 函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <script>
        // ========================================
        // 全域變數和設定
        // ========================================
        
        let currentData = {
            transactions: [],
            receipts: [],
            members: [],
            dashboardStats: {}
        };

        let currentFilters = {
            transactions: {},
            receipts: {},
            members: {}
        };

        let currentPage = {
            transactions: 1,
            receipts: 1,
            members: 1
        };

        const ITEMS_PER_PAGE = 20;

        // ========================================
        // 系統初始化
        // ========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('系統載入開始...');
            
            // 初始化系統
            initializeSystem();
            
            // 設定事件監聽器
            setupEventListeners();
            
            // 載入初始資料
            loadInitialData();
            
            // 隱藏載入器
            setTimeout(() => {
                document.getElementById('pageLoader').classList.add('hidden');
            }, 1500);
        });

        async function initializeSystem() {
            try {
                // 設定當前時間顯示
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                
                // 設定表單預設值
                setFormDefaults();
                
                // 初始化圖表
                initializeCharts();
                
                console.log('系統初始化完成');
                
            } catch (error) {
                console.error('系統初始化失敗:', error);
                showAlert('系統初始化失敗，請重新整理頁面', 'danger');
            }
        }

        function setupEventListeners() {
            // 分頁切換事件
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    const target = e.target.getAttribute('data-bs-target');
                    handleTabChange(target);
                });
            });

            // 表單提交事件
            setupFormHandlers();
            
            // 搜尋和篩選事件
            setupFilterHandlers();
            
            // 其他互動事件
            setupOtherHandlers();
        }

        function setupFormHandlers() {
            // 交易表單
            document.getElementById('transactionForm').addEventListener('submit', handleTransactionSubmit);
            
            // 收據表單
            document.getElementById('receiptForm').addEventListener('submit', handleReceiptSubmit);
            
            // 會員表單
            document.getElementById('memberForm').addEventListener('submit', handleMemberSubmit);
            
            // 報表表單
            document.getElementById('reportForm').addEventListener('submit', handleReportSubmit);

            // 交易類型變更
            document.getElementById('transactionType').addEventListener('change', handleTransactionTypeChange);
            
            // 收據自動生成選項
            document.getElementById('generateReceipt').addEventListener('change', toggleReceiptDetails);
        }

        function setupFilterHandlers() {
            // 交易搜尋和篩選
            document.getElementById('transactionSearch').addEventListener('input', debounce(filterTransactions, 300));
            document.getElementById('typeFilter').addEventListener('change', filterTransactions);
            document.getElementById('dateFromFilter').addEventListener('change', filterTransactions);
            document.getElementById('dateToFilter').addEventListener('change', filterTransactions);

            // 收據搜尋和篩選
            document.getElementById('receiptSearch').addEventListener('input', debounce(filterReceipts, 300));
            document.getElementById('receiptStatusFilter').addEventListener('change', filterReceipts);
            document.getElementById('receiptCategoryFilter').addEventListener('change', filterReceipts);

            // 會員搜尋和篩選
            document.getElementById('memberSearch').addEventListener('input', debounce(filterMembers, 300));
            document.getElementById('memberTypeFilter').addEventListener('change', filterMembers);
            document.getElementById('memberStatusFilter').addEventListener('change', filterMembers);
        }

        function setupOtherHandlers() {
            // 報表類型變更
            document.getElementById('reportType').addEventListener('change', handleReportTypeChange);
            
            // 視窗大小變更
            window.addEventListener('resize', debounce(handleWindowResize, 250));
        }

        async function loadInitialData() {
            try {
                showLoading('載入系統資料中...');
                
                // 載入儀表板資料
                await loadDashboardData();
                
                // 載入交易記錄
                await loadTransactions();
                
                hideLoading();
                
            } catch (error) {
                console.error('載入初始資料失敗:', error);
                hideLoading();
                showAlert('載入資料失敗，請檢查網路連線', 'danger');
            }
        }

        // ========================================
        // 儀表板功能
        // ========================================
        
        async function loadDashboardData() {
            try {
                const response = await callGoogleScript('getDashboardStats');
                
                if (response.success) {
                    currentData.dashboardStats = response.data;
                    updateDashboardStats(response.data);
                    await loadRecentActivities();
                } else {
                    throw new Error(response.error || '載入儀表板資料失敗');
                }
                
            } catch (error) {
                console.error('載入儀表板資料失敗:', error);
                showAlert('載入儀表板資料失敗', 'warning');
            }
        }

        function updateDashboardStats(stats) {
            // 更新統計數字
            document.getElementById('totalIncome').textContent = formatCurrency(stats.totalIncome || 0);
            document.getElementById('totalExpense').textContent = formatCurrency(stats.totalExpense || 0);
            document.getElementById('receiptCount').textContent = stats.receiptCount || 0;
            document.getElementById('memberCount').textContent = stats.memberCount || 0;

            // 更新快速統計
            document.getElementById('quickTotalIncome').textContent = formatCurrency(stats.totalIncome || 0);
            document.getElementById('quickTotalExpense').textContent = formatCurrency(stats.totalExpense || 0);
            document.getElementById('quickNetAmount').textContent = formatCurrency((stats.totalIncome || 0) - (stats.totalExpense || 0));
            document.getElementById('quickReceiptCount').textContent = stats.receiptCount || 0;

            // 更新變化百分比
            updateStatChanges(stats);
        }

        function updateStatChanges(stats) {
            const incomeChange = stats.incomeChange || 0;
            const expenseChange = stats.expenseChange || 0;
            const receiptChange = stats.receiptChange || 0;
            const memberChange = stats.memberChange || 0;

            updateChangeElement('incomeChange', incomeChange, true);
            updateChangeElement('expenseChange', expenseChange, false);
            updateChangeElement('receiptChange', receiptChange, true);
            updateChangeElement('memberChange', memberChange, true);
        }

        function updateChangeElement(elementId, value, isPositiveGood) {
            const element = document.getElementById(elementId);
            const isPositive = value >= 0;
            const icon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';
            const colorClass = (isPositive === isPositiveGood) ? 'positive' : 'negative';
            
            element.className = `stat-change ${colorClass}`;
            element.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${isPositive ? '+' : ''}${value}%</span>
            `;
        }

        async function loadRecentActivities() {
            try {
                const response = await callGoogleScript('getRecentActivities');
                
                if (response.success) {
                    displayRecentActivities(response.data);
                } else {
                    throw new Error(response.error || '載入最近活動失敗');
                }
                
            } catch (error) {
                console.error('載入最近活動失敗:', error);
                document.getElementById('recentActivities').innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <p>載入最近活動失敗</p>
                    </div>
                `;
            }
        }

        function displayRecentActivities(activities) {
            const container = document.getElementById('recentActivities');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-3"></i>
                        <p>暫無最近活動</p>
                    </div>
                `;
                return;
            }

            const html = activities.map(activity => `
                <div class="d-flex align-items-center mb-3 p-3 border rounded">
                    <div class="flex-shrink-0 me-3">
                        <i class="fas ${getActivityIcon(activity.type)} fa-lg text-${getActivityColor(activity.type)}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${activity.title}</h6>
                        <p class="mb-1 text-muted small">${activity.description}</p>
                        <small class="text-muted">${formatDateTime(activity.timestamp)}</small>
                    </div>
                    <div class="flex-shrink-0">
                        <span class="badge bg-${getActivityColor(activity.type)}">${activity.amount ? formatCurrency(activity.amount) : ''}</span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function getActivityIcon(type) {
            const icons = {
                'transaction': 'fa-exchange-alt',
                'receipt': 'fa-receipt',
                'member': 'fa-user-plus',
                'system': 'fa-cog'
            };
            return icons[type] || 'fa-info-circle';
        }

        function getActivityColor(type) {
            const colors = {
                'transaction': 'primary',
                'receipt': 'success',
                'member': 'warning',
                'system': 'info'
            };
            return colors[type] || 'secondary';
        }

        // ========================================
        // 交易記錄功能
        // ========================================
        
        async function loadTransactions(page = 1) {
            try {
                showLoading('載入交易記錄中...');
                
                const response = await callGoogleScript('getTransactions', {
                    page: page,
                    limit: ITEMS_PER_PAGE,
                    filters: currentFilters.transactions
                });
                
                if (response.success) {
                    currentData.transactions = response.data.transactions;
                    displayTransactions(response.data.transactions);
                    updateTransactionPagination(response.data.pagination);
                    currentPage.transactions = page;
                } else {
                    throw new Error(response.error || '載入交易記錄失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('載入交易記錄失敗:', error);
                hideLoading();
                showTransactionError();
            }
        }

        function displayTransactions(transactions) {
            const container = document.getElementById('transactionTableContainer');
            
            if (!transactions || transactions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                        <h5 class="text-muted">暫無交易記錄</h5>
                        <p class="text-muted">點擊左側表單新增第一筆交易記錄</p>
                    </div>
                `;
                return;
            }

            const tableHtml = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>姓名</th>
                            <th>類型</th>
                            <th>類別</th>
                            <th>金額</th>
                            <th>帳戶</th>
                            <th>狀態</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions.map(transaction => `
                            <tr>
                                <td>${formatDate(transaction.date)}</td>
                                <td>${transaction.name}</td>
                                <td>
                                    <span class="status-badge ${transaction.type === '收入' ? 'status-success' : 'status-danger'}">
                                        ${transaction.type}
                                    </span>
                                </td>
                                <td>${transaction.category}</td>
                                <td class="${transaction.type === '收入' ? 'text-success' : 'text-danger'}">
                                    ${transaction.type === '收入' ? '+' : '-'}${formatCurrency(transaction.amount)}
                                </td>
                                <td>${transaction.account || '-'}</td>
                                <td>
                                    <span class="status-badge status-success">已確認</span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-outline-primary btn-sm" onclick="viewTransaction('${transaction.id}')" title="查看詳情">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="editTransaction('${transaction.id}')" title="編輯">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteTransaction('${transaction.id}')" title="刪除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHtml;
        }

        function showTransactionError() {
            document.getElementById('transactionTableContainer').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                    <h5 class="text-danger">載入失敗</h5>
                    <p class="text-muted">無法載入交易記錄，請檢查網路連線</p>
                    <button class="btn btn-outline-primary" onclick="loadTransactions()">
                        <i class="fas fa-sync-alt me-2"></i>重新載入
                    </button>
                </div>
            `;
        }

        async function handleTransactionSubmit(e) {
            e.preventDefault();
            
            try {
                showLoading('儲存交易記錄中...');
                
                const formData = new FormData(e.target);
                const transactionData = {
                    date: formData.get('date') || document.getElementById('transactionDate').value,
                    name: formData.get('name') || document.getElementById('transactionName').value,
                    type: formData.get('type') || document.getElementById('transactionType').value,
                    category: formData.get('category') || document.getElementById('transactionCategory').value,
                    account: formData.get('account') || document.getElementById('transactionAccount').value,
                    amount: parseFloat(formData.get('amount') || document.getElementById('transactionAmount').value),
                    description: formData.get('description') || document.getElementById('transactionDescription').value,
                    generateReceipt: document.getElementById('generateReceipt').checked,
                    payerEmail: document.getElementById('payerEmail').value,
                    payerPhone: document.getElementById('payerPhone').value
                };

                // 驗證必填欄位
                if (!transactionData.date || !transactionData.name || !transactionData.type || 
                    !transactionData.category || !transactionData.amount) {
                    throw new Error('請填寫所有必填欄位');
                }

                const response = await callGoogleScript('addTransaction', transactionData);
                
                if (response.success) {
                    showAlert('交易記錄新增成功！', 'success');
                    clearTransactionForm();
                    await loadTransactions();
                    await loadDashboardData();
                    
                    // 如果需要生成收據
                    if (transactionData.generateReceipt && transactionData.type === '收入') {
                        await generateAutoReceipt(response.data.transactionId, transactionData);
                    }
                } else {
                    throw new Error(response.error || '新增交易記錄失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('新增交易記錄失敗:', error);
                hideLoading();
                showAlert(error.message, 'danger');
            }
        }

        function handleTransactionTypeChange() {
            const type = document.getElementById('transactionType').value;
            const categorySelect = document.getElementById('transactionCategory');
            const incomeOptions = document.getElementById('incomeOptions');
            const expenseOptions = document.getElementById('expenseOptions');

            // 清空類別選項
            categorySelect.innerHTML = '<option value="">請選擇類別</option>';

            // 根據類型顯示不同選項
            if (type === '收入') {
                incomeOptions.style.display = 'block';
                expenseOptions.style.display = 'none';
                
                // 添加收入類別
                const incomeCategories = ['會費', '捐款', '活動收入', '利息收入', '其他收入'];
                incomeCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
                
            } else if (type === '支出') {
                incomeOptions.style.display = 'none';
                expenseOptions.style.display = 'block';
                
                // 添加支出類別
                const expenseCategories = ['活動支出', '行政費用', '辦公用品', '交通費', '餐費', '其他支出'];
                expenseCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
                
            } else {
                incomeOptions.style.display = 'none';
                expenseOptions.style.display = 'none';
            }
        }

        function toggleReceiptDetails() {
            const checkbox = document.getElementById('generateReceipt');
            const details = document.getElementById('receiptDetails');
            details.style.display = checkbox.checked ? 'block' : 'none';
        }

        function clearTransactionForm() {
            document.getElementById('transactionForm').reset();
            document.getElementById('transactionDate').value = getCurrentDate();
            document.getElementById('incomeOptions').style.display = 'none';
            document.getElementById('expenseOptions').style.display = 'none';
            document.getElementById('receiptDetails').style.display = 'none';
            document.getElementById('transactionCategory').innerHTML = '<option value="">請選擇類別</option>';
        }

        function filterTransactions() {
            const search = document.getElementById('transactionSearch').value;
            const type = document.getElementById('typeFilter').value;
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;

            currentFilters.transactions = {
                search: search,
                type: type,
                dateFrom: dateFrom,
                dateTo: dateTo
            };

            loadTransactions(1);
        }

        function refreshTransactions() {
            loadTransactions(currentPage.transactions);
        }

        async function exportTransactions() {
            try {
                showLoading('匯出交易記錄中...');
                
                const response = await callGoogleScript('exportTransactions', {
                    filters: currentFilters.transactions
                });
                
                if (response.success) {
                    downloadFile(response.data.url, '交易記錄.xlsx');
                    showAlert('匯出成功！', 'success');
                } else {
                    throw new Error(response.error || '匯出失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('匯出交易記錄失敗:', error);
                hideLoading();
                showAlert('匯出失敗：' + error.message, 'danger');
            }
        }

        // ========================================
        // 收據管理功能
        // ========================================
        
        async function loadReceipts(page = 1) {
            try {
                showLoading('載入收據記錄中...');
                
                const response = await callGoogleScript('getReceipts', {
                    page: page,
                    limit: ITEMS_PER_PAGE,
                    filters: currentFilters.receipts
                });
                
                if (response.success) {
                    currentData.receipts = response.data.receipts;
                    displayReceipts(response.data.receipts);
                    currentPage.receipts = page;
                } else {
                    throw new Error(response.error || '載入收據記錄失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('載入收據記錄失敗:', error);
                hideLoading();
                showReceiptError();
            }
        }

        function displayReceipts(receipts) {
            const container = document.getElementById('receiptTableContainer');
            
            if (!receipts || receipts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-receipt fa-2x text-muted mb-3"></i>
                        <h5 class="text-muted">暫無收據記錄</h5>
                        <p class="text-muted">點擊左側表單開立第一張收據</p>
                    </div>
                `;
                return;
            }

            const tableHtml = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>收據編號</th>
                            <th>日期</th>
                            <th>付款人</th>
                            <th>類別</th>
                            <th>金額</th>
                            <th>狀態</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${receipts.map(receipt => `
                            <tr>
                                <td><strong>${receipt.receiptNumber}</strong></td>
                                <td>${formatDate(receipt.date)}</td>
                                <td>${receipt.payer}</td>
                                <td>${receipt.category}</td>
                                <td class="text-success">+${formatCurrency(receipt.amount)}</td>
                                <td>
                                    <span class="status-badge ${getReceiptStatusClass(receipt.status)}">
                                        ${receipt.status}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-outline-primary btn-sm" onclick="viewReceipt('${receipt.id}')" title="查看詳情">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="downloadReceipt('${receipt.id}')" title="下載PDF">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" onclick="resendReceipt('${receipt.id}')" title="重新寄送">
                                            <i class="fas fa-envelope"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteReceipt('${receipt.id}')" title="刪除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHtml;
        }

        function getReceiptStatusClass(status) {
            const statusClasses = {
                '已開立': 'status-info',
                '已寄送': 'status-success',
                '已列印': 'status-warning'
            };
            return statusClasses[status] || 'status-info';
        }

        function showReceiptError() {
            document.getElementById('receiptTableContainer').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                    <h5 class="text-danger">載入失敗</h5>
                    <p class="text-muted">無法載入收據記錄，請檢查網路連線</p>
                    <button class="btn btn-outline-primary" onclick="loadReceipts()">
                        <i class="fas fa-sync-alt me-2"></i>重新載入
                    </button>
                </div>
            `;
        }

        async function handleReceiptSubmit(e) {
            e.preventDefault();
            
            try {
                showLoading('開立收據中...');
                
                const receiptData = {
                    date: document.getElementById('receiptDate').value,
                    payer: document.getElementById('receiptPayer').value,
                    identity: document.getElementById('receiptIdentity').value,
                    phone: document.getElementById('receiptPhone').value,
                    email: document.getElementById('receiptEmail').value,
                    category: document.getElementById('receiptCategory').value,
                    amount: parseFloat(document.getElementById('receiptAmount').value),
                    description: document.getElementById('receiptDescription').value,
                    autoSendEmail: document.getElementById('autoSendEmail').checked
                };

                // 驗證必填欄位
                if (!receiptData.date || !receiptData.payer || !receiptData.category || !receiptData.amount) {
                    throw new Error('請填寫所有必填欄位');
                }

                const response = await callGoogleScript('createReceipt', receiptData);
                
                if (response.success) {
                    showAlert('收據開立成功！', 'success');
                    clearReceiptForm();
                    await loadReceipts();
                    await loadDashboardData();
                    
                    // 顯示收據編號
                    showAlert(`收據編號：${response.data.receiptNumber}`, 'info');
                } else {
                    throw new Error(response.error || '開立收據失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('開立收據失敗:', error);
                hideLoading();
                showAlert(error.message, 'danger');
            }
        }

        function clearReceiptForm() {
            document.getElementById('receiptForm').reset();
            document.getElementById('receiptDate').value = getCurrentDate();
            document.getElementById('autoSendEmail').checked = true;
        }

        function filterReceipts() {
            const search = document.getElementById('receiptSearch').value;
            const status = document.getElementById('receiptStatusFilter').value;
            const category = document.getElementById('receiptCategoryFilter').value;

            currentFilters.receipts = {
                search: search,
                status: status,
                category: category
            };

            loadReceipts(1);
        }

        function refreshReceipts() {
            loadReceipts(currentPage.receipts);
        }

        async function exportReceipts() {
            try {
                showLoading('匯出收據記錄中...');
                
                const response = await callGoogleScript('exportReceipts', {
                    filters: currentFilters.receipts
                });
                
                if (response.success) {
                    downloadFile(response.data.url, '收據記錄.xlsx');
                    showAlert('匯出成功！', 'success');
                } else {
                    throw new Error(response.error || '匯出失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('匯出收據記錄失敗:', error);
                hideLoading();
                showAlert('匯出失敗：' + error.message, 'danger');
            }
        }

        // ========================================
        // 會員管理功能
        // ========================================
        
        async function loadMembers(page = 1) {
            try {
                showLoading('載入會員資料中...');
                
                const response = await callGoogleScript('getMembers', {
                    page: page,
                    limit: ITEMS_PER_PAGE,
                    filters: currentFilters.members
                });
                
                if (response.success) {
                    currentData.members = response.data.members;
                    displayMembers(response.data.members);
                    updateMemberStats(response.data.stats);
                    currentPage.members = page;
                } else {
                    throw new Error(response.error || '載入會員資料失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('載入會員資料失敗:', error);
                hideLoading();
                showMemberError();
            }
        }

        function displayMembers(members) {
            const container = document.getElementById('memberTableContainer');
            
            if (!members || members.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-2x text-muted mb-3"></i>
                        <h5 class="text-muted">暫無會員資料</h5>
                        <p class="text-muted">點擊左側表單新增第一位會員</p>
                    </div>
                `;
                return;
            }

            const tableHtml = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>姓名</th>
                            <th>電話</th>
                            <th>會員類型</th>
                            <th>入會日期</th>
                            <th>會費狀態</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${members.map(member => `
                            <tr>
                                <td>
                                    <strong>${member.name}</strong>
                                    ${member.email ? `<br><small class="text-muted">${member.email}</small>` : ''}
                                </td>
                                <td>
                                    ${member.phone}
                                    ${member.mobile ? `<br><small class="text-muted">${member.mobile}</small>` : ''}
                                </td>
                                <td>
                                    <span class="status-badge ${getMemberTypeClass(member.type)}">
                                        ${member.type}
                                    </span>
                                </td>
                                <td>${formatDate(member.joinDate)}</td>
                                <td>
                                    <span class="status-badge ${getMemberStatusClass(member.feeStatus)}">
                                        ${member.feeStatus}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-outline-primary btn-sm" onclick="viewMember('${member.id}')" title="查看詳情">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="editMember('${member.id}')" title="編輯">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="renewMembership('${member.id}')" title="續會">
                                            <i class="fas fa-redo"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteMember('${member.id}')" title="刪除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHtml;
        }

        function getMemberTypeClass(type) {
            const typeClasses = {
                '一般會員': 'status-info',
                '贊助會員': 'status-success',
                '榮譽會員': 'status-warning',
                '終身會員': 'status-danger'
            };
            return typeClasses[type] || 'status-info';
        }

        function getMemberStatusClass(status) {
            const statusClasses = {
                '已繳費': 'status-success',
                '未繳費': 'status-danger',
                '部分繳費': 'status-warning',
                '免繳費': 'status-info'
            };
            return statusClasses[status] || 'status-info';
        }

        function updateMemberStats(stats) {
            document.getElementById('totalMembers').textContent = stats.total || 0;
            document.getElementById('paidMembers').textContent = stats.paid || 0;
            document.getElementById('unpaidMembers').textContent = stats.unpaid || 0;
            document.getElementById('newMembers').textContent = stats.newThisMonth || 0;
        }

        function showMemberError() {
            document.getElementById('memberTableContainer').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                    <h5 class="text-danger">載入失敗</h5>
                    <p class="text-muted">無法載入會員資料，請檢查網路連線</p>
                    <button class="btn btn-outline-primary" onclick="loadMembers()">
                        <i class="fas fa-sync-alt me-2"></i>重新載入
                    </button>
                </div>
            `;
        }

        async function handleMemberSubmit(e) {
            e.preventDefault();
            
            try {
                showLoading('新增會員中...');
                
                const memberData = {
                    name: document.getElementById('memberName').value,
                    gender: document.getElementById('memberGender').value,
                    birthDate: document.getElementById('memberBirthDate').value,
                    idCard: document.getElementById('memberIdCard').value,
                    phone: document.getElementById('memberPhone').value,
                    mobile: document.getElementById('memberMobile').value,
                    email: document.getElementById('memberEmail').value,
                    address: document.getElementById('memberAddress').value,
                    emergencyContact: document.getElementById('memberEmergencyContact').value,
                    emergencyPhone: document.getElementById('memberEmergencyPhone').value,
                    joinDate: document.getElementById('memberJoinDate').value,
                    type: document.getElementById('memberType').value,
                    feeStatus: document.getElementById('memberFeeStatus').value,
                    notes: document.getElementById('memberNotes').value
                };

                // 驗證必填欄位
                if (!memberData.name || !memberData.phone || !memberData.type) {
                    throw new Error('請填寫所有必填欄位');
                }

                const response = await callGoogleScript('addMember', memberData);
                
                if (response.success) {
                    showAlert('會員新增成功！', 'success');
                    clearMemberForm();
                    await loadMembers();
                    await loadDashboardData();
                } else {
                    throw new Error(response.error || '新增會員失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('新增會員失敗:', error);
                hideLoading();
                showAlert(error.message, 'danger');
            }
        }

        function clearMemberForm() {
            document.getElementById('memberForm').reset();
            document.getElementById('memberJoinDate').value = getCurrentDate();
            document.getElementById('memberFeeStatus').value = '未繳費';
        }

        function filterMembers() {
            const search = document.getElementById('memberSearch').value;
            const type = document.getElementById('memberTypeFilter').value;
            const status = document.getElementById('memberStatusFilter').value;

            currentFilters.members = {
                search: search,
                type: type,
                status: status
            };

            loadMembers(1);
        }

        function clearMemberFilters() {
            document.getElementById('memberSearch').value = '';
            document.getElementById('memberTypeFilter').value = '';
            document.getElementById('memberStatusFilter').value = '';
            currentFilters.members = {};
            loadMembers(1);
        }

        function refreshMembers() {
            loadMembers(currentPage.members);
        }

        async function exportMembers() {
            try {
                showLoading('匯出會員資料中...');
                
                const response = await callGoogleScript('exportMembers', {
                    filters: currentFilters.members
                });
                
                if (response.success) {
                    downloadFile(response.data.url, '會員資料.xlsx');
                    showAlert('匯出成功！', 'success');
                } else {
                    throw new Error(response.error || '匯出失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('匯出會員資料失敗:', error);
                hideLoading();
                showAlert('匯出失敗：' + error.message, 'danger');
            }
        }

        async function importMembers() {
            // 創建文件輸入元素
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls,.csv';
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    showLoading('匯入會員資料中...');
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const response = await callGoogleScript('importMembers', formData);
                    
                    if (response.success) {
                        showAlert(`匯入成功！新增 ${response.data.imported} 位會員`, 'success');
                        await loadMembers();
                        await loadDashboardData();
                    } else {
                        throw new Error(response.error || '匯入失敗');
                    }
                    
                    hideLoading();
                    
                } catch (error) {
                    console.error('匯入會員資料失敗:', error);
                    hideLoading();
                    showAlert('匯入失敗：' + error.message, 'danger');
                }
            };
            
            input.click();
        }

        // ========================================
        // 報表功能
        // ========================================
        
        async function handleReportSubmit(e) {
            e.preventDefault();
            
            try {
                showLoading('生成報表中...');
                
                const reportData = {
                    type: document.getElementById('reportType').value,
                    year: document.getElementById('reportYear').value,
                    month: document.getElementById('reportMonth').value,
                    format: document.querySelector('input[name="reportFormat"]:checked').value
                };

                const response = await callGoogleScript('generateReport', reportData);
                
                if (response.success) {
                    if (reportData.format === 'html') {
                        displayReport(response.data.html);
                        showAlert('報表生成成功！', 'success');
                    } else {
                        downloadFile(response.data.url, `${getReportFileName(reportData)}.${reportData.format}`);
                        showAlert('報表下載開始！', 'success');
                    }
                } else {
                    throw new Error(response.error || '生成報表失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('生成報表失敗:', error);
                hideLoading();
                showAlert('生成報表失敗：' + error.message, 'danger');
            }
        }

        function handleReportTypeChange() {
            const type = document.getElementById('reportType').value;
            const monthGroup = document.getElementById('monthGroup');
            
            // 年度報表不需要選擇月份
            if (type === 'yearly') {
                monthGroup.style.display = 'none';
            } else {
                monthGroup.style.display = 'block';
            }
        }

        function displayReport(html) {
            document.getElementById('reportContent').innerHTML = html;
        }

        function getReportFileName(reportData) {
            const typeNames = {
                'monthly': '月度財務報表',
                'yearly': '年度財務報表',
                'category': '類別分析報表',
                'member': '會員統計報表',
                'receipt': '收據統計報表'
            };
            
            const typeName = typeNames[reportData.type] || '報表';
            const datePart = reportData.type === 'yearly' ? 
                reportData.year : 
                `${reportData.year}-${reportData.month.padStart(2, '0')}`;
                
            return `${typeName}_${datePart}`;
        }

        function refreshReport() {
            const reportForm = document.getElementById('reportForm');
            if (reportForm) {
                handleReportSubmit({ preventDefault: () => {} });
            }
        }

        function printReport() {
            const reportContent = document.getElementById('reportContent').innerHTML;
            if (!reportContent || reportContent.includes('請選擇報表類型')) {
                showAlert('請先生成報表', 'warning');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>財務報表</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .text-center { text-align: center; }
                            .text-right { text-align: right; }
                            @media print { body { margin: 0; } }
                        </style>
                    </head>
                    <body>
                        ${reportContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function scheduleReport() {
            try {
                const reportData = {
                    type: document.getElementById('reportType').value,
                    year: document.getElementById('reportYear').value,
                    month: document.getElementById('reportMonth').value,
                    format: document.querySelector('input[name="reportFormat"]:checked').value
                };

                const response = await callGoogleScript('scheduleReport', reportData);
                
                if (response.success) {
                    showAlert('報表排程設定成功！', 'success');
                } else {
                    throw new Error(response.error || '設定排程失敗');
                }
                
            } catch (error) {
                console.error('設定報表排程失敗:', error);
                showAlert('設定排程失敗：' + error.message, 'danger');
            }
        }

        // ========================================
        // 系統設定功能
        // ========================================
        
        document.getElementById('organizationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                showLoading('儲存機構設定中...');
                
                const orgData = {
                    name: document.getElementById('orgName').value,
                    taxId: document.getElementById('orgTaxId').value,
                    address: document.getElementById('orgAddress').value,
                    phone: document.getElementById('orgPhone').value,
                    fax: document.getElementById('orgFax').value,
                    email: document.getElementById('orgEmail').value,
                    website: document.getElementById('orgWebsite').value
                };

                const response = await callGoogleScript('saveOrganizationSettings', orgData);
                
                if (response.success) {
                    showAlert('機構設定儲存成功！', 'success');
                } else {
                    throw new Error(response.error || '儲存設定失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('儲存機構設定失敗:', error);
                hideLoading();
                showAlert('儲存設定失敗：' + error.message, 'danger');
            }
        });

        document.getElementById('emailForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                showLoading('儲存郵件設定中...');
                
                const emailData = {
                    senderName: document.getElementById('emailSenderName').value,
                    senderAddress: document.getElementById('emailSenderAddress').value,
                    autoSendReceipt: document.getElementById('autoSendReceipt').checked,
                    emailNotification: document.getElementById('emailNotification').checked
                };

                const response = await callGoogleScript('saveEmailSettings', emailData);
                
                if (response.success) {
                    showAlert('郵件設定儲存成功！', 'success');
                } else {
                    throw new Error(response.error || '儲存設定失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('儲存郵件設定失敗:', error);
                hideLoading();
                showAlert('儲存設定失敗：' + error.message, 'danger');
            }
        });

        async function performSystemCheck() {
            try {
                showLoading('執行系統檢查中...');
                
                const response = await callGoogleScript('performSystemCheck');
                
                if (response.success) {
                    const results = response.data;
                    let message = '系統檢查完成：\n';
                    message += `• 資料庫連線：${results.database ? '正常' : '異常'}\n`;
                    message += `• 檔案系統：${results.fileSystem ? '正常' : '異常'}\n`;
                    message += `• 郵件服務：${results.emailService ? '正常' : '異常'}\n`;
                    message += `• 資料完整性：${results.dataIntegrity ? '正常' : '異常'}`;
                    
                    showAlert(message, results.overall ? 'success' : 'warning');
                } else {
                    throw new Error(response.error || '系統檢查失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('系統檢查失敗:', error);
                hideLoading();
                showAlert('系統檢查失敗：' + error.message, 'danger');
            }
        }

        async function createBackup() {
            try {
                showLoading('建立系統備份中...');
                
                const response = await callGoogleScript('createBackup');
                
                if (response.success) {
                    showAlert('系統備份建立成功！', 'success');
                    if (response.data.downloadUrl) {
                        downloadFile(response.data.downloadUrl, `backup_${getCurrentDate()}.zip`);
                    }
                } else {
                    throw new Error(response.error || '建立備份失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('建立系統備份失敗:', error);
                hideLoading();
                showAlert('建立備份失敗：' + error.message, 'danger');
            }
        }

        async function exportAllData() {
            try {
                showLoading('匯出全部資料中...');
                
                const response = await callGoogleScript('exportAllData');
                
                if (response.success) {
                    downloadFile(response.data.url, `全部資料_${getCurrentDate()}.xlsx`);
                    showAlert('資料匯出成功！', 'success');
                } else {
                    throw new Error(response.error || '匯出資料失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('匯出全部資料失敗:', error);
                hideLoading();
                showAlert('匯出資料失敗：' + error.message, 'danger');
            }
        }

        async function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.zip';
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    showLoading('匯入資料中...');
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const response = await callGoogleScript('importData', formData);
                    
                    if (response.success) {
                        showAlert('資料匯入成功！', 'success');
                        // 重新載入所有資料
                        await loadInitialData();
                    } else {
                        throw new Error(response.error || '匯入資料失敗');
                    }
                    
                    hideLoading();
                    
                } catch (error) {
                    console.error('匯入資料失敗:', error);
                    hideLoading();
                    showAlert('匯入資料失敗：' + error.message, 'danger');
                }
            };
            
            input.click();
        }

        async function clearCache() {
            try {
                showLoading('清除快取中...');
                
                const response = await callGoogleScript('clearCache');
                
                if (response.success) {
                    showAlert('快取清除成功！', 'success');
                } else {
                    throw new Error(response.error || '清除快取失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('清除快取失敗:', error);
                hideLoading();
                showAlert('清除快取失敗：' + error.message, 'danger');
            }
        }

        async function resetSystem() {
            if (!confirm('確定要重置系統嗎？這將清除所有資料，此操作無法復原！')) {
                return;
            }
            
            if (!confirm('請再次確認：您確定要重置整個系統嗎？')) {
                return;
            }
            
            try {
                showLoading('重置系統中...');
                
                const response = await callGoogleScript('resetSystem');
                
                if (response.success) {
                    showAlert('系統重置成功！頁面將重新載入', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    throw new Error(response.error || '重置系統失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('重置系統失敗:', error);
                hideLoading();
                showAlert('重置系統失敗：' + error.message, 'danger');
            }
        }

        // ========================================
        // 模態視窗功能
        // ========================================
        
        async function viewTransaction(id) {
            try {
                const response = await callGoogleScript('getTransactionDetails', { id: id });
                
                if (response.success) {
                    const transaction = response.data;
                    document.getElementById('transactionModalBody').innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>日期：</strong>${formatDate(transaction.date)}</p>
                                <p><strong>姓名：</strong>${transaction.name}</p>
                                <p><strong>類型：</strong><span class="status-badge ${transaction.type === '收入' ? 'status-success' : 'status-danger'}">${transaction.type}</span></p>
                                <p><strong>類別：</strong>${transaction.category}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>金額：</strong><span class="${transaction.type === '收入' ? 'text-success' : 'text-danger'}">${transaction.type === '收入' ? '+' : '-'}${formatCurrency(transaction.amount)}</span></p>
                                <p><strong>帳戶：</strong>${transaction.account || '-'}</p>
                                <p><strong>建立時間：</strong>${formatDateTime(transaction.createdAt)}</p>
                                <p><strong>更新時間：</strong>${formatDateTime(transaction.updatedAt)}</p>
                            </div>
                        </div>
                        ${transaction.description ? `<div class="mt-3"><strong>說明：</strong><p class="mt-2">${transaction.description}</p></div>` : ''}
                    `;
                    
                    new bootstrap.Modal(document.getElementById('transactionModal')).show();
                } else {
                    throw new Error(response.error || '載入交易詳情失敗');
                }
                
            } catch (error) {
                console.error('載入交易詳情失敗:', error);
                showAlert('載入交易詳情失敗', 'danger');
            }
        }

        async function viewReceipt(id) {
            try {
                const response = await callGoogleScript('getReceiptDetails', { id: id });
                
                if (response.success) {
                    const receipt = response.data;
                    document.getElementById('receiptModalBody').innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>收據編號：</strong>${receipt.receiptNumber}</p>
                                <p><strong>日期：</strong>${formatDate(receipt.date)}</p>
                                <p><strong>付款人：</strong>${receipt.payer}</p>
                                <p><strong>身分：</strong>${receipt.identity}</p>
                                <p><strong>電話：</strong>${receipt.phone || '-'}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>金額：</strong><span class="text-success">${formatCurrency(receipt.amount)}</span></p>
                                <p><strong>類別：</strong>${receipt.category}</p>
                                <p><strong>狀態：</strong><span class="status-badge ${getReceiptStatusClass(receipt.status)}">${receipt.status}</span></p>
                                <p><strong>電子郵件：</strong>${receipt.email || '-'}</p>
                                <p><strong>開立時間：</strong>${formatDateTime(receipt.createdAt)}</p>
                            </div>
                        </div>
                        ${receipt.description ? `<div class="mt-3"><strong>用途說明：</strong><p class="mt-2">${receipt.description}</p></div>` : ''}
                    `;
                    
                    new bootstrap.Modal(document.getElementById('receiptModal')).show();
                } else {
                    throw new Error(response.error || '載入收據詳情失敗');
                }
                
            } catch (error) {
                console.error('載入收據詳情失敗:', error);
                showAlert('載入收據詳情失敗', 'danger');
            }
        }

        async function viewMember(id) {
            try {
                const response = await callGoogleScript('getMemberDetails', { id: id });
                
                if (response.success) {
                    const member = response.data;
                    document.getElementById('memberModalBody').innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>姓名：</strong>${member.name}</p>
                                <p><strong>性別：</strong>${member.gender || '-'}</p>
                                <p><strong>生日：</strong>${member.birthDate ? formatDate(member.birthDate) : '-'}</p>
                                <p><strong>身分證字號：</strong>${member.idCard || '-'}</p>
                                <p><strong>電話：</strong>${member.phone}</p>
                                <p><strong>手機：</strong>${member.mobile || '-'}</p>
                                <p><strong>電子郵件：</strong>${member.email || '-'}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>會員類型：</strong><span class="status-badge ${getMemberTypeClass(member.type)}">${member.type}</span></p>
                                <p><strong>入會日期：</strong>${formatDate(member.joinDate)}</p>
                                <p><strong>會費狀態：</strong><span class="status-badge ${getMemberStatusClass(member.feeStatus)}">${member.feeStatus}</span></p>
                                <p><strong>緊急聯絡人：</strong>${member.emergencyContact || '-'}</p>
                                <p><strong>緊急聯絡電話：</strong>${member.emergencyPhone || '-'}</p>
                                <p><strong>建立時間：</strong>${formatDateTime(member.createdAt)}</p>
                                <p><strong>更新時間：</strong>${formatDateTime(member.updatedAt)}</p>
                            </div>
                        </div>
                        ${member.address ? `<div class="mt-3"><strong>地址：</strong><p class="mt-2">${member.address}</p></div>` : ''}
                        ${member.notes ? `<div class="mt-3"><strong>備註：</strong><p class="mt-2">${member.notes}</p></div>` : ''}
                    `;
                    
                    new bootstrap.Modal(document.getElementById('memberModal')).show();
                } else {
                    throw new Error(response.error || '載入會員詳情失敗');
                }
                
            } catch (error) {
                console.error('載入會員詳情失敗:', error);
                showAlert('載入會員詳情失敗', 'danger');
            }
        }

        // ========================================
        // 刪除功能
        // ========================================
        
        function deleteTransaction(id) {
            document.getElementById('deleteConfirmMessage').textContent = '您確定要刪除這筆交易記錄嗎？此操作無法復原。';
            document.getElementById('confirmDeleteBtn').onclick = () => confirmDeleteTransaction(id);
            new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
        }

        async function confirmDeleteTransaction(id) {
            try {
                showLoading('刪除交易記錄中...');
                
                const response = await callGoogleScript('deleteTransaction', { id: id });
                
                if (response.success) {
                    showAlert('交易記錄刪除成功！', 'success');
                    await loadTransactions();
                    await loadDashboardData();
                    bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
                } else {
                    throw new Error(response.error || '刪除交易記錄失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('刪除交易記錄失敗:', error);
                hideLoading();
                showAlert('刪除交易記錄失敗：' + error.message, 'danger');
            }
        }

        function deleteReceipt(id) {
            document.getElementById('deleteConfirmMessage').textContent = '您確定要刪除這張收據嗎？此操作無法復原。';
            document.getElementById('confirmDeleteBtn').onclick = () => confirmDeleteReceipt(id);
            new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
        }

        async function confirmDeleteReceipt(id) {
            try {
                showLoading('刪除收據中...');
                
                const response = await callGoogleScript('deleteReceipt', { id: id });
                
                if (response.success) {
                    showAlert('收據刪除成功！', 'success');
                    await loadReceipts();
                    await loadDashboardData();
                    bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
                } else {
                    throw new Error(response.error || '刪除收據失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('刪除收據失敗:', error);
                hideLoading();
                showAlert('刪除收據失敗：' + error.message, 'danger');
            }
        }

        function deleteMember(id) {
            document.getElementById('deleteConfirmMessage').textContent = '您確定要刪除這位會員嗎？此操作無法復原。';
            document.getElementById('confirmDeleteBtn').onclick = () => confirmDeleteMember(id);
            new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
        }

        async function confirmDeleteMember(id) {
            try {
                showLoading('刪除會員中...');
                
                const response = await callGoogleScript('deleteMember', { id: id });
                
                if (response.success) {
                    showAlert('會員刪除成功！', 'success');
                    await loadMembers();
                    await loadDashboardData();
                    bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
                } else {
                    throw new Error(response.error || '刪除會員失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('刪除會員失敗:', error);
                hideLoading();
                showAlert('刪除會員失敗：' + error.message, 'danger');
            }
        }

        // ========================================
        // 工具函數
        // ========================================
        
        async function callGoogleScript(functionName, parameters = {}) {
            try {
                // 模擬 API 調用，實際使用時需要替換為真實的 Google Apps Script URL
                const response = await fetch('https://script.google.com/macros/s/AKfycbw7Auj2dGg_0C440tpudjp91gfJoNAELt4GNb8VhohwpM-2uTJ_4Thr1-dZlEq3BCEw9w/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        function: functionName,
                        parameters: parameters
                    })
                });
                
                if (!response.ok) {
                    throw new Error('網路請求失敗');
                }
                
                const result = await response.json();
                return result;
                
            } catch (error) {
                console.error('API 調用失敗:', error);
                // 返回模擬資料用於測試
                return getMockResponse(functionName, parameters);
            }
        }

        function getMockResponse(functionName, parameters) {
            // 模擬資料，用於測試
            const mockResponses = {
                'getDashboardStats': {
                    success: true,
                    data: {
                        totalIncome: 150000,
                        totalExpense: 80000,
                        receiptCount: 25,
                        memberCount: 120,
                        incomeChange: 15,
                        expenseChange: -5,
                        receiptChange: 8,
                        memberChange: 3
                    }
                },
                'getRecentActivities': {
                    success: true,
                    data: [
                        {
                            type: 'transaction',
                            title: '新增收入記錄',
                            description: '王小明 - 會費收入',
                            amount: 1000,
                            timestamp: new Date().toISOString()
                        },
                        {
                            type: 'receipt',
                            title: '開立收據',
                            description: '收據編號：R2024001',
                            amount: 1000,
                            timestamp: new Date(Date.now() - 3600000).toISOString()
                        },
                        {
                            type: 'member',
                            title: '新增會員',
                            description: '李小華加入會員',
                            timestamp: new Date(Date.now() - 7200000).toISOString()
                        }
                    ]
                },
                'getTransactions': {
                    success: true,
                    data: {
                        transactions: [
                            {
                                id: '1',
                                date: '2024-12-19',
                                name: '王小明',
                                type: '收入',
                                category: '會費',
                                amount: 1000,
                                account: '現金',
                                description: '2024年度會費'
                            },
                            {
                                id: '2',
                                date: '2024-12-18',
                                name: '李小華',
                                type: '收入',
                                category: '捐款',
                                amount: 5000,
                                account: '銀行轉帳',
                                description: '一般捐款'
                            }
                        ],
                        pagination: {
                            currentPage: 1,
                            totalPages: 1,
                            totalItems: 2
                        }
                    }
                }
            };
            
            return mockResponses[functionName] || { success: false, error: '未知的函數調用' };
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getCurrentDate() {
            const now = new Date();
            return now.toISOString().split('T')[0];
        }

        function getCurrentDateTime() {
            const now = new Date();
            return now.toISOString().slice(0, 16);
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }

        function setFormDefaults() {
            // 設定日期欄位預設值為今天
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value) {
                    input.value = getCurrentDate();
                }
            });

            // 設定時間欄位預設值為現在
            const datetimeInputs = document.querySelectorAll('input[type="datetime-local"]');
            datetimeInputs.forEach(input => {
                if (!input.value) {
                    input.value = getCurrentDateTime();
                }
            });
        }

        function showLoading(message = '處理中...') {
            const overlay = document.getElementById('loadingOverlay');
            const messageElement = document.getElementById('loadingMessage');
            
            if (messageElement) {
                messageElement.textContent = message;
            }
            
            if (overlay) {
                overlay.classList.add('show');
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        function showAlert(message, type = 'info') {
            // 創建警告元素
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 自動移除警告
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        function downloadFile(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function handleTabChange(target) {
            // 根據切換的分頁載入對應資料
            switch (target) {
                case '#dashboard':
                    loadDashboardData();
                    break;
                case '#transactions':
                    if (currentData.transactions.length === 0) {
                        loadTransactions();
                    }
                    break;
                case '#receipts':
                    if (currentData.receipts.length === 0) {
                        loadReceipts();
                    }
                    break;
                case '#members':
                    if (currentData.members.length === 0) {
                        loadMembers();
                    }
                    break;
                case '#report':
                    // 報表頁面不需要預載資料
                    break;
                case '#settings':
                    loadSystemInfo();
                    break;
            }
        }

        function handleWindowResize() {
            // 處理視窗大小變更
            if (window.innerWidth < 768) {
                // 手機版處理
                document.body.classList.add('mobile-view');
            } else {
                document.body.classList.remove('mobile-view');
            }
        }

        async function loadSystemInfo() {
            try {
                const response = await callGoogleScript('getSystemInfo');
                
                if (response.success) {
                    const info = response.data;
                    document.getElementById('lastUpdate').textContent = formatDateTime(info.lastUpdate);
                }
                
            } catch (error) {
                console.error('載入系統資訊失敗:', error);
                document.getElementById('lastUpdate').textContent = '載入失敗';
            }
        }

        // ========================================
        // 圖表初始化
        // ========================================
        
        function initializeCharts() {
            // 初始化收入支出圖表
            const incomeExpenseCtx = document.getElementById('incomeExpenseChart');
            if (incomeExpenseCtx) {
                new Chart(incomeExpenseCtx, {
                    type: 'bar',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                        datasets: [{
                            label: '收入',
                            data: [12000, 15000, 18000, 14000, 16000, 20000, 22000, 19000, 17000, 21000, 23000, 25000],
                            backgroundColor: 'rgba(40, 167, 69, 0.8)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1
                        }, {
                            label: '支出',
                            data: [8000, 9000, 12000, 7000, 10000, 11000, 13000, 9500, 8500, 12000, 14000, 15000],
                            backgroundColor: 'rgba(220, 53, 69, 0.8)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + formatCurrency(context.raw);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 初始化會員類型圖表
            const memberTypeCtx = document.getElementById('memberTypeChart');
            if (memberTypeCtx) {
                new Chart(memberTypeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['一般會員', '贊助會員', '榮譽會員', '終身會員'],
                        datasets: [{
                            data: [85, 25, 8, 2],
                            backgroundColor: [
                                'rgba(13, 110, 253, 0.8)',
                                'rgba(25, 135, 84, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(220, 53, 69, 0.8)'
                            ],
                            borderColor: [
                                'rgba(13, 110, 253, 1)',
                                'rgba(25, 135, 84, 1)',
                                'rgba(255, 193, 7, 1)',
                                'rgba(220, 53, 69, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.raw / total) * 100).toFixed(1);
                                        return context.label + ': ' + context.raw + '人 (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // ========================================
        // 分頁功能
        // ========================================
        
        function updateTransactionPagination(pagination) {
            // 實作分頁功能
            const paginationContainer = document.getElementById('transactionPagination');
            if (!paginationContainer) return;

            let paginationHtml = '<nav><ul class="pagination justify-content-center">';
            
            // 上一頁
            if (pagination.currentPage > 1) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadTransactions(${pagination.currentPage - 1})">上一頁</a></li>`;
            }
            
            // 頁碼
            for (let i = 1; i <= pagination.totalPages; i++) {
                if (i === pagination.currentPage) {
                    paginationHtml += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
                } else {
                    paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadTransactions(${i})">${i}</a></li>`;
                }
            }
            
            // 下一頁
            if (pagination.currentPage < pagination.totalPages) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadTransactions(${pagination.currentPage + 1})">下一頁</a></li>`;
            }
            
            paginationHtml += '</ul></nav>';
            paginationContainer.innerHTML = paginationHtml;
        }

        // ========================================
        // 其他功能函數
        // ========================================
        
        async function generateAutoReceipt(transactionId, transactionData) {
            try {
                const receiptData = {
                    transactionId: transactionId,
                    date: transactionData.date,
                    payer: transactionData.name,
                    email: transactionData.payerEmail,
                    phone: transactionData.payerPhone,
                    category: transactionData.category,
                    amount: transactionData.amount,
                    description: transactionData.description,
                    autoSendEmail: true
                };

                const response = await callGoogleScript('createAutoReceipt', receiptData);
                
                if (response.success) {
                    showAlert(`收據自動生成成功！收據編號：${response.data.receiptNumber}`, 'success');
                } else {
                    showAlert('收據自動生成失敗：' + response.error, 'warning');
                }
                
            } catch (error) {
                console.error('自動生成收據失敗:', error);
                showAlert('收據自動生成失敗', 'warning');
            }
        }

        async function downloadReceipt(id) {
            try {
                showLoading('生成收據PDF中...');
                
                const response = await callGoogleScript('generateReceiptPDF', { id: id });
                
                if (response.success) {
                    downloadFile(response.data.url, `收據_${response.data.receiptNumber}.pdf`);
                    showAlert('收據PDF下載開始！', 'success');
                } else {
                    throw new Error(response.error || '生成PDF失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('下載收據失敗:', error);
                hideLoading();
                showAlert('下載收據失敗：' + error.message, 'danger');
            }
        }

        async function resendReceipt(id) {
            try {
                showLoading('重新寄送收據中...');
                
                const response = await callGoogleScript('resendReceipt', { id: id });
                
                if (response.success) {
                    showAlert('收據重新寄送成功！', 'success');
                } else {
                    throw new Error(response.error || '重新寄送失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('重新寄送收據失敗:', error);
                hideLoading();
                showAlert('重新寄送收據失敗：' + error.message, 'danger');
            }
        }

        async function renewMembership(id) {
            try {
                showLoading('處理會員續會中...');
                
                const response = await callGoogleScript('renewMembership', { id: id });
                
                if (response.success) {
                    showAlert('會員續會成功！', 'success');
                    await loadMembers();
                } else {
                    throw new Error(response.error || '會員續會失敗');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('會員續會失敗:', error);
                hideLoading();
                showAlert('會員續會失敗：' + error.message, 'danger');
            }
        }

        function showUserManual() {
            window.open('user-manual.html', '_blank');
        }

        function showSystemTutorial() {
            window.open('system-tutorial.html', '_blank');
        }

        function contactSupport() {
            window.open('mailto:support@example.com?subject=系統技術支援', '_blank');
        }

        function reportBug() {
            window.open('mailto:support@example.com?subject=系統問題回報', '_blank');
        }

        // ========================================
        // 鍵盤快捷鍵
        // ========================================
        
        document.addEventListener('keydown', function(e) {
            // Ctrl + S 儲存
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                const activeTab = document.querySelector('.tab-pane.active');
                if (activeTab) {
                    const form = activeTab.querySelector('form');
                    if (form) {
                        form.dispatchEvent(new Event('submit'));
                    }
                }
            }
            
            // Ctrl + R 重新整理
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                const activeTabId = document.querySelector('.nav-link.active').getAttribute('data-bs-target');
                handleTabChange(activeTabId);
            }
            
            // ESC 關閉模態視窗
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => {
                    bootstrap.Modal.getInstance(modal)?.hide();
                });
            }
        });

        // ========================================
        // 頁面卸載處理
        // ========================================
        
        window.addEventListener('beforeunload', function(e) {
            // 檢查是否有未儲存的更改
            const forms = document.querySelectorAll('form');
            let hasUnsavedChanges = false;
            
            forms.forEach(form => {
                const formData = new FormData(form);
                if (formData.get('name') || formData.get('amount') || formData.get('payer')) {
                    hasUnsavedChanges = true;
                }
            });
            
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '您有未儲存的更改，確定要離開嗎？';
                return e.returnValue;
            }
        });

        // ========================================
        // 服務工作者註冊（PWA支援）
        // ========================================
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('Service Worker 註冊成功:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Service Worker 註冊失敗:', error);
                    });
            });
        }

        // ========================================
        // 離線檢測
        // ========================================
        
        window.addEventListener('online', function() {
            showAlert('網路連線已恢復', 'success');
            // 重新載入資料
            loadInitialData();
        });

        window.addEventListener('offline', function() {
            showAlert('網路連線中斷，部分功能可能無法使用', 'warning');
        });

        console.log('會計管理系統載入完成 - v4.0.0');
    </script>
</body>
</html>





                

            
