<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會 - 會計管理系統 v4.0</title>
  
  <!-- CSS 框架 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  
  <!-- 自訂樣式 -->
  <style>
      :root {
          --primary-color: #2c5aa0;
          --secondary-color: #f8f9fa;
          --success-color: #28a745;
          --danger-color: #dc3545;
          --warning-color: #ffc107;
          --info-color: #17a2b8;
      }

      body {
          background-color: var(--secondary-color);
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
      }

      .navbar-brand {
          font-weight: bold;
          color: white !important;
      }

      .navbar {
          background: linear-gradient(135deg, var(--primary-color), #1e3d72) !important;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      .card {
          border: none;
          border-radius: 12px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.08);
          transition: transform 0.2s ease;
      }

      .card:hover {
          transform: translateY(-2px);
      }

      .card-header {
          background: linear-gradient(135deg, #f8f9fa, #e9ecef);
          border-bottom: 1px solid #dee2e6;
          border-radius: 12px 12px 0 0 !important;
          font-weight: 600;
      }

      .stat-card {
          background: linear-gradient(135deg, var(--primary-color), #1e3d72);
          color: white;
          border-radius: 15px;
          padding: 1.5rem;
          margin-bottom: 1rem;
          position: relative;
          overflow: hidden;
      }

      .stat-card::before {
          content: '';
          position: absolute;
          top: -50%;
          right: -50%;
          width: 100%;
          height: 100%;
          background: rgba(255,255,255,0.1);
          border-radius: 50%;
          transition: all 0.3s ease;
      }

      .stat-card:hover::before {
          transform: scale(1.2);
      }

      .stat-value {
          font-size: 2rem;
          font-weight: bold;
          margin-bottom: 0.5rem;
      }

      .stat-label {
          font-size: 0.9rem;
          opacity: 0.9;
      }

      .stat-change {
          font-size: 0.8rem;
          margin-top: 0.5rem;
      }

      .stat-change.positive {
          color: #28a745;
      }

      .stat-change.negative {
          color: #dc3545;
      }

      .nav-tabs .nav-link {
          border: none;
          color: #6c757d;
          font-weight: 500;
          padding: 1rem 1.5rem;
          border-radius: 8px 8px 0 0;
          margin-right: 0.25rem;
          transition: all 0.3s ease;
      }

      .nav-tabs .nav-link.active {
          background: var(--primary-color);
          color: white;
          border: none;
      }

      .nav-tabs .nav-link:hover:not(.active) {
          background: rgba(44, 90, 160, 0.1);
          color: var(--primary-color);
      }

      .btn-primary {
          background: linear-gradient(135deg, var(--primary-color), #1e3d72);
          border: none;
          border-radius: 8px;
          padding: 0.5rem 1.5rem;
          font-weight: 500;
          transition: all 0.3s ease;
      }

      .btn-primary:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 15px rgba(44, 90, 160, 0.3);
      }

      .form-control, .form-select {
          border: 2px solid #e9ecef;
          border-radius: 8px;
          padding: 0.75rem;
          transition: all 0.3s ease;
      }

      .form-control:focus, .form-select:focus {
          border-color: var(--primary-color);
          box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25);
      }

      .table {
          border-radius: 8px;
          overflow: hidden;
      }

      .table thead th {
          background: var(--primary-color);
          color: white;
          border: none;
          font-weight: 600;
          padding: 1rem;
      }

      .table tbody tr {
          transition: all 0.2s ease;
      }

      .table tbody tr:hover {
          background-color: rgba(44, 90, 160, 0.05);
      }

      .status-badge {
          padding: 0.4rem 0.8rem;
          border-radius: 20px;
          font-size: 0.8rem;
          font-weight: 500;
      }

      .status-success {
          background: rgba(40, 167, 69, 0.1);
          color: #28a745;
          border: 1px solid rgba(40, 167, 69, 0.2);
      }

      .status-danger {
          background: rgba(220, 53, 69, 0.1);
          color: #dc3545;
          border: 1px solid rgba(220, 53, 69, 0.2);
      }

      .status-warning {
          background: rgba(255, 193, 7, 0.1);
          color: #ffc107;
          border: 1px solid rgba(255, 193, 7, 0.2);
      }

      .status-info {
          background: rgba(23, 162, 184, 0.1);
          color: #17a2b8;
          border: 1px solid rgba(23, 162, 184, 0.2);
      }

      .action-buttons {
          display: flex;
          gap: 0.25rem;
      }

      .action-buttons .btn {
          padding: 0.375rem 0.5rem;
          font-size: 0.875rem;
      }

      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
      }

      .loading-overlay.show {
          opacity: 1;
          visibility: visible;
      }

      .loading-content {
          background: white;
          padding: 2rem;
          border-radius: 12px;
          text-align: center;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      }

      .spinner {
          width: 3rem;
          height: 3rem;
          border: 4px solid #f3f3f3;
          border-top: 4px solid var(--primary-color);
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin: 0 auto 1rem;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .quick-actions {
          position: fixed;
          bottom: 2rem;
          right: 2rem;
          z-index: 1000;
      }

      .quick-action-btn {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          margin-bottom: 1rem;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1.5rem;
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
          transition: all 0.3s ease;
      }

      .quick-action-btn:hover {
          transform: scale(1.1);
      }

      .footer {
          background: #343a40;
          color: white;
          padding: 2rem 0;
          margin-top: 3rem;
      }

      @media (max-width: 768px) {
          .stat-card {
              margin-bottom: 1rem;
          }
          
          .quick-actions {
              bottom: 1rem;
              right: 1rem;
          }
          
          .quick-action-btn {
              width: 50px;
              height: 50px;
              font-size: 1.2rem;
          }
          
          .table-responsive {
              font-size: 0.9rem;
          }
      }

      .auto-save-indicator {
          position: fixed;
          top: 20px;
          right: 20px;
          background: #28a745;
          color: white;
          padding: 8px 16px;
          border-radius: 4px;
          font-size: 14px;
          opacity: 0;
          transform: translateY(-20px);
          transition: all 0.3s ease;
          z-index: 9999;
      }
      
      .auto-save-indicator.show {
          opacity: 1;
          transform: translateY(0);
      }
  </style>
</head>
<body>
  <!-- 導航列 -->
  <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
          <a class="navbar-brand" href="#">
              <i class="fas fa-heartbeat me-2"></i>
              台灣帕金森病友權益促進會
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
              <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav ms-auto">
                  <li class="nav-item">
                      <span class="navbar-text me-3">
                          <i class="fas fa-clock me-1"></i>
                          <span id="currentTime"></span>
                      </span>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="#" onclick="showUserManual()">
                          <i class="fas fa-question-circle me-1"></i>說明
                      </a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="#" onclick="contactSupport()">
                          <i class="fas fa-headset me-1"></i>支援
                      </a>
                  </li>
              </ul>
          </div>
      </div>
  </nav>

  <!-- 全域訊息區域 -->
  <div class="container-fluid mt-3">
      <div id="globalMessage"></div>
  </div>

  <!-- 主要內容 -->
  <div class="container-fluid py-4">
      <!-- 分頁導航 -->
      <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
          <li class="nav-item" role="presentation">
              <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                  <i class="fas fa-tachometer-alt me-2"></i>儀表板
              </button>
          </li>
          <li class="nav-item" role="presentation">
              <button class="nav-link" id="transaction-tab" data-bs-toggle="tab" data-bs-target="#transaction" type="button" role="tab">
                  <i class="fas fa-exchange-alt me-2"></i>交易記錄
              </button>
          </li>
          <li class="nav-item" role="presentation">
              <button class="nav-link" id="receipt-tab" data-bs-toggle="tab" data-bs-target="#receipt" type="button" role="tab">
                  <i class="fas fa-receipt me-2"></i>收據管理
              </button>
          </li>
          <li class="nav-item" role="presentation">
              <button class="nav-link" id="member-tab" data-bs-toggle="tab" data-bs-target="#member" type="button" role="tab">
                  <i class="fas fa-users me-2"></i>會員管理
              </button>
          </li>
          <li class="nav-item" role="presentation">
              <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" type="button" role="tab">
                  <i class="fas fa-chart-bar me-2"></i>報表分析
              </button>
          </li>
      </ul>

      <!-- 分頁內容 -->
      <div class="tab-content" id="mainTabContent">
          <!-- 儀表板 -->
          <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
              <div class="row">
                  <!-- 統計卡片 -->
                  <div class="col-xl-3 col-md-6 mb-4">
                      <div class="stat-card">
                          <div class="d-flex justify-content-between align-items-center">
                              <div>
                                  <div class="stat-value" id="totalIncome">$0</div>
                                  <div class="stat-label">總收入</div>
                                  <div class="stat-change" id="incomeChange">
                                      <i class="fas fa-arrow-up"></i>
                                      <span>0%</span>
                                  </div>
                              </div>
                              <div class="fs-1 opacity-50">
                                  <i class="fas fa-arrow-up"></i>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="col-xl-3 col-md-6 mb-4">
                      <div class="stat-card" style="background: linear-gradient(135deg, #dc3545, #a71e2a);">
                          <div class="d-flex justify-content-between align-items-center">
                              <div>
                                  <div class="stat-value" id="totalExpense">$0</div>
                                  <div class="stat-label">總支出</div>
                                  <div class="stat-change" id="expenseChange">
                                      <i class="fas fa-arrow-down"></i>
                                      <span>0%</span>
                                  </div>
                              </div>
                              <div class="fs-1 opacity-50">
                                  <i class="fas fa-arrow-down"></i>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="col-xl-3 col-md-6 mb-4">
                      <div class="stat-card" style="background: linear-gradient(135deg, #28a745, #1e7e34);">
                          <div class="d-flex justify-content-between align-items-center">
                              <div>
                                  <div class="stat-value" id="receiptCount">0</div>
                                  <div class="stat-label">收據數量</div>
                                  <div class="stat-change" id="receiptChange">
                                      <i class="fas fa-plus"></i>
                                      <span>0%</span>
                                  </div>
                              </div>
                              <div class="fs-1 opacity-50">
                                  <i class="fas fa-receipt"></i>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="col-xl-3 col-md-6 mb-4">
                      <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8, #117a8b);">
                          <div class="d-flex justify-content-between align-items-center">
                              <div>
                                  <div class="stat-value" id="memberCount">0</div>
                                  <div class="stat-label">會員人數</div>
                                  <div class="stat-change" id="memberChange">
                                      <i class="fas fa-users"></i>
                                      <span>0%</span>
                                  </div>
                              </div>
                              <div class="fs-1 opacity-50">
                                  <i class="fas fa-users"></i>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <div class="row">
                  <!-- 快速統計 -->
                  <div class="col-lg-8 mb-4">
                      <div class="card">
                          <div class="card-header">
                              <h5 class="mb-0">
                                  <i class="fas fa-chart-line me-2"></i>財務概況
                              </h5>
                          </div>
                          <div class="card-body">
                              <div class="row text-center">
                                  <div class="col-md-3">
                                      <h4 class="text-success" id="quickTotalIncome">$0</h4>
                                      <small class="text-muted">本月收入</small>
                                  </div>
                                  <div class="col-md-3">
                                      <h4 class="text-danger" id="quickTotalExpense">$0</h4>
                                      <small class="text-muted">本月支出</small>
                                  </div>
                                  <div class="col-md-3">
                                      <h4 class="text-primary" id="quickNetAmount">$0</h4>
                                      <small class="text-muted">淨額</small>
                                  </div>
                                  <div class="col-md-3">
                                      <h4 class="text-info" id="quickReceiptCount">0</h4>
                                      <small class="text-muted">收據張數</small>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- 快速操作 -->
                  <div class="col-lg-4 mb-4">
                      <div class="card">
                          <div class="card-header">
                              <h5 class="mb-0">
                                  <i class="fas fa-bolt me-2"></i>快速操作
                              </h5>
                          </div>
                          <div class="card-body">
                              <div class="d-grid gap-2">
                                  <button class="btn btn-primary" onclick="showTransactionForm()">
                                      <i class="fas fa-plus me-2"></i>新增交易記錄
                                  </button>
                                  <button class="btn btn-success" onclick="showReceiptForm()">
                                      <i class="fas fa-receipt me-2"></i>開立收據
                                  </button>
                                  <button class="btn btn-info" onclick="showMemberForm()">
                                      <i class="fas fa-user-plus me-2"></i>新增會員
                                  </button>
                                  <button class="btn btn-warning" onclick="generateReport()">
                                      <i class="fas fa-chart-bar me-2"></i>生成報表
                                  </button>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 最近活動 -->
              <div class="row">
                  <div class="col-12">
                      <div class="card">
                          <div class="card-header">
                              <h5 class="mb-0">
                                  <i class="fas fa-history me-2"></i>最近活動
                              </h5>
                          </div>
                          <div class="card-body">
                              <div id="recentActivities">
                                  <div class="text-center text-muted py-4">
                                      <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                      <p>載入中...</p>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>

          <!-- 交易記錄 -->
          <div class="tab-pane fade" id="transaction" role="tabpanel">
              <div class="row">
                  <!-- 新增交易表單 -->
                  <div class="col-lg-4 mb-4">
                      <div class="card">
                          <div class="card-header">
                              <h5 class="mb-0">
                                  <i class="fas fa-plus me-2"></i>新增交易記錄
                              </h5>
                          </div>
                          <div class="card-body">
                              <form id="transactionForm">
                                  <div class="mb-3">
                                      <label for="transactionDate" class="form-label">日期</label>
                                      <input type="date" class="form-control" id="transactionDate" name="transactionDate" required>
                                  </div>

                                  <div class="mb-3">
                                      <label for="transactionName" class="form-label">姓名</label>
                                      <input type="text" class="form-control" id="transactionName" name="transactionName" placeholder="請輸入姓名" required>
                                  </div>

                                  <div class="mb-3">
                                      <label for="transactionType" class="form-label">類型</label>
                                      <select class="form-select" id="transactionType" name="transactionType" required onchange="handleTransactionTypeChange()">
                                          <option value="">請選擇類型</option>
                                          <option value="收入">收入</option>
                                          <option value="支出">支出</option>
                                      </select>
                                  </div>

                                  <div class="mb-3">
                                      <label for="transactionCategory" class="form-label">類別</label>
                                      <select class="form-select" id="transactionCategory" name="transactionCategory" required>
                                          <option value="">請選擇類別</option>
                                      </select>
                                  </div>

                                  <div class="mb-3">
                                      <label for="transactionAccount" class="form-label">帳戶</label>
                                      <select class="form-select" id="transactionAccount" name="transactionAccount">
                                          <option value="">請選擇帳戶</option>
                                          <option value="現金">現金</option>
                                          <option value="銀行">銀行</option>
                                          <option value="郵局">郵局</option>
                                      </select>
                                  </div>

                                  <div class="mb-3">
                                      <label for="transactionAmount" class="form-label">金額</label>
                                      <input type="number" class="form-control" id="transactionAmount" name="transactionAmount" placeholder="請輸入金額" min="0" step="1" required>
                                  </div>

                                  <div class="mb-3">
                                      <label for="transactionDescription" class="form-label">說明</label>
                                      <textarea class="form-control" id="transactionDescription" name="transactionDescription" rows="3" placeholder="請輸入說明（選填）"></textarea>
                                  </div>

                                  <!-- 收入選項 -->
                                  <div id="incomeOptions" style="display: none;">
                                      <div class="mb-3">
                                          <div class="form-check">
                                              <input class="form-check-input" type="checkbox" id="generateReceipt" name="generateReceipt" onchange="toggleReceiptDetails()">
                                              <label class="form-check-label" for="generateReceipt">
                                                  同時開立收據
                                              </label>
                                          </div>
                                      </div>

                                      <div id="receiptDetails" style="display: none;">
                                          <div class="mb-3">
                                              <label for="receiptEmail" class="form-label">電子郵件</label>
                                              <input type="email" class="form-control" id="receiptEmail" name="receiptEmail" placeholder="用於寄送收據">
                                          </div>
                                          <div class="mb-3">
                                              <label for="receiptPhone" class="form-label">聯絡電話</label>
                                              <input type="tel" class="form-control" id="receiptPhone" name="receiptPhone" placeholder="聯絡電話">
                                          </div>
                                      </div>
                                  </div>

                                  <!-- 支出選項 -->
                                  <div id="expenseOptions" style="display: none;">
                                      <div class="mb-3">
                                          <label for="expenseVendor" class="form-label">廠商/店家</label>
                                          <input type="text" class="form-control" id="expenseVendor" name="expenseVendor" placeholder="廠商或店家名稱">
                                      </div>
                                      <div class="mb-3">
                                          <label for="expenseInvoice" class="form-label">發票號碼</label>
                                          <input type="text" class="form-control" id="expenseInvoice" name="expenseInvoice" placeholder="發票號碼（選填）">
                                      </div>
                                  </div>

                                  <div class="d-grid gap-2">
                                      <button type="submit" class="btn btn-primary">
                                          <i class="fas fa-save me-2"></i>儲存交易記錄
                                      </button>
                                      <button type="button" class="btn btn-secondary" onclick="clearTransactionForm()">
                                          <i class="fas fa-times me-2"></i>清除表單
                                      </button>
                                  </div>
                              </form>
                          </div>
                      </div>
                  </div>

                  <!-- 交易記錄列表 -->
                  <div class="col-lg-8 mb-4">
                      <div class="card">
                          <div class="card-header d-flex justify-content-between align-items-center">
                              <h5 class="mb-0">
                                  <i class="fas fa-list me-2"></i>交易記錄
                              </h5>
                              <div class="d-flex gap-2">
                                  <button class="btn btn-outline-success btn-sm" onclick="exportTransactions()">
                                      <i class="fas fa-download me-1"></i>匯出
                                  </button>
                                  <button class="btn btn-outline-primary btn-sm" onclick="refreshTransactions()">
                                      <i class="fas fa-sync me-1"></i>重新整理
                                  </button>
                              </div>
                          </div>
                          <div class="card-body">
                              <!-- 篩選器 -->
                              <div class="row mb-3">
                                  <div class="col-md-3">
                                      <input type="text" class="form-control" id="transactionSearch" placeholder="搜尋姓名或說明" onkeyup="debounce(filterTransactions, 500)()">
                                  </div>
                                  <div class="col-md-2">
                                      <select class="form-select" id="typeFilter" onchange="filterTransactions()">
                                          <option value="">全部類型</option>
                                          <option value="收入">收入</option>
                                          <option value="支出">支出</option>
                                      </select>
                                  </div>
                                  <div class="col-md-3">
                                      <input type="date" class="form-control" id="dateFromFilter" onchange="filterTransactions()">
                                  </div>
                                  <div class="col-md-3">
                                      <input type="date" class="form-control" id="dateToFilter" onchange="filterTransactions()">
                                  </div>
                                  <div class="col-md-1">
                                      <button class="btn btn-outline-secondary" onclick="clearTransactionFilters()" title="清除篩選">
                                          <i class="fas fa-times"></i>
                                      </button>
                                  </div>
                              </div>

                              <!-- 表格容器 -->
                              <div class="table-responsive">
                                  <div id="transactionTableContainer">
                                      <div class="text-center text-muted py-4">
                                          <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                          <p>載入中...</p>
                                      </div>
                                  </div>
                              </div>

                              <!-- 分頁 -->
                              <nav aria-label="交易記錄分頁" class="mt-3">
                                  <ul class="pagination justify-content-center" id="transactionPagination">
                                      <!-- 分頁按鈕將由 JavaScript 動態生成 -->
                                  </ul>
                              </nav>
                          </div>
                      </div>
                  </div>
              </div>
          </div>

          <!-- 收據管理 -->
          <div class="tab-pane fade" id="receipt" role="tabpanel">
              <div class="row">
                  <!-- 新增收據表單 -->
                  <div class="col-lg-4 mb-4">
                      <div class="card">
                          <div class="card-header">
                              <h5 class="mb-0">
                                  <i class="fas fa-receipt me-2"></i>開立收據
                              </h5>
                          </div>
                          <div class="card-body">
                              <form id="receiptForm">
                                  <div class="mb-3">
                                      <label for="receiptDate" class="form-label">收據日期</label>
                                      <input type="date" class="form-control" id="receiptDate" name="receiptDate" required>
                                  </div>

                                  <div class="mb-3">
                                      <label for="receiptPayer" class="form-label">付款人姓名</label>
                                      <input type="text" class="form-control" id="receiptPayer" name="receiptPayer" placeholder="請輸入付款人姓名" required>
                                  </div>

                                  <div class="mb-3">
                                      <label for="receiptIdentity" class="form-label">身分</label>
                                      <select class="form-select" id="receiptIdentity" name="receiptIdentity">
                                          <option value="">請選擇身分</option>
                                          <option value="會員">會員</option>
                                          <option value="家屬">家屬</option>
                                          <option value="志工">志工</option>
                                          <option value="一般民眾">一般民眾</option>
                                          <option value="企業">企業</option>
                                      </select>
                                  </div>

                                  <div class="mb-3">
                                      <label for="receiptCategory" class="form-label">收款類別</label>
                                      <select class="form-select" id="receiptCategory" name="receiptCategory" required>
                                          <option value="">請選擇類別</option>
                                          <option value="會費">會費</option>
                                          <option value="捐款">捐款</option>
                                          <option value="活動費用">活動費用</option>
                                          <option value="其他收入">其他收入</option>
                                      </select>
                                  </div>

                                  <div class="mb-3">
                                      <label for="receiptAmount" class="form-label">金額</label>
                                      <input type="number" class="form-control" id="receiptAmount" name="receiptAmount" placeholder="請輸入金額" min="0" step="1" required>
                                  </div>

                                  <div class="mb-3">
                                      <label for="receiptDescription" class="form-label">用途說明</label>
                                      <textarea class="form-control" id="receiptDescription" name="receiptDescription" rows="3" placeholder="請說明收款用途"></textarea>
                                  </div>

                                  <div class="mb-3">
                                      <label for="receiptPhone" class="form-label">聯絡電話</label>
                                      <input type="tel" class="form-control" id="receiptPhone" name="receiptPhone" placeholder="聯絡電話">
                                  </div>

                                  <div class="mb-3">
                                      <label for="receiptEmail" class="form-label">電子郵件</label>
                                      <input type="email" class="form-control" id="receiptEmail" name="receiptEmail" placeholder="用於寄送電子收據">
                                  </div>

                                  <div class="d-grid gap-2">
                                      <button type="submit" class="btn btn-success">
                                          <i class="fas fa-receipt me-2"></i>開立收據
                                      </button>
                                      <button type="button" class="btn btn-secondary" onclick="clearReceiptForm()">
                                          <i class="fas fa-times me-2"></i>清除表單
                                      </button>
                                  </div>
                              </form>
                          </div>
                      </div>
                  </div>

                  <!-- 收據列表 -->
                  <div class="col-lg-8 mb-4">
                      <div class="card">
                          <div class="card-header d-flex justify-content-between align-items-center">
                              <h5 class="mb-0">
                                  <i class="fas fa-list me-2"></i>收據列表
                              </h5>
                              <div class="d-flex gap-2">
                                  <button class="btn btn-outline-success btn-sm" onclick="exportReceipts()">
                                      <i class="fas fa-download me-1"></i>匯出
                                  </button>
                                  <button class="btn btn-outline-primary btn-sm" onclick="refreshReceipts()">
                                      <i class="fas fa-sync me-1"></i>重新整理
                                  </button>
                              </div>
                          </div>
                          <div class="card-body">
                              <!-- 篩選器 -->
                              <div class="row mb-3">
                                  <div class="col-md-4">
                                      <input type="text" class="form-control" id="receiptSearch" placeholder="搜尋付款人或收據編號" onkeyup="debounce(filterReceipts, 500)()">
                                  </div>
                                  <div class="col-md-3">
                                      <select class="form-select" id="receiptStatusFilter" onchange="filterReceipts()">
                                          <option value="">全部狀態</option>
                                          <option value="已開立">已開立</option>
                                          <option value="已寄送">已寄送</option>
                                          <option value="已列印">已列印</option>
                                      </select>
                                  </div>
                                  <div class="col-md-3">
                                      <select class="form-select" id="receiptCategoryFilter" onchange="filterReceipts()">
                                          <option value="">全部類別</option>
                                          <option value="會費">會費</option>
                                          <option value="捐款">捐款</option>
                                          <option value="活動費用">活動費用</option>
                                          <option value="其他收入">其他收入</option>
                                      </select>
                                  </div>
                                  <div class="col-md-2">
                                      <button class="btn btn-outline-secondary w-100" onclick="clearReceiptFilters()" title="清除篩選">
                                          <i class="fas fa-times"></i> 清除
                                      </button>
                                  </div>
                              </div>

                              <!-- 表格容器 -->
                              <div class="table-responsive">
                                  <div id="receiptTableContainer">
                                      <div class="text-center text-muted py-4">
                                          <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                          <p>載入中...</p>
                                      </div>
                                  </div>
                              </div>

                              <!-- 分頁 -->
                              <nav aria-label="收據分頁" class="mt-3">
                                  <ul class="pagination justify-content-center" id="receiptPagination">
                                      <!-- 分頁按鈕將由 JavaScript 動態生成 -->
                                  </ul>
                              </nav>
                          </div>
                      </div>
                  </div>
              </div>
          </div>

          <!-- 會員管理 -->
          <div class="tab-pane fade" id="member" role="tabpanel">
              <div class="row">
                  <!-- 新增會員表單 -->
                  <div class="col-lg-4 mb-4">
                      <div class="card">
                          <div class="card-header">
                              <h5 class="mb-0">
                                  <i class="fas fa-user-plus me-2"></i>新增會員
                              </h5>
                          </div>
                          <div class="card-body">
                              <form id="memberForm">
                                  <div class="mb-3">
                                      <label for="memberName" class="form-label">姓名 <span class="text-danger">*</span></label>
                                      <input type="text" class="form-control" id="memberName" name="memberName" placeholder="請輸入姓名" required>
                                  </div>

                                  <div class="mb-3">
                                      <label for="memberGender" class="form-label">性別</label>
                                      <select class="form-select" id="memberGender" name="memberGender">
                                          <option value="">請選擇性別</option>
                                          <option value="男">男</option>
                                          <option value="女">女</option>
                                      </select>
                                  </div>

                                  <div class="mb-3">
                                      <label for="memberBirthDate" class="form-label">生日</label>
                                      <input type="date" class="form-control" id="memberBirthDate" name="memberBirthDate">
                                  </div>

                                  <div class="mb-3">
                                      <label for="memberIdCard" class="form-label">身分證字號</label>
                                      <input type="text" class="form-control" id="memberIdCard" name="memberIdCard" placeholder="請輸入身分證字號" maxlength="10">
                                  </div>

                                  <div class="mb-3">
                                      <label for="memberPhone" class="form-label">電話 <span class="text-danger">*</span></label>
                                      <input type="tel" class="form-control" id="memberPhone" name="memberPhone" placeholder="請輸入聯絡電話" required>
                                  </div>

                                  <div class="mb-3">
                                      <label for="memberMobile" class="form-label">手機</label>
                                      <input type="tel" class="form-control" id="memberMobile" name="memberMobile" placeholder="請輸入手機號碼">
                                  </div>

                                  <div class="mb-3">
                                      <label for="memberEmail" class="form-label">電子郵件</label>
                                      <input type="email" class="form-control" id="memberEmail" name="memberEmail" placeholder="請輸入電子郵件">
                                  </div>

                                  <div class="mb-3">
                                      <label for="memberType" class="form-label">會員類型 <span class="text-danger">*</span></label>
                                      <select class="form-select" id="memberType" name="memberType" required>
                                          <option value="">請選擇會員類型</option>
                                          <option value="正式會員">正式會員</option>
                                          <option value="家屬會員">家屬會員</option>
                                          <option value="志工會員">志工會員</option>
                                          <option value="榮譽會員">榮譽會員</option>
                                      </select>
                                  </div>

                                  <div class="mb-3">
                                      <label for="memberJoinDate" class="form-label">入會日期</label>
                                      <input type="date" class="form-control" id="memberJoinDate" name="memberJoinDate">
                                  </div>

                                  <div class="mb-3">
                                      <label for="memberAddress" class="form-label">地址</label>
                                      <textarea class="form-control" id="memberAddress" name="memberAddress" rows="2" placeholder="請輸入地址"></textarea>
                                  </div>

                                  <div class="mb-3">
                                      <label for="memberEmergencyContact" class="form-label">緊急聯絡人</label>
                                      <input type="text" class="form-control" id="memberEmergencyContact" name="memberEmergencyContact" placeholder="緊急聯絡人姓名">
                                  </div>

                                  <div class="mb-3">
                                      <label for="memberEmergencyPhone" class="form-label">緊急聯絡電話</label>
                                      <input type="tel" class="form-control" id="memberEmergencyPhone" name="memberEmergencyPhone" placeholder="緊急聯絡電話">
                                  </div>

                                  <div class="mb-3">
                                      <label for="memberNotes" class="form-label">備註</label>
                                      <textarea class="form-control" id="memberNotes" name="memberNotes" rows="3" placeholder="其他備註資訊"></textarea>
                                  </div>

                                  <div class="d-grid gap-2">
                                      <button type="submit" class="btn btn-info">
                                          <i class="fas fa-user-plus me-2"></i>新增會員
                                      </button>
                                      <button type="button" class="btn btn-secondary" onclick="clearMemberForm()">
                                          <i class="fas fa-times me-2"></i>清除表單
                                      </button>
                                  </div>
                              </form>
                          </div>
                      </div>
                  </div>

                  <!-- 會員列表 -->
                  <div class="col-lg-8 mb-4">
                      <div class="card">
                          <div class="card-header d-flex justify-content-between align-items-center">
                              <h5 class="mb-0">
                                  <i class="fas fa-users me-2"></i>會員列表
                              </h5>
                              <div class="d-flex gap-2">
                                  <button class="btn btn-outline-info btn-sm" onclick="importMembers()">
                                      <i class="fas fa-upload me-1"></i>匯入
                                  </button>
                                  <button class="btn btn-outline-success btn-sm" onclick="exportMembers()">
                                      <i class="fas fa-download me-1"></i>匯出
                                  </button>
                                  <button class="btn btn-outline-primary btn-sm" onclick="refreshMembers()">
                                      <i class="fas fa-sync me-1"></i>重新整理
                                  </button>
                              </div>
                          </div>
                          <div class="card-body">
                              <!-- 篩選器 -->
                              <div class="row mb-3">
                                  <div class="col-md-3">
                                      <input type="text" class="form-control" id="memberSearch" placeholder="搜尋姓名或電話" onkeyup="debounce(filterMembers, 500)()">
                                  </div>
                                  <div class="col-md-3">
                                      <select class="form-select" id="memberTypeFilter" onchange="filterMembers()">
                                          <option value="">全部類型</option>
                                          <option value="正式會員">正式會員</option>
                                          <option value="家屬會員">家屬會員</option>
                                          <option value="志工會員">志工會員</option>
                                          <option value="榮譽會員">榮譽會員</option>
                                      </select>
                                  </div>
                                  <div class="col-md-3">
                                      <select class="form-select" id="memberStatusFilter" onchange="filterMembers()">
                                          <option value="">全部狀態</option>
                                          <option value="已繳費">已繳費</option>
                                          <option value="未繳費">未繳費</option>
                                          <option value="部分繳費">部分繳費</option>
                                          <option value="免繳費">免繳費</option>
                                      </select>
                                  </div>
                                  <div class="col-md-3">
                                      <button class="btn btn-outline-secondary w-100" onclick="clearMemberFilters()" title="清除篩選">
                                          <i class="fas fa-times"></i> 清除篩選
                                      </button>
                                  </div>
                              </div>

                              <!-- 表格容器 -->
                              <div class="table-responsive">
                                  <div id="memberTableContainer">
                                      <div class="text-center text-muted py-4">
                                          <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                          <p>載入中...</p>
                                      </div>
                                  </div>
                              </div>

                              <!-- 分頁 -->
                              <nav aria-label="會員分頁" class="mt-3">
                                  <ul class="pagination justify-content-center" id="memberPagination">
                                      <!-- 分頁按鈕將由 JavaScript 動態生成 -->
                                  </ul>
                              </nav>
                          </div>
                      </div>
                  </div>
              </div>
          </div>

          <!-- 報表分析 -->
          <div class="tab-pane fade" id="report" role="tabpanel">
              <div class="row">
                  <!-- 報表設定 -->
                  <div class="col-lg-4 mb-4">
                      <div class="card">
                          <div class="card-header">
                              <h5 class="mb-0">
                                  <i class="fas fa-cog me-2"></i>報表設定
                              </h5>
                          </div>
                          <div class="card-body">
                              <form id="reportForm">
                                  <div class="mb-3">
                                      <label for="reportType" class="form-label">報表類型</label>
                                      <select class="form-select" id="reportType" name="reportType" onchange="handleReportTypeChange()">
                                          <option value="monthly">月度報表</option>
                                          <option value="yearly">年度報表</option>
                                          <option value="custom">自訂期間</option>
                                      </select>
                                  </div>

                                  <div class="mb-3" id="yearGroup">
                                      <label for="reportYear" class="form-label">年度</label>
                                      <select class="form-select" id="reportYear" name="reportYear" onchange="updateReportMonths()">
                                          <!-- 年份選項將由 JavaScript 動態生成 -->
                                      </select>
                                  </div>

                                  <div class="mb-3" id="monthGroup">
                                      <label for="reportMonth" class="form-label">月份</label>
                                      <select class="form-select" id="reportMonth" name="reportMonth">
                                          <option value="1">1月</option>
                                          <option value="2">2月</option>
                                          <option value="3">3月</option>
                                          <option value="4">4月</option>
                                          <option value="5">5月</option>
                                          <option value="6">6月</option>
                                          <option value="7">7月</option>
                                          <option value="8">8月</option>
                                          <option value="9">9月</option>
                                          <option value="10">10月</option>
                                          <option value="11">11月</option>
                                          <option value="12">12月</option>
                                      </select>
                                  </div>

                                  <div class="mb-3" id="customDateGroup" style="display: none;">
                                      <label for="reportStartDate" class="form-label">開始日期</label>
                                      <input type="date" class="form-control" id="reportStartDate" name="reportStartDate">
                                      <label for="reportEndDate" class="form-label mt-2">結束日期</label>
                                      <input type="date" class="form-control" id="reportEndDate" name="reportEndDate">
                                  </div>

                                  <div class="mb-3">
                                      <label class="form-label">包含項目</label>
                                      <div class="form-check">
                                          <input class="form-check-input" type="checkbox" id="includeIncome" name="includeIncome" checked>
                                          <label class="form-check-label" for="includeIncome">收入明細</label>
                                      </div>
                                      <div class="form-check">
                                          <input class="form-check-input" type="checkbox" id="includeExpense" name="includeExpense" checked>
                                          <label class="form-check-label" for="includeExpense">支出明細</label>
                                      </div>
                                      <div class="form-check">
                                          <input class="form-check-input" type="checkbox" id="includeReceipts" name="includeReceipts" checked>
                                          <label class="form-check-label" for="includeReceipts">收據統計</label>
                                      </div>
                                      <div class="form-check">
                                          <input class="form-check-input" type="checkbox" id="includeMembers" name="includeMembers">
                                          <label class="form-check-label" for="includeMembers">會員統計</label>
                                      </div>
                                  </div>

                                  <div class="d-grid gap-2">
                                      <button type="submit" class="btn btn-warning">
                                          <i class="fas fa-chart-bar me-2"></i>生成報表
                                      </button>
                                      <button type="button" class="btn btn-outline-info" onclick="scheduleReport()">
                                          <i class="fas fa-clock me-2"></i>排程報表
                                      </button>
                                  </div>
                              </form>
                          </div>
                      </div>

                      <!-- 快速統計 -->
                      <div class="card mt-4">
                          <div class="card-header">
                              <h5 class="mb-0">
                                  <i class="fas fa-tachometer-alt me-2"></i>快速統計
                              </h5>
                          </div>
                          <div class="card-body">
                              <div class="row text-center">
                                  <div class="col-6 mb-3">
                                      <h4 class="text-success" id="reportQuickIncome">$0</h4>
                                      <small class="text-muted">本月收入</small>
                                  </div>
                                  <div class="col-6 mb-3">
                                      <h4 class="text-danger" id="reportQuickExpense">$0</h4>
                                      <small class="text-muted">本月支出</small>
                                  </div>
                                  <div class="col-6 mb-3">
                                      <h4 class="text-primary" id="reportQuickNet">$0</h4>
                                      <small class="text-muted">淨收入</small>
                                  </div>
                                  <div class="col-6 mb-3">
                                      <h4 class="text-info" id="reportQuickReceipts">0</h4>
                                      <small class="text-muted">收據數</small>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- 報表內容 -->
                  <div class="col-lg-8 mb-4">
                      <div class="card">
                          <div class="card-header d-flex justify-content-between align-items-center">
                              <h5 class="mb-0">
                                  <i class="fas fa-file-alt me-2"></i>報表內容
                              </h5>
                              <div class="d-flex gap-2">
                                  <button class="btn btn-outline-success btn-sm" onclick="printReport()">
                                      <i class="fas fa-print me-1"></i>列印
                                  </button>
                                  <button class="btn btn-outline-primary btn-sm" onclick="refreshReport()">
                                      <i class="fas fa-sync me-1"></i>重新整理
                                  </button>
                              </div>
                          </div>
                          <div class="card-body">
                              <div id="reportContent">
                                  <div class="text-center text-muted py-5">
                                      <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                      <h5>請選擇報表設定並點擊「生成報表」</h5>
                                      <p>系統將根據您的設定生成對應的財務報表</p>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- 快速操作按鈕 -->
  <div class="quick-actions d-none d-lg-block">
      <button class="btn btn-primary quick-action-btn" onclick="showTransactionForm()" title="新增交易記錄 (Ctrl+N)">
          <i class="fas fa-plus"></i>
      </button>
      <button class="btn btn-success quick-action-btn" onclick="showReceiptForm()" title="開立收據 (Ctrl+R)">
          <i class="fas fa-receipt"></i>
      </button>
      <button class="btn btn-info quick-action-btn" onclick="showMemberForm()" title="新增會員 (Ctrl+M)">
          <i class="fas fa-user-plus"></i>
      </button>
  </div>

  <!-- 載入遮罩 -->
  <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-content">
          <div class="spinner"></div>
          <div id="loadingText">載入中...</div>
      </div>
  </div>

  <!-- 模態視窗 - 交易記錄詳情 -->
  <div class="modal fade" id="transactionModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="fas fa-eye me-2"></i>交易記錄詳情
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="transactionModalBody">
                  <!-- 內容將由 JavaScript 動態生成 -->
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
              </div>
          </div>
      </div>
  </div>

  <!-- 模態視窗 - 收據詳情 -->
  <div class="modal fade" id="receiptModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="fas fa-receipt me-2"></i>收據詳情
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="receiptModalBody">
                  <!-- 內容將由 JavaScript 動態生成 -->
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                  <button type="button" class="btn btn-success" onclick="downloadReceipt()">
                      <i class="fas fa-download me-1"></i>下載收據
                  </button>
              </div>
          </div>
      </div>
  </div>

  <!-- 模態視窗 - 會員詳情 -->
  <div class="modal fade" id="memberModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="fas fa-user me-2"></i>會員詳情
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="memberModalBody">
                  <!-- 內容將由 JavaScript 動態生成 -->
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                  <button type="button" class="btn btn-warning" onclick="editMember()">
                      <i class="fas fa-edit me-1"></i>編輯會員
                  </button>
              </div>
          </div>
      </div>
  </div>

  <!-- 頁尾 -->
  <footer class="footer">
      <div class="container">
          <div class="row">
              <div class="col-md-6">
                  <h6>台灣帕金森病友權益促進會</h6>
                  <p class="mb-0">會計管理系統 v4.0</p>
                  <small class="text-muted">最後更新: <span id="lastUpdate"></span></small>
              </div>
              <div class="col-md-6 text-md-end">
                  <p class="mb-0">
                      <i class="fas fa-phone me-2"></i>聯絡電話: (02) 1234-5678
                  </p>
                  <p class="mb-0">
                      <i class="fas fa-envelope me-2"></i>電子郵件: info@parkinson.org.tw
                  </p>
                  <small class="text-muted">© 2024 台灣帕金森病友權益促進會</small>
              </div>
          </div>
      </div>
  </footer>

  <!-- JavaScript 框架 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

  <!-- 主要 JavaScript -->
  <script>
      // ========================================
      // 全域變數和設定
      // ========================================
      
      // Google Apps Script 網址 - 請替換為您的實際網址
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby2j_5KHny2r92VgXXGtI3Wg7Q1RsGwQ_jWd9FiKEJmAbcJNblmjM7l5hld4FDjnN7D2Q/exec';
      
      // 全域資料儲存
      let globalData = {
          transactions: [],
          receipts: [],
          members: [],
          settings: {}
      };

      // 分頁設定
      const ITEMS_PER_PAGE = 10;
      let currentPage = {
          transactions: 1,
          receipts: 1,
          members: 1
      };

      // 篩選設定
      let currentFilters = {
          transactions: {},
          receipts: {},
          members: {}
      };

      // ========================================
      // 初始化函數
      // ========================================
      
      document.addEventListener('DOMContentLoaded', function() {
          initializeSystem();
      });

      async function initializeSystem() {
          try {
              showLoading('系統初始化中...');
              
              // 設定當前日期
              setCurrentDate();
              
              // 更新時間顯示
              updateCurrentTime();
              setInterval(updateCurrentTime, 1000);
              
              // 載入初始資料
              await loadInitialData();
              
              // 設定事件監聽器
              setupEventListeners();
              
              // 設定分頁切換
              setupTabHandlers();
              
              // 載入離線佇列
              loadOfflineQueue();
              
              // 啟用自動儲存
              enableAutoSave('transactionForm');
              enableAutoSave('receiptForm');
              enableAutoSave('memberForm');
              
              hideLoading();
              
              console.log('系統初始化完成');
              
          } catch (error) {
              console.error('系統初始化失敗:', error);
              showAlert('系統初始化失敗，請重新整理頁面', 'danger');
              hideLoading();
          }
      }

      function setCurrentDate() {
          const today = new Date().toISOString().split('T')[0];
          const dateInputs = ['transactionDate', 'receiptDate', 'memberJoinDate'];
          
          dateInputs.forEach(id => {
              const input = document.getElementById(id);
              if (input && !input.value) {
                  input.value = today;
              }
          });
      }

      function updateCurrentTime() {
          const now = new Date();
          const timeString = now.toLocaleString('zh-TW', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
          });
          
          const timeElement = document.getElementById('currentTime');
          if (timeElement) {
              timeElement.textContent = timeString;
          }
      }

      // ========================================
      // 資料載入函數
      // ========================================
      
      async function loadInitialData() {
          try {
              // 載入所有資料
              await Promise.all([
                  loadTransactions(),
                  loadReceipts(),
                  loadMembers(),
                  loadSettings()
              ]);
              
              // 更新儀表板
              updateDashboard();
              
          } catch (error) {
              console.error('載入初始資料失敗:', error);
              throw error;
          }
      }

      async function loadTransactions() {
          try {
              const response = await fetch(SCRIPT_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'getTransactions'
                  })
              });

              const result = await response.json();
              
              if (result.success) {
                  globalData.transactions = result.data || [];
                  renderTransactionTable();
              } else {
                  throw new Error(result.message || '載入交易記錄失敗');
              }
              
          } catch (error) {
              console.error('載入交易記錄錯誤:', error);
              if (!navigator.onLine) {
                  // 離線時從 localStorage 載入
                  const offlineData = localStorage.getItem('transactions');
                  if (offlineData) {
                      globalData.transactions = JSON.parse(offlineData);
                      renderTransactionTable();
                  }
              }
              throw error;
          }
      }

      async function loadReceipts() {
          try {
              const response = await fetch(SCRIPT_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'getReceipts'
                  })
              });

              const result = await response.json();
              
              if (result.success) {
                  globalData.receipts = result.data || [];
                  renderReceiptTable();
              } else {
                  throw new Error(result.message || '載入收據記錄失敗');
              }
              
          } catch (error) {
              console.error('載入收據記錄錯誤:', error);
              if (!navigator.onLine) {
                  const offlineData = localStorage.getItem('receipts');
                  if (offlineData) {
                      globalData.receipts = JSON.parse(offlineData);
                      renderReceiptTable();
                  }
              }
              throw error;
          }
      }

      async function loadMembers() {
          try {
              const response = await fetch(SCRIPT_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'getMembers'
                  })
              });

              const result = await response.json();
              
              if (result.success) {
                  globalData.members = result.data || [];
                  renderMemberTable();
              } else {
                  throw new Error(result.message || '載入會員資料失敗');
              }
              
          } catch (error) {
              console.error('載入會員資料錯誤:', error);
              if (!navigator.onLine) {
                  const offlineData = localStorage.getItem('members');
                  if (offlineData) {
                      globalData.members = JSON.parse(offlineData);
                      renderMemberTable();
                  }
              }
              throw error;
          }
      }

      async function loadSettings() {
          try {
              const response = await fetch(SCRIPT_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'getSettings'
                  })
              });

              const result = await response.json();
              
              if (result.success) {
                  globalData.settings = result.data || {};
              } else {
                  console.warn('載入設定失敗，使用預設設定');
                  globalData.settings = getDefaultSettings();
              }
              
          } catch (error) {
              console.error('載入設定錯誤:', error);
              globalData.settings = getDefaultSettings();
          }
      }

      function getDefaultSettings() {
          return {
              organizationName: '台灣帕金森病友權益促進會',
              organizationAddress: '台北市中正區重慶南路一段122號',
              organizationPhone: '(02) 1234-5678',
              organizationEmail: 'info@parkinson.org.tw',
              receiptPrefix: 'PDA',
              memberPrefix: 'M'
          };
      }

      // ========================================
      // 事件監聽器設定
      // ========================================
      
      function setupEventListeners() {
          // 表單提交事件
          document.getElementById('transactionForm').addEventListener('submit', handleTransactionSubmit);
          document.getElementById('receiptForm').addEventListener('submit', handleReceiptSubmit);
          document.getElementById('memberForm').addEventListener('submit', handleMemberSubmit);
          document.getElementById('reportForm').addEventListener('submit', handleReportSubmit);
          
          // 分頁切換事件
          document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
              tab.addEventListener('shown.bs.tab', function(event) {
                  const target = event.target.getAttribute('data-bs-target');
                  handleTabChange(target);
              });
          });
      }

      function setupTabHandlers() {
          const tabs = document.querySelectorAll('#mainTabs .nav-link');
          tabs.forEach(tab => {
              tab.addEventListener('click', function() {
                  const target = this.getAttribute('data-bs-target');
                  setTimeout(() => {
                      handleTabChange(target);
                  }, 100);
              });
          });
      }

      function handleTabChange(target) {
          switch(target) {
              case '#dashboard':
                  updateDashboard();
                  break;
              case '#transaction':
                  renderTransactionTable();
                  break;
              case '#receipt':
                  renderReceiptTable();
                  break;
              case '#member':
                  renderMemberTable();
                  break;
              case '#report':
                  initializeReportTab();
                  break;
          }
      }

      // ========================================
      // 表單處理函數
      // ========================================
      
      async function handleTransactionSubmit(event) {
          event.preventDefault();
          
          try {
              showLoading('儲存交易記錄中...');
              
              const formData = new FormData(event.target);
              const data = Object.fromEntries(formData.entries());
              
              // 資料驗證
              if (!validateTransactionData(data)) {
                  hideLoading();
                  return;
              }
              
              // 清理資料
              data.transactionName = sanitizeInput(data.transactionName);
              data.transactionDescription = sanitizeInput(data.transactionDescription);
              data.transactionAmount = parseFloat(data.transactionAmount);
              
              // 新增時間戳記
              data.timestamp = new Date().toISOString();
              data.id = generateId();
              
              if (navigator.onLine) {
                  const response = await fetch(SCRIPT_URL, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                          action: 'addTransaction',
                          data: data
                      })
                  });

                  const result = await response.json();
                  
                  if (result.success) {
                      globalData.transactions.unshift(data);
                      renderTransactionTable();
                      updateDashboard();
                      clearTransactionForm();
                      clearFormDraft('transactionForm');
                      showAlert('交易記錄已成功儲存', 'success');
                      
                      // 如果需要同時開立收據
                      if (data.generateReceipt && data.transactionType === '收入') {
                          await generateReceiptFromTransaction(data);
                      }
                  } else {
                      throw new Error(result.message || '儲存失敗');
                  }
              } else {
                  // 離線模式
                  addToOfflineQueue('addTransaction', data);
                  globalData.transactions.unshift(data);
                  renderTransactionTable();
                  updateDashboard();
                  clearTransactionForm();
              }
              
              hideLoading();
              
          } catch (error) {
              console.error('儲存交易記錄錯誤:', error);
              showAlert('儲存交易記錄失敗: ' + error.message, 'danger');
              hideLoading();
          }
      }

      async function handleReceiptSubmit(event) {
          event.preventDefault();
          
          try {
              showLoading('開立收據中...');
              
              const formData = new FormData(event.target);
              const data = Object.fromEntries(formData.entries());
              
              // 資料驗證
              if (!validateReceiptData(data)) {
                  hideLoading();
                  return;
              }
              
              // 清理資料
              data.receiptPayer = sanitizeInput(data.receiptPayer);
              data.receiptDescription = sanitizeInput(data.receiptDescription);
              data.receiptAmount = parseFloat(data.receiptAmount);
              
              // 生成收據編號
              data.receiptNumber = generateReceiptNumber();
              data.timestamp = new Date().toISOString();
              data.id = generateId();
              data.status = '已開立';
              
              if (navigator.onLine) {
                  const response = await fetch(SCRIPT_URL, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                          action: 'addReceipt',
                          data: data
                      })
                  });

                  const result = await response.json();
                  
                  if (result.success) {
                      globalData.receipts.unshift(data);
                      renderReceiptTable();
                      updateDashboard();
                      clearReceiptForm();
                      clearFormDraft('receiptForm');
                      showAlert('收據已成功開立，編號: ' + data.receiptNumber, 'success');
                      
                      // 如果有電子郵件，自動寄送
                      if (data.receiptEmail) {
                          await sendReceiptEmail(data);
                      }
                  } else {
                      throw new Error(result.message || '開立收據失敗');
                  }
              } else {
                  // 離線模式
                  addToOfflineQueue('addReceipt', data);
                  globalData.receipts.unshift(data);
                  renderReceiptTable();
                  updateDashboard();
                  clearReceiptForm();
              }
              
              hideLoading();
              
          } catch (error) {
              console.error('開立收據錯誤:', error);
              showAlert('開立收據失敗: ' + error.message, 'danger');
              hideLoading();
          }
      }

      async function handleMemberSubmit(event) {
          event.preventDefault();
          
          try {
              showLoading('新增會員中...');
              
              const formData = new FormData(event.target);
              const data = Object.fromEntries(formData.entries());
              
              // 資料驗證
              if (!validateMemberData(data)) {
                  hideLoading();
                  return;
              }
              
              // 清理資料
              data.memberName = sanitizeInput(data.memberName);
              data.memberPhone = formatPhoneNumber(data.memberPhone);
              data.memberMobile = formatPhoneNumber(data.memberMobile);
              data.memberAddress = sanitizeInput(data.memberAddress);
              data.memberNotes = sanitizeInput(data.memberNotes);
              
              // 生成會員編號
              data.memberNumber = generateMemberNumber();
              data.timestamp = new Date().toISOString();
              data.id = generateId();
              data.status = '已繳費'; // 預設狀態
              
              if (navigator.onLine) {
                  const response = await fetch(SCRIPT_URL, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                          action: 'addMember',
                          data: data
                      })
                  });

                  const result = await response.json();
                  
                  if (result.success) {
                      globalData.members.unshift(data);
                      renderMemberTable();
                      updateDashboard();
                      clearMemberForm();
                      clearFormDraft('memberForm');
                      showAlert('會員已成功新增，編號: ' + data.memberNumber, 'success');
                  } else {
                      throw new Error(result.message || '新增會員失敗');
                  }
              } else {
                  // 離線模式
                  addToOfflineQueue('addMember', data);
                  globalData.members.unshift(data);
                  renderMemberTable();
                  updateDashboard();
                  clearMemberForm();
              }
              
              hideLoading();
              
          } catch (error) {
              console.error('新增會員錯誤:', error);
              showAlert('新增會員失敗: ' + error.message, 'danger');
              hideLoading();
          }
      }

      async function handleReportSubmit(event) {
          event.preventDefault();
          
          try {
              showLoading('生成報表中...');
              
              const formData = new FormData(event.target);
              const data = Object.fromEntries(formData.entries());
              
              // 生成報表
              const reportData = await generateReportData(data);
              renderReport(reportData);
              
              hideLoading();
              showAlert('報表已成功生成', 'success');
              
          } catch (error) {
              console.error('生成報表錯誤:', error);
              showAlert('生成報表失敗: ' + error.message, 'danger');
              hideLoading();
          }
      }

      // ========================================
      // 資料驗證函數
      // ========================================
      
      function validateTransactionData(data) {
          if (!data.transactionDate) {
              showAlert('請選擇交易日期', 'warning');
              return false;
          }
          
          if (!data.transactionName || data.transactionName.trim() === '') {
              showAlert('請輸入姓名', 'warning');
              return false;
          }
          
          if (!data.transactionType) {
              showAlert('請選擇交易類型', 'warning');
              return false;
          }
          
          if (!data.transactionCategory) {
              showAlert('請選擇交易類別', 'warning');
              return false;
          }
          
          if (!data.transactionAmount || parseFloat(data.transactionAmount) <= 0) {
              showAlert('請輸入有效的金額', 'warning');
              return false;
          }
          
          return true;
      }

      function validateReceiptData(data) {
          if (!data.receiptDate) {
              showAlert('請選擇收據日期', 'warning');
              return false;
          }
          
          if (!data.receiptPayer || data.receiptPayer.trim() === '') {
              showAlert('請輸入付款人姓名', 'warning');
              return false;
          }
          
          if (!data.receiptCategory) {
              showAlert('請選擇收款類別', 'warning');
              return false;
          }
          
          if (!data.receiptAmount || parseFloat(data.receiptAmount) <= 0) {
              showAlert('請輸入有效的金額', 'warning');
              return false;
          }
          
          if (data.receiptEmail && !isValidEmail(data.receiptEmail)) {
              showAlert('請輸入有效的電子郵件地址', 'warning');
              return false;
          }
          
          return true;
      }

      function validateMemberData(data) {
          if (!data.memberName || data.memberName.trim() === '') {
              showAlert('請輸入會員姓名', 'warning');
              return false;
          }
          
          if (!data.memberPhone || data.memberPhone.trim() === '') {
              showAlert('請輸入聯絡電話', 'warning');
              return false;
          }
          
          if (!data.memberType) {
              showAlert('請選擇會員類型', 'warning');
              return false;
          }
          
          if (data.memberEmail && !isValidEmail(data.memberEmail)) {
              showAlert('請輸入有效的電子郵件地址', 'warning');
              return false;
          }
          
          if (data.memberIdCard && !isValidIdCard(data.memberIdCard)) {
              showAlert('請輸入有效的身分證字號', 'warning');
              return false;
          }
          
          return true;
      }

      // ========================================
      // 工具函數
      // ========================================
      
      function generateId() {
          return Date.now().toString(36) + Math.random().toString(36).substr(2);
      }

      function generateReceiptNumber() {
          const prefix = globalData.settings.receiptPrefix || 'PDA';
          const year = new Date().getFullYear();
          const month = String(new Date().getMonth() + 1).padStart(2, '0');
          const count = globalData.receipts.filter(r => 
              r.receiptNumber && r.receiptNumber.startsWith(prefix + year + month)
          ).length + 1;
          
          return `${prefix}${year}${month}${String(count).padStart(4, '0')}`;
      }

      function generateMemberNumber() {
          const prefix = globalData.settings.memberPrefix || 'M';
          const year = new Date().getFullYear();
          const count = globalData.members.filter(m => 
              m.memberNumber && m.memberNumber.startsWith(prefix + year)
          ).length + 1;
          
          return `${prefix}${year}${String(count).padStart(4, '0')}`;
      }

      function sanitizeInput(input) {
          if (typeof input !== 'string') return input;
          
          return input
              .replace(/[<>]/g, '') // 移除 HTML 標籤
              .trim(); // 移除前後空白
      }

      function isValidEmail(email) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailRegex.test(email);
      }

      function isValidIdCard(idCard) {
          const idRegex = /^[A-Z][12]\d{8}$/;
          return idRegex.test(idCard);
      }

      function formatPhoneNumber(phone) {
          if (!phone) return phone;
          
          const cleaned = phone.replace(/\D/g, '');
          
          if (cleaned.length === 10 && cleaned.startsWith('0')) {
              return cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3');
          } else if (cleaned.length === 9) {
              return '0' + cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3');
          }
          
          return phone;
      }

      function formatCurrency(amount) {
          return new Intl.NumberFormat('zh-TW', {
              style: 'currency',
              currency: 'TWD',
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
          }).format(amount);
      }

      function formatDate(dateString) {
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
          });
      }

      // ========================================
      // UI 輔助函數
      // ========================================
      
      function showLoading(message = '載入中...') {
          const overlay = document.getElementById('loadingOverlay');
          const text = document.getElementById('loadingText');
          
          if (text) text.textContent = message;
          if (overlay) overlay.classList.add('show');
      }

      function hideLoading() {
          const overlay = document.getElementById('loadingOverlay');
          if (overlay) overlay.classList.remove('show');
      }

      function showAlert(message, type = 'info', duration = 5000) {
          const alertContainer = document.getElementById('globalMessage');
          if (!alertContainer) return;
          
          const alertId = 'alert-' + Date.now();
          const alertHtml = `
              <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="${alertId}">
                  <i class="fas fa-${getAlertIcon(type)} me-2"></i>
                  ${message}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
          `;
          
          alertContainer.insertAdjacentHTML('beforeend', alertHtml);
          
          // 自動關閉
          if (duration > 0) {
              setTimeout(() => {
                  const alert = document.getElementById(alertId);
                  if (alert) {
                      const bsAlert = new bootstrap.Alert(alert);
                      bsAlert.close();
                  }
              }, duration);
          }
      }

      function getAlertIcon(type) {
          const icons = {
              'success': 'check-circle',
              'danger': 'exclamation-triangle',
              'warning': 'exclamation-circle',
              'info': 'info-circle'
          };
          return icons[type] || 'info-circle';
      }

      function debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
              const later = () => {
                  clearTimeout(timeout);
                  func(...args);
              };
              clearTimeout(timeout);
              timeout = setTimeout(later, wait);
          };
      }

      // ========================================
      // 系統完成初始化
      // ========================================
      
      // 設定最後更新時間
      document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-TW');
      
      console.log('台灣帕金森病友權益促進會會計管理系統已載入完成');
      console.log('版本: v4.0.0');
      console.log('最後更新: 2024-12-19');

      // ========================================
      // 額外功能函數 (接續主程式)
      // ========================================

      // 清除表單函數
      function clearTransactionForm() {
        document.getElementById('transactionForm').reset();
        document.getElementById('transactionType').value = '';
        document.getElementById('transactionCategory').innerHTML = '<option value="">請選擇類別</option>';
        document.getElementById('incomeOptions').style.display = 'none';
        document.getElementById('expenseOptions').style.display = 'none';
        document.getElementById('receiptDetails').style.display = 'none';
        setCurrentDate();
      }

      function clearReceiptForm() {
        document.getElementById('receiptForm').reset();
        setCurrentDate();
      }

      function clearMemberForm() {
        document.getElementById('memberForm').reset();
        setCurrentDate();
      }

      // 交易類型變更處理
      function handleTransactionTypeChange() {
        const type = document.getElementById('transactionType').value;
        const categorySelect = document.getElementById('transactionCategory');
        const incomeOptions = document.getElementById('incomeOptions');
        const expenseOptions = document.getElementById('expenseOptions');
        
        // 清空類別選項
        categorySelect.innerHTML = '<option value="">請選擇類別</option>';
        
        if (type === '收入') {
            const incomeCategories = ['會費', '捐款', '活動收入', '政府補助', '其他收入'];
            incomeCategories.forEach(category => {
                categorySelect.innerHTML += `<option value="${category}">${category}</option>`;
            });
            incomeOptions.style.display = 'block';
            expenseOptions.style.display = 'none';
        } else if (type === '支出') {
            const expenseCategories = ['活動支出', '辦公用品', '交通費', '餐費', '場地費', '其他支出'];
            expenseCategories.forEach(category => {
                categorySelect.innerHTML += `<option value="${category}">${category}</option>`;
            });
            incomeOptions.style.display = 'none';
            expenseOptions.style.display = 'block';
        } else {
            incomeOptions.style.display = 'none';
            expenseOptions.style.display = 'none';
        }
      }

      // 收據詳情切換
      function toggleReceiptDetails() {
        const checkbox = document.getElementById('generateReceipt');
        const details = document.getElementById('receiptDetails');
        details.style.display = checkbox.checked ? 'block' : 'none';
      }

      // 儀表板更新
      function updateDashboard() {
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        
        // 計算本月收支
        const monthlyTransactions = globalData.transactions.filter(t => {
            const transactionDate = new Date(t.transactionDate);
            return transactionDate.getMonth() === currentMonth && 
                  transactionDate.getFullYear() === currentYear;
        });
        
        const monthlyIncome = monthlyTransactions
            .filter(t => t.transactionType === '收入')
            .reduce((sum, t) => sum + parseFloat(t.transactionAmount), 0);
            
        const monthlyExpense = monthlyTransactions
            .filter(t => t.transactionType === '支出')
            .reduce((sum, t) => sum + parseFloat(t.transactionAmount), 0);
        
        const monthlyReceipts = globalData.receipts.filter(r => {
            const receiptDate = new Date(r.receiptDate);
            return receiptDate.getMonth() === currentMonth && 
                  receiptDate.getFullYear() === currentYear;
        }).length;
        
        // 更新統計卡片
        document.getElementById('totalIncome').textContent = formatCurrency(monthlyIncome);
        document.getElementById('totalExpense').textContent = formatCurrency(monthlyExpense);
        document.getElementById('receiptCount').textContent = monthlyReceipts;
        document.getElementById('memberCount').textContent = globalData.members.length;
        
        // 更新快速統計
        document.getElementById('quickTotalIncome').textContent = formatCurrency(monthlyIncome);
        document.getElementById('quickTotalExpense').textContent = formatCurrency(monthlyExpense);
        document.getElementById('quickNetAmount').textContent = formatCurrency(monthlyIncome - monthlyExpense);
        document.getElementById('quickReceiptCount').textContent = monthlyReceipts;
        
        // 更新報表快速統計
        document.getElementById('reportQuickIncome').textContent = formatCurrency(monthlyIncome);
        document.getElementById('reportQuickExpense').textContent = formatCurrency(monthlyExpense);
        document.getElementById('reportQuickNet').textContent = formatCurrency(monthlyIncome - monthlyExpense);
        document.getElementById('reportQuickReceipts').textContent = monthlyReceipts;
        
        // 更新最近活動
        updateRecentActivities();
      }

      // 更新最近活動
      function updateRecentActivities() {
        const container = document.getElementById('recentActivities');
        const recentItems = [];
        
        // 合併所有活動
        globalData.transactions.forEach(t => {
            recentItems.push({
                type: 'transaction',
                date: t.transactionDate,
                timestamp: t.timestamp,
                description: `${t.transactionType}: ${t.transactionName} - ${formatCurrency(t.transactionAmount)}`
            });
        });
        
        globalData.receipts.forEach(r => {
            recentItems.push({
                type: 'receipt',
                date: r.receiptDate,
                timestamp: r.timestamp,
                description: `收據: ${r.receiptPayer} - ${formatCurrency(r.receiptAmount)}`
            });
        });
        
        globalData.members.forEach(m => {
            recentItems.push({
                type: 'member',
                date: m.memberJoinDate,
                timestamp: m.timestamp,
                description: `新會員: ${m.memberName} (${m.memberType})`
            });
        });
        
        // 排序並取前10筆
        recentItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        const recent10 = recentItems.slice(0, 10);
        
        if (recent10.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">暫無活動記錄</p>';
            return;
        }
        
        let html = '<div class="list-group list-group-flush">';
        recent10.forEach(item => {
            const icon = getActivityIcon(item.type);
            const color = getActivityColor(item.type);
            html += `
                <div class="list-group-item d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-${icon} text-${color}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">${item.description}</div>
                        <small class="text-muted">${formatDate(item.date)}</small>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
      }

      function getActivityIcon(type) {
        const icons = {
            'transaction': 'exchange-alt',
            'receipt': 'receipt',
            'member': 'user-plus'
        };
        return icons[type] || 'circle';
      }

      function getActivityColor(type) {
        const colors = {
            'transaction': 'primary',
            'receipt': 'success',
            'member': 'info'
        };
        return colors[type] || 'secondary';
      }

      // 表格渲染函數
      function renderTransactionTable() {
        const container = document.getElementById('transactionTableContainer');
        
        if (globalData.transactions.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-4">暫無交易記錄</p>';
            return;
        }
        
        let html = `
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>姓名</th>
                        <th>類型</th>
                        <th>類別</th>
                        <th>金額</th>
                        <th>說明</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        globalData.transactions.forEach(transaction => {
            const typeClass = transaction.transactionType === '收入' ? 'success' : 'danger';
            html += `
                <tr>
                    <td>${formatDate(transaction.transactionDate)}</td>
                    <td>${transaction.transactionName}</td>
                    <td><span class="status-badge status-${typeClass}">${transaction.transactionType}</span></td>
                    <td>${transaction.transactionCategory}</td>
                    <td class="text-${typeClass}">${formatCurrency(transaction.transactionAmount)}</td>
                    <td>${transaction.transactionDescription || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewTransaction('${transaction.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="editTransaction('${transaction.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction('${transaction.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
      }

      function renderReceiptTable() {
        const container = document.getElementById('receiptTableContainer');
        
        if (globalData.receipts.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-4">暫無收據記錄</p>';
            return;
        }
        
        let html = `
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>收據編號</th>
                        <th>日期</th>
                        <th>付款人</th>
                        <th>類別</th>
                        <th>金額</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        globalData.receipts.forEach(receipt => {
            html += `
                <tr>
                    <td><strong>${receipt.receiptNumber}</strong></td>
                    <td>${formatDate(receipt.receiptDate)}</td>
                    <td>${receipt.receiptPayer}</td>
                    <td>${receipt.receiptCategory}</td>
                    <td class="text-success">${formatCurrency(receipt.receiptAmount)}</td>
                    <td><span class="status-badge status-success">${receipt.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewReceipt('${receipt.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="printReceipt('${receipt.id}')">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="emailReceipt('${receipt.id}')">
                                <i class="fas fa-envelope"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
      }

      function renderMemberTable() {
        const container = document.getElementById('memberTableContainer');
        
        if (globalData.members.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-4">暫無會員資料</p>';
            return;
        }
        
        let html = `
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>會員編號</th>
                        <th>姓名</th>
                        <th>類型</th>
                        <th>電話</th>
                        <th>入會日期</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        globalData.members.forEach(member => {
            html += `
                <tr>
                    <td><strong>${member.memberNumber}</strong></td>
                    <td>${member.memberName}</td>
                    <td>${member.memberType}</td>
                    <td>${member.memberPhone}</td>
                    <td>${formatDate(member.memberJoinDate)}</td>
                    <td><span class="status-badge status-success">${member.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewMember('${member.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="editMember('${member.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="memberHistory('${member.id}')">
                                <i class="fas fa-history"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
      }

      // 快速操作函數
      function showTransactionForm() {
        // 切換到交易記錄分頁
        const transactionTab = document.getElementById('transaction-tab');
        const tab = new bootstrap.Tab(transactionTab);
        tab.show();
        
        // 聚焦到姓名欄位
        setTimeout(() => {
            document.getElementById('transactionName').focus();
        }, 300);
      }

      function showReceiptForm() {
        // 切換到收據管理分頁
        const receiptTab = document.getElementById('receipt-tab');
        const tab = new bootstrap.Tab(receiptTab);
        tab.show();
        
        // 聚焦到付款人欄位
        setTimeout(() => {
            document.getElementById('receiptPayer').focus();
        }, 300);
      }

      function showMemberForm() {
        // 切換到會員管理分頁
        const memberTab = document.getElementById('member-tab');
        const tab = new bootstrap.Tab(memberTab);
        tab.show();
        
        // 聚焦到姓名欄位
        setTimeout(() => {
            document.getElementById('memberName').focus();
        }, 300);
      }

      // 離線支援函數
      function addToOfflineQueue(action, data) {
        const queue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
        queue.push({
            action: action,
            data: data,
            timestamp: new Date().toISOString()
        });
        localStorage.setItem('offlineQueue', JSON.stringify(queue));
        
        showAlert('資料已暫存，將在連線恢復後同步', 'info');
      }

      function loadOfflineQueue() {
        const queue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
        if (queue.length > 0 && navigator.onLine) {
            processOfflineQueue(queue);
        }
      }

      async function processOfflineQueue(queue) {
        for (const item of queue) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: item.action,
                        data: item.data
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    console.error('離線佇列處理失敗:', result.message);
                }
            } catch (error) {
                console.error('離線佇列處理錯誤:', error);
                break; // 停止處理剩餘項目
            }
        }
        
        // 清空佇列
        localStorage.removeItem('offlineQueue');
        showAlert('離線資料已成功同步', 'success');
      }

      // 自動儲存功能
      function enableAutoSave(formId) {
        const form = document.getElementById(formId);
        if (!form) return;
        
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('input', debounce(() => {
                saveFormDraft(formId);
            }, 1000));
        });
        
        // 載入已儲存的草稿
        loadFormDraft(formId);
      }

      function saveFormDraft(formId) {
        const form = document.getElementById(formId);
        if (!form) return;
        
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        localStorage.setItem(`draft_${formId}`, JSON.stringify(data));
        showAutoSaveIndicator();
      }

      function loadFormDraft(formId) {
        const draft = localStorage.getItem(`draft_${formId}`);
        if (!draft) return;
        
        const data = JSON.parse(draft);
        const form = document.getElementById(formId);
        
        Object.keys(data).forEach(key => {
            const input = form.querySelector(`[name="${key}"]`);
            if (input && data[key]) {
                input.value = data[key];
            }
        });
      }

      function clearFormDraft(formId) {
        localStorage.removeItem(`draft_${formId}`);
      }

      function showAutoSaveIndicator() {
        const indicator = document.querySelector('.auto-save-indicator') || createAutoSaveIndicator();
        indicator.textContent = '已自動儲存';
        indicator.classList.add('show');
        
        setTimeout(() => {
            indicator.classList.remove('show');
        }, 2000);
      }

      function createAutoSaveIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'auto-save-indicator';
        document.body.appendChild(indicator);
        return indicator;
      }

      // 鍵盤快捷鍵
      document.addEventListener('keydown', function(event) {
        if (event.ctrlKey) {
            switch(event.key) {
                case 'n':
                    event.preventDefault();
                    showTransactionForm();
                    break;
                case 'r':
                    event.preventDefault();
                    showReceiptForm();
                    break;
                case 'm':
                    event.preventDefault();
                    showMemberForm();
                    break;
            }
        }
      });

      // 網路狀態監控
      window.addEventListener('online', function() {
        showAlert('網路連線已恢復', 'success');
        loadOfflineQueue();
      });

      window.addEventListener('offline', function() {
        showAlert('網路連線中斷，將使用離線模式', 'warning');
      });

      console.log('額外功能函數已載入完成');

      
  </script>
</body>
</html>
