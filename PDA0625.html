<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會 - 會計管理系統</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          color: #333;
      }

      .container {
          max-width: 1400px;
          margin: 0 auto;
          padding: 20px;
      }

      .header {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-radius: 20px;
          padding: 30px;
          margin-bottom: 30px;
          text-align: center;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
          color: #2c3e50;
          font-size: 2.5em;
          margin-bottom: 10px;
          font-weight: 700;
      }

      .header p {
          color: #7f8c8d;
          font-size: 1.1em;
      }

      .nav-tabs {
          display: flex;
          justify-content: center;
          margin-bottom: 30px;
          flex-wrap: wrap;
          gap: 10px;
      }

      .nav-tab {
          background: rgba(255, 255, 255, 0.9);
          border: none;
          padding: 15px 25px;
          border-radius: 50px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 8px;
          min-width: 140px;
          justify-content: center;
      }

      .nav-tab:hover {
          background: #3498db;
          color: white;
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
      }

      .nav-tab.active {
          background: #2980b9;
          color: white;
          box-shadow: 0 5px 15px rgba(41, 128, 185, 0.4);
      }

      .tab-content {
          display: none;
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-radius: 20px;
          padding: 30px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          animation: fadeIn 0.5s ease-in-out;
      }

      .tab-content.active {
          display: block;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .form-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #2c3e50;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e0e0e0;
          border-radius: 10px;
          font-size: 16px;
          transition: all 0.3s ease;
          background: white;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          outline: none;
          border-color: #3498db;
          box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }

      .form-group textarea {
          resize: vertical;
          min-height: 100px;
      }

      .checkbox-group {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-top: 10px;
      }

      .checkbox-group input[type="checkbox"] {
          width: auto;
          margin: 0;
      }

      .btn {
          background: linear-gradient(135deg, #3498db, #2980b9);
          color: white;
          border: none;
          padding: 15px 30px;
          border-radius: 50px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          display: inline-flex;
          align-items: center;
          gap: 8px;
          text-decoration: none;
          min-width: 120px;
          justify-content: center;
      }

      .btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
      }

      .btn-success {
          background: linear-gradient(135deg, #27ae60, #2ecc71);
      }

      .btn-success:hover {
          box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
      }

      .btn-danger {
          background: linear-gradient(135deg, #e74c3c, #c0392b);
      }

      .btn-danger:hover {
          box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
      }

      .btn-warning {
          background: linear-gradient(135deg, #f39c12, #e67e22);
      }

      .btn-warning:hover {
          box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
      }

      .btn-secondary {
          background: linear-gradient(135deg, #95a5a6, #7f8c8d);
      }

      .btn-secondary:hover {
          box-shadow: 0 5px 15px rgba(149, 165, 166, 0.4);
      }

      .btn-group {
          display: flex;
          gap: 15px;
          flex-wrap: wrap;
          justify-content: center;
          margin-top: 20px;
      }

      .alert {
          padding: 15px 20px;
          border-radius: 10px;
          margin-bottom: 20px;
          display: none;
          align-items: center;
          gap: 10px;
          font-weight: 500;
      }

      .alert.show {
          display: flex;
          animation: slideDown 0.3s ease-out;
      }

      @keyframes slideDown {
          from { opacity: 0; transform: translateY(-10px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .alert-error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .alert-warning {
          background: #fff3cd;
          color: #856404;
          border: 1px solid #ffeaa7;
      }

      .alert-info {
          background: #d1ecf1;
          color: #0c5460;
          border: 1px solid #bee5eb;
      }

      .data-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
          background: white;
          border-radius: 10px;
          overflow: hidden;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .data-table th,
      .data-table td {
          padding: 12px 15px;
          text-align: left;
          border-bottom: 1px solid #e0e0e0;
      }

      .data-table th {
          background: #f8f9fa;
          font-weight: 600;
          color: #2c3e50;
          position: sticky;
          top: 0;
      }

      .data-table tr:hover {
          background: #f8f9fa;
      }

      .data-table .amount {
          text-align: right;
          font-weight: 600;
      }

      .data-table .income {
          color: #27ae60;
      }

      .data-table .expense {
          color: #e74c3c;
      }

      .search-filters {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 10px;
          margin-bottom: 20px;
      }

      .search-filters .form-grid {
          margin-bottom: 15px;
      }

      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
      }

      .stat-card {
          background: white;
          padding: 25px;
          border-radius: 15px;
          text-align: center;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          transition: transform 0.3s ease;
      }

      .stat-card:hover {
          transform: translateY(-5px);
      }

      .stat-card .icon {
          font-size: 3em;
          margin-bottom: 15px;
      }

      .stat-card .value {
          font-size: 2em;
          font-weight: 700;
          margin-bottom: 5px;
      }

      .stat-card .label {
          color: #7f8c8d;
          font-size: 1.1em;
      }

      .stat-card.income {
          border-left: 5px solid #27ae60;
      }

      .stat-card.income .icon {
          color: #27ae60;
      }

      .stat-card.expense {
          border-left: 5px solid #e74c3c;
      }

      .stat-card.expense .icon {
          color: #e74c3c;
      }

      .stat-card.net {
          border-left: 5px solid #3498db;
      }

      .stat-card.net .icon {
          color: #3498db;
      }

      .stat-card.count {
          border-left: 5px solid #9b59b6;
      }

      .stat-card.count .icon {
          color: #9b59b6;
      }

      .loading {
          display: none;
          text-align: center;
          padding: 40px;
      }

      .loading.show {
          display: block;
      }

      .spinner {
          border: 4px solid #f3f3f3;
          border-top: 4px solid #3498db;
          border-radius: 50%;
          width: 50px;
          height: 50px;
          animation: spin 1s linear infinite;
          margin: 0 auto 20px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          backdrop-filter: blur(5px);
      }

      .modal.show {
          display: flex;
          align-items: center;
          justify-content: center;
          animation: fadeIn 0.3s ease-out;
      }

      .modal-content {
          background: white;
          padding: 30px;
          border-radius: 20px;
          max-width: 500px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          position: relative;
          animation: slideUp 0.3s ease-out;
      }

      @keyframes slideUp {
          from { opacity: 0; transform: translateY(30px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
          padding-bottom: 15px;
          border-bottom: 2px solid #e0e0e0;
      }

      .modal-header h3 {
          color: #2c3e50;
          font-size: 1.5em;
      }

      .close {
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #7f8c8d;
          transition: color 0.3s ease;
      }

      .close:hover {
          color: #e74c3c;
      }

      .receipt-preview {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 10px;
          margin: 20px 0;
          border: 2px dashed #3498db;
      }

      .receipt-info {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          margin-bottom: 20px;
      }

      .receipt-info .info-item {
          display: flex;
          justify-content: space-between;
          padding: 8px 0;
          border-bottom: 1px solid #e0e0e0;
      }

      .receipt-info .info-label {
          font-weight: 600;
          color: #2c3e50;
      }

      .amount-highlight {
          background: linear-gradient(135deg, #3498db, #2980b9);
          color: white;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          margin: 20px 0;
      }

      .amount-highlight .amount {
          font-size: 2em;
          font-weight: 700;
          margin-bottom: 10px;
      }

      .pagination {
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 10px;
          margin-top: 20px;
      }

      .pagination button {
          padding: 8px 12px;
          border: 1px solid #e0e0e0;
          background: white;
          border-radius: 5px;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .pagination button:hover {
          background: #3498db;
          color: white;
          border-color: #3498db;
      }

      .pagination button.active {
          background: #3498db;
          color: white;
          border-color: #3498db;
      }

      .pagination button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
      }

      .autocomplete-container {
          position: relative;
      }

      .autocomplete-suggestions {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          background: white;
          border: 1px solid #e0e0e0;
          border-top: none;
          border-radius: 0 0 10px 10px;
          max-height: 200px;
          overflow-y: auto;
          z-index: 100;
          display: none;
      }

      .autocomplete-suggestions.show {
          display: block;
      }

      .autocomplete-suggestion {
          padding: 12px 15px;
          cursor: pointer;
          border-bottom: 1px solid #f0f0f0;
          transition: background-color 0.2s ease;
      }

      .autocomplete-suggestion:hover {
          background: #f8f9fa;
      }

      .autocomplete-suggestion:last-child {
          border-bottom: none;
      }

      .progress-bar {
          width: 100%;
          height: 6px;
          background: #e0e0e0;
          border-radius: 3px;
          overflow: hidden;
          margin: 20px 0;
      }

      .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, #3498db, #2980b9);
          width: 0%;
          transition: width 0.3s ease;
      }

      .system-status {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
          margin-bottom: 20px;
      }

      .status-item {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 15px;
          background: white;
          border-radius: 10px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .status-item .status-icon {
          font-size: 1.5em;
      }

      .status-item.online .status-icon {
          color: #27ae60;
      }

      .status-item.offline .status-icon {
          color: #e74c3c;
      }

      .status-item.warning .status-icon {
          color: #f39c12;
      }

      @media (max-width: 768px) {
          .container {
              padding: 10px;
          }

          .header h1 {
              font-size: 2em;
          }

          .nav-tabs {
              flex-direction: column;
              align-items: center;
          }

          .nav-tab {
              width: 100%;
              max-width: 300px;
          }

          .form-grid {
              grid-template-columns: 1fr;
          }

          .stats-grid {
              grid-template-columns: 1fr;
          }

          .btn-group {
              flex-direction: column;
              align-items: center;
          }

          .btn {
              width: 100%;
              max-width: 300px;
          }

          .data-table {
              font-size: 14px;
          }

          .data-table th,
          .data-table td {
              padding: 8px 10px;
          }

          .receipt-info {
              grid-template-columns: 1fr;
          }
      }

      .toast {
          position: fixed;
          top: 20px;
          right: 20px;
          background: white;
          padding: 15px 20px;
          border-radius: 10px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          z-index: 1001;
          transform: translateX(400px);
          transition: transform 0.3s ease;
          max-width: 350px;
      }

      .toast.show {
          transform: translateX(0);
      }

      .toast-success {
          border-left: 4px solid #27ae60;
      }

      .toast-error {
          border-left: 4px solid #e74c3c;
      }

      .toast-warning {
          border-left: 4px solid #f39c12;
      }

      .toast-info {
          border-left: 4px solid #3498db;
      }

      .empty-state {
          text-align: center;
          padding: 60px 20px;
          color: #7f8c8d;
      }

      .empty-state .icon {
          font-size: 4em;
          margin-bottom: 20px;
          opacity: 0.5;
      }

      .empty-state h3 {
          font-size: 1.5em;
          margin-bottom: 10px;
      }

      .empty-state p {
          font-size: 1.1em;
      }
  </style>
</head>
<body>
  <div class="container">
      <!-- 系統標題 -->
      <div class="header">
          <h1><i class="fas fa-calculator"></i> 台灣帕金森病友權益促進會</h1>
          <p>會計管理系統 - 專業版 v2.0</p>
      </div>

      <!-- 導航標籤 -->
      <div class="nav-tabs">
          <button class="nav-tab active" onclick="showTab('transaction')">
              <i class="fas fa-plus-circle"></i> 新增交易
          </button>
          <button class="nav-tab" onclick="showTab('records')">
              <i class="fas fa-list"></i> 交易記錄
          </button>
          <button class="nav-tab" onclick="showTab('receipts')">
              <i class="fas fa-receipt"></i> 收據管理
          </button>
          <button class="nav-tab" onclick="showTab('vouchers')">
              <i class="fas fa-file-invoice"></i> 支出憑證
          </button>
          <button class="nav-tab" onclick="showTab('personnel')">
              <i class="fas fa-users"></i> 人員管理
          </button>
          <button class="nav-tab" onclick="showTab('reports')">
              <i class="fas fa-chart-bar"></i> 報表統計
          </button>
          <button class="nav-tab" onclick="showTab('system')">
              <i class="fas fa-cog"></i> 系統管理
          </button>
      </div>

      <!-- 全域提示訊息 -->
      <div id="globalAlert" class="alert">
          <i class="fas fa-info-circle"></i>
          <span id="globalAlertMessage"></span>
      </div>

      <!-- 新增交易標籤 -->
      <div id="transaction" class="tab-content active">
          <h2><i class="fas fa-plus-circle"></i> 新增交易記錄</h2>
          
          <form id="transactionForm">
              <div class="form-grid">
                  <div class="form-group">
                      <label for="transactionDate">交易日期 *</label>
                      <input type="date" id="transactionDate" name="date" required>
                  </div>
                  
                  <div class="form-group">
                      <label for="transactionType">交易類型 *</label>
                      <select id="transactionType" name="type" required onchange="updateCategoryOptions()">
                          <option value="">請選擇交易類型</option>
                          <option value="收入">收入</option>
                          <option value="支出">支出</option>
                      </select>
                  </div>
                  
                  <div class="form-group autocomplete-container">
                      <label for="transactionName">姓名/機構 *</label>
                      <input type="text" id="transactionName" name="name" required 
                             placeholder="請輸入姓名或機構名稱" 
                             oninput="handleNameInput(this.value)"
                             onfocus="showNameSuggestions()"
                             onblur="hideNameSuggestions()">
                      <div id="nameSuggestions" class="autocomplete-suggestions"></div>
                  </div>
                  
                  <div class="form-group">
                      <label for="transactionCategory">類別 *</label>
                      <select id="transactionCategory" name="category" required>
                          <option value="">請先選擇交易類型</option>
                      </select>
                  </div>
                  
                  <div class="form-group">
                      <label for="transactionAmount">金額 *</label>
                      <input type="number" id="transactionAmount" name="amount" 
                             required min="1" step="1" placeholder="請輸入金額">
                  </div>
                  
                  <div class="form-group">
                      <label for="transactionAccount">帳戶</label>
                      <select id="transactionAccount" name="account">
                          <option value="">請選擇帳戶</option>
                          <option value="現金">現金</option>
                          <option value="銀行帳戶">銀行帳戶</option>
                          <option value="郵局帳戶">郵局帳戶</option>
                          <option value="信用卡">信用卡</option>
                      </select>
                  </div>
              </div>
              
              <div class="form-group">
                  <label for="transactionDescription">說明</label>
                  <textarea id="transactionDescription" name="description" 
                            placeholder="請輸入交易說明或備註"></textarea>
              </div>
              
              <!-- 聯絡資訊區塊 -->
              <div id="contactInfo" style="display: none;">
                  <h3><i class="fas fa-address-card"></i> 聯絡資訊</h3>
                  <div class="form-grid">
                      <div class="form-group">
                          <label for="identity">身分</label>
                          <select id="identity" name="identity">
                              <option value="">請選擇身分</option>
                              <option value="病友">病友</option>
                              <option value="家屬">家屬</option>
                              <option value="志工">志工</option>
                              <option value="一般民眾">一般民眾</option>
                              <option value="企業">企業</option>
                              <option value="機構">機構</option>
                          </select>
                      </div>
                      
                      <div class="form-group">
                          <label for="phone">電話</label>
                          <input type="tel" id="phone" name="phone" placeholder="請輸入聯絡電話">
                      </div>
                      
                      <div class="form-group">
                          <label for="email">電子郵件</label>
                          <input type="email" id="email" name="email" placeholder="請輸入電子郵件">
                      </div>
                  </div>
              </div>
              
              <!-- 收據選項 -->
              <div id="receiptOptions" style="display: none;">
                  <h3><i class="fas fa-receipt"></i> 收據選項</h3>
                  <div class="checkbox-group">
                      <input type="checkbox" id="generateReceipt" name="generateReceipt" value="true">
                      <label for="generateReceipt">開立電子收據</label>
                  </div>
                  <div class="checkbox-group">
                      <input type="checkbox" id="autoSendEmail" name="autoSendEmail" value="true">
                      <label for="autoSendEmail">自動寄送收據至信箱</label>
                  </div>
              </div>
              
              <!-- 支出憑證選項 -->
              <div id="voucherOptions" style="display: none;">
                  <h3><i class="fas fa-file-invoice"></i> 支出憑證選項</h3>
                  <div class="form-grid">
                      <div class="form-group">
                          <div class="checkbox-group">
                              <input type="checkbox" id="generateVoucher" name="generateVoucher" value="true">
                              <label for="generateVoucher">生成支出憑證申請單</label>
                          </div>
                      </div>
                      
                      <div class="form-group">
                          <label for="department">部門</label>
                          <select id="department" name="department">
                              <option value="會務部">會務部</option>
                              <option value="活動部">活動部</option>
                              <option value="財務部">財務部</option>
                              <option value="總務部">總務部</option>
                          </select>
                      </div>
                      
                      <div class="form-group">
                          <label for="receiptCount">收據張數</label>
                          <input type="number" id="receiptCount" name="receiptCount" 
                                 min="1" value="1" placeholder="請輸入收據張數">
                      </div>
                  </div>
              </div>
              
              <div class="btn-group">
                  <button type="submit" class="btn btn-success">
                      <i class="fas fa-save"></i> 儲存記錄
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="resetTransactionForm()">
                      <i class="fas fa-undo"></i> 重置表單
                  </button>
              </div>
          </form>
      </div>

      <!-- 交易記錄標籤 -->
      <div id="records" class="tab-content">
          <h2><i class="fas fa-list"></i> 交易記錄查詢</h2>
          
          <!-- 統計卡片 -->
          <div id="statsGrid" class="stats-grid">
              <div class="stat-card income">
                  <div class="icon"><i class="fas fa-arrow-up"></i></div>
                  <div class="value" id="totalIncome">$0</div>
                  <div class="label">總收入</div>
              </div>
              <div class="stat-card expense">
                  <div class="icon"><i class="fas fa-arrow-down"></i></div>
                  <div class="value" id="totalExpense">$0</div>
                  <div class="label">總支出</div>
              </div>
              <div class="stat-card net">
                  <div class="icon"><i class="fas fa-balance-scale"></i></div>
                  <div class="value" id="netIncome">$0</div>
                  <div class="label">淨收入</div>
              </div>
              <div class="stat-card count">
                  <div class="icon"><i class="fas fa-hashtag"></i></div>
                  <div class="value" id="totalTransactions">0</div>
                  <div class="label">交易筆數</div>
              </div>
          </div>
          
          <!-- 搜尋篩選器 -->
          <div class="search-filters">
              <h3><i class="fas fa-search"></i> 搜尋篩選</h3>
              <div class="form-grid">
                  <div class="form-group">
                      <label for="searchDateFrom">開始日期</label>
                      <input type="date" id="searchDateFrom">
                  </div>
                  <div class="form-group">
                      <label for="searchDateTo">結束日期</label>
                      <input type="date" id="searchDateTo">
                  </div>
                  <div class="form-group">
                      <label for="searchType">交易類型</label>
                      <select id="searchType">
                          <option value="">全部類型</option>
                          <option value="收入">收入</option>
                          <option value="支出">支出</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="searchCategory">類別</label>
                      <select id="searchCategory">
                          <option value="">全部類別</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="searchName">姓名/機構</label>
                      <input type="text" id="searchName" placeholder="請輸入關鍵字">
                  </div>
                  <div class="form-group">
                      <label for="searchAmount">金額範圍</label>
                      <div style="display: flex; gap: 10px;">
                          <input type="number" id="searchAmountMin" placeholder="最小金額" style="flex: 1;">
                          <input type="number" id="searchAmountMax" placeholder="最大金額" style="flex: 1;">
                      </div>
                  </div>
              </div>
              <div class="btn-group">
                  <button class="btn btn-success" onclick="searchTransactions()">
                      <i class="fas fa-search"></i> 搜尋
                  </button>
                  <button class="btn btn-secondary" onclick="resetSearchFilters()">
                      <i class="fas fa-undo"></i> 重置
                  </button>
                  <button class="btn btn-warning" onclick="exportTransactions()">
                      <i class="fas fa-download"></i> 匯出CSV
                  </button>
              </div>
          </div>
          
          <!-- 載入指示器 -->
          <div id="recordsLoading" class="loading">
              <div class="spinner"></div>
              <p>載入中...</p>
          </div>
          
          <!-- 交易記錄表格 -->
          <div id="transactionsTableContainer">
              <table id="transactionsTable" class="data-table">
                  <thead>
                      <tr>
                          <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                          <th>日期</th>
                          <th>姓名/機構</th>
                          <th>類型</th>
                          <th>類別</th>
                          <th>金額</th>
                          <th>說明</th>
                          <th>收據編號</th>
                          <th>狀態</th>
                          <th>操作</th>
                      </tr>
                  </thead>
                  <tbody id="transactionsTableBody">
                      <!-- 動態載入 -->
                  </tbody>
              </table>
              
              <!-- 分頁控制 -->
              <div id="pagination" class="pagination">
                  <!-- 動態載入 -->
              </div>
          </div>
          
          <!-- 批量操作 -->
          <div id="batchActions" style="display: none; margin-top: 20px;">
              <div class="btn-group">
                  <button class="btn btn-danger" onclick="batchDeleteTransactions()">
                      <i class="fas fa-trash"></i> 批量刪除
                  </button>
                  <button class="btn btn-warning" onclick="batchExportTransactions()">
                      <i class="fas fa-download"></i> 批量匯出
                  </button>
              </div>
          </div>
      </div>

      <!-- 收據管理標籤 -->
      <div id="receipts" class="tab-content">
          <h2><i class="fas fa-receipt"></i> 收據管理</h2>
          
          <!-- 收據搜尋 -->
          <div class="search-filters">
              <h3><i class="fas fa-search"></i> 收據查詢</h3>
              <div class="form-grid">
                  <div class="form-group">
                      <label for="receiptSearchNumber">收據編號</label>
                      <input type="text" id="receiptSearchNumber" placeholder="請輸入收據編號">
                  </div>
                  <div class="form-group">
                      <label for="receiptSearchPayer">付款人</label>
                      <input type="text" id="receiptSearchPayer" placeholder="請輸入付款人姓名">
                  </div>
                  <div class="form-group">
                      <label for="receiptSearchDateFrom">開始日期</label>
                      <input type="date" id="receiptSearchDateFrom">
                  </div>
                  <div class="form-group">
                      <label for="receiptSearchDateTo">結束日期</label>
                      <input type="date" id="receiptSearchDateTo">
                  </div>
              </div>
              <div class="btn-group">
                  <button class="btn btn-success" onclick="searchReceipts()">
                      <i class="fas fa-search"></i> 搜尋收據
                  </button>
                  <button class="btn btn-secondary" onclick="resetReceiptSearch()">
                      <i class="fas fa-undo"></i> 重置
                  </button>
              </div>
          </div>
          
          <!-- 收據記錄表格 -->
          <div id="receiptsTableContainer">
              <table id="receiptsTable" class="data-table">
                  <thead>
                      <tr>
                          <th>收據編號</th>
                          <th>開立日期</th>
                          <th>付款人</th>
                          <th>身分</th>
                          <th>聯絡電話</th>
                          <th>電子郵件</th>
                          <th>類別</th>
                          <th>金額</th>
                          <th>郵件狀態</th>
                          <th>操作</th>
                      </tr>
                  </thead>
                  <tbody id="receiptsTableBody">
                      <!-- 動態載入 -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- 支出憑證標籤 -->
      <div id="vouchers" class="tab-content">
          <h2><i class="fas fa-file-invoice"></i> 支出憑證管理</h2>
          
          <!-- 憑證搜尋 -->
          <div class="search-filters">
              <h3><i class="fas fa-search"></i> 憑證查詢</h3>
              <div class="form-grid">
                  <div class="form-group">
                      <label for="voucherSearchNumber">憑證編號</label>
                      <input type="text" id="voucherSearchNumber" placeholder="請輸入憑證編號">
                  </div>
                  <div class="form-group">
                      <label for="voucherSearchApplicant">申請人</label>
                      <input type="text" id="voucherSearchApplicant" placeholder="請輸入申請人姓名">
                  </div>
                  <div class="form-group">
                      <label for="voucherSearchStatus">審核狀態</label>
                      <select id="voucherSearchStatus">
                          <option value="">全部狀態</option>
                          <option value="待審核">待審核</option>
                          <option value="已審核">已審核</option>
                          <option value="已駁回">已駁回</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="voucherSearchDepartment">部門</label>
                      <select id="voucherSearchDepartment">
                          <option value="">全部部門</option>
                          <option value="會務部">會務部</option>
                          <option value="活動部">活動部</option>
                          <option value="財務部">財務部</option>
                          <option value="總務部">總務部</option>
                      </select>
                  </div>
              </div>
              <div class="btn-group">
                  <button class="btn btn-success" onclick="searchVouchers()">
                      <i class="fas fa-search"></i> 搜尋憑證
                  </button>
                  <button class="btn btn-secondary" onclick="resetVoucherSearch()">
                      <i class="fas fa-undo"></i> 重置
                  </button>
              </div>
          </div>
          
          <!-- 憑證記錄表格 -->
          <div id="vouchersTableContainer">
              <table id="vouchersTable" class="data-table">
                  <thead>
                      <tr>
                          <th>憑證編號</th>
                          <th>申請日期</th>
                          <th>申請人</th>
                          <th>部門</th>
                          <th>支出類別</th>
                          <th>金額</th>
                          <th>用途說明</th>
                          <th>收據張數</th>
                          <th>審核狀態</th>
                          <th>操作</th>
                      </tr>
                  </thead>
                  <tbody id="vouchersTableBody">
                      <!-- 動態載入 -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- 人員管理標籤 -->
      <div id="personnel" class="tab-content">
          <h2><i class="fas fa-users"></i> 人員管理</h2>
          
          <!-- 人員搜尋 -->
          <div class="search-filters">
              <h3><i class="fas fa-search"></i> 人員查詢</h3>
              <div class="form-grid">
                  <div class="form-group">
                      <label for="personnelSearchName">姓名</label>
                      <input type="text" id="personnelSearchName" placeholder="請輸入姓名關鍵字">
                  </div>
                  <div class="form-group">
                      <label for="personnelSearchPhone">電話</label>
                      <input type="text" id="personnelSearchPhone" placeholder="請輸入電話號碼">
                  </div>
                  <div class="form-group">
                      <label for="personnelSearchEmail">電子郵件</label>
                      <input type="text" id="personnelSearchEmail" placeholder="請輸入電子郵件">
                  </div>
              </div>
              <div class="btn-group">
                  <button class="btn btn-success" onclick="searchPersonnel()">
                      <i class="fas fa-search"></i> 搜尋人員
                  </button>
                  <button class="btn btn-secondary" onclick="resetPersonnelSearch()">
                      <i class="fas fa-undo"></i> 重置
                  </button>
                  <button class="btn btn-warning" onclick="exportPersonnel()">
                      <i class="fas fa-download"></i> 匯出人員資料
                  </button>
              </div>
          </div>
          
          <!-- 人員記錄表格 -->
          <div id="personnelTableContainer">
              <table id="personnelTable" class="data-table">
                  <thead>
                      <tr>
                          <th>姓名</th>
                          <th>身分</th>
                          <th>聯絡電話</th>
                          <th>電子郵件</th>
                          <th>建立時間</th>
                          <th>最後更新</th>
                          <th>捐款累計</th>
                          <th>操作</th>
                      </tr>
                  </thead>
                  <tbody id="personnelTableBody">
                      <!-- 動態載入 -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- 報表統計標籤 -->
      <div id="reports" class="tab-content">
          <h2><i class="fas fa-chart-bar"></i> 報表統計</h2>
          
          <!-- 報表選項 -->
          <div class="search-filters">
              <h3><i class="fas fa-calendar-alt"></i> 報表設定</h3>
              <div class="form-grid">
                  <div class="form-group">
                      <label for="reportYear">年度</label>
                      <select id="reportYear">
                          <!-- 動態載入年份選項 -->
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="reportMonth">月份</label>
                      <select id="reportMonth">
                          <option value="">全年度</option>
                          <option value="1">1月</option>
                          <option value="2">2月</option>
                          <option value="3">3月</option>
                          <option value="4">4月</option>
                          <option value="5">5月</option>
                          <option value="6">6月</option>
                          <option value="7">7月</option>
                          <option value="8">8月</option>
                          <option value="9">9月</option>
                          <option value="10">10月</option>
                          <option value="11">11月</option>
                          <option value="12">12月</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="reportType">報表類型</label>
                      <select id="reportType">
                          <option value="summary">財務摘要</option>
                          <option value="monthly">月度報表</option>
                          <option value="annual">年度統計</option>
                          <option value="donation">捐款統計</option>
                      </select>
                  </div>
              </div>
              <div class="btn-group">
                  <button class="btn btn-success" onclick="generateReport()">
                      <i class="fas fa-chart-line"></i> 生成報表
                  </button>
                  <button class="btn btn-warning" onclick="exportReport()">
                      <i class="fas fa-file-pdf"></i> 匯出PDF
                  </button>
              </div>
          </div>
          
          <!-- 報表內容區域 -->
          <div id="reportContent">
              <div class="empty-state">
                  <div class="icon"><i class="fas fa-chart-bar"></i></div>
                  <h3>尚未生成報表</h3>
                  <p>請選擇報表設定後點擊「生成報表」按鈕</p>
              </div>
          </div>
      </div>

      <!-- 系統管理標籤 -->
      <div id="system" class="tab-content">
          <h2><i class="fas fa-cog"></i> 系統管理</h2>
          
          <!-- 系統狀態 -->
          <div class="search-filters">
              <h3><i class="fas fa-heartbeat"></i> 系統狀態</h3>
              <div id="systemStatus" class="system-status">
                  <!-- 動態載入系統狀態 -->
              </div>
              <div class="btn-group">
                  <button class="btn btn-success" onclick="checkSystemHealth()">
                      <i class="fas fa-stethoscope"></i> 健康檢查
                  </button>
                  <button class="btn btn-warning" onclick="refreshSystemStatus()">
                      <i class="fas fa-sync-alt"></i> 重新整理
                  </button>
              </div>
          </div>
          
          <!-- 資料管理 -->
          <div class="search-filters">
              <h3><i class="fas fa-database"></i> 資料管理</h3>
              <div class="btn-group">
                  <button class="btn btn-warning" onclick="createBackup()">
                      <i class="fas fa-save"></i> 建立備份
                  </button>
                  <button class="btn btn-secondary" onclick="exportAllData()">
                      <i class="fas fa-download"></i> 匯出所有資料
                  </button>
                  <button class="btn btn-danger" onclick="cleanupTestData()">
                      <i class="fas fa-trash"></i> 清理測試資料
                  </button>
              </div>
          </div>
          
          <!-- 測試功能 -->
          <div class="search-filters">
              <h3><i class="fas fa-flask"></i> 測試功能</h3>
              <div class="btn-group">
                  <button class="btn btn-success" onclick="testReceiptFunction()">
                      <i class="fas fa-receipt"></i> 測試收據功能
                  </button>
                  <button class="btn btn-success" onclick="testEmailFunction()">
                      <i class="fas fa-envelope"></i> 測試郵件功能
                  </button>
                  <button class="btn btn-success" onclick="testPDFGeneration()">
                      <i class="fas fa-file-pdf"></i> 測試PDF生成
                  </button>
              </div>
          </div>
          
          <!-- 系統記錄 -->
          <div id="systemLogs">
              <h3><i class="fas fa-list-alt"></i> 系統記錄</h3>
              <div id="systemLogsContent">
                  <!-- 動態載入系統記錄 -->
              </div>
          </div>
      </div>
  </div>

  <!-- 模態視窗 -->
  
  <!-- 收據預覽模態視窗 -->
  <div id="receiptModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3><i class="fas fa-receipt"></i> 收據預覽</h3>
              <button class="close" onclick="closeModal('receiptModal')">&times;</button>
          </div>
          <div id="receiptPreviewContent">
              <!-- 動態載入收據內容 -->
          </div>
          <div class="btn-group">
              <button class="btn btn-success" onclick="downloadReceiptPDF()">
                  <i class="fas fa-download"></i> 下載PDF
              </button>
              <button class="btn btn-warning" onclick="sendReceiptEmail()">
                  <i class="fas fa-envelope"></i> 寄送郵件
              </button>
              <button class="btn btn-secondary" onclick="closeModal('receiptModal')">
                  <i class="fas fa-times"></i> 關閉
              </button>
          </div>
      </div>
  </div>
  
  <!-- 郵件寄送模態視窗 -->
  <div id="emailModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3><i class="fas fa-envelope"></i> 寄送收據郵件</h3>
              <button class="close" onclick="closeModal('emailModal')">&times;</button>
          </div>
          <form id="emailForm">
              <div class="form-group">
                  <label for="emailRecipient">收件人信箱 *</label>
                  <input type="email" id="emailRecipient" required placeholder="請輸入收件人電子郵件">
              </div>
              <div class="form-group">
                  <label for="emailMessage">自訂訊息</label>
                  <textarea id="emailMessage" placeholder="請輸入自訂訊息（選填）" rows="4"></textarea>
              </div>
              <div class="btn-group">
                  <button type="submit" class="btn btn-success">
                      <i class="fas fa-paper-plane"></i> 寄送郵件
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="closeModal('emailModal')">
                      <i class="fas fa-times"></i> 取消
                  </button>
              </div>
          </form>
      </div>
  </div>
  
  <!-- 確認刪除模態視窗 -->
  <div id="deleteModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3><i class="fas fa-exclamation-triangle"></i> 確認刪除</h3>
              <button class="close" onclick="closeModal('deleteModal')">&times;</button>
          </div>
          <div id="deleteModalContent">
              <p>您確定要刪除這筆記錄嗎？此操作無法復原。</p>
          </div>
          <div class="btn-group">
              <button class="btn btn-danger" onclick="confirmDelete()">
                  <i class="fas fa-trash"></i> 確認刪除
              </button>
              <button class="btn btn-secondary" onclick="closeModal('deleteModal')">
                  <i class="fas fa-times"></i> 取消
              </button>
          </div>
      </div>
  </div>

  <!-- Toast 通知 -->
  <div id="toast" class="toast">
      <div id="toastContent"></div>
  </div>

  <script>
      // ========================================
      // 全域變數
      // ========================================
      
      let currentTransactions = [];
      let currentReceipts = [];
      let currentVouchers = [];
      let currentPersonnel = [];
      let currentPage = 1;
      let itemsPerPage = 20;
      let selectedItems = [];
      let currentReceiptData = null;
      let deleteTarget = null;
      
      // 類別選項
      const incomeCategories = [
          '一般捐款', '指定捐款', '會費收入', '活動報名費', 
          '義賣收入', '補助款', '其他收入'
      ];
      
      const expenseCategories = [
          '活動支出', '辦公用品', '交通費', '餐費', '場地費', 
          '印刷費', '郵資', '電話費', '網路費', '其他支出'
      ];

      // ========================================
      // 初始化函數
      // ========================================
      
      document.addEventListener('DOMContentLoaded', function() {
          initializeSystem();
      });
      
      async function initializeSystem() {
          try {
              // 設定當前日期
              document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
              
              // 初始化年份選項
              initializeYearOptions();
              
              // 載入初始資料
              await loadTransactions();
              await loadFinancialSummary();
              
              // 檢查系統狀態
              await checkSystemHealth();
              
              showToast('系統初始化完成', 'success');
          } catch (error) {
              console.error('系統初始化失敗:', error);
              showToast('系統初始化失敗: ' + error.message, 'error');
          }
      }
      
      function initializeYearOptions() {
          const currentYear = new Date().getFullYear();
          const yearSelect = document.getElementById('reportYear');
          
          for (let year = currentYear; year >= currentYear - 5; year--) {
              const option = document.createElement('option');
              option.value = year;
              option.textContent = year + '年';
              if (year === currentYear) option.selected = true;
              yearSelect.appendChild(option);
          }
      }

      // ========================================
      // 標籤切換功能
      // ========================================
      
      function showTab(tabName) {
          // 隱藏所有標籤內容
          document.querySelectorAll('.tab-content').forEach(tab => {
              tab.classList.remove('active');
          });
          
          // 移除所有導航標籤的active類別
          document.querySelectorAll('.nav-tab').forEach(tab => {
              tab.classList.remove('active');
          });
          
          // 顯示選中的標籤內容
          document.getElementById(tabName).classList.add('active');
          
          // 設定對應導航標籤為active
          event.target.classList.add('active');
          
          // 根據標籤載入相應資料
          switch(tabName) {
              case 'records':
                  loadTransactions();
                  loadFinancialSummary();
                  break;
              case 'receipts':
                  loadReceipts();
                  break;
              case 'vouchers':
                  loadVouchers();
                  break;
              case 'personnel':
                  loadPersonnel();
                  break;
              case 'system':
                  checkSystemHealth();
                  break;
          }
      }

      // ========================================
      // 表單處理功能
      // ========================================
      
      function updateCategoryOptions() {
          const type = document.getElementById('transactionType').value;
          const categorySelect = document.getElementById('transactionCategory');
          const contactInfo = document.getElementById('contactInfo');
          const receiptOptions = document.getElementById('receiptOptions');
          const voucherOptions = document.getElementById('voucherOptions');
          
          // 清空類別選項
          categorySelect.innerHTML = '<option value="">請選擇類別</option>';
          
          if (type === '收入') {
              incomeCategories.forEach(category => {
                  const option = document.createElement('option');
                  option.value = category;
                  option.textContent = category;
                  categorySelect.appendChild(option);
              });
              
              // 顯示聯絡資訊和收據選項
              contactInfo.style.display = 'block';
              receiptOptions.style.display = 'block';
              voucherOptions.style.display = 'none';
              
          } else if (type === '支出') {
              expenseCategories.forEach(category => {
                  const option = document.createElement('option');
                  option.value = category;
                  option.textContent = category;
                  categorySelect.appendChild(option);
              });
              
              // 隱藏聯絡資訊和收據選項，顯示憑證選項
              contactInfo.style.display = 'none';
              receiptOptions.style.display = 'none';
              voucherOptions.style.display = 'block';
          } else {
              // 隱藏所有額外選項
              contactInfo.style.display = 'none';
              receiptOptions.style.display = 'none';
              voucherOptions.style.display = 'none';
          }
      }
      
      function resetTransactionForm() {
          document.getElementById('transactionForm').reset();
          document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
          document.getElementById('contactInfo').style.display = 'none';
          document.getElementById('receiptOptions').style.display = 'none';
          document.getElementById('voucherOptions').style.display = 'none';
          
          // 重置類別選項
          const categorySelect = document.getElementById('transactionCategory');
          categorySelect.innerHTML = '<option value="">請先選擇交易類型</option>';
      }

      // ========================================
      // 自動完成功能
      // ========================================
      
      let personnelCache = [];
      let suggestionTimeout = null;
      
      async function handleNameInput(value) {
          clearTimeout(suggestionTimeout);
          
          if (value.length < 2) {
              hideNameSuggestions();
              return;
          }
          
          suggestionTimeout = setTimeout(async () => {
              try {
                  if (personnelCache.length === 0) {
                      const result = await callGoogleScript('getAllPersonnel');
                      if (result.success) {
                          personnelCache = result.data;
                      }
                  }
                  
                  const suggestions = personnelCache.filter(person => 
                      person.name.toLowerCase().includes(value.toLowerCase())
                  ).slice(0, 10);
                  
                  showNameSuggestions(suggestions);
              } catch (error) {
                  console.error('載入人員建議失敗:', error);
              }
          }, 300);
      }
      
      function showNameSuggestions(suggestions = []) {
          const container = document.getElementById('nameSuggestions');
          
          if (suggestions.length === 0) {
              container.style.display = 'none';
              return;
          }
          
          container.innerHTML = '';
          suggestions.forEach(person => {
              const item = document.createElement('div');
              item.className = 'autocomplete-suggestion';
              item.innerHTML = `
                  <strong>${person.name}</strong>
                  ${person.phone ? `<br><small>${person.phone}</small>` : ''}
                  ${person.email ? `<br><small>${person.email}</small>` : ''}
              `;
              item.onclick = () => selectPerson(person);
              container.appendChild(item);
          });
          
          container.classList.add('show');
      }
      
      function hideNameSuggestions() {
          setTimeout(() => {
              document.getElementById('nameSuggestions').classList.remove('show');
          }, 200);
      }
      
      function selectPerson(person) {
          document.getElementById('transactionName').value = person.name;
          if (person.phone) document.getElementById('phone').value = person.phone;
          if (person.email) document.getElementById('email').value = person.email;
          if (person.identity) document.getElementById('identity').value = person.identity;
          
          hideNameSuggestions();
      }

      // ========================================
      // API 呼叫功能
      // ========================================
      
      const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwBFqx7JAYF6i3YPJPCRMOZxV0lJixYw5-JVjO6PijOyLQPUy-O05p_Zq42LTS7M0Zsgg/exec"; // ←請填你的網址

      async function callGoogleScript(action, params = {}) {
          try {
              const response = await fetch(WEBAPP_URL, {
                  method: "POST",
                  headers: {
                      "Content-Type": "application/json"
                  },
                  body: JSON.stringify({
                      action: action,
                      params: params
                  })
              });
              const result = await response.json();
              return result;
          } catch (error) {
              console.error(`API呼叫失敗 (${action}):`, error);
              throw error;
          }
      }


      // ========================================
      // 交易記錄功能
      // ========================================
      
      document.getElementById('transactionForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          try {
              showLoading('正在儲存交易記錄...');
              
              const formData = new FormData(e.target);
              const transactionData = {
                  date: formData.get('date'),
                  type: formData.get('type'),
                  name: formData.get('name'),
                  category: formData.get('category'),
                  amount: parseInt(formData.get('amount')),
                  account: formData.get('account'),
                  description: formData.get('description'),
                  identity: formData.get('identity'),
                  phone: formData.get('phone'),
                  email: formData.get('email'),
                  generateReceipt: formData.get('generateReceipt') === 'true',
                  autoSendEmail: formData.get('autoSendEmail') === 'true',
                  generateVoucher: formData.get('generateVoucher') === 'true',
                  department: formData.get('department'),
                  receiptCount: parseInt(formData.get('receiptCount')) || 1
              };
              
              let result;
              if (transactionData.type === '收入') {
                  result = await callGoogleScript('addIncomeRecord', transactionData);
              } else {
                  result = await callGoogleScript('addExpenseRecord', transactionData);
              }
              
              hideLoading();
              
              if (result.success) {
                  showToast('交易記錄儲存成功！', 'success');
                  
                  if (result.receiptNumber) {
                      showAlert(`收據編號：${result.receiptNumber}`, 'info');
                  }
                  
                  if (result.voucherNumber) {
                      showAlert(`憑證編號：${result.voucherNumber}`, 'info');
                  }
                  
                  resetTransactionForm();
                  
                  // 重新載入資料
                  if (document.getElementById('records').classList.contains('active')) {
                      await loadTransactions();
                      await loadFinancialSummary();
                  }
              } else {
                  showToast('儲存失敗：' + result.error, 'error');
              }
              
          } catch (error) {
              hideLoading();
              console.error('儲存交易記錄失敗:', error);
              showToast('儲存失敗：' + error.message, 'error');
          }
      });
      
      async function loadTransactions() {
          try {
              showLoading('載入交易記錄中...');
              
              const params = getSearchParams();
              const result = await callGoogleScript('getTransactions', params);
              
              hideLoading();
              
              if (result.success) {
                  currentTransactions = result.data;
                  displayTransactions();
                  updatePagination();
              } else {
                  showToast('載入交易記錄失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('載入交易記錄失敗:', error);
              showToast('載入交易記錄失敗：' + error.message, 'error');
          }
      }
      
      function getSearchParams() {
          return {
              dateFrom: document.getElementById('searchDateFrom').value,
              dateTo: document.getElementById('searchDateTo').value,
              type: document.getElementById('searchType').value,
              category: document.getElementById('searchCategory').value,
              name: document.getElementById('searchName').value,
              amountMin: document.getElementById('searchAmountMin').value,
              amountMax: document.getElementById('searchAmountMax').value,
              page: currentPage,
              limit: itemsPerPage
          };
      }
      
      function displayTransactions() {
          const tbody = document.getElementById('transactionsTableBody');
          
          if (currentTransactions.length === 0) {
              tbody.innerHTML = `
                  <tr>
                      <td colspan="10" class="empty-state">
                          <div class="icon"><i class="fas fa-inbox"></i></div>
                          <h3>暫無交易記錄</h3>
                          <p>請新增交易記錄或調整搜尋條件</p>
                      </td>
                  </tr>
              `;
              return;
          }
          
          tbody.innerHTML = currentTransactions.map(transaction => `
              <tr>
                  <td>
                      <input type="checkbox" value="${transaction.receiptNumber}" 
                             onchange="handleItemSelection(this)">
                  </td>
                  <td>${transaction.date}</td>
                  <td>${transaction.name}</td>
                  <td>
                      <span class="badge ${transaction.type === '收入' ? 'income' : 'expense'}">
                          ${transaction.type}
                      </span>
                  </td>
                  <td>${transaction.category}</td>
                  <td class="amount ${transaction.type === '收入' ? 'income' : 'expense'}">
                      $${transaction.amount.toLocaleString()}
                  </td>
                  <td title="${transaction.description}">${transaction.description.substring(0, 30)}${transaction.description.length > 30 ? '...' : ''}</td>
                  <td>${transaction.receiptNumber || '-'}</td>
                  <td>
                      <span class="badge ${getStatusClass(transaction.status)}">
                          ${transaction.status}
                      </span>
                  </td>
                  <td>
                      <div class="btn-group" style="gap: 5px;">
                          ${transaction.receiptNumber ? `
                              <button class="btn btn-sm" onclick="viewReceipt('${transaction.receiptNumber}')" 
                                      title="查看收據">
                                  <i class="fas fa-eye"></i>
                              </button>
                          ` : ''}
                          <button class="btn btn-sm btn-danger" onclick="deleteTransaction('${transaction.receiptNumber}')" 
                                  title="刪除記錄">
                              <i class="fas fa-trash"></i>
                          </button>
                      </div>
                  </td>
              </tr>
          `).join('');
      }
      
      function getStatusClass(status) {
          switch(status) {
              case '已完成': return 'success';
              case '待處理': return 'warning';
              case '已取消': return 'danger';
              default: return 'secondary';
          }
      }
      
      async function loadFinancialSummary() {
          try {
              const year = new Date().getFullYear();
              const month = new Date().getMonth() + 1;
              
              const result = await callGoogleScript('getFinancialSummary', { year, month });
              
              if (result.success) {
                  const data = result.data;
                  document.getElementById('totalIncome').textContent = `$${data.totalIncome.toLocaleString()}`;
                  document.getElementById('totalExpense').textContent = `$${data.totalExpense.toLocaleString()}`;
                  document.getElementById('netIncome').textContent = `$${data.netIncome.toLocaleString()}`;
                  document.getElementById('totalTransactions').textContent = data.totalTransactions;
                  
                  // 更新淨收入顏色
                  const netIncomeElement = document.getElementById('netIncome');
                  netIncomeElement.className = data.netIncome >= 0 ? 'income' : 'expense';
              }
          } catch (error) {
              console.error('載入財務摘要失敗:', error);
          }
      }

      // ========================================
      // 搜尋與篩選功能
      // ========================================
      
      async function searchTransactions() {
          currentPage = 1;
          await loadTransactions();
      }
      
      function resetSearchFilters() {
          document.getElementById('searchDateFrom').value = '';
          document.getElementById('searchDateTo').value = '';
          document.getElementById('searchType').value = '';
          document.getElementById('searchCategory').value = '';
          document.getElementById('searchName').value = '';
          document.getElementById('searchAmountMin').value = '';
          document.getElementById('searchAmountMax').value = '';
          
          searchTransactions();
      }
      
      // 更新類別篩選選項
      document.getElementById('searchType').addEventListener('change', function() {
          const type = this.value;
          const categorySelect = document.getElementById('searchCategory');
          
          categorySelect.innerHTML = '<option value="">全部類別</option>';
          
          if (type === '收入') {
              incomeCategories.forEach(category => {
                  const option = document.createElement('option');
                  option.value = category;
                  option.textContent = category;
                  categorySelect.appendChild(option);
              });
          } else if (type === '支出') {
              expenseCategories.forEach(category => {
                  const option = document.createElement('option');
                  option.value = category;
                  option.textContent = category;
                  categorySelect.appendChild(option);
              });
          }
      });

      // ========================================
      // 收據管理功能
      // ========================================
      
      async function loadReceipts() {
          try {
              showLoading('載入收據記錄中...');
              
              const params = {
                  receiptNumber: document.getElementById('receiptSearchNumber').value,
                  payer: document.getElementById('receiptSearchPayer').value,
                  dateFrom: document.getElementById('receiptSearchDateFrom').value,
                  dateTo: document.getElementById('receiptSearchDateTo').value
              };
              
              const result = await callGoogleScript('getReceiptRecords', params);
              
              hideLoading();
              
              if (result.success) {
                  currentReceipts = result.data;
                  displayReceipts();
              } else {
                  showToast('載入收據記錄失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('載入收據記錄失敗:', error);
              showToast('載入收據記錄失敗：' + error.message, 'error');
          }
      }
      
      function displayReceipts() {
          const tbody = document.getElementById('receiptsTableBody');
          
          if (currentReceipts.length === 0) {
              tbody.innerHTML = `
                  <tr>
                      <td colspan="10" class="empty-state">
                          <div class="icon"><i class="fas fa-receipt"></i></div>
                          <h3>暫無收據記錄</h3>
                          <p>請新增收入記錄並開立收據</p>
                      </td>
                  </tr>
              `;
              return;
          }
          
          tbody.innerHTML = currentReceipts.map(receipt => `
              <tr>
                  <td>${receipt.receiptNumber}</td>
                  <td>${receipt.date}</td>
                  <td>${receipt.payer}</td>
                  <td>${receipt.identity || '-'}</td>
                  <td>${receipt.phone || '-'}</td>
                  <td>${receipt.email || '-'}</td>
                  <td>${receipt.category}</td>
                  <td class="amount income">$${receipt.amount.toLocaleString()}</td>
                  <td>
                      <span class="badge ${receipt.emailSent ? 'success' : 'warning'}">
                          ${receipt.emailSent ? '已寄送' : '未寄送'}
                      </span>
                  </td>
                  <td>
                      <div class="btn-group" style="gap: 5px;">
                          <button class="btn btn-sm" onclick="viewReceipt('${receipt.receiptNumber}')" 
                                  title="查看收據">
                              <i class="fas fa-eye"></i>
                          </button>
                          <button class="btn btn-sm btn-warning" onclick="resendReceiptEmail('${receipt.receiptNumber}')" 
                                  title="重新寄送">
                              <i class="fas fa-envelope"></i>
                          </button>
                      </div>
                  </td>
              </tr>
          `).join('');
      }
      
      async function searchReceipts() {
          await loadReceipts();
      }
      
      function resetReceiptSearch() {
          document.getElementById('receiptSearchNumber').value = '';
          document.getElementById('receiptSearchPayer').value = '';
          document.getElementById('receiptSearchDateFrom').value = '';
          document.getElementById('receiptSearchDateTo').value = '';
          
          searchReceipts();
      }
      
      async function viewReceipt(receiptNumber) {
          try {
              showLoading('載入收據資料中...');
              
              const result = await callGoogleScript('getReceiptData', { receiptNumber });
              
              hideLoading();
              
              if (result.success) {
                  currentReceiptData = result.data;
                  displayReceiptPreview(result.data);
                  showModal('receiptModal');
              } else {
                  showToast('載入收據資料失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('載入收據資料失敗:', error);
              showToast('載入收據資料失敗：' + error.message, 'error');
          }
      }
      
      function displayReceiptPreview(receiptData) {
          const content = document.getElementById('receiptPreviewContent');
          
          content.innerHTML = `
              <div class="receipt-preview">
                  <div class="receipt-header" style="text-align: center; margin-bottom: 20px;">
                      <h2>台灣帕金森病友權益促進會</h2>
                      <h3>捐款收據</h3>
                  </div>
                  
                  <div class="receipt-info">
                      <div class="info-item">
                          <span class="info-label">收據編號：</span>
                          <span>${receiptData.receiptNumber}</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">開立日期：</span>
                          <span>${receiptData.date}</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">捐款人：</span>
                          <span>${receiptData.payer}</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">身分：</span>
                          <span>${receiptData.identity || '-'}</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">聯絡電話：</span>
                          <span>${receiptData.phone || '-'}</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">電子郵件：</span>
                          <span>${receiptData.email || '-'}</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">捐款類別：</span>
                          <span>${receiptData.category}</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">用途說明：</span>
                          <span>${receiptData.description || '-'}</span>
                      </div>
                  </div>
                  
                  <div class="amount-highlight">
                      <div class="amount">$${receiptData.amount.toLocaleString()}</div>
                      <div>捐款金額（新台幣）</div>
                  </div>
                  
                  <div style="text-align: center; margin-top: 20px; font-size: 14px; color: #666;">
                      <p>感謝您的愛心捐款，本會將善用每一分資源協助帕金森病友</p>
                      <p>本收據可作為所得稅列舉扣除憑證</p>
                  </div>
              </div>
          `;
      }

      // ========================================
      // 支出憑證管理功能
      // ========================================
      
      async function loadVouchers() {
          try {
              showLoading('載入憑證記錄中...');
              
              const params = {
                  voucherNumber: document.getElementById('voucherSearchNumber').value,
                  applicant: document.getElementById('voucherSearchApplicant').value,
                  status: document.getElementById('voucherSearchStatus').value,
                  department: document.getElementById('voucherSearchDepartment').value
              };
              
              const result = await callGoogleScript('getExpenseVouchers', params);
              
              hideLoading();
              
              if (result.success) {
                  currentVouchers = result.data;
                  displayVouchers();
              } else {
                  showToast('載入憑證記錄失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('載入憑證記錄失敗:', error);
              showToast('載入憑證記錄失敗：' + error.message, 'error');
          }
      }
      
      function displayVouchers() {
          const tbody = document.getElementById('vouchersTableBody');
          
          if (currentVouchers.length === 0) {
              tbody.innerHTML = `
                  <tr>
                      <td colspan="10" class="empty-state">
                          <div class="icon"><i class="fas fa-file-invoice"></i></div>
                          <h3>暫無憑證記錄</h3>
                          <p>請新增支出記錄並生成憑證</p>
                      </td>
                  </tr>
              `;
              return;
          }
          
          tbody.innerHTML = currentVouchers.map(voucher => `
              <tr>
                  <td>${voucher.voucherNumber}</td>
                  <td>${voucher.date}</td>
                  <td>${voucher.applicant}</td>
                  <td>${voucher.department}</td>
                  <td>${voucher.category}</td>
                  <td class="amount expense">$${voucher.amount.toLocaleString()}</td>
                  <td title="${voucher.description}">${voucher.description.substring(0, 30)}${voucher.description.length > 30 ? '...' : ''}</td>
                  <td>${voucher.receiptCount}</td>
                  <td>
                      <span class="badge ${getVoucherStatusClass(voucher.status)}">
                          ${voucher.status}
                      </span>
                  </td>
                  <td>
                      <div class="btn-group" style="gap: 5px;">
                          <button class="btn btn-sm" onclick="viewVoucher('${voucher.voucherNumber}')" 
                                  title="查看憑證">
                              <i class="fas fa-eye"></i>
                          </button>
                          ${voucher.status === '待審核' ? `
                              <button class="btn btn-sm btn-success" onclick="approveVoucher('${voucher.voucherNumber}')" 
                                      title="審核通過">
                                  <i class="fas fa-check"></i>
                              </button>
                              <button class="btn btn-sm btn-danger" onclick="rejectVoucher('${voucher.voucherNumber}')" 
                                      title="駁回">
                                  <i class="fas fa-times"></i>
                              </button>
                          ` : ''}
                      </div>
                  </td>
              </tr>
          `).join('');
      }
      
      function getVoucherStatusClass(status) {
          switch(status) {
              case '已審核': return 'success';
              case '待審核': return 'warning';
              case '已駁回': return 'danger';
              default: return 'secondary';
          }
      }
      
      async function searchVouchers() {
          await loadVouchers();
      }
      
      function resetVoucherSearch() {
          document.getElementById('voucherSearchNumber').value = '';
          document.getElementById('voucherSearchApplicant').value = '';
          document.getElementById('voucherSearchStatus').value = '';
          document.getElementById('voucherSearchDepartment').value = '';
          
          searchVouchers();
      }

      // ========================================
      // 人員管理功能
      // ========================================
      
      async function loadPersonnel() {
          try {
              showLoading('載入人員資料中...');
              
              const keyword = document.getElementById('personnelSearchName').value ||
                             document.getElementById('personnelSearchPhone').value ||
                             document.getElementById('personnelSearchEmail').value;
              
              let result;
              if (keyword) {
                  result = await callGoogleScript('searchPersonnel', { keyword });
              } else {
                  result = await callGoogleScript('getAllPersonnel');
              }
              
              hideLoading();
              
              if (result.success) {
                  currentPersonnel = result.data;
                  displayPersonnel();
              } else {
                  showToast('載入人員資料失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('載入人員資料失敗:', error);
              showToast('載入人員資料失敗：' + error.message, 'error');
          }
      }
      
      function displayPersonnel() {
          const tbody = document.getElementById('personnelTableBody');
          
          if (currentPersonnel.length === 0) {
              tbody.innerHTML = `
                  <tr>
                      <td colspan="8" class="empty-state">
                          <div class="icon"><i class="fas fa-users"></i></div>
                          <h3>暫無人員資料</h3>
                          <p>請新增交易記錄以建立人員資料</p>
                      </td>
                  </tr>
              `;
              return;
          }
          
          tbody.innerHTML = currentPersonnel.map(person => `
              <tr>
                  <td>${person.name}</td>
                  <td>${person.identity || '-'}</td>
                  <td>${person.phone || '-'}</td>
                  <td>${person.email || '-'}</td>
                  <td>${person.createdAt}</td>
                  <td>${person.updatedAt}</td>
                  <td class="amount income">$${(person.totalDonation || 0).toLocaleString()}</td>
                  <td>
                      <div class="btn-group" style="gap: 5px;">
                          <button class="btn btn-sm" onclick="viewPersonDetails('${person.name}')" 
                                  title="查看詳情">
                              <i class="fas fa-eye"></i>
                          </button>
                          <button class="btn btn-sm btn-warning" onclick="editPerson('${person.name}')" 
                                  title="編輯">
                              <i class="fas fa-edit"></i>
                          </button>
                      </div>
                  </td>
              </tr>
          `).join('');
      }
      
      async function searchPersonnel() {
          await loadPersonnel();
      }
      
      function resetPersonnelSearch() {
          document.getElementById('personnelSearchName').value = '';
          document.getElementById('personnelSearchPhone').value = '';
          document.getElementById('personnelSearchEmail').value = '';
          
          searchPersonnel();
      }

      // ========================================
      // 報表統計功能
      // ========================================
      
      async function generateReport() {
          try {
              const reportType = document.getElementById('reportType').value;
              const year = parseInt(document.getElementById('reportYear').value);
              const month = document.getElementById('reportMonth').value ? 
                           parseInt(document.getElementById('reportMonth').value) : null;
              
              showLoading('生成報表中...');
              
              let result;
              switch(reportType) {
                  case 'summary':
                      result = await callGoogleScript('getFinancialSummary', { year, month });
                      if (result.success) {
                          displaySummaryReport(result.data, year, month);
                      }
                      break;
                  case 'monthly':
                      if (!month) {
                          showToast('請選擇月份', 'warning');
                          hideLoading();
                          return;
                      }
                      result = await callGoogleScript('generateMonthlyReport', { year, month });
                      if (result.success) {
                          displayMonthlyReport(result);
                      }
                      break;
                  case 'annual':
                      result = await callGoogleScript('generateAnnualDonationStats', { year });
                      if (result.success) {
                          displayAnnualReport(result.data);
                      }
                      break;
                  case 'donation':
                      result = await callGoogleScript('generateAnnualDonationStats', { year });
                      if (result.success) {
                          displayDonationReport(result.data);
                      }
                      break;
              }
              
              hideLoading();
              
              if (!result.success) {
                  showToast('生成報表失敗：' + result.error, 'error');
              }
              
          } catch (error) {
              hideLoading();
              console.error('生成報表失敗:', error);
              showToast('生成報表失敗：' + error.message, 'error');
          }
      }
      
      function displaySummaryReport(data, year, month) {
          const content = document.getElementById('reportContent');
          const period = month ? `${year}年${month}月` : `${year}年`;
          
          content.innerHTML = `
              <div class="report-header">
                  <h3><i class="fas fa-chart-pie"></i> 財務摘要報表 - ${period}</h3>
              </div>
              
              <div class="stats-grid">
                  <div class="stat-card income">
                      <div class="icon"><i class="fas fa-arrow-up"></i></div>
                      <div class="value">$${data.totalIncome.toLocaleString()}</div>
                      <div class="label">總收入</div>
                  </div>
                  <div class="stat-card expense">
                      <div class="icon"><i class="fas fa-arrow-down"></i></div>
                      <div class="value">$${data.totalExpense.toLocaleString()}</div>
                      <div class="label">總支出</div>
                  </div>
                  <div class="stat-card net">
                      <div class="icon"><i class="fas fa-balance-scale"></i></div>
                      <div class="value ${data.netIncome >= 0 ? 'income' : 'expense'}">$${data.netIncome.toLocaleString()}</div>
                      <div class="label">淨收入</div>
                  </div>
                  <div class="stat-card count">
                      <div class="icon"><i class="fas fa-hashtag"></i></div>
                      <div class="value">${data.totalTransactions}</div>
                      <div class="label">交易筆數</div>
                  </div>
              </div>
              
              <div class="form-grid">
                  <div class="form-group">
                      <h4>收入分析</h4>
                      <table class="data-table">
                          <thead>
                              <tr><th>類別</th><th>金額</th><th>筆數</th><th>占比</th></tr>
                          </thead>
                          <tbody>
                              ${data.incomeByCategory ? data.incomeByCategory.map(item => `
                                  <tr>
                                      <td>${item.category}</td>
                                      <td class="amount income">$${item.amount.toLocaleString()}</td>
                                      <td>${item.count}</td>
                                      <td>${((item.amount / data.totalIncome) * 100).toFixed(1)}%</td>
                                  </tr>
                              `).join('') : '<tr><td colspan="4">暫無資料</td></tr>'}
                          </tbody>
                      </table>
                  </div>
                  
                  <div class="form-group">
                      <h4>支出分析</h4>
                      <table class="data-table">
                          <thead>
                              <tr><th>類別</th><th>金額</th><th>筆數</th><th>占比</th></tr>
                          </thead>
                          <tbody>
                              ${data.expenseByCategory ? data.expenseByCategory.map(item => `
                                  <tr>
                                      <td>${item.category}</td>
                                      <td class="amount expense">$${item.amount.toLocaleString()}</td>
                                      <td>${item.count}</td>
                                      <td>${((item.amount / data.totalExpense) * 100).toFixed(1)}%</td>
                                  </tr>
                              `).join('') : '<tr><td colspan="4">暫無資料</td></tr>'}
                          </tbody>
                      </table>
                  </div>
              </div>
          `;
      }

      // ========================================
      // 系統管理功能
      // ========================================
      
      async function checkSystemHealth() {
          try {
              const result = await callGoogleScript('checkSystemHealth');
              
              if (result.success) {
                  displaySystemStatus(result.data);
              } else {
                  showToast('系統健康檢查失敗：' + result.error, 'error');
              }
          } catch (error) {
              console.error('系統健康檢查失敗:', error);
              displaySystemStatus({
                  spreadsheet: { status: 'offline', message: '無法連接' },
                  email: { status: 'unknown', message: '未知' },
                  pdf: { status: 'unknown', message: '未知' }
              });
          }
      }
      
      function displaySystemStatus(statusData) {
          const container = document.getElementById('systemStatus');
          
          container.innerHTML = `
              <div class="status-item ${statusData.spreadsheet.status}">
                  <div class="status-icon">
                      <i class="fas ${statusData.spreadsheet.status === 'online' ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                  </div>
                  <div>
                      <strong>試算表連接</strong>
                      <div>${statusData.spreadsheet.message}</div>
                  </div>
              </div>
              
              <div class="status-item ${statusData.email.status}">
                  <div class="status-icon">
                      <i class="fas ${statusData.email.status === 'online' ? 'fa-check-circle' : statusData.email.status === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle'}"></i>
                  </div>
                  <div>
                      <strong>郵件服務</strong>
                      <div>${statusData.email.message}</div>
                  </div>
              </div>
              
              <div class="status-item ${statusData.pdf.status}">
                  <div class="status-icon">
                      <i class="fas ${statusData.pdf.status === 'online' ? 'fa-check-circle' : statusData.pdf.status === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle'}"></i>
                  </div>
                  <div>
                      <strong>PDF生成</strong>
                      <div>${statusData.pdf.message}</div>
                  </div>
              </div>
          `;
      }
      
      async function refreshSystemStatus() {
          await checkSystemHealth();
          showToast('系統狀態已更新', 'info');
      }
      
      async function createBackup() {
          try {
              showLoading('建立備份中...');
              
              const result = await callGoogleScript('createDataBackup');
              
              hideLoading();
              
              if (result.success) {
                  showToast('備份建立成功：' + result.backupId, 'success');
              } else {
                  showToast('備份建立失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('建立備份失敗:', error);
              showToast('建立備份失敗：' + error.message, 'error');
          }
      }
      
      async function exportAllData() {
          try {
              showLoading('匯出資料中...');
              
              const result = await callGoogleScript('exportAllData');
              
              hideLoading();
              
              if (result.success) {
                  // 下載檔案
                  const blob = new Blob([result.data], { type: 'text/csv;charset=utf-8;' });
                  const link = document.createElement('a');
                  link.href = URL.createObjectURL(blob);
                  link.download = `帕金森會計系統資料_${new Date().toISOString().split('T')[0]}.csv`;
                  link.click();
                  
                  showToast('資料匯出成功', 'success');
              } else {
                  showToast('資料匯出失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('資料匯出失敗:', error);
              showToast('資料匯出失敗：' + error.message, 'error');
          }
      }

      // ========================================
      // 測試功能
      // ========================================
      
      async function testReceiptFunction() {
          try {
              showLoading('測試收據功能中...');
              
              const testData = {
                  receiptNumber: 'TEST' + Date.now(),
                  date: new Date().toISOString().split('T')[0],
                  payer: '測試捐款人',
                  amount: 1000,
                  category: '一般捐款',
                  description: '收據功能測試'
              };
              
              const result = await callGoogleScript('testReceiptGeneration', testData);
              
              hideLoading();
              
              if (result.success) {
                  showToast('收據功能測試成功', 'success');
              } else {
                  showToast('收據功能測試失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('收據功能測試失敗:', error);
              showToast('收據功能測試失敗：' + error.message, 'error');
          }
      }
      
      async function testEmailFunction() {
          try {
              showLoading('測試郵件功能中...');
              
              const result = await callGoogleScript('testEmailFunction', {
                  to: 'test@example.com',
                  subject: '郵件功能測試',
                  body: '這是一封測試郵件，用於驗證系統郵件功能是否正常運作。'
              });
              
              hideLoading();
              
              if (result.success) {
                  showToast('郵件功能測試成功', 'success');
              } else {
                  showToast('郵件功能測試失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('郵件功能測試失敗:', error);
              showToast('郵件功能測試失敗：' + error.message, 'error');
          }
      }
      
      async function testPDFGeneration() {
          try {
              showLoading('測試PDF生成中...');
              
              const result = await callGoogleScript('testPDFGeneration');
              
              hideLoading();
              
              if (result.success) {
                  showToast('PDF生成測試成功', 'success');
              } else {
                  showToast('PDF生成測試失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('PDF生成測試失敗:', error);
              showToast('PDF生成測試失敗：' + error.message, 'error');
          }
      }

      // ========================================
      // 郵件功能
      // ========================================
      
      document.getElementById('emailForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          if (!currentReceiptData) {
              showToast('沒有收據資料可寄送', 'error');
              return;
          }
          
          try {
              showLoading('寄送郵件中...');
              
              const recipient = document.getElementById('emailRecipient').value;
              const customMessage = document.getElementById('emailMessage').value;
              
              const result = await callGoogleScript('sendReceiptEmail', {
                  receiptNumber: currentReceiptData.receiptNumber,
                  recipient: recipient,
                  customMessage: customMessage
              });
              
              hideLoading();
              
              if (result.success) {
                  showToast('收據郵件寄送成功', 'success');
                  closeModal('emailModal');
                  
                  // 重新載入收據記錄
                  if (document.getElementById('receipts').classList.contains('active')) {
                      await loadReceipts();
                  }
              } else {
                  showToast('郵件寄送失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('郵件寄送失敗:', error);
              showToast('郵件寄送失敗：' + error.message, 'error');
          }
      });
      
      async function resendReceiptEmail(receiptNumber) {
          try {
              // 載入收據資料
              const result = await callGoogleScript('getReceiptData', { receiptNumber });
              
              if (result.success && result.data.email) {
                  currentReceiptData = result.data;
                  document.getElementById('emailRecipient').value = result.data.email;
                  document.getElementById('emailMessage').value = '';
                  showModal('emailModal');
              } else {
                  showToast('無法載入收據資料或缺少電子郵件', 'error');
              }
          } catch (error) {
              console.error('載入收據資料失敗:', error);
              showToast('載入收據資料失敗：' + error.message, 'error');
          }
      }

      // ========================================
      // PDF 下載功能
      // ========================================
      
      async function downloadReceiptPDF() {
          if (!currentReceiptData) {
              showToast('沒有收據資料可下載', 'error');
              return;
          }
          
          try {
              showLoading('生成PDF中...');
              
              const result = await callGoogleScript('generateReceiptPDF', {
                  receiptNumber: currentReceiptData.receiptNumber
              });
              
              hideLoading();
              
              if (result.success) {
                  // 建立下載連結
                  const link = document.createElement('a');
                  link.href = result.pdfUrl;
                  link.download = `收據_${currentReceiptData.receiptNumber}.pdf`;
                  link.click();
                  
                  showToast('PDF下載成功', 'success');
              } else {
                  showToast('PDF生成失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('PDF生成失敗:', error);
              showToast('PDF生成失敗：' + error.message, 'error');
          }
      }

      // ========================================
      // 批量操作功能
      // ========================================
      
      function toggleSelectAll() {
          const selectAll = document.getElementById('selectAll');
          const checkboxes = document.querySelectorAll('#transactionsTableBody input[type="checkbox"]');
          
          checkboxes.forEach(checkbox => {
              checkbox.checked = selectAll.checked;
          });
          
          updateBatchActions();
      }
      
      function handleItemSelection(checkbox) {
          const checkboxes = document.querySelectorAll('#transactionsTableBody input[type="checkbox"]');
          const checkedBoxes = document.querySelectorAll('#transactionsTableBody input[type="checkbox"]:checked');
          
          document.getElementById('selectAll').checked = checkboxes.length === checkedBoxes.length;
          
          updateBatchActions();
      }
      
      function updateBatchActions() {
          const checkedBoxes = document.querySelectorAll('#transactionsTableBody input[type="checkbox"]:checked');
          const batchActions = document.getElementById('batchActions');
          
          if (checkedBoxes.length > 0) {
              batchActions.style.display = 'block';
              selectedItems = Array.from(checkedBoxes).map(cb => cb.value);
          } else {
              batchActions.style.display = 'none';
              selectedItems = [];
          }
      }
      
      async function batchDeleteTransactions() {
          if (selectedItems.length === 0) {
              showToast('請選擇要刪除的項目', 'warning');
              return;
          }
          
          if (!confirm(`確定要刪除選中的 ${selectedItems.length} 筆記錄嗎？此操作無法復原。`)) {
              return;
          }
          
          try {
              showLoading('批量刪除中...');
              
              const result = await callGoogleScript('batchDeleteTransactions', {
                  receiptNumbers: selectedItems
              });
              
              hideLoading();
              
              if (result.success) {
                  showToast(`成功刪除 ${result.deletedCount} 筆記錄`, 'success');
                  await loadTransactions();
                  await loadFinancialSummary();
                  selectedItems = [];
                  updateBatchActions();
              } else {
                  showToast('批量刪除失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('批量刪除失敗:', error);
              showToast('批量刪除失敗：' + error.message, 'error');
          }
      }
      
      async function batchExportTransactions() {
          if (selectedItems.length === 0) {
              showToast('請選擇要匯出的項目', 'warning');
              return;
          }
          
          try {
              showLoading('批量匯出中...');
              
              const result = await callGoogleScript('batchExportTransactions', {
                  receiptNumbers: selectedItems
              });
              
              hideLoading();
              
              if (result.success) {
                  // 下載檔案
                  const blob = new Blob([result.data], { type: 'text/csv;charset=utf-8;' });
                  const link = document.createElement('a');
                  link.href = URL.createObjectURL(blob);
                  link.download = `選中交易記錄_${new Date().toISOString().split('T')[0]}.csv`;
                  link.click();
                  
                  showToast(`成功匯出 ${selectedItems.length} 筆記錄`, 'success');
              } else {
                  showToast('批量匯出失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('批量匯出失敗:', error);
              showToast('批量匯出失敗：' + error.message, 'error');
          }
      }

      // ========================================
      // 刪除確認功能
      // ========================================
      
      function deleteTransaction(receiptNumber) {
          deleteTarget = { type: 'transaction', id: receiptNumber };
          document.getElementById('deleteModalContent').innerHTML = `
              <p>您確定要刪除收據編號「${receiptNumber}」的交易記錄嗎？</p>
              <p>此操作將同時刪除相關的收據和憑證記錄，且無法復原。</p>
          `;
          showModal('deleteModal');
      }
      
      async function confirmDelete() {
          if (!deleteTarget) return;
          
          try {
              showLoading('刪除中...');
              
              let result;
              if (deleteTarget.type === 'transaction') {
                  result = await callGoogleScript('deleteTransaction', {
                      receiptNumber: deleteTarget.id
                  });
              }
              
              hideLoading();
              closeModal('deleteModal');
              
              if (result.success) {
                  showToast('記錄刪除成功', 'success');
                  
                  // 重新載入相關資料
                  if (document.getElementById('records').classList.contains('active')) {
                      await loadTransactions();
                      await loadFinancialSummary();
                  }
                  if (document.getElementById('receipts').classList.contains('active')) {
                      await loadReceipts();
                  }
              } else {
                  showToast('刪除失敗：' + result.error, 'error');
              }
              
              deleteTarget = null;
          } catch (error) {
              hideLoading();
              closeModal('deleteModal');
              console.error('刪除失敗:', error);
              showToast('刪除失敗：' + error.message, 'error');
              deleteTarget = null;
          }
      }

      // ========================================
      // 匯出功能
      // ========================================
      
      async function exportTransactions() {
          try {
              showLoading('匯出交易記錄中...');
              
              const params = getSearchParams();
              const result = await callGoogleScript('exportTransactions', params);
              
              hideLoading();
              
              if (result.success) {
                  // 下載檔案
                  const blob = new Blob([result.data], { type: 'text/csv;charset=utf-8;' });
                  const link = document.createElement('a');
                  link.href = URL.createObjectURL(blob);
                  link.download = `交易記錄_${new Date().toISOString().split('T')[0]}.csv`;
                  link.click();
                  
                  showToast('交易記錄匯出成功', 'success');
              } else {
                  showToast('匯出失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('匯出失敗:', error);
              showToast('匯出失敗：' + error.message, 'error');
          }
      }
      
      async function exportPersonnel() {
          try {
              showLoading('匯出人員資料中...');
              
              const result = await callGoogleScript('exportPersonnel');
              
              hideLoading();
              
              if (result.success) {
                  // 下載檔案
                  const blob = new Blob([result.data], { type: 'text/csv;charset=utf-8;' });
                  const link = document.createElement('a');
                  link.href = URL.createObjectURL(blob);
                  link.download = `人員資料_${new Date().toISOString().split('T')[0]}.csv`;
                  link.click();
                  
                  showToast('人員資料匯出成功', 'success');
              } else {
                  showToast('匯出失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('匯出失敗:', error);
              showToast('匯出失敗：' + error.message, 'error');
          }
      }
      
      async function exportReport() {
          try {
              showLoading('匯出報表中...');
              
              const reportType = document.getElementById('reportType').value;
              const year = parseInt(document.getElementById('reportYear').value);
              const month = document.getElementById('reportMonth').value ? 
                           parseInt(document.getElementById('reportMonth').value) : null;
              
              const result = await callGoogleScript('exportReport', {
                  type: reportType,
                  year: year,
                  month: month
              });
              
              hideLoading();
              
              if (result.success) {
                  // 下載PDF檔案
                  const link = document.createElement('a');
                  link.href = result.pdfUrl;
                  link.download = `${reportType}_報表_${year}${month ? '_' + month : ''}.pdf`;
                  link.click();
                  
                  showToast('報表匯出成功', 'success');
              } else {
                  showToast('報表匯出失敗：' + result.error, 'error');
              }
          } catch (error) {
              hideLoading();
              console.error('報表匯出失敗:', error);
              showToast('報表匯出失敗：' + error.message, 'error');
          }
      }

      // ========================================
      // 分頁功能
      // ========================================
      
      function updatePagination() {
          const pagination = document.getElementById('pagination');
          const totalPages = Math.ceil(currentTransactions.length / itemsPerPage);
          
          if (totalPages <= 1) {
              pagination.innerHTML = '';
              return;
          }
          
          let paginationHTML = '';
          
          // 上一頁按鈕
          paginationHTML += `
              <button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">
                  <i class="fas fa-chevron-left"></i>
              </button>
          `;
          
          // 頁碼按鈕
          for (let i = 1; i <= totalPages; i++) {
              if (i === currentPage) {
                  paginationHTML += `<button class="active">${i}</button>`;
              } else if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
                  paginationHTML += `<button onclick="changePage(${i})">${i}</button>`;
              } else if (i === currentPage - 3 || i === currentPage + 3) {
                  paginationHTML += `<span>...</span>`;
              }
          }
          
          // 下一頁按鈕
          paginationHTML += `
              <button ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">
                  <i class="fas fa-chevron-right"></i>
              </button>
          `;
          
          pagination.innerHTML = paginationHTML;
      }
      
      async function changePage(page) {
          currentPage = page;
          await loadTransactions();
      }

      // ========================================
      // UI 輔助功能
      // ========================================
      
      function showModal(modalId) {
          document.getElementById(modalId).classList.add('show');
          document.body.style.overflow = 'hidden';
      }
      
      function closeModal(modalId) {
          document.getElementById(modalId).classList.remove('show');
          document.body.style.overflow = 'auto';
      }
      
      function showLoading(message = '載入中...') {
          const loadingElements = document.querySelectorAll('.loading');
          loadingElements.forEach(el => {
              el.classList.add('show');
              const messageEl = el.querySelector('p');
              if (messageEl) messageEl.textContent = message;
          });
      }
      
      function hideLoading() {
          const loadingElements = document.querySelectorAll('.loading');
          loadingElements.forEach(el => el.classList.remove('show'));
      }
      
      function showAlert(message, type = 'info') {
          const alert = document.getElementById('globalAlert');
          const messageEl = document.getElementById('globalAlertMessage');
          
          alert.className = `alert alert-${type} show`;
          messageEl.textContent = message;
          
          setTimeout(() => {
              alert.classList.remove('show');
          }, 5000);
      }
      
      function showToast(message, type = 'info') {
          const toast = document.getElementById('toast');
          const content = document.getElementById('toastContent');
          
          toast.className = `toast toast-${type} show`;
          content.innerHTML = `
              <div style="display: flex; align-items: center; gap: 10px;">
                  <i class="fas ${getToastIcon(type)}"></i>
                  <span>${message}</span>
              </div>
          `;
          
          setTimeout(() => {
              toast.classList.remove('show');
          }, 4000);
      }
      
      function getToastIcon(type) {
          switch(type) {
              case 'success': return 'fa-check-circle';
              case 'error': return 'fa-times-circle';
              case 'warning': return 'fa-exclamation-triangle';
              case 'info': return 'fa-info-circle';
              default: return 'fa-info-circle';
          }
      }
      
      // 點擊模態視窗外部關閉
      window.addEventListener('click', function(event) {
          const modals = document.querySelectorAll('.modal.show');
          modals.forEach(modal => {
              if (event.target === modal) {
                  modal.classList.remove('show');
                  document.body.style.overflow = 'auto';
              }
          });
      });
      
      // ESC 鍵關閉模態視窗
      document.addEventListener('keydown', function(event) {
          if (event.key === 'Escape') {
              const modals = document.querySelectorAll('.modal.show');
              modals.forEach(modal => {
                  modal.classList.remove('show');
                  document.body.style.overflow = 'auto';
              });
          }
      });

      // ========================================
      // 表單驗證
      // ========================================
      
      function validateTransactionForm() {
          const form = document.getElementById('transactionForm');
          const formData = new FormData(form);
          
          // 必填欄位檢查
          const requiredFields = ['date', 'type', 'name', 'category', 'amount'];
          for (const field of requiredFields) {
              if (!formData.get(field)) {
                  showToast(`請填寫${getFieldLabel(field)}`, 'warning');
                  return false;
              }
          }
          
          // 金額檢查
          const amount = parseInt(formData.get('amount'));
          if (amount <= 0) {
              showToast('金額必須大於0', 'warning');
              return false;
          }
          
          // 電子郵件格式檢查
          const email = formData.get('email');
          if (email && !isValidEmail(email)) {
              showToast('請輸入有效的電子郵件格式', 'warning');
              return false;
          }
          
          return true;
      }
      
      function getFieldLabel(field) {
          const labels = {
              'date': '交易日期',
              'type': '交易類型',
              'name': '姓名/機構',
              'category': '類別',
              'amount': '金額'
          };
          return labels[field] || field;
      }
      
      function isValidEmail(email) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailRegex.test(email);
      }

      // ========================================
      // 鍵盤快捷鍵
      // ========================================
      
      document.addEventListener('keydown', function(event) {
          // Ctrl/Cmd + S: 儲存表單
          if ((event.ctrlKey || event.metaKey) && event.key === 's') {
              event.preventDefault();
              const activeTab = document.querySelector('.tab-content.active');
              if (activeTab && activeTab.id === 'entry') {
                  if (validateTransactionForm()) {
                      document.getElementById('transactionForm').dispatchEvent(new Event('submit'));
                  }
              }
          }
          
          // Ctrl/Cmd + R: 重新整理資料
          if ((event.ctrlKey || event.metaKey) && event.key === 'r') {
              event.preventDefault();
              const activeTab = document.querySelector('.tab-content.active');
              if (activeTab) {
                  switch(activeTab.id) {
                      case 'records':
                          loadTransactions();
                          loadFinancialSummary();
                          break;
                      case 'receipts':
                          loadReceipts();
                          break;
                      case 'vouchers':
                          loadVouchers();
                          break;
                      case 'personnel':
                          loadPersonnel();
                          break;
                  }
              }
          }
          
          // Ctrl/Cmd + F: 聚焦搜尋欄位
          if ((event.ctrlKey || event.metaKey) && event.key === 'f') {
              event.preventDefault();
              const activeTab = document.querySelector('.tab-content.active');
              if (activeTab) {
                  const searchInput = activeTab.querySelector('input[type="text"], input[type="search"]');
                  if (searchInput) {
                      searchInput.focus();
                  }
              }
          }
      });

      // ========================================
      // 自動儲存功能
      // ========================================
      
      let autoSaveTimeout = null;
      
      function enableAutoSave() {
          const form = document.getElementById('transactionForm');
          const inputs = form.querySelectorAll('input, select, textarea');
          
          inputs.forEach(input => {
              input.addEventListener('input', function() {
                  clearTimeout(autoSaveTimeout);
                  autoSaveTimeout = setTimeout(() => {
                      saveFormDraft();
                  }, 2000); // 2秒後自動儲存草稿
              });
          });
      }
      
      function saveFormDraft() {
          const form = document.getElementById('transactionForm');
          const formData = new FormData(form);
          const draftData = {};
          
          for (const [key, value] of formData.entries()) {
              draftData[key] = value;
          }
          
          localStorage.setItem('transactionFormDraft', JSON.stringify(draftData));
          showToast('表單已自動儲存草稿', 'info');
      }
      
      function loadFormDraft() {
          const draftData = localStorage.getItem('transactionFormDraft');
          if (draftData) {
              try {
                  const data = JSON.parse(draftData);
                  const form = document.getElementById('transactionForm');
                  
                  Object.keys(data).forEach(key => {
                      const input = form.querySelector(`[name="${key}"]`);
                      if (input) {
                          input.value = data[key];
                          if (input.type === 'checkbox') {
                              input.checked = data[key] === 'true';
                          }
                      }
                  });
                  
                  // 觸發類型變更事件以更新類別選項
                  if (data.type) {
                      updateCategoryOptions();
                  }
                  
                  showToast('已載入表單草稿', 'info');
              } catch (error) {
                  console.error('載入表單草稿失敗:', error);
              }
          }
      }
      
      function clearFormDraft() {
          localStorage.removeItem('transactionFormDraft');
      }

      // ========================================
      // 離線支援
      // ========================================
      
      let isOnline = navigator.onLine;
      let pendingOperations = [];
      
      window.addEventListener('online', function() {
          isOnline = true;
          updateOnlineStatus();
          processPendingOperations();
      });
      
      window.addEventListener('offline', function() {
          isOnline = false;
          updateOnlineStatus();
      });
      
      function updateOnlineStatus() {
          const statusIndicator = document.getElementById('onlineStatus');
          if (statusIndicator) {
              statusIndicator.className = isOnline ? 'online' : 'offline';
              statusIndicator.textContent = isOnline ? '線上' : '離線';
          }
          
          if (!isOnline) {
              showToast('目前處於離線狀態，某些功能可能無法使用', 'warning');
          } else {
              showToast('已連線，所有功能正常', 'success');
          }
      }
      
      function addPendingOperation(operation) {
          pendingOperations.push({
              ...operation,
              timestamp: Date.now()
          });
          localStorage.setItem('pendingOperations', JSON.stringify(pendingOperations));
      }
      
      async function processPendingOperations() {
          if (pendingOperations.length === 0) return;
          
          showLoading('處理離線期間的操作...');
          
          const processedOperations = [];
          
          for (const operation of pendingOperations) {
              try {
                  const result = await callGoogleScript(operation.action, operation.params);
                  if (result.success) {
                      processedOperations.push(operation);
                  }
              } catch (error) {
                  console.error('處理離線操作失敗:', error);
              }
          }
          
          // 移除已處理的操作
          pendingOperations = pendingOperations.filter(op => 
              !processedOperations.includes(op)
          );
          
          localStorage.setItem('pendingOperations', JSON.stringify(pendingOperations));
          
          hideLoading();
          
          if (processedOperations.length > 0) {
              showToast(`已處理 ${processedOperations.length} 個離線操作`, 'success');
              
              // 重新載入資料
              const activeTab = document.querySelector('.tab-content.active');
              if (activeTab && activeTab.id === 'records') {
                  await loadTransactions();
                  await loadFinancialSummary();
              }
          }
      }

      // ========================================
      // 資料驗證與清理
      // ========================================
      
      function sanitizeInput(input) {
          if (typeof input !== 'string') return input;
          
          return input
              .trim()
              .replace(/[<>]/g, '') // 移除潛在的HTML標籤
              .substring(0, 1000); // 限制長度
      }
      
      function validateAmount(amount) {
          const numAmount = parseFloat(amount);
          return !isNaN(numAmount) && numAmount > 0 && numAmount <= 10000000; // 最大1千萬
      }
      
      function formatCurrency(amount) {
          return new Intl.NumberFormat('zh-TW', {
              style: 'currency',
              currency: 'TWD',
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
          }).format(amount);
      }
      
      function formatDate(dateString) {
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
          });
      }

      // ========================================
      // 效能優化
      // ========================================
      
      // 防抖函數
      function debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
              const later = () => {
                  clearTimeout(timeout);
                  func(...args);
              };
              clearTimeout(timeout);
              timeout = setTimeout(later, wait);
          };
      }
      
      // 節流函數
      function throttle(func, limit) {
          let inThrottle;
          return function() {
              const args = arguments;
              const context = this;
              if (!inThrottle) {
                  func.apply(context, args);
                  inThrottle = true;
                  setTimeout(() => inThrottle = false, limit);
              }
          }
      }
      
      // 使用防抖優化搜尋功能
      const debouncedSearch = debounce(searchTransactions, 500);
      
      // 綁定優化後的搜尋事件
      document.addEventListener('DOMContentLoaded', function() {
          const searchInputs = document.querySelectorAll('.search-filters input');
          searchInputs.forEach(input => {
              input.addEventListener('input', debouncedSearch);
          });
      });

      // ========================================
      // 錯誤處理與日誌
      // ========================================
      
      function logError(error, context = '') {
          const errorInfo = {
              message: error.message,
              stack: error.stack,
              context: context,
              timestamp: new Date().toISOString(),
              userAgent: navigator.userAgent,
              url: window.location.href
          };
          
          console.error('系統錯誤:', errorInfo);
          
          // 儲存錯誤日誌到本地存儲
          const errorLogs = JSON.parse(localStorage.getItem('errorLogs') || '[]');
          errorLogs.push(errorInfo);
          
          // 只保留最近50個錯誤
          if (errorLogs.length > 50) {
              errorLogs.splice(0, errorLogs.length - 50);
          }
          
          localStorage.setItem('errorLogs', JSON.stringify(errorLogs));
      }
      
      // 全域錯誤處理
      window.addEventListener('error', function(event) {
          logError(event.error, '全域錯誤');
      });
      
      window.addEventListener('unhandledrejection', function(event) {
          logError(new Error(event.reason), 'Promise拒絕');
      });

      // ========================================
      // 輔助功能支援
      // ========================================
      
      function enhanceAccessibility() {
          // 為所有按鈕添加鍵盤支援
          document.querySelectorAll('button, .btn').forEach(button => {
              button.addEventListener('keydown', function(event) {
                  if (event.key === 'Enter' || event.key === ' ') {
                      event.preventDefault();
                      button.click();
                  }
              });
          });
          
          // 為表格添加鍵盤導航
          document.querySelectorAll('.data-table').forEach(table => {
              table.setAttribute('role', 'table');
              table.querySelectorAll('th').forEach(th => {
                  th.setAttribute('role', 'columnheader');
              });
              table.querySelectorAll('td').forEach(td => {
                  td.setAttribute('role', 'cell');
              });
          });
          
          // 為模態視窗添加焦點管理
          document.querySelectorAll('.modal').forEach(modal => {
              modal.addEventListener('shown', function() {
                  const firstInput = modal.querySelector('input, button, select, textarea');
                  if (firstInput) {
                      firstInput.focus();
                  }
              });
          });
      }

      // ========================================
      // 系統初始化完成
      // ========================================
      
      document.addEventListener('DOMContentLoaded', function() {
          // 初始化所有功能
          initializeSystem();
          enableAutoSave();
          enhanceAccessibility();
          updateOnlineStatus();
          
          // 載入離線操作
          const savedOperations = localStorage.getItem('pendingOperations');
          if (savedOperations) {
              try {
                  pendingOperations = JSON.parse(savedOperations);
              } catch (error) {
                  console.error('載入離線操作失敗:', error);
              }
          }
          
          // 載入表單草稿
          if (confirm('發現表單草稿，是否要載入？')) {
              loadFormDraft();
          }
          
          console.log('台灣帕金森病友權益促進會會計系統已初始化完成');
      });

      // ========================================
      // 版本資訊與更新檢查
      // ========================================
      
      const SYSTEM_VERSION = '1.0.0';
      const BUILD_DATE = '2024-12-30';
      
      function checkForUpdates() {
          // 這裡可以實作版本檢查邏輯
          console.log(`當前版本: ${SYSTEM_VERSION} (${BUILD_DATE})`);
      }
      
      // 在控制台顯示系統資訊
      console.log(`
      ╔══════════════════════════════════════════════════════════════╗
      ║          台灣帕金森病友權益促進會會計系統                      ║
      ║                                                              ║
      ║  版本: ${SYSTEM_VERSION}                                        ║
      ║  建置日期: ${BUILD_DATE}                                      ║
      ║  開發者: AI Assistant                                        ║
      ║                                                              ║
      ║  功能特色:                                                    ║
      ║  • 收入支出記錄管理                                          ║
      ║  • 自動收據生成與寄送                                        ║
      ║  • 支出憑證管理                                              ║
      ║  • 人員資料管理                                              ║
      ║  • 財務報表統計                                              ║
      ║  • 系統健康監控                                              ║
      ║                                                              ║
      ║  如有問題請聯繫系統管理員                                    ║
      ╚══════════════════════════════════════════════════════════════╝
      `);

  </script>
</body>
</html>
