<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣帕金森病友權益促進會 - 會計管理系統</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #f8f9fa;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            color: #2c3e50;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e3c72 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .main-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e3c72 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1.5rem;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e3c72 100%);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(44, 90, 160, 0.3);
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .summary-item {
            text-align: center;
            padding: 1rem;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .summary-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .table {
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }

        .table thead th {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e3c72 100%);
            color: white;
            border: none;
            font-weight: 500;
            padding: 1rem;
        }

        .table tbody tr {
            transition: background-color 0.3s ease;
        }

        .table tbody tr:hover {
            background-color: #f8f9ff;
        }

        .amount-positive {
            color: var(--success-color);
            font-weight: bold;
        }

        .amount-negative {
            color: var(--danger-color);
            font-weight: bold;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-recorded { background: #e3f2fd; color: #1976d2; }
        .status-receipt-issued { background: #e8f5e8; color: #388e3c; }
        .status-receipt-sent { background: #f3e5f5; color: #7b1fa2; }
        .status-voucher-applied { background: #fff3e0; color: #f57c00; }
        .status-voucher-approved { background: #e8f5e8; color: #388e3c; }
        .status-voucher-rejected { background: #ffebee; color: #d32f2f; }

        .receipt-number-btn, .voucher-number-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .receipt-number-btn:hover, .voucher-number-btn:hover {
            color: #1e3c72;
        }

        .modal-content {
            border-radius: 15px;
            border: none;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e3c72 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            border: none;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.75rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25);
        }

        .sheets-status {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            max-width: 300px;
        }

        .sheets-connected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .sheets-disconnected {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .sync-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .receipt-preview, .voucher-preview {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: white;
            font-family: 'Microsoft JhengHei', serif;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid #333;
            padding-bottom: 1rem;
        }

        .receipt-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .receipt-subtitle {
            font-size: 1rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .receipt-type {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
        }

        .receipt-table td {
            padding: 0.75rem;
            border: 1px solid #ddd;
        }

        .receipt-table-label {
            background: #f8f9fa;
            font-weight: bold;
            width: 120px;
        }

        .receipt-amount {
            text-align: center;
            margin: 2rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .receipt-amount-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .receipt-amount-words {
            font-size: 1.1rem;
            color: #666;
        }

        .receipt-footer {
            margin-top: 3rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .receipt-stamps {
            display: flex;
            gap: 2rem;
        }

        .receipt-stamp {
            width: 80px;
            height: 80px;
            border: 2px solid #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .receipt-org-info {
            text-align: right;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .receipt-legal {
            text-align: center;
            font-size: 0.8rem;
            color: #666;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #ddd;
        }

        .voucher-form-table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
        }

        .voucher-form-table th,
        .voucher-form-table td {
            padding: 0.75rem;
            border: 1px solid #333;
            text-align: left;
        }

        .voucher-form-table th {
            background: #f8f9fa;
            font-weight: bold;
            width: 120px;
        }

        .voucher-receipt-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 2px dashed #ddd;
            border-radius: 10px;
        }

        .voucher-receipt-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }

        .voucher-receipt-box {
            height: 100px;
            border: 1px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 0.9rem;
        }

        .voucher-signature-section {
            margin: 2rem 0;
        }

        .voucher-signature-table {
            width: 100%;
            border-collapse: collapse;
        }

        .voucher-signature-table td {
            padding: 2rem 1rem;
            border: 1px solid #333;
            text-align: center;
            width: 25%;
        }

        .member-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .member-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .member-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .member-active { background: #d4edda; color: #155724; }
        .member-inactive { background: #f8d7da; color: #721c24; }
        .member-pending { background: #fff3cd; color: #856404; }

        .name-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .file-upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover,
        .file-upload-area.drag-over {
            border-color: var(--primary-color);
            background-color: #f8f9ff;
        }

        .batch-actions {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .summary-card {
                padding: 1rem;
            }
            
            .summary-value {
                font-size: 1.5rem;
            }
            
            .table-responsive {
                font-size: 0.9rem;
            }
            
            .receipt-preview,
            .voucher-preview {
                padding: 1rem;
            }
            
            .receipt-title {
                font-size: 1.5rem;
            }
            
            .receipt-stamps {
                flex-direction: column;
                gap: 1rem;
            }
            
            .receipt-stamp {
                width: 60px;
                height: 60px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- 導航列 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-heart-pulse me-2"></i>
                台灣帕金森病友權益促進會 - 會計系統
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showMemberManagement()">
                            <i class="bi bi-people"></i> 會員管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showVoucherManagement()">
                            <i class="bi bi-file-earmark-text"></i> 憑證管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="exportData()">
                            <i class="bi bi-download"></i> 匯出資料
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSettings()">
                            <i class="bi bi-gear"></i> 設定
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Google Sheets 連線狀態 -->
    <div id="sheetsStatus" class="alert sheets-status" style="display: none;"></div>

    <!-- 載入覆蓋層 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container main-container">
        <!-- Google Sheets 設定卡片 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-cloud"></i> Google 試算表設定
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="sheetsUrl" class="form-label">Google 試算表網址</label>
                            <input type="url" class="form-control" id="sheetsUrl" 
                                   placeholder="https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="connectToSheets()">
                                <i class="bi bi-link-45deg"></i> 連接試算表
                            </button>
                            <button class="btn btn-outline-secondary" onclick="createNewSheet()">
                                <i class="bi bi-plus-circle"></i> 建立新試算表
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-info btn-sm" onclick="syncWithSheets()">
                                <i class="bi bi-arrow-clockwise"></i> 手動同步
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="backupData()">
                                <i class="bi bi-shield-check"></i> 備份資料
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="restoreData()">
                                <i class="bi bi-upload"></i> 還原資料
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 財務摘要 -->
        <div class="summary-card">
            <div class="row">
                <div class="col-md-3 summary-item">
                    <div class="summary-value" id="totalIncome">NT$0</div>
                    <div class="summary-label">本月收入</div>
                </div>
                <div class="col-md-3 summary-item">
                    <div class="summary-value" id="totalExpense">NT$0</div>
                    <div class="summary-label">本月支出</div>
                </div>
                <div class="col-md-3 summary-item">
                    <div class="summary-value" id="totalAsset">NT$0</div>
                    <div class="summary-label">本月結餘</div>
                </div>
                <div class="col-md-3 summary-item">
                    <div class="summary-value" id="monthlyTransactions">0</div>
                    <div class="summary-label">本月交易</div>
                </div>
            </div>
        </div>

        <!-- 詳細統計 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-arrow-up-circle"></i> 收入明細</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="h5 text-success" id="income-entry">NT$0</div>
                                    <small class="text-muted">入會費</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="h5 text-success" id="income-annual">NT$0</div>
                                    <small class="text-muted">常年會費</small>
                                </div>
                            </div>
                            <div class="col-6 mt-3">
                                <div class="text-center">
                                    <div class="h5 text-success" id="income-donation">NT$0</div>
                                    <small class="text-muted">捐款</small>
                                </div>
                            </div>
                            <div class="col-6 mt-3">
                                <div class="text-center">
                                    <div class="h5 text-success" id="income-other">NT$0</div>
                                    <small class="text-muted">其他收入</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-arrow-down-circle"></i> 支出明細</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="h5 text-danger" id="expense-activity">NT$0</div>
                                    <small class="text-muted">活動支出</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="h5 text-danger" id="expense-admin">NT$0</div>
                                    <small class="text-muted">行政支出</small>
                                </div>
                            </div>
                            <div class="col-6 mt-3">
                                <div class="text-center">
                                    <div class="h5 text-danger" id="expense-other">NT$0</div>
                                    <small class="text-muted">其他支出</small>
                                </div>
                            </div>
                            <div class="col-6 mt-3">
                                <div class="text-center">
                                    <div class="h5 text-info" id="vouchers-pending">0</div>
                                    <small class="text-muted">待核憑證</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 交易記錄 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i> 交易記錄
                </h5>
                <button class="btn btn-light" onclick="showTransactionForm()">
                    <i class="bi bi-plus-circle"></i> 新增交易
                </button>
            </div>
            <div class="card-body">
                <!-- 篩選器 -->
                <div class="row mb-3">
                    <div class="col-md-2">
                        <select class="form-select" id="filterYear" onchange="applyFilters()">
                            <option value="">全部年份</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="filterMonth" onchange="applyFilters()">
                            <option value="">全部月份</option>
                            <option value="1">1月</option>
                            <option value="2">2月</option>
                            <option value="3">3月</option>
                            <option value="4">4月</option>
                            <option value="5">5月</option>
                            <option value="6">6月</option>
                            <option value="7">7月</option>
                            <option value="8">8月</option>
                            <option value="9">9月</option>
                            <option value="10">10月</option>
                            <option value="11">11月</option>
                            <option value="12">12月</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="filterType" onchange="applyFilters()">
                            <option value="">全部類型</option>
                            <option value="收入">收入</option>
                            <option value="支出">支出</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="filterKeyword" 
                               placeholder="搜尋姓名、描述或單據編號..." onkeyup="applyFilters()">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> 清除
                        </button>
                    </div>
                </div>

                <!-- 批次操作 -->
                <div id="batchActions" class="batch-actions">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>已選取 <span id="selectedCount">0</span> 筆記錄</span>
                        <div class="btn-group">
                            <button class="btn btn-light btn-sm" onclick="batchPrintReceipts()">
                                <i class="bi bi-printer"></i> 批次列印
                            </button>
                            <button class="btn btn-light btn-sm" onclick="batchSendEmails()">
                                <i class="bi bi-envelope"></i> 批次寄送
                            </button>
                            <button class="btn btn-light btn-sm" onclick="batchExport()">
                                <i class="bi bi-download"></i> 批次匯出
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 表格 -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="40">
                                    <input type="checkbox" class="form-check-input" id="selectAllTransactions" 
                                           onchange="selectAllTransactions()">
                                </th>
                                <th>日期</th>
                                <th>姓名</th>
                                <th>類型</th>
                                <th>分類</th>
                                <th>帳戶</th>
                                <th>金額</th>
                                <th>收據/憑證</th>
                                <th>狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody">
                            <tr>
                                <td colspan="11" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-1"></i><br>
                                    請先連接 Google 試算表以載入資料
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/編輯交易 Modal -->
    <div class="modal fade" id="transactionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transactionModalTitle">
                        <i class="bi bi-plus-circle"></i> 新增交易記錄
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="transactionForm" onsubmit="handleTransactionSubmit(event)">
                        <input type="hidden" id="transactionId">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="date" class="form-label">交易日期 <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3 position-relative">
                                    <label for="name" class="form-label">姓名 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="name" required 
                                           oninput="showNameSuggestions(this.value)" onblur="hideNameSuggestions()">
                                    <div id="nameSuggestions" class="name-suggestions"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="type" class="form-label">交易類型 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="type" required onchange="updateCategoryOptions(this.value)">
                                        <option value="">請選擇</option>
                                        <option value="收入">收入</option>
                                        <option value="支出">支出</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="category" class="form-label">分類 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="category" required>
                                        <option value="">請先選擇交易類型</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="account" class="form-label">帳戶 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="account" required>
                                        <option value="">請選擇</option>
                                        <option value="銀行帳戶">銀行帳戶</option>
                                        <option value="現金">現金</option>
                                        <option value="郵局帳戶">郵局帳戶</option>
                                        <option value="信用卡">信用卡</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="amount" class="form-label">金額 <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="amount" required min="1" step="1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="description" class="form-label">說明</label>
                                    <input type="text" class="form-control" id="description" placeholder="交易說明或備註">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="generateReceipt">
                                    <label class="form-check-label" for="generateReceipt">
                                        自動產生收據
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="sendEmail">
                                    <label class="form-check-label" for="sendEmail">
                                        自動寄送收據
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="saveDraft()">
                        <i class="bi bi-save"></i> 儲存草稿
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="loadDraft()">
                        <i class="bi bi-folder-open"></i> 載入草稿
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" form="transactionForm" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> 儲存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 收據預覽 Modal -->
    <div class="modal fade" id="receiptModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-receipt"></i> 收據預覽
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="receiptContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="printReceipt()">
                        <i class="bi bi-printer"></i> 列印
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="downloadReceipt()">
                        <i class="bi bi-download"></i> 下載 PDF
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="resendReceiptEmail()">
                        <i class="bi bi-envelope"></i> 重新寄送
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 憑證預覽 Modal -->
    <div class="modal fade" id="voucherModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-text"></i> 憑證預覽
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="voucherContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="printVoucher()">
                        <i class="bi bi-printer"></i> 列印
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="downloadVoucher()">
                        <i class="bi bi-download"></i> 下載 PDF
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="uploadVoucherAttachment()">
                        <i class="bi bi-paperclip"></i> 附件上傳
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 會員管理 Modal -->
    <div class="modal fade" id="memberModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-people"></i> 會員管理
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="memberSearch" 
                                       placeholder="搜尋會員姓名、電話或電子郵件..." onkeyup="searchMembers()">
                                <button class="btn btn-outline-secondary" onclick="searchMembers()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="memberFilter" id="filterAll" value="" checked onchange="loadMembers()">
                                <label class="btn btn-outline-primary" for="filterAll">全部</label>
                                
                                <input type="radio" class="btn-check" name="memberFilter" id="filterActive" value="active" onchange="loadMembers()">
                                <label class="btn btn-outline-success" for="filterActive">正常</label>
                                
                                <input type="radio" class="btn-check" name="memberFilter" id="filterInactive" value="inactive" onchange="loadMembers()">
                                <label class="btn btn-outline-danger" for="filterInactive">停權</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="showAddMemberForm()">
                                <i class="bi bi-person-plus"></i> 新增
                            </button>
                        </div>
                    </div>
                    
                    <div class="row" id="membersGrid">
                        <div class="col-12 text-center text-muted py-4">
                            <i class="bi bi-people fs-1"></i><br>
                            載入中...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 會員表單 Modal -->
    <div class="modal fade" id="memberFormModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="memberFormTitle">
                        <i class="bi bi-person-plus"></i> 新增會員
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="memberForm" onsubmit="handleMemberSubmit(event)">
                        <input type="hidden" id="memberId">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="memberName" class="form-label">姓名 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="memberName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="memberPhone" class="form-label">電話 <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="memberPhone" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="memberEmail" class="form-label">電子郵件</label>
                                    <input type="email" class="form-control" id="memberEmail">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="memberBirthday" class="form-label">生日</label>
                                    <input type="date" class="form-control" id="memberBirthday">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="memberType" class="form-label">會員類型 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="memberType" required>
                                        <option value="">請選擇</option>
                                        <option value="一般會員">一般會員</option>
                                        <option value="病友會員">病友會員</option>
                                        <option value="家屬會員">家屬會員</option>
                                        <option value="贊助會員">贊助會員</option>
                                        <option value="榮譽會員">榮譽會員</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="memberStatus" class="form-label">會員狀態</label>
                                    <select class="form-select" id="memberStatus">
                                        <option value="active">正常</option>
                                        <option value="inactive">停權</option>
                                        <option value="pending">待審核</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="memberJoinDate" class="form-label">入會日期</label>
                                    <input type="date" class="form-control" id="memberJoinDate">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="memberFeeStatus" class="form-label">會費狀態</label>
                                    <select class="form-select" id="memberFeeStatus">
                                        <option value="unpaid">未繳費</option>
                                        <option value="paid">已繳費</option>
                                        <option value="exempted">免繳</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="memberAddress" class="form-label">地址</label>
                                    <input type="text" class="form-control" id="memberAddress">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="memberNotes" class="form-label">備註</label>
                            <textarea class="form-control" id="memberNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" form="memberForm" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> 儲存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 憑證管理 Modal -->
    <div class="modal fade" id="voucherManagementModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-text"></i> 憑證管理
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>憑證編號</th>
                                    <th>申請日期</th>
                                    <th>申請人</th>
                                    <th>部門</th>
                                    <th>支出類別</th>
                                    <th>金額</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="voucherManagementBody">
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox fs-1"></i><br>
                                        沒有憑證記錄
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 檔案上傳 Modal -->
    <div class="modal fade" id="fileUploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-cloud-upload"></i> 檔案上傳
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="fileUploadArea" class="file-upload-area">
                        <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                        <p>點擊或拖拽檔案到此處上傳</p>
                        <p class="text-muted small">支援格式：PDF, JPG, PNG, DOC, DOCX<br>檔案大小限制：10MB</p>
                    </div>
                    <input type="file" id="fileInput" style="display: none;" 
                           accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                    
                    <div id="uploadProgress" class="progress mt-3" style="display: none;">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmFileUpload()">
                        <i class="bi bi-upload"></i> 確認上傳
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 設定 Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear"></i> 系統設定
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">組織資訊</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">組織名稱</label>
                                        <input type="text" class="form-control" id="orgName" 
                                               value="台灣帕金森病友權益促進會">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">統一編號</label>
                                        <input type="text" class="form-control" id="orgTaxId">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">地址</label>
                                        <textarea class="form-control" id="orgAddress" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">電話</label>
                                        <input type="tel" class="form-control" id="orgPhone">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">系統設定</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="autoSync" checked>
                                        <label class="form-check-label" for="autoSync">
                                            自動同步到 Google 試算表
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="autoBackup">
                                        <label class="form-check-label" for="autoBackup">
                                            每日自動備份
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="emailNotification">
                                        <label class="form-check-label" for="emailNotification">
                                            電子郵件通知
                                        </label>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">收據起始編號</label>
                                        <input type="number" class="form-control" id="receiptStartNumber" value="1">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">憑證起始編號</label>
                                        <input type="number" class="form-control" id="voucherStartNumber" value="1">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">
                        <i class="bi bi-check-circle"></i> 儲存設定
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 全域變數
        let currentData = {
            transactions: [],
            members: [],
            settings: {}
        };
        
        let sheetsConnected = false;
        let currentSpreadsheetId = '';
        let currentReceiptNumber = '';
        let currentVoucherNumber = '';
        let selectedTransactions = [];
        
        // Modal 實例
        let transactionModal, receiptModal, voucherModal, memberModal, memberFormModal, 
            voucherManagementModal, fileUploadModal, settingsModal;

        // Google Sheets API 設定
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        let gapi;
        let tokenClient;

        // 系統初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeModals();
            initializeGoogleAPI();
            initializeFileUpload();
            loadSettings();
            setDefaultDate();
            
            // 載入儲存的試算表連結
            const savedSheetsUrl = localStorage.getItem('sheetsUrl');
            if (savedSheetsUrl) {
                document.getElementById('sheetsUrl').value = savedSheetsUrl;
            }
        });

        function initializeModals() {
            transactionModal = new bootstrap.Modal(document.getElementById('transactionModal'));
            receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
            voucherModal = new bootstrap.Modal(document.getElementById('voucherModal'));
            memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
            memberFormModal = new bootstrap.Modal(document.getElementById('memberFormModal'));
            voucherManagementModal = new bootstrap.Modal(document.getElementById('voucherManagementModal'));
            fileUploadModal = new bootstrap.Modal(document.getElementById('fileUploadModal'));
            settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
        }

        // Google API 初始化
        async function initializeGoogleAPI() {
            try {
                await new Promise((resolve, reject) => {
                    gapi.load('client', {
                        callback: resolve,
                        onerror: reject
                    });
                });

                await gapi.client.init({
                    discoveryDocs: [DISCOVERY_DOC],
                });

                // 初始化 Google Identity Services
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: 'YOUR_GOOGLE_CLIENT_ID', // 需要替換為實際的 Client ID
                    scope: SCOPES,
                    callback: (tokenResponse) => {
                        console.log('Google API 授權成功');
                        updateSheetsStatus(true, '已連接到 Google 試算表');
                    },
                });

                console.log('Google API 初始化完成');
            } catch (error) {
                console.error('Google API 初始化失敗:', error);
                showAlert('error', 'Google API 初始化失敗', '請檢查網路連線或重新整理頁面');
            }
        }

        // 連接到 Google Sheets
        async function connectToSheets() {
            const sheetsUrl = document.getElementById('sheetsUrl').value.trim();
            
            if (!sheetsUrl) {
                showAlert('warning', '請輸入試算表網址', '請先輸入 Google 試算表的網址');
                return;
            }

            // 從網址中提取 Spreadsheet ID
            const match = sheetsUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            if (!match) {
                showAlert('error', '網址格式錯誤', '請輸入正確的 Google 試算表網址');
                return;
            }

            currentSpreadsheetId = match[1];
            showLoading();

            try {
                // 請求授權
                tokenClient.requestAccessToken();

                // 測試連接
                const response = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: currentSpreadsheetId
                });

                if (response.result) {
                    sheetsConnected = true;
                    localStorage.setItem('sheetsUrl', sheetsUrl);
                    localStorage.setItem('spreadsheetId', currentSpreadsheetId);
                    
                    updateSheetsStatus(true, '已成功連接到 Google 試算表');
                    
                    // 初始化工作表結構
                    await initializeSheetStructure();
                    
                    // 載入資料
                    await loadDataFromSheets();
                    
                    showAlert('success', '連接成功', '已成功連接到 Google 試算表並載入資料');
                }
            } catch (error) {
                console.error('連接失敗:', error);
                updateSheetsStatus(false, '連接失敗');
                showAlert('error', '連接失敗', '無法連接到指定的試算表，請檢查網址和權限設定');
            } finally {
                hideLoading();
            }
        }

        // 建立新的試算表
        async function createNewSheet() {
            showLoading();
            
            try {
                // 請求授權
                tokenClient.requestAccessToken();
                
                const response = await gapi.client.sheets.spreadsheets.create({
                    properties: {
                        title: '台灣帕金森病友權益促進會 - 會計系統'
                    },
                    sheets: [
                        {
                            properties: {
                                title: '交易記錄'
                            }
                        },
                        {
                            properties: {
                                title: '會員資料'
                            }
                        },
                        {
                            properties: {
                                title: '系統設定'
                            }
                        }
                    ]
                });

                if (response.result) {
                    currentSpreadsheetId = response.result.spreadsheetId;
                    const sheetsUrl = `https://docs.google.com/spreadsheets/d/${currentSpreadsheetId}/edit`;
                    
                    document.getElementById('sheetsUrl').value = sheetsUrl;
                    localStorage.setItem('sheetsUrl', sheetsUrl);
                    localStorage.setItem('spreadsheetId', currentSpreadsheetId);
                    
                    sheetsConnected = true;
                    updateSheetsStatus(true, '已建立新的試算表');
                    
                    // 初始化工作表結構
                    await initializeSheetStructure();
                    
                    showAlert('success', '建立成功', '已建立新的試算表並完成初始化');
                }
            } catch (error) {
                console.error('建立失敗:', error);
                showAlert('error', '建立失敗', '無法建立新的試算表，請檢查權限設定');
            } finally {
                hideLoading();
            }
        }

        // 初始化工作表結構
        async function initializeSheetStructure() {
            try {
                const requests = [];
                
                // 設定交易記錄工作表標題
                requests.push({
                    updateCells: {
                        range: {
                            sheetId: 0,
                            startRowIndex: 0,
                            endRowIndex: 1,
                            startColumnIndex: 0,
                            endColumnIndex: 11
                        },
                        rows: [{
                            values: [
                                { userEnteredValue: { stringValue: '日期' } },
                                { userEnteredValue: { stringValue: '姓名' } },
                                { userEnteredValue: { stringValue: '類型' } },
                                { userEnteredValue: { stringValue: '分類' } },
                                { userEnteredValue: { stringValue: '帳戶' } },
                                { userEnteredValue: { stringValue: '金額' } },
                                { userEnteredValue: { stringValue: '說明' } },
                                { userEnteredValue: { stringValue: '收據編號' } },
                                { userEnteredValue: { stringValue: '憑證編號' } },
                                { userEnteredValue: { stringValue: '狀態' } },
                                { userEnteredValue: { stringValue: '建立時間' } }
                            ]
                        }],
                        fields: 'userEnteredValue'
                    }
                });

                // 設定會員資料工作表標題
                requests.push({
                    updateCells: {
                        range: {
                            sheetId: 1,
                            startRowIndex: 0,
                            endRowIndex: 1,
                            startColumnIndex: 0,
                            endColumnIndex: 10
                        },
                        rows: [{
                            values: [
                                { userEnteredValue: { stringValue: '姓名' } },
                                { userEnteredValue: { stringValue: '電話' } },
                                { userEnteredValue: { stringValue: '電子郵件' } },
                                { userEnteredValue: { stringValue: '生日' } },
                                { userEnteredValue: { stringValue: '會員類型' } },
                                { userEnteredValue: { stringValue: '會員狀態' } },
                                { userEnteredValue: { stringValue: '入會日期' } },
                                { userEnteredValue: { stringValue: '會費狀態' } },
                                { userEnteredValue: { stringValue: '地址' } },
                                { userEnteredValue: { stringValue: '備註' } }
                            ]
                        }],
                        fields: 'userEnteredValue'
                    }
                });

                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: currentSpreadsheetId,
                    requests: requests
                });

                console.log('工作表結構初始化完成');
            } catch (error) {
                console.error('初始化工作表結構失敗:', error);
            }
        }

        // 從 Google Sheets 載入資料
        async function loadDataFromSheets() {
            try {
                // 載入交易記錄
                const transactionResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: currentSpreadsheetId,
                    range: '交易記錄!A2:K'
                });

                if (transactionResponse.result.values) {
                    currentData.transactions = transactionResponse.result.values.map((row, index) => ({
                        id: index + 1,
                        date: row[0] || '',
                        name: row[1] || '',
                        type: row[2] || '',
                        category: row[3] || '',
                        account: row[4] || '',
                        amount: parseInt(row[5]) || 0,
                        description: row[6] || '',
                        receiptNumber: row[7] || '',
                        voucherNumber: row[8] || '',
                        status: row[9] || '已記錄',
                        createdAt: row[10] || new Date().toISOString()
                    }));
                }

                // 載入會員資料
                const memberResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: currentSpreadsheetId,
                    range: '會員資料!A2:J'
                });

                if (memberResponse.result.values) {
                    currentData.members = memberResponse.result.values.map((row, index) => ({
                        id: index + 1,
                        name: row[0] || '',
                        phone: row[1] || '',
                        email: row[2] || '',
                        birthday: row[3] || '',
                        type: row[4] || '',
                        status: row[5] || 'active',
                        joinDate: row[6] || '',
                        feeStatus: row[7] || 'unpaid',
                        address: row[8] || '',
                        notes: row[9] || ''
                    }));
                }

                // 更新介面
                loadTransactions();
                updateSummary();
                updateYearFilter();
                
                console.log('資料載入完成');
            } catch (error) {
                console.error('載入資料失敗:', error);
                showAlert('error', '載入失敗', '無法從試算表載入資料');
            }
        }

        // 儲存資料到 Google Sheets
        async function saveToSheets(sheetName, data) {
            if (!sheetsConnected) {
                showAlert('warning', '未連接試算表', '請先連接到 Google 試算表');
                return false;
            }

            try {
                let values = [];
                
                if (sheetName === '交易記錄') {
                    values = data.map(item => [
                        item.date,
                        item.name,
                        item.type,
                        item.category,
                        item.account,
                        item.amount,
                        item.description,
                        item.receiptNumber,
                        item.voucherNumber,
                        item.status,
                        item.createdAt
                    ]);
                } else if (sheetName === '會員資料') {
                    values = data.map(item => [
                        item.name,
                        item.phone,
                        item.email,
                        item.birthday,
                        item.type,
                        item.status,
                        item.joinDate,
                        item.feeStatus,
                        item.address,
                        item.notes
                    ]);
                }

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: currentSpreadsheetId,
                    range: `${sheetName}!A2:Z`,
                    valueInputOption: 'USER_ENTERED',
                    values: values
                });

                return true;
            } catch (error) {
                console.error('儲存失敗:', error);
                showAlert('error', '儲存失敗', '無法將資料儲存到試算表');
                return false;
            }
        }

        // 手動同步
        async function syncWithSheets() {
            if (!sheetsConnected) {
                showAlert('warning', '未連接試算表', '請先連接到 Google 試算表');
                return;
            }

            showLoading();
            
            try {
                await loadDataFromSheets();
                showAlert('success', '同步完成', '已成功同步資料');
            } catch (error) {
                showAlert('error', '同步失敗', '無法同步資料，請檢查網路連線');
            } finally {
                hideLoading();
            }
        }

        // 更新試算表連線狀態
        function updateSheetsStatus(connected, message) {
            const statusElement = document.getElementById('sheetsStatus');
            
            if (connected) {
                statusElement.className = 'alert sheets-status sheets-connected';
                statusElement.innerHTML = `
                    <span class="sync-indicator"></span>
                    <strong>Google 試算表</strong><br>
                    ${message}
                `;
            } else {
                statusElement.className = 'alert sheets-status sheets-disconnected';
                statusElement.innerHTML = `
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>未連接</strong><br>
                    ${message}
                `;
            }
            
            statusElement.style.display = 'block';
            
            // 3秒後自動隱藏
            setTimeout(() => {
                if (connected) {
                    statusElement.style.display = 'none';
                }
            }, 3000);
        }

        // 設定預設日期
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        // 載入交易記錄
        function loadTransactions() {
            const tbody = document.getElementById('transactionTableBody');
            
            if (currentData.transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1"></i><br>
                            尚無交易記錄
                        </td>
                    </tr>
                `;
                return;
            }

            const filteredTransactions = getFilteredTransactions();
            
            tbody.innerHTML = filteredTransactions.map(transaction => `
                <tr>
                    <td>
                        <input type="checkbox" class="form-check-input transaction-checkbox" 
                               value="${transaction.receiptNumber || transaction.voucherNumber || transaction.id}"
                               onchange="toggleTransactionSelection(this.value)">
                    </td>
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.name}</td>
                    <td>
                        <span class="badge ${transaction.type === '收入' ? 'bg-success' : 'bg-danger'}">
                            ${transaction.type}
                        </span>
                    </td>
                    <td>${transaction.category}</td>
                    <td>${transaction.account}</td>
                    <td class="${transaction.type === '收入' ? 'amount-positive' : 'amount-negative'}">
                        ${formatCurrency(transaction.amount)}
                    </td>
                    <td>
                        ${transaction.receiptNumber ? 
                            `<button class="receipt-number-btn" onclick="showReceiptPreview('${transaction.receiptNumber}')">${transaction.receiptNumber}</button>` : 
                            ''}
                        ${transaction.voucherNumber ? 
                            `<button class="voucher-number-btn" onclick="showVoucherPreview('${transaction.voucherNumber}')">${transaction.voucherNumber}</button>` : 
                            ''}
                    </td>
                    <td>
                        <span class="status-badge ${getStatusClass(transaction.status)}">
                            ${transaction.status}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editTransaction(${transaction.id})" title="編輯">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteTransaction(${transaction.id})" title="刪除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // 取得篩選後的交易記錄
        function getFilteredTransactions() {
            let filtered = [...currentData.transactions];
            
            const filterYear = document.getElementById('filterYear').value;
            const filterMonth = document.getElementById('filterMonth').value;
            const filterType = document.getElementById('filterType').value;
            const filterKeyword = document.getElementById('filterKeyword').value.toLowerCase();

            if (filterYear) {
                filtered = filtered.filter(t => new Date(t.date).getFullYear().toString() === filterYear);
            }

            if (filterMonth) {
                filtered = filtered.filter(t => (new Date(t.date).getMonth() + 1).toString() === filterMonth);
            }

            if (filterType) {
                filtered = filtered.filter(t => t.type === filterType);
            }

            if (filterKeyword) {
                filtered = filtered.filter(t => 
                    t.name.toLowerCase().includes(filterKeyword) ||
                    t.description.toLowerCase().includes(filterKeyword) ||
                    (t.receiptNumber && t.receiptNumber.toLowerCase().includes(filterKeyword)) ||
                    (t.voucherNumber && t.voucherNumber.toLowerCase().includes(filterKeyword))
                );
            }

            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // 套用篩選器
        function applyFilters() {
            loadTransactions();
            updateSummary();
        }

        // 清除篩選器
        function clearFilters() {
            document.getElementById('filterYear').value = '';
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterKeyword').value = '';
            applyFilters();
        }

        // 更新年份篩選器
        function updateYearFilter() {
            const filterYear = document.getElementById('filterYear');
            const years = [...new Set(currentData.transactions.map(t => new Date(t.date).getFullYear()))].sort((a, b) => b - a);
            
            filterYear.innerHTML = '<option value="">全部年份</option>';
            years.forEach(year => {
                filterYear.innerHTML += `<option value="${year}">${year}</option>`;
            });
        }

        // 更新財務摘要
        function updateSummary() {
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            
            const monthlyTransactions = currentData.transactions.filter(t => {
                const date = new Date(t.date);
                return date.getMonth() + 1 === currentMonth && date.getFullYear() === currentYear;
            });

            const totalIncome = monthlyTransactions
                .filter(t => t.type === '收入')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalExpense = monthlyTransactions
                .filter(t => t.type === '支出')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalAsset = totalIncome - totalExpense;

            // 更新主要摘要
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
            document.getElementById('totalAsset').textContent = formatCurrency(totalAsset);
            document.getElementById('monthlyTransactions').textContent = monthlyTransactions.length;

            // 更新收入明細
            const incomeEntry = monthlyTransactions.filter(t => t.type === '收入' && t.category === '入會費').reduce((sum, t) => sum + t.amount, 0);
            const incomeAnnual = monthlyTransactions.filter(t => t.type === '收入' && t.category === '常年會費').reduce((sum, t) => sum + t.amount, 0);
            const incomeDonation = monthlyTransactions.filter(t => t.type === '收入' && t.category === '捐款').reduce((sum, t) => sum + t.amount, 0);
            const incomeOther = monthlyTransactions.filter(t => t.type === '收入' && !['入會費', '常年會費', '捐款'].includes(t.category)).reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('income-entry').textContent = formatCurrency(incomeEntry);
            document.getElementById('income-annual').textContent = formatCurrency(incomeAnnual);
            document.getElementById('income-donation').textContent = formatCurrency(incomeDonation);
            document.getElementById('income-other').textContent = formatCurrency(incomeOther);

            // 更新支出明細
            const expenseActivity = monthlyTransactions.filter(t => t.type === '支出' && t.category === '活動支出').reduce((sum, t) => sum + t.amount, 0);
            const expenseAdmin = monthlyTransactions.filter(t => t.type === '支出' && t.category === '行政支出').reduce((sum, t) => sum + t.amount, 0);
            const expenseOther = monthlyTransactions.filter(t => t.type === '支出' && !['活動支出', '行政支出'].includes(t.category)).reduce((sum, t) => sum + t.amount, 0);
            const vouchersPending = currentData.transactions.filter(t => t.status === '憑證待核准').length;

            document.getElementById('expense-activity').textContent = formatCurrency(expenseActivity);
            document.getElementById('expense-admin').textContent = formatCurrency(expenseAdmin);
            document.getElementById('expense-other').textContent = formatCurrency(expenseOther);
            document.getElementById('vouchers-pending').textContent = vouchersPending;
        }

        // 顯示交易表單
        function showTransactionForm(transactionId = null) {
            const modal = document.getElementById('transactionModal');
            const title = document.getElementById('transactionModalTitle');
            const form = document.getElementById('transactionForm');
            
            if (transactionId) {
                const transaction = currentData.transactions.find(t => t.id === transactionId);
                if (transaction) {
                    title.innerHTML = '<i class="bi bi-pencil"></i> 編輯交易記錄';
                    
                    document.getElementById('transactionId').value = transaction.id;
                    document.getElementById('date').value = transaction.date;
                    document.getElementById('name').value = transaction.name;
                    document.getElementById('type').value = transaction.type;
                    updateCategoryOptions(transaction.type);
                    document.getElementById('category').value = transaction.category;
                    document.getElementById('account').value = transaction.account;
                    document.getElementById('amount').value = transaction.amount;
                    document.getElementById('description').value = transaction.description;
                }
            } else {
                title.innerHTML = '<i class="bi bi-plus-circle"></i> 新增交易記錄';
                form.reset();
                setDefaultDate();
                document.getElementById('transactionId').value = '';
            }
            
            transactionModal.show();
        }

        // 更新分類選項
        function updateCategoryOptions(type) {
            const categorySelect = document.getElementById('category');
            
            if (type === '收入') {
                categorySelect.innerHTML = `
                    <option value="">請選擇分類</option>
                    <option value="入會費">入會費</option>
                    <option value="常年會費">常年會費</option>
                    <option value="捐款">捐款</option>
                    <option value="活動收入">活動收入</option>
                    <option value="其他收入">其他收入</option>
                `;
            } else if (type === '支出') {
                categorySelect.innerHTML = `
                    <option value="">請選擇分類</option>
                    <option value="活動支出">活動支出</option>
                    <option value="行政支出">行政支出</option>
                    <option value="設備支出">設備支出</option>
                    <option value="其他支出">其他支出</option>
                `;
            } else {
                categorySelect.innerHTML = '<option value="">請先選擇交易類型</option>';
            }
        }

        // 處理交易表單提交
        async function handleTransactionSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const transactionId = document.getElementById('transactionId').value;
            
            const transaction = {
                date: document.getElementById('date').value,
                name: document.getElementById('name').value,
                type: document.getElementById('type').value,
                category: document.getElementById('category').value,
                account: document.getElementById('account').value,
                amount: parseInt(document.getElementById('amount').value),
                description: document.getElementById('description').value,
                status: '已記錄',
                createdAt: new Date().toISOString()
            };

            // 產生收據或憑證編號
            if (document.getElementById('generateReceipt').checked) {
                if (transaction.type === '收入') {
                    transaction.receiptNumber = generateReceiptNumber();
                    transaction.status = '收據已開立';
                } else {
                    transaction.voucherNumber = generateVoucherNumber();
                    transaction.status = '憑證待核准';
                }
            }

            showLoading();

            try {
                if (transactionId) {
                    // 編輯現有交易
                    const index = currentData.transactions.findIndex(t => t.id == transactionId);
                    if (index !== -1) {
                        transaction.id = parseInt(transactionId);
                        currentData.transactions[index] = transaction;
                    }
                } else {
                    // 新增交易
                    transaction.id = currentData.transactions.length + 1;
                    currentData.transactions.push(transaction);
                }

                // 儲存到 Google Sheets
                const saved = await saveToSheets('交易記錄', currentData.transactions);
                
                if (saved) {
                    transactionModal.hide();
                    loadTransactions();
                    updateSummary();
                    updateYearFilter();
                    clearDraft();
                    
                    // 如果需要寄送收據
                    if (document.getElementById('sendEmail').checked && transaction.receiptNumber) {
                        await sendReceiptEmail(transaction.receiptNumber);
                    }
                    
                    showAlert('success', '儲存成功', '交易記錄已成功儲存');
                }
            } catch (error) {
                console.error('儲存失敗:', error);
                showAlert('error', '儲存失敗', '無法儲存交易記錄');
            } finally {
                hideLoading();
            }
        }

        // 編輯交易
        function editTransaction(id) {
            showTransactionForm(id);
        }

        // 刪除交易
        async function deleteTransaction(id) {
            const result = await Swal.fire({
                title: '確認刪除',
                text: '確定要刪除這筆交易記錄嗎？',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '刪除',
                cancelButtonText: '取消',
                confirmButtonColor: '#dc3545'
            });

            if (result.isConfirmed) {
                showLoading();
                
                try {
                    currentData.transactions = currentData.transactions.filter(t => t.id !== id);
                    
                    const saved = await saveToSheets('交易記錄', currentData.transactions);
                    
                    if (saved) {
                        loadTransactions();
                        updateSummary();
                        showAlert('success', '刪除成功', '交易記錄已刪除');
                    }
                } catch (error) {
                    showAlert('error', '刪除失敗', '無法刪除交易記錄');
                } finally {
                    hideLoading();
                }
            }
        }

        // 產生收據編號
        function generateReceiptNumber() {
            const year = new Date().getFullYear();
            const month = String(new Date().getMonth() + 1).padStart(2, '0');
            const existingReceipts = currentData.transactions.filter(t => 
                t.receiptNumber && t.receiptNumber.startsWith(`${year}${month}`)
            );
            const nextNumber = String(existingReceipts.length + 1).padStart(4, '0');
            return `${year}${month}${nextNumber}`;
        }

        // 產生憑證編號
        function generateVoucherNumber() {
            const year = new Date().getFullYear();
            const month = String(new Date().getMonth() + 1).padStart(2, '0');
            const existingVouchers = currentData.transactions.filter(t => 
                t.voucherNumber && t.voucherNumber.startsWith(`V${year}${month}`)
            );
            const nextNumber = String(existingVouchers.length + 1).padStart(4, '0');
            return `V${year}${month}${nextNumber}`;
        }

        // 顯示收據預覽
        function showReceiptPreview(receiptNumber) {
            const transaction = currentData.transactions.find(t => t.receiptNumber === receiptNumber);
            if (!transaction) return;

            currentReceiptNumber = receiptNumber;
            
            const receiptContent = document.getElementById('receiptContent');
            receiptContent.innerHTML = generateReceiptHTML(transaction);
            
            receiptModal.show();
        }

        // 產生收據 HTML
        function generateReceiptHTML(transaction) {
            const amountInWords = numberToChineseWords(transaction.amount);
            
            return `
                <div class="receipt-preview">
                    <div class="receipt-header">
                        <div class="receipt-title">台灣帕金森病友權益促進會</div>
                        <div class="receipt-subtitle">Taiwan Parkinson Association</div>
                        <div class="receipt-type">收據</div>
                    </div>
                    
                    <table class="receipt-table">
                        <tr>
                            <td class="receipt-table-label">收據編號</td>
                            <td>${transaction.receiptNumber}</td>
                            <td class="receipt-table-label">開立日期</td>
                            <td>${formatDate(transaction.date)}</td>
                        </tr>
                        <tr>
                            <td class="receipt-table-label">收款人</td>
                            <td colspan="3">台灣帕金森病友權益促進會</td>
                        </tr>
                        <tr>
                            <td class="receipt-table-label">付款人</td>
                            <td>${transaction.name}</td>
                            <td class="receipt-table-label">項目</td>
                            <td>${transaction.category}</td>
                        </tr>
                        <tr>
                            <td class="receipt-table-label">說明</td>
                            <td colspan="3">${transaction.description || transaction.category}</td>
                        </tr>
                    </table>
                    
                    <div class="receipt-amount">
                        <div class="receipt-amount-number">金額：${formatCurrency(transaction.amount)}</div>
                        <div class="receipt-amount-words">大寫：${amountInWords}</div>
                    </div>
                    
                    <div class="receipt-footer">
                        <div class="receipt-stamps">
                            <div class="receipt-stamp">理事長</div>
                            <div class="receipt-stamp">會計</div>
                            <div class="receipt-stamp">出納</div>
                        </div>
                        <div class="receipt-org-info">
                            台灣帕金森病友權益促進會<br>
                            統一編號：${currentData.settings.taxId || ''}<br>
                            地址：${currentData.settings.address || ''}<br>
                            電話：${currentData.settings.phone || ''}
                        </div>
                    </div>
                    
                    <div class="receipt-legal">
                        本收據為合法憑證，請妥善保存。如有疑問請洽本會。
                    </div>
                </div>
            `;
        }

        // 顯示憑證預覽
        function showVoucherPreview(voucherNumber) {
            const transaction = currentData.transactions.find(t => t.voucherNumber === voucherNumber);
            if (!transaction) return;

            currentVoucherNumber = voucherNumber;
            
            const voucherContent = document.getElementById('voucherContent');
            voucherContent.innerHTML = generateVoucherHTML(transaction);
            
            voucherModal.show();
        }

        // 產生憑證 HTML
        function generateVoucherHTML(transaction) {
            return `
                <div class="voucher-preview">
                    <div class="receipt-header">
                        <div class="receipt-title">台灣帕金森病友權益促進會</div>
                        <div class="receipt-subtitle">Taiwan Parkinson Association</div>
                        <div class="receipt-type">支出憑證申請單</div>
                    </div>
                    
                    <table class="voucher-form-table">
                        <tr>
                            <th>憑證編號</th>
                            <td>${transaction.voucherNumber}</td>
                            <th>申請日期</th>
                            <td>${formatDate(transaction.date)}</td>
                        </tr>
                        <tr>
                            <th>申請人</th>
                            <td>${transaction.name}</td>
                            <th>部門</th>
                            <td>一般事務</td>
                        </tr>
                        <tr>
                            <th>支出類別</th>
                            <td>${transaction.category}</td>
                            <th>金額</th>
                            <td class="text-danger fw-bold">${formatCurrency(transaction.amount)}</td>
                        </tr>
                        <tr>
                            <th>用途說明</th>
                            <td colspan="3">${transaction.description || transaction.category}</td>
                        </tr>
                        <tr>
                            <th>帳戶</th>
                            <td>${transaction.account}</td>
                            <th>狀態</th>
                            <td>
                                <span class="status-badge ${getStatusClass(transaction.status)}">
                                    ${transaction.status}
                                </span>
                            </td>
                        </tr>
                    </table>
                    
                    <div class="voucher-receipt-section">
                        <h6><i class="bi bi-paperclip"></i> 附件收據/發票</h6>
                        <div class="voucher-receipt-grid">
                            <div class="voucher-receipt-box">收據/發票 1</div>
                            <div class="voucher-receipt-box">收據/發票 2</div>
                            <div class="voucher-receipt-box">其他附件 1</div>
                            <div class="voucher-receipt-box">其他附件 2</div>
                        </div>
                        <p class="text-muted small">請將相關收據、發票或證明文件貼附於上方</p>
                    </div>
                    
                    <div class="voucher-signature-section">
                        <h6><i class="bi bi-pen"></i> 簽核流程</h6>
                        <table class="voucher-signature-table">
                            <tr>
                                <td>
                                    <strong>申請人</strong><br><br>
                                    簽名：<br><br>
                                    日期：${formatDate(transaction.date)}
                                </td>
                                <td>
                                    <strong>會計</strong><br><br>
                                    簽名：<br><br>
                                    日期：
                                </td>
                                <td>
                                    <strong>出納</strong><br><br>
                                    簽名：<br><br>
                                    日期：
                                </td>
                                <td>
                                    <strong>理事長</strong><br><br>
                                    簽名：<br><br>
                                    日期：
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;
        }

        // 列印收據
        function printReceipt() {
            const printContent = document.getElementById('receiptContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>收據 - ${currentReceiptNumber}</title>
                        <style>
                            body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 0; padding: 20px; }
                            .receipt-preview { max-width: 800px; margin: 0 auto; }
                            .receipt-header { text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #333; padding-bottom: 1rem; }
                            .receipt-title { font-size: 1.8rem; font-weight: bold; margin-bottom: 0.5rem; }
                            .receipt-subtitle { font-size: 1rem; color: #666; margin-bottom: 1rem; }
                            .receipt-type { font-size: 1.5rem; font-weight: bold; color: #2c5aa0; }
                            .receipt-table { width: 100%; border-collapse: collapse; margin: 2rem 0; }
                            .receipt-table td { padding: 0.75rem; border: 1px solid #ddd; }
                            .receipt-table-label { background: #f8f9fa; font-weight: bold; width: 120px; }
                            .receipt-amount { text-align: center; margin: 2rem 0; padding: 1rem; background: #f8f9fa; border-radius: 10px; }
                            .receipt-amount-number { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; }
                            .receipt-amount-words { font-size: 1.1rem; color: #666; }
                            .receipt-footer { margin-top: 3rem; display: flex; justify-content: space-between; align-items: flex-end; }
                            .receipt-stamps { display: flex; gap: 2rem; }
                            .receipt-stamp { width: 80px; height: 80px; border: 2px solid #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
                            .receipt-org-info { text-align: right; font-size: 0.9rem; line-height: 1.6; }
                            .receipt-legal { text-align: center; font-size: 0.8rem; color: #666; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ddd; }
                            @media print { body { margin: 0; } }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // 下載收據 PDF
        function downloadReceipt() {
            const element = document.getElementById('receiptContent');
            const opt = {
                margin: 1,
                filename: `收據_${currentReceiptNumber}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        // 列印憑證
        function printVoucher() {
            const printContent = document.getElementById('voucherContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>憑證 - ${currentVoucherNumber}</title>
                        <style>
                            body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 0; padding: 20px; }
                            .voucher-preview { max-width: 800px; margin: 0 auto; }
                            .receipt-header { text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #333; padding-bottom: 1rem; }
                            .receipt-title { font-size: 1.8rem; font-weight: bold; margin-bottom: 0.5rem; }
                            .receipt-subtitle { font-size: 1rem; color: #666; margin-bottom: 1rem; }
                            .receipt-type { font-size: 1.5rem; font-weight: bold; color: #2c5aa0; }
                            .voucher-form-table { width: 100%; border-collapse: collapse; margin: 2rem 0; }
                            .voucher-form-table th, .voucher-form-table td { padding: 0.75rem; border: 1px solid #333; text-align: left; }
                            .voucher-form-table th { background: #f8f9fa; font-weight: bold; width: 120px; }
                            .voucher-receipt-section { margin: 2rem 0; padding: 1rem; border: 2px dashed #ddd; border-radius: 10px; }
                            .voucher-receipt-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin: 1rem 0; }
                            .voucher-receipt-box { height: 100px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; color: #999; font-size: 0.9rem; }
                            .voucher-signature-section { margin: 2rem 0; }
                            .voucher-signature-table { width: 100%; border-collapse: collapse; }
                            .voucher-signature-table td { padding: 2rem 1rem; border: 1px solid #333; text-align: center; width: 25%; }
                            @media print { body { margin: 0; } }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // 下載憑證 PDF
        function downloadVoucher() {
            const element = document.getElementById('voucherContent');
            const opt = {
                margin: 1,
                filename: `憑證_${currentVoucherNumber}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        // 會員管理
        function showMemberManagement() {
            loadMembers();
            memberModal.show();
        }

        // 載入會員資料
        function loadMembers() {
            const membersGrid = document.getElementById('membersGrid');
            const filterValue = document.querySelector('input[name="memberFilter"]:checked').value;
            
            let filteredMembers = currentData.members;
            if (filterValue) {
                filteredMembers = currentData.members.filter(m => m.status === filterValue);
            }

            if (filteredMembers.length === 0) {
                membersGrid.innerHTML = `
                    <div class="col-12 text-center text-muted py-4">
                        <i class="bi bi-people fs-1"></i><br>
                        沒有符合條件的會員
                    </div>
                `;
                return;
            }

            membersGrid.innerHTML = filteredMembers.map(member => `
                <div class="col-md-4 mb-3">
                    <div class="card member-card" onclick="showMemberDetails(${member.id})">
                        <div class="card-body position-relative">
                            <div class="member-status member-${member.status}">
                                ${member.status === 'active' ? '正常' : member.status === 'inactive' ? '停權' : '待審核'}
                            </div>
                            <h6 class="card-title">${member.name}</h6>
                            <p class="card-text">
                                <small class="text-muted">
                                    <i class="bi bi-phone"></i> ${member.phone}<br>
                                    <i class="bi bi-envelope"></i> ${member.email || '未提供'}<br>
                                    <i class="bi bi-person-badge"></i> ${member.type}
                                </small>
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    入會：${formatDate(member.joinDate)}
                                </small>
                                <span class="badge ${member.feeStatus === 'paid' ? 'bg-success' : member.feeStatus === 'exempted' ? 'bg-info' : 'bg-warning'}">
                                    ${member.feeStatus === 'paid' ? '已繳費' : member.feeStatus === 'exempted' ? '免繳' : '未繳費'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 搜尋會員
        function searchMembers() {
            const keyword = document.getElementById('memberSearch').value.toLowerCase();
            const membersGrid = document.getElementById('membersGrid');
            
            if (!keyword) {
                loadMembers();
                return;
            }

            const filteredMembers = currentData.members.filter(m => 
                m.name.toLowerCase().includes(keyword) ||
                m.phone.includes(keyword) ||
                (m.email && m.email.toLowerCase().includes(keyword))
            );

            if (filteredMembers.length === 0) {
                membersGrid.innerHTML = `
                    <div class="col-12 text-center text-muted py-4">
                        <i class="bi bi-search fs-1"></i><br>
                        找不到符合條件的會員
                    </div>
                `;
                return;
            }

            membersGrid.innerHTML = filteredMembers.map(member => `
                <div class="col-md-4 mb-3">
                    <div class="card member-card" onclick="showMemberDetails(${member.id})">
                        <div class="card-body position-relative">
                            <div class="member-status member-${member.status}">
                                ${member.status === 'active' ? '正常' : member.status === 'inactive' ? '停權' : '待審核'}
                            </div>
                            <h6 class="card-title">${member.name}</h6>
                            <p class="card-text">
                                <small class="text-muted">
                                    <i class="bi bi-phone"></i> ${member.phone}<br>
                                    <i class="bi bi-envelope"></i> ${member.email || '未提供'}<br>
                                    <i class="bi bi-person-badge"></i> ${member.type}
                                </small>
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    入會：${formatDate(member.joinDate)}
                                </small>
                                <span class="badge ${member.feeStatus === 'paid' ? 'bg-success' : member.feeStatus === 'exempted' ? 'bg-info' : 'bg-warning'}">
                                    ${member.feeStatus === 'paid' ? '已繳費' : member.feeStatus === 'exempted' ? '免繳' : '未繳費'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 顯示新增會員表單
        function showAddMemberForm() {
            const form = document.getElementById('memberForm');
            const title = document.getElementById('memberFormTitle');
            
            title.innerHTML = '<i class="bi bi-person-plus"></i> 新增會員';
            form.reset();
            document.getElementById('memberId').value = '';
            document.getElementById('memberStatus').value = 'active';
            document.getElementById('memberJoinDate').value = new Date().toISOString().split('T')[0];
            
            memberFormModal.show();
        }

        // 顯示會員詳細資料
        function showMemberDetails(memberId) {
            const member = currentData.members.find(m => m.id === memberId);
            if (!member) return;

            const form = document.getElementById('memberForm');
            const title = document.getElementById('memberFormTitle');
            
            title.innerHTML = '<i class="bi bi-person"></i> 編輯會員資料';
            
            document.getElementById('memberId').value = member.id;
            document.getElementById('memberName').value = member.name;
            document.getElementById('memberPhone').value = member.phone;
            document.getElementById('memberEmail').value = member.email;
            document.getElementById('memberBirthday').value = member.birthday;
            document.getElementById('memberType').value = member.type;
            document.getElementById('memberStatus').value = member.status;
            document.getElementById('memberJoinDate').value = member.joinDate;
            document.getElementById('memberFeeStatus').value = member.feeStatus;
            document.getElementById('memberAddress').value = member.address;
            document.getElementById('memberNotes').value = member.notes;
            
            memberFormModal.show();
        }

        // 處理會員表單提交
        async function handleMemberSubmit(event) {
            event.preventDefault();
            
            const memberId = document.getElementById('memberId').value;
            
            const member = {
                name: document.getElementById('memberName').value,
                phone: document.getElementById('memberPhone').value,
                email: document.getElementById('memberEmail').value,
                birthday: document.getElementById('memberBirthday').value,
                type: document.getElementById('memberType').value,
                status: document.getElementById('memberStatus').value,
                joinDate: document.getElementById('memberJoinDate').value,
                feeStatus: document.getElementById('memberFeeStatus').value,
                address: document.getElementById('memberAddress').value,
                notes: document.getElementById('memberNotes').value
            };

            showLoading();

            try {
                if (memberId) {
                    // 編輯現有會員
                    const index = currentData.members.findIndex(m => m.id == memberId);
                    if (index !== -1) {
                        member.id = parseInt(memberId);
                        currentData.members[index] = member;
                    }
                } else {
                    // 新增會員
                    member.id = currentData.members.length + 1;
                    currentData.members.push(member);
                }

                // 儲存到 Google Sheets
                const saved = await saveToSheets('會員資料', currentData.members);
                
                if (saved) {
                    memberFormModal.hide();
                    loadMembers();
                    showAlert('success', '儲存成功', '會員資料已成功儲存');
                }
            } catch (error) {
                console.error('儲存失敗:', error);
                showAlert('error', '儲存失敗', '無法儲存會員資料');
            } finally {
                hideLoading();
            }
        }

        // 憑證管理
        function showVoucherManagement() {
            loadVoucherManagement();
            voucherManagementModal.show();
        }

        // 載入憑證管理資料
        function loadVoucherManagement() {
            const tbody = document.getElementById('voucherManagementBody');
            const vouchers = currentData.transactions.filter(t => t.voucherNumber);
            
            if (vouchers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1"></i><br>
                            沒有憑證記錄
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = vouchers.map(voucher => `
                <tr>
                    <td>
                        <button class="voucher-number-btn" onclick="showVoucherPreview('${voucher.voucherNumber}')">
                            ${voucher.voucherNumber}
                        </button>
                    </td>
                    <td>${formatDate(voucher.date)}</td>
                    <td>${voucher.name}</td>
                    <td>一般事務</td>
                    <td>${voucher.category}</td>
                    <td class="amount-negative">${formatCurrency(voucher.amount)}</td>
                    <td>
                        <span class="status-badge ${getStatusClass(voucher.status)}">
                            ${voucher.status}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success" onclick="approveVoucher('${voucher.voucherNumber}')" title="核准">
                                <i class="bi bi-check-circle"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="rejectVoucher('${voucher.voucherNumber}')" title="駁回">
                                <i class="bi bi-x-circle"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="showVoucherPreview('${voucher.voucherNumber}')" title="檢視">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // 核准憑證
        async function approveVoucher(voucherNumber) {
            const result = await Swal.fire({
                title: '確認核准',
                text: `確定要核准憑證 ${voucherNumber} 嗎？`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '核准',
                cancelButtonText: '取消',
                confirmButtonColor: '#28a745'
            });

            if (result.isConfirmed) {
                showLoading();
                
                try {
                    const transaction = currentData.transactions.find(t => t.voucherNumber === voucherNumber);
                    if (transaction) {
                        transaction.status = '憑證已核准';
                        
                        const saved = await saveToSheets('交易記錄', currentData.transactions);
                        
                        if (saved) {
                            loadVoucherManagement();
                            loadTransactions();
                            updateSummary();
                            showAlert('success', '核准成功', '憑證已核准');
                        }
                    }
                } catch (error) {
                    showAlert('error', '核准失敗', '無法核准憑證');
                } finally {
                    hideLoading();
                }
            }
        }

        // 駁回憑證
        async function rejectVoucher(voucherNumber) {
            const { value: reason } = await Swal.fire({
                title: '駁回憑證',
                input: 'textarea',
                inputLabel: '請輸入駁回原因',
                inputPlaceholder: '請說明駁回的原因...',
                showCancelButton: true,
                confirmButtonText: '確認駁回',
                cancelButtonText: '取消',
                confirmButtonColor: '#dc3545',
                inputValidator: (value) => {
                    if (!value) {
                        return '請輸入駁回原因';
                    }
                }
            });

            if (reason) {
                showLoading();
                
                try {
                    const transaction = currentData.transactions.find(t => t.voucherNumber === voucherNumber);
                    if (transaction) {
                        transaction.status = '憑證已駁回';
                        transaction.rejectReason = reason;
                        
                        const saved = await saveToSheets('交易記錄', currentData.transactions);
                        
                        if (saved) {
                            loadVoucherManagement();
                            loadTransactions();
                            updateSummary();
                            showAlert('success', '駁回成功', '憑證已駁回');
                        }
                    }
                } catch (error) {
                    showAlert('error', '駁回失敗', '無法駁回憑證');
                } finally {
                    hideLoading();
                }
            }
        }

        // 檔案上傳功能
        function initializeFileUpload() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('fileInput');

            fileUploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('drag-over');
            });

            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('drag-over');
            });

            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelection(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelection(e.target.files[0]);
                }
            });
        }

        // 處理檔案選擇
        function handleFileSelection(file) {
            // 檢查檔案類型
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            if (!allowedTypes.includes(file.type)) {
                showAlert('error', '檔案格式不支援', '請選擇 PDF、JPG、PNG、DOC 或 DOCX 檔案');
                return;
            }

            // 檢查檔案大小 (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showAlert('error', '檔案過大', '檔案大小不能超過 10MB');
                return;
            }

            // 顯示檔案資訊
            const fileUploadArea = document.getElementById('fileUploadArea');
            fileUploadArea.innerHTML = `
                <i class="bi bi-file-earmark fs-1 text-success"></i>
                <p><strong>${file.name}</strong></p>
                <p class="text-muted">大小: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
            `;
        }

        // 上傳憑證附件
        function uploadVoucherAttachment() {
            fileUploadModal.show();
        }

        // 確認檔案上傳
        function confirmFileUpload() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files.length) {
                showAlert('warning', '請選擇檔案', '請先選擇要上傳的檔案');
                return;
            }

            const file = fileInput.files[0];
            const progressBar = document.querySelector('#uploadProgress .progress-bar');
            const uploadProgress = document.getElementById('uploadProgress');

            uploadProgress.style.display = 'block';
            
            // 模擬上傳進度
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 30;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    
                    setTimeout(() => {
                        fileUploadModal.hide();
                        showAlert('success', '上傳成功', '檔案已成功上傳');
                        
                        // 重置上傳區域
                        document.getElementById('fileUploadArea').innerHTML = `
                            <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                            <p>點擊或拖拽檔案到此處上傳</p>
                            <p class="text-muted small">支援格式：PDF, JPG, PNG, DOC, DOCX<br>檔案大小限制：10MB</p>
                        `;
                        uploadProgress.style.display = 'none';
                        progressBar.style.width = '0%';
                    }, 500);
                }
                
                progressBar.style.width = progress + '%';
                progressBar.textContent = Math.round(progress) + '%';
            }, 100);
        }

        // 設定管理
        function showSettings() {
            loadSettings();
            settingsModal.show();
        }

        // 載入設定
        function loadSettings() {
            const savedSettings = localStorage.getItem('systemSettings');
            if (savedSettings) {
                currentData.settings = JSON.parse(savedSettings);
                
                document.getElementById('orgName').value = currentData.settings.orgName || '台灣帕金森病友權益促進會';
                document.getElementById('orgTaxId').value = currentData.settings.taxId || '';
                document.getElementById('orgAddress').value = currentData.settings.address || '';
                document.getElementById('orgPhone').value = currentData.settings.phone || '';
                document.getElementById('autoSync').checked = currentData.settings.autoSync !== false;
                document.getElementById('autoBackup').checked = currentData.settings.autoBackup || false;
                document.getElementById('emailNotification').checked = currentData.settings.emailNotification || false;
                document.getElementById('receiptStartNumber').value = currentData.settings.receiptStartNumber || 1;
                document.getElementById('voucherStartNumber').value = currentData.settings.voucherStartNumber || 1;
            }
        }

        // 儲存設定
        function saveSettings() {
            const settings = {
                orgName: document.getElementById('orgName').value,
                taxId: document.getElementById('orgTaxId').value,
                address: document.getElementById('orgAddress').value,
                phone: document.getElementById('orgPhone').value,
                autoSync: document.getElementById('autoSync').checked,
                autoBackup: document.getElementById('autoBackup').checked,
                emailNotification: document.getElementById('emailNotification').checked,
                receiptStartNumber: parseInt(document.getElementById('receiptStartNumber').value),
                voucherStartNumber: parseInt(document.getElementById('voucherStartNumber').value)
            };

            currentData.settings = settings;
            localStorage.setItem('systemSettings', JSON.stringify(settings));
            
            settingsModal.hide();
            showAlert('success', '設定已儲存', '系統設定已成功儲存');
        }

        // 草稿功能
        function saveDraft() {
            const formData = {
                date: document.getElementById('date').value,
                name: document.getElementById('name').value,
                type: document.getElementById('type').value,
                category: document.getElementById('category').value,
                account: document.getElementById('account').value,
                amount: document.getElementById('amount').value,
                description: document.getElementById('description').value,
                generateReceipt: document.getElementById('generateReceipt').checked,
                sendEmail: document.getElementById('sendEmail').checked
            };

            localStorage.setItem('transactionDraft', JSON.stringify(formData));
            showAlert('info', '草稿已儲存', '表單資料已儲存為草稿');
        }

        function loadDraft() {
            const draft = localStorage.getItem('transactionDraft');
            if (draft) {
                const formData = JSON.parse(draft);
                
                document.getElementById('date').value = formData.date || '';
                document.getElementById('name').value = formData.name || '';
                document.getElementById('type').value = formData.type || '';
                updateCategoryOptions(formData.type);
                document.getElementById('category').value = formData.category || '';
                document.getElementById('account').value = formData.account || '';
                document.getElementById('amount').value = formData.amount || '';
                document.getElementById('description').value = formData.description || '';
                document.getElementById('generateReceipt').checked = formData.generateReceipt || false;
                document.getElementById('sendEmail').checked = formData.sendEmail || false;
                
                showAlert('success', '草稿已載入', '已載入之前儲存的草稿');
            } else {
                showAlert('info', '沒有草稿', '沒有找到儲存的草稿');
            }
        }

        function clearDraft() {
            localStorage.removeItem('transactionDraft');
        }

        // 姓名自動完成
        function showNameSuggestions(input) {
            if (input.length < 2) {
                hideNameSuggestions();
                return;
            }

            const suggestions = currentData.members
                .filter(member => member.name.toLowerCase().includes(input.toLowerCase()))
                .slice(0, 5);

            if (suggestions.length === 0) {
                hideNameSuggestions();
                return;
            }

            const suggestionsDiv = document.getElementById('nameSuggestions');
            suggestionsDiv.innerHTML = suggestions.map(member => 
                `<div class="name-suggestion-item" onclick="selectName('${member.name}')">${member.name}</div>`
            ).join('');
            suggestionsDiv.style.display = 'block';
        }

        function hideNameSuggestions() {
            setTimeout(() => {
                document.getElementById('nameSuggestions').style.display = 'none';
            }, 200);
        }

        function selectName(name) {
            document.getElementById('name').value = name;
            hideNameSuggestions();
        }

        // 批次操作
        function toggleTransactionSelection(id) {
            const index = selectedTransactions.indexOf(id);
            if (index > -1) {
                selectedTransactions.splice(index, 1);
            } else {
                selectedTransactions.push(id);
            }
            
            updateBatchActions();
        }

        function selectAllTransactions() {
            const checkboxes = document.querySelectorAll('.transaction-checkbox');
            const selectAll = document.getElementById('selectAll').checked;
            
            selectedTransactions = [];
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
                if (selectAll) {
                    selectedTransactions.push(checkbox.value);
                }
            });
            
            updateBatchActions();
        }

        function updateBatchActions() {
            const batchActions = document.getElementById('batchActions');
            const selectedCount = selectedTransactions.length;
            
            if (selectedCount > 0) {
                batchActions.style.display = 'block';
                batchActions.querySelector('.selected-count').textContent = selectedCount;
            } else {
                batchActions.style.display = 'none';
            }
        }

        async function batchDelete() {
            if (selectedTransactions.length === 0) return;

            const result = await Swal.fire({
                title: '確認批次刪除',
                text: `確定要刪除選中的 ${selectedTransactions.length} 筆記錄嗎？`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '刪除',
                cancelButtonText: '取消',
                confirmButtonColor: '#dc3545'
            });

            if (result.isConfirmed) {
                showLoading();
                
                try {
                    currentData.transactions = currentData.transactions.filter(t => 
                        !selectedTransactions.includes(t.receiptNumber) && 
                        !selectedTransactions.includes(t.voucherNumber) && 
                        !selectedTransactions.includes(t.id.toString())
                    );
                    
                    const saved = await saveToSheets('交易記錄', currentData.transactions);
                    
                    if (saved) {
                        selectedTransactions = [];
                        loadTransactions();
                        updateSummary();
                        updateBatchActions();
                        showAlert('success', '批次刪除成功', '選中的記錄已刪除');
                    }
                } catch (error) {
                    showAlert('error', '批次刪除失敗', '無法刪除選中的記錄');
                } finally {
                    hideLoading();
                }
            }
        }

        function batchExport() {
            if (selectedTransactions.length === 0) return;

            const selectedData = currentData.transactions.filter(t => 
                selectedTransactions.includes(t.receiptNumber) || 
                selectedTransactions.includes(t.voucherNumber) || 
                selectedTransactions.includes(t.id.toString())
            );

            exportToCSV(selectedData, '選中的交易記錄');
        }

        // 匯出功能
        function exportData() {
            const filteredTransactions = getFilteredTransactions();
            exportToCSV(filteredTransactions, '交易記錄');
        }

        function exportToCSV(data, filename) {
            const headers = ['日期', '姓名', '類型', '分類', '帳戶', '金額', '說明', '收據編號', '憑證編號', '狀態'];
            const csvContent = [
                headers.join(','),
                ...data.map(row => [
                    row.date,
                    row.name,
                    row.type,
                    row.category,
                    row.account,
                    row.amount,
                    row.description,
                    row.receiptNumber || '',
                    row.voucherNumber || '',
                    row.status
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 電子郵件功能
        async function sendReceiptEmail(receiptNumber) {
            const transaction = currentData.transactions.find(t => t.receiptNumber === receiptNumber);
            if (!transaction) return;

            const member = currentData.members.find(m => m.name === transaction.name);
            if (!member || !member.email) {
                showAlert('warning', '無法寄送', '找不到會員的電子郵件地址');
                return;
            }

            try {
                // 這裡應該整合實際的郵件服務
                showAlert('success', '郵件已寄送', `收據已寄送至 ${member.email}`);
            } catch (error) {
                showAlert('error', '寄送失敗', '無法寄送收據郵件');
            }
        }

        async function resendReceiptEmail() {
            if (currentReceiptNumber) {
                await sendReceiptEmail(currentReceiptNumber);
            }
        }

        // 工具函數
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function getStatusClass(status) {
            switch (status) {
                case '已記錄': return 'status-recorded';
                case '收據已開立': return 'status-receipt';
                case '憑證待核准': return 'status-pending';
                case '憑證已核准': return 'status-approved';
                case '憑證已駁回': return 'status-rejected';
                default: return 'status-recorded';
            }
        }

        function numberToChineseWords(num) {
            const digits = ['零', '壹', '貳', '參', '肆', '伍', '陸', '柒', '捌', '玖'];
            const units = ['', '拾', '佰', '仟', '萬', '拾萬', '佰萬', '仟萬', '億'];
            
            if (num === 0) return '零元整';
            
            let result = '';
            let numStr = num.toString();
            let len = numStr.length;
            
            for (let i = 0; i < len; i++) {
                let digit = parseInt(numStr[i]);
                let unit = len - i - 1;
                
                if (digit !== 0) {
                    result += digits[digit] + (unit > 0 ? units[unit] : '');
                } else if (result && !result.endsWith('零')) {
                    result += '零';
                }
            }
            
            return result.replace(/零+$/, '') + '元整';
        }

        function showLoading() {
            Swal.fire({
                title: '處理中...',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        }

        function hideLoading() {
            Swal.close();
        }

        function showAlert(type, title, text) {
            const icons = {
                success: 'success',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };

            Swal.fire({
                icon: icons[type] || 'info',
                title: title,
                text: text,
                confirmButtonText: '確定',
                timer: type === 'success' ? 3000 : undefined,
                timerProgressBar: type === 'success'
            });
        }

        // 鍵盤快捷鍵
        document.addEventListener('keydown', function(e) {
            // Ctrl+N: 新增交易
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                showTransactionForm();
            }
            
            // Ctrl+S: 儲存 (在表單中)
            if (e.ctrlKey && e.key === 's' && document.querySelector('.modal.show')) {
                e.preventDefault();
                const activeForm = document.querySelector('.modal.show form');
                if (activeForm) {
                    activeForm.dispatchEvent(new Event('submit'));
                }
            }
            
            // Escape: 關閉 Modal
            if (e.key === 'Escape') {
                const activeModal = document.querySelector('.modal.show');
                if (activeModal) {
                    bootstrap.Modal.getInstance(activeModal).hide();
                }
            }
        });

        // 自動儲存草稿
        setInterval(() => {
            const modal = document.querySelector('#transactionModal.show');
            if (modal) {
                const name = document.getElementById('name').value;
                const amount = document.getElementById('amount').value;
                
                if (name || amount) {
                    saveDraft();
                }
            }
        }, 30000); // 每30秒自動儲存

        // 定期同步
        setInterval(() => {
            if (sheetsConnected && currentData.settings.autoSync) {
                syncWithSheets();
            }
        }, 300000); // 每5分鐘同步一次

        // 頁面離開前確認
        window.addEventListener('beforeunload', function(e) {
            const activeModal = document.querySelector('.modal.show');
            if (activeModal) {
                e.preventDefault();
                e.returnValue = '您有未儲存的資料，確定要離開嗎？';
            }
        });

        console.log('台灣帕金森病友權益促進會會計系統已載入完成');
    </script>

    <!-- 載入額外的函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
</body>
</html>
