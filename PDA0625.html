<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會 - 會計管理系統</title>
  
  <!-- 載入 Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- 載入 Font Awesome 圖示 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- 載入 DataTables CSS -->
  <link href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  
  <!-- 載入 Flatpickr 日期選擇器 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  
  <!-- 載入 Chart.js CSS -->
  <link href="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.min.css" rel="stylesheet">
  
  <style>
    /* 自訂樣式 */
    body {
      font-family: "微軟正黑體", "Microsoft JhengHei", sans-serif;
      background-color: #f8f9fa;
    }
    
    .sidebar {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      z-index: 100;
      padding: 48px 0 0;
      box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
      background-color: #343a40;
    }
    
    .sidebar-sticky {
      position: relative;
      top: 0;
      height: calc(100vh - 48px);
      padding-top: 0.5rem;
      overflow-x: hidden;
      overflow-y: auto;
    }
    
    .sidebar .nav-link {
      font-weight: 500;
      color: #d3d3d3;
      padding: 0.75rem 1rem;
    }
    
    .sidebar .nav-link:hover {
      color: #fff;
    }
    
    .sidebar .nav-link.active {
      color: #fff;
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .sidebar .nav-link i {
      margin-right: 0.5rem;
      width: 20px;
      text-align: center;
    }
    
    .navbar-brand {
      padding-top: 0.75rem;
      padding-bottom: 0.75rem;
      font-size: 1rem;
      background-color: rgba(0, 0, 0, 0.25);
      box-shadow: inset -1px 0 0 rgba(0, 0, 0, 0.25);
    }
    
    .content {
      margin-left: 240px;
      padding: 20px;
    }
    
    .card {
      margin-bottom: 20px;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .card-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid rgba(0, 0, 0, 0.125);
      padding: 0.75rem 1.25rem;
    }
    
    .btn-action {
      margin-right: 5px;
    }
    
    .dashboard-card {
      text-align: center;
      padding: 20px;
    }
    
    .dashboard-card .card-value {
      font-size: 2rem;
      font-weight: bold;
    }
    
    .dashboard-card .card-title {
      font-size: 1rem;
      color: #6c757d;
    }
    
    .form-required::after {
      content: "*";
      color: red;
      margin-left: 4px;
    }
    
    /* 響應式設計 */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        padding: 0;
      }
      
      .content {
        margin-left: 0;
      }
      
      .sidebar-sticky {
        height: auto;
      }
    }
  </style>
</head>
<body>
  <!-- 頂部導航欄 -->
  <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">台灣帕金森病友權益促進會</a>
    <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="w-100"></div>
    <div class="navbar-nav">
      <div class="nav-item text-nowrap">
        <span class="nav-link px-3" id="userInfo">載入中...</span>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- 側邊導航欄 -->
      <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
        <div class="sidebar-sticky">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="#" data-page="dashboard">
                <i class="fas fa-tachometer-alt"></i> 儀表板
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-page="transactions">
                <i class="fas fa-exchange-alt"></i> 交易記錄
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-page="receipts">
                <i class="fas fa-receipt"></i> 收據管理
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-page="vouchers">
                <i class="fas fa-file-invoice-dollar"></i> 支出憑證
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-page="members">
                <i class="fas fa-users"></i> 會員管理
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-page="reports">
                <i class="fas fa-chart-bar"></i> 報表分析
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-page="settings">
                <i class="fas fa-cog"></i> 系統設定
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <!-- 主要內容區域 -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 content">
        <div id="pageContent">
          <!-- 頁面內容將動態載入 -->
          <div class="text-center py-5">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">載入中...</span>
            </div>
            <p class="mt-3">正在載入系統，請稍候...</p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- 模態框 -->
  <div class="modal fade" id="formModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">表單</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
        </div>
        <div class="modal-body" id="modalBody">
          <!-- 表單內容將動態載入 -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="saveButton">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 確認模態框 -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmTitle">確認</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
        </div>
        <div class="modal-body" id="confirmBody">
          您確定要執行此操作嗎？
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-danger" id="confirmButton">確認</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast 通知 -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toastTitle">通知</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastBody">
        操作已完成
      </div>
    </div>
  </div>

  <!-- 載入 jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  
  <!-- 載入 Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- 載入 DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
  
  <!-- 載入 Flatpickr 日期選擇器 JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
  
  <!-- 載入 Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <script>
    // 全域變數
    let currentPage = 'dashboard';
    let currentUser = null;
    let systemSettings = {};
    let formModal = null;
    let confirmModal = null;
    let toast = null;
    
    // 頁面載入完成
    $(document).ready(function() {
      // 初始化 Bootstrap 元件
      formModal = new bootstrap.Modal(document.getElementById('formModal'));
      confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
      toast = new bootstrap.Toast(document.getElementById('toast'));
      
      // 載入目前使用者資訊
      loadCurrentUser();
      
      // 載入系統設定
      loadSystemSettings();
      
      // 註冊導航點擊事件
      $('.nav-link').click(function(e) {
        e.preventDefault();
        const page = $(this).data('page');
        if (page !== currentPage) {
          navigateTo(page);
        }
      });
      
      // 初始載入儀表板
      loadPage('dashboard');
    });
    
    // 載入目前使用者資訊
    function loadCurrentUser() {
      callApi('getCurrentUser', null, function(response) {
        if (response.success) {
          currentUser = response.data;
          $('#userInfo').text(currentUser.email);
        } else {
          showToast('錯誤', response.message || '無法載入使用者資訊');
        }
      });
    }
    
    // 載入系統設定
    function loadSystemSettings() {
      callApi('getSettings', null, function(response) {
        if (response.success) {
          systemSettings = response.data;
        } else {
          showToast('錯誤', response.message || '無法載入系統設定');
        }
      });
    }
    
    // 導航到指定頁面
    function navigateTo(page) {
      // 更新導航選中狀態
      $('.nav-link').removeClass('active');
      $(`.nav-link[data-page="${page}"]`).addClass('active');
      
      // 載入頁面內容
      loadPage(page);
      
      // 更新目前頁面
      currentPage = page;
    }
    
    // 載入頁面內容
    function loadPage(page) {
      $('#pageContent').html(`
        <div class="text-center py-5">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">載入中...</span>
          </div>
          <p class="mt-3">正在載入頁面，請稍候...</p>
        </div>
      `);
      
      // 根據頁面載入對應的內容
      switch (page) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'transactions':
          loadTransactions();
          break;
        case 'receipts':
          loadReceipts();
          break;
        case 'vouchers':
          loadVouchers();
          break;
        case 'members':
          loadMembers();
          break;
        case 'reports':
          loadReports();
          break;
        case 'settings':
          loadSettings();
          break;
        default:
          $('#pageContent').html('<div class="alert alert-danger">找不到指定的頁面</div>');
      }
    }
    
    // API 呼叫函數
    function callApi(operation, data, callback) {
      // 顯示載入中指示器
      const loadingIndicator = $('<div class="api-loading">載入中...</div>');
      $('body').append(loadingIndicator);
      
      // 準備請求資料
      const requestData = {
        operation: operation
      };
      
      // 如果有資料，加入到請求中
      if (data) {
        requestData.data = JSON.stringify(data);
      }
      
      // 取得部署的 Web App URL
      const webAppUrl = 'https://script.google.com/macros/s/AKfycbzyZ4-MP3BBeW3v4MPcgpL6STruJXLG6EJyXA7TsPVqoO3jXDYt7rsWdIovmtA61T5yuA/exec';
      
      $.ajax({
        url: webAppUrl,
        type: 'GET',  // Google Apps Script Web App 使用 GET 請求
        data: requestData,
        dataType: 'json',
        success: function(response) {
          // 移除載入中指示器
          loadingIndicator.remove();
          
          // 呼叫回調函數
          if (callback) {
            callback(response);
          }
        },
        error: function(jqXHR, textStatus, errorThrown) {
          // 移除載入中指示器
          loadingIndicator.remove();
          
          // 記錄錯誤
          console.error('API 呼叫失敗:', textStatus, errorThrown);
          
          // 顯示錯誤訊息
          showToast('錯誤', '系統發生錯誤: ' + (errorThrown || textStatus));
          
          // 呼叫回調函數並傳遞錯誤
          if (callback) {
            callback({
              success: false,
              message: '系統發生錯誤: ' + (errorThrown || textStatus)
            });
          }
        }
      });
    }

    
    // 顯示通知
    function showToast(title, message) {
      $('#toastTitle').text(title);
      $('#toastBody').text(message);
      toast.show();
    }
    
    // 格式化日期
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.getFullYear() + '/' + 
             String(date.getMonth() + 1).padStart(2, '0') + '/' + 
             String(date.getDate()).padStart(2, '0');
    }
    
    // 格式化金額
    function formatAmount(amount) {
      return parseFloat(amount).toLocaleString('zh-TW');
    }
    
    // 初始化日期選擇器
    function initDatePickers() {
      flatpickr(".datepicker", {
        locale: "zh_tw",
        dateFormat: "Y/m/d",
        allowInput: true
      });
    }
    
    // 載入儀表板
    function loadDashboard() {
      $('#pageContent').html(`
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">系統儀表板</h1>
        </div>
        
        <div class="row" id="dashboardStats">
          <div class="col-md-4">
            <div class="card dashboard-card">
              <div class="card-body">
                <div class="card-value" id="totalIncome">--</div>
                <div class="card-title">本年度總收入</div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card dashboard-card">
              <div class="card-body">
                <div class="card-value" id="totalExpense">--</div>
                <div class="card-title">本年度總支出</div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card dashboard-card">
              <div class="card-body">
                <div class="card-value" id="balance">--</div>
                <div class="card-title">本年度收支餘絀</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5>本年度月收支統計</h5>
              </div>
              <div class="card-body">
                <canvas id="monthlyChart"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5>收入類別分佈</h5>
              </div>
              <div class="card-body">
                <canvas id="incomeCategoryChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5>支出類別分佈</h5>
              </div>
              <div class="card-body">
                <canvas id="expenseCategoryChart"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5>會員統計</h5>
              </div>
              <div class="card-body">
                <canvas id="memberChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      `);
      
      // 載入交易統計資料
      callApi('getTransactionStats', null, function(response) {
        if (response.success) {
          const data = response.data;
          
          // 更新統計卡片
          $('#totalIncome').text('NT$ ' + formatAmount(data.totalIncome));
          $('#totalExpense').text('NT$ ' + formatAmount(data.totalExpense));
          
          const balance = data.balance;
          $('#balance').text('NT$ ' + formatAmount(Math.abs(balance)));
          if (balance < 0) {
            $('#balance').addClass('text-danger');
          } else {
            $('#balance').addClass('text-success');
          }
          
          // 繪製月度收支圖表
          const monthlyLabels = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
          const monthlyIncomeData = data.monthly.map(m => m.income);
          const monthlyExpenseData = data.monthly.map(m => m.expense);
          
          new Chart(document.getElementById('monthlyChart'), {
            type: 'bar',
            data: {
              labels: monthlyLabels,
              datasets: [
                {
                  label: '收入',
                  data: monthlyIncomeData,
                  backgroundColor: 'rgba(75, 192, 192, 0.5)',
                  borderColor: 'rgba(75, 192, 192, 1)',
                  borderWidth: 1
                },
                {
                  label: '支出',
                  data: monthlyExpenseData,
                  backgroundColor: 'rgba(255, 99, 132, 0.5)',
                  borderColor: 'rgba(255, 99, 132, 1)',
                  borderWidth: 1
                }
              ]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
          
          // 繪製收入類別圓餅圖
          const incomeCategories = Object.keys(data.categories.income);
          const incomeCategoryValues = Object.values(data.categories.income);
          
          new Chart(document.getElementById('incomeCategoryChart'), {
            type: 'pie',
            data: {
              labels: incomeCategories,
              datasets: [{
                data: incomeCategoryValues,
                backgroundColor: [
                  'rgba(75, 192, 192, 0.5)',
                  'rgba(54, 162, 235, 0.5)',
                  'rgba(153, 102, 255, 0.5)',
                  'rgba(255, 205, 86, 0.5)',
                  'rgba(255, 159, 64, 0.5)',
                  'rgba(201, 203, 207, 0.5)'
                ],
                borderColor: [
                  'rgba(75, 192, 192, 1)',
                  'rgba(54, 162, 235, 1)',
                  'rgba(153, 102, 255, 1)',
                  'rgba(255, 205, 86, 1)',
                  'rgba(255, 159, 64, 1)',
                  'rgba(201, 203, 207, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'right'
                }
              }
            }
          });
          
          // 繪製支出類別圓餅圖
          const expenseCategories = Object.keys(data.categories.expense);
          const expenseCategoryValues = Object.values(data.categories.expense);
          
          new Chart(document.getElementById('expenseCategoryChart'), {
            type: 'pie',
            data: {
              labels: expenseCategories,
              datasets: [{
                data: expenseCategoryValues,
                backgroundColor: [
                  'rgba(255, 99, 132, 0.5)',
                  'rgba(255, 159, 64, 0.5)',
                  'rgba(255, 205, 86, 0.5)',
                  'rgba(75, 192, 192, 0.5)',
                  'rgba(54, 162, 235, 0.5)',
                  'rgba(153, 102, 255, 0.5)'
                ],
                borderColor: [
                  'rgba(255, 99, 132, 1)',
                  'rgba(255, 159, 64, 1)',
                  'rgba(255, 205, 86, 1)',
                  'rgba(75, 192, 192, 1)',
                  'rgba(54, 162, 235, 1)',
                  'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'right'
                }
              }
            }
          });
        } else {
          showToast('錯誤', response.message || '無法載入交易統計資料');
        }
      });
      
      // 載入會員統計資料
      callApi('getMemberReport', null, function(response) {
        if (response.success) {
          const data = response.data;
          
          // 繪製會員類型圓餅圖
          const memberTypes = Object.keys(data.memberTypes);
          const memberTypeCounts = Object.values(data.memberTypes);
          
          new Chart(document.getElementById('memberChart'), {
            type: 'pie',
            data: {
              labels: memberTypes,
              datasets: [{
                data: memberTypeCounts,
                backgroundColor: [
                  'rgba(54, 162, 235, 0.5)',
                  'rgba(75, 192, 192, 0.5)',
                  'rgba(153, 102, 255, 0.5)',
                  'rgba(255, 205, 86, 0.5)'
                ],
                borderColor: [
                  'rgba(54, 162, 235, 1)',
                  'rgba(75, 192, 192, 1)',
                  'rgba(153, 102, 255, 1)',
                  'rgba(255, 205, 86, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'right'
                }
              }
            }
          });
        } else {
          showToast('錯誤', response.message || '無法載入會員統計資料');
        }
      });
    }
    
    // 載入交易記錄頁面
    function loadTransactions() {
      $('#pageContent').html(`
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">交易記錄管理</h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <button type="button" class="btn btn-sm btn-outline-primary" id="addTransactionBtn">
              <i class="fas fa-plus"></i> 新增交易
            </button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="row">
              <div class="col-md-8">
                <div class="input-group">
                  <input type="text" class="form-control" id="transactionSearch" placeholder="搜尋交易記錄...">
                  <button class="btn btn-outline-secondary" type="button" id="searchTransactionBtn">
                    <i class="fas fa-search"></i> 搜尋
                  </button>
                </div>
              </div>
              <div class="col-md-4">
                <div class="d-flex justify-content-end">
                  <select class="form-select me-2" id="transactionTypeFilter">
                    <option value="">所有類型</option>
                    <option value="收入">收入</option>
                    <option value="支出">支出</option>
                  </select>
                  <select class="form-select" id="transactionStatusFilter">
                    <option value="">所有狀態</option>
                    <option value="已確認">已確認</option>
                    <option value="待確認">待確認</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover" id="transactionsTable">
                <thead>
                  <tr>
                    <th>日期</th>
                    <th>名稱</th>
                    <th>類型</th>
                    <th>類別</th>
                    <th>金額</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="7" class="text-center">載入中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `);
      
      // 註冊新增交易按鈕事件
      $('#addTransactionBtn').click(function() {
        showTransactionForm();
      });
      
      // 註冊搜尋按鈕事件
      $('#searchTransactionBtn').click(function() {
        loadTransactionData();
      });
      
      // 註冊過濾器變更事件
      $('#transactionTypeFilter, #transactionStatusFilter').change(function() {
        loadTransactionData();
      });
      
      // 載入交易資料
      loadTransactionData();
    }
    
    // 載入交易資料
    function loadTransactionData() {
      const search = $('#transactionSearch').val();
      const typeFilter = $('#transactionTypeFilter').val();
      const statusFilter = $('#transactionStatusFilter').val();
      
      const filters = {
        search: search,
        type: typeFilter,
        status: statusFilter
      };
      
      callApi('getTransactions', filters, function(response) {
        if (response.success) {
          const transactions = response.data;
          let tableHtml = '';
          
          if (transactions.length === 0) {
            tableHtml = '<tr><td colspan="7" class="text-center">沒有符合條件的交易記錄</td></tr>';
          } else {
            transactions.forEach(function(tx) {
              const amountClass = tx.type === '收入' ? 'text-success' : 'text-danger';
              const amountPrefix = tx.type === '收入' ? '+' : '-';
              
              tableHtml += `
                <tr>
                  <td>${formatDate(tx.date)}</td>
                  <td>${tx.name}</td>
                  <td>${tx.type}</td>
                  <td>${tx.category}</td>
                  <td class="${amountClass}">${amountPrefix} ${formatAmount(tx.amount)}</td>
                  <td>${tx.status}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary btn-action" onclick="editTransaction('${tx.id}')">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteTransaction('${tx.id}')">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              `;
            });
          }
          
          $('#transactionsTable tbody').html(tableHtml);
          
          // 初始化 DataTable
          if ($.fn.DataTable.isDataTable('#transactionsTable')) {
            $('#transactionsTable').DataTable().destroy();
          }
          
          $('#transactionsTable').DataTable({
            language: {
              url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/zh-HANT.json'
            },
            paging: true,
            searching: false,
            ordering: true,
            info: true,
            pageLength: 10,
            lengthChange: false
          });
        } else {
          showToast('錯誤', response.message || '無法載入交易記錄');
        }
      });
    }
    
    // 顯示交易表單
    function showTransactionForm(id = null) {
      $('#modalTitle').text(id ? '編輯交易記錄' : '新增交易記錄');
      
      // 載入類別選項
      let incomeCategories = '一般捐款,專案捐款,會費收入,活動收入,其他收入';
      let expenseCategories = '人事費用,辦公費用,活動費用,專案費用,其他支出';
      
      if (systemSettings.default_categories_income) {
        incomeCategories = systemSettings.default_categories_income.value;
      }
      
      if (systemSettings.default_categories_expense) {
        expenseCategories = systemSettings.default_categories_expense.value;
      }
      
      const incomeCategoryOptions = incomeCategories.split(',').map(cat => 
        `<option value="${cat.trim()}">${cat.trim()}</option>`
      ).join('');
      
      const expenseCategoryOptions = expenseCategories.split(',').map(cat => 
        `<option value="${cat.trim()}">${cat.trim()}</option>`
      ).join('');
      
      // 建立表單
      $('#modalBody').html(`
        <form id="transactionForm">
          <input type="hidden" id="transactionId" value="${id || ''}">
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="transactionDate" class="form-label form-required">日期</label>
              <input type="text" class="form-control datepicker" id="transactionDate" required>
            </div>
            <div class="col-md-6">
              <label for="transactionType" class="form-label form-required">類型</label>
              <select class="form-select" id="transactionType" required>
                <option value="收入">收入</option>
                <option value="支出">支出</option>
              </select>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="transactionName" class="form-label form-required">名稱</label>
              <input type="text" class="form-control" id="transactionName" required>
            </div>
            <div class="col-md-6">
              <label for="transactionCategory" class="form-label form-required">類別</label>
              <select class="form-select" id="transactionCategory" required>
                <optgroup label="收入類別" id="incomeCategoryGroup">
                  ${incomeCategoryOptions}
                </optgroup>
                <optgroup label="支出類別" id="expenseCategoryGroup">
                  ${expenseCategoryOptions}
                </optgroup>
              </select>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="transactionAmount" class="form-label form-required">金額</label>
              <input type="number" class="form-control" id="transactionAmount" min="0" step="1" required>
            </div>
            <div class="col-md-6">
              <label for="transactionStatus" class="form-label form-required">狀態</label>
              <select class="form-select" id="transactionStatus" required>
                <option value="已確認">已確認</option>
                <option value="待確認">待確認</option>
              </select>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="transactionDescription" class="form-label">描述</label>
            <textarea class="form-control" id="transactionDescription" rows="3"></textarea>
          </div>
        </form>
      `);
      
      // 初始化日期選擇器
      initDatePickers();
      
      // 註冊交易類型變更事件
      $('#transactionType').change(function() {
        const type = $(this).val();
        if (type === '收入') {
          $('#incomeCategoryGroup').show();
          $('#expenseCategoryGroup').hide();
          $('#transactionCategory').val($('#incomeCategoryGroup option:first').val());
        } else {
          $('#incomeCategoryGroup').hide();
          $('#expenseCategoryGroup').show();
          $('#transactionCategory').val($('#expenseCategoryGroup option:first').val());
        }
      });
      
      // 如果是編輯，載入交易資料
      if (id) {
        callApi('getTransaction', { id: id }, function(response) {
          if (response.success && response.data) {
            const tx = response.data;
            
            $('#transactionDate').val(formatDate(tx.date));
            $('#transactionType').val(tx.type);
            $('#transactionName').val(tx.name);
            $('#transactionAmount').val(tx.amount);
            $('#transactionDescription').val(tx.description);
            $('#transactionStatus').val(tx.status);
            
            // 根據類型顯示對應的類別選項
            $('#transactionType').trigger('change');
            
            // 設定類別值
            $('#transactionCategory').val(tx.category);
          } else {
            showToast('錯誤', response.message || '無法載入交易資料');
          }
        });
      } else {
        // 設定預設值
        $('#transactionDate').val(formatDate(new Date()));
        $('#transactionType').trigger('change');
      }
      
      // 註冊儲存按鈕事件
      $('#saveButton').off('click').on('click', function() {
        saveTransaction();
      });
      
      // 顯示模態框
      formModal.show();
    }
    
    // 儲存交易記錄
    function saveTransaction() {
      // 表單驗證
      if (!$('#transactionForm')[0].checkValidity()) {
        $('#transactionForm')[0].reportValidity();
        return;
      }
      
      const transactionData = {
        id: $('#transactionId').val(),
        date: $('#transactionDate').val(),
        name: $('#transactionName').val(),
        type: $('#transactionType').val(),
        category: $('#transactionCategory').val(),
        amount: parseFloat($('#transactionAmount').val()),
        description: $('#transactionDescription').val(),
        status: $('#transactionStatus').val()
      };
      
      callApi('saveTransaction', transactionData, function(response) {
        if (response.success) {
          formModal.hide();
          showToast('成功', response.message || '交易記錄已儲存');
          loadTransactionData();
        } else {
          showToast('錯誤', response.message || '儲存交易記錄失敗');
        }
      });
    }
    
    // 編輯交易記錄
    function editTransaction(id) {
      showTransactionForm(id);
    }
    
    // 刪除交易記錄
    function deleteTransaction(id) {
      $('#confirmTitle').text('確認刪除');
      $('#confirmBody').text('您確定要刪除此交易記錄嗎？此操作無法復原。');
      
      $('#confirmButton').off('click').on('click', function() {
        callApi('deleteTransaction', { id: id }, function(response) {
          confirmModal.hide();
          
          if (response.success) {
            showToast('成功', response.message || '交易記錄已刪除');
            loadTransactionData();
          } else {
            showToast('錯誤', response.message || '刪除交易記錄失敗');
          }
        });
      });
      
      confirmModal.show();
    }
    
    // 載入收據管理頁面
    function loadReceipts() {
      $('#pageContent').html(`
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">收據管理</h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <button type="button" class="btn btn-sm btn-outline-primary" id="addReceiptBtn">
              <i class="fas fa-plus"></i> 新增收據
            </button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="row">
              <div class="col-md-8">
                <div class="input-group">
                  <input type="text" class="form-control" id="receiptSearch" placeholder="搜尋收據...">
                  <button class="btn btn-outline-secondary" type="button" id="searchReceiptBtn">
                    <i class="fas fa-search"></i> 搜尋
                  </button>
                </div>
              </div>
              <div class="col-md-4">
                <div class="d-flex justify-content-end">
                  <select class="form-select" id="receiptStatusFilter">
                    <option value="">所有狀態</option>
                    <option value="已開立">已開立</option>
                    <option value="待處理">待處理</option>
                    <option value="已作廢">已作廢</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover" id="receiptsTable">
                <thead>
                  <tr>
                    <th>收據編號</th>
                    <th>日期</th>
                    <th>捐款人</th>
                    <th>類別</th>
                    <th>金額</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="7" class="text-center">載入中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `);
      
      // 註冊新增收據按鈕事件
      $('#addReceiptBtn').click(function() {
        showReceiptForm();
      });
      
      // 註冊搜尋按鈕事件
      $('#searchReceiptBtn').click(function() {
        loadReceiptData();
      });
      
      // 註冊過濾器變更事件
      $('#receiptStatusFilter').change(function() {
        loadReceiptData();
      });
      
      // 載入收據資料
      loadReceiptData();
    }
    
    // 載入收據資料
    function loadReceiptData() {
      const search = $('#receiptSearch').val();
      const statusFilter = $('#receiptStatusFilter').val();
      
      const filters = {
        search: search,
        status: statusFilter
      };
      
      callApi('getReceipts', filters, function(response) {
        if (response.success) {
          const receipts = response.data;
          let tableHtml = '';
          
          if (receipts.length === 0) {
            tableHtml = '<tr><td colspan="7" class="text-center">沒有符合條件的收據記錄</td></tr>';
          } else {
            receipts.forEach(function(receipt) {
              tableHtml += `
                <tr>
                  <td>${receipt.receiptNumber}</td>
                  <td>${formatDate(receipt.date)}</td>
                  <td>${receipt.donor}</td>
                  <td>${receipt.category}</td>
                  <td class="text-success">${formatAmount(receipt.amount)}</td>
                  <td>${receipt.status}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary btn-action" onclick="editReceipt('${receipt.id}')">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteReceipt('${receipt.id}')">
                      <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary btn-action" onclick="printReceipt('${receipt.id}')">
                      <i class="fas fa-print"></i>
                    </button>
                  </td>
                </tr>
              `;
            });
          }
          
          $('#receiptsTable tbody').html(tableHtml);
          
          // 初始化 DataTable
          if ($.fn.DataTable.isDataTable('#receiptsTable')) {
            $('#receiptsTable').DataTable().destroy();
          }
          
          $('#receiptsTable').DataTable({
            language: {
              url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/zh-HANT.json'
            },
            paging: true,
            searching: false,
            ordering: true,
            info: true,
            pageLength: 10,
            lengthChange: false
          });
        } else {
          showToast('錯誤', response.message || '無法載入收據記錄');
        }
      });
    }
    
    // 顯示收據表單
    function showReceiptForm(id = null) {
      $('#modalTitle').text(id ? '編輯收據' : '新增收據');
      
      // 載入類別選項
      let donationCategories = '一般捐款,專案捐款,會費收入,活動收入,其他收入';
      
      if (systemSettings.default_categories_income) {
        donationCategories = systemSettings.default_categories_income.value;
      }
      
      const categoryOptions = donationCategories.split(',').map(cat => 
        `<option value="${cat.trim()}">${cat.trim()}</option>`
      ).join('');
      
      // 建立表單
      $('#modalBody').html(`
        <form id="receiptForm">
          <input type="hidden" id="receiptId" value="${id || ''}">
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="receiptDate" class="form-label form-required">日期</label>
              <input type="text" class="form-control datepicker" id="receiptDate" required>
            </div>
            <div class="col-md-6">
              <label for="receiptStatus" class="form-label form-required">狀態</label>
              <select class="form-select" id="receiptStatus" required>
                <option value="已開立">已開立</option>
                <option value="待處理">待處理</option>
                <option value="已作廢">已作廢</option>
              </select>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="receiptDonor" class="form-label form-required">捐款人</label>
              <input type="text" class="form-control" id="receiptDonor" required>
            </div>
            <div class="col-md-6">
              <label for="receiptIdentity" class="form-label">身份證字號/統一編號</label>
              <input type="text" class="form-control" id="receiptIdentity">
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="receiptPhone" class="form-label">聯絡電話</label>
              <input type="text" class="form-control" id="receiptPhone">
            </div>
            <div class="col-md-6">
              <label for="receiptEmail" class="form-label">電子郵件</label>
              <input type="email" class="form-control" id="receiptEmail">
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="receiptCategory" class="form-label form-required">類別</label>
              <select class="form-select" id="receiptCategory" required>
                ${categoryOptions}
              </select>
            </div>
            <div class="col-md-6">
              <label for="receiptAmount" class="form-label form-required">金額</label>
              <input type="number" class="form-control" id="receiptAmount" min="0" step="1" required>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="receiptPurpose" class="form-label">用途</label>
            <textarea class="form-control" id="receiptPurpose" rows="3"></textarea>
          </div>
        </form>
      `);
      
      // 初始化日期選擇器
      initDatePickers();
      
      // 如果是編輯，載入收據資料
      if (id) {
        callApi('getReceipt', { id: id }, function(response) {
          if (response.success && response.data) {
            const receipt = response.data;
            
            $('#receiptDate').val(formatDate(receipt.date));
            $('#receiptDonor').val(receipt.donor);
            $('#receiptIdentity').val(receipt.identity);
            $('#receiptPhone').val(receipt.phone);
            $('#receiptEmail').val(receipt.email);
            $('#receiptCategory').val(receipt.category);
            $('#receiptAmount').val(receipt.amount);
            $('#receiptPurpose').val(receipt.purpose);
            $('#receiptStatus').val(receipt.status);
          } else {
            showToast('錯誤', response.message || '無法載入收據資料');
          }
        });
      } else {
        // 設定預設值
        $('#receiptDate').val(formatDate(new Date()));
      }
      
      // 註冊儲存按鈕事件
      $('#saveButton').off('click').on('click', function() {
        saveReceipt();
      });
      
      // 顯示模態框
      formModal.show();
    }
    
    // 儲存收據
    function saveReceipt() {
      // 表單驗證
      if (!$('#receiptForm')[0].checkValidity()) {
        $('#receiptForm')[0].reportValidity();
        return;
      }
      
      const receiptData = {
        id: $('#receiptId').val(),
        date: $('#receiptDate').val(),
        donor: $('#receiptDonor').val(),
        identity: $('#receiptIdentity').val(),
        phone: $('#receiptPhone').val(),
        email: $('#receiptEmail').val(),
        category: $('#receiptCategory').val(),
        amount: parseFloat($('#receiptAmount').val()),
        purpose: $('#receiptPurpose').val(),
        status: $('#receiptStatus').val()
      };
      
      callApi('saveReceipt', receiptData, function(response) {
        if (response.success) {
          formModal.hide();
          showToast('成功', response.message || '收據已儲存');
          loadReceiptData();
        } else {
          showToast('錯誤', response.message || '儲存收據失敗');
        }
      });
    }
    
    // 編輯收據
    function editReceipt(id) {
      showReceiptForm(id);
    }
    
    // 刪除收據
    function deleteReceipt(id) {
      $('#confirmTitle').text('確認刪除');
      $('#confirmBody').text('您確定要刪除此收據嗎？此操作無法復原。');
      
      $('#confirmButton').off('click').on('click', function() {
        callApi('deleteReceipt', { id: id }, function(response) {
          confirmModal.hide();
          
          if (response.success) {
            showToast('成功', response.message || '收據已刪除');
            loadReceiptData();
          } else {
            showToast('錯誤', response.message || '刪除收據失敗');
          }
        });
      });
      
      confirmModal.show();
    }
    
    // 列印收據
    function printReceipt(id) {
      callApi('generateReceiptPDF', { id: id }, function(response) {
        if (response.success) {
          // 在新視窗中開啟 HTML 內容
          const printWindow = window.open('', '_blank');
          printWindow.document.write(response.data.content);
          printWindow.document.close();
          
          // 等待內容載入後列印
          setTimeout(function() {
            printWindow.print();
          }, 500);
        } else {
          showToast('錯誤', response.message || '產生收據 PDF 失敗');
        }
      });
    }
    
    // 載入支出憑證頁面
    function loadVouchers() {
      $('#pageContent').html(`
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">支出憑證管理</h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <button type="button" class="btn btn-sm btn-outline-primary" id="addVoucherBtn">
              <i class="fas fa-plus"></i> 新增支出憑證
            </button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="row">
              <div class="col-md-8">
                <div class="input-group">
                  <input type="text" class="form-control" id="voucherSearch" placeholder="搜尋支出憑證...">
                  <button class="btn btn-outline-secondary" type="button" id="searchVoucherBtn">
                    <i class="fas fa-search"></i> 搜尋
                  </button>
                </div>
              </div>
              <div class="col-md-4">
                <div class="d-flex justify-content-end">
                  <select class="form-select" id="voucherStatusFilter">
                    <option value="">所有狀態</option>
                    <option value="待審核">待審核</option>
                    <option value="已核准">已核准</option>
                    <option value="已拒絕">已拒絕</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover" id="vouchersTable">
                <thead>
                  <tr>
                    <th>憑證編號</th>
                    <th>日期</th>
                    <th>申請人</th>
                    <th>類別</th>
                    <th>金額</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="7" class="text-center">載入中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `);
      
      // 註冊新增支出憑證按鈕事件
      $('#addVoucherBtn').click(function() {
        showVoucherForm();
      });
      
      // 註冊搜尋按鈕事件
      $('#searchVoucherBtn').click(function() {
        loadVoucherData();
      });
      
      // 註冊過濾器變更事件
      $('#voucherStatusFilter').change(function() {
        loadVoucherData();
      });
      
      // 載入支出憑證資料
      loadVoucherData();
    }
    
    // 載入支出憑證資料
    function loadVoucherData() {
      const search = $('#voucherSearch').val();
      const statusFilter = $('#voucherStatusFilter').val();
      
      const filters = {
        search: search,
        status: statusFilter
      };
      
      callApi('getVouchers', filters, function(response) {
        if (response.success) {
          const vouchers = response.data;
          let tableHtml = '';
          
          if (vouchers.length === 0) {
            tableHtml = '<tr><td colspan="7" class="text-center">沒有符合條件的支出憑證</td></tr>';
          } else {
            vouchers.forEach(function(voucher) {
              const statusClass = voucher.status === '已核准' ? 'text-success' : 
                                 (voucher.status === '已拒絕' ? 'text-danger' : 'text-warning');
              
              tableHtml += `
                <tr>
                  <td>${voucher.voucherNumber}</td>
                  <td>${formatDate(voucher.date)}</td>
                  <td>${voucher.applicant}</td>
                  <td>${voucher.category}</td>
                  <td class="text-danger">${formatAmount(voucher.amount)}</td>
                  <td class="${statusClass}">${voucher.status}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary btn-action" onclick="editVoucher('${voucher.id}')">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteVoucher('${voucher.id}')">
                      <i class="fas fa-trash"></i>
                    </button>
                    ${voucher.status === '待審核' ? `
                    <button class="btn btn-sm btn-outline-success btn-action" onclick="approveVoucher('${voucher.id}')">
                      <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-action" onclick="rejectVoucher('${voucher.id}')">
                      <i class="fas fa-times"></i>
                    </button>
                    ` : ''}
                  </td>
                </tr>
              `;
            });
          }
          
          $('#vouchersTable tbody').html(tableHtml);
          
          // 初始化 DataTable
          if ($.fn.DataTable.isDataTable('#vouchersTable')) {
            $('#vouchersTable').DataTable().destroy();
          }
          
          $('#vouchersTable').DataTable({
            language: {
              url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/zh-HANT.json'
            },
            paging: true,
            searching: false,
            ordering: true,
            info: true,
            pageLength: 10,
            lengthChange: false
          });
        } else {
          showToast('錯誤', response.message || '無法載入支出憑證');
        }
      });
    }
    
    // 顯示支出憑證表單
    function showVoucherForm(id = null) {
      $('#modalTitle').text(id ? '編輯支出憑證' : '新增支出憑證');
      
      // 載入類別選項
      let expenseCategories = '人事費用,辦公費用,活動費用,專案費用,其他支出';
      
      if (systemSettings.default_categories_expense) {
        expenseCategories = systemSettings.default_categories_expense.value;
      }
      
      const categoryOptions = expenseCategories.split(',').map(cat => 
        `<option value="${cat.trim()}">${cat.trim()}</option>`
      ).join('');
      
      // 建立表單
      $('#modalBody').html(`
        <form id="voucherForm">
          <input type="hidden" id="voucherId" value="${id || ''}">
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="voucherDate" class="form-label form-required">日期</label>
              <input type="text" class="form-control datepicker" id="voucherDate" required>
            </div>
            <div class="col-md-6">
              <label for="voucherStatus" class="form-label form-required">狀態</label>
              <select class="form-select" id="voucherStatus" required>
                <option value="待審核">待審核</option>
                <option value="已核准">已核准</option>
                <option value="已拒絕">已拒絕</option>
              </select>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="voucherApplicant" class="form-label form-required">申請人</label>
              <input type="text" class="form-control" id="voucherApplicant" required>
            </div>
            <div class="col-md-6">
              <label for="voucherCategory" class="form-label form-required">類別</label>
              <select class="form-select" id="voucherCategory" required>
                ${categoryOptions}
              </select>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="voucherAmount" class="form-label form-required">金額</label>
              <input type="number" class="form-control" id="voucherAmount" min="0" step="1" required>
            </div>
            <div class="col-md-6">
              <label for="voucherReviewer" class="form-label">審核人</label>
              <input type="text" class="form-control" id="voucherReviewer" ${currentUser ? `value="${currentUser.email}" readonly` : ''}>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="voucherPurpose" class="form-label form-required">用途</label>
            <textarea class="form-control" id="voucherPurpose" rows="3" required></textarea>
          </div>
          
          <div class="mb-3">
            <label for="voucherRemarks" class="form-label">備註</label>
            <textarea class="form-control" id="voucherRemarks" rows="2"></textarea>
          </div>
        </form>
      `);
      
      // 初始化日期選擇器
      initDatePickers();
      
      // 如果是編輯，載入支出憑證資料
      if (id) {
        callApi('getVoucher', { id: id }, function(response) {
          if (response.success && response.data) {
            const voucher = response.data;
            
            $('#voucherDate').val(formatDate(voucher.date));
            $('#voucherApplicant').val(voucher.applicant);
            $('#voucherCategory').val(voucher.category);
            $('#voucherAmount').val(voucher.amount);
            $('#voucherPurpose').val(voucher.purpose);
            $('#voucherRemarks').val(voucher.remarks);
            $('#voucherStatus').val(voucher.status);
            $('#voucherReviewer').val(voucher.reviewer || (currentUser ? currentUser.email : ''));
          } else {
            showToast('錯誤', response.message || '無法載入支出憑證資料');
          }
        });
      } else {
        // 設定預設值
        $('#voucherDate').val(formatDate(new Date()));
      }
      
      // 註冊儲存按鈕事件
      $('#saveButton').off('click').on('click', function() {
        saveVoucher();
      });
      
      // 顯示模態框
      formModal.show();
    }
    
    // 儲存支出憑證
    function saveVoucher() {
      // 表單驗證
      if (!$('#voucherForm')[0].checkValidity()) {
        $('#voucherForm')[0].reportValidity();
        return;
      }
      
      const voucherData = {
        id: $('#voucherId').val(),
        date: $('#voucherDate').val(),
        applicant: $('#voucherApplicant').val(),
        category: $('#voucherCategory').val(),
        amount: parseFloat($('#voucherAmount').val()),
        purpose: $('#voucherPurpose').val(),
        remarks: $('#voucherRemarks').val(),
        status: $('#voucherStatus').val(),
        reviewer: $('#voucherReviewer').val()
      };
      
      callApi('saveVoucher', voucherData, function(response) {
        if (response.success) {
          formModal.hide();
          showToast('成功', response.message || '支出憑證已儲存');
          loadVoucherData();
        } else {
          showToast('錯誤', response.message || '儲存支出憑證失敗');
        }
      });
    }
    
    // 編輯支出憑證
    function editVoucher(id) {
      showVoucherForm(id);
    }
    
    // 刪除支出憑證
    function deleteVoucher(id) {
      $('#confirmTitle').text('確認刪除');
      $('#confirmBody').text('您確定要刪除此支出憑證嗎？此操作無法復原。');
      
      $('#confirmButton').off('click').on('click', function() {
        callApi('deleteVoucher', { id: id }, function(response) {
          confirmModal.hide();
          
          if (response.success) {
            showToast('成功', response.message || '支出憑證已刪除');
            loadVoucherData();
          } else {
            showToast('錯誤', response.message || '刪除支出憑證失敗');
          }
        });
      });
      
      confirmModal.show();
    }
    
    // 核准支出憑證
    function approveVoucher(id) {
      callApi('getVoucher', { id: id }, function(response) {
        if (response.success && response.data) {
          const voucher = response.data;
          voucher.status = '已核准';
          voucher.reviewer = currentUser ? currentUser.email : '';
          
          callApi('saveVoucher', voucher, function(saveResponse) {
            if (saveResponse.success) {
              showToast('成功', '支出憑證已核准');
              loadVoucherData();
            } else {
              showToast('錯誤', saveResponse.message || '核准支出憑證失敗');
            }
          });
        } else {
          showToast('錯誤', response.message || '無法載入支出憑證資料');
        }
      });
    }
    
    // 拒絕支出憑證
    function rejectVoucher(id) {
      callApi('getVoucher', { id: id }, function(response) {
        if (response.success && response.data) {
          const voucher = response.data;
          voucher.status = '已拒絕';
          voucher.reviewer = currentUser ? currentUser.email : '';
          
          callApi('saveVoucher', voucher, function(saveResponse) {
            if (saveResponse.success) {
              showToast('成功', '支出憑證已拒絕');
              loadVoucherData();
            } else {
              showToast('錯誤', saveResponse.message || '拒絕支出憑證失敗');
            }
          });
        } else {
          showToast('錯誤', response.message || '無法載入支出憑證資料');
        }
      });
    }
    
    // 載入會員管理頁面
    function loadMembers() {
      $('#pageContent').html(`
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">會員管理</h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <button type="button" class="btn btn-sm btn-outline-primary" id="addMemberBtn">
              <i class="fas fa-plus"></i> 新增會員
            </button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="row">
              <div class="col-md-8">
                <div class="input-group">
                  <input type="text" class="form-control" id="memberSearch" placeholder="搜尋會員...">
                  <button class="btn btn-outline-secondary" type="button" id="searchMemberBtn">
                    <i class="fas fa-search"></i> 搜尋
                  </button>
                </div>
              </div>
              <div class="col-md-4">
                <div class="d-flex justify-content-end">
                  <select class="form-select me-2" id="memberTypeFilter">
                    <option value="">所有類型</option>
                    <option value="一般會員">一般會員</option>
                    <option value="永久會員">永久會員</option>
                    <option value="贊助會員">贊助會員</option>
                    <option value="團體會員">團體會員</option>
                  </select>
                  <select class="form-select" id="memberStatusFilter">
                    <option value="">所有狀態</option>
                    <option value="有效">有效</option>
                    <option value="過期">過期</option>
                    <option value="停權">停權</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover" id="membersTable">
                <thead>
                  <tr>
                    <th>會員編號</th>
                    <th>姓名</th>
                    <th>會員類型</th>
                    <th>電話</th>
                    <th>加入日期</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="7" class="text-center">載入中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `);
      
      // 載入會員類型選項
      let memberTypes = '一般會員,永久會員,贊助會員,團體會員';
      
      if (systemSettings.member_types) {
        memberTypes = systemSettings.member_types.value;
      }
      
      const memberTypeOptions = memberTypes.split(',').map(type => 
        `<option value="${type.trim()}">${type.trim()}</option>`
      ).join('');
      
      $('#memberTypeFilter').html('<option value="">所有類型</option>' + memberTypeOptions);
      
      // 註冊新增會員按鈕事件
      $('#addMemberBtn').click(function() {
        showMemberForm();
      });
      
      // 註冊搜尋按鈕事件
      $('#searchMemberBtn').click(function() {
        loadMemberData();
      });
      
      // 註冊過濾器變更事件
      $('#memberTypeFilter, #memberStatusFilter').change(function() {
        loadMemberData();
      });
      
      // 載入會員資料
      loadMemberData();
    }
    
    // 載入會員資料
    function loadMemberData() {
      const search = $('#memberSearch').val();
      const typeFilter = $('#memberTypeFilter').val();
      const statusFilter = $('#memberStatusFilter').val();
      
      const filters = {
        search: search,
        memberType: typeFilter,
        status: statusFilter
      };
      
      callApi('getMembers', filters, function(response) {
        if (response.success) {
          const members = response.data;
          let tableHtml = '';
          
          if (members.length === 0) {
            tableHtml = '<tr><td colspan="7" class="text-center">沒有符合條件的會員資料</td></tr>';
          } else {
            members.forEach(function(member) {
              const statusClass = member.status === '有效' ? 'text-success' : 
                               (member.status === '過期' ? 'text-warning' : 'text-danger');
              
              tableHtml += `
                <tr>
                  <td>${member.memberNumber}</td>
                  <td>${member.name}</td>
                  <td>${member.memberType}</td>
                  <td>${member.phone || '-'}</td>
                  <td>${formatDate(member.joinDate)}</td>
                  <td class="${statusClass}">${member.status}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary btn-action" onclick="editMember('${member.id}')">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteMember('${member.id}')">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              `;
            });
          }
          
          $('#membersTable tbody').html(tableHtml);
          
          // 初始化 DataTable
          if ($.fn.DataTable.isDataTable('#membersTable')) {
            $('#membersTable').DataTable().destroy();
          }
          
          $('#membersTable').DataTable({
            language: {
              url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/zh-HANT.json'
            },
            paging: true,
            searching: false,
            ordering: true,
            info: true,
            pageLength: 10,
            lengthChange: false
          });
        } else {
          showToast('錯誤', response.message || '無法載入會員資料');
        }
      });
    }
    
    // 顯示會員表單
    function showMemberForm(id = null) {
      $('#modalTitle').text(id ? '編輯會員資料' : '新增會員');
      
      // 載入會員類型選項
      let memberTypes = '一般會員,永久會員,贊助會員,團體會員';
      
      if (systemSettings.member_types) {
        memberTypes = systemSettings.member_types.value;
      }
      
      const memberTypeOptions = memberTypes.split(',').map(type => 
        `<option value="${type.trim()}">${type.trim()}</option>`
      ).join('');
      
      // 建立表單
      $('#modalBody').html(`
        <form id="memberForm">
          <input type="hidden" id="memberId" value="${id || ''}">
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="memberName" class="form-label form-required">姓名</label>
              <input type="text" class="form-control" id="memberName" required>
            </div>
            <div class="col-md-6">
              <label for="memberGender" class="form-label">性別</label>
              <select class="form-select" id="memberGender">
                <option value="">未指定</option>
                <option value="男">男</option>
                <option value="女">女</option>
                <option value="其他">其他</option>
              </select>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="memberBirthDate" class="form-label">生日</label>
              <input type="text" class="form-control datepicker" id="memberBirthDate">
            </div>
            <div class="col-md-6">
              <label for="memberIdNumber" class="form-label">身份證字號</label>
              <input type="text" class="form-control" id="memberIdNumber">
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="memberPhone" class="form-label">電話</label>
              <input type="text" class="form-control" id="memberPhone">
            </div>
            <div class="col-md-6">
              <label for="memberEmail" class="form-label">電子郵件</label>
              <input type="email" class="form-control" id="memberEmail">
            </div>
          </div>
          
          <div class="mb-3">
            <label for="memberAddress" class="form-label">地址</label>
            <input type="text" class="form-control" id="memberAddress">
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="memberType" class="form-label form-required">會員類型</label>
              <select class="form-select" id="memberType" required>
                ${memberTypeOptions}
              </select>
            </div>
            <div class="col-md-6">
              <label for="memberStatus" class="form-label form-required">狀態</label>
              <select class="form-select" id="memberStatus" required>
                <option value="有效">有效</option>
                <option value="過期">過期</option>
                <option value="停權">停權</option>
              </select>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="memberJoinDate" class="form-label form-required">加入日期</label>
              <input type="text" class="form-control datepicker" id="memberJoinDate" required>
            </div>
            <div class="col-md-6">
              <label for="memberExpiryDate" class="form-label">到期日期</label>
              <input type="text" class="form-control datepicker" id="memberExpiryDate">
            </div>
          </div>
          
          <div class="mb-3">
            <label for="memberRemarks" class="form-label">備註</label>
            <textarea class="form-control" id="memberRemarks" rows="3"></textarea>
          </div>
        </form>
      `);
      
      // 初始化日期選擇器
      initDatePickers();
      
      // 如果是編輯，載入會員資料
      if (id) {
        callApi('getMember', { id: id }, function(response) {
          if (response.success && response.data) {
            const member = response.data;
            
            $('#memberName').val(member.name);
            $('#memberGender').val(member.gender);
            $('#memberBirthDate').val(member.birthDate ? formatDate(member.birthDate) : '');
            $('#memberIdNumber').val(member.idNumber);
            $('#memberPhone').val(member.phone);
            $('#memberEmail').val(member.email);
            $('#memberAddress').val(member.address);
            $('#memberType').val(member.memberType);
            $('#memberStatus').val(member.status);
            $('#memberJoinDate').val(formatDate(member.joinDate));
            $('#memberExpiryDate').val(member.expiryDate ? formatDate(member.expiryDate) : '');
            $('#memberRemarks').val(member.remarks);
          } else {
            showToast('錯誤', response.message || '無法載入會員資料');
          }
        });
      } else {
        // 設定預設值
        $('#memberJoinDate').val(formatDate(new Date()));
        $('#memberStatus').val('有效');
      }
      
      // 註冊儲存按鈕事件
      $('#saveButton').off('click').on('click', function() {
        saveMember();
      });
      
      // 顯示模態框
      formModal.show();
    }
    
    // 儲存會員資料
    function saveMember() {
      // 表單驗證
      if (!$('#memberForm')[0].checkValidity()) {
        $('#memberForm')[0].reportValidity();
        return;
      }
      
      const memberData = {
        id: $('#memberId').val(),
        name: $('#memberName').val(),
        gender: $('#memberGender').val(),
        birthDate: $('#memberBirthDate').val(),
        idNumber: $('#memberIdNumber').val(),
        phone: $('#memberPhone').val(),
        email: $('#memberEmail').val(),
        address: $('#memberAddress').val(),
        memberType: $('#memberType').val(),
        status: $('#memberStatus').val(),
        joinDate: $('#memberJoinDate').val(),
        expiryDate: $('#memberExpiryDate').val(),
        remarks: $('#memberRemarks').val()
      };
      
      callApi('saveMember', memberData, function(response) {
        if (response.success) {
          formModal.hide();
          showToast('成功', response.message || '會員資料已儲存');
          loadMemberData();
        } else {
          showToast('錯誤', response.message || '儲存會員資料失敗');
        }
      });
    }
    
    // 編輯會員資料
    function editMember(id) {
      showMemberForm(id);
    }
    
    // 刪除會員資料
    function deleteMember(id) {
      $('#confirmTitle').text('確認刪除');
      $('#confirmBody').text('您確定要刪除此會員資料嗎？此操作無法復原。');
      
      $('#confirmButton').off('click').on('click', function() {
        callApi('deleteMember', { id: id }, function(response) {
          confirmModal.hide();
          
          if (response.success) {
            showToast('成功', response.message || '會員資料已刪除');
            loadMemberData();
          } else {
            showToast('錯誤', response.message || '刪除會員資料失敗');
          }
        });
      });
      
      confirmModal.show();
    }
    
    // 載入報表分析頁面
    function loadReports() {
      $('#pageContent').html(`
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">報表分析</h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
              <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-file-export"></i> 匯出
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" id="exportTransactionsBtn">交易記錄報表</a></li>
                <li><a class="dropdown-item" href="#" id="exportDonationsBtn">捐款報表</a></li>
                <li><a class="dropdown-item" href="#" id="exportMembersBtn">會員報表</a></li>
              </ul>
            </div>
          </div>
        </div>
        
        <ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="income-expense-tab" data-bs-toggle="tab" data-bs-target="#income-expense-content" type="button" role="tab" aria-controls="income-expense-content" aria-selected="true">收支餘絀表</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="donation-tab" data-bs-toggle="tab" data-bs-target="#donation-content" type="button" role="tab" aria-controls="donation-content" aria-selected="false">捐款統計</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="member-tab" data-bs-toggle="tab" data-bs-target="#member-content" type="button" role="tab" aria-controls="member-content" aria-selected="false">會員統計</button>
          </li>
        </ul>
        
        <div class="tab-content" id="reportTabContent">
          <div class="tab-pane fade show active" id="income-expense-content" role="tabpanel" aria-labelledby="income-expense-tab">
            <div class="card mb-4">
              <div class="card-header">
                <div class="row">
                  <div class="col-md-6">
                    <h5>收支餘絀表</h5>
                  </div>
                  <div class="col-md-6 text-end">
                    <div class="input-group input-group-sm" style="max-width: 300px; float: right;">
                      <label class="input-group-text" for="incomeExpenseYear">年度</label>
                      <select class="form-select" id="incomeExpenseYear">
                        <!-- 年份選項將動態載入 -->
                      </select>
                      <label class="input-group-text" for="incomeExpenseMonth">月份</label>
                      <select class="form-select" id="incomeExpenseMonth">
                        <option value="">全年</option>
                        <option value="1">1月</option>
                        <option value="2">2月</option>
                        <option value="3">3月</option>
                        <option value="4">4月</option>
                        <option value="5">5月</option>
                        <option value="6">6月</option>
                        <option value="7">7月</option>
                        <option value="8">8月</option>
                        <option value="9">9月</option>
                        <option value="10">10月</option>
                        <option value="11">11月</option>
                        <option value="12">12月</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="row mb-4">
                  <div class="col-md-4">
                    <div class="card dashboard-card">
                      <div class="card-body">
                        <div class="card-value" id="reportTotalIncome">--</div>
                        <div class="card-title">總收入</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card dashboard-card">
                      <div class="card-body">
                        <div class="card-value" id="reportTotalExpense">--</div>
                        <div class="card-title">總支出</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card dashboard-card">
                      <div class="card-body">
                        <div class="card-value" id="reportBalance">--</div>
                        <div class="card-title">收支餘絀</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-md-6">
                    <h5>收入類別分佈</h5>
                    <canvas id="reportIncomeChart"></canvas>
                  </div>
                  <div class="col-md-6">
                    <h5>支出類別分佈</h5>
                    <canvas id="reportExpenseChart"></canvas>
                  </div>
                </div>
                
                <div class="row mt-4" id="monthlyChartContainer">
                  <div class="col-12">
                    <h5>月度收支趨勢</h5>
                    <canvas id="reportMonthlyChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="tab-pane fade" id="donation-content" role="tabpanel" aria-labelledby="donation-tab">
            <div class="card mb-4">
              <div class="card-header">
                <div class="row">
                  <div class="col-md-6">
                    <h5>捐款統計報表</h5>
                  </div>
                  <div class="col-md-6 text-end">
                    <div class="input-group input-group-sm" style="max-width: 200px; float: right;">
                      <label class="input-group-text" for="donationYear">年度</label>
                      <select class="form-select" id="donationYear">
                        <!-- 年份選項將動態載入 -->
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="row mb-4">
                  <div class="col-md-4">
                    <div class="card dashboard-card">
                      <div class="card-body">
                        <div class="card-value" id="totalDonation">--</div>
                        <div class="card-title">總捐款金額</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card dashboard-card">
                      <div class="card-body">
                        <div class="card-value" id="donorCount">--</div>
                        <div class="card-title">捐款人次</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card dashboard-card">
                      <div class="card-body">
                        <div class="card-value" id="receiptCount">--</div>
                        <div class="card-title">收據數量</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-md-6">
                    <h5>捐款類別分佈</h5>
                    <canvas id="donationCategoryChart"></canvas>
                  </div>
                  <div class="col-md-6">
                    <h5>捐款金額區間分佈</h5>
                    <canvas id="donationAmountRangeChart"></canvas>
                  </div>
                </div>
                
                <div class="row mt-4">
                  <div class="col-12">
                    <h5>月度捐款趨勢</h5>
                    <canvas id="monthlyDonationChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="tab-pane fade" id="member-content" role="tabpanel" aria-labelledby="member-tab">
            <div class="card mb-4">
              <div class="card-header">
                <h5>會員統計報表</h5>
              </div>
              <div class="card-body">
                <div class="row mb-4">
                  <div class="col-md-4">
                    <div class="card dashboard-card">
                      <div class="card-body">
                        <div class="card-value" id="totalMembers">--</div>
                        <div class="card-title">總會員數</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card dashboard-card">
                      <div class="card-body">
                        <div class="card-value" id="activeMembers">--</div>
                        <div class="card-title">有效會員數</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card dashboard-card">
                      <div class="card-body">
                        <div class="card-value" id="expiredMembers">--</div>
                        <div class="card-title">過期會員數</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-md-6">
                    <h5>會員類型分佈</h5>
                    <canvas id="memberTypeChart"></canvas>
                  </div>
                  <div class="col-md-6">
                    <h5>會員性別分佈</h5>
                    <canvas id="memberGenderChart"></canvas>
                  </div>
                </div>
                
                <div class="row mt-4">
                  <div class="col-md-6">
                    <h5>會員年齡分佈</h5>
                    <canvas id="memberAgeChart"></canvas>
                  </div>
                  <div class="col-md-6">
                    <h5>會員加入年度統計</h5>
                    <canvas id="memberJoinYearChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `);
      
      // 載入年份選項
      const currentYear = new Date().getFullYear();
      let yearOptions = '';
      for (let year = currentYear; year >= currentYear - 5; year--) {
        yearOptions += `<option value="${year}">${year}年</option>`;
      }
      
      $('#incomeExpenseYear').html(yearOptions);
      $('#donationYear').html(yearOptions);
      
      // 註冊年份和月份變更事件
      $('#incomeExpenseYear, #incomeExpenseMonth').change(function() {
        loadIncomeExpenseReport();
      });
      
      $('#donationYear').change(function() {
        loadDonationReport();
      });
      
      // 註冊匯出按鈕事件
      $('#exportTransactionsBtn').click(function() {
        exportReport('transactions');
      });
      
      $('#exportDonationsBtn').click(function() {
        exportReport('donations');
      });
      
      $('#exportMembersBtn').click(function() {
        exportReport('members');
      });
      
      // 載入初始報表
      loadIncomeExpenseReport();
      
      // 註冊標籤頁切換事件
      $('#reportTabs button').on('shown.bs.tab', function(e) {
        const target = $(e.target).attr('id');
        
        if (target === 'income-expense-tab') {
          loadIncomeExpenseReport();
        } else if (target === 'donation-tab') {
          loadDonationReport();
        } else if (target === 'member-tab') {
          loadMemberReport();
        }
      });
    }
    
    // 載入收支餘絀報表
    function loadIncomeExpenseReport() {
      const year = $('#incomeExpenseYear').val();
      const month = $('#incomeExpenseMonth').val();
      
      callApi('getIncomeExpenseReport', { year: year, month: month }, function(response) {
        if (response.success) {
          const data = response.data;
          
          // 更新統計卡片
          $('#reportTotalIncome').text('NT$ ' + formatAmount(data.totalIncome));
          $('#reportTotalExpense').text('NT$ ' + formatAmount(data.totalExpense));
          
          const balance = data.balance;
          $('#reportBalance').text('NT$ ' + formatAmount(Math.abs(balance)));
          if (balance < 0) {
            $('#reportBalance').addClass('text-danger');
          } else {
            $('#reportBalance').addClass('text-success');
          }
          
          // 繪製收入類別圓餅圖
          const incomeCategories = Object.keys(data.incomeByCategory);
          const incomeCategoryValues = Object.values(data.incomeByCategory);
          
          if (window.reportIncomeChart) {
            window.reportIncomeChart.destroy();
          }
          
          window.reportIncomeChart = new Chart(document.getElementById('reportIncomeChart'), {
            type: 'pie',
            data: {
              labels: incomeCategories,
              datasets: [{
                data: incomeCategoryValues,
                backgroundColor: [
                  'rgba(75, 192, 192, 0.5)',
                  'rgba(54, 162, 235, 0.5)',
                  'rgba(153, 102, 255, 0.5)',
                  'rgba(255, 205, 86, 0.5)',
                  'rgba(255, 159, 64, 0.5)',
                  'rgba(201, 203, 207, 0.5)'
                ],
                borderColor: [
                  'rgba(75, 192, 192, 1)',
                  'rgba(54, 162, 235, 1)',
                  'rgba(153, 102, 255, 1)',
                  'rgba(255, 205, 86, 1)',
                  'rgba(255, 159, 64, 1)',
                  'rgba(201, 203, 207, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'right'
                }
              }
            }
          });
          
          // 繪製支出類別圓餅圖
          const expenseCategories = Object.keys(data.expenseByCategory);
          const expenseCategoryValues = Object.values(data.expenseByCategory);
          
          if (window.reportExpenseChart) {
            window.reportExpenseChart.destroy();
          }
          
          window.reportExpenseChart = new Chart(document.getElementById('reportExpenseChart'), {
            type: 'pie',
            data: {
              labels: expenseCategories,
              datasets: [{
                data: expenseCategoryValues,
                backgroundColor: [
                  'rgba(255, 99, 132, 0.5)',
                  'rgba(255, 159, 64, 0.5)',
                  'rgba(255, 205, 86, 0.5)',
                  'rgba(75, 192, 192, 0.5)',
                  'rgba(54, 162, 235, 0.5)',
                  'rgba(153, 102, 255, 0.5)'
                ],
                borderColor: [
                  'rgba(255, 99, 132, 1)',
                  'rgba(255, 159, 64, 1)',
                  'rgba(255, 205, 86, 1)',
                  'rgba(75, 192, 192, 1)',
                  'rgba(54, 162, 235, 1)',
                  'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'right'
                }
              }
            }
          });
          
          // 如果是查詢整年度，顯示月度趨勢圖
          if (!month && data.monthlyData) {
            $('#monthlyChartContainer').show();
            
            const monthlyLabels = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            const monthlyIncomeData = data.monthlyData.map(m => m.income);
            const monthlyExpenseData = data.monthlyData.map(m => m.expense);
            
            if (window.reportMonthlyChart) {
              window.reportMonthlyChart.destroy();
            }
            
            window.reportMonthlyChart = new Chart(document.getElementById('reportMonthlyChart'), {
              type: 'bar',
              data: {
                labels: monthlyLabels,
                datasets: [
                  {
                    label: '收入',
                    data: monthlyIncomeData,
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                  },
                  {
                    label: '支出',
                    data: monthlyExpenseData,
                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                  }
                ]
              },
              options: {
                responsive: true,
                scales: {
                  y: {
                    beginAtZero: true
                  }
                }
              }
            });
          } else {
            $('#monthlyChartContainer').hide();
          }
        } else {
          showToast('錯誤', response.message || '無法載入收支餘絀報表');
        }
      });
    }
    
    // 載入捐款統計報表
    function loadDonationReport() {
      const year = $('#donationYear').val();
      
      callApi('getDonationReport', { year: year }, function(response) {
        if (response.success) {
          const data = response.data;
          
          // 更新統計卡片
          $('#totalDonation').text('NT$ ' + formatAmount(data.totalDonation));
          $('#donorCount').text(data.donorCount);
          $('#receiptCount').text(data.receiptCount);
          
          // 繪製捐款類別圓餅圖
          const donationCategories = Object.keys(data.donationByCategory);
          const donationCategoryValues = Object.values(data.donationByCategory);
          
          if (window.donationCategoryChart) {
            window.donationCategoryChart.destroy();
          }
          
          window.donationCategoryChart = new Chart(document.getElementById('donationCategoryChart'), {
            type: 'pie',
            data: {
              labels: donationCategories,
              datasets: [{
                data: donationCategoryValues,
                backgroundColor: [
                  'rgba(75, 192, 192, 0.5)',
                  'rgba(54, 162, 235, 0.5)',
                  'rgba(153, 102, 255, 0.5)',
                  'rgba(255, 205, 86, 0.5)',
                  'rgba(255, 159, 64, 0.5)'
                ],
                borderColor: [
                  'rgba(75, 192, 192, 1)',
                  'rgba(54, 162, 235, 1)',
                  'rgba(153, 102, 255, 1)',
                  'rgba(255, 205, 86, 1)',
                  'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'right'
                }
              }
            }
          });
          
          // 繪製捐款金額區間圓餅圖
          const amountRangeLabels = Object.keys(data.amountRanges);
          const amountRangeValues = Object.values(data.amountRanges);
          
          if (window.donationAmountRangeChart) {
            window.donationAmountRangeChart.destroy();
          }
          
          window.donationAmountRangeChart = new Chart(document.getElementById('donationAmountRangeChart'), {
            type: 'pie',
            data: {
              labels: amountRangeLabels,
              datasets: [{
                data: amountRangeValues,
                backgroundColor: [
                  'rgba(255, 99, 132, 0.5)',
                  'rgba(255, 159, 64, 0.5)',
                  'rgba(255, 205, 86, 0.5)',
                  'rgba(75, 192, 192, 0.5)',
                  'rgba(54, 162, 235, 0.5)',
                  'rgba(153, 102, 255, 0.5)'
                ],
                borderColor: [
                  'rgba(255, 99, 132, 1)',
                  'rgba(255, 159, 64, 1)',
                  'rgba(255, 205, 86, 1)',
                  'rgba(75, 192, 192, 1)',
                  'rgba(54, 162, 235, 1)',
                  'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'right'
                }
              }
            }
          });
          
          // 繪製月度捐款趨勢圖
          const monthlyLabels = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
          
          if (window.monthlyDonationChart) {
            window.monthlyDonationChart.destroy();
          }
          
          window.monthlyDonationChart = new Chart(document.getElementById('monthlyDonationChart'), {
            type: 'bar',
            data: {
              labels: monthlyLabels,
              datasets: [
                {
                  label: '捐款金額',
                  data: data.monthlyDonation,
                  backgroundColor: 'rgba(75, 192, 192, 0.5)',
                  borderColor: 'rgba(75, 192, 192, 1)',
                  borderWidth: 1
                }
              ]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        } else {
          showToast('錯誤', response.message || '無法載入捐款統計報表');
        }
      });
    }
    
    // 載入會員統計報表
    function loadMemberReport() {
      callApi('getMemberReport', null, function(response) {
        if (response.success) {
          const data = response.data;
          
          // 更新統計卡片
          $('#totalMembers').text(data.total);
          $('#activeMembers').text(data.status['有效'] || 0);
          $('#expiredMembers').text(data.status['過期'] || 0);
          
          // 繪製會員類型圓餅圖
          const memberTypes = Object.keys(data.memberTypes);
          const memberTypeCounts = Object.values(data.memberTypes);
          
          if (window.memberTypeChart) {
            window.memberTypeChart.destroy();
          }
          
          window.memberTypeChart = new Chart(document.getElementById('memberTypeChart'), {
            type: 'pie',
            data: {
              labels: memberTypes,
              datasets: [{
                data: memberTypeCounts,
                backgroundColor: [
                  'rgba(54, 162, 235, 0.5)',
                  'rgba(75, 192, 192, 0.5)',
                  'rgba(153, 102, 255, 0.5)',
                  'rgba(255, 205, 86, 0.5)'
                ],
                borderColor: [
                  'rgba(54, 162, 235, 1)',
                  'rgba(75, 192, 192, 1)',
                  'rgba(153, 102, 255, 1)',
                  'rgba(255, 205, 86, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'right'
                }
              }
            }
          });
          
          // 繪製會員性別圓餅圖
          const genderLabels = Object.keys(data.gender);
          const genderValues = Object.values(data.gender);
          
          if (window.memberGenderChart) {
            window.memberGenderChart.destroy();
          }
          
          window.memberGenderChart = new Chart(document.getElementById('memberGenderChart'), {
            type: 'pie',
            data: {
              labels: genderLabels,
              datasets: [{
                data: genderValues,
                backgroundColor: [
                  'rgba(54, 162, 235, 0.5)',
                  'rgba(255, 99, 132, 0.5)',
                  'rgba(255, 205, 86, 0.5)'
                ],
                borderColor: [
                  'rgba(54, 162, 235, 1)',
                  'rgba(255, 99, 132, 1)',
                  'rgba(255, 205, 86, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'right'
                }
              }
            }
          });
          
          // 繪製會員年齡分佈圖
          const ageLabels = Object.keys(data.ageRanges);
          const ageValues = Object.values(data.ageRanges);
          
          if (window.memberAgeChart) {
            window.memberAgeChart.destroy();
          }
          
          window.memberAgeChart = new Chart(document.getElementById('memberAgeChart'), {
            type: 'bar',
            data: {
              labels: ageLabels,
              datasets: [{
                label: '會員數',
                data: ageValues,
                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
          
          // 繪製會員加入年度統計圖
          const joinYearLabels = Object.keys(data.joinYears);
          const joinYearValues = Object.values(data.joinYears);
          
          if (window.memberJoinYearChart) {
            window.memberJoinYearChart.destroy();
          }
          
          window.memberJoinYearChart = new Chart(document.getElementById('memberJoinYearChart'), {
            type: 'line',
            data: {
              labels: joinYearLabels,
              datasets: [{
                label: '新增會員數',
                data: joinYearValues,
                backgroundColor: 'rgba(153, 102, 255, 0.5)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 2,
                tension: 0.1
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        } else {
          showToast('錯誤', response.message || '無法載入會員統計報表');
        }
      });
    }
    
    // 匯出報表
    function exportReport(reportType) {
      let params = {};
      
      if (reportType === 'transactions') {
        params = {
          year: $('#incomeExpenseYear').val(),
          month: $('#incomeExpenseMonth').val()
        };
      } else if (reportType === 'donations') {
        params = {
          year: $('#donationYear').val()
        };
      }
      
      callApi('exportReportCSV', { reportType: reportType, params: params }, function(response) {
        if (response.success) {
          // 建立下載連結
          const blob = new Blob([response.data.content], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = response.data.filename;
          link.style.display = 'none';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          showToast('成功', '報表已匯出');
        } else {
          showToast('錯誤', response.message || '匯出報表失敗');
        }
      });
    }
    
    // 載入系統設定頁面
    function loadSettings() {
      $('#pageContent').html(`
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">系統設定</h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <button type="button" class="btn btn-sm btn-outline-primary" id="backupDataBtn">
              <i class="fas fa-download"></i> 備份資料
            </button>
          </div>
        </div>
        
        <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general-content" type="button" role="tab" aria-controls="general-content" aria-selected="true">一般設定</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="category-tab" data-bs-toggle="tab" data-bs-target="#category-content" type="button" role="tab" aria-controls="category-content" aria-selected="false">類別設定</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs-content" type="button" role="tab" aria-controls="logs-content" aria-selected="false">系統日誌</button>
          </li>
        </ul>
        
        <div class="tab-content" id="settingsTabContent">
          <div class="tab-pane fade show active" id="general-content" role="tabpanel" aria-labelledby="general-tab">
            <div class="card mb-4">
              <div class="card-header">
                <h5>一般設定</h5>
              </div>
              <div class="card-body">
                <form id="generalSettingsForm">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="orgName" class="form-label">組織名稱</label>
                      <input type="text" class="form-control" id="orgName" name="org_name">
                    </div>
                    <div class="col-md-6">
                      <label for="fiscalYearStart" class="form-label">會計年度開始月份</label>
                      <select class="form-select" id="fiscalYearStart" name="fiscal_year_start">
                        <option value="1">1月</option>
                        <option value="2">2月</option>
                        <option value="3">3月</option>
                        <option value="4">4月</option>
                        <option value="5">5月</option>
                        <option value="6">6月</option>
                        <option value="7">7月</option>
                        <option value="8">8月</option>
                        <option value="9">9月</option>
                        <option value="10">10月</option>
                        <option value="11">11月</option>
                        <option value="12">12月</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label for="receiptPrefix" class="form-label">收據編號前綴</label>
                      <input type="text" class="form-control" id="receiptPrefix" name="receipt_prefix">
                    </div>
                    <div class="col-md-4">
                      <label for="voucherPrefix" class="form-label">憑證編號前綴</label>
                      <input type="text" class="form-control" id="voucherPrefix" name="voucher_prefix">
                    </div>
                    <div class="col-md-4">
                      <label for="memberPrefix" class="form-label">會員編號前綴</label>
                      <input type="text" class="form-control" id="memberPrefix" name="member_prefix">
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="adminEmails" class="form-label">管理員電子郵件 (逗號分隔)</label>
                      <input type="text" class="form-control" id="adminEmails" name="admin_emails">
                    </div>
                    <div class="col-md-6">
                      <label for="cacheTimeout" class="form-label">快取有效時間 (秒)</label>
                      <input type="number" class="form-control" id="cacheTimeout" name="cache_timeout" min="0">
                    </div>
                  </div>
                  
                  <div class="text-end">
                    <button type="button" class="btn btn-primary" id="saveGeneralSettingsBtn">儲存設定</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          
          <div class="tab-pane fade" id="category-content" role="tabpanel" aria-labelledby="category-tab">
            <div class="card mb-4">
              <div class="card-header">
                <h5>類別設定</h5>
              </div>
              <div class="card-body">
                <form id="categorySettingsForm">
                  <div class="mb-3">
                    <label for="incomeCategories" class="form-label">收入類別 (逗號分隔)</label>
                    <textarea class="form-control" id="incomeCategories" name="default_categories_income" rows="3"></textarea>
                  </div>
                  
                  <div class="mb-3">
                    <label for="expenseCategories" class="form-label">支出類別 (逗號分隔)</label>
                    <textarea class="form-control" id="expenseCategories" name="default_categories_expense" rows="3"></textarea>
                  </div>
                  
                  <div class="mb-3">
                    <label for="memberTypes" class="form-label">會員類型 (逗號分隔)</label>
                    <textarea class="form-control" id="memberTypes" name="member_types" rows="3"></textarea>
                  </div>
                  
                  <div class="text-end">
                    <button type="button" class="btn btn-primary" id="saveCategorySettingsBtn">儲存設定</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          
          <div class="tab-pane fade" id="logs-content" role="tabpanel" aria-labelledby="logs-tab">
            <div class="card mb-4">
              <div class="card-header">
                <div class="row">
                  <div class="col-md-6">
                    <h5>系統日誌</h5>
                  </div>
                  <div class="col-md-6 text-end">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshLogsBtn">
                      <i class="fas fa-sync-alt"></i> 重新整理
                    </button>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped table-hover" id="logsTable">
                    <thead>
                      <tr>
                        <th>時間</th>
                        <th>操作</th>
                        <th>描述</th>
                        <th>使用者</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="4" class="text-center">載入中...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      `);
      
      // 載入系統設定
      callApi('getSettings', null, function(response) {
        if (response.success) {
          const settings = response.data;
          
          // 填入一般設定
          $('#orgName').val(settings.org_name ? settings.org_name.value : '');
          $('#fiscalYearStart').val(settings.fiscal_year_start ? settings.fiscal_year_start.value : '1');
          $('#receiptPrefix').val(settings.receipt_prefix ? settings.receipt_prefix.value : '');
          $('#voucherPrefix').val(settings.voucher_prefix ? settings.voucher_prefix.value : '');
          $('#memberPrefix').val(settings.member_prefix ? settings.member_prefix.value : '');
          $('#adminEmails').val(settings.admin_emails ? settings.admin_emails.value : '');
          $('#cacheTimeout').val(settings.cache_timeout ? settings.cache_timeout.value : '300');
          
          // 填入類別設定
          $('#incomeCategories').val(settings.default_categories_income ? settings.default_categories_income.value : '');
          $('#expenseCategories').val(settings.default_categories_expense ? settings.default_categories_expense.value : '');
          $('#memberTypes').val(settings.member_types ? settings.member_types.value : '');
        } else {
          showToast('錯誤', response.message || '無法載入系統設定');
        }
      });
      
      // 載入系統日誌
      loadSystemLogs();
      
      // 註冊儲存一般設定按鈕事件
      $('#saveGeneralSettingsBtn').click(function() {
        saveGeneralSettings();
      });
      
      // 註冊儲存類別設定按鈕事件
      $('#saveCategorySettingsBtn').click(function() {
        saveCategorySettings();
      });
      
      // 註冊重新整理日誌按鈕事件
      $('#refreshLogsBtn').click(function() {
        loadSystemLogs();
      });
      
      // 註冊備份資料按鈕事件
      $('#backupDataBtn').click(function() {
        backupData();
      });
    }
    
    // 載入系統日誌
    function loadSystemLogs() {
      callApi('getSystemLogs', { limit: 100 }, function(response) {
        if (response.success) {
          const logs = response.data;
          let tableHtml = '';
          
          if (logs.length === 0) {
            tableHtml = '<tr><td colspan="4" class="text-center">沒有系統日誌記錄</td></tr>';
          } else {
            logs.forEach(function(log) {
              tableHtml += `
                <tr>
                  <td>${formatDate(log.timestamp)} ${new Date(log.timestamp).toLocaleTimeString()}</td>
                  <td>${log.action}</td>
                  <td>${log.description}</td>
                  <td>${log.user || '-'}</td>
                </tr>
              `;
            });
          }
          
          $('#logsTable tbody').html(tableHtml);
          
          // 初始化 DataTable
          if ($.fn.DataTable.isDataTable('#logsTable')) {
            $('#logsTable').DataTable().destroy();
          }
          
          $('#logsTable').DataTable({
            language: {
              url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/zh-HANT.json'
            },
            paging: true,
            searching: true,
            ordering: true,
            order: [[0, 'desc']],
            info: true,
            pageLength: 10,
            lengthChange: false
          });
        } else {
          showToast('錯誤', response.message || '無法載入系統日誌');
        }
      });
    }
    
    // 儲存一般設定
    function saveGeneralSettings() {
      const settings = {
        org_name: $('#orgName').val(),
        fiscal_year_start: $('#fiscalYearStart').val(),
        receipt_prefix: $('#receiptPrefix').val(),
        voucher_prefix: $('#voucherPrefix').val(),
        member_prefix: $('#memberPrefix').val(),
        admin_emails: $('#adminEmails').val(),
        cache_timeout: $('#cacheTimeout').val()
      };
      
      callApi('updateSettings', settings, function(response) {
        if (response.success) {
          showToast('成功', '一般設定已儲存');
          loadSystemSettings(); // 重新載入系統設定
        } else {
          showToast('錯誤', response.message || '儲存一般設定失敗');
        }
      });
    }
    
    // 儲存類別設定
    function saveCategorySettings() {
      const settings = {
        default_categories_income: $('#incomeCategories').val(),
        default_categories_expense: $('#expenseCategories').val(),
        member_types: $('#memberTypes').val()
      };
      
      callApi('updateSettings', settings, function(response) {
        if (response.success) {
          showToast('成功', '類別設定已儲存');
          loadSystemSettings(); // 重新載入系統設定
        } else {
          showToast('錯誤', response.message || '儲存類別設定失敗');
        }
      });
    }
    
    // 備份資料
    function backupData() {
      $('#confirmTitle').text('確認備份');
      $('#confirmBody').text('您確定要備份系統資料嗎？此操作可能需要一些時間。');
      
      $('#confirmButton').off('click').on('click', function() {
        confirmModal.hide();
        
        // 顯示載入中訊息
        showToast('資訊', '正在備份資料，請稍候...');
        
        callApi('backupData', null, function(response) {
          if (response.success) {
            // 建立下載連結
            const blob = new Blob([response.data.content], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = response.data.filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('成功', '資料備份已完成');
          } else {
            showToast('錯誤', response.message || '備份資料失敗');
          }
        });
      });
      
      confirmModal.show();
    }
  </script>
</body>
</html>



