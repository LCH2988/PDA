<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡—é ­Kæ­Œæ´»å‹•å ±åç³»çµ±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            padding-bottom: 60px;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border-radius: 15px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }
        .header h1 {
            font-size: 26px;
            margin-bottom: 8px;
        }
        .header p {
            font-size: 15px;
            opacity: 0.9;
        }
        .event-info {
            background: rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #5a0080;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            border-color: #667eea;
            outline: none;
        }
        .form-group .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .radio-group label {
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .radio-group input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .hidden {
            display: none !important;
        }
        .fee-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .fee-item {
            margin-bottom: 12px;
        }
        .fee-item:last-child {
            margin-bottom: 0;
        }
        .btn {
            display: inline-block;
            padding: 14px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: bold;
            width: 100%;
            text-align: center;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            position: relative;
        }
        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        .close:hover {
            color: #333;
        }
        .modal-header {
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            text-align: center;
        }
        .modal-header h2 {
            color: #5a0080;
            font-size: 22px;
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .modal-footer {
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .preview-message {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #667eea;
            white-space: pre-wrap;
            font-size: 15px;
            line-height: 1.6;
            max-height: 350px;
            overflow-y: auto;
        }
        .status-info {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
        }
        .status-info.status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info.status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-info.status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status-info.status-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-left: 5px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .share-options {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 2px solid #667eea;
        }
        .share-options label {
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        .share-options input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ è¡—é ­Kæ­Œæ´»å‹•å ±åç³»çµ±</h1>
            <p>æ­¡è¿å ±ååƒåŠ è¡—é ­Kæ­Œæ´»å‹•</p>
            <div class="event-info" id="eventInfo">
                <p><strong>æ´»å‹•æ—¥æœŸï¼š</strong><span id="displayDate">è¼‰å…¥ä¸­...</span></p>
                <p><strong>æ´»å‹•æ™‚é–“ï¼š</strong><span id="displayTime">è¼‰å…¥ä¸­...</span></p>
                <p><strong>æ´»å‹•åœ°é»ï¼š</strong><span id="displayLocation">è¼‰å…¥ä¸­...</span></p>
            </div>
        </div>

        <div id="liffStatus" class="status-info status-info">
            <div>è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
        </div>

        <form id="registrationForm">
            <div class="form-group">
                <label>1. èº«åˆ†é¸æ“‡ *</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="identity" value="æ­Œæ‰‹" required>
                        æ­Œæ‰‹
                    </label>
                    <label>
                        <input type="radio" name="identity" value="ç²‰çµ²">
                        ç²‰çµ²
                    </label>
                </div>
                <div class="error-message" id="identity-error">è«‹é¸æ“‡èº«åˆ†</div>
            </div>

            <div class="form-group hidden" id="performerTypeGroup">
                <label>2. è¡¨æ¼”å½¢å¼ *</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="performerType" value="å–®äºº">
                        å–®äºº
                    </label>
                    <label>
                        <input type="radio" name="performerType" value="é›™äºº">
                        é›™äºº
                    </label>
                </div>
                <div class="error-message" id="performerType-error">è«‹é¸æ“‡è¡¨æ¼”å½¢å¼</div>
            </div>

            <div class="form-group">
                <label>3. å§“å A *</label>
                <input type="text" id="nameA" placeholder="è«‹è¼¸å…¥å§“å" required>
                <div class="error-message" id="nameA-error">è«‹è¼¸å…¥å§“å</div>
            </div>

            <div class="form-group hidden" id="nameBGroup">
                <label>å§“å B *</label>
                <input type="text" id="nameB" placeholder="è«‹è¼¸å…¥ç¬¬äºŒä½è¡¨æ¼”è€…å§“å">
                <div class="error-message" id="nameB-error">è«‹è¼¸å…¥ç¬¬äºŒä½è¡¨æ¼”è€…å§“å</div>
            </div>

            <div class="form-group hidden" id="songGroup">
                <label>4. æ­Œæ›²åç¨± *</label>
                <input type="text" id="song" placeholder="è«‹è¼¸å…¥æ­Œæ›²åç¨±">
                <div class="error-message" id="song-error">è«‹è¼¸å…¥æ­Œæ›²åç¨±</div>
            </div>

            <div class="form-group hidden" id="youtubeGroup">
                <label>5. YouTube é€£çµï¼ˆé¸å¡«ï¼‰</label>
                <input type="url" id="youtube" placeholder="https://www.youtube.com/watch?v=...">
                <div class="error-message" id="youtube-error">è«‹è¼¸å…¥æœ‰æ•ˆçš„ YouTube é€£çµ</div>
            </div>

            <div class="form-group">
                <label>6. è²»ç”¨æ˜ç´°</label>
                <div class="fee-section">
                    <div class="fee-item hidden" id="karaokeFeeGroup">
                        <label>a. Kæ­Œè²»ç”¨</label>
                        <input type="number" id="karaokeFee" value="200" min="0"> å…ƒ
                    </div>

                    <div class="fee-item">
                        <label>b. ç”¨é¤è²»ç”¨</label>
                        <select id="mealType">
                            <option value="ä¸ç”¨é¤">ä¸ç”¨é¤ - $0</option>
                            <option value="è‘·é£Ÿ">è‘·é£Ÿ - $150</option>
                            <option value="ç´ é£Ÿ">ç´ é£Ÿ - $150</option>
                        </select>
                    </div>

                    <div class="fee-item">
                        <label>c. è´ŠåŠ© / æ‰“è³è²»ç”¨ï¼ˆè‡ªç”±å¡«å¯«ï¼‰</label>
                        <input type="number" id="donation" value="0" min="0"> å…ƒ
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>7. å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                <textarea id="note" rows="3" placeholder="æœ‰ä»»ä½•ç‰¹æ®Šéœ€æ±‚æˆ–æƒ³èªªçš„è©±ï¼Œè«‹åœ¨æ­¤å¡«å¯«..."></textarea>
            </div>

            <div class="share-options">
                <label>
                    <input type="checkbox" id="shareToGroup" checked>
                    å ±åå®Œæˆå¾Œï¼Œåˆ†äº«é€šçŸ¥åˆ° LINE ç¾¤çµ„
                </label>
            </div>

            <button type="button" class="btn" onclick="validateForm()">ç¢ºèªé€å‡º</button>
        </form>
    </div>

    <!-- é è¦½è¨Šæ¯çš„å½ˆçª— -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('previewModal')">&times;</span>
            <div class="modal-header">
                <h2>ç¢ºèªå ±åè³‡è¨Š</h2>
            </div>
            <div class="modal-body">
                <div class="preview-message" id="preview-message"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="confirmSendBtn" onclick="confirmAndSend()">ç™¼é€åˆ°LINE</button>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸè¨Šæ¯çš„å½ˆçª— -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('successModal')">&times;</span>
            <div class="modal-header">
                <h2>âœ… å ±åæˆåŠŸ</h2>
            </div>
            <div class="modal-body">
                <p id="successMessage" style="text-align: center; font-size: 18px; padding: 20px;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('successModal')">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // ==================== è¨­å®šå€ ====================
        const LIFF_ID = "2001679903-r5VXNe5g";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzySDTobTLFTu0xhWp9su8UCfqQAW9U43z_7Mt9dkhsN64SAsJjcCsGJ-n21BVoRsRLsg/exec";

        // å…¨åŸŸè®Šæ•¸
        let liffReady = false;
        let isSubmitting = false;
        let userProfile = null;
        let liffContext = null;
        let isFromGroup = false;
        let currentEvent = null;
        let currentFormData = {};

        // ==================== LIFF åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('é–‹å§‹ LIFF åˆå§‹åŒ–...');
            
            liff.init({ liffId: LIFF_ID })
                .then(() => {
                    debugLog('LIFF åˆå§‹åŒ–æˆåŠŸ');
                    liffReady = true;
                    updateStatus('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ', 'success');

                    if (liff.isLoggedIn()) {
                        debugLog('ç”¨æˆ¶å·²ç™»å…¥ï¼Œå–å¾—ç”¨æˆ¶è³‡æ–™...');
                        return liff.getProfile();
                    } else {
                        debugLog('ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                        liff.login();
                        return null;
                    }
                })
                .then((profile) => {
                    if (profile) {
                        userProfile = profile;
                        
                        try {
                            liffContext = liff.getContext();
                            debugLog(`LIFF Context: ${JSON.stringify(liffContext)}`);
                            
                            if (liffContext) {
                                isFromGroup = liffContext.type === 'group' || liffContext.type === 'room';
                                debugLog(`æ˜¯å¦å¾ç¾¤çµ„é–‹å•Ÿ: ${isFromGroup}`);
                            }
                        } catch (contextError) {
                            debugLog('ç„¡æ³•å–å¾— Context: ' + contextError.message);
                            isFromGroup = false;
                        }

                        updateStatus(`âœ… ä½¿ç”¨è€…ï¼š${profile.displayName}${isFromGroup ? ' (ç¾¤çµ„)' : ''}`, 'success');
                        updateShareOptions();
                    }

                    // è¼‰å…¥æ´»å‹•è³‡è¨Š
                    loadEventInfo();
                    restoreFormData();
                })
                .catch((err) => {
                    console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', err);
                    debugLog('LIFF åˆå§‹åŒ–å¤±æ•—: ' + err.message);
                    updateStatus('âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹åœ¨ LINE ä¸­é–‹å•Ÿ', 'error');
                });
        });

        // ==================== è¼‰å…¥æ´»å‹•è³‡è¨Š ====================
        async function loadEventInfo() {
            try {
                const response = await fetch(GAS_URL + '?action=getEvent');
                const data = await response.json();

                if (data.success && data.event) {
                    currentEvent = data.event;
                    document.getElementById('displayDate').textContent = data.event.date;
                    document.getElementById('displayTime').textContent = `${data.event.startTime} - ${data.event.endTime}`;
                    document.getElementById('displayLocation').textContent = data.event.location;

                    document.getElementById('karaokeFee').value = data.event.karaokeFee || 200;

                    const mealFee = data.event.mealFee || 150;
                    document.getElementById('mealType').innerHTML = `
                        <option value="ä¸ç”¨é¤">ä¸ç”¨é¤ - $0</option>
                        <option value="è‘·é£Ÿ">è‘·é£Ÿ - $${mealFee}</option>
                        <option value="ç´ é£Ÿ">ç´ é£Ÿ - $${mealFee}</option>
                    `;
                }
            } catch (error) {
                console.error('è¼‰å…¥æ´»å‹•è³‡è¨Šå¤±æ•—:', error);
                debugLog('è¼‰å…¥æ´»å‹•è³‡è¨Šå¤±æ•—: ' + error.message);
            }
        }

        // ==================== è¡¨å–®é‚è¼¯ ====================
        document.querySelectorAll('input[name="identity"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isSinger = this.value === 'æ­Œæ‰‹';
                document.getElementById('performerTypeGroup').classList.toggle('hidden', !isSinger);
                document.getElementById('songGroup').classList.toggle('hidden', !isSinger);
                document.getElementById('youtubeGroup').classList.toggle('hidden', !isSinger);
                document.getElementById('karaokeFeeGroup').classList.toggle('hidden', !isSinger);

                if (!isSinger) {
                    document.getElementById('nameBGroup').classList.add('hidden');
                }
                
                autoSaveForm();
            });
        });

        document.querySelectorAll('input[name="performerType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isDuo = this.value === 'é›™äºº';
                document.getElementById('nameBGroup').classList.toggle('hidden', !isDuo);
                document.getElementById('nameB').required = isDuo;
                
                autoSaveForm();
            });
        });

        // è‡ªå‹•å„²å­˜
        document.querySelectorAll('#registrationForm input, #registrationForm textarea, #registrationForm select').forEach(input => {
            input.addEventListener('change', autoSaveForm);
        });

        // ==================== è¡¨å–®é©—è­‰ ====================
        function validateForm() {
            clearAllFieldErrors();

            const identity = document.querySelector('input[name="identity"]:checked');
            if (!identity) {
                showFieldError('identity', 'è«‹é¸æ“‡èº«åˆ†ï¼ˆæ­Œæ‰‹æˆ–ç²‰çµ²ï¼‰');
                return false;
            }

            const nameA = document.getElementById('nameA').value.trim();
            if (!nameA) {
                showFieldError('nameA', 'è«‹è¼¸å…¥å§“å');
                return false;
            }

            if (identity.value === 'æ­Œæ‰‹') {
                const performerType = document.querySelector('input[name="performerType"]:checked');
                if (!performerType) {
                    showFieldError('performerType', 'è«‹é¸æ“‡è¡¨æ¼”å½¢å¼ï¼ˆå–®äººæˆ–é›™äººï¼‰');
                    return false;
                }

                if (performerType.value === 'é›™äºº') {
                    const nameB = document.getElementById('nameB').value.trim();
                    if (!nameB) {
                        showFieldError('nameB', 'è«‹å¡«å¯«ç¬¬äºŒä½è¡¨æ¼”è€…å§“å');
                        return false;
                    }
                }

                const song = document.getElementById('song').value.trim();
                if (!song) {
                    showFieldError('song', 'è«‹å¡«å¯«æ­Œæ›²åç¨±');
                    return false;
                }

                const youtube = document.getElementById('youtube').value.trim();
                if (youtube && !isValidYouTubeUrl(youtube)) {
                    showFieldError('youtube', 'YouTube é€£çµæ ¼å¼ä¸æ­£ç¢º');
                    return false;
                }
            }

            // æº–å‚™è¡¨å–®è³‡æ–™
            prepareFormData();
            showPreviewModal();
        }

        function isValidYouTubeUrl(url) {
            const pattern = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.+/;
            return pattern.test(url);
        }

        function showFieldError(fieldId, message) {
            const errorElement = document.getElementById(`${fieldId}-error`);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function clearAllFieldErrors() {
            const errorElements = document.querySelectorAll('.error-message');
            errorElements.forEach(element => {
                element.style.display = 'none';
            });
        }

        // ==================== æº–å‚™è¡¨å–®è³‡æ–™ ====================
        function prepareFormData() {
            const identity = document.querySelector('input[name="identity"]:checked').value;
            const nameA = document.getElementById('nameA').value.trim();
            const nameB = document.getElementById('nameB').value.trim();
            const performerType = document.querySelector('input[name="performerType"]:checked')?.value || '';
            const song = document.getElementById('song').value.trim();
            const youtube = document.getElementById('youtube').value.trim();
            const karaokeFee = identity === 'æ­Œæ‰‹' ? parseInt(document.getElementById('karaokeFee').value) : 0;
            const mealType = document.getElementById('mealType').value;
            const mealFee = mealType !== 'ä¸ç”¨é¤' ? (currentEvent?.mealFee || 150) : 0;
            const donation = parseInt(document.getElementById('donation').value) || 0;
            const note = document.getElementById('note').value.trim();

            const name = performerType === 'é›™äºº' && nameB ? `${nameA} & ${nameB}` : nameA;
            const totalFee = karaokeFee + mealFee + donation;

            currentFormData = {
                name,
                identity,
                performerType,
                song: song || '-',
                youtube: youtube || '-',
                meal: mealType,
                fee: totalFee,
                note: note || '-',
                timestamp: new Date().toISOString(),
                lineUserId: userProfile?.userId || 'unknown',
                lineUserName: userProfile?.displayName || 'unknown'
            };
        }

        // ==================== é¡¯ç¤ºé è¦½ ====================
        function showPreviewModal() {
            const message = createRegistrationMessage(currentFormData);
            document.getElementById('preview-message').textContent = message;
            openModal('previewModal');
        }

        function createRegistrationMessage(registration) {
            const eventInfo = currentEvent ?
                `ğŸ“… ${currentEvent.date} ${currentEvent.startTime}-${currentEvent.endTime}\nğŸ“ ${currentEvent.location}` :
                'æ´»å‹•è³‡è¨Šè¼‰å…¥ä¸­';

            let message = `ğŸ¤ è¡—é ­Kæ­Œæ´»å‹• - æ–°å ±åé€šçŸ¥\n\n${eventInfo}\n\n`;
            message += `ğŸ‘¤ å§“åï¼š${registration.name}\n`;
            message += `ğŸ­ èº«åˆ†ï¼š${registration.identity}\n`;

            if (registration.identity === 'æ­Œæ‰‹') {
                message += `ğŸµ æ­Œæ›²ï¼š${registration.song}\n`;
                if (registration.youtube !== '-') {
                    message += `ğŸ”— é€£çµï¼š${registration.youtube}\n`;
                }
            }

            message += `ğŸ½ï¸ ç”¨é¤ï¼š${registration.meal}\n`;
            message += `ğŸ’° è²»ç”¨ï¼š$${registration.fee}\n`;

            if (registration.note !== '-') {
                message += `ğŸ“ å‚™è¨»ï¼š${registration.note}\n`;
            }

            message += `\nâ° å ±åæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            })}`;

            return message;
        }

        // ==================== ç¢ºèªä¸¦ç™¼é€ ====================
        async function confirmAndSend() {
            if (isSubmitting) return;

            debugLog('é–‹å§‹ LINE ç™¼é€æµç¨‹...');
            isSubmitting = true;
            const confirmBtn = document.getElementById('confirmSendBtn');
            const originalBtnText = confirmBtn.textContent;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = 'ç™¼é€ä¸­... <span class="loading"></span>';

            try {
                if (!liffReady) {
                    throw new Error('LIFF å°šæœªåˆå§‹åŒ–å®Œæˆ');
                }

                if (!liff.isInClient()) {
                    throw new Error('è«‹åœ¨ LINE æ‡‰ç”¨ç¨‹å¼ä¸­é–‹å•Ÿæ­¤åŠŸèƒ½');
                }

                const message = document.getElementById('preview-message').textContent;

                // å…ˆæäº¤åˆ°å¾Œç«¯
                await submitToBackend('line_send', message);

                // æ ¹æ“šä¾†æºæ±ºå®šç™¼é€æ–¹å¼
                const shareToGroup = document.getElementById('shareToGroup').checked;
                
                if (shareToGroup) {
                    if (isFromGroup) {
                        // å¾ç¾¤çµ„é–‹å•Ÿï¼šå˜—è©¦ç›´æ¥ç™¼é€
                        await sendMessageToCurrentGroup(message);
                    } else {
                        // éç¾¤çµ„é–‹å•Ÿï¼šä½¿ç”¨é¸æ“‡å™¨
                        await shareToLine(message);
                    }
                }

                debugLog('å ±åå®Œæˆ');

                closeModal('previewModal');
                document.getElementById('successMessage').textContent = 'æ‚¨çš„å ±åå·²æˆåŠŸæäº¤ä¸¦è¨˜éŒ„åˆ°ç³»çµ±ï¼';
                openModal('successModal');

                resetForm();

            } catch (error) {
                debugLog('ç™¼é€æˆ–æäº¤å¤±æ•—: ' + error.message);
                console.error('ç™¼é€éŒ¯èª¤:', error);
                alert('æ“ä½œå¤±æ•—ï¼š' + error.message);
            } finally {
                isSubmitting = false;
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalBtnText;
            }
        }

        // ==================== ç™¼é€åˆ°ç¾¤çµ„ ====================
        async function sendMessageToCurrentGroup(message) {
            try {
                if (liff.isApiAvailable('sendMessages')) {
                    await liff.sendMessages([{
                        type: 'text',
                        text: message
                    }]);
                    debugLog('è¨Šæ¯å·²é€é sendMessages ç™¼é€');
                    return true;
                }
            } catch (error) {
                debugLog('sendMessages å¤±æ•—: ' + error.message);
            }

            // é™ç´šä½¿ç”¨ shareTargetPicker
            return await shareToLine(message);
        }

        async function shareToLine(message) {
            try {
                if (!liff.isApiAvailable('shareTargetPicker')) {
                    throw new Error('åˆ†äº«åŠŸèƒ½ä¸å¯ç”¨');
                }

                const result = await liff.shareTargetPicker([{
                    type: 'text',
                    text: message
                }]);

                if (result) {
                    debugLog('è¨Šæ¯å·²é€é shareTargetPicker ç™¼é€');
                    return true;
                } else {
                    debugLog('ä½¿ç”¨è€…å–æ¶ˆåˆ†äº«');
                    return false;
                }
            } catch (error) {
                debugLog('shareTargetPicker å¤±æ•—: ' + error.message);
                throw error;
            }
        }

        // ==================== æäº¤åˆ°å¾Œç«¯ ====================
        async function submitToBackend(sendMethod, message) {
            debugLog('æäº¤è¡¨å–®åˆ°å¾Œç«¯ï¼Œæ“ä½œ: ' + sendMethod);

            const formData = {
                ...currentFormData,
                sendMethod: sendMethod,
                message: message,
                source: 'liff_form'
            };

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                    mode: 'no-cors'
                });

                debugLog('å¾Œç«¯æäº¤å®Œæˆ');
                clearSavedFormData();
                return true;

            } catch (error) {
                console.error('æäº¤éŒ¯èª¤:', error);
                debugLog('æäº¤éŒ¯èª¤: ' + error.message);
                throw error;
            }
        }

        // ==================== è¼”åŠ©å‡½æ•¸ ====================
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('liffStatus');
            statusDiv.className = `status-info status-${type}`;
            statusDiv.innerHTML = `<div>${message}</div>`;
        }

        function updateShareOptions() {
            const shareOptions = document.querySelector('.share-options');
            if (!shareOptions) return;

            if (isFromGroup) {
                shareOptions.innerHTML = `
                    <label>
                        <input type="checkbox" id="shareToGroup" checked>
                        å ±åå®Œæˆå¾Œï¼Œè‡ªå‹•ç™¼é€é€šçŸ¥åˆ°æ­¤ LINE ç¾¤çµ„ âœ…
                    </label>
                `;
            } else {
                shareOptions.innerHTML = `
                    <label>
                        <input type="checkbox" id="shareToGroup">
                        å ±åå®Œæˆå¾Œï¼Œé¸æ“‡è¦åˆ†äº«çš„ LINE å°è±¡
                    </label>
                `;
            }
        }

        function autoSaveForm() {
            try {
                const formData = {
                    identity: document.querySelector('input[name="identity"]:checked')?.value,
                    performerType: document.querySelector('input[name="performerType"]:checked')?.value,
                    nameA: document.getElementById('nameA').value,
                    nameB: document.getElementById('nameB').value,
                    song: document.getElementById('song').value,
                    youtube: document.getElementById('youtube').value,
                    mealType: document.getElementById('mealType').value,
                    donation: document.getElementById('donation').value,
                    note: document.getElementById('note').value,
                    timestamp: new Date().toISOString()
                };

                localStorage.setItem('karaokeFormData', JSON.stringify(formData));
                debugLog('è¡¨å–®è³‡æ–™å·²è‡ªå‹•å„²å­˜');
            } catch (error) {
                console.error('å„²å­˜è¡¨å–®è³‡æ–™å¤±æ•—:', error);
            }
        }

        function restoreFormData() {
            try {
                const savedData = localStorage.getItem('karaokeFormData');
                if (savedData) {
                    const formData = JSON.parse(savedData);

                    const savedTime = new Date(formData.timestamp);
                    const currentTime = new Date();
                    const hoursDiff = (currentTime - savedTime) / (1000 * 60 * 60);

                    if (hoursDiff < 24) {
                        if (formData.identity) {
                            document.querySelector(`input[name="identity"][value="${formData.identity}"]`).checked = true;
                            document.querySelector(`input[name="identity"][value="${formData.identity}"]`).dispatchEvent(new Event('change'));
                        }
                        if (formData.performerType) {
                            document.querySelector(`input[name="performerType"][value="${formData.performerType}"]`).checked = true;
                            document.querySelector(`input[name="performerType"][value="${formData.performerType}"]`).dispatchEvent(new Event('change'));
                        }
                        document.getElementById('nameA').value = formData.nameA || '';
                        document.getElementById('nameB').value = formData.nameB || '';
                        document.getElementById('song').value = formData.song || '';
                        document.getElementById('youtube').value = formData.youtube || '';
                        document.getElementById('mealType').value = formData.mealType || 'ä¸ç”¨é¤';
                        document.getElementById('donation').value = formData.donation || '0';
                        document.getElementById('note').value = formData.note || '';

                        debugLog('å·²æ¢å¾©å„²å­˜çš„è¡¨å–®è³‡æ–™');
                    } else {
                        clearSavedFormData();
                    }
                }
            } catch (error) {
                console.error('æ¢å¾©è¡¨å–®è³‡æ–™å¤±æ•—:', error);
            }
        }

        function clearSavedFormData() {
            try {
                localStorage.removeItem('karaokeFormData');
                debugLog('å·²æ¸…é™¤å„²å­˜çš„è¡¨å–®è³‡æ–™');
            } catch (error) {
                console.error('æ¸…é™¤è¡¨å–®è³‡æ–™å¤±æ•—:', error);
            }
        }

        function resetForm() {
            document.getElementById('registrationForm').reset();
            document.getElementById('performerTypeGroup').classList.add('hidden');
            document.getElementById('nameBGroup').classList.add('hidden');
            document.getElementById('songGroup').classList.add('hidden');
            document.getElementById('youtubeGroup').classList.add('hidden');
            document.getElementById('karaokeFeeGroup').classList.add('hidden');
            clearSavedFormData();
            updateShareOptions();
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function debugLog(message) {
            console.log('[DEBUG]', message);
        }

        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let i = 0; i < modals.length; i++) {
                if (event.target == modals[i]) {
                    modals[i].style.display = 'none';
                }
            }
        };
    </script>
</body>
</html>
