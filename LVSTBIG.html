<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸•é‡‘æ£®ç—…å‹è«–å£‡</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
      :root {
          --primary: #2E7D32;
          --secondary: #4CAF50;
          --accent: #81C784;
          --warning: #FF9800;
          --danger: #F44336;
          --info: #2196F3;
          --success: #4CAF50;
          --dark: #1B5E20;
          --light: #757575;
          --white: #FFFFFF;
          --bg: #F1F8E9;
          --shadow: 0 2px 10px rgba(0,0,0,0.1);
          --border-radius: 12px;
          --transition: all 0.3s ease;
      }

      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, var(--bg) 0%, #E8F5E8 100%);
          color: #333;
          line-height: 1.6;
          min-height: 100vh;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 0 20px;
      }

      /* Header */
      .header {
          background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
          color: white;
          padding: 1rem 0;
          box-shadow: var(--shadow);
          position: sticky;
          top: 0;
          z-index: 1000;
      }

      .header-content {
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: 1rem;
      }

      .logo {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-size: 1.5rem;
          font-weight: bold;
      }

      .user-info {
          display: flex;
          align-items: center;
          gap: 1rem;
      }

      .user-avatar {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          border: 2px solid white;
      }

      /* Navigation */
      .nav-tabs {
          background: white;
          padding: 0;
          box-shadow: var(--shadow);
          overflow-x: auto;
      }

      .nav-tabs ul {
          display: flex;
          list-style: none;
          margin: 0;
          padding: 0;
          min-width: max-content;
      }

      .nav-tabs li {
          flex: 1;
      }

      .nav-tabs button {
          width: 100%;
          padding: 1rem 1.5rem;
          border: none;
          background: transparent;
          color: var(--light);
          font-weight: 500;
          cursor: pointer;
          transition: var(--transition);
          border-bottom: 3px solid transparent;
          white-space: nowrap;
      }

      .nav-tabs button:hover {
          background: var(--bg);
          color: var(--primary);
      }

      .nav-tabs button.active {
          color: var(--primary);
          border-bottom-color: var(--primary);
          background: var(--bg);
      }

      /* Main Content */
      .main-content {
          padding: 2rem 0;
          min-height: calc(100vh - 200px);
      }

      .page {
          display: none;
      }

      .page.active {
          display: block;
      }

      /* Forum Stats */
      .forum-stats {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1rem;
          margin-bottom: 2rem;
      }

      .stat-card {
          background: white;
          padding: 1.5rem;
          border-radius: var(--border-radius);
          box-shadow: var(--shadow);
          text-align: center;
          transition: var(--transition);
      }

      .stat-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 5px 20px rgba(0,0,0,0.15);
      }

      .stat-icon {
          font-size: 2.5rem;
          margin-bottom: 0.5rem;
          color: var(--primary);
      }

      .stat-number {
          font-size: 2rem;
          font-weight: bold;
          color: var(--primary);
          margin-bottom: 0.25rem;
      }

      .stat-label {
          color: var(--light);
          font-size: 0.9rem;
      }

      /* Forum Controls */
      .forum-controls {
          background: white;
          padding: 1.5rem;
          border-radius: var(--border-radius);
          box-shadow: var(--shadow);
          margin-bottom: 2rem;
      }

      .controls-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: 1rem;
          margin-bottom: 1rem;
      }

      .controls-row:last-child {
          margin-bottom: 0;
      }

      .category-filters {
          display: flex;
          gap: 0.5rem;
          flex-wrap: wrap;
      }

      .search-actions {
          display: flex;
          gap: 0.5rem;
          align-items: center;
          flex-wrap: wrap;
      }

      .search-input {
          padding: 0.75rem;
          border: 2px solid #e0e0e0;
          border-radius: var(--border-radius);
          width: 250px;
          transition: var(--transition);
      }

      .search-input:focus {
          outline: none;
          border-color: var(--primary);
          box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
      }

      /* Buttons */
      .btn {
          padding: 0.75rem 1.5rem;
          border: none;
          border-radius: var(--border-radius);
          cursor: pointer;
          font-weight: 500;
          text-decoration: none;
          display: inline-flex;
          align-items: center;
          gap: 0.5rem;
          transition: var(--transition);
          font-size: 0.9rem;
      }

      .btn-primary {
          background: var(--primary);
          color: white;
      }

      .btn-primary:hover {
          background: var(--dark);
          transform: translateY(-2px);
      }

      .btn-secondary {
          background: #f5f5f5;
          color: var(--light);
          border: 2px solid #e0e0e0;
      }

      .btn-secondary:hover, .btn-secondary.active {
          background: var(--primary);
          color: white;
          border-color: var(--primary);
      }

      .btn-success {
          background: var(--success);
          color: white;
      }

      .btn-info {
          background: var(--info);
          color: white;
      }

      .btn-warning {
          background: var(--warning);
          color: white;
      }

      .btn-danger {
          background: var(--danger);
          color: white;
      }

      /* Forum Posts */
      .forum-posts {
          display: flex;
          flex-direction: column;
          gap: 1rem;
      }

      .post-card {
          background: white;
          border-radius: var(--border-radius);
          box-shadow: var(--shadow);
          overflow: hidden;
          transition: var(--transition);
          cursor: pointer;
      }

      .post-card:hover {
          transform: translateY(-3px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      }

      .post-card.pinned {
          border-left: 5px solid var(--warning);
          background: linear-gradient(to right, #FFF8E1 0%, white 5%);
      }

      .post-card.featured {
          border-left: 5px solid var(--success);
      }

      .post-header {
          padding: 1.5rem 1.5rem 0;
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          gap: 1rem;
      }

      .post-title {
          font-size: 1.25rem;
          font-weight: bold;
          color: var(--primary);
          margin-bottom: 0.5rem;
          line-height: 1.4;
      }

      .post-badges {
          display: flex;
          gap: 0.5rem;
          flex-shrink: 0;
          flex-wrap: wrap;
      }

      .badge {
          padding: 0.25rem 0.75rem;
          border-radius: 15px;
          font-size: 0.75rem;
          font-weight: bold;
          color: white;
      }

      .badge-pinned {
          background: var(--warning);
      }

      .badge-featured {
          background: var(--success);
      }

      .badge-hot {
          background: var(--danger);
      }

      .post-meta {
          display: flex;
          gap: 1rem;
          font-size: 0.85rem;
          color: var(--light);
          flex-wrap: wrap;
          margin-bottom: 1rem;
      }

      .post-meta-item {
          display: flex;
          align-items: center;
          gap: 0.3rem;
      }

      .post-content-preview {
          padding: 0 1.5rem;
          color: #666;
          line-height: 1.6;
          margin-bottom: 1rem;
          display: -webkit-box;
          -webkit-line-clamp: 3;
          -webkit-box-orient: vertical;
          overflow: hidden;
      }

      .post-footer {
          padding: 1rem 1.5rem;
          background: #fafafa;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-top: 1px solid #eee;
          flex-wrap: wrap;
          gap: 1rem;
      }

      .post-stats {
          display: flex;
          gap: 1.5rem;
          font-size: 0.85rem;
          color: var(--light);
      }

      .post-tags {
          display: flex;
          gap: 0.5rem;
          flex-wrap: wrap;
      }

      .post-tag {
          padding: 0.25rem 0.75rem;
          background: #E3F2FD;
          color: var(--info);
          border-radius: 15px;
          font-size: 0.75rem;
          text-decoration: none;
      }

      .post-tag:hover {
          background: var(--info);
          color: white;
      }

      /* Post Detail */
      .post-detail {
          background: white;
          border-radius: var(--border-radius);
          box-shadow: var(--shadow);
          overflow: hidden;
      }

      .post-detail-header {
          padding: 2rem;
          border-bottom: 3px solid var(--accent);
      }

      .post-detail-title {
          font-size: 2rem;
          font-weight: bold;
          color: var(--primary);
          margin-bottom: 1rem;
          line-height: 1.3;
      }

      .post-detail-content {
          padding: 2rem;
          font-size: 1.1rem;
          line-height: 1.8;
          color: #333;
          white-space: pre-wrap;
      }

      .post-actions {
          padding: 1.5rem 2rem;
          background: #fafafa;
          border-top: 1px solid #eee;
          display: flex;
          gap: 1rem;
          align-items: center;
          flex-wrap: wrap;
      }

      .like-button {
          padding: 0.75rem 1.5rem;
          border: 2px solid #E91E63;
          background: white;
          color: #E91E63;
          border-radius: 25px;
          cursor: pointer;
          transition: var(--transition);
          font-weight: bold;
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }

      .like-button:hover {
          background: #E91E63;
          color: white;
          transform: scale(1.05);
      }

      .like-button.liked {
          background: #E91E63;
          color: white;
      }

      /* Comments */
      .comments-section {
          background: white;
          border-radius: var(--border-radius);
          box-shadow: var(--shadow);
          margin-top: 2rem;
      }

      .comments-header {
          padding: 1.5rem 2rem;
          border-bottom: 1px solid #eee;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .comment-form {
          padding: 1.5rem 2rem;
          background: #fafafa;
          border-bottom: 1px solid #eee;
      }

      .comment-input {
          width: 100%;
          padding: 1rem;
          border: 2px solid #e0e0e0;
          border-radius: var(--border-radius);
          resize: vertical;
          min-height: 100px;
          font-family: inherit;
          transition: var(--transition);
      }

      .comment-input:focus {
          outline: none;
          border-color: var(--primary);
          box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
      }

      .comment-form-actions {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-top: 1rem;
          flex-wrap: wrap;
          gap: 1rem;
      }

      .comment-item {
          padding: 1.5rem 2rem;
          border-bottom: 1px solid #eee;
      }

      .comment-item:last-child {
          border-bottom: none;
      }

      .comment-item.reply {
          margin-left: 3rem;
          background: #f9f9f9;
          border-left: 3px solid var(--primary);
      }

      .comment-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.75rem;
      }

      .comment-author {
          font-weight: bold;
          color: var(--primary);
      }

      .comment-time {
          font-size: 0.85rem;
          color: var(--light);
      }

      .comment-content {
          color: #333;
          line-height: 1.6;
          margin-bottom: 1rem;
          white-space: pre-wrap;
      }

      .comment-actions {
          display: flex;
          gap: 1rem;
          font-size: 0.9rem;
      }

      .comment-action-btn {
          background: none;
          border: none;
          color: var(--light);
          cursor: pointer;
          padding: 0.25rem 0.5rem;
          transition: var(--transition);
          display: flex;
          align-items: center;
          gap: 0.3rem;
      }

      .comment-action-btn:hover {
          color: var(--primary);
      }

      .comment-action-btn.liked {
          color: #E91E63;
          font-weight: bold;
      }

      /* Modal */
      .modal {
          display: none;
          position: fixed;
          z-index: 2000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
          backdrop-filter: blur(5px);
      }

      .modal.show {
          display: flex;
          align-items: center;
          justify-content: center;
      }

      .modal-content {
          background: white;
          border-radius: var(--border-radius);
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 90vw;
          max-height: 90vh;
          overflow-y: auto;
          animation: modalSlideIn 0.3s ease;
      }

      @keyframes modalSlideIn {
          from {
              opacity: 0;
              transform: translateY(-50px) scale(0.9);
          }
          to {
              opacity: 1;
              transform: translateY(0) scale(1);
          }
      }

      .modal-header {
          padding: 1.5rem 2rem;
          border-bottom: 1px solid #eee;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .modal-close {
          font-size: 1.5rem;
          cursor: pointer;
          color: var(--light);
          transition: var(--transition);
      }

      .modal-close:hover {
          color: var(--danger);
      }

      .modal-body {
          padding: 2rem;
      }

      /* Form Elements */
      .form-group {
          margin-bottom: 1.5rem;
      }

      .form-label {
          display: block;
          margin-bottom: 0.5rem;
          font-weight: 500;
          color: var(--dark);
      }

      .form-control {
          width: 100%;
          padding: 0.75rem;
          border: 2px solid #e0e0e0;
          border-radius: var(--border-radius);
          font-family: inherit;
          transition: var(--transition);
      }

      .form-control:focus {
          outline: none;
          border-color: var(--primary);
          box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
      }

      .form-select {
          appearance: none;
          background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
          background-position: right 0.5rem center;
          background-repeat: no-repeat;
          background-size: 1.5em 1.5em;
          padding-right: 2.5rem;
      }

      /* Loading & Empty States */
      .loading {
          text-align: center;
          padding: 3rem;
          color: var(--light);
      }

      .loading i {
          font-size: 2rem;
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
      }

      .empty-state {
          text-align: center;
          padding: 3rem;
          color: var(--light);
      }

      .empty-state i {
          font-size: 4rem;
          margin-bottom: 1rem;
          opacity: 0.5;
      }

      /* Reply Info */
      #replyToInfo {
          margin-bottom: 1rem;
          padding: 1rem;
          background: #e3f2fd;
          border-radius: var(--border-radius);
          display: none;
          justify-content: space-between;
          align-items: center;
      }

      #replyToInfo.show {
          display: flex;
      }

      /* Like User Item */
      .like-user-item {
          padding: 1rem;
          border-bottom: 1px solid #eee;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .like-user-item:last-child {
          border-bottom: none;
      }

      /* Notification */
      .notification {
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 1rem 1.5rem;
          border-radius: var(--border-radius);
          color: white;
          font-weight: 500;
          z-index: 3000;
          transform: translateX(400px);
          transition: var(--transition);
          box-shadow: var(--shadow);
      }

      .notification.show {
          transform: translateX(0);
      }

      .notification.success {
          background: var(--success);
      }

      .notification.error {
          background: var(--danger);
      }

      .notification.warning {
          background: var(--warning);
      }

      .notification.info {
          background: var(--info);
      }

      /* Authentication States */
      .auth-required {
          display: none;
      }

      .authenticated .auth-required {
          display: inline-flex;
      }

      .guest-only {
          display: inline-flex;
      }

      .authenticated .guest-only {
          display: none;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
          .container {
              padding: 0 15px;
          }

          .header-content {
              flex-direction: column;
              text-align: center;
          }

          .controls-row {
              flex-direction: column;
              align-items: stretch;
          }

          .category-filters {
              justify-content: center;
          }

          .search-actions {
              justify-content: center;
          }

          .search-input {
              width: 100%;
              max-width: 300px;
          }

          .post-header {
              flex-direction: column;
              align-items: stretch;
          }

          .post-badges {
              align-self: flex-start;
          }

          .post-footer {
              flex-direction: column;
              gap: 1rem;
              align-items: stretch;
          }

          .comment-item.reply {
              margin-left: 1rem;
          }

          .modal-content {
              margin: 1rem;
              max-width: calc(100vw - 2rem);
          }

          .modal-body {
              padding: 1rem;
          }

          .post-detail-title {
              font-size: 1.5rem;
          }

          .post-detail-content {
              font-size: 1rem;
              padding: 1rem;
          }
      }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
      <div class="container">
          <div class="header-content">
              <div class="logo">
                  <i class="fas fa-comments"></i>
                  <span>å¸•é‡‘æ£®ç—…å‹è«–å£‡</span>
              </div>
              <div class="user-info">
                  <div class="guest-only">
                      <button class="btn btn-primary" onclick="loginWithLine()">
                          <i class="fab fa-line"></i>
                          LINE ç™»å…¥
                      </button>
                  </div>
                  <div class="auth-required">
                      <img id="userAvatar" class="user-avatar" src="" alt="ç”¨æˆ¶é ­åƒ">
                      <span id="userName">è¼‰å…¥ä¸­...</span>
                      <button class="btn btn-secondary" onclick="logout()">
                          <i class="fas fa-sign-out-alt"></i>
                          ç™»å‡º
                      </button>
                  </div>
              </div>
          </div>
      </div>
  </header>

  <!-- Navigation -->
  <nav class="nav-tabs">
      <div class="container">
          <ul>
              <li><button class="active" onclick="showPage('forum')"><i class="fas fa-home"></i> è«–å£‡é¦–é </button></li>
              <li><button onclick="showPage('trending')"><i class="fas fa-fire"></i> ç†±é–€è©±é¡Œ</button></li>
              <li><button onclick="showPage('my-posts')" class="auth-required"><i class="fas fa-user-edit"></i> æˆ‘çš„è²¼æ–‡</button></li>
          </ul>
      </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
      <div class="container">
          <!-- Forum Page -->
          <div id="forumPage" class="page active">
              <!-- Forum Statistics -->
              <div class="forum-stats">
                  <div class="stat-card">
                      <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                      <div class="stat-number" id="totalPosts">0</div>
                      <div class="stat-label">ç¸½è²¼æ–‡æ•¸</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-icon"><i class="fas fa-comments"></i></div>
                      <div class="stat-number" id="totalComments">0</div>
                      <div class="stat-label">ç¸½ç•™è¨€æ•¸</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-icon"><i class="fas fa-eye"></i></div>
                      <div class="stat-number" id="totalViews">0</div>
                      <div class="stat-label">ç¸½ç€è¦½æ•¸</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-icon"><i class="fas fa-heart"></i></div>
                      <div class="stat-number" id="totalLikes">0</div>
                      <div class="stat-label">ç¸½æŒ‰è®šæ•¸</div>
                  </div>
              </div>

              <!-- Forum Controls -->
              <div class="forum-controls">
                  <div class="controls-row">
                      <div class="category-filters">
                          <button class="btn btn-secondary active" onclick="filterByCategory('å…¨éƒ¨')">å…¨éƒ¨</button>
                          <button class="btn btn-secondary" onclick="filterByCategory('å…¬å‘Š')">ğŸ“¢ å…¬å‘Š</button>
                          <button class="btn btn-secondary" onclick="filterByCategory('ç”¨è—¥ç¶“é©—')">ğŸ’Š ç”¨è—¥ç¶“é©—</button>
                          <button class="btn btn-secondary" onclick="filterByCategory('ç”Ÿæ´»åˆ†äº«')">ğŸŒŸ ç”Ÿæ´»åˆ†äº«</button>
                          <button class="btn btn-secondary" onclick="filterByCategory('å•é¡Œæ±‚åŠ©')">â“ å•é¡Œæ±‚åŠ©</button>
                          <button class="btn btn-secondary" onclick="filterByCategory('æ´»å‹•å¿ƒå¾—')">ğŸ‰ æ´»å‹•å¿ƒå¾—</button>
                      </div>
                      <div class="search-actions">
                          <input type="text" class="search-input" id="searchInput" placeholder="æœå°‹è²¼æ–‡æ¨™é¡Œã€å…§å®¹æˆ–æ¨™ç±¤...">
                          <button class="btn btn-info" onclick="searchPosts()">
                              <i class="fas fa-search"></i>
                              æœå°‹
                          </button>
                          <button class="btn btn-success auth-required" onclick="showCreatePostModal()">
                              <i class="fas fa-plus"></i>
                              ç™¼è¡¨è²¼æ–‡
                          </button>
                      </div>
                  </div>
                  <div class="controls-row">
                      <div>
                          <label class="form-label" style="margin-right: 0.5rem;">æ’åºæ–¹å¼ï¼š</label>
                          <select class="form-control form-select" id="sortBy" onchange="loadPosts()" style="width: 150px; display: inline-block;">
                              <option value="latest">æœ€æ–°ç™¼å¸ƒ</option>
                              <option value="popular">æœ€å¤šäº’å‹•</option>
                              <option value="views">æœ€å¤šç€è¦½</option>
                              <option value="likes">æœ€å¤šæŒ‰è®š</option>
                          </select>
                      </div>
                  </div>
              </div>

              <!-- Forum Posts -->
              <div id="forumPosts" class="forum-posts">
                  <div class="loading">
                      <i class="fas fa-spinner"></i>
                      <p>è¼‰å…¥ä¸­...</p>
                  </div>
              </div>
          </div>

          <!-- Post Detail Page -->
          <div id="postDetailPage" class="page">
              <button class="btn btn-secondary" onclick="backToForum()" style="margin-bottom: 1rem;">
                  <i class="fas fa-arrow-left"></i>
                  è¿”å›è«–å£‡
              </button>
              
              <div id="postDetailContent"></div>
              
              <!-- Comments Section -->
              <div class="comments-section">
                  <div class="comments-header">
                      <h3><i class="fas fa-comments"></i> ç•™è¨€è¨è«– (<span id="commentCount">0</span>)</h3>
                  </div>
                  
                  <!-- Comment Form -->
                  <div class="comment-form auth-required">
                      <form onsubmit="submitComment(event)">
                          <input type="hidden" id="replyToCommentId" value="">
                          <div id="replyToInfo">
                              <span>å›è¦†çµ¦ï¼š<strong id="replyToAuthor"></strong></span>
                              <button type="button" class="btn btn-secondary" onclick="cancelReply()">
                                  <i class="fas fa-times"></i>
                                  å–æ¶ˆ
                              </button>
                          </div>
                          <textarea class="comment-input" id="commentContent" placeholder="ç™¼è¡¨ä½ çš„çœ‹æ³•..." required></textarea>
                          <div class="comment-form-actions">
                              <label style="cursor: pointer;">
                                  <input type="checkbox" id="commentAnonymous">
                                  <span style="margin-left: 0.5rem;">åŒ¿åç™¼è¡¨</span>
                              </label>
                              <button type="submit" class="btn btn-primary">
                                  <i class="fas fa-paper-plane"></i>
                                  ç™¼è¡¨ç•™è¨€
                              </button>
                          </div>
                      </form>
                  </div>

                  <!-- Comments List -->
                  <div id="commentsList"></div>
              </div>
          </div>

          <!-- Trending Page -->
          <div id="trendingPage" class="page">
              <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-fire"></i> ç†±é–€è©±é¡Œ</h2>
              <div id="trendingPosts" class="forum-posts">
                  <div class="loading">
                      <i class="fas fa-spinner"></i>
                      <p>è¼‰å…¥ä¸­...</p>
                  </div>
              </div>
          </div>

          <!-- My Posts Page -->
          <div id="my-postsPage" class="page">
              <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-user-edit"></i> æˆ‘çš„è²¼æ–‡</h2>
              <div id="myPosts" class="forum-posts">
                  <div class="loading">
                      <i class="fas fa-spinner"></i>
                      <p>è¼‰å…¥ä¸­...</p>
                  </div>
              </div>
          </div>
      </div>
  </main>

  <!-- Create Post Modal -->
  <div id="createPostModal" class="modal">
      <div class="modal-content" style="width: 800px;">
          <div class="modal-header">
              <h2><i class="fas fa-edit"></i> ç™¼è¡¨æ–°è²¼æ–‡</h2>
              <span class="modal-close" onclick="closeModal('createPostModal')">&times;</span>
          </div>
          <div class="modal-body">
              <form onsubmit="submitPost(event)">
                  <div class="form-group">
                      <label class="form-label">æ¨™é¡Œ *</label>
                      <input type="text" class="form-control" id="postTitle" required maxlength="100">
                  </div>
                  <div class="form-group">
                      <label class="form-label">åˆ†é¡ *</label>
                      <select class="form-control form-select" id="postCategory" required>
                          <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                          <option value="ç”¨è—¥ç¶“é©—">ğŸ’Š ç”¨è—¥ç¶“é©—</option>
                          <option value="ç”Ÿæ´»åˆ†äº«">ğŸŒŸ ç”Ÿæ´»åˆ†äº«</option>
                          <option value="å•é¡Œæ±‚åŠ©">â“ å•é¡Œæ±‚åŠ©</option>
                          <option value="æ´»å‹•å¿ƒå¾—">ğŸ‰ æ´»å‹•å¿ƒå¾—</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label class="form-label">å…§å®¹ *</label>
                      <textarea class="form-control" id="postContent" rows="10" required></textarea>
                  </div>
                  <div class="form-group">
                      <label class="form-label">æ¨™ç±¤ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
                      <input type="text" class="form-control" id="postTags" placeholder="ä¾‹å¦‚ï¼šç”¨è—¥,ç¶“é©—åˆ†äº«,å¸•é‡‘æ£®">
                  </div>
                  <div class="form-group">
                      <label style="cursor: pointer;">
                          <input type="checkbox" id="postAnonymous">
                          <span style="margin-left: 0.5rem;">åŒ¿åç™¼è¡¨</span>
                      </label>
                  </div>
                  <button type="submit" class="btn btn-primary" style="width: 100%;">
                      <i class="fas fa-paper-plane"></i>
                      ç™¼å¸ƒè²¼æ–‡
                  </button>
              </form>
          </div>
      </div>
  </div>

  <!-- Like Users Modal -->
  <div id="likeUsersModal" class="modal">
      <div class="modal-content" style="width: 500px;">
          <div class="modal-header">
              <h2><i class="fas fa-heart"></i> æŒ‰è®šç”¨æˆ¶</h2>
              <span class="modal-close" onclick="closeModal('likeUsersModal')">&times;</span>
          </div>
          <div class="modal-body">
              <div id="likeUsersList"></div>
          </div>
      </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification"></div>

  <script>
      // ==================== é…ç½®è¨­å®š ====================
      const CONFIG = {
          LIFF_ID: '2001679903-jkND3El9', // âš ï¸ è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID
          SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxAjXI18FDRIDmBJWF7oZq9gH0zY7dwtmVqiuvjViB_AWxaXcrQoHhTNnKutEXu7Pt4/exec' // âš ï¸ è«‹æ›¿æ›ç‚ºæ‚¨çš„ Script URL
      };

      // ==================== å…¨åŸŸè®Šæ•¸ ====================
      let currentUser = null;
      let currentPostId = null;
      let currentCategory = 'å…¨éƒ¨';
      let currentSort = 'latest';
      let isAuthenticated = false;

      // ==================== LIFF åˆå§‹åŒ– ====================
      async function initializeLiff() {
          try {
              await liff.init({ liffId: CONFIG.LIFF_ID });
              
              if (liff.isLoggedIn()) {
                  const profile = await liff.getProfile();
                  currentUser = {
                      userId: profile.userId,
                      displayName: profile.displayName,
                      pictureUrl: profile.pictureUrl
                  };
                  
                  updateUserInterface();
                  isAuthenticated = true;
                  document.body.classList.add('authenticated');
              } else {
                  document.body.classList.remove('authenticated');
              }
          } catch (error) {
              console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
              showNotification('ç³»çµ±åˆå§‹åŒ–å¤±æ•—', 'error');
          }
      }

      // ==================== èªè­‰å‡½æ•¸ ====================
      async function loginWithLine() {
          try {
              if (!liff.isLoggedIn()) {
                  liff.login();
              }
          } catch (error) {
              console.error('ç™»å…¥å¤±æ•—:', error);
              showNotification('ç™»å…¥å¤±æ•—', 'error');
          }
      }

      function logout() {
          try {
              liff.logout();
              currentUser = null;
              isAuthenticated = false;
              document.body.classList.remove('authenticated');
              showNotification('å·²æˆåŠŸç™»å‡º', 'success');
              loadPosts();
          } catch (error) {
              console.error('ç™»å‡ºå¤±æ•—:', error);
              showNotification('ç™»å‡ºå¤±æ•—', 'error');
          }
      }

      function updateUserInterface() {
          if (currentUser) {
              document.getElementById('userName').textContent = currentUser.displayName;
              document.getElementById('userAvatar').src = currentUser.pictureUrl;
          }
      }

      // ==================== é é¢å°èˆª ====================
      function showPage(pageId) {
          // éš±è—æ‰€æœ‰é é¢
          document.querySelectorAll('.page').forEach(page => {
              page.classList.remove('active');
          });
          
          // é¡¯ç¤ºé¸ä¸­çš„é é¢
          const targetPage = document.getElementById(pageId + 'Page');
          if (targetPage) {
              targetPage.classList.add('active');
          }
          
          // æ›´æ–°å°èˆªæŒ‰éˆ•ç‹€æ…‹
          document.querySelectorAll('.nav-tabs button').forEach(btn => {
              btn.classList.remove('active');
          });
          event.target.classList.add('active');

          // è¼‰å…¥å°æ‡‰é é¢çš„è³‡æ–™
          if (pageId === 'trending') {
              loadTrendingPosts();
          } else if (pageId === 'my-posts') {
              loadMyPosts();
          }
      }

      function backToForum() {
          document.querySelectorAll('.page').forEach(page => {
              page.classList.remove('active');
          });
          document.getElementById('forumPage').classList.add('active');
          
          document.querySelectorAll('.nav-tabs button').forEach(btn => {
              btn.classList.remove('active');
          });
          document.querySelector('.nav-tabs button').classList.add('active');
      }

      // ==================== è«–å£‡åŠŸèƒ½ ====================
      async function loadPosts() {
          try {
              showLoading('forumPosts');
              
              const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getAllForumPosts&category=${currentCategory}&sortBy=${currentSort}`);
              const data = await response.json();
              
              if (data.success) {
                  displayPosts(data.posts, 'forumPosts');
                  updateStatistics();
              } else {
                  showError('forumPosts', data.message || 'è¼‰å…¥è²¼æ–‡å¤±æ•—');
              }
          } catch (error) {
              console.error('è¼‰å…¥è²¼æ–‡å¤±æ•—:', error);
              showError('forumPosts', 'ç¶²è·¯é€£ç·šéŒ¯èª¤');
          }
      }

      async function loadTrendingPosts() {
          try {
              showLoading('trendingPosts');
              
              const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getTrendingPosts`);
              const data = await response.json();
              
              if (data.success) {
                  displayPosts(data.posts, 'trendingPosts');
              } else {
                  showError('trendingPosts', data.message || 'è¼‰å…¥ç†±é–€è²¼æ–‡å¤±æ•—');
              }
          } catch (error) {
              console.error('è¼‰å…¥ç†±é–€è²¼æ–‡å¤±æ•—:', error);
              showError('trendingPosts', 'ç¶²è·¯é€£ç·šéŒ¯èª¤');
          }
      }

      async function loadMyPosts() {
          if (!isAuthenticated) {
              showError('myPosts', 'è«‹å…ˆç™»å…¥');
              return;
          }

          try {
              showLoading('myPosts');
              
              const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getUserPosts&author=${encodeURIComponent(currentUser.displayName)}`);
              const data = await response.json();
              
              if (data.success) {
                  displayPosts(data.posts, 'myPosts');
              } else {
                  showError('myPosts', data.message || 'è¼‰å…¥æˆ‘çš„è²¼æ–‡å¤±æ•—');
              }
          } catch (error) {
              console.error('è¼‰å…¥æˆ‘çš„è²¼æ–‡å¤±æ•—:', error);
              showError('myPosts', 'ç¶²è·¯é€£ç·šéŒ¯èª¤');
          }
      }

      function displayPosts(posts, containerId) {
          const container = document.getElementById(containerId);
          
          if (posts.length === 0) {
              container.innerHTML = `
                  <div class="empty-state">
                      <i class="fas fa-comments"></i>
                      <h3>æš«ç„¡è²¼æ–‡</h3>
                      <p>æˆç‚ºç¬¬ä¸€å€‹ç™¼è¡¨è²¼æ–‡çš„äººå§ï¼</p>
                  </div>
              `;
              return;
          }
          
          container.innerHTML = posts.map(post => `
              <div class="post-card ${post.isPinned ? 'pinned' : ''} ${post.isFeatured ? 'featured' : ''}" onclick="viewPost('${post.postId}')">
                  <div class="post-header">
                      <div style="flex: 1;">
                          <div class="post-title">${escapeHtml(post.title)}</div>
                          <div class="post-meta">
                              <div class="post-meta-item">
                                  <i class="fas fa-user"></i>
                                  <span>${escapeHtml(post.author)}</span>
                              </div>
                              <div class="post-meta-item">
                                  <i class="fas fa-folder"></i>
                                  <span>${escapeHtml(post.category)}</span>
                              </div>
                              <div class="post-meta-item">
                                  <i class="fas fa-clock"></i>
                                  <span>${post.publishTime}</span>
                              </div>
                          </div>
                      </div>
                      <div class="post-badges">
                          ${post.isPinned ? '<span class="badge badge-pinned">ç½®é ‚</span>' : ''}
                          ${post.isFeatured ? '<span class="badge badge-featured">ç²¾è¯</span>' : ''}
                          ${(post.likeCount + post.commentCount) > 10 ? '<span class="badge badge-hot">ç†±é–€</span>' : ''}
                      </div>
                  </div>
                  <div class="post-content-preview">${escapeHtml(post.content)}</div>
                  <div class="post-footer">
                      <div class="post-stats">
                          <span><i class="fas fa-eye"></i> ${post.viewCount}</span>
                          <span><i class="fas fa-heart"></i> ${post.likeCount}</span>
                          <span><i class="fas fa-comments"></i> ${post.commentCount}</span>
                      </div>
                      <div class="post-tags">
                          ${post.tags ? post.tags.split(',').map(tag => 
                              `<a href="#" class="post-tag" onclick="event.stopPropagation(); searchByTag('${escapeHtml(tag.trim())}')">${escapeHtml(tag.trim())}</a>`
                          ).join('') : ''}
                      </div>
                  </div>
              </div>
          `).join('');
      }

      async function viewPost(postId) {
          try {
              currentPostId = postId;
              showLoading('postDetailContent');
              
              const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getForumPostDetail&postId=${postId}`);
              const data = await response.json();
              
              if (data.success) {
                  displayPostDetail(data.post);
                  loadComments(postId);
                  
                  // åˆ‡æ›åˆ°è©³æƒ…é é¢
                  document.querySelectorAll('.page').forEach(page => {
                      page.classList.remove('active');
                  });
                  document.getElementById('postDetailPage').classList.add('active');
              } else {
                  showNotification(data.message || 'è¼‰å…¥è²¼æ–‡å¤±æ•—', 'error');
              }
          } catch (error) {
              console.error('è¼‰å…¥è²¼æ–‡è©³æƒ…å¤±æ•—:', error);
              showNotification('ç¶²è·¯é€£ç·šéŒ¯èª¤', 'error');
          }
      }

      function displayPostDetail(post) {
          document.getElementById('postDetailContent').innerHTML = `
              <div class="post-detail">
                  <div class="post-detail-header">
                      <div class="post-badges" style="margin-bottom: 1rem;">
                          ${post.isPinned ? '<span class="badge badge-pinned">ç½®é ‚</span>' : ''}
                          ${post.isFeatured ? '<span class="badge badge-featured">ç²¾è¯</span>' : ''}
                      </div>
                      <h1 class="post-detail-title">${escapeHtml(post.title)}</h1>
                      <div class="post-meta">
                          <div class="post-meta-item">
                              <i class="fas fa-user"></i>
                              <span>${escapeHtml(post.author)}</span>
                          </div>
                          <div class="post-meta-item">
                              <i class="fas fa-folder"></i>
                              <span>${escapeHtml(post.category)}</span>
                          </div>
                          <div class="post-meta-item">
                              <i class="fas fa-clock"></i>
                              <span>${post.publishTime}</span>
                          </div>
                          <div class="post-meta-item">
                              <i class="fas fa-eye"></i>
                              <span>${post.viewCount} æ¬¡ç€è¦½</span>
                          </div>
                      </div>
                  </div>
                  <div class="post-detail-content">${escapeHtml(post.content)}</div>
                  <div class="post-actions">
                      <button class="like-button auth-required" onclick="togglePostLike('${post.postId}')" id="postLikeBtn">
                          <i class="fas fa-heart"></i>
                          <span id="postLikeCount">${post.likeCount}</span>
                      </button>
                      <button class="btn btn-info" onclick="showLikeUsers('è²¼æ–‡', '${post.postId}')">
                          <i class="fas fa-users"></i>
                          æŸ¥çœ‹æŒ‰è®šç”¨æˆ¶
                      </button>
                      <div class="post-tags">
                          ${post.tags ? post.tags.split(',').map(tag => 
                              `<a href="#" class="post-tag" onclick="searchByTag('${escapeHtml(tag.trim())}')">${escapeHtml(tag.trim())}</a>`
                          ).join('') : ''}
                      </div>
                  </div>
              </div>
          `;
          
          // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²æŒ‰è®š
          if (isAuthenticated) {
              checkUserLike('è²¼æ–‡', post.postId);
          }
      }

      async function loadComments(postId) {
          try {
              const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getPostComments&postId=${postId}`);
              const data = await response.json();
              
              if (data.success) {
                  displayComments(data.comments);
                  document.getElementById('commentCount').textContent = data.comments.reduce((count, comment) => count + 1 + comment.replies.length, 0);
              } else {
                  console.error('è¼‰å…¥ç•™è¨€å¤±æ•—:', data.message);
              }
          } catch (error) {
              console.error('è¼‰å…¥ç•™è¨€å¤±æ•—:', error);
          }
      }

      function displayComments(comments) {
          const container = document.getElementById('commentsList');
          
          if (comments.length === 0) {
              container.innerHTML = `
                  <div class="empty-state">
                      <i class="fas fa-comments"></i>
                      <h3>æš«ç„¡ç•™è¨€</h3>
                      <p>æˆç‚ºç¬¬ä¸€å€‹ç•™è¨€çš„äººå§ï¼</p>
                  </div>
              `;
              return;
          }
          
          container.innerHTML = comments.map(comment => `
              <div class="comment-item">
                  <div class="comment-header">
                      <span class="comment-author">${escapeHtml(comment.author)}</span>
                      <span class="comment-time">${comment.publishTime}</span>
                  </div>
                  <div class="comment-content">${escapeHtml(comment.content)}</div>
                  <div class="comment-actions">
                      <button class="comment-action-btn auth-required" onclick="toggleCommentLike('${comment.commentId}')" id="commentLike_${comment.commentId}">
                          <i class="fas fa-heart"></i>
                          <span>${comment.likeCount}</span>
                      </button>
                      <button class="comment-action-btn auth-required" onclick="replyToComment('${comment.commentId}', '${escapeHtml(comment.author)}')">
                          <i class="fas fa-reply"></i>
                          å›è¦†
                      </button>
                  </div>
                  ${comment.replies.map(reply => `
                      <div class="comment-item reply">
                          <div class="comment-header">
                              <span class="comment-author">${escapeHtml(reply.author)}</span>
                              <span class="comment-time">${reply.publishTime}</span>
                          </div>
                          <div class="comment-content">${escapeHtml(reply.content)}</div>
                          <div class="comment-actions">
                              <button class="comment-action-btn auth-required" onclick="toggleCommentLike('${reply.commentId}')" id="commentLike_${reply.commentId}">
                                  <i class="fas fa-heart"></i>
                                  <span>${reply.likeCount}</span>
                              </button>
                          </div>
                      </div>
                  `).join('')}
              </div>
          `).join('');

          // æª¢æŸ¥ç”¨æˆ¶å°æ¯å€‹ç•™è¨€çš„æŒ‰è®šç‹€æ…‹
          if (isAuthenticated) {
              comments.forEach(comment => {
                  checkUserLike('ç•™è¨€', comment.commentId);
                  comment.replies.forEach(reply => {
                      checkUserLike('ç•™è¨€', reply.commentId);
                  });
              });
          }
      }

      // ==================== è¡¨å–®è™•ç† ====================
      async function submitPost(event) {
          event.preventDefault();
          
          if (!isAuthenticated) {
              showNotification('è«‹å…ˆç™»å…¥', 'warning');
              return;
          }
          
          const title = document.getElementById('postTitle').value;
          const category = document.getElementById('postCategory').value;
          const content = document.getElementById('postContent').value;
          const tags = document.getElementById('postTags').value;
          const isAnonymous = document.getElementById('postAnonymous').checked;
          
          try {
              const response = await fetch(CONFIG.SCRIPT_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: new URLSearchParams({
                      action: 'createForumPost',
                      title: title,
                      content: content,
                      category: category,
                      author: currentUser.displayName,
                      authorType: 'æœƒå“¡',
                      tags: tags,
                      isAnonymous: isAnonymous,
                      lineUserId: currentUser.userId
                  })
              });
              
              const data = await response.json();
              
              if (data.success) {
                  showNotification('è²¼æ–‡ç™¼å¸ƒæˆåŠŸï¼', 'success');
                  closeModal('createPostModal');
                  document.getElementById('postTitle').value = '';
                  document.getElementById('postCategory').value = '';
                  document.getElementById('postContent').value = '';
                  document.getElementById('postTags').value = '';
                  document.getElementById('postAnonymous').checked = false;
                  loadPosts();
              } else {
                  showNotification(data.message || 'ç™¼å¸ƒå¤±æ•—', 'error');
              }
          } catch (error) {
              console.error('ç™¼å¸ƒè²¼æ–‡å¤±æ•—:', error);
              showNotification('ç¶²è·¯é€£ç·šéŒ¯èª¤', 'error');
          }
      }

      async function submitComment(event) {
          event.preventDefault();
          
          if (!isAuthenticated) {
              showNotification('è«‹å…ˆç™»å…¥', 'warning');
              return;
          }
          
          const content = document.getElementById('commentContent').value;
          const parentCommentId = document.getElementById('replyToCommentId').value;
          const isAnonymous = document.getElementById('commentAnonymous').checked;
          
          try {
              const response = await fetch(CONFIG.SCRIPT_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: new URLSearchParams({
                      action: 'createComment',
                      postId: currentPostId,
                      content: content,
                      author: currentUser.displayName,
                      authorType: 'æœƒå“¡',
                      parentCommentId: parentCommentId,
                      isAnonymous: isAnonymous,
                      lineUserId: currentUser.userId
                  })
              });
              
              const data = await response.json();
              
              if (data.success) {
                  showNotification('ç•™è¨€ç™¼è¡¨æˆåŠŸï¼', 'success');
                  document.getElementById('commentContent').value = '';
                  document.getElementById('commentAnonymous').checked = false;
                  cancelReply();
                  loadComments(currentPostId);
              } else {
                  showNotification(data.message || 'ç™¼è¡¨å¤±æ•—', 'error');
              }
          } catch (error) {
              console.error('ç™¼è¡¨ç•™è¨€å¤±æ•—:', error);
              showNotification('ç¶²è·¯é€£ç·šéŒ¯èª¤', 'error');
          }
      }

      // ==================== æŒ‰è®šåŠŸèƒ½ ====================
      async function togglePostLike(postId) {
          if (!isAuthenticated) {
              showNotification('è«‹å…ˆç™»å…¥', 'warning');
              return;
          }
          
          try {
              const response = await fetch(CONFIG.SCRIPT_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: new URLSearchParams({
                      action: 'toggleLike',
                      targetType: 'è²¼æ–‡',
                      targetId: postId,
                      userName: currentUser.displayName,
                      lineUserId: currentUser.userId
                  })
              });
              
              const data = await response.json();
              
              if (data.success) {
                  const btn = document.getElementById('postLikeBtn');
                  const countSpan = document.getElementById('postLikeCount');
                  
                  if (data.action === 'liked') {
                      btn.classList.add('liked');
                      countSpan.textContent = parseInt(countSpan.textContent) + 1;
                  } else {
                      btn.classList.remove('liked');
                      countSpan.textContent = parseInt(countSpan.textContent) - 1;
                  }
              } else {
                  showNotification(data.message || 'æ“ä½œå¤±æ•—', 'error');
              }
          } catch (error) {
              console.error('æŒ‰è®šæ“ä½œå¤±æ•—:', error);
              showNotification('ç¶²è·¯é€£ç·šéŒ¯èª¤', 'error');
          }
      }

      async function toggleCommentLike(commentId) {
          if (!isAuthenticated) {
              showNotification('è«‹å…ˆç™»å…¥', 'warning');
              return;
          }
          
          try {
              const response = await fetch(CONFIG.SCRIPT_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: new URLSearchParams({
                      action: 'toggleLike',
                      targetType: 'ç•™è¨€',
                      targetId: commentId,
                      userName: currentUser.displayName,
                      lineUserId: currentUser.userId
                  })
              });
              
              const data = await response.json();
              
              if (data.success) {
                  const btn = document.getElementById(`commentLike_${commentId}`);
                  const countSpan = btn.querySelector('span');
                  
                  if (data.action === 'liked') {
                      btn.classList.add('liked');
                      countSpan.textContent = parseInt(countSpan.textContent) + 1;
                  } else {
                      btn.classList.remove('liked');
                      countSpan.textContent = parseInt(countSpan.textContent) - 1;
                  }
              } else {
                  showNotification(data.message || 'æ“ä½œå¤±æ•—', 'error');
              }
          } catch (error) {
              console.error('æŒ‰è®šæ“ä½œå¤±æ•—:', error);
              showNotification('ç¶²è·¯é€£ç·šéŒ¯èª¤', 'error');
          }
      }

      async function checkUserLike(targetType, targetId) {
          if (!isAuthenticated) return;
          
          try {
              const response = await fetch(`${CONFIG.SCRIPT_URL}?action=checkUserLike&targetType=${targetType}&targetId=${targetId}&userName=${encodeURIComponent(currentUser.displayName)}`);
              const data = await response.json();
              
              if (data.success && data.liked) {
                  if (targetType === 'è²¼æ–‡') {
                      const btn = document.getElementById('postLikeBtn');
                      if (btn) btn.classList.add('liked');
                  } else {
                      const btn = document.getElementById(`commentLike_${targetId}`);
                      if (btn) btn.classList.add('liked');
                  }
              }
          } catch (error) {
              console.error('æª¢æŸ¥æŒ‰è®šç‹€æ…‹å¤±æ•—:', error);
          }
      }

        // ==================== ç¯©é¸èˆ‡æœå°‹åŠŸèƒ½ ====================
        function filterByCategory(category) {
            currentCategory = category;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.category-filters .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadPosts();
        }

        async function searchPosts() {
            const keyword = document.getElementById('searchInput').value.trim();
            
            if (!keyword) {
                loadPosts();
                return;
            }
            
            try {
                showLoading('forumPosts');
                
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=searchForumPosts&keyword=${encodeURIComponent(keyword)}`);
                const data = await response.json();
                
                if (data.success) {
                    displayPosts(data.posts, 'forumPosts');
                } else {
                    showError('forumPosts', data.message || 'æœå°‹å¤±æ•—');
                }
            } catch (error) {
                console.error('æœå°‹å¤±æ•—:', error);
                showError('forumPosts', 'ç¶²è·¯é€£ç·šéŒ¯èª¤');
            }
        }

        function searchByTag(tag) {
            document.getElementById('searchInput').value = tag;
            searchPosts();
            backToForum();
        }

        // ==================== Modal åŠŸèƒ½ ====================
        function showCreatePostModal() {
            if (!isAuthenticated) {
                showNotification('è«‹å…ˆç™»å…¥', 'warning');
                return;
            }
            
            document.getElementById('createPostModal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        async function showLikeUsers(targetType, targetId) {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getLikeUsers&targetType=${targetType}&targetId=${targetId}`);
                const data = await response.json();
                
                if (data.success) {
                    const usersList = document.getElementById('likeUsersList');
                    
                    if (data.users.length === 0) {
                        usersList.innerHTML = '<div class="empty-state"><p>æš«ç„¡æŒ‰è®šç”¨æˆ¶</p></div>';
                    } else {
                        usersList.innerHTML = data.users.map(user => `
                            <div class="like-user-item">
                                <span>${escapeHtml(user.userName)}</span>
                                <span style="color: var(--light); font-size: 0.85rem;">${user.likeTime}</span>
                            </div>
                        `).join('');
                    }
                    
                    document.getElementById('likeUsersModal').classList.add('show');
                } else {
                    showNotification(data.message || 'è¼‰å…¥å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('è¼‰å…¥æŒ‰è®šç”¨æˆ¶å¤±æ•—:', error);
                showNotification('ç¶²è·¯é€£ç·šéŒ¯èª¤', 'error');
            }
        }

        // ==================== å›è¦†åŠŸèƒ½ ====================
        function replyToComment(commentId, authorName) {
            document.getElementById('replyToCommentId').value = commentId;
            document.getElementById('replyToAuthor').textContent = authorName;
            document.getElementById('replyToInfo').classList.add('show');
            document.getElementById('commentContent').focus();
        }

        function cancelReply() {
            document.getElementById('replyToCommentId').value = '';
            document.getElementById('replyToInfo').classList.remove('show');
        }

        // ==================== çµ±è¨ˆåŠŸèƒ½ ====================
        async function updateStatistics() {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getForumStatistics`);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.statistics;
                    document.getElementById('totalPosts').textContent = stats.totalPosts;
                    document.getElementById('totalComments').textContent = stats.totalComments;
                    document.getElementById('totalViews').textContent = stats.totalViews;
                    document.getElementById('totalLikes').textContent = stats.totalLikes;
                }
            } catch (error) {
                console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
            }
        }

        // ==================== è¼”åŠ©å‡½æ•¸ ====================
        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>è¼‰å…¥ä¸­...</p>
                    </div>
                `;
            }
        }

        function showError(containerId, message) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>è¼‰å…¥å¤±æ•—</h3>
                        <p>${message}</p>
                        <button class="btn btn-primary" onclick="loadPosts()">é‡æ–°è¼‰å…¥</button>
                    </div>
                `;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== äº‹ä»¶ç›£è½å™¨ ====================
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ– LIFF
            initializeLiff();
            
            // è¼‰å…¥åˆå§‹è³‡æ–™
            loadPosts();
            
            // é»æ“Š modal å¤–éƒ¨é—œé–‰
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.classList.remove('show');
                }
            });
            
            // æœå°‹æ¡† Enter éµæœå°‹
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        searchPosts();
                    }
                });
            }
            
            // æ’åºè®Šæ›´è™•ç†
            const sortBy = document.getElementById('sortBy');
            if (sortBy) {
                sortBy.addEventListener('change', function() {
                    currentSort = this.value;
                    loadPosts();
                });
            }
        });
    </script>
  </body>
  </html>
