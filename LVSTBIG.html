<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森多元化論壇</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      
      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px;
      }
      
      .container {
          max-width: 800px;
          margin: 0 auto;
          background: white;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          overflow: hidden;
      }
      
      .header {
          background: linear-gradient(45deg, #4CAF50, #45a049);
          color: white;
          padding: 30px;
          text-align: center;
      }
      
      .header h1 {
          font-size: 2.5em;
          margin-bottom: 10px;
      }
      
      .header p {
          font-size: 1.1em;
          opacity: 0.9;
      }
      
      .nav-tabs {
          display: flex;
          background: #f8f9fa;
          border-bottom: 1px solid #dee2e6;
      }
      
      .nav-tab {
          flex: 1;
          padding: 15px;
          text-align: center;
          background: none;
          border: none;
          cursor: pointer;
          font-size: 16px;
          transition: all 0.3s;
      }
      
      .nav-tab.active {
          background: white;
          border-bottom: 3px solid #4CAF50;
          color: #4CAF50;
      }
      
      .content {
          padding: 30px;
      }
      
      .tab-content {
          display: none;
      }
      
      .tab-content.active {
          display: block;
      }
      
      .topic-card {
          background: #f8f9fa;
          border-radius: 10px;
          padding: 20px;
          margin-bottom: 20px;
          border-left: 4px solid #4CAF50;
          transition: transform 0.3s;
      }
      
      .topic-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      }
      
      .topic-title {
          font-size: 1.3em;
          font-weight: bold;
          color: #333;
          margin-bottom: 10px;
      }
      
      .topic-meta {
          color: #666;
          font-size: 0.9em;
          margin-bottom: 15px;
      }
      
      .topic-content {
          line-height: 1.6;
          color: #555;
      }
      
      .btn {
          background: #4CAF50;
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 25px;
          cursor: pointer;
          font-size: 16px;
          transition: all 0.3s;
          margin: 5px;
      }
      
      .btn:hover {
          background: #45a049;
          transform: translateY(-2px);
      }
      
      .btn-secondary {
          background: #6c757d;
      }
      
      .btn-secondary:hover {
          background: #5a6268;
      }
      
      .form-group {
          margin-bottom: 20px;
      }
      
      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: bold;
          color: #333;
      }
      
      .form-group input,
      .form-group textarea,
      .form-group select {
          width: 100%;
          padding: 12px;
          border: 2px solid #ddd;
          border-radius: 8px;
          font-size: 16px;
          transition: border-color 0.3s;
      }
      
      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
          outline: none;
          border-color: #4CAF50;
      }
      
      .reply-section {
          background: #e9ecef;
          border-radius: 8px;
          padding: 15px;
          margin-top: 15px;
      }
      
      .reply-item {
          background: white;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 10px;
          border-left: 3px solid #007bff;
      }
      
      .user-info {
          background: #e3f2fd;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
      }
      
      .status-indicator {
          display: inline-block;
          width: 12px;
          height: 12px;
          border-radius: 50%;
          margin-right: 8px;
      }
      
      .status-online {
          background: #4CAF50;
      }
      
      .status-offline {
          background: #ccc;
      }
      
      @media (max-width: 600px) {
          .nav-tabs {
              flex-direction: column;
          }
          
          .content {
              padding: 20px;
          }
          
          .header h1 {
              font-size: 2em;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>🌟 帕金森多元化論壇</h1>
          <p>關懷、分享、互助的溫暖社群</p>
      </div>
      
      <div class="nav-tabs">
          <button class="nav-tab active" onclick="showTab('forum')">論壇首頁</button>
          <button class="nav-tab" onclick="showTab('create')">發表主題</button>
          <button class="nav-tab" onclick="showTab('admin')">版主管理</button>
          <button class="nav-tab" onclick="showTab('profile')">個人資料</button>
      </div>
      
      <div class="content">
          <!-- 論壇首頁 -->
          <div id="forum" class="tab-content active">
              <div class="user-info">
                  <h3>👋 歡迎回來！</h3>
                  <p><span class="status-indicator status-online"></span>您已通過LINE LIFF驗證</p>
                  <p><strong>用戶名稱：</strong><span id="userName">載入中...</span></p>
              </div>
              
              <h2>📋 最新話題</h2>
              <div id="topicsList">
                  <div class="topic-card">
                      <div class="topic-title">💊 新藥物治療經驗分享</div>
                      <div class="topic-meta">👤 張醫師 | 📅 2024-01-15 | 💬 12 回覆</div>
                      <div class="topic-content">
                          最近開始使用新的帕金森藥物，想和大家分享一些使用心得和注意事項...
                      </div>
                      <button class="btn" onclick="viewTopic(1)">查看詳情</button>
                      <button class="btn btn-secondary" onclick="replyTopic(1)">回覆</button>
                  </div>
                  
                  <div class="topic-card">
                      <div class="topic-title">🏃‍♂️ 運動復健分享</div>
                      <div class="topic-meta">👤 李復健師 | 📅 2024-01-14 | 💬 8 回覆</div>
                      <div class="topic-content">
                          分享一些適合帕金森患者的運動方式和復健技巧，希望對大家有幫助...
                      </div>
                      <button class="btn" onclick="viewTopic(2)">查看詳情</button>
                      <button class="btn btn-secondary" onclick="replyTopic(2)">回覆</button>
                  </div>
                  
                  <div class="topic-card">
                      <div class="topic-title">🍎 營養飲食建議</div>
                      <div class="topic-meta">👤 王營養師 | 📅 2024-01-13 | 💬 15 回覆</div>
                      <div class="topic-content">
                          帕金森患者的飲食調理非常重要，這裡分享一些營養搭配的建議...
                      </div>
                      <button class="btn" onclick="viewTopic(3)">查看詳情</button>
                      <button class="btn btn-secondary" onclick="replyTopic(3)">回覆</button>
                  </div>
              </div>
          </div>
          
          <!-- 發表主題 -->
          <div id="create" class="tab-content">
              <h2>✍️ 發表新主題</h2>
              <form id="createTopicForm">
                  <div class="form-group">
                      <label for="topicCategory">📂 主題分類</label>
                      <select id="topicCategory" required>
                          <option value="">請選擇分類</option>
                          <option value="medical">💊 醫療資訊</option>
                          <option value="rehabilitation">🏃‍♂️ 復健運動</option>
                          <option value="nutrition">🍎 營養飲食</option>
                          <option value="psychology">🧠 心理支持</option>
                          <option value="daily">🏠 日常生活</option>
                          <option value="experience">💭 經驗分享</option>
                      </select>
                  </div>
                  
                  <div class="form-group">
                      <label for="topicTitle">📝 主題標題</label>
                      <input type="text" id="topicTitle" placeholder="請輸入主題標題..." required>
                  </div>
                  
                  <div class="form-group">
                      <label for="topicContent">📄 內容描述</label>
                      <textarea id="topicContent" rows="6" placeholder="請詳細描述您想分享的內容..." required></textarea>
                  </div>
                  
                  <div class="form-group">
                      <label for="topicTags">🏷️ 標籤 (用逗號分隔)</label>
                      <input type="text" id="topicTags" placeholder="例如: 藥物, 副作用, 經驗分享">
                  </div>
                  
                  <button type="submit" class="btn">🚀 發表主題</button>
              </form>
          </div>
          
          <!-- 版主管理 -->
          <div id="admin" class="tab-content">
              <h2>⚙️ 版主管理面板</h2>
              <div id="adminPanel">
                  <div class="topic-card">
                      <h3>📊 論壇統計</h3>
                      <p>📝 總主題數: <strong>156</strong></p>
                      <p>💬 總回覆數: <strong>892</strong></p>
                      <p>👥 活躍用戶: <strong>45</strong></p>
                      <p>📅 今日新增: <strong>3</strong></p>
                  </div>
                  
                  <div class="topic-card">
                      <h3>🛠️ 管理功能</h3>
                      <button class="btn" onclick="manageCategories()">📂 管理分類</button>
                      <button class="btn" onclick="manageUsers()">👥 用戶管理</button>
                      <button class="btn" onclick="moderateContent()">🔍 內容審核</button>
                      <button class="btn" onclick="exportData()">📊 匯出數據</button>
                  </div>
                  
                  <div class="topic-card">
                      <h3>⚠️ 待處理事項</h3>
                      <div class="reply-item">
                          <strong>🚨 檢舉內容:</strong> 用戶回報不當言論
                          <button class="btn btn-secondary" style="float: right;">處理</button>
                      </div>
                      <div class="reply-item">
                          <strong>📝 待審核:</strong> 新用戶申請加入
                          <button class="btn" style="float: right;">審核</button>
                      </div>
                  </div>
              </div>
          </div>
          
          <!-- 個人資料 -->
          <div id="profile" class="tab-content">
              <h2>👤 個人資料設定</h2>
              <form id="profileForm">
                  <div class="form-group">
                      <label for="displayName">📛 顯示名稱</label>
                      <input type="text" id="displayName" value="載入中...">
                  </div>
                  
                  <div class="form-group">
                      <label for="userRole">👔 身份角色</label>
                      <select id="userRole">
                          <option value="patient">🤒 患者</option>
                          <option value="caregiver">👨‍⚕️ 照護者</option>
                          <option value="medical">🩺 醫療專業人員</option>
                          <option value="family">👨‍👩‍👧‍👦 家屬</option>
                      </select>
                  </div>
                  
                  <div class="form-group">
                      <label for="interests">🎯 關注領域</label>
                      <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                          <label><input type="checkbox" value="medical"> 💊 醫療資訊</label>
                          <label><input type="checkbox" value="rehabilitation"> 🏃‍♂️ 復健運動</label>
                          <label><input type="checkbox" value="nutrition"> 🍎 營養飲食</label>
                          <label><input type="checkbox" value="psychology"> 🧠 心理支持</label>
                      </div>
                  </div>
                  
                  <div class="form-group">
                      <label for="notifications">🔔 通知設定</label>
                      <div>
                          <label><input type="checkbox" checked> 📧 新回覆通知</label><br>
                          <label><input type="checkbox" checked> 📱 LINE推送通知</label><br>
                          <label><input type="checkbox"> 📊 週報摘要</label>
                      </div>
                  </div>
                  
                  <button type="submit" class="btn">💾 儲存設定</button>
              </form>
          </div>
      </div>
  </div>

  <script>
      // LIFF初始化
      let liffId = '2001679903-O06mNaLy'; // 請替換為實際的LIFF ID
      let userId = null;
      let userName = null;
      
      // 初始化LIFF
      async function initializeLiff() {
          try {
              await liff.init({ liffId: liffId });
              
              if (liff.isLoggedIn()) {
                  const profile = await liff.getProfile();
                  userId = profile.userId;
                  userName = profile.displayName;
                  
                  document.getElementById('userName').textContent = userName;
                  document.getElementById('displayName').value = userName;
              } else {
                  liff.login();
              }
          } catch (error) {
              console.error('LIFF初始化失敗:', error);
              // 模擬數據用於測試
              userName = '測試用戶';
              document.getElementById('userName').textContent = userName;
              document.getElementById('displayName').value = userName;
          }
      }
      
      // 頁面載入時初始化
      window.addEventListener('load', initializeLiff);
      
      // 切換標籤頁
      function showTab(tabName) {
          // 隱藏所有標籤內容
          const contents = document.querySelectorAll('.tab-content');
          contents.forEach(content => content.classList.remove('active'));
          
          // 移除所有標籤的active狀態
          const tabs = document.querySelectorAll('.nav-tab');
          tabs.forEach(tab => tab.classList.remove('active'));
          
          // 顯示選中的標籤內容
          document.getElementById(tabName).classList.add('active');
          event.target.classList.add('active');
      }
      
      // GAS後端API調用
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbxkiW-pSozig8mWHhuw_LySz70R55ASs55JNhk8m8qlMf5Z5llnBFBujogFjSJgsL8HOQ/exec'; // 請替換為實際的GAS Web App URL
      
      // 發表新主題
      document.getElementById('createTopicForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const topicData = {
              category: document.getElementById('topicCategory').value,
              title: document.getElementById('topicTitle').value,
              content: document.getElementById('topicContent').value,
              tags: document.getElementById('topicTags').value,
              userId: userId,
              userName: userName,
              timestamp: new Date().toISOString()
          };
          
          try {
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'createTopic',
                      data: topicData
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  alert('✅ 主題發表成功！');
                  document.getElementById('createTopicForm').reset();
                  showTab('forum');
                  loadTopics(); // 重新載入主題列表
                  
                  // 發送LINE通知給群組
                  await sendLineNotification('新主題發表', topicData.title);
              } else {
                  alert('❌ 發表失敗，請稍後再試');
              }
          } catch (error) {
              console.error('發表主題失敗:', error);
              alert('❌ 網路錯誤，請稍後再試');
          }
      });
      
      // 查看主題詳情
      function viewTopic(topicId) {
          // 這裡可以開啟主題詳情頁面或模態框
          alert(`查看主題 ${topicId} 的詳細內容`);
      }
      
      // 回覆主題
      async function replyTopic(topicId) {
          const replyContent = prompt('請輸入您的回覆內容:');
          
          if (replyContent && replyContent.trim()) {
              const replyData = {
                  topicId: topicId,
                  content: replyContent.trim(),
                  userId: userId,
                  userName: userName,
                  timestamp: new Date().toISOString()
              };
              
              try {
                  const response = await fetch(GAS_URL, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                          action: 'replyTopic',
                          data: replyData
                      })
                  });
                  
                  const result = await response.json();
                  
                  if (result.success) {
                      alert('✅ 回覆發表成功！');
                      
                      // 發送LINE通知
                      await sendLineNotification('新回覆', `${userName} 回覆了您的主題`);
                  } else {
                      alert('❌ 回覆失敗，請稍後再試');
                  }
              } catch (error) {
                  console.error('回覆失敗:', error);
                  alert('❌ 網路錯誤，請稍後再試');
              }
          }
      }
      
      // 發送LINE通知
      async function sendLineNotification(type, message) {
          try {
              if (liff.isLoggedIn()) {
                  await liff.sendMessages([{
                      type: 'text',
                      text: `🔔 ${type}\n\n${message}\n\n來自帕金森多元化論壇`
                  }]);
              }
          } catch (error) {
              console.error('LINE通知發送失敗:', error);
          }
      }
      
      // 載入主題列表
      async function loadTopics() {
          try {
              const response = await fetch(`${GAS_URL}?action=getTopics`);
              const result = await response.json();
              
              if (result.success) {
                  updateTopicsList(result.data);
              }
          } catch (error) {
              console.error('載入主題失敗:', error);
          }
      }
      
      // 更新主題列表顯示
      function updateTopicsList(topics) {
          const topicsList = document.getElementById('topicsList');
          topicsList.innerHTML = '';
          
          topics.forEach(topic => {
              const topicCard = document.createElement('div');
              topicCard.className = 'topic-card';
              topicCard.innerHTML = `
                  <div class="topic-title">${topic.title}</div>
                  <div class="topic-meta">👤 ${topic.userName} | 📅 ${new Date(topic.timestamp).toLocaleDateString()} | 💬 ${topic.replyCount || 0} 回覆</div>
                  <div class="topic-content">${topic.content.substring(0, 100)}...</div>
                  <button class="btn" onclick="viewTopic(${topic.id})">查看詳情</button>
                  <button class="btn btn-secondary" onclick="replyTopic(${topic.id})">回覆</button>
              `;
              topicsList.appendChild(topicCard);
          });
      }
      
      // 版主管理功能
      function manageCategories() {
          alert('📂 分類管理功能開發中...');
      }
      
      function manageUsers() {
          alert('👥 用戶管理功能開發中...');
      }
      
      function moderateContent() {
          alert('🔍 內容審核功能開發中...');
      }
      
      function exportData() {
          alert('📊 數據匯出功能開發中...');
      }
      
      // 儲存個人資料
      document.getElementById('profileForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const profileData = {
              userId: userId,
              displayName: document.getElementById('displayName').value,
              role: document.getElementById('userRole').value,
              interests: Array.from(document.querySelectorAll('#interests input:checked')).map(cb => cb.value),
              notifications: {
                  reply: document.querySelector('input[type="checkbox"]:nth-of-type(1)').checked,
                  line: document.querySelector('input[type="checkbox"]:nth-of-type(2)').checked,
                  weekly: document.querySelector('input[type="checkbox"]:nth-of-type(3)').checked
              }
          };
          
          try {
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'updateProfile',
                      data: profileData
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  alert('✅ 個人資料更新成功！');
              } else {
                  alert('❌ 更新失敗，請稍後再試');
              }
          } catch (error) {
              console.error('更新個人資料失敗:', error);
              alert('❌ 網路錯誤，請稍後再試');
          }
      });
  </script>
</body>
</html>
