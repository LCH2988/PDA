<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森多元化論壇 - 專業版</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
      :root {
          --primary-color: #4CAF50;
          --secondary-color: #2196F3;
          --accent-color: #FF9800;
          --danger-color: #f44336;
          --success-color: #4CAF50;
          --warning-color: #ff9800;
          --info-color: #2196F3;
          --light-color: #f8f9fa;
          --dark-color: #343a40;
          --border-radius: 12px;
          --box-shadow: 0 4px 20px rgba(0,0,0,0.1);
          --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          line-height: 1.6;
      }

      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255,255,255,0.9);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          transition: var(--transition);
      }

      .loading-spinner {
          width: 50px;
          height: 50px;
          border: 4px solid #f3f3f3;
          border-top: 4px solid var(--primary-color);
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 20px;
      }

      .header {
          background: linear-gradient(135deg, var(--primary-color), #45a049);
          color: white;
          padding: 30px;
          border-radius: var(--border-radius);
          margin-bottom: 20px;
          text-align: center;
          box-shadow: var(--box-shadow);
      }

      .header h1 {
          font-size: 2.5em;
          margin-bottom: 10px;
          font-weight: 700;
      }

      .header p {
          font-size: 1.2em;
          opacity: 0.9;
      }

      .main-content {
          display: grid;
          grid-template-columns: 250px 1fr;
          gap: 20px;
          background: white;
          border-radius: var(--border-radius);
          box-shadow: var(--box-shadow);
          overflow: hidden;
      }

      .sidebar {
          background: var(--light-color);
          padding: 0;
          border-right: 1px solid #dee2e6;
      }

      .nav-menu {
          list-style: none;
      }

      .nav-item {
          border-bottom: 1px solid #dee2e6;
      }

      .nav-link {
          display: flex;
          align-items: center;
          padding: 15px 20px;
          color: var(--dark-color);
          text-decoration: none;
          transition: var(--transition);
          cursor: pointer;
      }

      .nav-link:hover,
      .nav-link.active {
          background: var(--primary-color);
          color: white;
      }

      .nav-link i {
          margin-right: 10px;
          width: 20px;
      }

      .content-area {
          padding: 30px;
          min-height: 600px;
      }

      .tab-content {
          display: none;
          animation: fadeIn 0.3s ease-in;
      }

      .tab-content.active {
          display: block;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .user-info-card {
          background: linear-gradient(135deg, var(--info-color), #1976D2);
          color: white;
          padding: 20px;
          border-radius: var(--border-radius);
          margin-bottom: 20px;
          display: flex;
          align-items: center;
      }

      .user-avatar {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background: rgba(255,255,255,0.2);
          display: flex;
          align-items: center;
          justify-content: center;
          margin-right: 15px;
          font-size: 24px;
      }

      .user-details h3 {
          margin-bottom: 5px;
      }

      .user-status {
          display: flex;
          align-items: center;
          font-size: 0.9em;
          opacity: 0.9;
      }

      .status-dot {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: #4CAF50;
          margin-right: 8px;
      }

      .topic-card {
          background: white;
          border: 1px solid #e9ecef;
          border-radius: var(--border-radius);
          padding: 20px;
          margin-bottom: 20px;
          transition: var(--transition);
          position: relative;
          overflow: hidden;
      }

      .topic-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          width: 4px;
          height: 100%;
          background: var(--primary-color);
      }

      .topic-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      }

      .topic-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 15px;
      }

      .topic-title {
          font-size: 1.4em;
          font-weight: 600;
          color: var(--dark-color);
          margin-bottom: 8px;
      }

      .topic-category {
          display: inline-block;
          padding: 4px 12px;
          background: var(--primary-color);
          color: white;
          border-radius: 20px;
          font-size: 0.8em;
          font-weight: 500;
      }

      .topic-meta {
          display: flex;
          align-items: center;
          color: #6c757d;
          font-size: 0.9em;
          margin-bottom: 15px;
          flex-wrap: wrap;
          gap: 15px;
      }

      .meta-item {
          display: flex;
          align-items: center;
      }

      .meta-item i {
          margin-right: 5px;
      }

      .topic-content {
          color: #555;
          line-height: 1.7;
          margin-bottom: 15px;
      }

      .topic-tags {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
          margin-bottom: 15px;
      }

      .tag {
          background: #e9ecef;
          color: #495057;
          padding: 4px 10px;
          border-radius: 15px;
          font-size: 0.8em;
      }

      .topic-actions {
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
      }

      .btn {
          padding: 10px 20px;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 500;
          text-decoration: none;
          display: inline-flex;
          align-items: center;
          gap: 8px;
          transition: var(--transition);
          text-align: center;
      }

      .btn-primary {
          background: var(--primary-color);
          color: white;
      }

      .btn-primary:hover {
          background: #45a049;
          transform: translateY(-1px);
      }

      .btn-secondary {
          background: #6c757d;
          color: white;
      }

      .btn-secondary:hover {
          background: #5a6268;
      }

      .btn-info {
          background: var(--info-color);
          color: white;
      }

      .btn-info:hover {
          background: #1976D2;
      }

      .btn-warning {
          background: var(--warning-color);
          color: white;
      }

      .btn-danger {
          background: var(--danger-color);
          color: white;
      }

      .form-container {
          background: white;
          padding: 30px;
          border-radius: var(--border-radius);
          box-shadow: var(--box-shadow);
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: var(--dark-color);
      }

      .form-control {
          width: 100%;
          padding: 12px 16px;
          border: 2px solid #e9ecef;
          border-radius: var(--border-radius);
          font-size: 16px;
          transition: var(--transition);
          font-family: inherit;
      }

      .form-control:focus {
          outline: none;
          border-color: var(--primary-color);
          box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
      }

      .form-control.error {
          border-color: var(--danger-color);
      }

      .error-message {
          color: var(--danger-color);
          font-size: 0.9em;
          margin-top: 5px;
      }

      .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
          animation: fadeIn 0.3s ease;
      }

      .modal-content {
          background-color: white;
          margin: 5% auto;
          padding: 30px;
          border-radius: var(--border-radius);
          width: 90%;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
          position: relative;
          animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
          from { transform: translateY(-50px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
          padding-bottom: 15px;
          border-bottom: 1px solid #e9ecef;
      }

      .modal-title {
          font-size: 1.5em;
          font-weight: 600;
          color: var(--dark-color);
      }

      .close {
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #adb5bd;
          padding: 0;
          width: 30px;
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
      }

      .close:hover {
          color: var(--dark-color);
      }

      .reply-section {
          background: #f8f9fa;
          border-radius: var(--border-radius);
          padding: 20px;
          margin-top: 20px;
      }

      .reply-item {
          background: white;
          padding: 15px;
          border-radius: var(--border-radius);
          margin-bottom: 15px;
          border-left: 3px solid var(--info-color);
      }

      .reply-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
      }

      .reply-author {
          font-weight: 600;
          color: var(--dark-color);
      }

      .reply-time {
          color: #6c757d;
          font-size: 0.9em;
      }

      .reply-content {
          color: #555;
          line-height: 1.6;
      }

      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
      }

      .stat-card {
          background: white;
          padding: 25px;
          border-radius: var(--border-radius);
          text-align: center;
          box-shadow: var(--box-shadow);
          transition: var(--transition);
      }

      .stat-card:hover {
          transform: translateY(-2px);
      }

      .stat-icon {
          font-size: 2.5em;
          margin-bottom: 15px;
      }

      .stat-number {
          font-size: 2em;
          font-weight: 700;
          margin-bottom: 5px;
      }

      .stat-label {
          color: #6c757d;
          font-size: 0.9em;
      }

      .notification {
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          border-radius: var(--border-radius);
          color: white;
          font-weight: 500;
          z-index: 1001;
          transform: translateX(400px);
          transition: var(--transition);
      }

      .notification.show {
          transform: translateX(0);
      }

      .notification.success {
          background: var(--success-color);
      }

      .notification.error {
          background: var(--danger-color);
      }

      .notification.info {
          background: var(--info-color);
      }

      .notification.warning {
          background: var(--warning-color);
      }

      .search-container {
          position: relative;
          margin-bottom: 20px;
      }

      .search-input {
          width: 100%;
          padding: 12px 45px 12px 16px;
          border: 2px solid #e9ecef;
          border-radius: 25px;
          font-size: 16px;
      }

      .search-btn {
          position: absolute;
          right: 5px;
          top: 50%;
          transform: translateY(-50%);
          background: var(--primary-color);
          border: none;
          color: white;
          width: 35px;
          height: 35px;
          border-radius: 50%;
          cursor: pointer;
      }

      .filter-bar {
          display: flex;
          gap: 15px;
          margin-bottom: 20px;
          flex-wrap: wrap;
          align-items: center;
      }

      .filter-select {
          padding: 8px 12px;
          border: 1px solid #e9ecef;
          border-radius: var(--border-radius);
          background: white;
      }

      .pagination {
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 10px;
          margin-top: 30px;
      }

      .page-btn {
          padding: 8px 12px;
          border: 1px solid #e9ecef;
          background: white;
          border-radius: 6px;
          cursor: pointer;
          transition: var(--transition);
      }

      .page-btn:hover,
      .page-btn.active {
          background: var(--primary-color);
          color: white;
          border-color: var(--primary-color);
      }

      .empty-state {
          text-align: center;
          padding: 60px 20px;
          color: #6c757d;
      }

      .empty-state i {
          font-size: 4em;
          margin-bottom: 20px;
          opacity: 0.5;
      }

      .checkbox-group {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 10px;
          margin-top: 10px;
      }

      .checkbox-item {
          display: flex;
          align-items: center;
          gap: 8px;
      }

      .checkbox-item input[type="checkbox"] {
          width: 18px;
          height: 18px;
      }

      @media (max-width: 768px) {
          .main-content {
              grid-template-columns: 1fr;
          }

          .sidebar {
              order: 2;
              border-right: none;
              border-top: 1px solid #dee2e6;
          }

          .nav-menu {
              display: flex;
              overflow-x: auto;
          }

          .nav-item {
              border-bottom: none;
              border-right: 1px solid #dee2e6;
              flex-shrink: 0;
          }

          .container {
              padding: 10px;
          }

          .header h1 {
              font-size: 2em;
          }

          .stats-grid {
              grid-template-columns: 1fr;
          }

          .filter-bar {
              flex-direction: column;
              align-items: stretch;
          }

          .modal-content {
              margin: 10% auto;
              width: 95%;
              padding: 20px;
          }
      }

      .admin-panel {
          background: white;
          border-radius: var(--border-radius);
          overflow: hidden;
          box-shadow: var(--box-shadow);
      }

      .admin-header {
          background: linear-gradient(135deg, var(--danger-color), #d32f2f);
          color: white;
          padding: 20px;
          text-align: center;
      }

      .admin-content {
          padding: 30px;
      }

      .admin-section {
          margin-bottom: 30px;
          padding: 20px;
          border: 1px solid #e9ecef;
          border-radius: var(--border-radius);
      }

      .admin-section h3 {
          color: var(--dark-color);
          margin-bottom: 15px;
          padding-bottom: 10px;
          border-bottom: 2px solid var(--primary-color);
      }

      .pending-items {
          max-height: 300px;
          overflow-y: auto;
      }

      .pending-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 15px;
          border: 1px solid #e9ecef;
          border-radius: var(--border-radius);
          margin-bottom: 10px;
          background: #f8f9fa;
      }

      .item-info {
          flex: 1;
      }

      .item-actions {
          display: flex;
          gap: 10px;
      }
  </style>
</head>
<body>
  <!-- 載入覆蓋層 -->
  <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-spinner"></div>
  </div>

  <!-- 通知容器 -->
  <div id="notificationContainer"></div>

  <div class="container">
      <!-- 標題區 -->
      <div class="header">
          <h1><i class="fas fa-heart"></i> 帕金森多元化論壇</h1>
          <p>專業醫療資訊 • 溫暖互助社群 • 全方位照護支持</p>
      </div>

      <!-- 主要內容區 -->
      <div class="main-content">
          <!-- 側邊選單 -->
          <div class="sidebar">
              <ul class="nav-menu">
                  <li class="nav-item">
                      <a class="nav-link active" onclick="showTab('dashboard')">
                          <i class="fas fa-home"></i>
                          <span>論壇首頁</span>
                      </a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" onclick="showTab('topics')">
                          <i class="fas fa-comments"></i>
                          <span>話題討論</span>
                      </a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" onclick="showTab('create')">
                          <i class="fas fa-plus-circle"></i>
                          <span>發表主題</span>
                      </a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" onclick="showTab('profile')">
                          <i class="fas fa-user"></i>
                          <span>個人資料</span>
                      </a>
                  </li>
                  <li class="nav-item" id="adminNavItem" style="display: none;">
                      <a class="nav-link" onclick="showTab('admin')">
                          <i class="fas fa-cog"></i>
                          <span>版主管理</span>
                      </a>
                  </li>
              </ul>
          </div>

          <!-- 內容區域 -->
          <div class="content-area">
              <!-- 論壇首頁 -->
              <div id="dashboard" class="tab-content active">
                  <!-- 用戶資訊卡片 -->
                  <div class="user-info-card">
                      <div class="user-avatar">
                          <i class="fas fa-user"></i>
                      </div>
                      <div class="user-details">
                          <h3 id="welcomeUserName">載入中...</h3>
                          <div class="user-status">
                              <span class="status-dot"></span>
                              <span>已通過LINE LIFF驗證</span>
                          </div>
                      </div>
                  </div>

                  <!-- 統計資訊 -->
                  <div class="stats-grid">
                      <div class="stat-card">
                          <div class="stat-icon" style="color: var(--primary-color);">
                              <i class="fas fa-comments"></i>
                          </div>
                          <div class="stat-number" id="totalTopics">0</div>
                          <div class="stat-label">總話題數</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-icon" style="color: var(--info-color);">
                              <i class="fas fa-reply"></i>
                          </div>
                          <div class="stat-number" id="totalReplies">0</div>
                          <div class="stat-label">總回覆數</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-icon" style="color: var(--warning-color);">
                              <i class="fas fa-users"></i>
                          </div>
                          <div class="stat-number" id="totalUsers">0</div>
                          <div class="stat-label">活躍用戶</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-icon" style="color: var(--success-color);">
                              <i class="fas fa-calendar-day"></i>
                          </div>
                          <div class="stat-number" id="todayTopics">0</div>
                          <div class="stat-label">今日新增</div>
                      </div>
                  </div>

                  <!-- 最新話題預覽 -->
                  <h2><i class="fas fa-fire"></i> 熱門話題</h2>
                  <div id="recentTopicsPreview"></div>
                  
                  <div style="text-align: center; margin-top: 20px;">
                      <button class="btn btn-primary" onclick="showTab('topics')">
                          <i class="fas fa-arrow-right"></i>
                          查看更多話題
                      </button>
                  </div>
              </div>

              <!-- 話題討論區 -->
              <div id="topics" class="tab-content">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                      <h2><i class="fas fa-comments"></i> 話題討論</h2>
                      <button class="btn btn-primary" onclick="showTab('create')">
                          <i class="fas fa-plus"></i>
                          發表新主題
                      </button>
                  </div>

                  <!-- 搜尋和篩選 -->
                  <div class="search-container">
                      <input type="text" id="searchInput" class="search-input" placeholder="搜尋話題、內容或作者...">
                      <button class="search-btn" onclick="searchTopics()">
                          <i class="fas fa-search"></i>
                      </button>
                  </div>

                  <div class="filter-bar">
                      <select id="categoryFilter" class="filter-select" onchange="filterTopics()">
                          <option value="">所有分類</option>
                          <option value="medical">💊 醫療資訊</option>
                          <option value="rehabilitation">🏃‍♂️ 復健運動</option>
                          <option value="nutrition">🍎 營養飲食</option>
                          <option value="psychology">🧠 心理支持</option>
                          <option value="daily">🏠 日常生活</option>
                          <option value="experience">💭 經驗分享</option>
                      </select>
                      
                      <select id="sortFilter" class="filter-select" onchange="filterTopics()">
                          <option value="newest">最新發表</option>
                          <option value="oldest">最早發表</option>
                          <option value="most_replies">最多回覆</option>
                          <option value="most_views">最多瀏覽</option>
                      </select>

                      <button class="btn btn-secondary" onclick="resetFilters()">
                          <i class="fas fa-undo"></i>
                          重置篩選
                      </button>
                  </div>

                  <!-- 話題列表 -->
                  <div id="topicsList"></div>

                  <!-- 分頁 -->
                  <div id="pagination" class="pagination"></div>
              </div>

              <!-- 發表主題 -->
              <div id="create" class="tab-content">
                  <div class="form-container">
                      <h2><i class="fas fa-edit"></i> 發表新主題</h2>
                      <form id="createTopicForm">
                          <div class="form-group">
                              <label for="topicCategory">
                                  <i class="fas fa-folder"></i> 主題分類 *
                              </label>
                              <select id="topicCategory" class="form-control" required>
                                  <option value="">請選擇分類</option>
                                  <option value="medical">💊 醫療資訊</option>
                                  <option value="rehabilitation">🏃‍♂️ 復健運動</option>
                                  <option value="nutrition">🍎 營養飲食</option>
                                  <option value="psychology">🧠 心理支持</option>
                                  <option value="daily">🏠 日常生活</option>
                                  <option value="experience">💭 經驗分享</option>
                              </select>
                          </div>

                          <div class="form-group">
                              <label for="topicTitle">
                                  <i class="fas fa-heading"></i> 主題標題 *
                              </label>
                              <input type="text" id="topicTitle" class="form-control" 
                                     placeholder="請輸入清楚明確的主題標題..." required maxlength="100">
                              <small class="text-muted">建議標題長度 10-100 字元</small>
                          </div>

                          <div class="form-group">
                              <label for="topicContent">
                                  <i class="fas fa-align-left"></i> 內容描述 *
                              </label>
                              <textarea id="topicContent" class="form-control" rows="8" 
                                        placeholder="請詳細描述您想分享的內容，包括背景、問題、經驗等..." required></textarea>
                              <small class="text-muted">建議內容長度至少 50 字元</small>
                          </div>

                          <div class="form-group">
                              <label for="topicTags">
                                  <i class="fas fa-tags"></i> 標籤 (選填)
                              </label>
                              <input type="text" id="topicTags" class="form-control" 
                                     placeholder="例如: 藥物, 副作用, 經驗分享 (用逗號分隔)">
                              <small class="text-muted">標籤有助於其他用戶找到您的主題</small>
                          </div>

                          <div class="form-group">
                              <label>
                                  <i class="fas fa-bell"></i> 通知設定
                              </label>
                              <div class="checkbox-group">
                                  <div class="checkbox-item">
                                      <input type="checkbox" id="notifyReplies" checked>
                                      <label for="notifyReplies">有新回覆時通知我</label>
                                  </div>
                                  <div class="checkbox-item">
                                      <input type="checkbox" id="notifyLine" checked>
                                      <label for="notifyLine">發送LINE通知</label>
                                  </div>
                              </div>
                          </div>

                          <div class="form-group">
                              <button type="submit" class="btn btn-primary">
                                  <i class="fas fa-paper-plane"></i>
                                  發表主題
                              </button>
                              <button type="button" class="btn btn-secondary" onclick="resetCreateForm()">
                                  <i class="fas fa-undo"></i>
                                  重置表單
                              </button>
                          </div>
                      </form>
                  </div>
              </div>

              <!-- 個人資料 -->
              <div id="profile" class="tab-content">
                  <div class="form-container">
                      <h2><i class="fas fa-user-cog"></i> 個人資料設定</h2>
                      <form id="profileForm">
                          <div class="form-group">
                              <label for="displayName">
                                  <i class="fas fa-id-card"></i> 顯示名稱
                              </label>
                              <input type="text" id="displayName" class="form-control" 
                                     placeholder="您的顯示名稱" required>
                          </div>

                          <div class="form-group">
                              <label for="userRole">
                                  <i class="fas fa-user-tag"></i> 身份角色
                              </label>
                              <select id="userRole" class="form-control">
                                  <option value="patient">🤒 患者</option>
                                  <option value="caregiver">👨‍⚕️ 照護者</option>
                                  <option value="medical">🩺 醫療專業人員</option>
                                  <option value="family">👨‍👩‍👧‍👦 家屬</option>
                                  <option value="volunteer">🤝 志工</option>
                              </select>
                          </div>

                          <div class="form-group">
                              <label for="userBio">
                                  <i class="fas fa-info-circle"></i> 個人簡介
                              </label>
                              <textarea id="userBio" class="form-control" rows="4" 
                                        placeholder="簡單介紹您自己，讓其他用戶更了解您..."></textarea>
                          </div>

                          <div class="form-group">
                              <label>
                                  <i class="fas fa-heart"></i> 關注領域
                              </label>
                              <div class="checkbox-group">
                                  <div class="checkbox-item">
                                      <input type="checkbox" id="interest_medical" value="medical">
                                      <label for="interest_medical">💊 醫療資訊</label>
                                  </div>
                                  <div class="checkbox-item">
                                      <input type="checkbox" id="interest_rehabilitation" value="rehabilitation">
                                      <label for="interest_rehabilitation">🏃‍♂️ 復健運動</label>
                                  </div>
                                  <div class="checkbox-item">
                                      <input type="checkbox" id="interest_nutrition" value="nutrition">
                                      <label for="interest_nutrition">🍎 營養飲食</label>
                                  </div>
                                  <div class="checkbox-item">
                                      <input type="checkbox" id="interest_psychology" value="psychology">
                                      <label for="interest_psychology">🧠 心理支持</label>
                                  </div>
                                  <div class="checkbox-item">
                                      <input type="checkbox" id="interest_daily" value="daily">
                                      <label for="interest_daily">🏠 日常生活</label>
                                  </div>
                                  <div class="checkbox-item">
                                      <input type="checkbox" id="interest_experience" value="experience">
                                      <label for="interest_experience">💭 經驗分享</label>
                                  </div>
                              </div>
                          </div>

                          <div class="form-group">
                              <label>
                                  <i class="fas fa-bell"></i> 通知設定
                              </label>
                              <div class="checkbox-group">
                                  <div class="checkbox-item">
                                      <input type="checkbox" id="notify_replies" checked>
                                      <label for="notify_replies">📧 新回覆通知</label>
                                  </div>
                                  <div class="checkbox-item">
                                      <input type="checkbox" id="notify_line" checked>
                                      <label for="notify_line">📱 LINE推送通知</label>
                                  </div>
                                  <div class="checkbox-item">
                                      <input type="checkbox" id="notify_weekly">
                                      <label for="notify_weekly">📊 週報摘要</label>
                                  </div>
                                  <div class="checkbox-item">
                                      <input type="checkbox" id="notify_mentions" checked>
                                      <label for="notify_mentions">🔔 被提及通知</label>
                                  </div>
                              </div>
                          </div>

                          <div class="form-group">
                              <label>
                                  <i class="fas fa-shield-alt"></i> 隱私設定
                              </label>
                              <div class="checkbox-group">
                                  <div class="checkbox-item">
                                      <input type="checkbox" id="privacy_profile" checked>
                                      <label for="privacy_profile">公開個人資料</label>
                                  </div>
                                  <div class="checkbox-item">
                                      <input type="checkbox" id="privacy_activity">
                                      <label for="privacy_activity">顯示活動狀態</label>
                                  </div>
                              </div>
                          </div>

                          <div class="form-group">
                              <button type="submit" class="btn btn-primary">
                                  <i class="fas fa-save"></i>
                                  儲存設定
                              </button>
                              <button type="button" class="btn btn-secondary" onclick="loadUserProfile()">
                                  <i class="fas fa-undo"></i>
                                  重置變更
                              </button>
                          </div>
                      </form>
                  </div>
              </div>

              <!-- 版主管理 -->
              <div id="admin" class="tab-content">
                  <div class="admin-panel">
                      <div class="admin-header">
                          <h2><i class="fas fa-shield-alt"></i> 版主管理面板</h2>
                          <p>論壇管理與監控中心</p>
                      </div>
                      <div class="admin-content">
                          <!-- 管理統計 -->
                          <div class="admin-section">
                              <h3><i class="fas fa-chart-bar"></i> 管理統計</h3>
                              <div class="stats-grid">
                                  <div class="stat-card">
                                      <div class="stat-icon" style="color: var(--info-color);">
                                          <i class="fas fa-eye"></i>
                                      </div>
                                      <div class="stat-number" id="adminTotalViews">0</div>
                                      <div class="stat-label">總瀏覽數</div>
                                  </div>
                                  <div class="stat-card">
                                      <div class="stat-icon" style="color: var(--warning-color);">
                                          <i class="fas fa-flag"></i>
                                      </div>
                                      <div class="stat-number" id="adminReportedContent">0</div>
                                      <div class="stat-label">檢舉內容</div>
                                  </div>
                                  <div class="stat-card">
                                      <div class="stat-icon" style="color: var(--danger-color);">
                                          <i class="fas fa-ban"></i>
                                      </div>
                                      <div class="stat-number" id="adminBlockedUsers">0</div>
                                      <div class="stat-label">封鎖用戶</div>
                                  </div>
                                  <div class="stat-card">
                                      <div class="stat-icon" style="color: var(--success-color);">
                                          <i class="fas fa-check-circle"></i>
                                      </div>
                                      <div class="stat-number" id="adminApprovedContent">0</div>
                                      <div class="stat-label">已審核內容</div>
                                  </div>
                              </div>
                          </div>

                          <!-- 待處理事項 -->
                          <div class="admin-section">
                              <h3><i class="fas fa-tasks"></i> 待處理事項</h3>
                              <div class="pending-items" id="pendingItems">
                                  <!-- 動態載入待處理項目 -->
                              </div>
                          </div>

                          <!-- 管理功能 -->
                          <div class="admin-section">
                              <h3><i class="fas fa-tools"></i> 管理功能</h3>
                              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                  <button class="btn btn-info" onclick="manageCategories()">
                                      <i class="fas fa-folder-open"></i>
                                      分類管理
                                  </button>
                                  <button class="btn btn-info" onclick="manageUsers()">
                                      <i class="fas fa-users-cog"></i>
                                      用戶管理
                                  </button>
                                  <button class="btn btn-warning" onclick="moderateContent()">
                                      <i class="fas fa-search"></i>
                                      內容審核
                                  </button>
                                  <button class="btn btn-secondary" onclick="exportData()">
                                      <i class="fas fa-download"></i>
                                      匯出數據
                                  </button>
                                  <button class="btn btn-primary" onclick="sendAnnouncement()">
                                      <i class="fas fa-bullhorn"></i>
                                      發布公告
                                  </button>
                                  <button class="btn btn-success" onclick="generateReport()">
                                      <i class="fas fa-file-alt"></i>
                                      生成報告
                                  </button>
                              </div>
                          </div>

                          <!-- 系統設定 -->
                          <div class="admin-section">
                              <h3><i class="fas fa-cogs"></i> 系統設定</h3>
                              <form id="systemSettingsForm">
                                  <div class="form-group">
                                      <label for="forumTitle">論壇標題</label>
                                      <input type="text" id="forumTitle" class="form-control" value="帕金森多元化論壇">
                                  </div>
                                  <div class="form-group">
                                      <label for="maxTopicsPerPage">每頁顯示主題數</label>
                                      <input type="number" id="maxTopicsPerPage" class="form-control" value="10" min="5" max="50">
                                  </div>
                                  <div class="form-group">
                                      <label>功能開關</label>
                                      <div class="checkbox-group">
                                          <div class="checkbox-item">
                                              <input type="checkbox" id="enableRegistration" checked>
                                              <label for="enableRegistration">開放註冊</label>
                                          </div>
                                          <div class="checkbox-item">
                                              <input type="checkbox" id="enableGuestView" checked>
                                              <label for="enableGuestView">允許訪客瀏覽</label>
                                          </div>
                                          <div class="checkbox-item">
                                              <input type="checkbox" id="enableAutoApprove">
                                              <label for="enableAutoApprove">自動審核通過</label>
                                          </div>
                                      </div>
                                  </div>
                                  <button type="submit" class="btn btn-primary">
                                      <i class="fas fa-save"></i>
                                      儲存設定
                                  </button>
                              </form>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- 主題詳情模態框 -->
  <div id="topicModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3 class="modal-title" id="modalTopicTitle">主題詳情</h3>
              <button class="close" onclick="closeModal('topicModal')">&times;</button>
          </div>
          <div id="modalTopicContent">
              <!-- 動態載入主題內容 -->
          </div>
      </div>
  </div>

  <!-- 回覆模態框 -->
  <div id="replyModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3 class="modal-title">回覆主題</h3>
              <button class="close" onclick="closeModal('replyModal')">&times;</button>
          </div>
          <form id="replyForm">
              <div class="form-group">
                  <label for="replyContent">回覆內容</label>
                  <textarea id="replyContent" class="form-control" rows="6" 
                            placeholder="請輸入您的回覆內容..." required></textarea>
              </div>
              <div class="form-group">
                  <div class="checkbox-item">
                      <input type="checkbox" id="replyNotifyLine" checked>
                      <label for="replyNotifyLine">發送LINE通知給主題作者</label>
                  </div>
              </div>
              <div class="form-group">
                  <button type="submit" class="btn btn-primary">
                      <i class="fas fa-reply"></i>
                      發送回覆
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="closeModal('replyModal')">
                      <i class="fas fa-times"></i>
                      取消
                  </button>
              </div>
          </form>
      </div>
  </div>

  <script>
      // 全域變數
      const CONFIG = {
          LIFF_ID: '2001679903-O06mNaLy', // 請替換為實際的LIFF ID
          GAS_URL: 'https://script.google.com/macros/s/AKfycbzD_rAzFiX8oEEFrRYjYr8qRHdNjU5dSqs0s8RxVrmuJ8Tv37OlGuDPseJj9mbBkzUifA/exec', // 請替換為實際的GAS Web App URL
          ITEMS_PER_PAGE: 10,
          MAX_CONTENT_PREVIEW: 150
      };

      let currentUser = {
          id: null,
          name: null,
          role: null,
          isAdmin: false
      };

      let currentPage = 1;
      let totalPages = 1;
      let allTopics = [];
      let filteredTopics = [];
      let currentTopicId = null;

      // 初始化應用程式
      document.addEventListener('DOMContentLoaded', async function() {
          showLoading(true);
          await initializeLiff();
          await loadInitialData();
          setupEventListeners();
          showLoading(false);
      });

      // LIFF初始化
      async function initializeLiff() {
          try {
              if (typeof liff !== 'undefined') {
                  await liff.init({ liffId: CONFIG.LIFF_ID });
                  
                  if (liff.isLoggedIn()) {
                      const profile = await liff.getProfile();
                      currentUser.id = profile.userId;
                      currentUser.name = profile.displayName;
                      
                      // 更新UI
                      document.getElementById('welcomeUserName').textContent = `歡迎回來，${currentUser.name}！`;
                      document.getElementById('displayName').value = currentUser.name;
                      
                      // 檢查管理員權限
                      await checkAdminPermission();
                  } else {
                      liff.login();
                      return;
                  }
              } else {
                  // 開發模式或LIFF不可用時的模擬數據
                  currentUser.id = 'test_user_001';
                  currentUser.name = '測試用戶';
                  document.getElementById('welcomeUserName').textContent = `歡迎回來，${currentUser.name}！`;
                  document.getElementById('displayName').value = currentUser.name;
              }
          } catch (error) {
              console.error('LIFF初始化失敗:', error);
              showNotification('LIFF初始化失敗，部分功能可能無法正常使用', 'warning');
              
              // 使用模擬數據
              currentUser.id = 'fallback_user';
              currentUser.name = '訪客用戶';
              document.getElementById('welcomeUserName').textContent = `歡迎，${currentUser.name}！`;
          }
      }

      // 檢查管理員權限
      async function checkAdminPermission() {
          try {
              const response = await apiCall('checkAdminPermission', { userId: currentUser.id });
              if (response.success && response.data.isAdmin) {
                  currentUser.isAdmin = true;
                  currentUser.role = response.data.role;
                  document.getElementById('adminNavItem').style.display = 'block';
              }
          } catch (error) {
              console.error('檢查管理員權限失敗:', error);
          }
      }

      // 載入初始數據
      async function loadInitialData() {
          try {
              await Promise.all([
                  loadForumStats(),
                  loadTopics(),
                  loadUserProfile()
              ]);
          } catch (error) {
              console.error('載入初始數據失敗:', error);
              showNotification('載入數據失敗，請重新整理頁面', 'error');
          }
      }

      // 載入論壇統計
      async function loadForumStats() {
          try {
              const response = await apiCall('getForumStats');
              if (response.success) {
                  const stats = response.data;
                  document.getElementById('totalTopics').textContent = stats.totalTopics || 0;
                  document.getElementById('totalReplies').textContent = stats.totalReplies || 0;
                  document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
                  document.getElementById('todayTopics').textContent = stats.todayTopics || 0;
              }
          } catch (error) {
              console.error('載入統計數據失敗:', error);
          }
      }

      // 載入主題列表
      async function loadTopics() {
          try {
              const response = await apiCall('getTopics');
              if (response.success) {
                  allTopics = response.data || [];
                  filteredTopics = [...allTopics];
                  updateTopicsDisplay();
                  updateRecentTopicsPreview();
              }
          } catch (error) {
              console.error('載入主題失敗:', error);
              showNotification('載入主題失敗', 'error');
          }
      }

      // 更新主題顯示
      function updateTopicsDisplay() {
          const container = document.getElementById('topicsList');
          const startIndex = (currentPage - 1) * CONFIG.ITEMS_PER_PAGE;
          const endIndex = startIndex + CONFIG.ITEMS_PER_PAGE;
          const pageTopics = filteredTopics.slice(startIndex, endIndex);

          if (pageTopics.length === 0) {
              container.innerHTML = `
                  <div class="empty-state">
                      <i class="fas fa-comments"></i>
                      <h3>暫無主題</h3>
                      <p>目前沒有符合條件的主題，來發表第一個主題吧！</p>
                      <button class="btn btn-primary" onclick="showTab('create')">
                          <i class="fas fa-plus"></i>
                          發表主題
                      </button>
                  </div>
              `;
              return;
          }

          container.innerHTML = pageTopics.map(topic => createTopicCard(topic)).join('');
          updatePagination();
      }

      // 創建主題卡片
      function createTopicCard(topic) {
          const categoryNames = {
              'medical': '💊 醫療資訊',
              'rehabilitation': '🏃‍♂️ 復健運動',
              'nutrition': '🍎 營養飲食',
              'psychology': '🧠 心理支持',
              'daily': '🏠 日常生活',
              'experience': '💭 經驗分享'
          };

          const categoryName = categoryNames[topic.category] || topic.category;
          const timeAgo = getTimeAgo(topic.timestamp);
          const contentPreview = topic.content.length > CONFIG.MAX_CONTENT_PREVIEW 
              ? topic.content.substring(0, CONFIG.MAX_CONTENT_PREVIEW) + '...' 
              : topic.content;

          const tags = topic.tags ? topic.tags.split(',').map(tag => 
              `<span class="tag">${tag.trim()}</span>`
          ).join('') : '';

          return `
              <div class="topic-card" data-topic-id="${topic.id}">
                  <div class="topic-header">
                      <div>
                          <div class="topic-title">${escapeHtml(topic.title)}</div>
                          <span class="topic-category">${categoryName}</span>
                      </div>
                  </div>
                  
                  <div class="topic-meta">
                      <div class="meta-item">
                          <i class="fas fa-user"></i>
                          <span>${escapeHtml(topic.userName)}</span>
                      </div>
                      <div class="meta-item">
                          <i class="fas fa-clock"></i>
                          <span>${timeAgo}</span>
                      </div>
                      <div class="meta-item">
                          <i class="fas fa-reply"></i>
                          <span>${topic.replyCount || 0} 回覆</span>
                      </div>
                      <div class="meta-item">
                          <i class="fas fa-eye"></i>
                          <span>${topic.viewCount || 0} 瀏覽</span>
                      </div>
                  </div>
                  
                  <div class="topic-content">${escapeHtml(contentPreview)}</div>
                  
                  ${tags ? `<div class="topic-tags">${tags}</div>` : ''}
                  
                  <div class="topic-actions">
                      <button class="btn btn-primary" onclick="viewTopic(${topic.id})">
                          <i class="fas fa-eye"></i>
                          查看詳情
                      </button>
                      <button class="btn btn-info" onclick="replyTopic(${topic.id})">
                          <i class="fas fa-reply"></i>
                          回覆
                      </button>
                      ${currentUser.isAdmin || topic.userId === currentUser.id ? `
                          <button class="btn btn-warning" onclick="editTopic(${topic.id})">
                              <i class="fas fa-edit"></i>
                              編輯
                          </button>
                      ` : ''}
                      ${currentUser.isAdmin ? `
                          <button class="btn btn-danger" onclick="deleteTopic(${topic.id})">
                              <i class="fas fa-trash"></i>
                              刪除
                          </button>
                      ` : ''}
                  </div>
              </div>
          `;
      }

      // 更新最新主題預覽
      function updateRecentTopicsPreview() {
          const container = document.getElementById('recentTopicsPreview');
          const recentTopics = allTopics.slice(0, 3);
          
          if (recentTopics.length === 0) {
              container.innerHTML = `
                  <div class="empty-state">
                      <i class="fas fa-comments"></i>
                      <p>暫無主題，來發表第一個主題吧！</p>
                  </div>
              `;
              return;
          }

          container.innerHTML = recentTopics.map(topic => createTopicCard(topic)).join('');
      }

      // 更新分頁
      function updatePagination() {
          totalPages = Math.ceil(filteredTopics.length / CONFIG.ITEMS_PER_PAGE);
          const container = document.getElementById('pagination');
          
          if (totalPages <= 1) {
              container.innerHTML = '';
              return;
          }

          let paginationHtml = '';
          
          // 上一頁
          if (currentPage > 1) {
              paginationHtml += `<button class="page-btn" onclick="changePage(${currentPage - 1})">
                  <i class="fas fa-chevron-left"></i>
              </button>`;
          }

          // 頁碼
          const startPage = Math.max(1, currentPage - 2);
          const endPage = Math.min(totalPages, currentPage + 2);

          if (startPage > 1) {
              paginationHtml += `<button class="page-btn" onclick="changePage(1)">1</button>`;
              if (startPage > 2) {
                  paginationHtml += `<span>...</span>`;
              }
          }

          for (let i = startPage; i <= endPage; i++) {
              paginationHtml += `<button class="page-btn ${i === currentPage ? 'active' : ''}" 
                  onclick="changePage(${i})">${i}</button>`;
          }

          if (endPage < totalPages) {
              if (endPage < totalPages - 1) {
                  paginationHtml += `<span>...</span>`;
              }
              paginationHtml += `<button class="page-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
          }

          // 下一頁
          if (currentPage < totalPages) {
              paginationHtml += `<button class="page-btn" onclick="changePage(${currentPage + 1})">
                  <i class="fas fa-chevron-right"></i>
              </button>`;
          }

          container.innerHTML = paginationHtml;
      }

      // 切換頁面
      function changePage(page) {
          currentPage = page;
          updateTopicsDisplay();
          document.querySelector('.content-area').scrollTop = 0;
      }

      // 載入用戶資料
      async function loadUserProfile() {
          try {
              const response = await apiCall('getUserProfile', { userId: currentUser.id });
              if (response.success && response.data) {
                  const profile = response.data;
                  
                  // 更新表單
                  document.getElementById('displayName').value = profile.displayName || currentUser.name;
                  document.getElementById('userRole').value = profile.role || 'patient';
                  document.getElementById('userBio').value = profile.bio || '';
                  
                  // 更新關注領域
                  const interests = profile.interests || [];
                  interests.forEach(interest => {
                      const checkbox = document.getElementById(`interest_${interest}`);
                      if (checkbox) checkbox.checked = true;
                  });
                  
                  // 更新通知設定
                  const notifications = profile.notifications || {};
                  document.getElementById('notify_replies').checked = notifications.replies !== false;
                  document.getElementById('notify_line').checked = notifications.line !== false;
                  document.getElementById('notify_weekly').checked = notifications.weekly === true;
                  document.getElementById('notify_mentions').checked = notifications.mentions !== false;
                  
                  // 更新隱私設定
                  const privacy = profile.privacy || {};
                  document.getElementById('privacy_profile').checked = privacy.profile !== false;
                  document.getElementById('privacy_activity').checked = privacy.activity === true;
              }
          } catch (error) {
              console.error('載入用戶資料失敗:', error);
          }
      }

      // 設定事件監聽器
      function setupEventListeners() {
          // 發表主題表單
          document.getElementById('createTopicForm').addEventListener('submit', handleCreateTopic);
          
          // 個人資料表單
          document.getElementById('profileForm').addEventListener('submit', handleUpdateProfile);
          
          // 回覆表單
          document.getElementById('replyForm').addEventListener('submit', handleReplyTopic);
          
          // 系統設定表單
          const systemForm = document.getElementById('systemSettingsForm');
          if (systemForm) {
              systemForm.addEventListener('submit', handleSystemSettings);
          }
          
          // 搜尋輸入
          document.getElementById('searchInput').addEventListener('input', debounce(searchTopics, 300));
          
          // 模態框點擊外部關閉
          window.addEventListener('click', function(event) {
              if (event.target.classList.contains('modal')) {
                  event.target.style.display = 'none';
              }
          });
          
          // 鍵盤快捷鍵
          document.addEventListener('keydown', function(event) {
              if (event.key === 'Escape') {
                  closeAllModals();
              }
          });
      }

      // 處理發表主題
      async function handleCreateTopic(event) {
          event.preventDefault();
          
          const formData = {
              category: document.getElementById('topicCategory').value,
              title: document.getElementById('topicTitle').value.trim(),
              content: document.getElementById('topicContent').value.trim(),
              tags: document.getElementById('topicTags').value.trim(),
              notifyReplies: document.getElementById('notifyReplies').checked,
              notifyLine: document.getElementById('notifyLine').checked,
              userId: currentUser.id,
              userName: currentUser.name,
              timestamp: new Date().toISOString()
          };
          
          // 表單驗證
          if (!validateTopicForm(formData)) {
              return;
          }
          
          try {
              showLoading(true);
              const response = await apiCall('createTopic', formData);
              
              if (response.success) {
                  showNotification('主題發表成功！', 'success');
                  document.getElementById('createTopicForm').reset();
                  await loadTopics();
                  showTab('topics');
                  
                  // 發送LINE通知
                  if (formData.notifyLine) {
                      await sendLineNotification('新主題發表', formData.title);
                  }
              } else {
                  showNotification(response.error || '發表失敗，請稍後再試', 'error');
              }
          } catch (error) {
              console.error('發表主題失敗:', error);
              showNotification('網路錯誤，請稍後再試', 'error');
          } finally {
              showLoading(false);
          }
      }

      // 處理更新個人資料
      async function handleUpdateProfile(event) {
          event.preventDefault();
          
          const interests = Array.from(document.querySelectorAll('[id^="interest_"]:checked'))
              .map(cb => cb.value);
          
          const profileData = {
              userId: currentUser.id,
              displayName: document.getElementById('displayName').value.trim(),
              role: document.getElementById('userRole').value,
              bio: document.getElementById('userBio').value.trim(),
              interests: interests,
              notifications: {
                  replies: document.getElementById('notify_replies').checked,
                  line: document.getElementById('notify_line').checked,
                  weekly: document.getElementById('notify_weekly').checked,
                  mentions: document.getElementById('notify_mentions').checked
              },
              privacy: {
                  profile: document.getElementById('privacy_profile').checked,
                  activity: document.getElementById('privacy_activity').checked
              }
          };
          
          try {
              showLoading(true);
              const response = await apiCall('updateProfile', profileData);
              
              if (response.success) {
                  showNotification('個人資料更新成功！', 'success');
                  currentUser.name = profileData.displayName;
                  document.getElementById('welcomeUserName').textContent = `歡迎回來，${currentUser.name}！`;
              } else {
                  showNotification(response.error || '更新失敗，請稍後再試', 'error');
              }
          } catch (error) {
              console.error('更新個人資料失敗:', error);
              showNotification('網路錯誤，請稍後再試', 'error');
          } finally {
              showLoading(false);
          }
      }

      // 處理回覆主題
      async function handleReplyTopic(event) {
          event.preventDefault();
          
          const replyData = {
              topicId: currentTopicId,
              content: document.getElementById('replyContent').value.trim(),
              notifyLine: document.getElementById('replyNotifyLine').checked,
              userId: currentUser.id,
              userName: currentUser.name,
              timestamp: new Date().toISOString()
          };
          
          if (!replyData.content) {
              showNotification('請輸入回覆內容', 'warning');
              return;
          }
          
          try {
              showLoading(true);
              const response = await apiCall('replyTopic', replyData);
              
              if (response.success) {
                  showNotification('回覆發表成功！', 'success');
                  closeModal('replyModal');
                  await loadTopics();
                  
                  // 如果主題詳情模態框開啟，重新載入
                  if (document.getElementById('topicModal').style.display === 'block') {
                      await viewTopic(currentTopicId);
                  }
                  
                  // 發送LINE通知
                  if (replyData.notifyLine) {
                      await sendLineNotification('新回覆', `${currentUser.name} 回覆了您的主題`);
                  }
              } else {
                  showNotification(response.error || '回覆失敗，請稍後再試', 'error');
              }
          } catch (error) {
              console.error('回覆失敗:', error);
              showNotification('網路錯誤，請稍後再試', 'error');
          } finally {
              showLoading(false);
          }
      }

      // 查看主題詳情
      async function viewTopic(topicId) {
          try {
              showLoading(true);
              const response = await apiCall('getTopic', { id: topicId });
              
              if (response.success) {
                  const topic = response.data;
                  displayTopicModal(topic);
                  
                  // 增加瀏覽數
                  await apiCall('incrementViewCount', { topicId: topicId });
              } else {
                  showNotification('載入主題失敗', 'error');
              }
          } catch (error) {
              console.error('載入主題詳情失敗:', error);
              showNotification('載入失敗，請稍後再試', 'error');
          } finally {
              showLoading(false);
          }
      }

      // 顯示主題詳情模態框
      function displayTopicModal(topic) {
          const modal = document.getElementById('topicModal');
          const titleElement = document.getElementById('modalTopicTitle');
          const contentElement = document.getElementById('modalTopicContent');
          
          titleElement.textContent = topic.title;
          
          const categoryNames = {
              'medical': '💊 醫療資訊',
              'rehabilitation': '🏃‍♂️ 復健運動',
              'nutrition': '🍎 營養飲食',
              'psychology': '🧠 心理支持',
              'daily': '🏠 日常生活',
              'experience': '💭 經驗分享'
          };
          
          const categoryName = categoryNames[topic.category] || topic.category;
          const timeAgo = getTimeAgo(topic.timestamp);
          const tags = topic.tags ? topic.tags.split(',').map(tag => 
              `<span class="tag">${tag.trim()}</span>`
          ).join('') : '';
          
          contentElement.innerHTML = `
              <div class="topic-card">
                  <div class="topic-header">
                      <span class="topic-category">${categoryName}</span>
                  </div>
                  
                  <div class="topic-meta">
                      <div class="meta-item">
                          <i class="fas fa-user"></i>
                          <span>${escapeHtml(topic.userName)}</span>
                      </div>
                      <div class="meta-item">
                          <i class="fas fa-clock"></i>
                          <span>${timeAgo}</span>
                      </div>
                      <div class="meta-item">
                          <i class="fas fa-eye"></i>
                          <span>${(topic.viewCount || 0) + 1} 瀏覽</span>
                      </div>
                  </div>
                  
                  <div class="topic-content" style="white-space: pre-wrap; margin: 20px 0;">
                      ${escapeHtml(topic.content)}
                  </div>
                  
                  ${tags ? `<div class="topic-tags">${tags}</div>` : ''}
                  
                  <div class="topic-actions">
                      <button class="btn btn-info" onclick="replyTopic(${topic.id})">
                          <i class="fas fa-reply"></i>
                          回覆這個主題
                      </button>
                      ${currentUser.isAdmin || topic.userId === currentUser.id ? `
                          <button class="btn btn-warning" onclick="editTopic(${topic.id})">
                              <i class="fas fa-edit"></i>
                              編輯
                          </button>
                      ` : ''}
                  </div>
              </div>
              
              ${topic.replies && topic.replies.length > 0 ? `
                  <div class="reply-section">
                      <h4><i class="fas fa-comments"></i> 回覆 (${topic.replies.length})</h4>
                      ${topic.replies.map(reply => `
                          <div class="reply-item">
                              <div class="reply-header">
                                  <span class="reply-author">${escapeHtml(reply.userName)}</span>
                                  <span class="reply-time">${getTimeAgo(reply.timestamp)}</span>
                              </div>
                              <div class="reply-content">${escapeHtml(reply.content)}</div>
                          </div>
                      `).join('')}
                  </div>
              ` : ''}
          `;
          
          modal.style.display = 'block';
      }

      // 回覆主題
      function replyTopic(topicId) {
          currentTopicId = topicId;
          document.getElementById('replyContent').value = '';
          document.getElementById('replyModal').style.display = 'block';
      }

      // 搜尋主題
      function searchTopics() {
          const query = document.getElementById('searchInput').value.toLowerCase().trim();
          
          if (!query) {
              filteredTopics = [...allTopics];
          } else {
              filteredTopics = allTopics.filter(topic => 
                  topic.title.toLowerCase().includes(query) ||
                  topic.content.toLowerCase().includes(query) ||
                  topic.userName.toLowerCase().includes(query) ||
                  (topic.tags && topic.tags.toLowerCase().includes(query))
              );
          }
          
          currentPage = 1;
          updateTopicsDisplay();
      }

      // 篩選主題
      function filterTopics() {
          const category = document.getElementById('categoryFilter').value;
          const sort = document.getElementById('sortFilter').value;
          const query = document.getElementById('searchInput').value.toLowerCase().trim();
          
          // 先篩選分類
          let filtered = allTopics;
          if (category) {
              filtered = filtered.filter(topic => topic.category === category);
          }
          
          // 再篩選搜尋
          if (query) {
              filtered = filtered.filter(topic => 
                  topic.title.toLowerCase().includes(query) ||
                  topic.content.toLowerCase().includes(query) ||
                  topic.userName.toLowerCase().includes(query) ||
                  (topic.tags && topic.tags.toLowerCase().includes(query))
              );
          }
          
          // 排序
          switch (sort) {
              case 'newest':
                  filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                  break;
              case 'oldest':
                  filtered.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                  break;
              case 'most_replies':
                  filtered.sort((a, b) => (b.replyCount || 0) - (a.replyCount || 0));
                  break;
              case 'most_views':
                  filtered.sort((a, b) => (b.viewCount || 0) - (a.viewCount || 0));
                  break;
          }
          
          filteredTopics = filtered;
          currentPage = 1;
          updateTopicsDisplay();
      }

      // 重置篩選
      function resetFilters() {
          document.getElementById('searchInput').value = '';
          document.getElementById('categoryFilter').value = '';
          document.getElementById('sortFilter').value = 'newest';
          filteredTopics = [...allTopics];
          currentPage = 1;
          updateTopicsDisplay();
      }

      // 切換標籤頁
      function showTab(tabName) {
          // 隱藏所有標籤內容
          const contents = document.querySelectorAll('.tab-content');
          contents.forEach(content => content.classList.remove('active'));
          
          // 移除所有導航連結的active狀態
          const navLinks = document.querySelectorAll('.nav-link');
          navLinks.forEach(link => link.classList.remove('active'));
          
          // 顯示選中的標籤內容
          const targetTab = document.getElementById(tabName);
          if (targetTab) {
              targetTab.classList.add('active');
          }
          
          // 設定對應導航連結為active
          const targetNavLink = document.querySelector(`[onclick="showTab('${tabName}')"]`);
          if (targetNavLink) {
              targetNavLink.classList.add('active');
          }
          
          // 特殊處理
          if (tabName === 'admin' && currentUser.isAdmin) {
              loadAdminData();
          }
      }

      // 載入管理員數據
      async function loadAdminData() {
          try {
              const response = await apiCall('getAdminStats');
              if (response.success) {
                  const stats = response.data;
                  document.getElementById('adminTotalViews').textContent = stats.totalViews || 0;
                  document.getElementById('adminReportedContent').textContent = stats.reportedContent || 0;
                  document.getElementById('adminBlockedUsers').textContent = stats.blockedUsers || 0;
                  document.getElementById('adminApprovedContent').textContent = stats.approvedContent || 0;
              }
              
              await loadPendingItems();
          } catch (error) {
              console.error('載入管理員數據失敗:', error);
          }
      }

      // 載入待處理事項
      async function loadPendingItems() {
          try {
              const response = await apiCall('getPendingItems');
              if (response.success) {
                  const container = document.getElementById('pendingItems');
                  const items = response.data || [];
                  
                  if (items.length === 0) {
                      container.innerHTML = '<p class="text-muted">目前沒有待處理事項</p>';
                      return;
                  }
                  
                  container.innerHTML = items.map(item => `
                      <div class="pending-item">
                          <div class="item-info">
                              <strong>${item.type}</strong>: ${item.description}
                              <br><small class="text-muted">${getTimeAgo(item.timestamp)}</small>
                          </div>
                          <div class="item-actions">
                              <button class="btn btn-success" onclick="approveItem('${item.id}')">
                                  <i class="fas fa-check"></i>
                                  批准
                              </button>
                              <button class="btn btn-danger" onclick="rejectItem('${item.id}')">
                                  <i class="fas fa-times"></i>
                                  拒絕
                              </button>
                          </div>
                      </div>
                  `).join('');
              }
          } catch (error) {
              console.error('載入待處理事項失敗:', error);
          }
      }

      // 管理功能
      function manageCategories() {
          showNotification('分類管理功能開發中...', 'info');
      }

      function manageUsers() {
          showNotification('用戶管理功能開發中...', 'info');
      }

      function moderateContent() {
          showNotification('內容審核功能開發中...', 'info');
      }

      function exportData() {
          showNotification('數據匯出功能開發中...', 'info');
      }

      function sendAnnouncement() {
          const message = prompt('請輸入公告內容:');
          if (message && message.trim()) {
              sendLineNotification('論壇公告', message.trim());
              showNotification('公告已發送', 'success');
          }
      }

      function generateReport() {
          showNotification('報告生成功能開發中...', 'info');
      }

      // 工具函數
      function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
      }

      function getTimeAgo(timestamp) {
          const now = new Date();
          const time = new Date(timestamp);
          const diff = now - time;
          
          const minutes = Math.floor(diff / 60000);
          const hours = Math.floor(diff / 3600000);
          const days = Math.floor(diff / 86400000);
          
          if (minutes < 1) return '剛剛';
          if (minutes < 60) return `${minutes}分鐘前`;
          if (hours < 24) return `${hours}小時前`;
          if (days < 7) return `${days}天前`;
          
          return time.toLocaleDateString('zh-TW');
      }

      function debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
              const later = () => {
                  clearTimeout(timeout);
                  func(...args);
              };
              clearTimeout(timeout);
              timeout = setTimeout(later, wait);
          };
      }

      function showLoading(show) {
          const overlay = document.getElementById('loadingOverlay');
          overlay.style.display = show ? 'flex' : 'none';
      }

      function showNotification(message, type = 'info') {
          const container = document.getElementById('notificationContainer');
          const notification = document.createElement('div');
          notification.className = `notification ${type}`;
          notification.innerHTML = `
              <i class="fas fa-${getNotificationIcon(type)}"></i>
              ${message}
          `;
          
          container.appendChild(notification);
          
          // 顯示動畫
          setTimeout(() => notification.classList.add('show'), 100);
          
          // 自動隱藏
          setTimeout(() => {
              notification.classList.remove('show');
              setTimeout(() => container.removeChild(notification), 300);
          }, 4000);
      }

      function getNotificationIcon(type) {
          const icons = {
              'success': 'check-circle',
              'error': 'exclamation-circle',
              'warning': 'exclamation-triangle',
              'info': 'info-circle'
          };
          return icons[type] || 'info-circle';
      }

      function closeModal(modalId) {
          document.getElementById(modalId).style.display = 'none';
          if (modalId === 'replyModal') {
              document.getElementById('replyContent').value = '';
          }
      }

      function closeAllModals() {
          const modals = document.querySelectorAll('.modal');
          modals.forEach(modal => modal.style.display = 'none');
      }

      function resetCreateForm() {
          document.getElementById('createTopicForm').reset();
      }

      // 表單驗證
      function validateTopicForm(data) {
          if (!data.category) {
              showNotification('請選擇主題分類', 'warning');
              return false;
          }
          
          if (!data.title || data.title.length < 5) {
              showNotification('主題標題至少需要5個字元', 'warning');
              return false;
          }
          
          if (!data.content || data.content.length < 10) {
              showNotification('內容描述至少需要10個字元', 'warning');
              return false;
          }
          
          return true;
      }

      // API調用
      async function apiCall(action, data = {}) {
          const url = CONFIG.GAS_URL;
          const payload = {
              action: action,
              data: data
          };
          
          try {
              const response = await fetch(url, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(payload)
              });
              
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              return await response.json();
          } catch (error) {
              console.error('API調用失敗:', error);
              throw error;
          }
      }

      // LINE通知
      async function sendLineNotification(type, message) {
          try {
              if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                  await liff.sendMessages([{
                      type: 'text',
                      text: `🔔 ${type}\n\n${message}\n\n來自帕金森多元化論壇`
                  }]);
              }
          } catch (error) {
              console.error('LINE通知發送失敗:', error);
          }
      }

      // 編輯主題
      function editTopic(topicId) {
          showNotification('編輯功能開發中...', 'info');
      }

      // 刪除主題
      async function deleteTopic(topicId) {
          if (!confirm('確定要刪除這個主題嗎？此操作無法復原。')) {
              return;
          }
          
          try {
              showLoading(true);
              const response = await apiCall('deleteTopic', { topicId: topicId });
              
              if (response.success) {
                  showNotification('主題已刪除', 'success');
                  await loadTopics();
              } else {
                  showNotification(response.error || '刪除失敗', 'error');
              }
          } catch (error) {
              console.error('刪除主題失敗:', error);
              showNotification('刪除失敗，請稍後再試', 'error');
          } finally {
              showLoading(false);
          }
      }

      // 批准/拒絕待處理事項
      async function approveItem(itemId) {
          try {
              const response = await apiCall('moderateItem', { 
                  itemId: itemId, 
                  action: 'approve',
                  moderatorId: currentUser.id 
              });
              
              if (response.success) {
                  showNotification('已批准', 'success');
                  await loadPendingItems();
              } else {
                  showNotification('操作失敗', 'error');
              }
          } catch (error) {
              console.error('批准失敗:', error);
              showNotification('操作失敗', 'error');
          }
      }

      async function rejectItem(itemId) {
          try {
              const response = await apiCall('moderateItem', { 
                  itemId: itemId, 
                  action: 'reject',
                  moderatorId: currentUser.id 
              });
              
              if (response.success) {
                  showNotification('已拒絕', 'success');
                  await loadPendingItems();
              } else {
                  showNotification('操作失敗', 'error');
              }
          } catch (error) {
              console.error('拒絕失敗:', error);
              showNotification('操作失敗', 'error');
          }
      }

      // 處理系統設定
      async function handleSystemSettings(event) {
          event.preventDefault();
          
          const settings = {
              forumTitle: document.getElementById('forumTitle').value,
              maxTopicsPerPage: parseInt(document.getElementById('maxTopicsPerPage').value),
              enableRegistration: document.getElementById('enableRegistration').checked,
              enableGuestView: document.getElementById('enableGuestView').checked,
              enableAutoApprove: document.getElementById('enableAutoApprove').checked
          };
          
          try {
              showLoading(true);
              const response = await apiCall('updateSystemSettings', settings);
              
              if (response.success) {
                  showNotification('系統設定已更新', 'success');
                  CONFIG.ITEMS_PER_PAGE = settings.maxTopicsPerPage;
                  updateTopicsDisplay();
              } else {
                  showNotification('更新失敗', 'error');
              }
          } catch (error) {
              console.error('更新系統設定失敗:', error);
              showNotification('更新失敗', 'error');
          } finally {
              showLoading(false);
          }
      }
  </script>
</body>
</html>
