<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>管理員專區</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
body {
    font-family: 'Noto Sans TC', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}
.admin-nav {
    background: white;
    border-radius: 15px;
    margin: 20px;
    padding: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.nav-pills .nav-link {
    border-radius: 10px;
    margin: 0 5px;
    font-weight: 600;
}
.nav-pills .nav-link.active {
    background: linear-gradient(135deg, #2c5aa0, #4a90e2);
}
.content-card {
    background: white;
    border-radius: 20px;
    margin: 20px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}
.stat-card {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
}
.stat-card h3 {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 10px;
}
.table-container {
    max-height: 400px;
    overflow-y: auto;
    border-radius: 10px;
    border: 1px solid #dee2e6;
}
.form-floating {
    margin-bottom: 15px;
}
.form-floating .form-control, .form-floating .form-select {
    border-radius: 10px;
}
.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
}
.alert {
    border-radius: 15px;
    margin-bottom: 20px;
}
.proposal-card {
    border: 1px solid #dee2e6;
    border-radius: 15px;
    margin-bottom: 20px;
    overflow: hidden;
}
.proposal-card .card-header {
    background: linear-gradient(135deg, #6c757d, #495057);
    color: white;
    font-weight: 600;
}
.vote-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}
.vote-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
}
.expense-receipt {
    border: 1px solid #dee2e6;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    background: #fff;
}
.receipt-image {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin-top: 10px;
}
.approval-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-top: 15px;
}
.receipt-card {
    border: 1px solid #dee2e6;
    border-radius: 15px;
    margin-bottom: 20px;
    overflow: hidden;
}
.receipt-card .card-header {
    background: linear-gradient(135deg, #17a2b8, #138496);
    color: white;
    font-weight: 600;
}
.receipt-status {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}
.receipt-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}
</style>
</head>
<body>
<!-- 錯誤/成功訊息 -->
<div id="errorAlert" class="alert alert-danger mx-3" style="display: none;">
<i class="bi bi-exclamation-triangle me-2"></i>
<span id="errorMessage"></span>
</div>

<div id="successAlert" class="alert alert-success mx-3" style="display: none;">
<i class="bi bi-check-circle me-2"></i>
<span id="successMessage"></span>
</div>

<!-- 導航選單 -->
<div class="admin-nav">
<ul class="nav nav-pills justify-content-center" id="adminTabs">
    <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="pill" href="#dashboard">
            <i class="bi bi-speedometer2 me-1"></i>儀表板
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#finance">
            <i class="bi bi-cash-coin me-1"></i>財務管理
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#receipts">
            <i class="bi bi-receipt-cutoff me-1"></i>收據管理
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#members">
            <i class="bi bi-people me-1"></i>會員管理
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#activities">
            <i class="bi bi-calendar-event me-1"></i>活動管理
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#proposals">
            <i class="bi bi-file-text me-1"></i>提案審查
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#expenses">
            <i class="bi bi-receipt me-1"></i>支出審核
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#motions">
            <i class="bi bi-lightning me-1"></i>臨時動議
        </a>
    </li>
</ul>
</div>

<!-- 內容區域 -->
<div class="tab-content">
<!-- 儀表板 -->
<div class="tab-pane fade show active" id="dashboard">
    <div class="content-card">
        <h4 class="mb-4"><i class="bi bi-speedometer2 me-2"></i>系統概覽</h4>
        <div class="row" id="dashboardStats">
            <div class="col-12 text-center">
                <div class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 財務管理 -->
<div class="tab-pane fade" id="finance">
    <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4><i class="bi bi-cash-coin me-2"></i>財務管理</h4>
            <button class="btn btn-success btn-sm" onclick="showTransactionForm()">
                <i class="bi bi-plus-circle me-1"></i>新增交易
            </button>
        </div>
        
        <!-- 交易表單 -->
        <div id="transactionForm" style="display: none;">
            <div class="card border-primary mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">新增交易</h6>
                </div>
                <div class="card-body">
                    <form id="newTransactionForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="transactionDate" required>
                                    <label>日期</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="transactionType" required>
                                        <option value="">請選擇</option>
                                        <option value="收入">收入</option>
                                        <option value="支出">支出</option>
                                    </select>
                                    <label>類型</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="transactionCategory" required>
                                        <option value="">請選擇類別</option>
                                    </select>
                                    <label>類別</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="transactionAmount" required min="1">
                                    <label>金額</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="transactionTarget">
                                    <label>對象</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="transactionAccount" required>
                                        <option value="現金">現金</option>
                                        <option value="銀行">銀行</option>
                                    </select>
                                    <label>帳戶</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="transactionDescription" style="height: 80px;"></textarea>
                                    <label>說明</label>
                                </div>
                            </div>
                            <!-- 收據開立選項 -->
                            <div class="col-12" id="receiptOptions" style="display: none;">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="bi bi-receipt-cutoff me-2"></i>收據開立</h6>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="generateReceipt">
                                            <label class="form-check-label" for="generateReceipt">
                                                開立收據
                                            </label>
                                        </div>
                                        <div id="receiptDetails" style="display: none;">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="form-floating">
                                                        <input type="text" class="form-control" id="receiptName" required>
                                                        <label>收據抬頭</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-floating">
                                                        <input type="email" class="form-control" id="receiptEmail">
                                                        <label>Email（選填）</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-floating">
                                                        <input type="text" class="form-control" id="receiptPhone">
                                                        <label>聯絡電話（選填）</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-floating">
                                                        <input type="text" class="form-control" id="receiptTaxId">
                                                        <label>統一編號（選填）</label>
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="form-floating">
                                                        <textarea class="form-control" id="receiptAddress" style="height: 80px;"></textarea>
                                                        <label>地址（選填）</label>
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="sendReceiptNow">
                                                        <label class="form-check-label" for="sendReceiptNow">
                                                            立即寄送收據（需填寫Email）
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="bi bi-check-circle me-1"></i>儲存
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="hideTransactionForm()">
                                <i class="bi bi-x-circle me-1"></i>取消
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 交易列表 -->
        <div class="table-container mt-4">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>日期</th>
                        <th>類型</th>
                        <th>類別</th>
                        <th>金額</th>
                        <th>對象</th>
                        <th>收據</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="transactionList">
                    <tr><td colspan="7" class="text-center">載入中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 收據管理 -->
<div class="tab-pane fade" id="receipts">
    <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4><i class="bi bi-receipt-cutoff me-2"></i>收據管理</h4>
            <div>
                <button class="btn btn-info btn-sm me-2" onclick="showReceiptTemplateModal()">
                    <i class="bi bi-file-earmark-text me-1"></i>設定模板
                </button>
                <button class="btn btn-success btn-sm" onclick="showManualReceiptForm()">
                    <i class="bi bi-plus-circle me-1"></i>手動開立收據
                </button>
            </div>
        </div>

        <!-- 手動收據表單 -->
        <div id="manualReceiptForm" style="display: none;">
            <div class="card border-success mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">手動開立收據</h6>
                </div>
                <div class="card-body">
                    <form id="newManualReceiptForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="manualReceiptDate" required>
                                    <label>收據日期</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="manualReceiptAmount" required min="1">
                                    <label>金額</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="manualReceiptName" required>
                                    <label>收據抬頭</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="manualReceiptCategory" required>
                                        <option value="">請選擇</option>
                                        <option value="會費">會費</option>
                                        <option value="捐款">捐款</option>
                                        <option value="活動收入">活動收入</option>
                                        <option value="其他收入">其他收入</option>
                                    </select>
                                    <label>收入類別</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="email" class="form-control" id="manualReceiptEmail">
                                    <label>Email（選填）</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="manualReceiptPhone">
                                    <label>聯絡電話（選填）</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="manualReceiptTaxId">
                                    <label>統一編號（選填）</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="manualReceiptPaymentMethod">
                                    <label>付款方式（選填）</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="manualReceiptAddress" style="height: 80px;"></textarea>
                                    <label>地址（選填）</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="manualReceiptNote" style="height: 60px;"></textarea>
                                    <label>備註（選填）</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sendManualReceiptNow">
                                    <label class="form-check-label" for="sendManualReceiptNow">
                                        立即寄送收據（需填寫Email）
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-success me-2">
                                <i class="bi bi-check-circle me-1"></i>開立收據
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="hideManualReceiptForm()">
                                <i class="bi bi-x-circle me-1"></i>取消
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 收據列表 -->
        <div id="receiptList">
            <div class="text-center">載入中...</div>
        </div>
    </div>
</div>

<!-- 會員管理 -->
<div class="tab-pane fade" id="members">
    <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4><i class="bi bi-people me-2"></i>會員管理</h4>
            <button class="btn btn-primary btn-sm" onclick="exportMembers()">
                <i class="bi bi-download me-1"></i>匯出會員
            </button>
        </div>
        
        <div class="table-container">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>姓名</th>
                        <th>電話</th>
                        <th>會員狀態</th>
                        <th>加入日期</th>
                        <th>最後捐款</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="memberList">
                    <tr><td colspan="6" class="text-center">載入中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 活動管理 -->
<div class="tab-pane fade" id="activities">
    <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4><i class="bi bi-calendar-event me-2"></i>活動管理</h4>
            <button class="btn btn-success btn-sm" onclick="showActivityForm()">
                <i class="bi bi-plus-circle me-1"></i>新增活動
            </button>
        </div>
        
        <!-- 活動表單 -->
        <div id="activityForm" style="display: none;">
            <div class="card border-success mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">新增活動</h6>
                </div>
                <div class="card-body">
                    <form id="newActivityForm">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="activityName" required>
                                    <label>活動名稱</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select class="form-select" id="activityType" required>
                                        <option value="">請選擇</option>
                                        <option value="講座">講座</option>
                                        <option value="聚會">聚會</option>
                                        <option value="旅遊">旅遊</option>
                                        <option value="運動">運動</option>
                                        <option value="志工服務">志工服務</option>
                                        <option value="其他">其他</option>
                                    </select>
                                    <label>活動類型</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="activityDate" required>
                                    <label>活動日期</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="time" class="form-control" id="activityTime">
                                    <label>活動時間</label>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="activityLocation">
                                    <label>活動地點</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="activityMaxPeople" min="1" value="50">
                                    <label>人數上限</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="activityDescription" style="height: 100px;"></textarea>
                                    <label>活動描述</label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-success me-2">
                                <i class="bi bi-check-circle me-1"></i>建立活動
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="hideActivityForm()">
                                <i class="bi bi-x-circle me-1"></i>取消
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 活動列表 -->
        <div class="row" id="activityList">
            <div class="col-12 text-center">載入中...</div>
        </div>
    </div>
</div>

<!-- 提案審查 -->
<div class="tab-pane fade" id="proposals">
    <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4><i class="bi bi-file-text me-2"></i>提案審查</h4>
            <button class="btn btn-success btn-sm" onclick="showProposalForm()">
                <i class="bi bi-plus-circle me-1"></i>新增提案
            </button>
        </div>

        <!-- 提案表單 -->
        <div id="proposalForm" style="display: none;">
            <div class="card border-success mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">新增提案</h6>
                </div>
                <div class="card-body">
                    <form id="newProposalForm">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="proposalTitle" required>
                                    <label>提案標題</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select class="form-select" id="proposalType" required>
                                        <option value="">請選擇</option>
                                        <option value="預算提案">預算提案</option>
                                        <option value="活動提案">活動提案</option>
                                        <option value="制度提案">制度提案</option>
                                        <option value="人事提案">人事提案</option>
                                        <option value="其他提案">其他提案</option>
                                    </select>
                                    <label>提案類型</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="proposalContent" style="height: 120px;" required></textarea>
                                    <label>提案內容</label>
                                </div>
                            </div>
                              <div class="col-md-6">
                                  <div class="form-floating">
                                      <input type="number" class="form-control" id="proposalBudget" min="0">
                                      <label>預算金額（如適用）</label>
                                  </div>
                              </div>
                              <div class="col-md-6">
                                  <div class="form-floating">
                                      <input type="date" class="form-control" id="proposalDeadline">
                                      <label>執行期限（如適用）</label>
                                  </div>
                              </div>
                          </div>
                          <div class="mt-3">
                              <button type="submit" class="btn btn-success me-2">
                                  <i class="bi bi-check-circle me-1"></i>提交提案
                              </button>
                              <button type="button" class="btn btn-secondary" onclick="hideProposalForm()">
                                  <i class="bi bi-x-circle me-1"></i>取消
                              </button>
                          </div>
                      </form>
                  </div>
              </div>
          </div>

          <!-- 提案列表 -->
          <div id="proposalList">
              <div class="text-center">載入中...</div>
          </div>
      </div>
  </div>

  <!-- 支出審核 -->
  <div class="tab-pane fade" id="expenses">
      <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-4">
              <h4><i class="bi bi-receipt me-2"></i>支出憑證審核</h4>
              <button class="btn btn-success btn-sm" onclick="showExpenseForm()">
                  <i class="bi bi-plus-circle me-1"></i>提交憑證
              </button>
          </div>

          <!-- 支出憑證表單 -->
          <div id="expenseForm" style="display: none;">
              <div class="card border-warning mb-4">
                  <div class="card-header bg-warning text-dark">
                      <h6 class="mb-0">提交支出憑證</h6>
                  </div>
                  <div class="card-body">
                      <form id="newExpenseForm">
                          <div class="row g-3">
                              <div class="col-md-6">
                                  <div class="form-floating">
                                      <input type="date" class="form-control" id="expenseDate" required>
                                      <label>支出日期</label>
                                  </div>
                              </div>
                              <div class="col-md-6">
                                  <div class="form-floating">
                                      <input type="number" class="form-control" id="expenseAmount" required min="1">
                                      <label>支出金額</label>
                                  </div>
                              </div>
                              <div class="col-md-6">
                                  <div class="form-floating">
                                      <select class="form-select" id="expenseCategory" required>
                                          <option value="">請選擇</option>
                                          <option value="活動費用">活動費用</option>
                                          <option value="辦公費用">辦公費用</option>
                                          <option value="交通費">交通費</option>
                                          <option value="餐費">餐費</option>
                                          <option value="場地費">場地費</option>
                                          <option value="其他支出">其他支出</option>
                                      </select>
                                      <label>支出類別</label>
                                  </div>
                              </div>
                              <div class="col-md-6">
                                  <div class="form-floating">
                                      <input type="text" class="form-control" id="expenseVendor" required>
                                      <label>廠商/店家</label>
                                  </div>
                              </div>
                              <div class="col-12">
                                  <div class="form-floating">
                                      <textarea class="form-control" id="expenseDescription" style="height: 80px;" required></textarea>
                                      <label>支出說明</label>
                                  </div>
                              </div>
                              <div class="col-12">
                                  <label class="form-label">上傳憑證圖片</label>
                                  <input type="file" class="form-control" id="expenseReceipt" accept="image/*" required>
                              </div>
                          </div>
                          <div class="mt-3">
                              <button type="submit" class="btn btn-warning me-2">
                                  <i class="bi bi-check-circle me-1"></i>提交審核
                              </button>
                              <button type="button" class="btn btn-secondary" onclick="hideExpenseForm()">
                                  <i class="bi bi-x-circle me-1"></i>取消
                              </button>
                          </div>
                      </form>
                  </div>
              </div>
          </div>

          <!-- 支出憑證列表 -->
          <div id="expenseList">
              <div class="text-center">載入中...</div>
          </div>
      </div>
  </div>

  <!-- 臨時動議 -->
  <div class="tab-pane fade" id="motions">
      <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-4">
              <h4><i class="bi bi-lightning me-2"></i>臨時動議</h4>
              <button class="btn btn-danger btn-sm" onclick="showMotionForm()">
                  <i class="bi bi-plus-circle me-1"></i>提出動議
              </button>
          </div>

          <!-- 臨時動議表單 -->
          <div id="motionForm" style="display: none;">
              <div class="card border-danger mb-4">
                  <div class="card-header bg-danger text-white">
                      <h6 class="mb-0">提出臨時動議</h6>
                  </div>
                  <div class="card-body">
                      <form id="newMotionForm">
                          <div class="row g-3">
                              <div class="col-12">
                                  <div class="form-floating">
                                      <input type="text" class="form-control" id="motionTitle" required>
                                      <label>動議標題</label>
                                  </div>
                              </div>
                              <div class="col-md-6">
                                  <div class="form-floating">
                                      <select class="form-select" id="motionUrgency" required>
                                          <option value="">請選擇</option>
                                          <option value="緊急">緊急</option>
                                          <option value="重要">重要</option>
                                          <option value="一般">一般</option>
                                      </select>
                                      <label>緊急程度</label>
                                  </div>
                              </div>
                              <div class="col-md-6">
                                  <div class="form-floating">
                                      <input type="date" class="form-control" id="motionDeadline">
                                      <label>希望決議期限</label>
                                  </div>
                              </div>
                              <div class="col-12">
                                  <div class="form-floating">
                                      <textarea class="form-control" id="motionContent" style="height: 120px;" required></textarea>
                                      <label>動議內容</label>
                                  </div>
                              </div>
                              <div class="col-12">
                                  <div class="form-floating">
                                      <textarea class="form-control" id="motionReason" style="height: 80px;" required></textarea>
                                      <label>提出理由</label>
                                  </div>
                              </div>
                          </div>
                          <div class="mt-3">
                              <button type="submit" class="btn btn-danger me-2">
                                  <i class="bi bi-check-circle me-1"></i>提出動議
                              </button>
                              <button type="button" class="btn btn-secondary" onclick="hideMotionForm()">
                                  <i class="bi bi-x-circle me-1"></i>取消
                              </button>
                          </div>
                      </form>
                  </div>
              </div>
          </div>

          <!-- 臨時動議列表 -->
          <div id="motionList">
              <div class="text-center">載入中...</div>
          </div>
      </div>
  </div>
</div>

<!-- 收據模板設定 Modal -->
<div class="modal fade" id="receiptTemplateModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>收據模板設定</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="receiptTemplateForm">
          <div class="mb-3">
            <label class="form-label">Google 文件模板 ID</label>
            <input type="text" class="form-control" id="templateDocId" placeholder="請輸入 Google 文件 ID">
            <div class="form-text">請先在 Google 文件中建立收據模板，並將文件 ID 填入此處</div>
          </div>
          <div class="mb-3">
            <label class="form-label">收據編號前綴</label>
            <input type="text" class="form-control" id="receiptPrefix" value="RCP" placeholder="例：RCP">
          </div>
          <div class="mb-3">
            <label class="form-label">機構名稱</label>
            <input type="text" class="form-control" id="organizationName" placeholder="請輸入機構名稱">
          </div>
          <div class="mb-3">
            <label class="form-label">機構地址</label>
            <textarea class="form-control" id="organizationAddress" rows="2" placeholder="請輸入機構地址"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">機構電話</label>
            <input type="text" class="form-control" id="organizationPhone" placeholder="請輸入機構電話">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="saveReceiptTemplate()">儲存設定</button>
      </div>
    </div>
  </div>
</div>

<script>
  let userId = null;
  let isAdmin = false;
  let userRole = null;
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbyZpV5ljUHHjDEMFA9gsyA02qO1o0eTKCzKrLOmsc0Nit0dG8u4L1uC6q66I76Fn4korg/exec';
  
  // 初始化 LIFF
  liff.init({ liffId: '1656516134-k8rMQwnQ' }).then(() => {
      if (!liff.isLoggedIn()) {
          liff.login();
          return;
      }
      
      liff.getProfile().then(profile => {
          userId = profile.userId;
          checkAdminPermission();
      }).catch(err => {
          console.error('取得用戶資料失敗:', err);
          showError('無法取得用戶資料，請重新開啟頁面');
      });
  }).catch(err => {
        console.error('LIFF初始化失敗:', err);
        showError('系統初始化失敗，請重新開啟頁面');
    });
    
    // 檢查管理員權限
    async function checkAdminPermission() {
        try {
            const response = await fetch(`${GAS_URL}?action=getUserInfo&userId=${encodeURIComponent(userId)}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message || '權限驗證失敗');
            }
            
            userRole = result.data.userInfo.用戶角色;
            
            if (!['admin', 'chairman', 'director', 'supervisor'].includes(userRole)) {
                showError('您沒有管理員權限');
                setTimeout(() => {
                    if (liff.isInClient()) {
                        liff.closeWindow();
                    }
                }, 2000);
                return;
            }
            
            isAdmin = true;
            loadDashboard();
        } catch (error) {
            console.error('權限驗證失敗:', error);
            showError(`權限驗證失敗：${error.message}`);
        }
    }
    
    // 載入儀表板
    async function loadDashboard() {
        try {
            const response = await fetch(`${GAS_URL}?action=getDashboardData`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                const stats = result.data;
                document.getElementById('dashboardStats').innerHTML = `
                    <div class="col-md-3">
                        <div class="stat-card">
                            <h3>${stats.總會員數 || 0}</h3>
                            <p><i class="bi bi-people-fill me-1"></i>總會員數</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                            <h3>$${(stats.本月捐款總額 || 0).toLocaleString()}</h3>
                            <p><i class="bi bi-arrow-up-circle me-1"></i>本月捐款</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                            <h3>${stats.本月捐款次數 || 0}</h3>
                            <p><i class="bi bi-heart-fill me-1"></i>捐款次數</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: linear-gradient(135deg, #ffc107, #e0a800);">
                            <h3>${stats.進行中活動 || 0}</h3>
                            <p><i class="bi bi-calendar-check me-1"></i>進行中活動</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card" style="background: linear-gradient(135deg, #6f42c1, #5a32a3);">
                            <h3>${stats.待審提案 || 0}</h3>
                            <p><i class="bi bi-file-text me-1"></i>待審提案</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card" style="background: linear-gradient(135deg, #fd7e14, #e8590c);">
                            <h3>${stats.待審憑證 || 0}</h3>
                            <p><i class="bi bi-receipt me-1"></i>待審憑證</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card" style="background: linear-gradient(135deg, #e83e8c, #d91a72);">
                            <h3>${stats.本月收據數 || 0}</h3>
                            <p><i class="bi bi-receipt-cutoff me-1"></i>本月收據</p>
                        </div>
                    </div>
                `;
            } else {
                throw new Error(result.message || '載入儀表板資料失敗');
            }
        } catch (error) {
            console.error('載入儀表板失敗:', error);
            document.getElementById('dashboardStats').innerHTML = `
                <div class="col-12 text-center text-danger">
                    <i class="bi bi-exclamation-triangle" style="font-size: 48px;"></i>
                    <p class="mt-2">載入儀表板資料失敗</p>
                </div>
            `;
        }
    }

    // === 收據管理功能 ===
    
    // 顯示收據模板設定 Modal
    function showReceiptTemplateModal() {
        const modal = new bootstrap.Modal(document.getElementById('receiptTemplateModal'));
        loadReceiptTemplate();
        modal.show();
    }
    
    // 載入收據模板設定
    async function loadReceiptTemplate() {
        try {
            const response = await fetch(`${GAS_URL}?action=getReceiptTemplate`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.data) {
                const template = result.data;
                document.getElementById('templateDocId').value = template.templateDocId || '';
                document.getElementById('receiptPrefix').value = template.receiptPrefix || 'RCP';
                document.getElementById('organizationName').value = template.organizationName || '';
                document.getElementById('organizationAddress').value = template.organizationAddress || '';
                document.getElementById('organizationPhone').value = template.organizationPhone || '';
            }
        } catch (error) {
            console.error('載入收據模板設定失敗:', error);
        }
    }
    
    // 儲存收據模板設定
    async function saveReceiptTemplate() {
        const templateData = {
            action: 'saveReceiptTemplate',
            templateDocId: document.getElementById('templateDocId').value,
            receiptPrefix: document.getElementById('receiptPrefix').value,
            organizationName: document.getElementById('organizationName').value,
            organizationAddress: document.getElementById('organizationAddress').value,
            organizationPhone: document.getElementById('organizationPhone').value
        };
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(templateData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('收據模板設定已儲存');
                bootstrap.Modal.getInstance(document.getElementById('receiptTemplateModal')).hide();
            } else {
                throw new Error(result.message || '儲存失敗');
            }
        } catch (error) {
            console.error('儲存收據模板設定失敗:', error);
            showError(`儲存失敗：${error.message}`);
        }
    }
    
    // 顯示手動收據表單
    function showManualReceiptForm() {
        document.getElementById('manualReceiptForm').style.display = 'block';
        document.getElementById('manualReceiptDate').value = new Date().toISOString().split('T')[0];
    }
    
    // 隱藏手動收據表單
    function hideManualReceiptForm() {
        document.getElementById('manualReceiptForm').style.display = 'none';
        document.getElementById('newManualReceiptForm').reset();
    }
    
    // 提交手動收據
    document.getElementById('newManualReceiptForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>開立中...';
        submitBtn.disabled = true;
        
        const receiptData = {
            action: 'createManualReceipt',
            收據日期: document.getElementById('manualReceiptDate').value,
            金額: parseInt(document.getElementById('manualReceiptAmount').value),
            收據抬頭: document.getElementById('manualReceiptName').value,
            收入類別: document.getElementById('manualReceiptCategory').value,
            Email: document.getElementById('manualReceiptEmail').value,
            聯絡電話: document.getElementById('manualReceiptPhone').value,
            統一編號: document.getElementById('manualReceiptTaxId').value,
            付款方式: document.getElementById('manualReceiptPaymentMethod').value,
            地址: document.getElementById('manualReceiptAddress').value,
            備註: document.getElementById('manualReceiptNote').value,
            立即寄送: document.getElementById('sendManualReceiptNow').checked,
            開立人: userId
        };
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(receiptData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                const message = receiptData.立即寄送 ? '收據已開立並寄送' : '收據已開立';
                showSuccess(message);
                hideManualReceiptForm();
                loadReceiptList();
                loadDashboard();
            } else {
                throw new Error(result.message || '開立失敗');
            }
        } catch (error) {
            console.error('開立收據失敗:', error);
            showError(`開立失敗：${error.message}`);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
    
    // 載入收據列表
    async function loadReceiptList() {
        try {
            const response = await fetch(`${GAS_URL}?action=getReceiptList`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                document.getElementById('receiptList').innerHTML = result.data.map(r => `
                    <div class="receipt-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">收據編號：${r.收據編號}</h6>
                                <small class="text-light">開立日期：${formatDate(r.收據日期)}</small>
                            </div>
                            <div>
                                <span class="receipt-status ${getReceiptStatusClass(r.狀態)}">${r.狀態}</span>
                                <span class="badge bg-light text-dark ms-2">$${r.金額.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <p class="mb-2"><strong>收據抬頭：</strong>${r.收據抬頭}</p>
                                    <p class="mb-2"><strong>收入類別：</strong>${r.收入類別}</p>
                                    ${r.統一編號 ? `<p class="mb-2"><strong>統一編號：</strong>${r.統一編號}</p>` : ''}
                                    ${r.Email ? `<p class="mb-2"><strong>Email：</strong>${r.Email}</p>` : ''}
                                    ${r.備註 ? `<p class="mb-2"><strong>備註：</strong>${r.備註}</p>` : ''}
                                    <p class="mb-0 text-muted small">開立時間：${formatDateTime(r.開立時間)}</p>
                                </div>
                                <div class="col-md-4">
                                    <div class="receipt-actions">
                                        ${r.PDF連結 ? `
                                            <button class="btn btn-primary btn-sm" onclick="window.open('${r.PDF連結}', '_blank')">
                                                <i class="bi bi-file-pdf me-1"></i>下載PDF
                                            </button>
                                        ` : ''}
                                        ${r.Email && r.狀態 !== '已寄送' ? `
                                            <button class="btn btn-success btn-sm" onclick="sendReceipt('${r.收據ID}')">
                                                <i class="bi bi-envelope me-1"></i>寄送
                                            </button>
                                        ` : ''}
                                        <button class="btn btn-info btn-sm" onclick="regenerateReceiptPDF('${r.收據ID}')">
                                            <i class="bi bi-arrow-clockwise me-1"></i>重新產生
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('receiptList').innerHTML = 
                    '<div class="text-center text-muted">暫無收據資料</div>';
            }
        } catch (error) {
            console.error('載入收據列表失敗:', error);
            document.getElementById('receiptList').innerHTML = 
                '<div class="text-center text-danger">載入收據列表失敗</div>';
        }
    }
    
    // 寄送收據
    async function sendReceipt(receiptId) {
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'sendReceipt',
                    receiptId: receiptId
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('收據已寄送');
                loadReceiptList();
            } else {
                throw new Error(result.message || '寄送失敗');
            }
        } catch (error) {
            console.error('寄送收據失敗:', error);
            showError(`寄送失敗：${error.message}`);
        }
    }
    
    // 重新產生收據PDF
    async function regenerateReceiptPDF(receiptId) {
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'regenerateReceiptPDF',
                    receiptId: receiptId
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('收據PDF已重新產生');
                loadReceiptList();
            } else {
                throw new Error(result.message || '重新產生失敗');
            }
        } catch (error) {
            console.error('重新產生收據PDF失敗:', error);
            showError(`重新產生失敗：${error.message}`);
        }
    }
    
    // 取得收據狀態樣式
    function getReceiptStatusClass(status) {
        switch (status) {
            case '已開立': return 'bg-success text-white';
            case '已寄送': return 'bg-primary text-white';
            case '處理中': return 'bg-warning text-dark';
            case '錯誤': return 'bg-danger text-white';
            default: return 'bg-secondary text-white';
        }
    }

    // === 交易管理功能（含收據開立） ===
    
    // 顯示交易表單
    function showTransactionForm() {
        document.getElementById('transactionForm').style.display = 'block';
        document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
    }
    
    // 隱藏交易表單
    function hideTransactionForm() {
        document.getElementById('transactionForm').style.display = 'none';
        document.getElementById('newTransactionForm').reset();
        document.getElementById('receiptOptions').style.display = 'none';
        document.getElementById('receiptDetails').style.display = 'none';
    }
    
    // 更新類別選項
    document.getElementById('transactionType').addEventListener('change', (e) => {
        const categorySelect = document.getElementById('transactionCategory');
        const receiptOptions = document.getElementById('receiptOptions');
        let options = '<option value="">請選擇類別</option>';
        
        if (e.target.value === '收入') {
            options += `
                <option value="會費">會費</option>
                <option value="捐款">捐款</option>
                <option value="活動收入">活動收入</option>
                <option value="政府補助">政府補助</option>
                <option value="其他收入">其他收入</option>
            `;
            receiptOptions.style.display = 'block';
        } else if (e.target.value === '支出') {
            options += `
                <option value="活動費用">活動費用</option>
                <option value="辦公費用">辦公費用</option>
                <option value="交通費">交通費</option>
                <option value="餐費">餐費</option>
                <option value="場地費">場地費</option>
                <option value="其他支出">其他支出</option>
            `;
            receiptOptions.style.display = 'none';
        } else {
            receiptOptions.style.display = 'none';
        }
        
        categorySelect.innerHTML = options;
    });
    
    // 收據開立選項切換
    document.getElementById('generateReceipt').addEventListener('change', (e) => {
        const receiptDetails = document.getElementById('receiptDetails');
        if (e.target.checked) {
            receiptDetails.style.display = 'block';
            // 自動填入對象到收據抬頭
            const target = document.getElementById('transactionTarget').value;
            if (target) {
                document.getElementById('receiptName').value = target;
            }
        } else {
            receiptDetails.style.display = 'none';
        }
    });
    
    // 提交交易表單（含收據開立）
    document.getElementById('newTransactionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>儲存中...';
        submitBtn.disabled = true;
        
        const formData = {
            action: 'addTransactionWithReceipt',
            日期: document.getElementById('transactionDate').value,
            類型: document.getElementById('transactionType').value,
            類別: document.getElementById('transactionCategory').value,
            金額: parseInt(document.getElementById('transactionAmount').value),
            對象: document.getElementById('transactionTarget').value,
            帳戶: document.getElementById('transactionAccount').value,
            說明: document.getElementById('transactionDescription').value,
            開立收據: document.getElementById('generateReceipt').checked
        };
        
        // 如果要開立收據，加入收據資料
        if (formData.開立收據) {
            formData.收據資料 = {
                收據抬頭: document.getElementById('receiptName').value,
                Email: document.getElementById('receiptEmail').value,
                聯絡電話: document.getElementById('receiptPhone').value,
                統一編號: document.getElementById('receiptTaxId').value,
                地址: document.getElementById('receiptAddress').value,
                立即寄送: document.getElementById('sendReceiptNow').checked
            };
        }
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(formData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                let message = '交易記錄已新增';
                if (formData.開立收據) {
                    message += formData.收據資料.立即寄送 ? '，收據已開立並寄送' : '，收據已開立';
                }
                showSuccess(message);
                hideTransactionForm();
                loadTransactionList();
                loadDashboard();
            } else {
                throw new Error(result.message || '新增失敗');
            }
        } catch (error) {
            console.error('新增交易失敗:', error);
            showError(`新增失敗：${error.message}`);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
    
    // 載入交易列表（含收據資訊）
    async function loadTransactionList() {
        try {
            const response = await fetch(`${GAS_URL}?action=getTransactionList`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                document.getElementById('transactionList').innerHTML = result.data.slice(0, 20).map(t => `
                    <tr>
                        <td>${formatDate(t.日期)}</td>
                        <td><span class="badge ${t.類型 === '收入' ? 'bg-success' : 'bg-danger'}">${t.類型}</span></td>
                        <td>${t.類別}</td>
                        <td class="${t.類型 === '收入' ? 'text-success' : 'text-danger'}">
                            ${t.類型 === '收入' ? '+' : '-'}$${t.金額.toLocaleString()}
                        </td>
                        <td>${t.對象 || '-'}</td>
                        <td>
                            ${t.收據編號 ? `
                                <span class="badge bg-info">${t.收據編號}</span>
                                ${t.收據PDF連結 ? `
                                    <button class="btn btn-outline-primary btn-sm ms-1" onclick="window.open('${t.收據PDF連結}', '_blank')" title="下載收據">
                                        <i class="bi bi-file-pdf"></i>
                                    </button>
                                ` : ''}
                            ` : (t.類型 === '收入' ? `
                                <button class="btn btn-outline-success btn-sm" onclick="createReceiptForTransaction('${t.編號}')" title="補開收據">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            ` : '-')}
                        </td>
                        <td>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteTransaction('${t.編號}')" title="刪除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('transactionList').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-muted">暫無交易記錄</td></tr>';
            }
        } catch (error) {
            console.error('載入交易列表失敗:', error);
            document.getElementById('transactionList').innerHTML = 
                '<tr><td colspan="7" class="text-center text-danger">載入交易列表失敗</td></tr>';
        }
    }
    
    // 為現有交易補開收據
    async function createReceiptForTransaction(transactionId) {
        const receiptData = prompt('請輸入收據抬頭：');
        if (!receiptData || receiptData.trim() === '') return;
        
        const email = prompt('請輸入Email（選填，按取消跳過）：');
        const sendNow = email && confirm('是否立即寄送收據？');
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'createReceiptForTransaction',
                    transactionId: transactionId,
                    收據抬頭: receiptData.trim(),
                    Email: email || '',
                    立即寄送: sendNow || false
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                const message = sendNow ? '收據已開立並寄送' : '收據已開立';
                showSuccess(message);
                loadTransactionList();
                loadReceiptList();
            } else {
                throw new Error(result.message || '開立失敗');
            }
        } catch (error) {
            console.error('補開收據失敗:', error);
            showError(`補開收據失敗：${error.message}`);
        }
    }

    // === 原有功能保持不變 ===
    
    // 載入會員列表
    async function loadMemberList() {
        try {
            const response = await fetch(`${GAS_URL}?action=getMemberList`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                document.getElementById('memberList').innerHTML = result.data.map(m => `
                    <tr>
                        <td>${m.真實姓名 || m.LINE名稱}</td>
                        <td>${m.電話 || '-'}</td>
                        <td>
                            <span class="badge ${m.是否會員 ? 'bg-success' : 'bg-secondary'}">
                                ${m.是否會員 ? '正式會員' : '一般用戶'}
                            </span>
                        </td>
                        <td>${formatDate(m.加入日期)}</td>
                        <td>${m.最後捐款日期 ? formatDate(m.最後捐款日期) : '-'}</td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm" onclick="viewMemberDetail('${m.用戶ID}')" title="查看詳情">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('memberList').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-muted">暫無會員資料</td></tr>';
            }
        } catch (error) {
            console.error('載入會員列表失敗:', error);
            document.getElementById('memberList').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">載入會員列表失敗</td></tr>';
        }
    }
    
    // 標籤頁切換事件
    document.querySelectorAll('#adminTabs a[data-bs-toggle="pill"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', (e) => {
            const target = e.target.getAttribute('href');
            
            switch (target) {
                case '#dashboard':
                    loadDashboard();
                    break;
                case '#finance':
                    loadTransactionList();
                    break;
                case '#receipts':
                    loadReceiptList();
                    break;
                case '#members':
                    loadMemberList();
                    break;
                case '#activities':
                    loadActivityList();
                    break;
                case '#proposals':
                    loadProposalList();
                    break;
                case '#expenses':
                    loadExpenseList();
                    break;
                case '#motions':
                    loadMotionList();
                    break;
            }
        });
    });
    
    // 其他原有函數保持不變...
    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW');
    }
    
    function formatDateTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleString('zh-TW');
    }
    
    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorAlert').style.display = 'block';
        document.getElementById('successAlert').style.display = 'none';
        
        setTimeout(() => {
            document.getElementById('errorAlert').style.display = 'none';
        }, 5000);
    }
    
    function showSuccess(message) {
        document.getElementById('successMessage').textContent = message;
        document.getElementById('successAlert').style.display = 'block';
        document.getElementById('errorAlert').style.display = 'none';
        
        setTimeout(() => {
            document.getElementById('successAlert').style.display = 'none';
        }, 3000);
    }

    // 其他原有功能函數（提案、支出、動議等）保持原樣...
    // [這裡包含所有原有的功能函數，為節省空間不重複列出]
    // === 活動管理功能 ===
    
    // 顯示活動表單
    function showActivityForm() {
        document.getElementById('activityForm').style.display = 'block';
        document.getElementById('activityDate').value = new Date().toISOString().split('T')[0];
    }
    
    // 隱藏活動表單
    function hideActivityForm() {
        document.getElementById('activityForm').style.display = 'none';
        document.getElementById('newActivityForm').reset();
    }
    
    // 提交活動表單
    document.getElementById('newActivityForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>建立中...';
        submitBtn.disabled = true;
        
        const activityData = {
            action: 'addActivity',
            活動名稱: document.getElementById('activityName').value,
            活動類型: document.getElementById('activityType').value,
            活動日期: document.getElementById('activityDate').value,
            活動時間: document.getElementById('activityTime').value,
            活動地點: document.getElementById('activityLocation').value,
            人數上限: parseInt(document.getElementById('activityMaxPeople').value) || 50,
            活動描述: document.getElementById('activityDescription').value,
            建立者: userId
        };
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(activityData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('活動已建立成功');
                hideActivityForm();
                loadActivityList();
                loadDashboard();
            } else {
                throw new Error(result.message || '建立失敗');
            }
        } catch (error) {
            console.error('建立活動失敗:', error);
            showError(`建立失敗：${error.message}`);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
    
    // 載入活動列表
    async function loadActivityList() {
        try {
            const response = await fetch(`${GAS_URL}?action=getActivityList`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                document.getElementById('activityList').innerHTML = result.data.map(a => `
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">${a.活動名稱}</h6>
                                <small>${a.活動類型}</small>
                            </div>
                            <div class="card-body">
                                <p class="card-text">${a.活動描述 || '無描述'}</p>
                                <div class="mb-2">
                                    <i class="bi bi-calendar me-1"></i>
                                    <small>${formatDate(a.活動日期)} ${a.活動時間 || ''}</small>
                                </div>
                                ${a.活動地點 ? `
                                    <div class="mb-2">
                                        <i class="bi bi-geo-alt me-1"></i>
                                        <small>${a.活動地點}</small>
                                    </div>
                                ` : ''}
                                <div class="mb-2">
                                    <i class="bi bi-people me-1"></i>
                                    <small>報名：${a.報名人數 || 0}/${a.人數上限}</small>
                                </div>
                                <div class="progress mb-2" style="height: 5px;">
                                    <div class="progress-bar" style="width: ${((a.報名人數 || 0) / a.人數上限) * 100}%"></div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="d-flex justify-content-between">
                                    <span class="badge ${getActivityStatusBadge(a.活動狀態)}">${a.活動狀態}</span>
                                    <div>
                                        <button class="btn btn-outline-primary btn-sm" onclick="viewActivityDetail('${a.活動ID}')" title="查看詳情">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="exportActivityMembers('${a.活動ID}')" title="匯出名單">
                                            <i class="bi bi-download"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('activityList').innerHTML = 
                    '<div class="col-12 text-center text-muted">暫無活動資料</div>';
            }
        } catch (error) {
            console.error('載入活動列表失敗:', error);
            document.getElementById('activityList').innerHTML = 
                '<div class="col-12 text-center text-danger">載入活動列表失敗</div>';
        }
    }
    
    // 取得活動狀態徽章樣式
    function getActivityStatusBadge(status) {
        switch (status) {
            case '報名中': return 'bg-success';
            case '進行中': return 'bg-primary';
            case '已結束': return 'bg-secondary';
            case '已取消': return 'bg-danger';
            default: return 'bg-info';
        }
    }
    
    // 查看活動詳情
    async function viewActivityDetail(activityId) {
        // 實作活動詳情查看功能
        alert('活動詳情功能開發中');
    }
    
    // 匯出活動成員名單
    async function exportActivityMembers(activityId) {
        try {
            const response = await fetch(`${GAS_URL}?action=exportActivityMembers&activityId=${encodeURIComponent(activityId)}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                // 下載CSV檔案
                const csvContent = result.data;
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `活動報名名單_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccess('名單已匯出');
            } else {
                throw new Error(result.message || '匯出失敗');
            }
        } catch (error) {
            console.error('匯出活動名單失敗:', error);
            showError(`匯出失敗：${error.message}`);
        }
    }

    // === 提案審查功能 ===
    
    // 顯示提案表單
    function showProposalForm() {
        document.getElementById('proposalForm').style.display = 'block';
        const today = new Date();
        const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
        document.getElementById('proposalDeadline').value = nextWeek.toISOString().split('T')[0];
    }
    
    // 隱藏提案表單
    function hideProposalForm() {
        document.getElementById('proposalForm').style.display = 'none';
        document.getElementById('newProposalForm').reset();
    }
    
    // 提交提案表單
    document.getElementById('newProposalForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>提交中...';
        submitBtn.disabled = true;
        
        const proposalData = {
            action: 'addProposal',
            提案標題: document.getElementById('proposalTitle').value,
            提案類型: document.getElementById('proposalType').value,
            提案內容: document.getElementById('proposalContent').value,
            預算金額: parseInt(document.getElementById('proposalBudget').value) || 0,
            執行期限: document.getElementById('proposalDeadline').value,
            提案人: userId
        };
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(proposalData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('提案已提交，等待審查');
                hideProposalForm();
                loadProposalList();
                loadDashboard();
            } else {
                throw new Error(result.message || '提交失敗');
            }
        } catch (error) {
            console.error('提交提案失敗:', error);
            showError(`提交失敗：${error.message}`);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
    
    // 載入提案列表
    async function loadProposalList() {
        try {
            const response = await fetch(`${GAS_URL}?action=getProposalList`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                document.getElementById('proposalList').innerHTML = result.data.map(p => `
                    <div class="proposal-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">${p.提案標題}</h6>
                                <small class="text-light">${p.提案類型} | 提案人：${p.提案人姓名 || '匿名'}</small>
                            </div>
                            <span class="badge ${getProposalStatusBadge(p.審查狀態)}">${p.審查狀態}</span>
                        </div>
                        <div class="card-body">
                            <p class="mb-3">${p.提案內容}</p>
                            ${p.預算金額 > 0 ? `<p class="mb-2"><strong>預算：</strong>$${p.預算金額.toLocaleString()}</p>` : ''}
                            ${p.執行期限 ? `<p class="mb-2"><strong>執行期限：</strong>${formatDate(p.執行期限)}</p>` : ''}
                            <p class="mb-0 text-muted small">提案時間：${formatDateTime(p.提案時間)}</p>
                            
                            ${p.審查狀態 === '待審查' && ['admin', 'chairman', 'director'].includes(userRole) ? `
                                <div class="vote-buttons">
                                    <button class="btn btn-success btn-sm" onclick="voteProposal('${p.提案ID}', '通過')">
                                        <i class="bi bi-check-circle me-1"></i>通過
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="voteProposal('${p.提案ID}', '否決')">
                                        <i class="bi bi-x-circle me-1"></i>否決
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="voteProposal('${p.提案ID}', '修正')">
                                        <i class="bi bi-pencil me-1"></i>需修正
                                    </button>
                                </div>
                            ` : ''}
                            
                            ${p.投票結果 ? `
                                <div class="vote-status">
                                    <div>
                                        <span class="text-success">贊成：${p.投票結果.贊成 || 0}</span>
                                        <span class="text-danger ms-2">反對：${p.投票結果.反對 || 0}</span>
                                        <span class="text-warning ms-2">修正：${p.投票結果.修正 || 0}</span>
                                    </div>
                                    <small class="text-muted">投票進度：${p.投票結果.總投票數}/${p.投票結果.應投票數}</small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('proposalList').innerHTML = 
                    '<div class="text-center text-muted">暫無提案資料</div>';
            }
        } catch (error) {
            console.error('載入提案列表失敗:', error);
            document.getElementById('proposalList').innerHTML = 
                '<div class="text-center text-danger">載入提案列表失敗</div>';
        }
    }
    
    // 取得提案狀態徽章樣式
    function getProposalStatusBadge(status) {
        switch (status) {
            case '待審查': return 'bg-warning text-dark';
            case '審查中': return 'bg-info';
            case '已通過': return 'bg-success';
            case '已否決': return 'bg-danger';
            case '需修正': return 'bg-secondary';
            default: return 'bg-light text-dark';
        }
    }
    
    // 投票提案
    async function voteProposal(proposalId, vote) {
        const comment = vote === '修正' ? prompt('請輸入修正建議：') : prompt('請輸入投票理由（選填）：');
        if (vote === '修正' && (!comment || comment.trim() === '')) {
            showError('修正建議不能為空');
            return;
        }
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'voteProposal',
                    proposalId: proposalId,
                    vote: vote,
                    comment: comment || '',
                    voterId: userId
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('投票已提交');
                loadProposalList();
                loadDashboard();
            } else {
                throw new Error(result.message || '投票失敗');
            }
        } catch (error) {
            console.error('投票失敗:', error);
            showError(`投票失敗：${error.message}`);
        }
    }

    // === 支出審核功能 ===
    
    // 顯示支出憑證表單
    function showExpenseForm() {
        document.getElementById('expenseForm').style.display = 'block';
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    }
    
    // 隱藏支出憑證表單
    function hideExpenseForm() {
        document.getElementById('expenseForm').style.display = 'none';
        document.getElementById('newExpenseForm').reset();
    }
    
    // 提交支出憑證表單
    document.getElementById('newExpenseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>提交中...';
        submitBtn.disabled = true;
        
        const fileInput = document.getElementById('expenseReceipt');
        const file = fileInput.files[0];
        
        if (!file) {
            showError('請選擇憑證圖片');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            return;
        }
        
        // 將圖片轉換為 base64
        const reader = new FileReader();
        reader.onload = async function(e) {
            const expenseData = {
                action: 'addExpense',
                支出日期: document.getElementById('expenseDate').value,
                支出金額: parseInt(document.getElementById('expenseAmount').value),
                支出類別: document.getElementById('expenseCategory').value,
                廠商店家: document.getElementById('expenseVendor').value,
                支出說明: document.getElementById('expenseDescription').value,
                憑證圖片: e.target.result,
                檔案名稱: file.name,
                提交人: userId
            };
            
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(expenseData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('支出憑證已提交，等待審核');
                    hideExpenseForm();
                    loadExpenseList();
                    loadDashboard();
                } else {
                    throw new Error(result.message || '提交失敗');
                }
            } catch (error) {
                console.error('提交支出憑證失敗:', error);
                showError(`提交失敗：${error.message}`);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        };
        
        reader.readAsDataURL(file);
    });
    
    // 載入支出憑證列表
    async function loadExpenseList() {
        try {
            const response = await fetch(`${GAS_URL}?action=getExpenseList`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                document.getElementById('expenseList').innerHTML = result.data.map(e => `
                    <div class="expense-receipt">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6 class="mb-1">${e.廠商店家} - $${e.支出金額.toLocaleString()}</h6>
                                <small class="text-muted">${formatDate(e.支出日期)} | ${e.支出類別}</small>
                            </div>
                            <span class="badge ${getExpenseStatusBadge(e.審核狀態)}">${e.審核狀態}</span>
                        </div>
                        
                        <p class="mb-2">${e.支出說明}</p>
                        
                        ${e.憑證圖片連結 ? `
                            <img src="${e.憑證圖片連結}" class="receipt-image" alt="支出憑證" onclick="window.open('${e.憑證圖片連結}', '_blank')">
                        ` : ''}
                        
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-muted">提交人：${e.提交人姓名 || '匿名'} | ${formatDateTime(e.提交時間)}</small>
                            
                            ${e.審核狀態 === '待審核' && ['admin', 'chairman', 'supervisor'].includes(userRole) ? `
                                <div>
                                    <button class="btn btn-success btn-sm me-1" onclick="approveExpense('${e.憑證ID}', '通過')">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="approveExpense('${e.憑證ID}', '駁回')">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${e.審核意見 ? `
                            <div class="approval-section">
                                <small><strong>審核意見：</strong>${e.審核意見}</small><br>
                                <small class="text-muted">審核人：${e.審核人姓名} | ${formatDateTime(e.審核時間)}</small>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } else {
                document.getElementById('expenseList').innerHTML = 
                    '<div class="text-center text-muted">暫無支出憑證</div>';
            }
        } catch (error) {
            console.error('載入支出憑證列表失敗:', error);
            document.getElementById('expenseList').innerHTML = 
                '<div class="text-center text-danger">載入支出憑證列表失敗</div>';
        }
    }
    
    // 取得支出狀態徽章樣式
    function getExpenseStatusBadge(status) {
        switch (status) {
            case '待審核': return 'bg-warning text-dark';
            case '已通過': return 'bg-success';
            case '已駁回': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }
    
    // 審核支出憑證
    async function approveExpense(expenseId, decision) {
        const comment = prompt(decision === '駁回' ? '請輸入駁回理由：' : '請輸入審核意見（選填）：');
        if (decision === '駁回' && (!comment || comment.trim() === '')) {
            showError('駁回理由不能為空');
            return;
        }
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'approveExpense',
                    expenseId: expenseId,
                    decision: decision,
                    comment: comment || '',
                    reviewerId: userId
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess(`憑證已${decision}`);
                loadExpenseList();
                loadDashboard();
            } else {
                throw new Error(result.message || '審核失敗');
            }
        } catch (error) {
            console.error('審核支出憑證失敗:', error);
            showError(`審核失敗：${error.message}`);
        }
    }

    // === 臨時動議功能 ===
    
    // 顯示臨時動議表單
    function showMotionForm() {
        document.getElementById('motionForm').style.display = 'block';
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('motionDeadline').value = tomorrow.toISOString().split('T')[0];
    }
    
    // 隱藏臨時動議表單
    function hideMotionForm() {
        document.getElementById('motionForm').style.display = 'none';
        document.getElementById('newMotionForm').reset();
    }
    
    // 提交臨時動議表單
    document.getElementById('newMotionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>提出中...';
        submitBtn.disabled = true;
        
        const motionData = {
            action: 'addMotion',
            動議標題: document.getElementById('motionTitle').value,
            緊急程度: document.getElementById('motionUrgency').value,
            希望決議期限: document.getElementById('motionDeadline').value,
            動議內容: document.getElementById('motionContent').value,
            提出理由: document.getElementById('motionReason').value,
            提出人: userId
        };
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(motionData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('臨時動議已提出');
                hideMotionForm();
                loadMotionList();
                loadDashboard();
            } else {
                throw new Error(result.message || '提出失敗');
            }
        } catch (error) {
            console.error('提出臨時動議失敗:', error);
            showError(`提出失敗：${error.message}`);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
    
    // 載入臨時動議列表
    async function loadMotionList() {
        try {
            const response = await fetch(`${GAS_URL}?action=getMotionList`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                document.getElementById('motionList').innerHTML = result.data.map(m => `
                    <div class="card mb-3 border-${getMotionUrgencyColor(m.緊急程度)}">
                        <div class="card-header bg-${getMotionUrgencyColor(m.緊急程度)} text-white d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">${m.動議標題}</h6>
                                <small>提出人：${m.提出人姓名 || '匿名'} | ${m.緊急程度}</small>
                            </div>
                            <span class="badge ${getMotionStatusBadge(m.處理狀態)}">${m.處理狀態}</span>
                        </div>
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">動議內容</h6>
                            <p class="card-text">${m.動議內容}</p>
                            
                            <h6 class="card-subtitle mb-2 text-muted">提出理由</h6>
                            <p class="card-text">${m.提出理由}</p>
                            
                            ${m.希望決議期限 ? `<p class="mb-2"><strong>希望決議期限：</strong>${formatDate(m.希望決議期限)}</p>` : ''}
                            <p class="mb-0 text-muted small">提出時間：${formatDateTime(m.提出時間)}</p>
                            
                            ${m.處理狀態 === '待處理' && ['admin', 'chairman'].includes(userRole) ? `
                                <div class="mt-3">
                                    <button class="btn btn-success btn-sm me-2" onclick="processMotion('${m.動議ID}', '接受')">
                                        <i class="bi bi-check-circle me-1"></i>接受處理
                                    </button>
                                    <button class="btn btn-warning btn-sm me-2" onclick="processMotion('${m.動議ID}', '延後')">
                                        <i class="bi bi-clock me-1"></i>延後處理
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="processMotion('${m.動議ID}', '拒絕')">
                                        <i class="bi bi-x-circle me-1"></i>拒絕處理
                                    </button>
                                </div>
                            ` : ''}
                            
                            ${m.處理意見 ? `
                                <div class="mt-3 p-2 bg-light rounded">
                                    <small><strong>處理意見：</strong>${m.處理意見}</small><br>
                                    <small class="text-muted">處理人：${m.處理人姓名} | ${formatDateTime(m.處理時間)}</small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('motionList').innerHTML = 
                    '<div class="text-center text-muted">暫無臨時動議</div>';
            }
        } catch (error) {
            console.error('載入臨時動議列表失敗:', error);
            document.getElementById('motionList').innerHTML = 
                '<div class="text-center text-danger">載入臨時動議列表失敗</div>';
        }
    }
    
    // 取得動議緊急程度顏色
    function getMotionUrgencyColor(urgency) {
        switch (urgency) {
            case '緊急': return 'danger';
            case '重要': return 'warning';
            case '一般': return 'info';
            default: return 'secondary';
        }
    }
    
    // 取得動議狀態徽章樣式
    function getMotionStatusBadge(status) {
        switch (status) {
            case '待處理': return 'bg-warning text-dark';
            case '處理中': return 'bg-info';
            case '已接受': return 'bg-success';
            case '已延後': return 'bg-secondary';
            case '已拒絕': return 'bg-danger';
            default: return 'bg-light text-dark';
        }
    }
    
    // 處理臨時動議
    async function processMotion(motionId, action) {
        const comment = prompt(`請輸入${action}理由：`);
        if (!comment || comment.trim() === '') {
            showError(`${action}理由不能為空`);
            return;
        }
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'processMotion',
                    motionId: motionId,
                    decision: action,
                    comment: comment,
                    processerId: userId
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess(`動議已${action}`);
                loadMotionList();
                loadDashboard();
            } else {
                throw new Error(result.message || '處理失敗');
            }
        } catch (error) {
            console.error('處理臨時動議失敗:', error);
            showError(`處理失敗：${error.message}`);
        }
    }

    // === 會員管理功能 ===
    
    // 查看會員詳情
    async function viewMemberDetail(memberId) {
        try {
            const response = await fetch(`${GAS_URL}?action=getMemberDetail&memberId=${encodeURIComponent(memberId)}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                const member = result.data;
                const modalHtml = `
                    <div class="modal fade" id="memberDetailModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">會員詳情 - ${member.真實姓名 || member.LINE名稱}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>基本資料</h6>
                                            <p><strong>姓名：</strong>${member.真實姓名 || '未提供'}</p>
                                            <p><strong>LINE名稱：</strong>${member.LINE名稱}</p>
                                            <p><strong>電話：</strong>${member.電話 || '未提供'}</p>
                                            <p><strong>Email：</strong>${member.Email || '未提供'}</p>
                                            <p><strong>會員狀態：</strong>
                                                <span class="badge ${member.是否會員 ? 'bg-success' : 'bg-secondary'}">
                                                    ${member.是否會員 ? '正式會員' : '一般用戶'}
                                                </span>
                                            </p>
                                            <p><strong>加入日期：</strong>${formatDate(member.加入日期)}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>捐款統計</h6>
                                            <p><strong>總捐款金額：</strong>$${(member.總捐款金額 || 0).toLocaleString()}</p>
                                            <p><strong>捐款次數：</strong>${member.捐款次數 || 0} 次</p>
                                            <p><strong>最後捐款：</strong>${member.最後捐款日期 ? formatDate(member.最後捐款日期) : '無'}</p>
                                            <p><strong>平均捐款：</strong>$${member.捐款次數 > 0 ? Math.round((member.總捐款金額 || 0) / member.捐款次數).toLocaleString() : '0'}</p>
                                        </div>
                                    </div>
                                    
                                    ${member.捐款記錄 && member.捐款記錄.length > 0 ? `
                                        <hr>
                                        <h6>最近捐款記錄</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>日期</th>
                                                        <th>金額</th>
                                                        <th>類別</th>
                                                        <th>收據</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${member.捐款記錄.slice(0, 5).map(d => `
                                                        <tr>
                                                            <td>${formatDate(d.日期)}</td>
                                                            <td class="text-success">$${d.金額.toLocaleString()}</td>
                                                            <td>${d.類別}</td>
                                                            <td>${d.收據編號 || '-'}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    ` : ''}
                                    
                                    ${member.活動參與 && member.活動參與.length > 0 ? `
                                        <hr>
                                        <h6>活動參與記錄</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>活動名稱</th>
                                                        <th>日期</th>
                                                        <th>狀態</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${member.活動參與.slice(0, 5).map(a => `
                                                        <tr>
                                                            <td>${a.活動名稱}</td>
                                                            <td>${formatDate(a.活動日期)}</td>
                                                            <td>
                                                                <span class="badge ${a.參與狀態 === '已參加' ? 'bg-success' : 'bg-warning'}">
                                                                    ${a.參與狀態}
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                                    ${member.是否會員 ? `
                                        <button type="button" class="btn btn-warning" onclick="updateMemberStatus('${member.用戶ID}', false)">
                                            取消會員資格
                                        </button>
                                    ` : `
                                        <button type="button" class="btn btn-success" onclick="updateMemberStatus('${member.用戶ID}', true)">
                                            升級為會員
                                        </button>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 移除舊的 modal
                const oldModal = document.getElementById('memberDetailModal');
                if (oldModal) {
                    oldModal.remove();
                }
                
                // 加入新的 modal
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modal = new bootstrap.Modal(document.getElementById('memberDetailModal'));
                modal.show();
                
            } else {
                throw new Error(result.message || '載入會員詳情失敗');
            }
        } catch (error) {
            console.error('查看會員詳情失敗:', error);
            showError(`查看會員詳情失敗：${error.message}`);
        }
    }
    
    // 更新會員狀態
    async function updateMemberStatus(memberId, isMember) {
        const action = isMember ? '升級為會員' : '取消會員資格';
        if (!confirm(`確定要${action}嗎？`)) return;
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'updateMemberStatus',
                    memberId: memberId,
                    isMember: isMember,
                    updaterId: userId
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess(`會員狀態已更新`);
                bootstrap.Modal.getInstance(document.getElementById('memberDetailModal')).hide();
                loadMemberList();
                loadDashboard();
            } else {
                throw new Error(result.message || '更新失敗');
            }
        } catch (error) {
            console.error('更新會員狀態失敗:', error);
            showError(`更新失敗：${error.message}`);
        }
    }

    // === 交易管理功能補充 ===
    
    // 刪除交易記錄
    async function deleteTransaction(transactionId) {
        if (!confirm('確定要刪除這筆交易記錄嗎？此操作無法復原。')) return;
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'deleteTransaction',
                    transactionId: transactionId,
                    deleterId: userId
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('交易記錄已刪除');
                loadTransactionList();
                loadDashboard();
            } else {
                throw new Error(result.message || '刪除失敗');
            }
        } catch (error) {
            console.error('刪除交易記錄失敗:', error);
            showError(`刪除失敗：${error.message}`);
        }
    }

    // === 系統功能 ===
    
    // 匯出資料
    async function exportData(dataType) {
        try {
            const response = await fetch(`${GAS_URL}?action=exportData&dataType=${dataType}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                // 下載CSV檔案
                const csvContent = result.data;
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${dataType}_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccess(`${dataType}資料已匯出`);
            } else {
                throw new Error(result.message || '匯出失敗');
            }
        } catch (error) {
            console.error('匯出資料失敗:', error);
            showError(`匯出失敗：${error.message}`);
        }
    }
    
    // 系統備份
    async function backupSystem() {
        if (!confirm('確定要進行系統備份嗎？這可能需要幾分鐘時間。')) return;
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'backupSystem',
                    backuperId: userId
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('系統備份已完成');
            } else {
                throw new Error(result.message || '備份失敗');
            }
        } catch (error) {
            console.error('系統備份失敗:', error);
            showError(`備份失敗：${error.message}`);
        }
    }
    
    // 發送系統通知
    async function sendSystemNotification() {
        const message = prompt('請輸入要發送給所有會員的通知訊息：');
        if (!message || message.trim() === '') return;
        
        const sendToAll = confirm('是否發送給所有用戶？\n確定：所有用戶\n取消：僅會員');
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'sendSystemNotification',
                    message: message.trim(),
                    sendToAll: sendToAll,
                    senderId: userId
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess(`通知已發送給 ${result.data.sentCount} 位用戶`);
            } else {
                throw new Error(result.message || '發送失敗');
            }
        } catch (error) {
            console.error('發送系統通知失敗:', error);
            showError(`發送失敗：${error.message}`);
        }
    }
    
    // 頁面載入完成後初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 設定預設標籤頁
        const defaultTab = document.querySelector('#adminTabs a[href="#dashboard"]');
        if (defaultTab) {
            defaultTab.click();
        }
        
        // 設定自動刷新儀表板（每5分鐘）
        setInterval(() => {
            const activeTab = document.querySelector('#adminTabs .nav-link.active');
            if (activeTab && activeTab.getAttribute('href') === '#dashboard') {
                loadDashboard();
            }
        }, 5 * 60 * 1000);
    });
    
    // 頁面關閉前確認
    window.addEventListener('beforeunload', function(e) {
        // 檢查是否有未儲存的表單
        const forms = document.querySelectorAll('form');
        let hasUnsavedChanges = false;
        
        forms.forEach(form => {
            if (form.style.display !== 'none' && form.querySelector('input, textarea, select')) {
                const inputs = form.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (input.value && input.value.trim() !== '') {
                        hasUnsavedChanges = true;
                    }
                });
            }
        });
        
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '您有未儲存的變更，確定要離開嗎？';
            return e.returnValue;
        }
    });

    // === 快捷鍵支援 ===
    document.addEventListener('keydown', function(e) {
        // Ctrl + S: 快速儲存（如果有開啟的表單）
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            const visibleForm = document.querySelector('form[style*="display: block"], form:not([style*="display: none"])');
            if (visibleForm) {
                const submitBtn = visibleForm.querySelector('button[type="submit"]');
                if (submitBtn && !submitBtn.disabled) {
                    submitBtn.click();
                }
            }
        }
        
        // Esc: 關閉開啟的表單或 Modal
        if (e.key === 'Escape') {
            const visibleModal = document.querySelector('.modal.show');
            if (visibleModal) {
                const modal = bootstrap.Modal.getInstance(visibleModal);
                if (modal) modal.hide();
            } else {
                // 關閉開啟的表單
                const forms = ['transactionForm', 'manualReceiptForm', 'activityForm', 'proposalForm', 'expenseForm', 'motionForm'];
                forms.forEach(formId => {
                    const form = document.getElementById(formId);
                    if (form && form.style.display !== 'none') {
                        form.style.display = 'none';
                    }
                });
            }
        }
    });

    // === 錯誤處理和日誌 ===
    window.addEventListener('error', function(e) {
        console.error('JavaScript錯誤:', e.error);
        // 可以在這裡加入錯誤回報機制
    });
    
    window.addEventListener('unhandledrejection', function(e) {
        console.error('未處理的Promise拒絕:', e.reason);
        // 可以在這裡加入錯誤回報機制
    });
    
</script>
</body>
</html>

