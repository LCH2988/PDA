<!-- ===================================================================
   完整 LIFF 前端程式 (Admin 管理員專區 + 個人資料頁)
   說明：
   1. 建議將本檔拆為兩個獨立檔案：
      - admin.html  (管理員後台)
      - profile.html (會員個人資料)
   2. 請自行替換：
      - YOUR_GAS_DEPLOYMENT_URL  為 Apps Script Web App 部署 URL
      - YOUR_LIFF_ID_ADMIN       為後台用 LIFF ID
      - YOUR_LIFF_ID_PROFILE     為個人資料頁 LIFF ID
   3. 若已採用 ScriptProperties 管理敏感資訊，前端不需硬編碼 Token
   4. 所有功能保留，並包含前次回饋修正（getUserInfo 回傳 stats、updateUserProfile 等）
==================================================================== -->


<!-- ========================= admin.html ========================= -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>管理員專區</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height: 100vh;
    }
    .admin-nav {
      background: #fff;
      border-radius: 15px;
      margin: 20px;
      padding: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,.12);
    }
    .nav-pills .nav-link {
      border-radius: 10px;
      margin: 0 5px;
      font-weight: 600;
    }
    .nav-pills .nav-link.active {
      background: linear-gradient(135deg,#2c5aa0,#4a90e2);
    }
    .content-card {
      background: #fff;
      border-radius: 20px;
      margin: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,.1);
    }
    .stat-card {
      background: linear-gradient(135deg,#28a745,#20c997);
      color:#fff;
      border-radius:15px;
      padding:20px;
      margin-bottom:20px;
      text-align:center;
    }
    .stat-card h3 { font-size:2.2rem;font-weight:700;margin-bottom:8px; }
    .table-container {
      max-height: 430px;
      overflow-y: auto;
      border:1px solid #dee2e6;
      border-radius:10px;
    }
    .proposal-card,.receipt-card,.expense-receipt {
      border:1px solid #dee2e6;
      border-radius:15px;
      margin-bottom:20px;
      overflow:hidden;
      background:#fff;
    }
    .proposal-card .card-header {
      background:linear-gradient(135deg,#6c757d,#495057);
      color:#fff;
      font-weight:600;
    }
    .receipt-card .card-header {
      background:linear-gradient(135deg,#17a2b8,#138496);
      color:#fff;
      font-weight:600;
    }
    .receipt-status {
      display:inline-block;
      padding:4px 8px;
      border-radius:12px;
      font-size:.75rem;
      font-weight:600;
    }
    .vote-buttons, .receipt-actions {
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      margin-top:12px;
    }
    .expense-receipt { padding:15px; }
    .receipt-image {
      max-width:100%;height:auto;border-radius:8px;margin-top:8px;cursor:pointer;
    }
    .approval-section {
      background:#f8f9fa;
      border-radius:10px;
      padding:10px 12px;
      margin-top:10px;
      font-size:.85rem;
    }
    .form-floating { margin-bottom:14px; }
    .badge-tight { font-size:.65rem; }
    .loading { padding:45px; text-align:center; }
    .progress { background:#ececec; }
    .spinner-centered { display:flex;justify-content:center;align-items:center;padding:40px; }
    .footer-actions {
      margin: 10px 20px 30px;
      text-align: right;
    }
    .footer-actions .btn { margin-left:6px; }
    @media (max-width: 992px) {
      .table-container { max-height: 360px; }
    }
  </style>
</head>
<body>
  <!-- 全域訊息 -->
  <div id="errorAlert" class="alert alert-danger mx-3 mt-3 d-none">
    <i class="bi bi-exclamation-triangle me-2"></i><span id="errorMessage"></span>
  </div>
  <div id="successAlert" class="alert alert-success mx-3 mt-3 d-none">
    <i class="bi bi-check-circle me-2"></i><span id="successMessage"></span>
  </div>

  <!-- 導航 -->
  <div class="admin-nav">
    <ul class="nav nav-pills justify-content-center" id="adminTabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#dashboard"><i class="bi bi-speedometer2 me-1"></i>儀表板</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#finance"><i class="bi bi-cash-coin me-1"></i>財務管理</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#receipts"><i class="bi bi-receipt-cutoff me-1"></i>收據管理</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#members"><i class="bi bi-people me-1"></i>會員管理</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#activities"><i class="bi bi-calendar-event me-1"></i>活動管理</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#proposals"><i class="bi bi-file-text me-1"></i>提案審查</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#expenses"><i class="bi bi-receipt me-1"></i>支出審核</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#motions"><i class="bi bi-lightning me-1"></i>臨時動議</a></li>
    </ul>
  </div>

  <!-- 內容區 -->
  <div class="tab-content">

    <!-- 儀表板 -->
    <div class="tab-pane fade show active" id="dashboard">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>系統概覽</h4>
          <div>
            <button class="btn btn-outline-primary btn-sm" onclick="manualRefreshDashboard()">
              <i class="bi bi-arrow-clockwise me-1"></i>刷新
            </button>
          </div>
        </div>
        <div class="row" id="dashboardStats">
          <div class="col-12 spinner-centered">
            <div class="spinner-border text-light" role="status"><span class="visually-hidden">載入中...</span></div>
          </div>
        </div>
      </div>

      <div class="footer-actions">
        <button class="btn btn-outline-secondary btn-sm" onclick="backupSystem()"><i class="bi bi-hdd-stack me-1"></i>系統備份</button>
        <button class="btn btn-outline-info btn-sm" onclick="sendSystemNotification()"><i class="bi bi-megaphone me-1"></i>系統通知</button>
        <button class="btn btn-outline-dark btn-sm" onclick="exportDataPrompt()"><i class="bi bi-download me-1"></i>匯出資料</button>
      </div>
    </div>

    <!-- 財務管理 -->
    <div class="tab-pane fade" id="finance">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0"><i class="bi bi-cash-coin me-2"></i>財務管理</h4>
          <button class="btn btn-success btn-sm" onclick="showTransactionForm()"><i class="bi bi-plus-circle me-1"></i>新增交易</button>
        </div>
        <!-- 交易表單 -->
        <div id="transactionForm" class="mb-4" style="display:none;">
          <div class="card border-primary">
            <div class="card-header bg-primary text-white py-2">
              <h6 class="mb-0">新增交易</h6>
            </div>
            <div class="card-body">
              <form id="newTransactionForm">
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="date" id="transactionDate" class="form-control" required>
                      <label>日期</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select id="transactionType" class="form-select" required>
                        <option value="">選擇</option>
                        <option value="收入">收入</option>
                        <option value="支出">支出</option>
                      </select>
                      <label>類型</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select id="transactionCategory" class="form-select" required>
                        <option value="">請先選擇類型</option>
                      </select>
                      <label>類別</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="number" id="transactionAmount" class="form-control" min="1" required>
                      <label>金額</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="text" id="transactionTarget" class="form-control">
                      <label>對象 / 捐款人</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select id="transactionAccount" class="form-select" required>
                        <option value="現金">現金</option>
                        <option value="銀行">銀行</option>
                      </select>
                      <label>帳戶</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="transactionDescription" class="form-control" style="height:80px;"></textarea>
                      <label>說明</label>
                    </div>
                  </div>

                  <!-- 收據開立選項 -->
                  <div class="col-12" id="receiptOptions" style="display:none;">
                    <div class="card bg-light">
                      <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                          <h6 class="card-title mb-0"><i class="bi bi-receipt-cutoff me-2"></i>收據開立</h6>
                        </div>
                        <div class="form-check mb-2">
                          <input class="form-check-input" type="checkbox" id="generateReceipt">
                          <label class="form-check-label" for="generateReceipt">開立收據</label>
                        </div>
                        <div id="receiptDetails" style="display:none;">
                          <div class="row g-3">
                            <div class="col-md-6">
                              <div class="form-floating">
                                <input type="text" id="receiptName" class="form-control">
                                <label>收據抬頭</label>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-floating">
                                <input type="email" id="receiptEmail" class="form-control">
                                <label>Email（選填）</label>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-floating">
                                <input type="text" id="receiptPhone" class="form-control">
                                <label>聯絡電話（選填）</label>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-floating">
                                <input type="text" id="receiptTaxId" class="form-control">
                                <label>統一編號（選填）</label>
                              </div>
                            </div>
                            <div class="col-12">
                              <div class="form-floating">
                                <textarea id="receiptAddress" class="form-control" style="height:70px;"></textarea>
                                <label>地址（選填）</label>
                              </div>
                            </div>
                            <div class="col-12">
                              <div class="form-check">
                                <input type="checkbox" id="sendReceiptNow" class="form-check-input">
                                <label for="sendReceiptNow" class="form-check-label">立即寄送（需 Email）</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div><!-- card-body -->
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-check-circle me-1"></i>儲存
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="hideTransactionForm()">
                    <i class="bi bi-x-circle me-1"></i>取消
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div><!-- 交易表單結束 -->

        <!-- 交易列表 -->
          <div class="table-container">
            <table class="table table-hover table-sm align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th style="min-width:90px;">日期</th>
                  <th>類型</th>
                  <th>類別</th>
                  <th>金額</th>
                  <th>對象</th>
                  <th>收據</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="transactionList">
                <tr><td colspan="7" class="text-center text-muted">載入中...</td></tr>
              </tbody>
            </table>
          </div>
      </div>
    </div>

    <!-- 收據管理 -->
    <div class="tab-pane fade" id="receipts">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0"><i class="bi bi-receipt-cutoff me-2"></i>收據管理</h4>
          <div>
            <button class="btn btn-info btn-sm me-2" onclick="showReceiptTemplateModal()"><i class="bi bi-file-earmark-text me-1"></i>模板設定</button>
            <button class="btn btn-success btn-sm" onclick="showManualReceiptForm()"><i class="bi bi-plus-circle me-1"></i>手動開立</button>
          </div>
        </div>

        <!-- 手動收據表單 -->
        <div id="manualReceiptForm" style="display:none;">
          <div class="card border-success mb-4">
            <div class="card-header bg-success text-white py-2">
              <h6 class="mb-0">手動開立收據</h6>
            </div>
            <div class="card-body">
              <form id="newManualReceiptForm">
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="date" id="manualReceiptDate" class="form-control" required>
                      <label>收據日期</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="number" id="manualReceiptAmount" class="form-control" min="1" required>
                      <label>金額</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="text" id="manualReceiptName" class="form-control" required>
                      <label>收據抬頭</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select id="manualReceiptCategory" class="form-select" required>
                        <option value="">選擇</option>
                        <option value="會費">會費</option>
                        <option value="捐款">捐款</option>
                        <option value="活動收入">活動收入</option>
                        <option value="其他收入">其他收入</option>
                      </select>
                      <label>收入類別</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="email" id="manualReceiptEmail" class="form-control">
                      <label>Email（選填）</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="text" id="manualReceiptPhone" class="form-control">
                      <label>聯絡電話（選填）</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="text" id="manualReceiptTaxId" class="form-control">
                      <label>統一編號（選填）</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="text" id="manualReceiptPaymentMethod" class="form-control">
                      <label>付款方式（選填）</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="manualReceiptAddress" class="form-control" style="height:70px;"></textarea>
                      <label>地址（選填）</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="manualReceiptNote" class="form-control" style="height:60px;"></textarea>
                      <label>備註（選填）</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-check">
                      <input type="checkbox" id="sendManualReceiptNow" class="form-check-input">
                      <label class="form-check-label" for="sendManualReceiptNow">立即寄送（需 Email）</label>
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <button type="submit" class="btn btn-success me-2">
                    <i class="bi bi-check-circle me-1"></i>開立收據
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="hideManualReceiptForm()">
                    <i class="bi bi-x-circle me-1"></i>取消
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- 收據列表 -->
        <div id="receiptList" class="mt-3">
          <div class="text-center text-muted py-4">載入中...</div>
        </div>
      </div>
    </div>

    <!-- 會員管理 -->
    <div class="tab-pane fade" id="members">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0"><i class="bi bi-people me-2"></i>會員管理</h4>
          <button class="btn btn-primary btn-sm" onclick="exportMembers()"><i class="bi bi-download me-1"></i>匯出會員</button>
        </div>
        <div class="table-container">
          <table class="table table-hover table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>姓名</th>
                <th>電話</th>
                <th>會員狀態</th>
                <th>加入日期</th>
                <th>最後捐款</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="memberList">
              <tr><td colspan="6" class="text-center text-muted">載入中...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 活動管理 -->
    <div class="tab-pane fade" id="activities">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0"><i class="bi bi-calendar-event me-2"></i>活動管理</h4>
          <button class="btn btn-success btn-sm" onclick="showActivityForm()"><i class="bi bi-plus-circle me-1"></i>新增活動</button>
        </div>

        <!-- 活動表單 -->
        <div id="activityForm" style="display:none;">
          <div class="card border-success mb-4">
            <div class="card-header bg-success text-white py-2">
              <h6 class="mb-0">新增活動</h6>
            </div>
            <div class="card-body">
              <form id="newActivityForm">
                <div class="row g-3">
                  <div class="col-md-8">
                    <div class="form-floating">
                      <input type="text" id="activityName" class="form-control" required>
                      <label>活動名稱</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select id="activityType" class="form-select" required>
                        <option value="">選擇</option>
                        <option value="講座">講座</option>
                        <option value="聚會">聚會</option>
                        <option value="旅遊">旅遊</option>
                        <option value="運動">運動</option>
                        <option value="志工服務">志工服務</option>
                        <option value="其他">其他</option>
                      </select>
                      <label>活動類型</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="date" id="activityDate" class="form-control" required>
                      <label>活動日期</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="time" id="activityTime" class="form-control">
                      <label>活動時間</label>
                    </div>
                  </div>
                  <div class="col-md-8">
                    <div class="form-floating">
                      <input type="text" id="activityLocation" class="form-control">
                      <label>活動地點</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="number" id="activityMaxPeople" min="1" value="50" class="form-control">
                      <label>人數上限</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="activityDescription" class="form-control" style="height:80px;"></textarea>
                      <label>活動描述</label>
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <button type="submit" class="btn btn-success me-2">
                    <i class="bi bi-check-circle me-1"></i>建立活動
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="hideActivityForm()">
                    <i class="bi bi-x-circle me-1"></i>取消
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- 活動列表 -->
        <div class="row" id="activityList">
          <div class="col-12 text-center text-muted py-4">載入中...</div>
        </div>
      </div>
    </div>

    <!-- 提案審查 -->
    <div class="tab-pane fade" id="proposals">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0"><i class="bi bi-file-text me-2"></i>提案審查</h4>
          <button class="btn btn-success btn-sm" onclick="showProposalForm()"><i class="bi bi-plus-circle me-1"></i>新增提案</button>
        </div>

        <!-- 提案表單 -->
        <div id="proposalForm" style="display:none;">
          <div class="card border-success mb-4">
            <div class="card-header bg-success text-white py-2">
              <h6 class="mb-0">新增提案</h6>
            </div>
            <div class="card-body">
              <form id="newProposalForm">
                <div class="row g-3">
                  <div class="col-md-8">
                    <div class="form-floating">
                      <input type="text" id="proposalTitle" class="form-control" required>
                      <label>提案標題</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select id="proposalType" class="form-select" required>
                        <option value="">選擇</option>
                        <option value="預算提案">預算提案</option>
                        <option value="活動提案">活動提案</option>
                        <option value="制度提案">制度提案</option>
                        <option value="人事提案">人事提案</option>
                        <option value="其他提案">其他提案</option>
                      </select>
                      <label>提案類型</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="proposalContent" class="form-control" style="height:120px;" required></textarea>
                      <label>提案內容</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="number" id="proposalBudget" class="form-control" min="0">
                      <label>預算金額（選填）</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="date" id="proposalDeadline" class="form-control">
                      <label>執行期限（選填）</label>
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <button type="submit" class="btn btn-success me-2">
                    <i class="bi bi-check-circle me-1"></i>提交提案
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="hideProposalForm()">
                    <i class="bi bi-x-circle me-1"></i>取消
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- 提案列表 -->
        <div id="proposalList">
          <div class="text-center text-muted py-4">載入中...</div>
        </div>
      </div>
    </div>

    <!-- 支出審核 -->
    <div class="tab-pane fade" id="expenses">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0"><i class="bi bi-receipt me-2"></i>支出審核</h4>
          <button class="btn btn-warning btn-sm" onclick="showExpenseForm()"><i class="bi bi-plus-circle me-1"></i>提交憑證</button>
        </div>

        <!-- 支出表單 -->
        <div id="expenseForm" style="display:none;">
          <div class="card border-warning mb-4">
            <div class="card-header bg-warning text-dark py-2">
              <h6 class="mb-0">提交支出憑證</h6>
            </div>
            <div class="card-body">
              <form id="newExpenseForm">
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="date" id="expenseDate" class="form-control" required>
                      <label>支出日期</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="number" id="expenseAmount" class="form-control" min="1" required>
                      <label>支出金額</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select id="expenseCategory" class="form-select" required>
                        <option value="">選擇</option>
                        <option value="活動費用">活動費用</option>
                        <option value="辦公費用">辦公費用</option>
                        <option value="交通費">交通費</option>
                        <option value="餐費">餐費</option>
                        <option value="場地費">場地費</option>
                        <option value="其他支出">其他支出</option>
                      </select>
                      <label>支出類別</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" id="expenseVendor" class="form-control" required>
                      <label>廠商 / 店家</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="expenseDescription" class="form-control" style="height:70px;" required></textarea>
                      <label>支出說明</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label fw-semibold">上傳憑證圖片</label>
                    <input type="file" id="expenseReceipt" class="form-control" accept="image/*" required>
                  </div>
                </div>
                <div class="mt-3">
                  <button class="btn btn-warning me-2" type="submit">
                    <i class="bi bi-check-circle me-1"></i>提交審核
                  </button>
                  <button class="btn btn-secondary" type="button" onclick="hideExpenseForm()">
                    <i class="bi bi-x-circle me-1"></i>取消
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- 支出列表 -->
        <div id="expenseList">
          <div class="text-center text-muted py-4">載入中...</div>
        </div>
      </div>
    </div>

    <!-- 臨時動議 -->
    <div class="tab-pane fade" id="motions">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0"><i class="bi bi-lightning me-2"></i>臨時動議</h4>
          <button class="btn btn-danger btn-sm" onclick="showMotionForm()"><i class="bi bi-plus-circle me-1"></i>提出動議</button>
        </div>

        <!-- 動議表單 -->
        <div id="motionForm" style="display:none;">
          <div class="card border-danger mb-4">
            <div class="card-header bg-danger text-white py-2">
              <h6 class="mb-0">提出臨時動議</h6>
            </div>
            <div class="card-body">
              <form id="newMotionForm">
                <div class="row g-3">
                  <div class="col-md-8">
                    <div class="form-floating">
                      <input type="text" id="motionTitle" class="form-control" required>
                      <label>動議標題</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select id="motionUrgency" class="form-select" required>
                        <option value="">選擇</option>
                        <option value="緊急">緊急</option>
                        <option value="重要">重要</option>
                        <option value="一般">一般</option>
                      </select>
                      <label>緊急程度</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="date" id="motionDeadline" class="form-control">
                      <label>希望決議期限</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="motionContent" class="form-control" style="height:100px;" required></textarea>
                      <label>動議內容</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea id="motionReason" class="form-control" style="height:70px;" required></textarea>
                      <label>提出理由</label>
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <button class="btn btn-danger me-2" type="submit"><i class="bi bi-check-circle me-1"></i>提出動議</button>
                  <button class="btn btn-secondary" type="button" onclick="hideMotionForm()"><i class="bi bi-x-circle me-1"></i>取消</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- 動議列表 -->
        <div id="motionList">
          <div class="text-center text-muted py-4">載入中...</div>
        </div>
      </div>
    </div>
  </div><!-- tab-content -->

  <!-- 收據模板設定 Modal -->
  <div class="modal fade" id="receiptTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>收據模板設定</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="receiptTemplateForm">
            <div class="mb-3">
              <label class="form-label">Google 文件模板 ID</label>
              <input type="text" id="templateDocId" class="form-control" placeholder="請輸入文件 ID">
              <div class="form-text">Google Docs 收據模板的檔案 ID</div>
            </div>
            <div class="mb-3">
              <label class="form-label">收據編號前綴</label>
              <input type="text" id="receiptPrefix" class="form-control" value="RCP">
            </div>
            <div class="mb-3">
              <label class="form-label">機構名稱</label>
              <input type="text" id="organizationName" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">機構地址</label>
              <textarea id="organizationAddress" rows="2" class="form-control"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">機構電話</label>
              <input type="text" id="organizationPhone" class="form-control">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary" onclick="saveReceiptTemplate()"><i class="bi bi-save me-1"></i>儲存設定</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 動態插入的 Modal (會員詳情等) -->
  <div id="dynamicModalContainer"></div>

  <script>
    /**********************************************************
     * 全域設定
     **********************************************************/
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyeEQZTAD3sfy_rUtFG-IFMONAT1ywy87_5H9LYWUuyhWo-rhAaZrlZ9d79DAqMvKutfg/exec';
    const LIFF_ID  = '1656516134-k8rMQwnQ';

    let userId = null;
    let userRole = null;
    let isAdmin = false;

    /**********************************************************
     * 初始化 LIFF
     **********************************************************/
    initLiff();
    function initLiff() {
      liff.init({ liffId: LIFF_ID })
        .then(() => {
          if (!liff.isLoggedIn()) { liff.login(); return; }
          return liff.getProfile();
        })
        .then(profile => {
          if (!profile) return;
          userId = profile.userId;
          return checkAdminPermission();
        })
        .catch(err => {
          console.error('LIFF 初始化失敗', err);
          showError('LIFF 初始化失敗：' + err.message);
        });
    }

    /**********************************************************
     * 通用 Fetch 包裝
     **********************************************************/
    async function gasGet(paramsObj) {
      const qs = new URLSearchParams(paramsObj).toString();
      const res = await fetch(`${GAS_URL}?${qs}`, { method: 'GET' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }
    async function gasPost(bodyObj) {
      const res = await fetch(GAS_URL, {
        method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(bodyObj)
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    /**********************************************************
     * 權限檢查
     **********************************************************/
    async function checkAdminPermission() {
      try {
        const result = await gasGet({ action:'getUserInfo', userId });
        if (!result.success) throw new Error(result.message || '權限驗證失敗');
        userRole = result.data.userInfo.用戶角色;
        if (!['admin','chairman','director','supervisor'].includes(userRole)) {
          showError('您沒有管理員權限');
          setTimeout(()=> { if (liff.isInClient()) liff.closeWindow(); }, 2000);
          return;
        }
        isAdmin = true;
        loadDashboard();
      } catch (e) {
        showError('權限檢查失敗：' + e.message);
      }
    }

    /**********************************************************
     * 儀表板
     **********************************************************/
    async function loadDashboard() {
      const container = document.getElementById('dashboardStats');
      container.innerHTML = '<div class="col-12 spinner-centered"><div class="spinner-border text-primary"></div></div>';
      try {
        const result = await gasGet({ action:'getDashboardData' });
        if (!result.success) throw new Error(result.message);
        const s = result.data;
        container.innerHTML = `
          ${buildStatCard('總會員數', s.總會員數, 'bi-people-fill', '#28a745,#20c997')}
          ${buildStatCard('本月捐款', '$' + (s.本月捐款總額||0).toLocaleString(), 'bi-arrow-up-circle', '#17a2b8,#138496')}
          ${buildStatCard('捐款次數', s.本月捐款次數, 'bi-heart-fill', '#dc3545,#c82333')}
          ${buildStatCard('進行中活動', s.進行中活動, 'bi-calendar-check', '#ffc107,#e0a800')}
          <div class="col-md-4">
            <div class="stat-card" style="background:linear-gradient(135deg,#6f42c1,#5a32a3);">
              <h3>${s.待審提案||0}</h3>
              <p><i class="bi bi-file-text me-1"></i>待審提案</p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card" style="background:linear-gradient(135deg,#fd7e14,#e8590c);">
              <h3>${s.待審憑證||0}</h3>
              <p><i class="bi bi-receipt me-1"></i>待審憑證</p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card" style="background:linear-gradient(135deg,#e83e8c,#d91a72);">
              <h3>${s.本月收據數||0}</h3>
              <p><i class="bi bi-receipt-cutoff me-1"></i>本月收據</p>
            </div>
          </div>`;
      } catch (e) {
        container.innerHTML = `<div class="col-12 text-center text-danger py-4">
          <i class="bi bi-exclamation-triangle fs-1"></i><p class="mt-2">載入失敗：${e.message}</p></div>`;
      }
    }
    function buildStatCard(label, value, icon, gradient) {
      return `
        <div class="col-md-3">
          <div class="stat-card" style="background:linear-gradient(135deg,${gradient});">
            <h3>${value || 0}</h3>
            <p><i class="bi ${icon} me-1"></i>${label}</p>
          </div>
        </div>`;
    }
    function manualRefreshDashboard() { loadDashboard(); }

    /**********************************************************
     * 收據模板設定
     **********************************************************/
    function showReceiptTemplateModal() {
      const modal = new bootstrap.Modal('#receiptTemplateModal');
      loadReceiptTemplate().finally(()=> modal.show());
    }
    async function loadReceiptTemplate() {
      try {
        const result = await gasGet({ action:'getReceiptTemplate' });
        if (result.success && result.data) {
          const t = result.data;
          document.getElementById('templateDocId').value = t.templateDocId || '';
          document.getElementById('receiptPrefix').value = t.receiptPrefix || 'RCP';
          document.getElementById('organizationName').value = t.organizationName || '';
          document.getElementById('organizationAddress').value = t.organizationAddress || '';
          document.getElementById('organizationPhone').value = t.organizationPhone || '';
        }
      } catch(e) { console.warn('載入模板設定失敗', e); }
    }
    async function saveReceiptTemplate() {
      try {
        const body = {
          action: 'saveReceiptTemplate',
          templateDocId: document.getElementById('templateDocId').value.trim(),
          receiptPrefix: document.getElementById('receiptPrefix').value.trim(),
          organizationName: document.getElementById('organizationName').value.trim(),
          organizationAddress: document.getElementById('organizationAddress').value.trim(),
          organizationPhone: document.getElementById('organizationPhone').value.trim(),
          userId
        };
        const result = await gasPost(body);
        if (!result.success) throw new Error(result.message);
        showSuccess('模板已儲存');
        bootstrap.Modal.getInstance(document.getElementById('receiptTemplateModal')).hide();
      } catch (e) {
        showError('儲存失敗：' + e.message);
      }
    }

    /**********************************************************
     * 交易管理 + 收據開立
     **********************************************************/
    function showTransactionForm() {
      document.getElementById('transactionForm').style.display='block';
      document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
    }
    function hideTransactionForm() {
      document.getElementById('transactionForm').style.display='none';
      document.getElementById('newTransactionForm').reset();
      document.getElementById('receiptOptions').style.display='none';
      document.getElementById('receiptDetails').style.display='none';
    }

    document.getElementById('transactionType').addEventListener('change', e=>{
      const val=e.target.value;
      const categorySelect = document.getElementById('transactionCategory');
      const receiptOptions = document.getElementById('receiptOptions');
      let html='<option value="">請選擇類別</option>';
      if (val==='收入') {
        html+=`<option value="會費">會費</option>
               <option value="捐款">捐款</option>
               <option value="活動收入">活動收入</option>
               <option value="政府補助">政府補助</option>
               <option value="其他收入">其他收入</option>`;
        receiptOptions.style.display='block';
      } else if (val==='支出') {
        html+=`<option value="活動費用">活動費用</option>
               <option value="辦公費用">辦公費用</option>
               <option value="交通費">交通費</option>
               <option value="餐費">餐費</option>
               <option value="場地費">場地費</option>
               <option value="其他支出">其他支出</option>`;
        receiptOptions.style.display='none';
      } else {
        receiptOptions.style.display='none';
      }
      categorySelect.innerHTML=html;
    });

    document.getElementById('generateReceipt').addEventListener('change', e=>{
      document.getElementById('receiptDetails').style.display = e.target.checked?'block':'none';
      if (e.target.checked) {
        const targetVal = document.getElementById('transactionTarget').value;
          if (targetVal) document.getElementById('receiptName').value = targetVal;
      }
    });

    document.getElementById('newTransactionForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      const old = btn.innerHTML;
      btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>儲存中...';
      const payload = {
        action:'addTransactionWithReceipt',
        日期: document.getElementById('transactionDate').value,
        類型: document.getElementById('transactionType').value,
        類別: document.getElementById('transactionCategory').value,
        金額: parseInt(document.getElementById('transactionAmount').value),
        對象: document.getElementById('transactionTarget').value.trim(),
        帳戶: document.getElementById('transactionAccount').value,
        說明: document.getElementById('transactionDescription').value.trim(),
        開立收據: document.getElementById('generateReceipt').checked,
        userId
      };
      if (payload.開立收據) {
        payload.收據資料 = {
          收據抬頭: document.getElementById('receiptName').value.trim(),
          Email: document.getElementById('receiptEmail').value.trim(),
          聯絡電話: document.getElementById('receiptPhone').value.trim(),
          統一編號: document.getElementById('receiptTaxId').value.trim(),
          地址: document.getElementById('receiptAddress').value.trim(),
          備註: '',
          立即寄送: document.getElementById('sendReceiptNow').checked
        };
      }
      try {
        const result = await gasPost(payload);
        if (!result.success) throw new Error(result.message);
        showSuccess('交易新增成功' + (payload.開立收據 ? '（含收據）':''));
        hideTransactionForm();
        loadTransactionList();
        loadDashboard();
      } catch(e2){
        showError('新增失敗：' + e2.message);
      } finally {
        btn.disabled=false; btn.innerHTML=old;
      }
    });

    async function loadTransactionList() {
      const tbody = document.getElementById('transactionList');
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-secondary">載入中...</td></tr>`;
      try {
        const result = await gasGet({ action:'getTransactionList' });
        if (!result.success) throw new Error(result.message);
        const data = result.data;
        if (!data.length) {
          tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">暫無資料</td></tr>`;
          return;
        }
        tbody.innerHTML = data.slice(0,50).map(t=>{
          const amountClass = t.類型==='收入' ? 'text-success':'text-danger';
          const sign = t.類型==='收入' ? '+' : '-';
          return `<tr>
            <td>${formatDate(t.日期)}</td>
            <td><span class="badge ${t.類型==='收入'?'bg-success':'bg-danger'}">${t.類型}</span></td>
            <td>${escapeHtml(t.類別||'')}</td>
            <td class="${amountClass}">${sign}$${Number(t.金額||0).toLocaleString()}</td>
            <td>${escapeHtml(t.對象||'-')}</td>
            <td>${
              t.收據編號
                ? `<span class="badge bg-info">${t.收據編號}</span>`
                : (t.類型==='收入'
                      ? `<button class="btn btn-outline-success btn-sm" onclick="createReceiptForTransaction('${t.編號}')"><i class="bi bi-plus-circle"></i></button>`
                      : '-')
            }</td>
            <td>
              <button class="btn btn-outline-danger btn-sm" onclick="deleteTransaction('${t.編號}')"><i class="bi bi-trash"></i></button>
            </td>
          </tr>`;
        }).join('');
      } catch(e){
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">載入失敗：${e.message}</td></tr>`;
      }
    }

    async function deleteTransaction(transactionId) {
      if (!confirm('確定刪除？此操作無法復原')) return;
      try {
        const result = await gasPost({ action:'deleteTransaction', transactionId, deleterId:userId });
        if (!result.success) throw new Error(result.message);
        showSuccess('已刪除');
        loadTransactionList();
        loadDashboard();
      } catch(e){ showError('刪除失敗：'+e.message); }
    }

    async function createReceiptForTransaction(txId) {
      const title = prompt('請輸入收據抬頭：');
      if (!title) return;
      const email = prompt('如需寄送請輸入 Email（可空白）：') || '';
      const sendNow = email ? confirm('立即寄送？') : false;
      try {
        const result = await gasPost({
          action: 'createReceiptForTransaction',
          transactionId: txId,
          收據抬頭: title.trim(),
          Email: email.trim(),
          立即寄送: sendNow,
          userId
        });
        if (!result.success) throw new Error(result.message);
        showSuccess('收據已開立' + (sendNow ? '並寄送':''));
        loadTransactionList();
        loadReceiptList();
      } catch(e){
        showError('補開失敗：'+e.message);
      }
    }

    /**********************************************************
     * 手動開立收據
     **********************************************************/
    function showManualReceiptForm(){
      document.getElementById('manualReceiptForm').style.display='block';
      document.getElementById('manualReceiptDate').value = new Date().toISOString().split('T')[0];
    }
    function hideManualReceiptForm(){
      document.getElementById('manualReceiptForm').style.display='none';
      document.getElementById('newManualReceiptForm').reset();
    }
    document.getElementById('newManualReceiptForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      const old=btn.innerHTML; btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>處理中...';
      const payload = {
        action:'createManualReceipt',
        收據日期: document.getElementById('manualReceiptDate').value,
        金額: parseInt(document.getElementById('manualReceiptAmount').value),
        收據抬頭: document.getElementById('manualReceiptName').value.trim(),
        收入類別: document.getElementById('manualReceiptCategory').value,
        Email: document.getElementById('manualReceiptEmail').value.trim(),
        聯絡電話: document.getElementById('manualReceiptPhone').value.trim(),
        統一編號: document.getElementById('manualReceiptTaxId').value.trim(),
        付款方式: document.getElementById('manualReceiptPaymentMethod').value.trim(),
        地址: document.getElementById('manualReceiptAddress').value.trim(),
        備註: document.getElementById('manualReceiptNote').value.trim(),
        立即寄送: document.getElementById('sendManualReceiptNow').checked,
        開立人: userId
      };
      try {
        const result = await gasPost(payload);
        if (!result.success) throw new Error(result.message);
        showSuccess('收據已開立' + (payload.立即寄送 ? '並寄送':''));
        hideManualReceiptForm();
        loadReceiptList();
        loadTransactionList();
        loadDashboard();
      } catch(e2){
        showError('開立失敗：'+e2.message);
      } finally {
        btn.disabled=false; btn.innerHTML=old;
      }
    });

    async function loadReceiptList() {
      const list = document.getElementById('receiptList');
      list.innerHTML = '<div class="text-center text-muted py-4">載入中...</div>';
      try {
        const result = await gasGet({ action:'getReceiptList' });
        if (!result.success) throw new Error(result.message);
        const data = result.data;
        if (!data.length) {
          list.innerHTML = '<div class="text-center text-muted py-4">暫無收據</div>';
          return;
        }
        list.innerHTML = data.slice(0,50).map(r=>{
          return `<div class="receipt-card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0">收據編號：${r.收據編號}</h6>
                <small class="text-light">${formatDate(r.收據日期)}</small>
              </div>
              <div>
                <span class="receipt-status ${receiptStatusClass(r.狀態)}">${r.狀態}</span>
                <span class="badge bg-light text-dark ms-2">$${Number(r.金額||0).toLocaleString()}</span>
              </div>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-8">
                  <p class="mb-1"><strong>抬頭：</strong>${escapeHtml(r.收據抬頭||'')}</p>
                  <p class="mb-1"><strong>類別：</strong>${escapeHtml(r.收入類別||'')}</p>
                  ${r.統一編號? `<p class="mb-1"><strong>統一編號：</strong>${escapeHtml(r.統一編號)}</p>`:''}
                  ${r.Email? `<p class="mb-1"><strong>Email：</strong>${escapeHtml(r.Email)}</p>`:''}
                  ${r.備註? `<p class="mb-1"><strong>備註：</strong>${escapeHtml(r.備註)}</p>`:''}
                  <p class="mb-0 text-muted small">開立時間：${formatDateTime(r.開立時間)}</p>
                </div>
                <div class="col-md-4 d-flex flex-column gap-2">
                  ${r.PDF連結? `<button class="btn btn-primary btn-sm" onclick="window.open('${r.PDF連結}','_blank')"><i class="bi bi-file-pdf me-1"></i>下載PDF</button>`:''}
                  ${(r.Email && r.狀態!=='已寄送')
                      ? `<button class="btn btn-success btn-sm" onclick="sendReceipt('${r.收據ID}')"><i class="bi bi-envelope me-1"></i>寄送</button>`
                      : ''}
                  <button class="btn btn-info btn-sm" onclick="regenerateReceiptPDF('${r.收據ID}')"><i class="bi bi-arrow-clockwise me-1"></i>重新產生</button>
                </div>
              </div>
            </div>
          </div>`;
        }).join('');
      } catch(e){
        list.innerHTML = '<div class="text-center text-danger py-4">載入失敗：'+e.message+'</div>';
      }
    }

    async function sendReceipt(receiptId){
      try {
        const result = await gasPost({ action:'sendReceipt', receiptId });
        if (!result.success) throw new Error(result.message);
        showSuccess('收據已寄送');
        loadReceiptList();
      } catch(e){ showError('寄送失敗：'+e.message); }
    }
    async function regenerateReceiptPDF(receiptId){
      try {
        const result = await gasPost({ action:'regenerateReceiptPDF', receiptId });
        if (!result.success) throw new Error(result.message);
        showSuccess('PDF 已重新產生');
        loadReceiptList();
      } catch(e){ showError('重新產生失敗：'+e.message); }
    }
    function receiptStatusClass(status) {
      switch (status) {
        case '已開立': return 'bg-success text-white';
        case '已寄送': return 'bg-primary text-white';
        case '錯誤': return 'bg-danger text-white';
        default: return 'bg-secondary text-white';
      }
    }

    /**********************************************************
     * 會員管理
     **********************************************************/
    async function loadMemberList(){
      const tbody = document.getElementById('memberList');
      tbody.innerHTML='<tr><td colspan="6" class="text-center text-muted">載入中...</td></tr>';
      try {
        const result = await gasGet({ action:'getMemberList' });
        if (!result.success) throw new Error(result.message);
        const data=result.data;
        if (!data.length){
          tbody.innerHTML='<tr><td colspan="6" class="text-center text-muted">尚無會員</td></tr>';
          return;
        }
        tbody.innerHTML=data.map(m=>{
          return `<tr>
            <td>${escapeHtml(m.真實姓名||m.LINE名稱||'-')}</td>
            <td>${escapeHtml(m.電話||'-')}</td>
            <td><span class="badge ${m.是否會員?'bg-success':'bg-secondary'}">${m.是否會員?'正式會員':'一般'}</span></td>
            <td>${formatDate(m.加入日期)}</td>
            <td>${m.最後捐款日期? formatDate(m.最後捐款日期): '-'}</td>
            <td>
              <button class="btn btn-outline-primary btn-sm" onclick="viewMemberDetail('${m.用戶ID}')"><i class="bi bi-eye"></i></button>
            </td>
          </tr>`;
        }).join('');
      } catch(e){
        tbody.innerHTML='<tr><td colspan="6" class="text-center text-danger">載入失敗：'+e.message+'</td></tr>';
      }
    }

    async function viewMemberDetail(memberId){
      try {
        const result = await gasGet({ action:'getMemberDetail', memberId });
        if (!result.success) throw new Error(result.message);
        const m = result.data;
        const donations = (m.捐款記錄||[]).slice(0,5).map(d=>`
          <tr>
            <td>${formatDate(d.日期)}</td>
            <td class="text-success">$${Number(d.金額||0).toLocaleString()}</td>
            <td>${escapeHtml(d.類別||'')}</td>
            <td>${escapeHtml(d.收據編號||'-')}</td>
          </tr>`).join('') || `<tr><td colspan="4" class="text-center text-muted">無</td></tr>`;
        const acts = (m.活動參與||[]).slice(0,5).map(a=>`
          <tr>
            <td>${escapeHtml(a.活動名稱||'')}</td>
            <td>${formatDate(a.活動日期)}</td>
            <td><span class="badge ${a.參與狀態==='已參加'?'bg-success':'bg-warning'}">${escapeHtml(a.參與狀態||'-')}</span></td>
          </tr>`).join('') || `<tr><td colspan="3" class="text-center text-muted">無</td></tr>`;

        const modalHtml = `
          <div class="modal fade" id="memberDetailModal" tabindex="-1">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">會員詳情 - ${escapeHtml(m.真實姓名||m.LINE名稱||'')}</h5>
                  <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="col-md-6">
                      <h6>基本資料</h6><hr class="mt-1">
                      <p><strong>姓名：</strong>${escapeHtml(m.真實姓名||'-')}</p>
                      <p><strong>LINE 名稱：</strong>${escapeHtml(m.LINE名稱||'-')}</p>
                      <p><strong>電話：</strong>${escapeHtml(m.電話||'-')}</p>
                      <p><strong>Email：</strong>${escapeHtml(m.Email||'-')}</p>
                      <p><strong>會員狀態：</strong><span class="badge ${m.是否會員?'bg-success':'bg-secondary'}">${m.是否會員?'正式會員':'一般'}</span></p>
                      <p><strong>加入日期：</strong>${formatDate(m.加入日期)}</p>
                      <p><strong>地址：</strong>${escapeHtml(m.地址||'-')}</p>
                      <p><strong>生日：</strong>${m.生日? formatDate(m.生日): '-'}</p>
                    </div>
                    <div class="col-md-6">
                      <h6>捐款統計</h6><hr class="mt-1">
                      <p><strong>總額：</strong>$${Number(m.總捐款金額||0).toLocaleString()}</p>
                      <p><strong>次數：</strong>${m.捐款次數||0}</p>
                      <p><strong>最後捐款：</strong>${m.最後捐款日期? formatDate(m.最後捐款日期): '-'}</p>
                      <p><strong>平均：</strong>$${(m.捐款次數>0)? Math.round((m.總捐款金額||0)/m.捐款次數).toLocaleString():0}</p>
                    </div>
                  </div>
                  <hr>
                  <h6>最近捐款</h6>
                  <div class="table-responsive mb-3">
                    <table class="table table-sm">
                      <thead><tr><th>日期</th><th>金額</th><th>類別</th><th>收據</th></tr></thead>
                      <tbody>${donations}</tbody>
                    </table>
                  </div>
                  <h6>活動參與</h6>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead><tr><th>活動名稱</th><th>日期</th><th>狀態</th></tr></thead>
                      <tbody>${acts}</tbody>
                    </table>
                  </div>
                </div>
                <div class="modal-footer">
                  ${m.是否會員
                      ? `<button class="btn btn-warning" onclick="updateMemberStatus('${m.用戶ID}', false)">取消會員資格</button>`
                      : `<button class="btn btn-success" onclick="updateMemberStatus('${m.用戶ID}', true)">升級為會員</button>`
                    }
                  <button class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
              </div>
            </div>
          </div>`;
        const container = document.getElementById('dynamicModalContainer');
        container.innerHTML = modalHtml;
        const modal = new bootstrap.Modal('#memberDetailModal');
        modal.show();
      } catch(e){
        showError('載入會員詳情失敗：'+ e.message);
      }
    }

    async function updateMemberStatus(memberId,isMember){
      if (!confirm('確定要' + (isMember?'升級為會員':'取消會員資格') + '？')) return;
      try {
        const result = await gasPost({ action:'updateMemberStatus', memberId, isMember, updaterId:userId });
        if (!result.success) throw new Error(result.message);
        showSuccess('已更新');
        loadMemberList();
        loadDashboard();
        const modalEl = document.getElementById('memberDetailModal');
        if (modalEl) bootstrap.Modal.getInstance(modalEl).hide();
      } catch(e){
        showError('更新失敗：'+e.message);
      }
    }

    function exportMembers(){ exportData('會員資料'); }

    /**********************************************************
     * 活動管理
     **********************************************************/
    function showActivityForm(){
      document.getElementById('activityForm').style.display='block';
      document.getElementById('activityDate').value = new Date().toISOString().split('T')[0];
    }
    function hideActivityForm(){
      document.getElementById('activityForm').style.display='none';
      document.getElementById('newActivityForm').reset();
    }
    document.getElementById('newActivityForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const btn=e.target.querySelector('button[type="submit"]');
      const old=btn.innerHTML; btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>建立中...';
      const payload={
        action:'addActivity',
        活動名稱: document.getElementById('activityName').value.trim(),
        活動類型: document.getElementById('activityType').value,
        活動日期: document.getElementById('activityDate').value,
        活動時間: document.getElementById('activityTime').value,
        活動地點: document.getElementById('activityLocation').value.trim(),
        人數上限: parseInt(document.getElementById('activityMaxPeople').value)||50,
        活動描述: document.getElementById('activityDescription').value.trim(),
        建立者: userId
      };
      try {
        const result = await gasPost(payload);
        if (!result.success) throw new Error(result.message);
        showSuccess('活動已建立');
        hideActivityForm();
        loadActivityList();
        loadDashboard();
      } catch(e2){
        showError('建立失敗：'+e2.message);
      } finally {
        btn.disabled=false; btn.innerHTML=old;
      }
    });

    async function loadActivityList(){
      const list = document.getElementById('activityList');
      list.innerHTML='<div class="col-12 text-center text-muted py-4">載入中...</div>';
      try {
        const result = await gasGet({ action:'getActivityList' });
        if (!result.success) throw new Error(result.message);
        const data=result.data;
        if (!data.length){
          list.innerHTML='<div class="col-12 text-center text-muted py-4">尚無活動</div>';
          return;
        }
        list.innerHTML=data.map(a=>{
          const ratio = a.人數上限? Math.min(100, (Number(a.報名人數||0)/a.人數上限)*100):0;
          return `<div class="col-md-6 col-lg-4">
            <div class="card h-100">
              <div class="card-header bg-primary text-white py-2">
                <h6 class="mb-0">${escapeHtml(a.活動名稱||'')}</h6>
                <small>${escapeHtml(a.活動類型||'')}</small>
              </div>
              <div class="card-body">
                <p class="text-truncate-3" style="min-height:48px;">${escapeHtml(a.活動描述||'無描述')}</p>
                <p class="mb-1"><i class="bi bi-calendar me-1"></i>${formatDate(a.活動日期)} ${a.活動時間||''}</p>
                ${a.活動地點? `<p class="mb-1"><i class="bi bi-geo-alt me-1"></i>${escapeHtml(a.活動地點)}</p>`:''}
                <p class="mb-1"><i class="bi bi-people me-1"></i>報名：${a.報名人數||0}/${a.人數上限}</p>
                <div class="progress" style="height:5px;"><div class="progress-bar" style="width:${ratio}%"></div></div>
              </div>
              <div class="card-footer d-flex justify-content-between align-items-center">
                <span class="badge ${activityStatusBadge(a.活動狀態)}">${escapeHtml(a.活動狀態||'')}</span>
                <div>
                  <button class="btn btn-outline-primary btn-sm" onclick="viewActivityDetail('${a.活動ID}')"><i class="bi bi-eye"></i></button>
                  <button class="btn btn-outline-success btn-sm" onclick="exportActivityMembers('${a.活動ID}')"><i class="bi bi-download"></i></button>
                </div>
              </div>
            </div>
          </div>`;
        }).join('');
      } catch(e){
        list.innerHTML='<div class="col-12 text-center text-danger py-4">載入失敗：'+e.message+'</div>';
      }
    }
    function activityStatusBadge(status){
      switch(status){
        case '報名中': return 'bg-success';
        case '進行中': return 'bg-primary';
        case '已結束': return 'bg-secondary';
        case '已取消': return 'bg-danger';
        default: return 'bg-info';
      }
    }
    function viewActivityDetail(id){
      alert('活動詳情功能可再擴充（ID: '+id+'）');
    }
    async function exportActivityMembers(activityId){
      try {
        const result = await gasGet({ action:'exportActivityMembers', activityId });
        if (!result.success) throw new Error(result.message);
        downloadCsv(result.data, '活動報名名單_' + new Date().toISOString().split('T')[0] + '.csv');
        showSuccess('名單已匯出');
      } catch(e){
        showError('匯出失敗：'+e.message);
      }
    }

    /**********************************************************
     * 提案審查
     **********************************************************/
    function showProposalForm(){
      document.getElementById('proposalForm').style.display='block';
      const nextWeek = new Date(Date.now()+7*86400000);
      document.getElementById('proposalDeadline').value = nextWeek.toISOString().split('T')[0];
    }
    function hideProposalForm(){
      document.getElementById('proposalForm').style.display='none';
      document.getElementById('newProposalForm').reset();
    }
    document.getElementById('newProposalForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const btn=e.target.querySelector('button[type="submit"]');
      const old=btn.innerHTML; btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>提交中...';
      const payload={
        action:'addProposal',
        提案標題: document.getElementById('proposalTitle').value.trim(),
        提案類型: document.getElementById('proposalType').value,
        提案內容: document.getElementById('proposalContent').value.trim(),
        預算金額: parseInt(document.getElementById('proposalBudget').value)||0,
        執行期限: document.getElementById('proposalDeadline').value,
        提案人: userId
      };
      try {
        const result=await gasPost(payload);
        if (!result.success) throw new Error(result.message);
        showSuccess('提案已提交');
        hideProposalForm();
        loadProposalList();
        loadDashboard();
      } catch(e2){
        showError('提交失敗：'+e2.message);
      } finally {
        btn.disabled=false; btn.innerHTML=old;
      }
    });

    async function loadProposalList(){
      const list=document.getElementById('proposalList');
      list.innerHTML='<div class="text-center text-muted py-4">載入中...</div>';
      try{
        const result=await gasGet({ action:'getProposalList' });
        if (!result.success) throw new Error(result.message);
        const data=result.data;
        if (!data.length){
          list.innerHTML='<div class="text-center text-muted py-4">尚無提案</div>';
          return;
        }
        list.innerHTML=data.map(p=>{
          return `<div class="proposal-card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0">${escapeHtml(p.提案標題||'')}</h6>
                <small class="text-light">${escapeHtml(p.提案類型||'')} | 提案人：${escapeHtml(p.提案人姓名||'')}</small>
              </div>
              <span class="badge ${proposalStatusBadge(p.審查狀態)}">${escapeHtml(p.審查狀態||'')}</span>
            </div>
            <div class="card-body">
              <p class="mb-2">${escapeHtml(p.提案內容||'')}</p>
              ${p.預算金額>0? `<p class="mb-1"><strong>預算：</strong>$${Number(p.預算金額).toLocaleString()}</p>`:''}
              ${p.執行期限? `<p class="mb-1"><strong>期限：</strong>${formatDate(p.執行期限)}</p>`:''}
              <p class="mb-0 text-muted small">提案時間：${formatDateTime(p.提案時間)}</p>
              ${ (p.審查狀態==='待審查' && ['admin','chairman','director'].includes(userRole))
                  ? `<div class="vote-buttons">
                      <button class="btn btn-success btn-sm" onclick="voteProposal('${p.提案ID}','通過')"><i class="bi bi-check-circle me-1"></i>通過</button>
                      <button class="btn btn-danger btn-sm" onclick="voteProposal('${p.提案ID}','否決')"><i class="bi bi-x-circle me-1"></i>否決</button>
                      <button class="btn btn-warning btn-sm" onclick="voteProposal('${p.提案ID}','修正')"><i class="bi bi-pencil me-1"></i>需修正</button>
                     </div>`:''
              }
              ${p.投票結果? `
                <div class="mt-2 p-2 bg-light rounded small d-flex flex-wrap justify-content-between">
                  <div>
                    <span class="text-success me-2">贊成：${p.投票結果.贊成||0}</span>
                    <span class="text-danger me-2">反對：${p.投票結果.反對||0}</span>
                    <span class="text-warning">修正：${p.投票結果.修正||0}</span>
                  </div>
                  <div class="text-muted">投票：${p.投票結果.總投票數}/${p.投票結果.應投票數}</div>
                </div>`:''
              }
            </div>
          </div>`;
        }).join('');
      }catch(e){
        list.innerHTML='<div class="text-center text-danger py-4">載入失敗：'+e.message+'</div>';
      }
    }

    function proposalStatusBadge(status){
      switch(status){
        case '待審查': return 'bg-warning text-dark';
        case '審查中': return 'bg-info';
        case '已通過': return 'bg-success';
        case '已否決': return 'bg-danger';
        case '需修正': return 'bg-secondary';
        default: return 'bg-light text-dark';
      }
    }

    async function voteProposal(proposalId, vote){
      let comment = '';
      if (vote==='修正') {
        comment = prompt('請輸入修正建議：');
        if (!comment) { showError('需提供修正建議'); return; }
      } else {
        comment = prompt('投票理由（可留空）：') || '';
      }
      try {
        const result = await gasPost({ action:'voteProposal', proposalId, vote, comment, voterId:userId });
        if (!result.success) throw new Error(result.message);
        showSuccess('投票完成');
        loadProposalList();
        loadDashboard();
      } catch(e){
        showError('投票失敗：'+e.message);
      }
    }

    /**********************************************************
     * 支出審核
     **********************************************************/
    function showExpenseForm(){
      document.getElementById('expenseForm').style.display='block';
      document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    }
    function hideExpenseForm(){
      document.getElementById('expenseForm').style.display='none';
      document.getElementById('newExpenseForm').reset();
    }

    document.getElementById('newExpenseForm').addEventListener('submit', e=>{
      e.preventDefault();
      const file = document.getElementById('expenseReceipt').files[0];
      if (!file) { showError('請選擇圖片'); return; }
      const btn=e.target.querySelector('button[type="submit"]');
      const old=btn.innerHTML; btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>上傳中...';
      const reader = new FileReader();
      reader.onload = async evt=>{
        const payload = {
          action:'addExpense',
          支出日期: document.getElementById('expenseDate').value,
          支出金額: parseInt(document.getElementById('expenseAmount').value),
          支出類別: document.getElementById('expenseCategory').value,
          廠商店家: document.getElementById('expenseVendor').value.trim(),
          支出說明: document.getElementById('expenseDescription').value.trim(),
          憑證圖片: evt.target.result,
          檔案名稱: file.name,
          提交人: userId
        };
        try {
          const result = await gasPost(payload);
          if (!result.success) throw new Error(result.message);
          showSuccess('憑證已提交等待審核');
          hideExpenseForm();
          loadExpenseList();
          loadDashboard();
        } catch(e2){
          showError('提交失敗：'+e2.message);
        } finally {
          btn.disabled=false; btn.innerHTML=old;
        }
      };
      reader.readAsDataURL(file);
    });

    async function loadExpenseList(){
      const container=document.getElementById('expenseList');
      container.innerHTML='<div class="text-center text-muted py-4">載入中...</div>';
      try{
        const result=await gasGet({ action:'getExpenseList' });
        if (!result.success) throw new Error(result.message);
        const data=result.data;
        if (!data.length){
          container.innerHTML='<div class="text-center text-muted py-4">尚無憑證</div>';
          return;
        }
        container.innerHTML=data.slice(0,50).map(e=>{
          return `<div class="expense-receipt">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <h6 class="mb-1">${escapeHtml(e.廠商店家||'')} - $${Number(e.支出金額||0).toLocaleString()}</h6>
                <small class="text-muted">${formatDate(e.支出日期)} | ${escapeHtml(e.支出類別||'')}</small>
              </div>
              <span class="badge ${expenseStatusBadge(e.審核狀態)}">${escapeHtml(e.審核狀態||'')}</span>
            </div>
            <p class="mb-2">${escapeHtml(e.支出說明||'')}</p>
            ${e.憑證圖片連結? `<img src="${e.憑證圖片連結}" class="receipt-image" onclick="window.open('${e.憑證圖片連結}','_blank')">`:''}
            <div class="d-flex justify-content-between align-items-center mt-2">
              <small class="text-muted">提交：${escapeHtml(e.提交人姓名||'')} | ${formatDateTime(e.提交時間)}</small>
              ${(e.審核狀態==='待審核' && ['admin','chairman','supervisor'].includes(userRole))
                  ? `<div>
                      <button class="btn btn-success btn-sm me-1" onclick="approveExpense('${e.憑證ID}','通過')"><i class="bi bi-check-circle"></i></button>
                      <button class="btn btn-danger btn-sm" onclick="approveExpense('${e.憑證ID}','駁回')"><i class="bi bi-x-circle"></i></button>
                    </div>`:''
              }
            </div>
            ${e.審核意見? `<div class="approval-section mt-2">
              <strong>審核意見：</strong>${escapeHtml(e.審核意見||'')}
              <div class="text-muted mt-1 small">審核人：${escapeHtml(e.審核人姓名||'')} | ${formatDateTime(e.審核時間)}</div>
            </div>`:''}
          </div>`;
        }).join('');
      }catch(e){
        container.innerHTML='<div class="text-center text-danger py-4">載入失敗：'+e.message+'</div>';
      }
    }
    function expenseStatusBadge(status){
      switch(status){
        case '待審核': return 'bg-warning text-dark';
        case '已通過': return 'bg-success';
        case '已駁回': return 'bg-danger';
        default: return 'bg-secondary';
      }
    }
    async function approveExpense(expenseId, decision){
      let comment='';
      if (decision==='駁回'){
        comment=prompt('請輸入駁回理由：');
        if (!comment) { showError('駁回理由不可空白'); return; }
      } else {
        comment=prompt('審核意見（可空白）：') || '';
      }
      try {
        const result=await gasPost({ action:'approveExpense', expenseId, decision, comment, reviewerId:userId });
        if (!result.success) throw new Error(result.message);
        showSuccess('已'+decision);
        loadExpenseList();
        loadDashboard();
      } catch(e){
        showError('審核失敗：'+e.message);
      }
    }

    /**********************************************************
     * 臨時動議
     **********************************************************/
    function showMotionForm(){
      document.getElementById('motionForm').style.display='block';
      const tomorrow=new Date(Date.now()+86400000);
      document.getElementById('motionDeadline').value = tomorrow.toISOString().split('T')[0];
    }
    function hideMotionForm(){
      document.getElementById('motionForm').style.display='none';
      document.getElementById('newMotionForm').reset();
    }
    document.getElementById('newMotionForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const btn=e.target.querySelector('button[type="submit"]');
      const old=btn.innerHTML; btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>送出中...';
      const payload={
        action:'addMotion',
        動議標題: document.getElementById('motionTitle').value.trim(),
        緊急程度: document.getElementById('motionUrgency').value,
        希望決議期限: document.getElementById('motionDeadline').value,
        動議內容: document.getElementById('motionContent').value.trim(),
        提出理由: document.getElementById('motionReason').value.trim(),
        提出人: userId
      };
      try{
        const result=await gasPost(payload);
        if (!result.success) throw new Error(result.message);
        showSuccess('動議已提出');
        hideMotionForm();
        loadMotionList();
        loadDashboard();
      }catch(e2){
        showError('提出失敗：'+e2.message);
      }finally{
        btn.disabled=false; btn.innerHTML=old;
      }
    });

    async function loadMotionList(){
      const list=document.getElementById('motionList');
      list.innerHTML='<div class="text-center text-muted py-4">載入中...</div>';
      try{
        const result=await gasGet({ action:'getMotionList' });
        if (!result.success) throw new Error(result.message);
        const data=result.data;
        if (!data.length){
          list.innerHTML='<div class="text-center text-muted py-4">尚無臨時動議</div>';
          return;
        }
        list.innerHTML=data.map(m=>{
          return `<div class="card mb-3 border-${motionUrgencyColor(m.緊急程度)}">
            <div class="card-header bg-${motionUrgencyColor(m.緊急程度)} text-white py-2 d-flex justify-content-between">
              <div>
                <h6 class="mb-0">${escapeHtml(m.動議標題||'')}</h6>
                <small>${escapeHtml(m.提出人姓名||'')} | ${escapeHtml(m.緊急程度||'')}</small>
              </div>
              <span class="badge ${motionStatusBadge(m.處理狀態)}">${escapeHtml(m.處理狀態||'')}</span>
            </div>
            <div class="card-body">
              <h6 class="text-muted small mb-1">動議內容</h6>
              <p>${escapeHtml(m.動議內容||'')}</p>
              <h6 class="text-muted small mb-1">提出理由</h6>
              <p>${escapeHtml(m.提出理由||'')}</p>
              ${m.希望決議期限? `<p><strong>決議期限：</strong>${formatDate(m.希望決議期限)}</p>`:''}
              <p class="text-muted small mb-2">提出時間：${formatDateTime(m.提出時間)}</p>
              ${ (m.處理狀態==='待處理' && ['admin','chairman'].includes(userRole))
                  ? `<div class="d-flex flex-wrap gap-2">
                      <button class="btn btn-success btn-sm" onclick="processMotion('${m.動議ID}','接受')"><i class="bi bi-check-circle me-1"></i>接受</button>
                      <button class="btn btn-warning btn-sm" onclick="processMotion('${m.動議ID}','延後')"><i class="bi bi-clock me-1"></i>延後</button>
                      <button class="btn btn-danger btn-sm" onclick="processMotion('${m.動議ID}','拒絕')"><i class="bi bi-x-circle me-1"></i>拒絕</button>
                    </div>`:''
              }
              ${m.處理意見? `<div class="mt-3 p-2 bg-light rounded small">
                <strong>處理意見：</strong>${escapeHtml(m.處理意見||'')}<br>
                <span class="text-muted">處理人：${escapeHtml(m.處理人姓名||'')} | ${formatDateTime(m.處理時間)}</span>
              </div>`:''}
            </div>
          </div>`;
        }).join('');
      }catch(e){
        list.innerHTML='<div class="text-center text-danger py-4">載入失敗：'+e.message+'</div>';
      }
    }

    function motionUrgencyColor(u){
      switch(u){
        case '緊急': return 'danger';
        case '重要': return 'warning';
        case '一般': return 'info';
        default: return 'secondary';
      }
    }
    function motionStatusBadge(s){
      switch(s){
        case '待處理': return 'bg-warning text-dark';
        case '已接受': return 'bg-success';
        case '已延後': return 'bg-secondary';
        case '已拒絕': return 'bg-danger';
        case '處理中': return 'bg-info';
        default: return 'bg-light text-dark';
      }
    }
    async function processMotion(motionId, decision){
      const reason = prompt('請輸入' + decision + '理由：');
      if (!reason) { showError('理由不可空白'); return; }
      try {
        const result = await gasPost({ action:'processMotion', motionId, decision, comment:reason, processerId:userId });
        if (!result.success) throw new Error(result.message);
        showSuccess('已' + decision);
        loadMotionList();
        loadDashboard();
      } catch(e){
        showError('處理失敗：'+e.message);
      }
    }

    /**********************************************************
     * 系統功能：匯出 / 備份 / 通知
     **********************************************************/
    function exportDataPrompt(){
      const type = prompt('請輸入要匯出的類型：會員資料 / 交易記錄 / 收據記錄 / 活動資料');
      if (!type) return;
      exportData(type.trim());
    }
    async function exportData(dataType){
      try {
        const result=await gasGet({ action:'exportData', dataType });
        if (!result.success) throw new Error(result.message);
        downloadCsv(result.data, dataType + '_' + new Date().toISOString().split('T')[0] + '.csv');
        showSuccess('已匯出：' + dataType);
      } catch(e){
        showError('匯出失敗：'+e.message);
      }
    }
    async function backupSystem(){
      if (!confirm('確定進行系統備份？')) return;
      try {
        const result=await gasPost({ action:'backupSystem', backuperId: userId });
        if (!result.success) throw new Error(result.message);
        showSuccess('備份完成');
      } catch(e){
        showError('備份失敗：'+e.message);
      }
    }
    async function sendSystemNotification(){
      const message = prompt('請輸入通知內容：');
      if (!message) return;
      const toAll = confirm('確定發送給「所有用戶」嗎？\n取消則僅發送給會員');
      try {
        const result=await gasPost({ action:'sendSystemNotification', message:message.trim(), sendToAll:toAll, senderId:userId });
        if (!result.success) throw new Error(result.message);
        showSuccess('通知已發送，數量：' + (result.data?.sentCount||0));
      } catch(e){
        showError('發送失敗：'+e.message);
      }
    }

    /**********************************************************
     * 工具 / 格式化
     **********************************************************/
    function formatDate(d){
      if (!d) return '';
      const dt=new Date(d);
      if (isNaN(dt.getTime())) return '';
      return dt.toLocaleDateString('zh-TW');
    }
    function formatDateTime(d){
      if (!d) return '';
      const dt=new Date(d);
      if (isNaN(dt.getTime())) return '';
      return dt.toLocaleString('zh-TW');
    }
    function escapeHtml(str=''){
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
    function downloadCsv(content, filename){
      const blob = new Blob([content], { type:'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.href=url; link.download=filename;
      link.style.display='none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    /**********************************************************
     * 收據快速方法 (list reload)
     **********************************************************/
    function receiptStatusReload(){ loadReceiptList(); }

    /**********************************************************
     * UI 訊息
     **********************************************************/
    function showError(msg){
      const eA=document.getElementById('errorAlert');
      document.getElementById('errorMessage').textContent=msg;
      eA.classList.remove('d-none');
      setTimeout(()=> eA.classList.add('d-none'), 6000);
    }
    function showSuccess(msg){
      const sA=document.getElementById('successAlert');
      document.getElementById('successMessage').textContent=msg;
      sA.classList.remove('d-none');
      setTimeout(()=> sA.classList.add('d-none'), 4000);
    }

    /**********************************************************
     * 分頁切換事件
     **********************************************************/
    document.querySelectorAll('#adminTabs a[data-bs-toggle="pill"]').forEach(tab=>{
      tab.addEventListener('shown.bs.tab', e=>{
        const target = e.target.getAttribute('href');
        switch(target){
          case '#dashboard': loadDashboard(); break;
          case '#finance': loadTransactionList(); break;
          case '#receipts': loadReceiptList(); break;
          case '#members': loadMemberList(); break;
          case '#activities': loadActivityList(); break;
          case '#proposals': loadProposalList(); break;
          case '#expenses': loadExpenseList(); break;
          case '#motions': loadMotionList(); break;
        }
      });
    });

    /**********************************************************
     * 快捷鍵 (可選)
     **********************************************************/
    document.addEventListener('keydown', e=>{
      if (e.ctrlKey && e.key==='s'){
        e.preventDefault();
        const form = document.querySelector('form:visible') || document.querySelector('form');
      }
    });

    /**********************************************************
     * 初始化自動刷新 (儀表板每5分鐘)
     **********************************************************/
    setInterval(()=>{
      const active = document.querySelector('#adminTabs a.nav-link.active');
      if (active && active.getAttribute('href')==='#dashboard') loadDashboard();
    }, 5*60*1000);

  </script>
</body>
</html>

