<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友會管理系統 - 完整版</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #28a745, #20c997);
      --danger-gradient: linear-gradient(135deg, #dc3545, #c82333);
      --warning-gradient: linear-gradient(135deg, #ffc107, #e0a800);
      --info-gradient: linear-gradient(135deg, #17a2b8, #138496);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', sans-serif;
      background: var(--primary-gradient);
      min-height: 100vh;
      color: #333;
    }

    /* Header & Navigation */
    .main-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      margin: 20px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 20px;
      z-index: 1000;
    }

    .main-header h1 {
      color: #4a5568;
      font-size: 28px;
      margin-bottom: 10px;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .user-info-bar {
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 20px;
      border-radius: 25px;
      display: inline-flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      margin-top: 10px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    /* Navigation Tabs */
    .nav-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 15px;
      margin: 0 20px 20px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .nav-pills {
      --bs-nav-pills-border-radius: 12px;
      --bs-nav-pills-link-active-bg: transparent;
      gap: 5px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .nav-pills .nav-link {
      background: transparent;
      border: 2px solid transparent;
      color: #6c757d;
      font-weight: 600;
      padding: 12px 20px;
      transition: all 0.3s ease;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-pills .nav-link:hover {
      background: rgba(102, 126, 234, 0.1);
      border-color: rgba(102, 126, 234, 0.3);
      color: #667eea;
    }

    .nav-pills .nav-link.active {
      background: var(--primary-gradient);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    /* Content Cards */
    .content-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
    }

    .content-card:hover {
      transform: translateY(-2px);
    }

    /* Statistics Cards */
    .stat-card {
      background: var(--success-gradient);
      color: white;
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3);
      transition: transform 0.2s ease;
      margin-bottom: 20px;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    .stat-card h3 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .stat-card p {
      margin: 0;
      opacity: 0.9;
    }

    /* Form Elements */
    .form-floating {
      margin-bottom: 20px;
    }

    .form-control, .form-select {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
    }

    .form-control:focus, .form-select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
      background: white;
    }

    /* Buttons */
    .btn {
      border-radius: 12px;
      font-weight: 600;
      padding: 12px 24px;
      transition: all 0.3s ease;
      border: none;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: var(--primary-gradient);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-success {
      background: var(--success-gradient);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .btn-danger {
      background: var(--danger-gradient);
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    .btn-warning {
      background: var(--warning-gradient);
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
      color: #212529;
    }

    .btn-info {
      background: var(--info-gradient);
      box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Activity Items */
    .activity-item, .member-item, .transaction-item {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #667eea;
      transition: all 0.2s ease;
    }

    .activity-item:hover, .member-item:hover, .transaction-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-registered { background: #c6f6d5; color: #22543d; }
    .status-pending { background: #feebc8; color: #7b341e; }
    .status-approved { background: #c6f6d5; color: #22543d; }
    .status-rejected { background: #fed7d7; color: #742a2a; }
    .status-active { background: #bee3f8; color: #2a69ac; }

    /* Tables */
    .table-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 15px;
      background: white;
    }

    .table {
      margin-bottom: 0;
    }

    .table th {
      background: #f8f9fa;
      border-bottom: 2px solid #dee2e6;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      max-width: 400px;
      transform: translateX(450px);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: #c6f6d5;
      color: #22543d;
      border-left: 4px solid #48bb78;
    }

    .notification.error {
      background: #fed7d7;
      color: #742a2a;
      border-left: 4px solid #f56565;
    }

    .notification.warning {
      background: #feebc8;
      color: #7b341e;
      border-left: 4px solid #ed8936;
    }

    /* Loading States */
    .loading-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      color: #718096;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 15px;
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .quick-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #e2e8f0;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      color: #4a5568;
    }

    .quick-btn:hover {
      border-color: #667eea;
      background: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      color: #667eea;
      text-decoration: none;
    }

    .quick-btn i {
      font-size: 24px;
      margin-bottom: 10px;
      display: block;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .pagination button:hover {
      background: #f7fafc;
      border-color: #667eea;
    }

    .pagination button.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .main-header, .nav-container, .content-card {
        margin: 10px;
        padding: 15px;
      }

      .main-header h1 {
        font-size: 24px;
      }

      .nav-pills .nav-link {
        padding: 8px 12px;
        font-size: 14px;
      }

      .stat-card h3 {
        font-size: 2rem;
      }

      .quick-actions {
        grid-template-columns: repeat(2, 1fr);
      }

      .table-container {
        max-height: 400px;
      }
    }

    /* Dark Mode Support */
    @media (prefers-color-scheme: dark) {
      .main-header, .nav-container, .content-card {
        background: rgba(45, 55, 72, 0.95);
        color: #e2e8f0;
      }

      .form-control, .form-select {
        background: rgba(74, 85, 104, 0.9);
        border-color: #718096;
        color: #e2e8f0;
      }

      .activity-item, .member-item, .transaction-item {
        background: #2d3748;
        color: #e2e8f0;
      }

      .quick-btn {
        background: rgba(45, 55, 72, 0.9);
        border-color: #718096;
        color: #e2e8f0;
      }
    }

    /* Animation Classes */
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Hide inactive tabs */
    .tab-pane:not(.active) {
      display: none;
    }

    /* Admin specific styles */
    .admin-only {
      display: none;
    }

    .admin-only.show {
      display: block;
    }

    /* Receipt styles */
    .receipt-card {
      border: 1px solid #dee2e6;
      border-radius: 15px;
      margin-bottom: 20px;
      overflow: hidden;
      background: white;
    }

    .receipt-card .card-header {
      background: var(--info-gradient);
      color: white;
      font-weight: 600;
    }

    .receipt-image {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin-top: 8px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <!-- Main Header -->
  <div class="main-header">
    <h1><i class="bi bi-hospital"></i> 帕金森病友會管理系統</h1>
    <p class="text-muted">完整功能整合版</p>
    <div id="userInfoBar" class="user-info-bar" style="display: none;">
      <div class="user-avatar" id="userAvatar">?</div>
      <div>
        <div class="fw-bold" id="userName">載入中...</div>
        <small class="text-muted" id="userRole">會員</small>
      </div>
      <div class="ms-auto">
        <button class="btn btn-sm btn-outline-secondary" onclick="refreshData()">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer"></div>

  <!-- Navigation -->
  <div class="nav-container">
    <ul class="nav nav-pills" id="mainTabs" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#dashboard" role="tab">
          <i class="bi bi-speedometer2"></i> 儀表板
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#profile" role="tab">
          <i class="bi bi-person"></i> 個人資料
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#activities" role="tab">
          <i class="bi bi-calendar-event"></i> 活動管理
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#volunteer" role="tab">
          <i class="bi bi-heart"></i> 志工服務
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#finance" role="tab">
          <i class="bi bi-cash-coin"></i> 財務管理
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#feedback" role="tab">
          <i class="bi bi-chat-dots"></i> 活動回饋
        </button>
      </li>
      <li class="nav-item admin-only">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#admin" role="tab">
          <i class="bi bi-gear"></i> 系統管理
        </button>
      </li>
    </ul>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Dashboard -->
    <div class="tab-pane fade show active" id="dashboard">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3><i class="bi bi-speedometer2 me-2"></i>系統儀表板</h3>
          <button class="btn btn-outline-primary btn-sm" onclick="loadDashboard()">
            <i class="bi bi-arrow-clockwise me-1"></i>刷新
          </button>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <div class="quick-btn" onclick="showTab('profile')">
            <i class="bi bi-person-check"></i>
            <div>更新資料</div>
          </div>
          <div class="quick-btn" onclick="showTab('activities')">
            <i class="bi bi-calendar-plus"></i>
            <div>報名活動</div>
          </div>
          <div class="quick-btn" onclick="showNewDonationModal()">
            <i class="bi bi-heart-fill"></i>
            <div>愛心捐款</div>
          </div>
          <div class="quick-btn" onclick="showTab('volunteer')">
            <i class="bi bi-hand-thumbs-up"></i>
            <div>志工服務</div>
          </div>
        </div>

        <!-- Statistics -->
        <div class="row" id="dashboardStats">
          <div class="col-12">
            <div class="loading-container">
              <div class="loading-spinner"></div>
              <span>載入統計資料中...</span>
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="mt-4">
          <h5><i class="bi bi-clock-history me-2"></i>最近活動</h5>
          <div id="recentActivity">
            <div class="loading-container">
              <div class="loading-spinner"></div>
              <span>載入最近活動...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Management -->
    <div class="tab-pane fade" id="profile">
      <div class="content-card">
        <h3><i class="bi bi-person me-2"></i>個人資料管理</h3>
        
        <!-- Registration Form -->
        <div id="registrationSection">
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            請完成會員註冊以使用完整功能
          </div>
          <form id="registrationForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="realName" required>
                <label for="realName">真實姓名 *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="memberType" required>
                  <option value="">請選擇會員類別</option>
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                  <option value="醫護">醫護人員</option>
                  <option value="支持者">支持者</option>
                </select>
                <label for="memberType">會員類別 *</label>
              </div>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle me-1"></i>完成註冊
              </button>
            </div>
          </form>
        </div>

        <!-- Profile Form -->
        <div id="profileSection" style="display: none;">
          <form id="profileForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="profileRealName" readonly>
                <label for="profileRealName">真實姓名</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="lineName" readonly>
                <label for="lineName">LINE 名稱</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="tel" class="form-control" id="phone">
                <label for="phone">聯絡電話</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="email" class="form-control" id="email">
                <label for="email">電子郵件</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="date" class="form-control" id="birthday">
                <label for="birthday">生日</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="profileMemberType">
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                  <option value="醫護">醫護人員</option>
                  <option value="支持者">支持者</option>
                </select>
                <label for="profileMemberType">會員類別</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" style="height: 100px" id="address"></textarea>
                <label for="address">通訊地址</label>
              </div>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i>更新資料
              </button>
            </div>
          </form>

          <!-- Profile Statistics -->
          <div class="mt-4">
            <h5><i class="bi bi-bar-chart me-2"></i>個人統計</h5>
            <div class="row g-3" id="profileStats">
              <!-- Stats will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Activity Management -->
    <div class="tab-pane fade" id="activities">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3><i class="bi bi-calendar-event me-2"></i>活動管理</h3>
          <div class="admin-only">
            <button class="btn btn-success btn-sm" onclick="showNewActivityModal()">
              <i class="bi bi-plus-circle me-1"></i>新增活動
            </button>
          </div>
        </div>

        <!-- Activity Filters -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="form-floating">
              <select class="form-select" id="activityStatusFilter">
                <option value="">全部狀態</option>
                <option value="開放報名">開放報名</option>
                <option value="報名截止">報名截止</option>
                <option value="進行中">進行中</option>
                <option value="已結束">已結束</option>
              </select>
              <label for="activityStatusFilter">活動狀態</label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-floating">
              <input type="date" class="form-control" id="activityDateFilter">
              <label for="activityDateFilter">活動日期</label>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-floating">
              <input type="text" class="form-control" id="activitySearchFilter" placeholder="搜尋活動...">
              <label for="activitySearchFilter">搜尋活動</label>
            </div>
          </div>
          <div class="col-md-2">
            <button class="btn btn-outline-primary h-100" onclick="filterActivities()">
              <i class="bi bi-search"></i> 搜尋
            </button>
          </div>
        </div>

        <!-- Activities List -->
      <div id="activitiesList">
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <span>載入活動中...</span>
        </div>
      </div>

      <!-- My Registrations -->
      <div class="mt-5">
        <h5><i class="bi bi-clipboard-check me-2"></i>我的活動報名</h5>
        <div id="myRegistrations">
          <div class="loading-container">
            <div class="loading-spinner"></div>
            <span>載入報名記錄...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Volunteer Service -->
  <div class="tab-pane fade" id="volunteer">
    <div class="content-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="bi bi-heart me-2"></i>志工服務</h3>
        <div class="admin-only">
          <button class="btn btn-success btn-sm" onclick="showNewVolunteerNeedModal()">
            <i class="bi bi-plus-circle me-1"></i>新增志工需求
          </button>
        </div>
      </div>

      <!-- Volunteer Statistics -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="stat-card" style="background: var(--info-gradient);">
            <h3 id="volunteerHours">0</h3>
            <p><i class="bi bi-clock me-1"></i>我的服務時數</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card" style="background: var(--warning-gradient);">
            <h3 id="volunteerActivities">0</h3>
            <p><i class="bi bi-calendar me-1"></i>參與活動數</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card" style="background: var(--success-gradient);">
            <h3 id="volunteerRank">-</h3>
            <p><i class="bi bi-trophy me-1"></i>志工排名</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card" style="background: var(--danger-gradient);">
            <h3 id="availableNeeds">0</h3>
            <p><i class="bi bi-hand-thumbs-up me-1"></i>可報名需求</p>
          </div>
        </div>
      </div>

      <!-- Volunteer Needs -->
      <h5><i class="bi bi-exclamation-circle me-2"></i>志工需求</h5>
      <div id="volunteerNeeds">
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <span>載入志工需求...</span>
        </div>
      </div>

      <!-- My Volunteer Records -->
      <div class="mt-5">
        <h5><i class="bi bi-journal-text me-2"></i>我的志工記錄</h5>
        <div id="myVolunteerRecords">
          <div class="loading-container">
            <div class="loading-spinner"></div>
            <span>載入志工記錄...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Finance Management -->
  <div class="tab-pane fade" id="finance">
    <div class="content-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="bi bi-cash-coin me-2"></i>財務管理</h3>
        <div>
          <button class="btn btn-success btn-sm me-2" onclick="showNewDonationModal()">
            <i class="bi bi-heart-fill me-1"></i>愛心捐款
          </button>
          <button class="btn btn-warning btn-sm" onclick="showNewExpenseModal()">
            <i class="bi bi-receipt me-1"></i>支出申請
          </button>
        </div>
      </div>

      <!-- Finance Statistics -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="stat-card" style="background: var(--success-gradient);">
            <h3 id="myDonationAmount">NT$ 0</h3>
            <p><i class="bi bi-heart-fill me-1"></i>我的捐款總額</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card" style="background: var(--info-gradient);">
            <h3 id="myDonationCount">0</h3>
            <p><i class="bi bi-list-ol me-1"></i>捐款次數</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card" style="background: var(--warning-gradient);">
            <h3 id="myExpenseAmount">NT$ 0</h3>
            <p><i class="bi bi-receipt me-1"></i>支出申請金額</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card" style="background: var(--danger-gradient);">
            <h3 id="pendingExpenses">0</h3>
            <p><i class="bi bi-hourglass me-1"></i>待審核支出</p>
          </div>
        </div>
      </div>

      <!-- Donation History -->
      <h5><i class="bi bi-heart-fill me-2"></i>我的捐款記錄</h5>
      <div id="donationHistory">
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <span>載入捐款記錄...</span>
        </div>
      </div>

      <!-- Expense History -->
      <div class="mt-5">
        <h5><i class="bi bi-receipt me-2"></i>我的支出申請</h5>
        <div id="expenseHistory">
          <div class="loading-container">
            <div class="loading-spinner"></div>
            <span>載入支出記錄...</span>
          </div>
        </div>
      </div>

      <!-- Admin Finance Overview -->
      <div class="admin-only mt-5">
        <h5><i class="bi bi-graph-up me-2"></i>財務總覽（管理員）</h5>
        <div class="row g-3">
          <div class="col-md-3">
            <div class="stat-card" style="background: var(--success-gradient);">
              <h3 id="totalIncome">NT$ 0</h3>
              <p><i class="bi bi-arrow-up-circle me-1"></i>總收入</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card" style="background: var(--danger-gradient);">
              <h3 id="totalExpense">NT$ 0</h3>
              <p><i class="bi bi-arrow-down-circle me-1"></i>總支出</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card" style="background: var(--info-gradient);">
              <h3 id="currentBalance">NT$ 0</h3>
              <p><i class="bi bi-wallet2 me-1"></i>目前餘額</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card" style="background: var(--warning-gradient);">
              <h3 id="monthlyDonations">NT$ 0</h3>
              <p><i class="bi bi-calendar-month me-1"></i>本月捐款</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity Feedback -->
  <div class="tab-pane fade" id="feedback">
    <div class="content-card">
      <h3><i class="bi bi-chat-dots me-2"></i>活動回饋</h3>

      <!-- New Feedback Form -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>新增活動回饋</h5>
        </div>
        <div class="card-body">
          <form id="feedbackForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="feedbackActivity" required>
                  <option value="">請選擇活動</option>
                </select>
                <label for="feedbackActivity">選擇活動 *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="feedbackRating" required>
                  <option value="">請選擇評分</option>
                  <option value="5">5分 - 非常滿意</option>
                  <option value="4">4分 - 滿意</option>
                  <option value="3">3分 - 普通</option>
                  <option value="2">2分 - 不滿意</option>
                  <option value="1">1分 - 非常不滿意</option>
                </select>
                <label for="feedbackRating">評分 *</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" style="height: 120px" id="feedbackComment" required></textarea>
                <label for="feedbackComment">意見與建議 *</label>
              </div>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-send me-1"></i>提交回饋
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- My Feedback History -->
      <h5><i class="bi bi-chat-left-text me-2"></i>我的回饋記錄</h5>
      <div id="myFeedback">
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <span>載入回饋記錄...</span>
        </div>
      </div>

      <!-- All Feedback (Admin Only) -->
      <div class="admin-only mt-5">
        <h5><i class="bi bi-chat-square-dots me-2"></i>所有活動回饋（管理員）</h5>
        <div id="allFeedback">
          <div class="loading-container">
            <div class="loading-spinner"></div>
            <span>載入所有回饋...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- System Administration -->
  <div class="tab-pane fade" id="admin">
    <div class="content-card">
      <h3><i class="bi bi-gear me-2"></i>系統管理</h3>

      <!-- Admin Navigation -->
      <ul class="nav nav-tabs mb-4" id="adminTabs">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#memberManagement">
            <i class="bi bi-people me-1"></i>會員管理
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#activityManagement">
            <i class="bi bi-calendar-event me-1"></i>活動管理
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#financeManagement">
            <i class="bi bi-cash-stack me-1"></i>財務管理
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#receiptManagement">
            <i class="bi bi-receipt-cutoff me-1"></i>收據管理
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#systemSettings">
            <i class="bi bi-gear-fill me-1"></i>系統設定
          </button>
        </li>
      </ul>

      <!-- Admin Tab Content -->
      <div class="tab-content">
        <!-- Member Management -->
        <div class="tab-pane fade show active" id="memberManagement">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>會員管理</h5>
            <button class="btn btn-outline-primary btn-sm" onclick="exportMembers()">
              <i class="bi bi-download me-1"></i>匯出會員資料
            </button>
          </div>
          <div class="table-container">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>姓名</th>
                  <th>會員類別</th>
                  <th>註冊狀態</th>
                  <th>加入日期</th>
                  <th>捐款次數</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="memberList">
                <tr>
                  <td colspan="6" class="text-center">
                    <div class="loading-container">
                      <div class="loading-spinner"></div>
                      <span>載入會員資料...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Activity Management -->
        <div class="tab-pane fade" id="activityManagement">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>活動管理</h5>
            <button class="btn btn-success btn-sm" onclick="showNewActivityModal()">
              <i class="bi bi-plus-circle me-1"></i>新增活動
            </button>
          </div>
          <div id="adminActivityList">
            <div class="loading-container">
              <div class="loading-spinner"></div>
              <span>載入活動資料...</span>
            </div>
          </div>
        </div>

        <!-- Finance Management -->
        <div class="tab-pane fade" id="financeManagement">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>財務管理</h5>
            <div>
              <button class="btn btn-success btn-sm me-2" onclick="showNewTransactionModal()">
                <i class="bi bi-plus-circle me-1"></i>新增交易
              </button>
              <button class="btn btn-outline-primary btn-sm" onclick="exportFinanceData()">
                <i class="bi bi-download me-1"></i>匯出財務資料
              </button>
            </div>
          </div>
          <div class="table-container">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>日期</th>
                  <th>類型</th>
                  <th>金額</th>
                  <th>類別</th>
                  <th>說明</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="transactionList">
                <tr>
                  <td colspan="6" class="text-center">
                    <div class="loading-container">
                      <div class="loading-spinner"></div>
                      <span>載入交易記錄...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Receipt Management -->
        <div class="tab-pane fade" id="receiptManagement">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>收據管理</h5>
            <div>
              <button class="btn btn-info btn-sm me-2" onclick="showReceiptTemplateModal()">
                <i class="bi bi-file-text me-1"></i>模板設定
              </button>
              <button class="btn btn-success btn-sm" onclick="showManualReceiptModal()">
                <i class="bi bi-plus-circle me-1"></i>手動開立
              </button>
            </div>
          </div>
          <div id="receiptList">
            <div class="loading-container">
              <div class="loading-spinner"></div>
              <span>載入收據記錄...</span>
            </div>
          </div>
        </div>

        <!-- System Settings -->
        <div class="tab-pane fade" id="systemSettings">
          <h5>系統設定</h5>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0"><i class="bi bi-database me-2"></i>資料備份</h6>
                </div>
                <div class="card-body">
                  <p class="text-muted small">定期備份系統資料以確保資料安全</p>
                  <button class="btn btn-warning" onclick="backupSystem()">
                    <i class="bi bi-download me-1"></i>立即備份
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0"><i class="bi bi-bell me-2"></i>系統通知</h6>
                </div>
                <div class="card-body">
                  <p class="text-muted small">發送系統通知給所有會員</p>
                  <button class="btn btn-info" onclick="showSystemNotificationModal()">
                    <i class="bi bi-megaphone me-1"></i>發送通知
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="modalContainer"></div>

<script>
  // System Configuration
  const CONFIG = {
    LIFF_ID: '1656516134-VaGgmaPm',
    API_BASE_URL: 'https://script.google.com/macros/s/AKfycbx9QAIVnqQjK3_TzLsKwqD315C2y-UzHihCnXoa3Wlsa7AA12WFIxXzNH_YPygLTqo89A/exec',
    API_KEY: 'AAbb8520258185202581',
    ADMIN_API_URL: 'https://script.google.com/macros/s/AKfycbx9QAIVnqQjK3_TzLsKwqD315C2y-UzHihCnXoa3Wlsa7AA12WFIxXzNH_YPygLTqo89A/exec',
    ADMIN_LIFF_ID: '1656516134-k8rMQwnQ'
  };

  // Global Variables
  let currentUser = null;
  let isAdmin = false;
  let userProfile = null;
  let currentPage = 1;
  let itemsPerPage = 10;

  // Utility Functions
  function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return '-';
    return date.toLocaleDateString('zh-TW');
  }

  function formatDateTime(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return '-';
    return date.toLocaleString('zh-TW');
  }

  function formatCurrency(amount) {
    return new Intl.NumberFormat('zh-TW', {
      style: 'currency',
      currency: 'TWD',
      minimumFractionDigits: 0
    }).format(amount || 0);
  }

  function showNotification(message, type = 'success', duration = 3000) {
    const container = document.getElementById('notificationContainer');
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span>${message}</span>
        <button onclick="this.parentElement.parentElement.remove()" 
                style="background: none; border: none; color: inherit; cursor: pointer; font-size: 18px; margin-left: 10px;">
          &times;
        </button>
      </div>
    `;
    
    container.appendChild(notification);
    setTimeout(() => notification.classList.add('show'), 100);
    
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => notification.remove(), 300);
    }, duration);
  }

  function setButtonLoading(buttonElement, loading = true) {
    if (!buttonElement) return;
    
    if (loading) {
      buttonElement.disabled = true;
      buttonElement.classList.add('loading');
      const text = buttonElement.querySelector('span:not(.loading-spinner)');
      if (text) text.style.opacity = '0';
    } else {
      buttonElement.disabled = false;
      buttonElement.classList.remove('loading');
      const text = buttonElement.querySelector('span:not(.loading-spinner)');
      if (text) text.style.opacity = '1';
    }
  }

  // API Functions
  async function callAPI(action, data = {}, retries = 3) {
    const apiUrl = isAdmin && action.startsWith('admin') ? CONFIG.ADMIN_API_URL : CONFIG.API_BASE_URL;
    
    for (let i = 0; i < retries; i++) {
      try {
        const payload = {
          action,
          ...data,
          apiKey: CONFIG.API_KEY,
          timestamp: Date.now(),
          nonce: Math.random().toString(36).substring(2)
        };

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (!result.success && result.message) {
          throw new Error(result.message);
        }

        return result;
      } catch (error) {
        console.error(`API call failed (attempt ${i + 1}/${retries}):`, error);
        if (i === retries - 1) throw error;
        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
      }
    }
  }

  // LIFF Initialization
  async function initializeLiff() {
    try {
      await liff.init({ liffId: CONFIG.LIFF_ID });
      
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      userProfile = await liff.getProfile();
      await loadUserData();
      await loadDashboard();
      
      showNotification('系統初始化成功', 'success');
    } catch (error) {
      console.error('LIFF initialization failed:', error);
      showNotification('系統初始化失敗，請重新整理頁面', 'error');
    }
  }

  // User Data Management
  async function loadUserData() {
    try {
      const result = await callAPI('getUserInfo', { 
        lineId: userProfile.userId 
      });

      if (result.success && result.data) {
        currentUser = result.data;
        isAdmin = currentUser.isAdmin || false;
        updateUserInterface();
      } else {
        // User not registered, show registration form
        showRegistrationForm();
      }
    } catch (error) {
      console.error('Failed to load user data:', error);
      showRegistrationForm();
    }
  }

  function updateUserInterface() {
    // Update user info bar
    const userInfoBar = document.getElementById('userInfoBar');
    const userName = document.getElementById('userName');
    const userRole = document.getElementById('userRole');
    const userAvatar = document.getElementById('userAvatar');

    if (currentUser) {
      userName.textContent = currentUser.realName || currentUser.lineName || '會員';
      userRole.textContent = currentUser.memberType || '會員';
      userAvatar.textContent = (currentUser.realName || currentUser.lineName || '?')[0];
      userInfoBar.style.display = 'inline-flex';

      // Show/hide admin features
      const adminElements = document.querySelectorAll('.admin-only');
      adminElements.forEach(el => {
        el.classList.toggle('show', isAdmin);
      });

      // Update profile section
      updateProfileSection();
    }
  }

  function showRegistrationForm() {
    document.getElementById('registrationSection').style.display = 'block';
    document.getElementById('profileSection').style.display = 'none';
  }

  function updateProfileSection() {
    if (!currentUser) return;

    // Hide registration form, show profile form
    document.getElementById('registrationSection').style.display = 'none';
    document.getElementById('profileSection').style.display = 'block';

    // Populate profile form
    document.getElementById('profileRealName').value = currentUser.realName || '';
    document.getElementById('lineName').value = currentUser.lineName || '';
    document.getElementById('phone').value = currentUser.phone || '';
    document.getElementById('email').value = currentUser.email || '';
    document.getElementById('birthday').value = currentUser.birthday || '';
    document.getElementById('profileMemberType').value = currentUser.memberType || '';
    document.getElementById('address').value = currentUser.address || '';
  }

  // Dashboard Functions
  async function loadDashboard() {
    try {
      const result = await callAPI('getDashboardData', {
        lineId: userProfile?.userId
      });

      if (result.success) {
        updateDashboardStats(result.data);
        updateRecentActivity(result.data.recentActivity || []);
      }
    } catch (error) {
      console.error('Failed to load dashboard:', error);
      document.getElementById('dashboardStats').innerHTML = `
        <div class="col-12 text-center text-danger">
          <i class="bi bi-exclamation-triangle fs-1"></i>
          <p class="mt-2">載入失敗：${error.message}</p>
        </div>
      `;
    }
  }

  function updateDashboardStats(data) {
    const statsContainer = document.getElementById('dashboardStats');
    statsContainer.innerHTML = `
      <div class="col-md-3">
        <div class="stat-card">
          <h3>${data.totalActivities || 0}</h3>
          <p><i class="bi bi-calendar-event me-1"></i>可報名活動</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card" style="background: var(--info-gradient);">
          <h3>${data.myRegistrations || 0}</h3>
          <p><i class="bi bi-clipboard-check me-1"></i>我的報名</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card" style="background: var(--warning-gradient);">
          <h3>${data.myVolunteerHours || 0}</h3>
          <p><i class="bi bi-clock me-1"></i>志工時數</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card" style="background: var(--danger-gradient);">
          <h3>${formatCurrency(data.myDonationAmount || 0).replace('NT$', '')}</h3>
          <p><i class="bi bi-heart-fill me-1"></i>捐款總額</p>
        </div>
      </div>
    `;
  }

  function updateRecentActivity(activities) {
    const container = document.getElementById('recentActivity';
if (!activities || activities.length === 0) {
container.innerHTML = '<p class="text-muted text-center">暫無最近活動</p>';
return;
}
    container.innerHTML = activities.map(activity => `
      <div class="activity-item">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h6 class="mb-1">${activity.title}</h6>
            <p class="mb-1 text-muted">${activity.description}</p>
            <small class="text-muted">
              <i class="bi bi-calendar me-1"></i>${formatDate(activity.date)}
            </small>
          </div>
          <span class="status-badge status-${activity.status.toLowerCase()}">${activity.status}</span>
        </div>
      </div>
    `).join('');
  }

  // Tab Management
  function showTab(tabId) {
    const tabButton = document.querySelector(`button[data-bs-target="#${tabId}"]`);
    if (tabButton) {
      tabButton.click();
    }
  }

  // Registration Functions
  document.getElementById('registrationForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const submitButton = e.target.querySelector('button[type="submit"]');
    
    setButtonLoading(submitButton, true);
    
    try {
      const result = await callAPI('registerUser', {
        lineId: userProfile.userId,
        lineName: userProfile.displayName,
        realName: formData.get('realName'),
        memberType: formData.get('memberType')
      });

      if (result.success) {
        showNotification('註冊成功！歡迎加入帕金森病友會', 'success');
        await loadUserData();
      } else {
        throw new Error(result.message || '註冊失敗');
      }
    } catch (error) {
      showNotification(`註冊失敗：${error.message}`, 'error');
    } finally {
      setButtonLoading(submitButton, false);
    }
  });

  // Profile Update
  document.getElementById('profileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const submitButton = e.target.querySelector('button[type="submit"]');
    
    setButtonLoading(submitButton, true);
    
    try {
      const result = await callAPI('updateProfile', {
        lineId: userProfile.userId,
        phone: formData.get('phone'),
        email: formData.get('email'),
        birthday: formData.get('birthday'),
        memberType: formData.get('memberType'),
        address: formData.get('address')
      });

      if (result.success) {
        showNotification('個人資料更新成功', 'success');
        await loadUserData();
      } else {
        throw new Error(result.message || '更新失敗');
      }
    } catch (error) {
      showNotification(`更新失敗：${error.message}`, 'error');
    } finally {
      setButtonLoading(submitButton, false);
    }
  });

  // Activity Management
  async function loadActivities() {
    try {
      const result = await callAPI('getActivities');
      
      if (result.success) {
        updateActivitiesList(result.data);
      }
    } catch (error) {
      document.getElementById('activitiesList').innerHTML = `
        <div class="text-center text-danger">
          <i class="bi bi-exclamation-triangle fs-1"></i>
          <p class="mt-2">載入活動失敗：${error.message}</p>
        </div>
      `;
    }
  }

  function updateActivitiesList(activities) {
    const container = document.getElementById('activitiesList');
    
    if (!activities || activities.length === 0) {
      container.innerHTML = '<p class="text-muted text-center">目前沒有活動</p>';
      return;
    }

    container.innerHTML = activities.map(activity => `
      <div class="activity-item">
        <div class="row">
          <div class="col-md-8">
            <h5 class="mb-2">${activity.title}</h5>
            <p class="mb-2">${activity.description}</p>
            <div class="d-flex gap-3 text-muted small">
              <span><i class="bi bi-calendar me-1"></i>${formatDate(activity.date)}</span>
              <span><i class="bi bi-clock me-1"></i>${activity.time}</span>
              <span><i class="bi bi-geo-alt me-1"></i>${activity.location}</span>
              <span><i class="bi bi-people me-1"></i>${activity.currentCount}/${activity.maxParticipants}</span>
            </div>
          </div>
          <div class="col-md-4 text-end">
            <div class="mb-2">
              <span class="status-badge status-${activity.status.replace(' ', '').toLowerCase()}">${activity.status}</span>
            </div>
            <div class="mb-2">
              <strong class="text-primary">${formatCurrency(activity.fee)}</strong>
            </div>
            ${activity.status === '開放報名' ? `
              <button class="btn btn-primary btn-sm" onclick="registerActivity('${activity.id}')">
                <i class="bi bi-plus-circle me-1"></i>報名
              </button>
            ` : ''}
          </div>
        </div>
      </div>
    `).join('');
  }

  async function registerActivity(activityId) {
    if (!currentUser) {
      showNotification('請先完成會員註冊', 'warning');
      return;
    }

    try {
      const result = await callAPI('registerActivity', {
        lineId: userProfile.userId,
        activityId: activityId
      });

      if (result.success) {
        showNotification('活動報名成功！', 'success');
        await loadActivities();
        await loadMyRegistrations();
      } else {
        throw new Error(result.message || '報名失敗');
      }
    } catch (error) {
      showNotification(`報名失敗：${error.message}`, 'error');
    }
  }

  async function loadMyRegistrations() {
    if (!currentUser) return;

    try {
      const result = await callAPI('getMyRegistrations', {
        lineId: userProfile.userId
      });

      if (result.success) {
        updateMyRegistrations(result.data);
      }
    } catch (error) {
      document.getElementById('myRegistrations').innerHTML = `
        <div class="text-center text-danger">
          <p>載入報名記錄失敗：${error.message}</p>
        </div>
      `;
    }
  }

  function updateMyRegistrations(registrations) {
    const container = document.getElementById('myRegistrations');
    
    if (!registrations || registrations.length === 0) {
      container.innerHTML = '<p class="text-muted text-center">您還沒有報名任何活動</p>';
      return;
    }

    container.innerHTML = registrations.map(reg => `
      <div class="activity-item">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h6 class="mb-1">${reg.activityTitle}</h6>
            <p class="mb-1 text-muted">${reg.activityDescription}</p>
            <small class="text-muted">
              <i class="bi bi-calendar me-1"></i>${formatDate(reg.activityDate)}
              <i class="bi bi-clock ms-2 me-1"></i>報名時間：${formatDateTime(reg.registrationTime)}
            </small>
          </div>
          <div class="text-end">
            <span class="status-badge status-${reg.status.toLowerCase()}">${reg.status}</span>
            ${reg.status === '已報名' ? `
              <button class="btn btn-danger btn-sm mt-2" onclick="cancelRegistration('${reg.id}')">
                <i class="bi bi-x-circle me-1"></i>取消報名
              </button>
            ` : ''}
          </div>
        </div>
      </div>
    `).join('');
  }

  async function cancelRegistration(registrationId) {
    if (!confirm('確定要取消這個活動報名嗎？')) return;

    try {
      const result = await callAPI('cancelRegistration', {
        lineId: userProfile.userId,
        registrationId: registrationId
      });

      if (result.success) {
        showNotification('已取消報名', 'success');
        await loadMyRegistrations();
        await loadActivities();
      } else {
        throw new Error(result.message || '取消失敗');
      }
    } catch (error) {
      showNotification(`取消失敗：${error.message}`, 'error');
    }
  }

  // Volunteer Functions
  async function loadVolunteerData() {
    if (!currentUser) return;

    try {
      const result = await callAPI('getVolunteerData', {
        lineId: userProfile.userId
      });

      if (result.success) {
        updateVolunteerStats(result.data.stats);
        updateVolunteerNeeds(result.data.needs);
        updateMyVolunteerRecords(result.data.records);
      }
    } catch (error) {
      console.error('Failed to load volunteer data:', error);
    }
  }

  function updateVolunteerStats(stats) {
    document.getElementById('volunteerHours').textContent = stats.totalHours || 0;
    document.getElementById('volunteerActivities').textContent = stats.totalActivities || 0;
    document.getElementById('volunteerRank').textContent = stats.rank || '-';
    document.getElementById('availableNeeds').textContent = stats.availableNeeds || 0;
  }

  function updateVolunteerNeeds(needs) {
    const container = document.getElementById('volunteerNeeds');
    
    if (!needs || needs.length === 0) {
      container.innerHTML = '<p class="text-muted text-center">目前沒有志工需求</p>';
      return;
    }

    container.innerHTML = needs.map(need => `
      <div class="activity-item">
        <div class="row">
          <div class="col-md-8">
            <h6 class="mb-2">${need.title}</h6>
            <p class="mb-2">${need.description}</p>
            <div class="d-flex gap-3 text-muted small">
              <span><i class="bi bi-calendar me-1"></i>${formatDate(need.date)}</span>
              <span><i class="bi bi-clock me-1"></i>${need.time}</span>
              <span><i class="bi bi-people me-1"></i>需要 ${need.needCount} 人</span>
              <span><i class="bi bi-award me-1"></i>${need.hours} 小時</span>
            </div>
          </div>
          <div class="col-md-4 text-end">
            <div class="mb-2">
              <span class="status-badge status-${need.status.toLowerCase()}">${need.status}</span>
            </div>
            ${need.status === '開放報名' ? `
              <button class="btn btn-success btn-sm" onclick="applyVolunteer('${need.id}')">
                <i class="bi bi-hand-thumbs-up me-1"></i>我要報名
              </button>
            ` : ''}
          </div>
        </div>
      </div>
    `).join('');
  }

  function updateMyVolunteerRecords(records) {
    const container = document.getElementById('myVolunteerRecords');
    
    if (!records || records.length === 0) {
      container.innerHTML = '<p class="text-muted text-center">您還沒有志工服務記錄</p>';
      return;
    }

    container.innerHTML = records.map(record => `
      <div class="activity-item">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h6 class="mb-1">${record.title}</h6>
            <p class="mb-1 text-muted">${record.description}</p>
            <small class="text-muted">
              <i class="bi bi-calendar me-1"></i>${formatDate(record.date)}
              <i class="bi bi-clock ms-2 me-1"></i>${record.hours} 小時
            </small>
          </div>
          <span class="status-badge status-${record.status.toLowerCase()}">${record.status}</span>
        </div>
      </div>
    `).join('');
  }

  async function applyVolunteer(needId) {
    if (!currentUser) {
      showNotification('請先完成會員註冊', 'warning');
      return;
    }

    try {
      const result = await callAPI('applyVolunteer', {
        lineId: userProfile.userId,
        needId: needId
      });

      if (result.success) {
        showNotification('志工報名成功！', 'success');
        await loadVolunteerData();
      } else {
        throw new Error(result.message || '報名失敗');
      }
    } catch (error) {
      showNotification(`報名失敗：${error.message}`, 'error');
    }
  }

  // Finance Functions
  async function loadFinanceData() {
    if (!currentUser) return;

    try {
      const result = await callAPI('getFinanceData', {
        lineId: userProfile.userId
      });

      if (result.success) {
        updateFinanceStats(result.data.stats);
        updateDonationHistory(result.data.donations);
        updateExpenseHistory(result.data.expenses);
        
        if (isAdmin) {
          updateAdminFinanceStats(result.data.adminStats);
        }
      }
    } catch (error) {
      console.error('Failed to load finance data:', error);
    }
  }

  function updateFinanceStats(stats) {
    document.getElementById('myDonationAmount').textContent = formatCurrency(stats.totalDonation || 0).replace('NT$', '');
    document.getElementById('myDonationCount').textContent = stats.donationCount || 0;
    document.getElementById('myExpenseAmount').textContent = formatCurrency(stats.totalExpense || 0).replace('NT$', '');
    document.getElementById('pendingExpenses').textContent = stats.pendingExpenses || 0;
  }

  function updateDonationHistory(donations) {
    const container = document.getElementById('donationHistory');
    
    if (!donations || donations.length === 0) {
      container.innerHTML = '<p class="text-muted text-center">您還沒有捐款記錄</p>';
      return;
    }

    container.innerHTML = donations.map(donation => `
      <div class="transaction-item">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h6 class="mb-1">捐款 - ${donation.category}</h6>
            <p class="mb-1 text-muted">${donation.description}</p>
            <small class="text-muted">
              <i class="bi bi-calendar me-1"></i>${formatDateTime(donation.date)}
            </small>
          </div>
          <div class="text-end">
            <div class="fw-bold text-success">${formatCurrency(donation.amount)}</div>
            <small class="text-muted">收據: ${donation.receiptNumber || '處理中'}</small>
          </div>
        </div>
      </div>
    `).join('');
  }

  function updateExpenseHistory(expenses) {
    const container = document.getElementById('expenseHistory');
    
    if (!expenses || expenses.length === 0) {
      container.innerHTML = '<p class="text-muted text-center">您還沒有支出申請記錄</p>';
      return;
    }

    container.innerHTML = expenses.map(expense => `
      <div class="transaction-item">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h6 class="mb-1">支出申請 - ${expense.category}</h6>
            <p class="mb-1 text-muted">${expense.description}</p>
            <small class="text-muted">
              <i class="bi bi-calendar me-1"></i>${formatDateTime(expense.date)}
            </small>
          </div>
          <div class="text-end">
            <div class="fw-bold text-danger">${formatCurrency(expense.amount)}</div>
            <span class="status-badge status-${expense.status.toLowerCase()}">${expense.status}</span>
          </div>
        </div>
      </div>
    `).join('');
  }

  // Modal Functions
  function showNewDonationModal() {
    const modalHtml = `
      <div class="modal fade" id="donationModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>愛心捐款</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="donationForm">
              <div class="modal-body">
                <div class="form-floating mb-3">
                  <select class="form-select" id="donationCategory" required>
                    <option value="">請選擇捐款類別</option>
                    <option value="一般捐款">一般捐款</option>
                    <option value="活動贊助">活動贊助</option>
                    <option value="設備購置">設備購置</option>
                    <option value="其他">其他</option>
                  </select>
                  <label for="donationCategory">捐款類別 *</label>
                </div>
                <div class="form-floating mb-3">
                  <input type="number" class="form-control" id="donationAmount" min="1" required>
                  <label for="donationAmount">捐款金額 *</label>
                </div>
                <div class="form-floating mb-3">
                  <textarea class="form-control" style="height: 100px" id="donationDescription"></textarea>
                  <label for="donationDescription">備註說明</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="needReceipt" checked>
                  <label class="form-check-label" for="needReceipt">
                    需要開立收據
                  </label>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="submit" class="btn btn-success">
                  <i class="bi bi-heart-fill me-1"></i>確認捐款
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('modalContainer').innerHTML = modalHtml;
    const modal = new bootstrap.Modal(document.getElementById('donationModal'));
    modal.show();

    document.getElementById('donationForm').addEventListener('submit', handleDonationSubmit);
  }

  async function handleDonationSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const submitButton = e.target.querySelector('button[type="submit"]');
    
    setButtonLoading(submitButton, true);
    
    try {
      const result = await callAPI('createDonation', {
        lineId: userProfile.userId,
        category: formData.get('donationCategory'),
        amount: parseInt(formData.get('donationAmount')),
        description: formData.get('donationDescription'),
        needReceipt: document.getElementById('needReceipt').checked
      });

      if (result.success) {
        showNotification('捐款記錄已建立，感謝您的愛心！', 'success');
        bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
        await loadFinanceData();
      } else {
        throw new Error(result.message || '建立失敗');
      }
    } catch (error) {
      showNotification(`建立失敗：${error.message}`, 'error');
    } finally {
      setButtonLoading(submitButton, false);
    }
  }

  // Feedback Functions
  async function loadFeedbackData() {
    if (!currentUser) return;

    try {
      // Load available activities for feedback
      const activitiesResult = await callAPI('getMyCompletedActivities', {
        lineId: userProfile.userId
      });
      
      if (activitiesResult.success) {
        updateFeedbackActivityOptions(activitiesResult.data);
      }

      // Load my feedback history
      const feedbackResult = await callAPI('getMyFeedback', {
        lineId: userProfile.userId
      });
      
      if (feedbackResult.success) {
        updateMyFeedback(feedbackResult.data);
      }

      // Load all feedback for admin
      if (isAdmin) {
        const allFeedbackResult = await callAPI('getAllFeedback');
        if (allFeedbackResult.success) {
          updateAllFeedback(allFeedbackResult.data);
        }
      }
    } catch (error) {
      console.error('Failed to load feedback data:', error);
    }
  }

  function updateFeedbackActivityOptions(activities) {
    const select = document.getElementById('feedbackActivity');
    select.innerHTML = '<option value="">請選擇活動</option>';
    
    activities.forEach(activity => {
      select.innerHTML += `<option value="${activity.id}">${activity.title} (${formatDate(activity.date)})</option>`;
    });
  }

  function updateMyFeedback(feedbacks) {
    const container = document.getElementById('myFeedback');
    
    if (!feedbacks || feedbacks.length === 0) {
      container.innerHTML = '<p class="text-muted text-center">您還沒有提交任何活動回饋</p>';
      return;
    }

    container.innerHTML = feedbacks.map(feedback => `
      <div class="activity-item">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h6 class="mb-1">${feedback.activityTitle}</h6>
            <div class="mb-2">
              ${'★'.repeat(feedback.rating)}${'☆'.repeat(5-feedback.rating)}
              <span class="ms-2 text-muted">(${feedback.rating}/5)</span>
            </div>
            <p class="mb-1">${feedback.comment}</p>
            <small class="text-muted">
              <i class="bi bi-calendar me-1"></i>${formatDateTime(feedback.createdAt)}
            </small>
          </div>
        </div>
      </div>
    `).join('');
  }

  // Feedback Form Submit
  document.getElementById('feedbackForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const submitButton = e.target.querySelector('button[type="submit"]');
    
    setButtonLoading(submitButton, true);
    
    try {
      const result = await callAPI('createFeedback', {
        lineId: userProfile.userId,
        activityId: formData.get('feedbackActivity'),
        rating: parseInt(formData.get('feedbackRating')),
        comment: formData.get('feedbackComment')
      });

      if (result.success) {
        showNotification('活動回饋提交成功，感謝您的意見！', 'success');
        e.target.reset();
        await loadFeedbackData();
      } else {
        throw new Error(result.message || '提交失敗');
      }
    } catch (error) {
      showNotification(`提交失敗：${error.message}`, 'error');
    } finally {
      setButtonLoading(submitButton, false);
    }
  });

  // Refresh Data
  async function refreshData() {
    const refreshButton = document.querySelector('button[onclick="refreshData()"]');
    setButtonLoading(refreshButton, true);
    
    try {
      await Promise.all([
        loadDashboard(),
        loadActivities(),
        loadMyRegistrations(),
        loadVolunteerData(),
        loadFinanceData(),
        loadFeedbackData()
      ]);
      
      showNotification('資料已刷新', 'success');
    } catch (error) {
      showNotification(`刷新失敗：${error.message}`, 'error');
    } finally {
      setButtonLoading(refreshButton, false);
    }
  }

  // Tab Event Listeners
  document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('[data-bs-toggle="pill"]');
    tabButtons.forEach(button => {
      button.addEventListener('shown.bs.tab', function(e) {
        const targetId = e.target.getAttribute('data-bs-target').substring(1);
        
        switch(targetId) {
          case 'activities':
            loadActivities();
            loadMyRegistrations();
            break;
          case 'volunteer':
            loadVolunteerData();
            break;
          case 'finance':
            loadFinanceData();
            break;
          case 'feedback':
            loadFeedbackData();
            break;
          case 'admin':
            if (isAdmin) {
              loadAdminData();
            }
            break;
        }
      });
    });
  });

  // Admin Functions
  async function loadAdminData() {
    if (!isAdmin) return;

    try {
      const result = await callAPI('getAdminData');
      
      if (result.success) {
        updateMemberList(result.data.members);
        updateAdminActivityList(result.data.activities);
        updateTransactionList(result.data.transactions);
        updateReceiptList(result.data.receipts);
      }
    } catch (error) {
      console.error('Failed to load admin data:', error);
    }
  }

  function updateMemberList(members) {
    const tbody = document.getElementById('memberList');
    
    if (!members || members.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">暫無會員資料</td></tr>';
      return;
    }

    tbody.innerHTML = members.map(member => `
      <tr>
        <td>${member.realName}</td>
        <td>${member.memberType}</td>
        <td><span class="status-badge status-${member.status.toLowerCase()}">${member.status}</span></td>
        <td>${formatDate(member.joinDate)}</td>
        <td>${member.donationCount || 0}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="viewMemberDetail('${member.lineId}')">
            <i class="bi bi-eye"></i>
          </button>
        </td>
      </tr>
    `).join('');
  }

  // Initialize System
  window.addEventListener('load', function() {
    initializeLiff();
  });

  // Prevent form submit on enter
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'BUTTON') {
      e.preventDefault();
    }
  });

  // Export functions to global scope
  window.showTab = showTab;
  window.refreshData = refreshData;
  window.showNewDonationModal = showNewDonationModal;
  window.registerActivity = registerActivity;
  window.cancelRegistration = cancelRegistration;
  window.applyVolunteer = applyVolunteer;
</script>

</body>
</html>
