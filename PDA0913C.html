<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理員專區</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
      body {
          font-family: 'Noto Sans TC', sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
      }
      .admin-nav {
          background: white;
          border-radius: 15px;
          margin: 20px;
          padding: 15px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      }
      .nav-pills .nav-link {
          border-radius: 10px;
          margin: 0 5px;
          font-weight: 600;
      }
      .nav-pills .nav-link.active {
          background: linear-gradient(135deg, #2c5aa0, #4a90e2);
      }
      .content-card {
          background: white;
          border-radius: 20px;
          margin: 20px;
          padding: 25px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      }
      .stat-card {
          background: linear-gradient(135deg, #28a745, #20c997);
          color: white;
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 20px;
          text-align: center;
      }
      .stat-card h3 {
          font-size: 2.5rem;
          font-weight: bold;
          margin-bottom: 10px;
      }
      .table-container {
          max-height: 400px;
          overflow-y: auto;
          border-radius: 10px;
          border: 1px solid #dee2e6;
      }
      .btn-group-sm .btn {
          padding: 0.25rem 0.5rem;
          font-size: 0.875rem;
          border-radius: 8px;
      }
      .form-floating {
          margin-bottom: 15px;
      }
      .form-floating .form-control, .form-floating .form-select {
          border-radius: 10px;
      }
      .loading {
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 40px;
      }
      .activity-card {
          border: none;
          border-radius: 15px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.1);
          margin-bottom: 20px;
          transition: transform 0.2s;
      }
      .activity-card:hover {
          transform: translateY(-3px);
      }
      .report-card {
          border: none;
          border-radius: 15px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.1);
          transition: transform 0.2s;
      }
      .report-card:hover {
          transform: translateY(-3px);
      }
      .chart-container {
          position: relative;
          height: 300px;
          margin: 20px 0;
      }
  </style>
</head>
<body>
  <!-- 導航選單 -->
  <div class="admin-nav">
      <ul class="nav nav-pills justify-content-center" id="adminTabs">
          <li class="nav-item">
              <a class="nav-link active" data-bs-toggle="pill" href="#dashboard">
                  <i class="bi bi-speedometer2 me-1"></i>儀表板
              </a>
          </li>
          <li class="nav-item">
              <a class="nav-link" data-bs-toggle="pill" href="#finance">
                  <i class="bi bi-cash-coin me-1"></i>財務管理
              </a>
          </li>
          <li class="nav-item">
              <a class="nav-link" data-bs-toggle="pill" href="#members">
                  <i class="bi bi-people me-1"></i>會員管理
              </a>
          </li>
          <li class="nav-item">
              <a class="nav-link" data-bs-toggle="pill" href="#activities">
                  <i class="bi bi-calendar-event me-1"></i>活動管理
              </a>
          </li>
          <li class="nav-item">
              <a class="nav-link" data-bs-toggle="pill" href="#reports">
                  <i class="bi bi-file-earmark-text me-1"></i>報表中心
              </a>
          </li>
      </ul>
  </div>

  <!-- 內容區域 -->
  <div class="tab-content">
      <!-- 儀表板 -->
      <div class="tab-pane fade show active" id="dashboard">
          <div class="content-card">
              <h4 class="mb-4"><i class="bi bi-speedometer2 me-2"></i>系統概覽</h4>
              <div class="row" id="dashboardStats">
                  <div class="col-12 text-center">
                      <div class="loading">
                          <div class="spinner-border text-primary" role="status">
                              <span class="visually-hidden">載入中...</span>
                          </div>
                      </div>
                  </div>
              </div>
              <div class="row mt-4">
                  <div class="col-md-6">
                      <h6>最近收入</h6>
                      <div id="recentIncome" class="table-container">
                          <div class="text-center p-4">載入中...</div>
                      </div>
                  </div>
                  <div class="col-md-6">
                      <h6>最近支出</h6>
                      <div id="recentExpense" class="table-container">
                          <div class="text-center p-4">載入中...</div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- 財務管理 -->
      <div class="tab-pane fade" id="finance">
          <div class="content-card">
              <div class="d-flex justify-content-between align-items-center mb-4">
                  <h4><i class="bi bi-cash-coin me-2"></i>財務管理</h4>
                  <div class="btn-group">
                      <button class="btn btn-success btn-sm" onclick="showIncomeForm()">
                          <i class="bi bi-plus-circle me-1"></i>新增收入
                      </button>
                      <button class="btn btn-danger btn-sm" onclick="showExpenseForm()">
                          <i class="bi bi-dash-circle me-1"></i>新增支出
                      </button>
                  </div>
              </div>
              
              <!-- 收支表單 -->
              <div id="financeForm" style="display: none;">
                  <div class="card border-primary mb-4">
                      <div class="card-header bg-primary text-white">
                          <h6 class="mb-0" id="formTitle">新增交易</h6>
                      </div>
                      <div class="card-body">
                          <form id="transactionForm">
                              <div class="row g-3">
                                  <div class="col-md-6">
                                      <div class="form-floating">
                                          <input type="date" class="form-control" id="transactionDate" required>
                                          <label>日期</label>
                                      </div>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="form-floating">
                                          <select class="form-select" id="transactionType" required>
                                              <option value="">請選擇</option>
                                              <option value="收入">收入</option>
                                              <option value="支出">支出</option>
                                          </select>
                                          <label>類型</label>
                                      </div>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="form-floating">
                                          <select class="form-select" id="transactionCategory" required>
                                              <option value="">請選擇類別</option>
                                          </select>
                                          <label>類別</label>
                                      </div>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="form-floating">
                                          <input type="number" class="form-control" id="transactionAmount" required min="1">
                                          <label>金額</label>
                                      </div>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="form-floating">
                                          <input type="text" class="form-control" id="transactionTarget">
                                          <label>對象</label>
                                      </div>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="form-floating">
                                          <select class="form-select" id="transactionAccount" required>
                                              <option value="現金">現金</option>
                                              <option value="銀行">銀行</option>
                                          </select>
                                          <label>帳戶</label>
                                      </div>
                                  </div>
                                  <div class="col-12">
                                      <div class="form-floating">
                                          <textarea class="form-control" id="transactionDescription" style="height: 80px;"></textarea>
                                          <label>說明</label>
                                      </div>
                                  </div>
                              </div>
                              <div class="mt-3">
                                  <button type="submit" class="btn btn-primary me-2">
                                      <i class="bi bi-check-circle me-1"></i>儲存
                                  </button>
                                  <button type="button" class="btn btn-secondary" onclick="hideFinanceForm()">
                                      <i class="bi bi-x-circle me-1"></i>取消
                                  </button>
                              </div>
                          </form>
                      </div>
                  </div>
              </div>
              
              <!-- 交易列表 -->
              <div class="table-container mt-4">
                  <table class="table table-hover">
                      <thead class="table-light">
                          <tr>
                              <th>日期</th>
                              <th>類型</th>
                              <th>類別</th>
                              <th>金額</th>
                              <th>對象</th>
                              <th>操作</th>
                          </tr>
                      </thead>
                      <tbody id="transactionList">
                          <tr><td colspan="6" class="text-center">載入中...</td></tr>
                      </tbody>
                  </table>
              </div>
          </div>
      </div>

      <!-- 會員管理 -->
      <div class="tab-pane fade" id="members">
          <div class="content-card">
              <div class="d-flex justify-content-between align-items-center mb-4">
                  <h4><i class="bi bi-people me-2"></i>會員管理</h4>
                  <div class="btn-group">
                      <button class="btn btn-primary btn-sm" onclick="exportMembers()">
                          <i class="bi bi-download me-1"></i>匯出會員
                      </button>
                      <button class="btn btn-success btn-sm" onclick="refreshMemberList()">
                          <i class="bi bi-arrow-clockwise me-1"></i>重新整理
                      </button>
                  </div>
              </div>
              
              <!-- 會員統計 -->
              <div class="row mb-4" id="memberStats">
                  <div class="col-md-3">
                      <div class="card text-center">
                          <div class="card-body">
                              <h5 class="card-title text-primary" id="totalUsers">0</h5>
                              <p class="card-text">總用戶數</p>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card text-center">
                          <div class="card-body">
                              <h5 class="card-title text-success" id="totalMembers">0</h5>
                              <p class="card-text">正式會員</p>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card text-center">
                          <div class="card-body">
                              <h5 class="card-title text-warning" id="newMembersThisMonth">0</h5>
                              <p class="card-text">本月新增</p>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="card text-center">
                          <div class="card-body">
                              <h5 class="card-title text-info" id="activeDonors">0</h5>
                              <p class="card-text">活躍捐款者</p>
                          </div>
                      </div>
                  </div>
              </div>
              
              <div class="table-container">
                  <table class="table table-hover">
                      <thead class="table-light">
                          <tr>
                              <th>姓名</th>
                              <th>電話</th>
                              <th>會員狀態</th>
                              <th>加入日期</th>
                              <th>最後捐款</th>
                              <th>操作</th>
                          </tr>
                      </thead>
                      <tbody id="memberList">
                          <tr><td colspan="6" class="text-center">載入中...</td></tr>
                      </tbody>
                  </table>
              </div>
          </div>
      </div>

      <!-- 活動管理 -->
      <div class="tab-pane fade" id="activities">
          <div class="content-card">
              <div class="d-flex justify-content-between align-items-center mb-4">
                  <h4><i class="bi bi-calendar-event me-2"></i>活動管理</h4>
                  <button class="btn btn-success btn-sm" onclick="showActivityForm()">
                      <i class="bi bi-plus-circle me-1"></i>新增活動
                  </button>
              </div>
              
              <!-- 活動表單 -->
              <div id="activityForm" style="display: none;">
                  <div class="card border-success mb-4">
                      <div class="card-header bg-success text-white">
                          <h6 class="mb-0">新增活動</h6>
                      </div>
                      <div class="card-body">
                          <form id="newActivityForm">
                              <div class="row g-3">
                                  <div class="col-md-8">
                                      <div class="form-floating">
                                          <input type="text" class="form-control" id="activityName" required>
                                          <label>活動名稱</label>
                                      </div>
                                  </div>
                                  <div class="col-md-4">
                                      <div class="form-floating">
                                          <select class="form-select" id="activityType" required>
                                              <option value="">請選擇</option>
                                              <option value="講座">講座</option>
                                              <option value="聚會">聚會</option>
                                              <option value="旅遊">旅遊</option>
                                              <option value="運動">運動</option>
                                              <option value="志工服務">志工服務</option>
                                              <option value="其他">其他</option>
                                          </select>
                                          <label>活動類型</label>
                                      </div>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="form-floating">
                                          <input type="date" class="form-control" id="activityDate" required>
                                          <label>活動日期</label>
                                      </div>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="form-floating">
                                          <input type="time" class="form-control" id="activityTime">
                                          <label>活動時間</label>
                                      </div>
                                  </div>
                                  <div class="col-md-8">
                                      <div class="form-floating">
                                          <input type="text" class="form-control" id="activityLocation">
                                          <label>活動地點</label>
                                      </div>
                                  </div>
                                  <div class="col-md-4">
                                      <div class="form-floating">
                                          <input type="number" class="form-control" id="activityMaxPeople" min="1" value="50">
                                          <label>人數上限</label>
                                      </div>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="form-floating">
                                          <input type="number" class="form-control" id="activityFee" min="0" value="0">
                                          <label>活動費用</label>
                                      </div>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="form-floating">
                                          <input type="text" class="form-control" id="activityContact">
                                          <label>聯絡人</label>
                                      </div>
                                  </div>
                                  <div class="col-12">
                                      <div class="form-floating">
                                          <textarea class="form-control" id="activityDescription" style="height: 100px;"></textarea>
                                          <label>活動描述</label>
                                      </div>
                                  </div>
                              </div>
                              <div class="mt-3">
                                  <button type="submit" class="btn btn-success me-2">
                                      <i class="bi bi-check-circle me-1"></i>建立活動
                                  </button>
                                  <button type="button" class="btn btn-secondary" onclick="hideActivityForm()">
                                      <i class="bi bi-x-circle me-1"></i>取消
                                  </button>
                              </div>
                          </form>
                      </div>
                  </div>
              </div>
              
              <!-- 活動列表 -->
              <div class="row" id="activityList">
                  <div class="col-12 text-center">載入中...</div>
              </div>
          </div>
      </div>

      <!-- 報表中心 -->
      <div class="tab-pane fade" id="reports">
          <div class="content-card">
              <h4 class="mb-4"><i class="bi bi-file-earmark-text me-2"></i>報表中心</h4>
              <div class="row g-3 mb-4">
                  <div class="col-md-4">
                      <div class="card report-card h-100">
                          <div class="card-body text-center">
                              <i class="bi bi-cash-stack text-success" style="font-size: 3rem;"></i>
                              <h5 class="mt-3">財務報表</h5>
                              <p class="text-muted">收支統計與分析</p>
                              <button class="btn btn-success" onclick="generateFinanceReport()">
                                  <i class="bi bi-graph-up me-1"></i>產生報表
                              </button>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="card report-card h-100">
                          <div class="card-body text-center">
                              <i class="bi bi-people-fill text-primary" style="font-size: 3rem;"></i>
                              <h5 class="mt-3">會員報表</h5>
                              <p class="text-muted">會員統計與分析</p>
                              <button class="btn btn-primary" onclick="generateMemberReport()">
                                  <i class="bi bi-person-lines-fill me-1"></i>產生報表
                              </button>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="card report-card h-100">
                          <div class="card-body text-center">
                              <i class="bi bi-calendar-event text-warning" style="font-size: 3rem;"></i>
                              <h5 class="mt-3">活動報表</h5>
                              <p class="text-muted">活動統計與分析</p>
                              <button class="btn btn-warning" onclick="generateActivityReport()">
                                  <i class="bi bi-calendar-check me-1"></i>產生報表
                              </button>
                          </div>
                      </div>
                  </div>
              </div>
              
              <div id="reportContent" class="mt-4" style="display: none;">
                  <!-- 報表內容將在這裡動態載入 -->
              </div>
          </div>
      </div>
  </div>

  <!-- 會員詳情模態框 -->
  <div class="modal fade" id="memberDetailModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">會員詳細資料</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="memberDetailContent">
                  <!-- 會員詳情內容 -->
              </div>
          </div>
      </div>
  </div>

  <!-- 活動詳情模態框 -->
  <div class="modal fade" id="activityDetailModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">活動詳細資料</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="activityDetailContent">
                  <!-- 活動詳情內容 -->
              </div>
          </div>
      </div>
  </div>

  <script>
      let userId = null;
      let isAdmin = false;
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbzxcdhyVb2uNePH-SITfQrHzwcAjj67Y7J7IVHxZB3MS_zwgf9TOtpPmPbVjXgcUCgOCQ/exec'; // 請替換為實際的 GAS URL
      
      // 初始化 LIFF
      liff.init({ liffId: '1656516134-k8rMQwnQ' }).then(() => {
          if (!liff.isLoggedIn()) {
              liff.login();
              return;
          }
          
          liff.getProfile().then(profile => {
              userId = profile.userId;
              checkAdminPermission();
          });
      }).catch(err => {
          console.error('LIFF初始化失敗:', err);
          alert('系統初始化失敗，請重新開啟');
      });
      
      // 檢查管理員權限
      async function checkAdminPermission() {
          try {
              const response = await fetch(`${GAS_URL}?action=getUserInfo&userId=${userId}`);
              const userInfo = await response.json();
              
              if (!userInfo || userInfo.用戶角色 !== 'admin') {
                  alert('您沒有管理員權限');
                  liff.closeWindow();
                  return;
              }
              
              isAdmin = true;
              loadDashboard();
          } catch (error) {
              console.error('權限驗證失敗:', error);
              alert('權限驗證失敗');
              liff.closeWindow();
          }
      }
      
      // 載入儀表板
      async function loadDashboard() {
          try {
              const response = await fetch(`${GAS_URL}?action=getDashboardStats`);
              const stats = await response.json();
              
              document.getElementById('dashboardStats').innerHTML = `
                  <div class="col-md-3">
                      <div class="stat-card">
                          <h3>${stats.totalMembers || 0}</h3>
                          <p><i class="bi bi-people-fill me-1"></i>總會員數</p>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                          <h3>$${(stats.totalIncome || 0).toLocaleString()}</h3>
                          <p><i class="bi bi-arrow-up-circle me-1"></i>本月收入</p>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="stat-card" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                          <h3>$${(stats.totalExpense || 0).toLocaleString()}</h3>
                          <p><i class="bi bi-arrow-down-circle me-1"></i>本月支出</p>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="stat-card" style="background: linear-gradient(135deg, #ffc107, #e0a800);">
                          <h3>${stats.activeActivities || 0}</h3>
                          <p><i class="bi bi-calendar-check me-1"></i>進行中活動</p>
                      </div>
                  </div>
              `;
              
              loadRecentTransactions();
              
          } catch (error) {
              console.error('載入儀表板失敗:', error);
              showError('載入儀表板失敗');
          }
      }
      
      // 載入最近交易
      async function loadRecentTransactions() {
          try {
              const response = await fetch(`${GAS_URL}?action=getRecentTransactions`);
              const transactions = await response.json();
              
              const income = transactions.filter(t => t.類型 === '收入').slice(0, 5);
              const expense = transactions.filter(t => t.類型 === '支出').slice(0, 5);
              
              document.getElementById('recentIncome').innerHTML = income.length > 0 ? `
                  <table class="table table-sm">
                      <tbody>
                          ${income.map(t => `
                              <tr>
                                  <td>${formatDate(t.日期)}</td>
                                  <td>${t.類別}</td>
                                  <td class="text-success">+$${t.金額.toLocaleString()}</td>
                              </tr>
                          `).join('')}
                      </tbody>
                  </table>
              ` : '<div class="text-center p-3 text-muted">暫無收入記錄</div>';
              
              document.getElementById('recentExpense').innerHTML = expense.length > 0 ? `
                  <table class="table table-sm">
                      <tbody>
                          ${expense.map(t => `
                              <tr>
                                  <td>${formatDate(t.日期)}</td>
                                  <td>${t.類別}</td>
                                  <td class="text-danger">-$${t.金額.toLocaleString()}</td>
                              </tr>
                          `).join('')}
                      </tbody>
                  </table>
              ` : '<div class="text-center p-3 text-muted">暫無支出記錄</div>';
              
          } catch (error) {
              console.error('載入交易紀錄失敗:', error);
          }
      }
      
      // 顯示收入表單
      function showIncomeForm() {
          document.getElementById('financeForm').style.display = 'block';
          document.getElementById('formTitle').textContent = '新增收入';
          document.getElementById('transactionType').value = '收入';
          document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
          updateCategoryOptions('收入');
      }
      
      // 顯示支出表單
      function showExpenseForm() {
          document.getElementById('financeForm').style.display = 'block';
          document.getElementById('formTitle').textContent = '新增支出';
          document.getElementById('transactionType').value = '支出';
          document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
          updateCategoryOptions('支出');
      }
      
      // 隱藏財務表單
      function hideFinanceForm() {
          document.getElementById('financeForm').style.display = 'none';
          document.getElementById('transactionForm').reset();
      }
      
      // 更新類別選項
      function updateCategoryOptions(type) {
          const categorySelect = document.getElementById('transactionCategory');
          let options = '';
          
          if (type === '收入') {
              options = `
                  <option value="會費">會費</option>
                  <option value="捐款">捐款</option>
                  <option value="活動收入">活動收入</option>
                  <option value="政府補助">政府補助</option>
                  <option value="其他收入">其他收入</option>
              `;
          } else {
              options = `
                  <option value="活動費用">活動費用</option>
                  <option value="辦公費用">辦公費用</option>
                  <option value="交通費">交通費</option>
                  <option value="餐費">餐費</option>
                  <option value="場地費">場地費</option>
                  <option value="其他支出">其他支出</option>
              `;
          }
          
          categorySelect.innerHTML = options;
      }
      
      // 提交交易表單
      document.getElementById('transactionForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>儲存中...';
          submitBtn.disabled = true;
          
          const formData = {
              action: 'addTransaction',
              date: document.getElementById('transactionDate').value,
              type: document.getElementById('transactionType').value,
              category: document.getElementById('transactionCategory').value,
              amount: parseInt(document.getElementById('transactionAmount').value),
              target: document.getElementById('transactionTarget').value,
              account: document.getElementById('transactionAccount').value,
              description: document.getElementById('transactionDescription').value
          };
          
          try {
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(formData)
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showSuccess('交易記錄已新增');
                  hideFinanceForm();
                  loadTransactionList();
                  loadDashboard();
              } else {
                  showError('新增失敗：' + result.message);
              }
          } catch (error) {
              console.error('新增交易失敗:', error);
              showError('系統錯誤，請稍後再試');
          } finally {
              submitBtn.innerHTML = originalText;
              submitBtn.disabled = false;
          }
      });
      
      // 載入交易列表
      async function loadTransactionList() {
          try {
              const response = await fetch(`${GAS_URL}?action=getAllTransactions`);
              const transactions = await response.json();
              
              if (transactions.length === 0) {
                  document.getElementById('transactionList').innerHTML = 
                      '<tr><td colspan="6" class="text-center text-muted">暫無交易記錄</td></tr>';
                  return;
              }
              
              document.getElementById('transactionList').innerHTML = transactions.map(t => `
                  <tr>
                      <td>${formatDate(t.日期)}</td>
                      <td><span class="badge ${t.類型 === '收入' ? 'bg-success' : 'bg-danger'}">${t.類型}</span></td>
                      <td>${t.類別}</td>
                      <td class="${t.類型 === '收入' ? 'text-success' : 'text-danger'}">
                          ${t.類型 === '收入' ? '+' : '-'}$${t.金額.toLocaleString()}
                      </td>
                      <td>${t.對象 || '-'}</td>
                      <td>
                          <div class="btn-group-sm">
                              <button class="btn btn-outline-info btn-sm" onclick="viewTransactionDetail('${t.交易ID}')" title="查看詳情">
                                  <i class="bi bi-eye"></i>
                              </button>
                              <button class="btn btn-outline-danger btn-sm" onclick="deleteTransaction('${t.交易ID}')" title="刪除">
                                  <i class="bi bi-trash"></i>
                              </button>
                          </div>
                      </td>
                  </tr>
              `).join('');
              
          } catch (error) {
              console.error('載入交易列表失敗:', error);
              document.getElementById('transactionList').innerHTML = 
                  '<tr><td colspan="6" class="text-center text-danger">載入失敗</td></tr>';
          }
      }
      
      // 載入會員列表
      async function loadMemberList() {
          try {
              const response = await fetch(`${GAS_URL}?action=getAllMembers`);
              const members = await response.json();
              
              // 更新會員統計
              updateMemberStats(members);
              
              if (members.length === 0) {
                  document.getElementById('memberList').innerHTML = 
                      '<tr><td colspan="6" class="text-center text-muted">暫無會員資料</td></tr>';
                  return;
              }
              
              document.getElementById('memberList').innerHTML = members.map(m => `
                  <tr>
                      <td>${m.真實姓名 || m.LINE名稱}</td>
                      <td>${m.電話 || '-'}</td>
                      <td>
                          <span class="badge ${m.是否會員 ? 'bg-success' : 'bg-secondary'}">
                              ${m.是否會員 ? '正式會員' : '一般用戶'}
                          </span>
                      </td>
                      <td>${formatDate(m.加入日期)}</td>
                      <td>${m.最後捐款日期 ? formatDate(m.最後捐款日期) : '-'}</td>
                      <td>
                          <div class="btn-group-sm">
                              <button class="btn btn-outline-primary btn-sm" onclick="viewMemberDetail('${m.用戶ID}')" title="查看詳情">
                                  <i class="bi bi-eye"></i>
                              </button>
                              <button class="btn btn-outline-success btn-sm" onclick="sendMessageToMember('${m.用戶ID}')" title="發送訊息">
                                  <i class="bi bi-chat-dots"></i>
                              </button>
                          </div>
                      </td>
                  </tr>
              `).join('');
              
          } catch (error) {
              console.error('載入會員列表失敗:', error);
              document.getElementById('memberList').innerHTML = 
                  '<tr><td colspan="6" class="text-center text-danger">載入失敗</td></tr>';
          }
      }
      
      // 更新會員統計
      function updateMemberStats(members) {
          const totalUsers = members.length;
          const totalMembers = members.filter(m => m.是否會員).length;
          
          const now = new Date();
          const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
          const newMembersThisMonth = members.filter(m => 
              m.加入日期 && new Date(m.加入日期) >= thisMonth
          ).length;
          
          const activeDonors = members.filter(m => 
              m.最後捐款日期 && 
              new Date(m.最後捐款日期) > new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000)
          ).length;
          
          document.getElementById('totalUsers').textContent = totalUsers;
          document.getElementById('totalMembers').textContent = totalMembers;
          document.getElementById('newMembersThisMonth').textContent = newMembersThisMonth;
          document.getElementById('activeDonors').textContent = activeDonors;
      }
      
      // 重新整理會員列表
      function refreshMemberList() {
          document.getElementById('memberList').innerHTML = 
              '<tr><td colspan="6" class="text-center">載入中...</td></tr>';
          loadMemberList();
      }
      
      // 顯示活動表單
      function showActivityForm() {
          document.getElementById('activityForm').style.display = 'block';
          document.getElementById('activityDate').value = new Date().toISOString().split('T')[0];
          document.getElementById('activityForm').scrollIntoView({ behavior: 'smooth' });
      }
      
      // 隱藏活動表單
      function hideActivityForm() {
          document.getElementById('activityForm').style.display = 'none';
          document.getElementById('newActivityForm').reset();
      }
      
      // 提交活動表單
      document.getElementById('newActivityForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>建立中...';
          submitBtn.disabled = true;
          
          const formData = {
              action: 'addActivity',
              name: document.getElementById('activityName').value,
              type: document.getElementById('activityType').value,
              date: document.getElementById('activityDate').value,
              time: document.getElementById('activityTime').value,
              location: document.getElementById('activityLocation').value,
              maxPeople: parseInt(document.getElementById('activityMaxPeople').value),
              fee: parseInt(document.getElementById('activityFee').value) || 0,
              contact: document.getElementById('activityContact').value,
              description: document.getElementById('activityDescription').value
          };
          
          try {
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(formData)
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showSuccess('活動已建立');
                  hideActivityForm();
                  loadActivityList();
              } else {
                  showError('建立失敗：' + result.message);
              }
          } catch (error) {
              console.error('建立活動失敗:', error);
              showError('系統錯誤，請稍後再試');
          } finally {
              submitBtn.innerHTML = originalText;
              submitBtn.disabled = false;
          }
      });
      
      // 載入活動列表
      async function loadActivityList() {
          try {
              const response = await fetch(`${GAS_URL}?action=getAllActivities`);
              const activities = await response.json();
              
              if (activities.length === 0) {
                  document.getElementById('activityList').innerHTML = 
                      '<div class="col-12 text-center text-muted">暫無活動資料</div>';
                  return;
              }
              
              document.getElementById('activityList').innerHTML = activities.map(a => `
                  <div class="col-md-6 mb-3">
                      <div class="card activity-card">
                          <div class="card-body">
                              <div class="d-flex justify-content-between align-items-start mb-2">
                                  <h6 class="card-title mb-0">${a.活動名稱}</h6>
                                  <span class="badge ${getActivityStatusBadge(a.活動狀態)}">${a.活動狀態}</span>
                              </div>
                              <p class="card-text small text-muted">
                                  <i class="bi bi-calendar me-1"></i>${formatDate(a.活動日期)} ${a.活動時間 || ''}<br>
                                  <i class="bi bi-geo-alt me-1"></i>${a.活動地點 || '待定'}<br>
                                  <i class="bi bi-people me-1"></i>報名人數：${a.報名人數 || 0}/${a.人數上限}
                              </p>
                              <div class="btn-group-sm">
                                  <button class="btn btn-outline-primary btn-sm" onclick="viewActivityDetail('${a.活動ID}')">
                                      <i class="bi bi-eye me-1"></i>詳情
                                  </button>
                                  <button class="btn btn-outline-success btn-sm" onclick="exportActivityRegistrations('${a.活動ID}')">
                                      <i class="bi bi-download me-1"></i>匯出
                                  </button>
                                  <button class="btn btn-outline-warning btn-sm" onclick="editActivity('${a.活動ID}')">
                                      <i class="bi bi-pencil me-1"></i>編輯
                                  </button>
                                  <button class="btn btn-outline-danger btn-sm" onclick="deleteActivity('${a.活動ID}')">
                                      <i class="bi bi-trash me-1"></i>刪除
                                  </button>
                              </div>
                          </div>
                      </div>
                  </div>
              `).join('');
              
          } catch (error) {
              console.error('載入活動列表失敗:', error);
              document.getElementById('activityList').innerHTML = 
                  '<div class="col-12 text-center text-danger">載入失敗</div>';
          }
      }
      
      // 取得活動狀態徽章樣式
      function getActivityStatusBadge(status) {
          switch(status) {
              case '已發布': return 'bg-success';
              case '報名中': return 'bg-primary';
              case '已額滿': return 'bg-warning';
              case '已結束': return 'bg-secondary';
              case '已取消': return 'bg-danger';
              default: return 'bg-secondary';
          }
      }
      
      // 產生財務報表
      async function generateFinanceReport() {
          const reportContent = document.getElementById('reportContent');
          reportContent.style.display = 'block';
          reportContent.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">產生報表中...</p></div>';
          
          try {
              const response = await fetch(`${GAS_URL}?action=generateFinanceReport`);
              const report = await response.json();
              
              reportContent.innerHTML = `
                  <div class="card">
                      <div class="card-header bg-success text-white">
                          <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>財務報表 - ${new Date().getFullYear()}年${new Date().getMonth() + 1}月</h5>
                      </div>
                      <div class="card-body">
                          <div class="row text-center mb-4">
                              <div class="col-md-4">
                                  <div class="border rounded p-3">
                                      <h3 class="text-success">${report.totalIncome ? '$' + report.totalIncome.toLocaleString() : '$0'}</h3>
                                      <p class="text-muted">總收入</p>
                                  </div>
                              </div>
                              <div class="col-md-4">
                                  <div class="border rounded p-3">
                                      <h3 class="text-danger">${report.totalExpense ? '$' + report.totalExpense.toLocaleString() : '$0'}</h3>
                                      <p class="text-muted">總支出</p>
                                  </div>
                              </div>
                              <div class="col-md-4">
                                  <div class="border rounded p-3">
                                      <h3 class="${(report.balance || 0) >= 0 ? 'text-success' : 'text-danger'}">
                                          ${report.balance ? '$' + report.balance.toLocaleString() : '$0'}
                                      </h3>
                                      <p class="text-muted">結餘</p>
                                  </div>
                              </div>
                          </div>
                          <div class="text-center">
                              <button class="btn btn-success me-2" onclick="exportFinanceReport()">
                                  <i class="bi bi-download me-1"></i>匯出 Excel
                              </button>
                              <button class="btn btn-primary" onclick="printReport()">
                                  <i class="bi bi-printer me-1"></i>列印報表
                              </button>
                          </div>
                      </div>
                  </div>
              `;
              
          } catch (error) {
              console.error('產生財務報表失敗:', error);
              reportContent.innerHTML = '<div class="alert alert-danger">產生報表失敗，請稍後再試</div>';
          }
      }
      
      // 產生會員報表
      async function generateMemberReport() {
          const reportContent = document.getElementById('reportContent');
          reportContent.style.display = 'block';
          reportContent.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">產生報表中...</p></div>';
          
          try {
              const response = await fetch(`${GAS_URL}?action=getAllMembers`);
              const members = await response.json();
              
              const totalUsers = members.length;
              const totalMembers = members.filter(m => m.是否會員).length;
              const activeDonors = members.filter(m => 
                  m.最後捐款日期 && 
                  new Date(m.最後捐款日期) > new Date(Date.now() - 90 * 24 * 60 * 60 * 1000)
              ).length;
              
              reportContent.innerHTML = `
                  <div class="card">
                      <div class="card-header bg-primary text-white">
                          <h5 class="mb-0"><i class="bi bi-people me-2"></i>會員統計報表</h5>
                      </div>
                      <div class="card-body">
                          <div class="row text-center mb-4">
                              <div class="col-md-3">
                                  <div class="border rounded p-3">
                                      <h3 class="text-primary">${totalUsers}</h3>
                                      <p class="text-muted">總用戶數</p>
                                  </div>
                              </div>
                              <div class="col-md-3">
                                  <div class="border rounded p-3">
                                      <h3 class="text-success">${totalMembers}</h3>
                                      <p class="text-muted">正式會員</p>
                                  </div>
                              </div>
                              <div class="col-md-3">
                                  <div class="border rounded p-3">
                                      <h3 class="text-info">${activeDonors}</h3>
                                      <p class="text-muted">活躍捐款者</p>
                                  </div>
                              </div>
                              <div class="col-md-3">
                                  <div class="border rounded p-3">
                                      <h3 class="text-warning">${Math.round((totalMembers / totalUsers) * 100)}%</h3>
                                      <p class="text-muted">會員轉換率</p>
                                  </div>
                              </div>
                          </div>
                          <div class="text-center">
                              <button class="btn btn-primary me-2" onclick="exportMembers()">
                                  <i class="bi bi-download me-1"></i>匯出會員資料
                              </button>
                              <button class="btn btn-success" onclick="printReport()">
                                  <i class="bi bi-printer me-1"></i>列印報表
                              </button>
                          </div>
                      </div>
                  </div>
              `;
              
          } catch (error) {
              console.error('產生會員報表失敗:', error);
              reportContent.innerHTML = '<div class="alert alert-danger">產生報表失敗，請稍後再試</div>';
          }
      }
      
      // 產生活動報表
      async function generateActivityReport() {
          const reportContent = document.getElementById('reportContent');
          reportContent.style.display = 'block';
          reportContent.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">產生報表中...</p></div>';
          
          try {
              const response = await fetch(`${GAS_URL}?action=getAllActivities`);
              const activities = await response.json();
              
              const totalActivities = activities.length;
              const activeActivities = activities.filter(a => a.活動狀態 === '已發布' || a.活動狀態 === '報名中').length;
              const completedActivities = activities.filter(a => a.活動狀態 === '已結束').length;
              const totalRegistrations = activities.reduce((sum, a) => sum + (a.報名人數 || 0), 0);
              
              reportContent.innerHTML = `
                  <div class="card">
                      <div class="card-header bg-warning text-dark">
                          <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>活動統計報表</h5>
                      </div>
                      <div class="card-body">
                          <div class="row text-center mb-4">
                              <div class="col-md-3">
                                  <div class="border rounded p-3">
                                      <h3 class="text-primary">${totalActivities}</h3>
                                      <p class="text-muted">總活動數</p>
                                  </div>
                              </div>
                              <div class="col-md-3">
                                  <div class="border rounded p-3">
                                      <h3 class="text-success">${activeActivities}</h3>
                                      <p class="text-muted">進行中活動</p>
                                  </div>
                              </div>
                              <div class="col-md-3">
                                  <div class="border rounded p-3">
                                      <h3 class="text-info">${completedActivities}</h3>
                                      <p class="text-muted">已完成活動</p>
                                  </div>
                              </div>
                              <div class="col-md-3">
                                  <div class="border rounded p-3">
                                      <h3 class="text-warning">${totalRegistrations}</h3>
                                      <p class="text-muted">總報名人次</p>
                                  </div>
                              </div>
                          </div>
                          <div class="text-center">
                              <button class="btn btn-warning me-2" onclick="exportActivityReport()">
                                  <i class="bi bi-download me-1"></i>匯出活動資料
                              </button>
                              <button class="btn btn-primary" onclick="printReport()">
                                  <i class="bi bi-printer me-1"></i>列印報表
                              </button>
                          </div>
                      </div>
                  </div>
              `;
              
          } catch (error) {
              console.error('產生活動報表失敗:', error);
              reportContent.innerHTML = '<div class="alert alert-danger">產生報表失敗，請稍後再試</div>';
          }
      }
      
      // 標籤頁切換事件
      document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tab => {
          tab.addEventListener('shown.bs.tab', (e) => {
              const target = e.target.getAttribute('href');
              
              switch(target) {
                  case '#finance':
                      loadTransactionList();
                      break;
                  case '#members':
                      loadMemberList();
                      break;
                  case '#activities':
                      loadActivityList();
                      break;
                  case '#reports':
                      document.getElementById('reportContent').style.display = 'none';
                      break;
              }
          });
      });
      
      // 工具函數
      function formatDate(dateString) {
          if (!dateString) return '-';
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW');
      }
      
      function showSuccess(message) {
          // 可以使用 Toast 或其他通知方式
          alert('✅ ' + message);
      }
      
      function showError(message) {
          alert('❌ ' + message);
      }
      
      // 刪除交易
      async function deleteTransaction(transactionId) {
          if (!confirm('確定要刪除此交易記錄嗎？')) return;
          
          try {
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                      action: 'deleteTransaction',
                      transactionId: transactionId
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showSuccess('交易記錄已刪除');
                  loadTransactionList();
                  loadDashboard();
              } else {
                  showError('刪除失敗：' + result.message);
              }
          } catch (error) {
              console.error('刪除交易失敗:', error);
              showError('系統錯誤，請稍後再試');
          }
      }
      
      // 刪除活動
      async function deleteActivity(activityId) {
          if (!confirm('確定要刪除此活動嗎？已報名的用戶將會收到取消通知。')) return;
          
          try {
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                      action: 'deleteActivity',
                      activityId: activityId
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showSuccess('活動已刪除');
                  loadActivityList();
              } else {
                  showError('刪除失敗：' + result.message);
              }
          } catch (error) {
              console.error('刪除活動失敗:', error);
              showError('系統錯誤，請稍後再試');
          }
      }
      
      // 查看會員詳情
      async function viewMemberDetail(userId) {
          try {
              const response = await fetch(`${GAS_URL}?action=getMemberDetail&userId=${userId}`);
              const member = await response.json();
              
              document.getElementById('memberDetailContent').innerHTML = `
                  <div class="row">
                      <div class="col-md-6">
                          <h6>基本資料</h6>
                          <p><strong>LINE名稱：</strong>${member.LINE名稱 || '-'}</p>
                          <p><strong>真實姓名：</strong>${member.真實姓名 || '-'}</p>
                          <p><strong>電話：</strong>${member.電話 || '-'}</p>
                          <p><strong>電子郵件：</strong>${member.電子郵件 || '-'}</p>
                          <p><strong>地址：</strong>${member.地址 || '-'}</p>
                      </div>
                      <div class="col-md-6">
                          <h6>會員資訊</h6>
                          <p><strong>會員狀態：</strong>${member.是否會員 ? '正式會員' : '一般用戶'}</p>
                          <p><strong>加入日期：</strong>${formatDate(member.加入日期)}</p>
                          <p><strong>最後捐款：</strong>${formatDate(member.最後捐款日期)}</p>
                          <p><strong>捐款總額：</strong>$${(member.捐款總額 || 0).toLocaleString()}</p>
                      </div>
                  </div>
              `;
              
              const modal = new bootstrap.Modal(document.getElementById('memberDetailModal'));
              modal.show();
              
          } catch (error) {
              console.error('載入會員詳情失敗:', error);
              showError('載入會員詳情失敗');
          }
      }
      
      // 查看活動詳情
      async function viewActivityDetail(activityId) {
          try {
              const response = await fetch(`${GAS_URL}?action=getActivityDetail&activityId=${activityId}`);
              const activity = await response.json();
              
              document.getElementById('activityDetailContent').innerHTML = `
                  <div class="row">
                      <div class="col-md-8">
                          <h6>活動資訊</h6>
                          <p><strong>活動名稱：</strong>${activity.活動名稱}</p>
                          <p><strong>活動類型：</strong>${activity.活動類型}</p>
                          <p><strong>活動日期：</strong>${formatDate(activity.活動日期)} ${activity.活動時間 || ''}</p>
                          <p><strong>活動地點：</strong>${activity.活動地點 || '待定'}</p>
                          <p><strong>活動描述：</strong>${activity.活動描述 || '-'}</p>
                          <p><strong>聯絡人：</strong>${activity.聯絡人 || '-'}</p>
                      </div>
                      <div class="col-md-4">
                          <h6>報名狀況</h6>
                          <p><strong>人數上限：</strong>${activity.人數上限}</p>
                          <p><strong>報名人數：</strong>${activity.報名人數 || 0}</p>
                          <p><strong>活動費用：</strong>$${activity.活動費用 || 0}</p>
                          <p><strong>活動狀態：</strong>
                              <span class="badge ${getActivityStatusBadge(activity.活動狀態)}">${activity.活動狀態}</span>
                          </p>
                      </div>
                  </div>
                  <hr>
                  <h6>報名名單</h6>
                  <div class="table-container" style="max-height: 200px;">
                      <table class="table table-sm">
                          <thead>
                              <tr>
                                  <th>姓名</th>
                                  <th>電話</th>
                                  <th>報名時間</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${activity.報名名單 && activity.報名名單.length > 0 ? 
                                  activity.報名名單.map(r => `
                                      <tr>
                                          <td>${r.姓名}</td>
                                          <td>${r.電話 || '-'}</td>
                                          <td>${formatDate(r.報名時間)}</td>
                                      </tr>
                                  `).join('') : 
                                  '<tr><td colspan="3" class="text-center text-muted">暫無報名資料</td></tr>'
                              }
                          </tbody>
                      </table>
                  </div>
              `;
              
              const modal = new bootstrap.Modal(document.getElementById('activityDetailModal'));
              modal.show();
              
          } catch (error) {
              console.error('載入活動詳情失敗:', error);
              showError('載入活動詳情失敗');
          }
      }
      
      // 編輯活動
      function editActivity(activityId) {
          // 實作編輯活動功能
          showError('編輯功能開發中');
      }
      
      // 發送訊息給會員
      function sendMessageToMember(userId) {
          const message = prompt('請輸入要發送的訊息：');
          if (!message) return;
          
          fetch(GAS_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  action: 'sendMessageToUser',
                  userId: userId,
                  message: message
              })
          }).then(response => response.json())
          .then(result => {
              if (result.success) {
                  showSuccess('訊息已發送');
              } else {
                  showError('發送失敗：' + result.message);
              }
          }).catch(error => {
              console.error('發送訊息失敗:', error);
              showError('發送失敗');
          });
      }
      
      // 匯出功能
      async function exportMembers() {
          try {
              const response = await fetch(`${GAS_URL}?action=exportMembersToCSV`);
              const result = await response.json();
              
              if (result.success) {
                  const link = document.createElement('a');
                  link.href = result.downloadUrl;
                  link.download = result.fileName;
                  link.click();
                  showSuccess('會員資料匯出完成');
              } else {
                  showError('匯出失敗：' + result.error);
              }
          } catch (error) {
              console.error('匯出會員資料失敗:', error);
              showError('匯出失敗');
          }
      }
      
      async function exportFinanceReport() {
          try {
              const response = await fetch(`${GAS_URL}?action=exportFinanceReportToCSV`);
              const result = await response.json();
              
              if (result.success) {
                  const link = document.createElement('a');
                  link.href = result.downloadUrl;
                  link.download = result.fileName;
                  link.click();
                  showSuccess('財務報表匯出完成');
              } else {
                  showError('匯出失敗：' + result.error);
              }
          } catch (error) {
              console.error('匯出財務報表失敗:', error);
              showError('匯出失敗');
          }
      }
      
      async function exportActivityRegistrations(activityId) {
          try {
              const response = await fetch(`${GAS_URL}?action=exportActivityRegistrations&activityId=${activityId}`);
              const result = await response.json();
              
              if (result.success) {
                  const link = document.createElement('a');
                  link.href = result.downloadUrl;
                  link.download = result.fileName;
                  link.click();
                  showSuccess('活動報名資料匯出完成');
              } else {
                  showError('匯出失敗：' + result.error);
              }
          } catch (error) {
              console.error('匯出活動資料失敗:', error);
              showError('匯出失敗');
          }
      }
      
      async function exportActivityReport() {
          try {
              const response = await fetch(`${GAS_URL}?action=exportActivityReportToCSV`);
              const result = await response.json();
              
              if (result.success) {
                  const link = document.createElement('a');
                  link.href = result.downloadUrl;
                  link.download = result.fileName;
                  link.click();
                  showSuccess('活動報表匯出完成');
              } else {
                  showError('匯出失敗：' + result.error);
              }
          } catch (error) {
              console.error('匯出活動報表失敗:', error);
              showError('匯出失敗');
          }
      }
      
      // 列印報表
      function printReport() {
          const reportContent = document.getElementById('reportContent');
          if (reportContent.style.display === 'none') {
              showError('請先產生報表');
              return;
          }
          
          const printWindow = window.open('', '_blank');
          printWindow.document.write(`
              <!DOCTYPE html>
              <html>
              <head>
                  <title>報表列印</title>
                  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                  <style>
                      @media print {
                          .btn { display: none !important; }
                      }
                      body { font-family: 'Microsoft JhengHei', sans-serif; }
                  </style>
              </head>
              <body>
                  <div class="container">
                      <div class="text-center mb-4">
                          <h2>台灣帕金森病友權益促進會</h2>
                          <p>列印時間：${new Date().toLocaleString('zh-TW')}</p>
                      </div>
                      ${reportContent.innerHTML}
                  </div>
                  <script>
                      window.onload = function() {
                          window.print();
                          window.onafterprint = function() {
                              window.close();
                          };
                      };
                  </script>
              </body>
              </html>
          `);
          printWindow.document.close();
      }
      
      // 查看交易詳情
      async function viewTransactionDetail(transactionId) {
          try {
              const response = await fetch(`${GAS_URL}?action=getTransactionDetail&transactionId=${transactionId}`);
              const transaction = await response.json();
              
              const detailHtml = `
                  <div class="row">
                      <div class="col-md-6">
                          <h6>交易資訊</h6>
                          <p><strong>交易編號：</strong>${transaction.編號}</p>
                          <p><strong>日期：</strong>${formatDate(transaction.日期)}</p>
                          <p><strong>類型：</strong>
                              <span class="badge ${transaction.類型 === '收入' ? 'bg-success' : 'bg-danger'}">${transaction.類型}</span>
                          </p>
                          <p><strong>類別：</strong>${transaction.類別}</p>
                          <p><strong>金額：</strong>
                              <span class="${transaction.類型 === '收入' ? 'text-success' : 'text-danger'}">
                                  ${transaction.類型 === '收入' ? '+' : '-'}$${transaction.金額.toLocaleString()}
                              </span>
                          </p>
                      </div>
                      <div class="col-md-6">
                          <h6>詳細資訊</h6>
                          <p><strong>對象：</strong>${transaction.對象 || '-'}</p>
                          <p><strong>帳戶：</strong>${transaction.帳戶}</p>
                          <p><strong>說明：</strong>${transaction.說明 || '-'}</p>
                          <p><strong>建立時間：</strong>${formatDate(transaction.建立時間)}</p>
                      </div>
                  </div>
              `;
              
              // 使用 SweetAlert 或 Bootstrap Modal 顯示詳情
              alert('交易詳情：\n' + 
                    `編號：${transaction.編號}\n` +
                    `日期：${formatDate(transaction.日期)}\n` +
                    `類型：${transaction.類型}\n` +
                    `類別：${transaction.類別}\n` +
                    `金額：${transaction.類型 === '收入' ? '+' : '-'}$${transaction.金額.toLocaleString()}\n` +
                    `對象：${transaction.對象 || '-'}\n` +
                    `帳戶：${transaction.帳戶}\n` +
                    `說明：${transaction.說明 || '-'}`
              );
              
          } catch (error) {
              console.error('載入交易詳情失敗:', error);
              showError('載入交易詳情失敗');
          }
      }
      
      // 批量操作
      function selectAllMembers() {
          const checkboxes = document.querySelectorAll('input[name="memberSelect"]');
          const selectAllCheckbox = document.getElementById('selectAllMembers');
          
          checkboxes.forEach(checkbox => {
              checkbox.checked = selectAllCheckbox.checked;
          });
      }
      
      function batchSendMessage() {
          const selectedMembers = document.querySelectorAll('input[name="memberSelect"]:checked');
          
          if (selectedMembers.length === 0) {
              showError('請選擇要發送訊息的會員');
              return;
          }
          
          const message = prompt('請輸入要發送的訊息：');
          if (!message) return;
          
          const userIds = Array.from(selectedMembers).map(cb => cb.value);
          
          fetch(GAS_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  action: 'batchSendMessage',
                  userIds: userIds,
                  message: message
              })
          }).then(response => response.json())
          .then(result => {
              if (result.success) {
                  showSuccess(`已向 ${userIds.length} 位會員發送訊息`);
              } else {
                  showError('批量發送失敗：' + result.message);
              }
          }).catch(error => {
              console.error('批量發送訊息失敗:', error);
              showError('批量發送失敗');
          });
      }
      
      // 搜尋功能
      function searchMembers() {
          const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
          const rows = document.querySelectorAll('#memberList tr');
          
          rows.forEach(row => {
              const text = row.textContent.toLowerCase();
              row.style.display = text.includes(searchTerm) ? '' : 'none';
          });
      }
      
      function searchTransactions() {
          const searchTerm = document.getElementById('transactionSearch').value.toLowerCase();
          const rows = document.querySelectorAll('#transactionList tr');
          
          rows.forEach(row => {
              const text = row.textContent.toLowerCase();
              row.style.display = text.includes(searchTerm) ? '' : 'none';
          });
      }
      
      // 資料過濾
      function filterTransactionsByType() {
          const filterType = document.getElementById('transactionTypeFilter').value;
          const rows = document.querySelectorAll('#transactionList tr');
          
          rows.forEach(row => {
              if (filterType === '' || row.textContent.includes(filterType)) {
                  row.style.display = '';
              } else {
                  row.style.display = 'none';
              }
          });
      }
      
      function filterMembersByStatus() {
          const filterStatus = document.getElementById('memberStatusFilter').value;
          const rows = document.querySelectorAll('#memberList tr');
          
          rows.forEach(row => {
              if (filterStatus === '' || row.textContent.includes(filterStatus)) {
                  row.style.display = '';
              } else {
                  row.style.display = 'none';
              }
          });
      }
      
      // 自動重新整理
      let autoRefreshInterval;
      
      function toggleAutoRefresh() {
          const button = document.getElementById('autoRefreshBtn');
          
          if (autoRefreshInterval) {
              clearInterval(autoRefreshInterval);
              autoRefreshInterval = null;
              button.innerHTML = '<i class="bi bi-play-circle me-1"></i>開始自動重新整理';
              button.classList.remove('btn-danger');
              button.classList.add('btn-success');
          } else {
              autoRefreshInterval = setInterval(() => {
                  const activeTab = document.querySelector('.nav-link.active').getAttribute('href');
                  
                  switch(activeTab) {
                      case '#dashboard':
                          loadDashboard();
                          break;
                      case '#finance':
                          loadTransactionList();
                          break;
                      case '#members':
                          loadMemberList();
                          break;
                      case '#activities':
                          loadActivityList();
                          break;
                  }
              }, 30000); // 每30秒重新整理
              
              button.innerHTML = '<i class="bi bi-stop-circle me-1"></i>停止自動重新整理';
              button.classList.remove('btn-success');
              button.classList.add('btn-danger');
          }
      }
      
      // 鍵盤快捷鍵
      document.addEventListener('keydown', (e) => {
          if (e.ctrlKey || e.metaKey) {
              switch(e.key) {
                  case '1':
                      e.preventDefault();
                      document.querySelector('[href="#dashboard"]').click();
                      break;
                  case '2':
                      e.preventDefault();
                      document.querySelector('[href="#finance"]').click();
                      break;
                  case '3':
                      e.preventDefault();
                      document.querySelector('[href="#members"]').click();
                      break;
                  case '4':
                      e.preventDefault();
                      document.querySelector('[href="#activities"]').click();
                      break;
                  case '5':
                      e.preventDefault();
                      document.querySelector('[href="#reports"]').click();
                      break;
                  case 'r':
                      e.preventDefault();
                      location.reload();
                      break;
              }
          }
      });
      
      // 離開頁面確認
      window.addEventListener('beforeunload', (e) => {
          if (document.getElementById('financeForm').style.display !== 'none' ||
              document.getElementById('activityForm').style.display !== 'none') {
              e.preventDefault();
              e.returnValue = '您有未儲存的變更，確定要離開嗎？';
          }
      });
      
      // 錯誤處理
      window.addEventListener('error', (e) => {
          console.error('JavaScript錯誤:', e.error);
          showError('系統發生錯誤，請重新整理頁面');
      });
      
      // 網路狀態監控
      window.addEventListener('online', () => {
          showSuccess('網路連線已恢復');
      });
      
      window.addEventListener('offline', () => {
          showError('網路連線中斷，部分功能可能無法使用');
      });
      
      // 初始化完成後的設定
      document.addEventListener('DOMContentLoaded', () => {
          // 設定日期輸入的預設值
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('transactionDate').value = today;
          
          // 設定表單驗證
          const forms = document.querySelectorAll('form');
          forms.forEach(form => {
              form.addEventListener('submit', (e) => {
                  if (!form.checkValidity()) {
                      e.preventDefault();
                      e.stopPropagation();
                  }
                  form.classList.add('was-validated');
              });
          });
      });
  </script>
</body>
</html>
                          
