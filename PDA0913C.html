<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>財務管理系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
      body {
          font-family: 'Noto Sans TC', sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
      }

      .finance-header {
          background: white;
          border-radius: 15px;
          margin: 20px;
          padding: 20px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      }

      .content-card {
          background: white;
          border-radius: 20px;
          margin: 20px;
          padding: 25px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      }

      .stat-card {
          background: linear-gradient(135deg, #28a745, #20c997);
          color: white;
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 20px;
          text-align: center;
          transition: transform 0.3s ease;
      }

      .stat-card:hover {
          transform: translateY(-5px);
      }

      .stat-card h3 {
          font-size: 2.5rem;
          font-weight: bold;
          margin-bottom: 10px;
      }

      .stat-card.income {
          background: linear-gradient(135deg, #28a745, #20c997);
      }

      .stat-card.expense {
          background: linear-gradient(135deg, #dc3545, #c82333);
      }

      .stat-card.net {
          background: linear-gradient(135deg, #17a2b8, #138496);
      }

      .stat-card.balance {
          background: linear-gradient(135deg, #ffc107, #e0a800);
      }

      .table-container {
          max-height: 500px;
          overflow-y: auto;
          border-radius: 10px;
          border: 1px solid #dee2e6;
      }

      .form-floating {
          margin-bottom: 15px;
      }

      .form-floating .form-control, 
      .form-floating .form-select {
          border-radius: 10px;
      }

      .alert {
          border-radius: 15px;
          margin-bottom: 20px;
      }

      .table-success {
          --bs-table-bg: rgba(25, 135, 84, 0.1);
      }

      .table-danger {
          --bs-table-bg: rgba(220, 53, 69, 0.1);
      }

      .transaction-amount {
          font-weight: bold;
          font-size: 1.1em;
      }

      .chart-container {
          position: relative;
          height: 300px;
          margin-bottom: 20px;
      }

      .pagination .page-link {
          color: #2c5aa0;
          border-radius: 8px;
          margin: 0 2px;
      }

      .pagination .page-item.active .page-link {
          background-color: #2c5aa0;
          border-color: #2c5aa0;
      }

      .filter-section {
          background: #f8f9fa;
          border-radius: 10px;
          padding: 15px;
          margin-bottom: 20px;
      }

      .btn-group-sm .btn {
          padding: 0.25rem 0.5rem;
          font-size: 0.875rem;
      }

      .loading {
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 40px;
      }

      .transaction-card {
          border: 1px solid #dee2e6;
          border-radius: 10px;
          margin-bottom: 15px;
          padding: 15px;
          transition: all 0.3s ease;
      }

      .transaction-card:hover {
          box-shadow: 0 5px 15px rgba(0,0,0,0.1);
          transform: translateY(-2px);
      }

      .transaction-card.income {
          border-left: 4px solid #28a745;
      }

      .transaction-card.expense {
          border-left: 4px solid #dc3545;
      }

      .receipt-thumbnail {
          max-width: 60px;
          max-height: 60px;
          border-radius: 5px;
          cursor: pointer;
      }

      .modal-body img {
          max-width: 100%;
          height: auto;
      }

      @media (max-width: 768px) {
          .stat-card h3 {
              font-size: 1.8rem;
          }
          
          .table-responsive {
              font-size: 0.875rem;
          }
      }
  </style>
</head>
<body>
  <!-- 錯誤/成功訊息 -->
  <div id="errorAlert" class="alert alert-danger mx-3" style="display: none;">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <span id="errorMessage"></span>
  </div>

  <div id="successAlert" class="alert alert-success mx-3" style="display: none;">
      <i class="bi bi-check-circle me-2"></i>
      <span id="successMessage"></span>
  </div>

  <!-- 頁面標題 -->
  <div class="finance-header">
      <div class="d-flex justify-content-between align-items-center">
          <div>
              <h2 class="mb-1"><i class="bi bi-cash-coin me-2"></i>財務管理系統</h2>
              <p class="text-muted mb-0">管理組織的收支記錄與財務報表</p>
          </div>
          <div>
              <button class="btn btn-outline-secondary btn-sm" onclick="liff.closeWindow()" id="closeBtn" style="display: none;">
                  <i class="bi bi-x-lg me-1"></i>關閉
              </button>
          </div>
      </div>
  </div>

  <!-- 主要內容 -->
  <div class="content-card">
      <!-- 操作按鈕 -->
      <div class="d-flex justify-content-between align-items-center mb-4">
          <h4><i class="bi bi-graph-up me-2"></i>財務概覽</h4>
          <div>
              <button class="btn btn-success btn-sm me-2" onclick="showTransactionForm()">
                  <i class="bi bi-plus-circle me-1"></i>新增交易
              </button>
              <button class="btn btn-info btn-sm me-2" onclick="showFinancialReport()">
                  <i class="bi bi-bar-chart me-1"></i>財務報表
              </button>
              <button class="btn btn-warning btn-sm me-2" onclick="exportFinancialData()">
                  <i class="bi bi-download me-1"></i>匯出資料
              </button>
              <button class="btn btn-outline-primary btn-sm" onclick="refreshFinance()">
                  <i class="bi bi-arrow-clockwise me-1"></i>重新整理
              </button>
          </div>
      </div>

      <!-- 財務統計卡片 -->
      <div class="row mb-4" id="financeStats">
          <div class="col-md-3">
              <div class="stat-card income">
                  <h3 id="totalIncome">載入中...</h3>
                  <p><i class="bi bi-arrow-up-circle me-1"></i>本月收入</p>
              </div>
          </div>
          <div class="col-md-3">
              <div class="stat-card expense">
                  <h3 id="totalExpense">載入中...</h3>
                  <p><i class="bi bi-arrow-down-circle me-1"></i>本月支出</p>
              </div>
          </div>
          <div class="col-md-3">
              <div class="stat-card net">
                  <h3 id="netIncome">載入中...</h3>
                  <p><i class="bi bi-calculator me-1"></i>淨收入</p>
              </div>
          </div>
          <div class="col-md-3">
              <div class="stat-card balance">
                  <h3 id="accountBalance">載入中...</h3>
                  <p><i class="bi bi-wallet2 me-1"></i>帳戶餘額</p>
              </div>
          </div>
      </div>

      <!-- 篩選和搜尋區域 -->
      <div class="filter-section">
          <div class="row g-3">
              <div class="col-md-2">
                  <select class="form-select form-select-sm" id="transactionTypeFilter" onchange="filterTransactions()">
                      <option value="">全部類型</option>
                      <option value="收入">收入</option>
                      <option value="支出">支出</option>
                  </select>
              </div>
              <div class="col-md-2">
                  <select class="form-select form-select-sm" id="transactionCategoryFilter" onchange="filterTransactions()">
                      <option value="">全部類別</option>
                  </select>
              </div>
              <div class="col-md-2">
                  <select class="form-select form-select-sm" id="accountFilter" onchange="filterTransactions()">
                      <option value="">全部帳戶</option>
                  </select>
              </div>
              <div class="col-md-2">
                  <input type="month" class="form-control form-control-sm" id="monthFilter" onchange="filterTransactions()">
              </div>
              <div class="col-md-3">
                  <input type="text" class="form-control form-control-sm" id="searchTransaction" placeholder="搜尋交易..." onkeyup="filterTransactions()">
              </div>
              <div class="col-md-1">
                  <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()">
                      <i class="bi bi-x-circle"></i>
                  </button>
              </div>
          </div>
      </div>

      <!-- 交易表單 -->
      <div id="transactionForm" style="display: none;">
          <div class="card border-primary mb-4">
              <div class="card-header bg-primary text-white">
                  <h6 class="mb-0">
                      <i class="bi bi-plus-circle me-2"></i>
                      <span id="formTitle">新增交易</span>
                  </h6>
              </div>
              <div class="card-body">
                  <form id="newTransactionForm">
                      <input type="hidden" id="editTransactionId">
                      <div class="row g-3">
                          <div class="col-md-6">
                              <div class="form-floating">
                                  <input type="date" class="form-control" id="transactionDate" required>
                                  <label>交易日期 *</label>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="form-floating">
                                  <select class="form-select" id="transactionType" required onchange="updateCategoryOptions()">
                                      <option value="">請選擇</option>
                                      <option value="收入">收入</option>
                                      <option value="支出">支出</option>
                                  </select>
                                  <label>交易類型 *</label>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="form-floating">
                                  <select class="form-select" id="transactionCategory" required>
                                      <option value="">請先選擇類型</option>
                                  </select>
                                  <label>交易類別 *</label>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="form-floating">
                                  <input type="number" class="form-control" id="transactionAmount" required min="1" step="0.01">
                                  <label>交易金額 *</label>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="form-floating">
                                  <input type="text" class="form-control" id="transactionTarget">
                                  <label>交易對象</label>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="form-floating">
                                  <select class="form-select" id="transactionAccount" required>
                                      <option value="">請選擇</option>
                                      <option value="現金">現金</option>
                                      <option value="銀行-主帳戶">銀行-主帳戶</option>
                                      <option value="銀行-專案帳戶">銀行-專案帳戶</option>
                                      <option value="電子支付">電子支付</option>
                                      <option value="信用卡">信用卡</option>
                                  </select>
                                  <label>帳戶類型 *</label>
                              </div>
                          </div>
                          <div class="col-12">
                              <div class="form-floating">
                                  <textarea class="form-control" id="transactionDescription" style="height: 80px;"></textarea>
                                  <label>交易說明</label>
                              </div>
                          </div>
                          <div class="col-12">
                              <label class="form-label">上傳憑證（選填）</label>
                              <input type="file" class="form-control" id="transactionReceipt" accept="image/*,application/pdf">
                              <div class="form-text">支援圖片和PDF格式，檔案大小不超過5MB</div>
                          </div>
                      </div>
                      <div class="mt-3">
                          <button type="submit" class="btn btn-primary me-2">
                              <i class="bi bi-check-circle me-1"></i>儲存交易
                          </button>
                          <button type="button" class="btn btn-secondary" onclick="hideTransactionForm()">
                              <i class="bi bi-x-circle me-1"></i>取消
                          </button>
                      </div>
                  </form>
              </div>
          </div>
      </div>

      <!-- 財務報表 -->
      <div id="financialReport" style="display: none;">
          <div class="card border-info mb-4">
              <div class="card-header bg-info text-white">
                  <h6 class="mb-0">
                      <i class="bi bi-bar-chart me-2"></i>財務報表分析
                  </h6>
              </div>
              <div class="card-body">
                  <div class="row mb-3">
                      <div class="col-md-4">
                          <select class="form-select" id="reportPeriod" onchange="updateFinancialReport()">
                              <option value="month">本月</option>
                              <option value="quarter">本季</option>
                              <option value="year">本年</option>
                              <option value="custom">自訂期間</option>
                          </select>
                      </div>
                      <div class="col-md-4" id="customDateRange" style="display: none;">
                          <input type="month" class="form-control" id="reportStartDate">
                      </div>
                      <div class="col-md-4" id="customDateRange2" style="display: none;">
                          <input type="month" class="form-control" id="reportEndDate">
                      </div>
                  </div>
                  <div class="row">
                      <div class="col-md-6">
                          <div class="chart-container">
                              <canvas id="incomeExpenseChart"></canvas>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="chart-container">
                              <canvas id="categoryChart"></canvas>
                          </div>
                      </div>
                  </div>
                  <div class="row">
                      <div class="col-md-6">
                          <div class="chart-container">
                              <canvas id="trendChart"></canvas>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="chart-container">
                              <canvas id="accountChart"></canvas>
                          </div>
                      </div>
                  </div>
                  <div class="mt-3">
                      <button type="button" class="btn btn-secondary me-2" onclick="hideFinancialReport()">
                          <i class="bi bi-x-circle me-1"></i>關閉報表
                      </button>
                      <button type="button" class="btn btn-success" onclick="exportChartData()">
                          <i class="bi bi-download me-1"></i>匯出圖表資料
                      </button>
                  </div>
              </div>
          </div>
      </div>

      <!-- 交易列表 -->
      <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>交易記錄</h5>
          <div class="d-flex align-items-center">
              <span class="text-muted me-3">共 <span id="totalTransactions">0</span> 筆記錄</span>
              <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-secondary" id="listViewBtn" onclick="setViewMode('list')">
                      <i class="bi bi-list"></i>
                  </button>
                  <button class="btn btn-outline-secondary active" id="tableViewBtn" onclick="setViewMode('table')">
                      <i class="bi bi-table"></i>
                  </button>
              </div>
          </div>
      </div>

      <!-- 表格檢視 -->
      <div id="tableView">
          <div class="table-container">
              <table class="table table-hover mb-0">
                  <thead class="table-light sticky-top">
                      <tr>
                          <th>日期</th>
                          <th>類型</th>
                          <th>類別</th>
                          <th>金額</th>
                          <th>對象</th>
                          <th>帳戶</th>
                          <th>說明</th>
                          <th>憑證</th>
                          <th>操作</th>
                      </tr>
                  </thead>
                  <tbody id="transactionList">
                      <tr><td colspan="9" class="text-center">載入中...</td></tr>
                  </tbody>
              </table>
          </div>
      </div>

      <!-- 卡片檢視 -->
      <div id="listView" style="display: none;">
          <div id="transactionCards">
              <div class="text-center">載入中...</div>
          </div>
      </div>

      <!-- 分頁控制 -->
      <nav aria-label="交易分頁" class="mt-4">
          <ul class="pagination justify-content-center" id="transactionPagination">
              <!-- 分頁按鈕將動態生成 -->
          </ul>
      </nav>
  </div>

  <!-- 憑證預覽模態框 -->
  <div class="modal fade" id="receiptModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">憑證預覽</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body text-center">
                  <img id="receiptImage" src="" class="img-fluid" alt="憑證圖片">
                  <iframe id="receiptPDF" src="" width="100%" height="500px" style="display: none;"></iframe>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-primary" onclick="downloadReceipt()">
                      <i class="bi bi-download me-1"></i>下載
                  </button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
              </div>
          </div>
      </div>
  </div>

  <!-- 確認刪除模態框 -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">確認刪除</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <p>確定要刪除這筆交易記錄嗎？</p>
                  <div id="deleteTransactionInfo"></div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                      <i class="bi bi-trash me-1"></i>確定刪除
                  </button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              </div>
          </div>
      </div>
  </div>

  <script>
      // === 全域變數 ===
      let userId = null;
      let isAdmin = false;
      let userRole = null;
      let userRoles = [];
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbx-wqvQ5Ko4rTPp8SQFAOx2ucRHFAnYNqskdWdY2wjlYwdlLXq9TCnV-TWEz29g9_ETzg/exec';

      // 交易類別配置
      const TRANSACTION_CATEGORIES = {
          '收入': [
              '會費收入', '捐款收入', '活動收入', '利息收入', 
              '補助收入', '販售收入', '投資收益', '其他收入'
          ],
          '支出': [
              '活動費用', '辦公費用', '交通費', '餐費', 
              '場地費', '設備費', '人事費', '水電費',
              '通訊費', '保險費', '稅務費用', '其他支出'
          ]
      };

      let currentPage = 1;
      const itemsPerPage = 20;
      let allTransactions = [];
      let filteredTransactions = [];
      let currentViewMode = 'table';
      let charts = {};

      // === LIFF 初始化 ===
      liff.init({ liffId: '1656516134-k8rMQwnQ' }).then(() => {
          if (!liff.isLoggedIn()) {
              liff.login();
              return;
          }
          
          // 顯示關閉按鈕（如果在 LINE 內開啟）
          if (liff.isInClient()) {
              document.getElementById('closeBtn').style.display = 'block';
          }
          
          liff.getProfile().then(profile => {
              userId = profile.userId;
              checkPermission();
          }).catch(err => {
              console.error('取得用戶資料失敗:', err);
              showError('無法取得用戶資料，請重新開啟頁面');
          });
      }).catch(err => {
          console.error('LIFF初始化失敗:', err);
          showError('系統初始化失敗，請重新開啟頁面');
      });

      // === 權限檢查 ===
      async function checkPermission() {
          try {
              const response = await fetch(`${GAS_URL}?action=getUserInfo&userId=${encodeURIComponent(userId)}`);
              
              if (!response.ok) {
                  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              
              const result = await response.json();
              
              if (!result.success) {
                  throw new Error(result.message || '權限驗證失敗');
              }
              
              // 支援多重角色
              try {
                  userRoles = JSON.parse(result.data.userInfo.用戶角色) || ['member'];
              } catch (e) {
                  userRoles = [result.data.userInfo.用戶角色 || 'member'];
              }
              
              userRole = getHighestRole(userRoles);
              
              if (!hasAnyRole(['admin', 'chairman', 'director', 'supervisor', 'treasurer'])) {
                  showError('您沒有財務管理權限');
                  setTimeout(() => {
                      if (liff.isInClient()) {
                          liff.closeWindow();
                      }
                  }, 2000);
                  return;
              }
              
              isAdmin = true;
              initFinanceModule();
          } catch (error) {
              console.error('權限驗證失敗:', error);
              showError(`權限驗證失敗：${error.message}`);
          }
      }

      // === 權限輔助函數 ===
      function hasRole(role) {
          return userRoles.includes(role);
      }
      
      function hasAnyRole(roles) {
          return roles.some(role => userRoles.includes(role));
      }
      
      function getHighestRole(roles) {
          const hierarchy = { 'admin': 5, 'chairman': 4, 'treasurer': 3, 'director': 2, 'supervisor': 2, 'member': 1 };
          let highest = 'member';
          let highestLevel = 0;
          
          roles.forEach(role => {
              const level = hierarchy[role] || 0;
              if (level > highestLevel) {
                  highestLevel = level;
                  highest = role;
              }
          });
          
          return highest;
      }

      // === 初始化財務模組 ===
      function initFinanceModule() {
          // 設定當前月份篩選器
          const currentMonth = new Date().toISOString().slice(0, 7);
          document.getElementById('monthFilter').value = currentMonth;
          
          // 載入資料
          loadFinanceStats();
          loadTransactionList();
      }

      // === 載入財務統計 ===
      async function loadFinanceStats() {
          try {
              const response = await fetch(`${GAS_URL}?action=getFinanceStats&userId=${encodeURIComponent(userId)}`);
              
              if (!response.ok) {
                  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              
              const result = await response.json();
              
              if (result.success) {
                  const stats = result.data;
                  document.getElementById('totalIncome').textContent = `$${(stats.本月收入 || 0).toLocaleString()}`;
                  document.getElementById('totalExpense').textContent = `$${(stats.本月支出 || 0).toLocaleString()}`;
                  document.getElementById('netIncome').textContent = `$${(stats.淨收入 || 0).toLocaleString()}`;
                  document.getElementById('accountBalance').textContent = `$${(stats.帳戶餘額 || 0).toLocaleString()}`;
              } else {
                  throw new Error(result.message || '載入財務統計失敗');
              }
          } catch (error) {
              console.error('載入財務統計失敗:', error);
              showError('載入財務統計失敗');
          }
      }

      // === 載入交易列表 ===
      async function loadTransactionList() {
          try {
              const response = await fetch(`${GAS_URL}?action=getTransactionList&userId=${encodeURIComponent(userId)}`);
              
              if (!response.ok) {
                  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              
              const result = await response.json();
              
              if (result.success) {
                  allTransactions = result.data || [];
                    filteredTransactions = [...allTransactions];
                    renderTransactionList();
                    updateFilterOptions();
                    document.getElementById('totalTransactions').textContent = allTransactions.length;
                } else {
                    throw new Error(result.message || '載入交易列表失敗');
                }
            } catch (error) {
                console.error('載入交易列表失敗:', error);
                document.getElementById('transactionList').innerHTML = 
                    '<tr><td colspan="9" class="text-center text-danger">載入交易列表失敗</td></tr>';
                document.getElementById('transactionCards').innerHTML = 
                    '<div class="text-center text-danger">載入交易列表失敗</div>';
            }
        }

        // === 渲染交易列表 ===
        function renderTransactionList() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);
            
            if (currentViewMode === 'table') {
                renderTableView(pageTransactions);
            } else {
                renderCardView(pageTransactions);
            }
            
            renderPagination();
        }

        // === 渲染表格檢視 ===
        function renderTableView(transactions) {
            if (transactions.length === 0) {
                document.getElementById('transactionList').innerHTML = 
                    '<tr><td colspan="9" class="text-center text-muted">暫無交易記錄</td></tr>';
                return;
            }
            
            document.getElementById('transactionList').innerHTML = transactions.map(t => `
                <tr class="${t.交易類型 === '收入' ? 'table-success' : 'table-danger'}">
                    <td>${formatDate(t.交易日期)}</td>
                    <td>
                        <span class="badge ${t.交易類型 === '收入' ? 'bg-success' : 'bg-danger'}">
                            ${t.交易類型}
                        </span>
                    </td>
                    <td>${t.交易類別}</td>
                    <td class="transaction-amount">$${t.交易金額.toLocaleString()}</td>
                    <td>${t.交易對象 || '-'}</td>
                    <td>${t.帳戶類型}</td>
                    <td>${truncateText(t.交易說明 || '-', 20)}</td>
                    <td>
                        ${t.憑證檔案 ? `
                            <img src="${t.憑證檔案}" class="receipt-thumbnail" 
                                 onclick="viewReceipt('${t.憑證檔案}', '${t.交易類別}')" 
                                 alt="憑證">
                        ` : '-'}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editTransaction('${t.交易ID}')" title="編輯">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="confirmDeleteTransaction('${t.交易ID}', '${t.交易類別}', ${t.交易金額})" title="刪除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // === 渲染卡片檢視 ===
        function renderCardView(transactions) {
            if (transactions.length === 0) {
                document.getElementById('transactionCards').innerHTML = 
                    '<div class="text-center text-muted">暫無交易記錄</div>';
                return;
            }
            
            document.getElementById('transactionCards').innerHTML = transactions.map(t => `
                <div class="transaction-card ${t.交易類型 === '收入' ? 'income' : 'expense'}">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">${t.交易類別}</h6>
                                    <small class="text-muted">${formatDate(t.交易日期)} | ${t.帳戶類型}</small>
                                </div>
                                <span class="badge ${t.交易類型 === '收入' ? 'bg-success' : 'bg-danger'} fs-6">
                                    $${t.交易金額.toLocaleString()}
                                </span>
                            </div>
                            <p class="mb-1"><strong>對象：</strong>${t.交易對象 || '無'}</p>
                            <p class="mb-0 text-muted small">${t.交易說明 || '無說明'}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            ${t.憑證檔案 ? `
                                <img src="${t.憑證檔案}" class="receipt-thumbnail mb-2" 
                                     onclick="viewReceipt('${t.憑證檔案}', '${t.交易類別}')" 
                                     alt="憑證">
                                <br>
                            ` : ''}
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editTransaction('${t.交易ID}')" title="編輯">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="confirmDeleteTransaction('${t.交易ID}', '${t.交易類別}', ${t.交易金額})" title="刪除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // === 渲染分頁 ===
        function renderPagination() {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            
            if (totalPages <= 1) {
                document.getElementById('transactionPagination').innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // 上一頁
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // 頁碼
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            // 下一頁
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;
            
            document.getElementById('transactionPagination').innerHTML = paginationHTML;
        }

        // === 切換頁面 ===
        function changePage(page) {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderTransactionList();
            
            // 滾動到頂部
            document.querySelector('.content-card').scrollIntoView({ behavior: 'smooth' });
        }

        // === 設定檢視模式 ===
        function setViewMode(mode) {
            currentViewMode = mode;
            
            // 更新按鈕狀態
            document.getElementById('listViewBtn').classList.toggle('active', mode === 'list');
            document.getElementById('tableViewBtn').classList.toggle('active', mode === 'table');
            
            // 切換檢視
            document.getElementById('tableView').style.display = mode === 'table' ? 'block' : 'none';
            document.getElementById('listView').style.display = mode === 'list' ? 'block' : 'none';
            
            renderTransactionList();
        }

        // === 篩選交易 ===
        function filterTransactions() {
            const typeFilter = document.getElementById('transactionTypeFilter').value;
            const categoryFilter = document.getElementById('transactionCategoryFilter').value;
            const accountFilter = document.getElementById('accountFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const searchTerm = document.getElementById('searchTransaction').value.toLowerCase();
            
            filteredTransactions = allTransactions.filter(t => {
                const matchType = !typeFilter || t.交易類型 === typeFilter;
                const matchCategory = !categoryFilter || t.交易類別 === categoryFilter;
                const matchAccount = !accountFilter || t.帳戶類型 === accountFilter;
                const matchMonth = !monthFilter || t.交易日期.startsWith(monthFilter);
                const matchSearch = !searchTerm || 
                    t.交易說明?.toLowerCase().includes(searchTerm) ||
                    t.交易對象?.toLowerCase().includes(searchTerm) ||
                    t.交易類別.toLowerCase().includes(searchTerm);
                
                return matchType && matchCategory && matchAccount && matchMonth && matchSearch;
            });
            
            currentPage = 1;
            renderTransactionList();
            document.getElementById('totalTransactions').textContent = filteredTransactions.length;
        }

        // === 清除篩選 ===
        function clearFilters() {
            document.getElementById('transactionTypeFilter').value = '';
            document.getElementById('transactionCategoryFilter').value = '';
            document.getElementById('accountFilter').value = '';
            document.getElementById('monthFilter').value = '';
            document.getElementById('searchTransaction').value = '';
            filterTransactions();
        }

        // === 更新篩選選項 ===
        function updateFilterOptions() {
            // 更新類別篩選
            const categories = [...new Set(allTransactions.map(t => t.交易類別))];
            const categoryFilter = document.getElementById('transactionCategoryFilter');
            categoryFilter.innerHTML = '<option value="">全部類別</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            // 更新帳戶篩選
            const accounts = [...new Set(allTransactions.map(t => t.帳戶類型))];
            const accountFilter = document.getElementById('accountFilter');
            accountFilter.innerHTML = '<option value="">全部帳戶</option>' +
                accounts.map(acc => `<option value="${acc}">${acc}</option>`).join('');
        }

        // === 顯示交易表單 ===
        function showTransactionForm() {
            document.getElementById('transactionForm').style.display = 'block';
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('financialReport').style.display = 'none';
            document.getElementById('formTitle').textContent = '新增交易';
            document.getElementById('editTransactionId').value = '';
            
            // 滾動到表單
            document.getElementById('transactionForm').scrollIntoView({ behavior: 'smooth' });
        }

        // === 隱藏交易表單 ===
        function hideTransactionForm() {
            document.getElementById('transactionForm').style.display = 'none';
            document.getElementById('newTransactionForm').reset();
        }

        // === 更新類別選項 ===
        function updateCategoryOptions() {
            const type = document.getElementById('transactionType').value;
            const categorySelect = document.getElementById('transactionCategory');
            
            if (!type) {
                categorySelect.innerHTML = '<option value="">請先選擇類型</option>';
                return;
            }
            
            const categories = TRANSACTION_CATEGORIES[type] || [];
            categorySelect.innerHTML = categories.map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');
        }

        // === 提交交易表單 ===
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('newTransactionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const editId = document.getElementById('editTransactionId').value;
                const isEdit = !!editId;
                
                const formData = new FormData();
                formData.append('action', isEdit ? 'updateTransaction' : 'addTransaction');
                formData.append('userId', userId);
                
                if (isEdit) {
                    formData.append('transactionId', editId);
                }
                
                formData.append('transactionDate', document.getElementById('transactionDate').value);
                formData.append('transactionType', document.getElementById('transactionType').value);
                formData.append('transactionCategory', document.getElementById('transactionCategory').value);
                formData.append('transactionAmount', document.getElementById('transactionAmount').value);
                formData.append('transactionTarget', document.getElementById('transactionTarget').value);
                formData.append('transactionAccount', document.getElementById('transactionAccount').value);
                formData.append('transactionDescription', document.getElementById('transactionDescription').value);
                
                const receiptFile = document.getElementById('transactionReceipt').files[0];
                if (receiptFile) {
                    formData.append('receiptFile', receiptFile);
                }
                
                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showSuccess(isEdit ? '交易記錄已更新' : '交易記錄已新增');
                        hideTransactionForm();
                        loadTransactionList();
                        loadFinanceStats();
                    } else {
                        throw new Error(result.message || (isEdit ? '更新交易失敗' : '新增交易失敗'));
                    }
                } catch (error) {
                    console.error('提交交易失敗:', error);
                    showError(`${isEdit ? '更新' : '新增'}交易失敗：${error.message}`);
                }
            });
        });

        // === 編輯交易 ===
        async function editTransaction(transactionId) {
            const transaction = allTransactions.find(t => t.交易ID === transactionId);
            if (!transaction) {
                showError('找不到交易記錄');
                return;
            }
            
            // 填入表單
            document.getElementById('editTransactionId').value = transactionId;
            document.getElementById('transactionDate').value = transaction.交易日期;
            document.getElementById('transactionType').value = transaction.交易類型;
            updateCategoryOptions();
            document.getElementById('transactionCategory').value = transaction.交易類別;
            document.getElementById('transactionAmount').value = transaction.交易金額;
            document.getElementById('transactionTarget').value = transaction.交易對象 || '';
            document.getElementById('transactionAccount').value = transaction.帳戶類型;
            document.getElementById('transactionDescription').value = transaction.交易說明 || '';
            
            // 顯示表單
            document.getElementById('formTitle').textContent = '編輯交易';
            showTransactionForm();
        }

        // === 確認刪除交易 ===
        function confirmDeleteTransaction(transactionId, category, amount) {
            document.getElementById('deleteTransactionInfo').innerHTML = `
                <div class="alert alert-warning">
                    <strong>類別：</strong>${category}<br>
                    <strong>金額：</strong>$${amount.toLocaleString()}
                </div>
            `;
            
            document.getElementById('confirmDeleteBtn').onclick = () => deleteTransaction(transactionId);
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        // === 刪除交易 ===
        async function deleteTransaction(transactionId) {
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'deleteTransaction',
                        transactionId: transactionId,
                        userId: userId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('交易記錄已刪除');
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                    loadTransactionList();
                    loadFinanceStats();
                } else {
                    throw new Error(result.message || '刪除交易失敗');
                }
            } catch (error) {
                console.error('刪除交易失敗:', error);
                showError(`刪除交易失敗：${error.message}`);
            }
        }

        // === 查看憑證 ===
        function viewReceipt(receiptUrl, title) {
            const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
            document.querySelector('#receiptModal .modal-title').textContent = `${title} - 憑證預覽`;
            
            if (receiptUrl.toLowerCase().includes('.pdf')) {
                document.getElementById('receiptImage').style.display = 'none';
                document.getElementById('receiptPDF').style.display = 'block';
                document.getElementById('receiptPDF').src = receiptUrl;
            } else {
                document.getElementById('receiptPDF').style.display = 'none';
                document.getElementById('receiptImage').style.display = 'block';
                document.getElementById('receiptImage').src = receiptUrl;
            }
            
            window.currentReceiptUrl = receiptUrl;
            modal.show();
        }

        // === 下載憑證 ===
        function downloadReceipt() {
            if (window.currentReceiptUrl) {
                const link = document.createElement('a');
                link.href = window.currentReceiptUrl;
                link.download = `憑證_${new Date().getTime()}`;
                link.click();
            }
        }

        // === 顯示財務報表 ===
        function showFinancialReport() {
            document.getElementById('financialReport').style.display = 'block';
            document.getElementById('transactionForm').style.display = 'none';
            generateFinancialCharts();
            
            // 滾動到報表
            document.getElementById('financialReport').scrollIntoView({ behavior: 'smooth' });
        }

        // === 隱藏財務報表 ===
        function hideFinancialReport() {
            document.getElementById('financialReport').style.display = 'none';
            
            // 銷毀圖表
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
        }

        // === 生成財務圖表 ===
        function generateFinancialCharts() {
            // 銷毀現有圖表
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            const period = document.getElementById('reportPeriod').value;
            const reportData = getReportData(period);
            
            // 收支對比圖
            const ctx1 = document.getElementById('incomeExpenseChart').getContext('2d');
            charts.incomeExpense = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: reportData.months,
                    datasets: [{
                        label: '收入',
                        data: reportData.incomeData,
                        backgroundColor: 'rgba(40, 167, 69, 0.8)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    }, {
                        label: '支出',
                        data: reportData.expenseData,
                        backgroundColor: 'rgba(220, 53, 69, 0.8)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '收支對比圖'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // 類別分析圖
            const ctx2 = document.getElementById('categoryChart').getContext('2d');
            charts.category = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: reportData.categories,
                    datasets: [{
                        data: reportData.categoryData,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '支出類別分析'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // 趨勢圖
            const ctx3 = document.getElementById('trendChart').getContext('2d');
            charts.trend = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: reportData.months,
                    datasets: [{
                        label: '淨收入',
                        data: reportData.netIncomeData,
                        borderColor: 'rgba(23, 162, 184, 1)',
                        backgroundColor: 'rgba(23, 162, 184, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '淨收入趨勢'
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // 帳戶分析圖
            const ctx4 = document.getElementById('accountChart').getContext('2d');
            charts.account = new Chart(ctx4, {
                type: 'pie',
                data: {
                    labels: reportData.accounts,
                    datasets: [{
                        data: reportData.accountData,
                        backgroundColor: [
                            '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '帳戶使用分析'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // === 獲取報表資料 ===
        function getReportData(period) {
            const now = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    endDate = new Date(now.getFullYear(), quarter * 3 + 3, 0);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    break;
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth() - 5, 1);
                    endDate = now;
            }
            
            // 篩選期間內的交易
            const periodTransactions = allTransactions.filter(t => {
                const transactionDate = new Date(t.交易日期);
                return transactionDate >= startDate && transactionDate <= endDate;
            });
            
            // 生成月份標籤
            const months = [];
            const incomeData = [];
            const expenseData = [];
            const netIncomeData = [];
            
            for (let d = new Date(startDate); d <= endDate; d.setMonth(d.getMonth() + 1)) {
                const monthStr = d.toISOString().slice(0, 7);
                months.push(monthStr);
                
                const monthTransactions = periodTransactions.filter(t => t.交易日期.startsWith(monthStr));
                const income = monthTransactions.filter(t => t.交易類型 === '收入').reduce((sum, t) => sum + t.交易金額, 0);
                const expense = monthTransactions.filter(t => t.交易類型 === '支出').reduce((sum, t) => sum + t.交易金額, 0);
                
                incomeData.push(income);
                expenseData.push(expense);
                netIncomeData.push(income - expense);
            }
            
            // 類別分析
            const categoryMap = {};
            const accountMap = {};
            
            periodTransactions.forEach(t => {
                if (t.交易類型 === '支出') {
                    categoryMap[t.交易類別] = (categoryMap[t.交易類別] || 0) + t.交易金額;
                }
                accountMap[t.帳戶類型] = (accountMap[t.帳戶類型] || 0) + t.交易金額;
            });
            
            return {
                months: months.map(m => m.slice(5)),
                incomeData,
                expenseData,
                netIncomeData,
                categories: Object.keys(categoryMap),
                categoryData: Object.values(categoryMap),
                accounts: Object.keys(accountMap),
                accountData: Object.values(accountMap)
            };
        }

        // === 更新財務報表 ===
        function updateFinancialReport() {
            const period = document.getElementById('reportPeriod').value;
            
            if (period === 'custom') {
                document.getElementById('customDateRange').style.display = 'block';
                document.getElementById('customDateRange2').style.display = 'block';
            } else {
                document.getElementById('customDateRange').style.display = 'none';
                document.getElementById('customDateRange2').style.display = 'none';
                generateFinancialCharts();
            }
        }

        // === 匯出財務資料 ===
        function exportFinancialData() {
            const csvContent = generateCSV(filteredTransactions);
            downloadCSV(csvContent, `財務資料_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // === 匯出圖表資料 ===
        function exportChartData() {
            const period = document.getElementById('reportPeriod').value;
            const reportData = getReportData(period);
            
            let csvContent = '月份,收入,支出,淨收入\n';
            reportData.months.forEach((month, index) => {
                csvContent += `${month},${reportData.incomeData[index]},${reportData.expenseData[index]},${reportData.netIncomeData[index]}\n`;
            });
            
            downloadCSV(csvContent, `財務報表_${period}_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // === 生成 CSV ===
        function generateCSV(data) {
            const headers = ['日期', '類型', '類別', '金額', '對象', '帳戶', '說明'];
            const csvRows = [headers.join(',')];
            
            data.forEach(t => {
                const row = [
                    t.交易日期,
                    t.交易類型,
                    t.交易類別,
                    t.交易金額,
                    t.交易對象 || '',
                    t.帳戶類型,
                    (t.交易說明 || '').replace(/,/g, '，')
                ];
                csvRows.push(row.map(field => `"${field}"`).join(','));
            });
            
            return '\FEFF' + csvRows.join('\n'); // 加入 BOM 支援中文
        }

        // === 下載 CSV ===
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }

        // === 重新整理財務資料 ===
        function refreshFinance() {
            loadTransactionList();
            loadFinanceStats();
            showSuccess('資料已重新整理');
        }

        // === 輔助函數 ===
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // === 訊息顯示函數 ===
        function showError(message) {
            const alert = document.getElementById('errorAlert');
            document.getElementById('errorMessage').textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
            
            // 滾動到頂部
            alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            document.getElementById('successMessage').textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
            
            // 滾動到頂部
            alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // === 鍵盤快捷鍵 ===
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + N: 新增交易
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                showTransactionForm();
            }
            
            // Ctrl/Cmd + R: 重新整理
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                refreshFinance();
            }
            
            // Ctrl/Cmd + E: 匯出資料
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                exportFinancialData();
            }
            
            // ESC: 關閉表單/報表
            if (e.key === 'Escape') {
                hideTransactionForm();
                hideFinancialReport();
            }
        });

        // === 響應式處理 ===
        window.addEventListener('resize', function() {
            // 重新調整圖表大小
            Object.values(charts).forEach(chart => {
                if (chart) {
                    chart.resize();
                }
            });
        });

        // === 頁面載入完成後的初始化 ===
        document.addEventListener('DOMContentLoaded', function() {
            // 設定檔案上傳限制
            const fileInput = document.getElementById('transactionReceipt');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // 檢查檔案大小（5MB限制）
                        if (file.size > 5 * 1024 * 1024) {
                            showError('檔案大小不能超過5MB');
                            e.target.value = '';
                            return;
                        }
                        
                        // 檢查檔案類型
                        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'];
                        if (!allowedTypes.includes(file.type)) {
                            showError('只支援圖片檔案（JPG、PNG、GIF）和PDF檔案');
                            e.target.value = '';
                            return;
                        }
                    }
                });
            }
            
            // 設定報表期間變更監聽
            const reportPeriod = document.getElementById('reportPeriod');
            if (reportPeriod) {
                reportPeriod.addEventListener('change', updateFinancialReport);
            }
            
            // 初始化工具提示
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // === 離開頁面前確認 ===
        window.addEventListener('beforeunload', function(e) {
            const form = document.getElementById('transactionForm');
            if (form && form.style.display !== 'none') {
                const formData = new FormData(document.getElementById('newTransactionForm'));
                let hasData = false;
                
                for (let [key, value] of formData.entries()) {
                    if (value && key !== 'userId') {
                        hasData = true;
                        break;
                    }
                }
                
                if (hasData) {
                    e.preventDefault();
                    e.returnValue = '您有未儲存的交易資料，確定要離開嗎？';
                    return e.returnValue;
                }
            }
        });

        // === 自動儲存草稿功能 ===
        let draftTimer;
        const formFields = ['transactionDate', 'transactionType', 'transactionCategory', 'transactionAmount', 'transactionTarget', 'transactionAccount', 'transactionDescription'];

        function initDraftSaving() {
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        clearTimeout(draftTimer);
                        draftTimer = setTimeout(saveDraft, 2000); // 2秒後自動儲存草稿
                    });
                }
            });
        }

        function saveDraft() {
            const draft = {};
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    draft[fieldId] = field.value;
                }
            });
            
            if (Object.values(draft).some(value => value)) {
                localStorage.setItem('transactionDraft', JSON.stringify(draft));
            }
        }

        function loadDraft() {
            const draft = localStorage.getItem('transactionDraft');
            if (draft) {
                try {
                    const draftData = JSON.parse(draft);
                    formFields.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field && draftData[fieldId]) {
                            field.value = draftData[fieldId];
                            if (fieldId === 'transactionType') {
                                updateCategoryOptions();
                            }
                        }
                    });
                    
                    showSuccess('已載入上次未完成的交易草稿');
                } catch (e) {
                    console.error('載入草稿失敗:', e);
                }
            }
        }

        function clearDraft() {
            localStorage.removeItem('transactionDraft');
        }

        // === PWA 支援 ===
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful');
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        // === 網路狀態監控 ===
        window.addEventListener('online', function() {
            showSuccess('網路連線已恢復');
            refreshFinance();
        });

        window.addEventListener('offline', function() {
            showError('網路連線中斷，部分功能可能無法使用');
        });

        // === 錯誤追蹤 ===
        window.addEventListener('error', function(e) {
            console.error('全域錯誤:', e.error);
            showError('系統發生錯誤，請重新整理頁面');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('未處理的Promise拒絕:', e.reason);
            showError('系統發生錯誤，請重新整理頁面');
        });

        // === 資料快取機制 ===
        let cacheTimestamp = 0;
        const CACHE_DURATION = 5 * 60 * 1000; // 5分鐘

        function isCacheValid() {
            return Date.now() - cacheTimestamp < CACHE_DURATION;
        }

        function updateCache() {
            cacheTimestamp = Date.now();
        }

        // // === 列印功能 ===
        // function printTransactionList() {
        //     const printWindow = window.open('', '_blank');
        //     const printContent = generatePrintContent();
            
        //     printWindow.document.write(`
        //         <!DOCTYPE html>
        //         <html>
        //         <head>
        //             <title>財務交易記錄</title>
        //             <style>
        //                 body { font-family: Arial, sans-serif; margin: 20px; }
        //                 table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        //                 th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        //                 th { background-color: #f2f2f2; }
        //                 .header { text-align: center; margin-bottom: 20px; }
        //                 .summary { margin-bottom: 20px; }
        //                 @media print { .no-print { display: none; } }
        //             </style>
        //         </head>
        //         <body>
        //             ${printContent}
        //             <script>window.print(); window.close();</script>
        //         </body>
        //         </html>
        //     `);
        // }

        function generatePrintContent() {
            const stats = {
                totalIncome: document.getElementById('totalIncome').textContent,
                totalExpense: document.getElementById('totalExpense').textContent,
                netIncome: document.getElementById('netIncome').textContent
            };
            
            let content = `
                <div class="header">
                    <h1>財務交易記錄</h1>
                    <p>列印時間：${new Date().toLocaleString('zh-TW')}</p>
                </div>
                
                <div class="summary">
                    <h3>財務摘要</h3>
                    <p>本月收入：${stats.totalIncome}</p>
                    <p>本月支出：${stats.totalExpense}</p>
                    <p>淨收入：${stats.netIncome}</p>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>類型</th>
                            <th>類別</th>
                            <th>金額</th>
                            <th>對象</th>
                            <th>帳戶</th>
                            <th>說明</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredTransactions.forEach(t => {
                content += `
                    <tr>
                        <td>${formatDate(t.交易日期)}</td>
                        <td>${t.交易類型}</td>
                        <td>${t.交易類別}</td>
                        <td>$${t.交易金額.toLocaleString()}</td>
                        <td>${t.交易對象 || '-'}</td>
                        <td>${t.帳戶類型}</td>
                        <td>${t.交易說明 || '-'}</td>
                    </tr>
                `;
            });
            
            content += `
                    </tbody>
                </table>
            `;
            
            return content;
        }

        // === 延遲初始化 ===
        setTimeout(() => {
            initDraftSaving();
        }, 1000);

    </script>
</body>
</html>

