<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>財務管理系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <style>
      :root {
          --primary-color: #2c3e50;
          --success-color: #27ae60;
          --danger-color: #e74c3c;
          --warning-color: #f39c12;
          --info-color: #3498db;
      }

      body {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .main-container {
          padding: 20px;
          max-width: 1400px;
          margin: 0 auto;
      }

      .header-section {
          background: rgba(255, 255, 255, 0.95);
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 20px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          backdrop-filter: blur(10px);
      }

      .stats-card {
          background: linear-gradient(135deg, var(--card-color), var(--card-color-light));
          border-radius: 15px;
          padding: 20px;
          color: white;
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
          transition: transform 0.3s ease, box-shadow 0.3s ease;
          border: none;
          position: relative;
          overflow: hidden;
      }

      .stats-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      }

      .stats-card::before {
          content: '';
          position: absolute;
          top: 0;
          right: 0;
          width: 100px;
          height: 100px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 50%;
          transform: translate(30px, -30px);
      }

      .stats-card.income {
          --card-color: #27ae60;
          --card-color-light: #2ecc71;
      }

      .stats-card.expense {
          --card-color: #e74c3c;
          --card-color-light: #c0392b;
      }

      .stats-card.net {
          --card-color: #3498db;
          --card-color-light: #2980b9;
      }

      .stats-card.balance {
          --card-color: #f39c12;
          --card-color-light: #e67e22;
      }

      .content-card {
          background: rgba(255, 255, 255, 0.95);
          border-radius: 15px;
          padding: 25px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          backdrop-filter: blur(10px);
          margin-bottom: 20px;
      }

      .btn-custom {
          border-radius: 25px;
          padding: 8px 20px;
          font-weight: 500;
          transition: all 0.3s ease;
          border: none;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .btn-custom:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .table-responsive {
          border-radius: 10px;
          overflow: hidden;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .table {
          margin-bottom: 0;
      }

      .table thead th {
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
          border: none;
          font-weight: 600;
          padding: 15px;
      }

      .table tbody tr:hover {
          background-color: rgba(102, 126, 234, 0.1);
          transform: scale(1.01);
          transition: all 0.2s ease;
      }

      .transaction-card {
          background: white;
          border-radius: 10px;
          padding: 15px;
          margin-bottom: 15px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
          transition: transform 0.2s ease;
          border-left: 4px solid;
      }

      .transaction-card.income {
          border-left-color: var(--success-color);
      }

      .transaction-card.expense {
          border-left-color: var(--danger-color);
      }

      .transaction-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .receipt-thumbnail {
          width: 40px;
          height: 40px;
          object-fit: cover;
          border-radius: 5px;
          cursor: pointer;
          transition: transform 0.2s ease;
      }

      .receipt-thumbnail:hover {
          transform: scale(1.1);
      }

      .form-control, .form-select {
          border-radius: 10px;
          border: 2px solid #e9ecef;
          transition: all 0.3s ease;
      }

      .form-control:focus, .form-select:focus {
          border-color: #667eea;
          box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }

      .alert {
          border-radius: 10px;
          border: none;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .modal-content {
          border-radius: 15px;
          border: none;
          box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      }

      .modal-header {
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
          border-radius: 15px 15px 0 0;
      }

      .pagination .page-link {
          border-radius: 20px;
          margin: 0 2px;
          border: none;
          color: #667eea;
      }

      .pagination .page-item.active .page-link {
          background: linear-gradient(135deg, #667eea, #764ba2);
          border: none;
      }

      .loading-spinner {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid rgba(255, 255, 255, 0.3);
          border-radius: 50%;
          border-top-color: #fff;
          animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
          to { transform: rotate(360deg); }
      }

      .error-state {
          text-align: center;
          padding: 40px;
          color: #6c757d;
      }

      .error-state i {
          font-size: 3rem;
          margin-bottom: 15px;
          color: #dc3545;
      }

      @media (max-width: 768px) {
          .main-container {
              padding: 10px;
          }
          
          .header-section {
              padding: 15px;
          }
          
          .content-card {
              padding: 15px;
          }
          
          .stats-card {
              margin-bottom: 15px;
          }
      }
  </style>
</head>
<body>
  <div class="main-container">
      <!-- 錯誤提示 -->
      <div id="errorAlert" class="alert alert-danger alert-dismissible fade show" style="display: none;">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <span id="errorMessage"></span>
          <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'"></button>
      </div>

      <!-- 成功提示 -->
      <div id="successAlert" class="alert alert-success alert-dismissible fade show" style="display: none;">
          <i class="bi bi-check-circle-fill me-2"></i>
          <span id="successMessage"></span>
          <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'"></button>
      </div>

      <!-- 標題區域 -->
      <div class="header-section">
          <div class="d-flex justify-content-between align-items-center flex-wrap">
              <div>
                  <h1 class="mb-0"><i class="bi bi-check-circle text-success me-2"></i>財務概覽</h1>
                  <p class="text-muted mb-0 mt-1">管理您的收支記錄</p>
              </div>
              <div class="btn-group flex-wrap">
                  <button class="btn btn-success btn-custom" onclick="showTransactionForm()">
                      <i class="bi bi-plus-circle me-1"></i>新增交易
                  </button>
                  <button class="btn btn-info btn-custom" onclick="showFinancialReport()">
                      <i class="bi bi-bar-chart me-1"></i>財務報表
                  </button>
                  <button class="btn btn-warning btn-custom" onclick="exportFinancialData()">
                      <i class="bi bi-download me-1"></i>匯出資料
                  </button>
                  <button class="btn btn-primary btn-custom" onclick="refreshFinance()">
                      <i class="bi bi-arrow-clockwise me-1"></i>重新整理
                  </button>
              </div>
          </div>
      </div>

      <!-- 統計卡片 -->
      <div class="row mb-4">
          <div class="col-lg-3 col-md-6 mb-3">
              <div class="stats-card income">
                  <div class="d-flex justify-content-between align-items-center">
                      <div>
                          <h6 class="mb-1">本月收入</h6>
                          <h3 class="mb-0" id="totalIncome">$0</h3>
                      </div>
                      <i class="bi bi-arrow-up-circle fs-1 opacity-75"></i>
                  </div>
              </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
              <div class="stats-card expense">
                  <div class="d-flex justify-content-between align-items-center">
                      <div>
                          <h6 class="mb-1">本月支出</h6>
                          <h3 class="mb-0" id="totalExpense">$0</h3>
                      </div>
                      <i class="bi bi-arrow-down-circle fs-1 opacity-75"></i>
                  </div>
              </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
              <div class="stats-card net">
                  <div class="d-flex justify-content-between align-items-center">
                      <div>
                          <h6 class="mb-1">淨收入</h6>
                          <h3 class="mb-0" id="netIncome">$0</h3>
                      </div>
                      <i class="bi bi-graph-up fs-1 opacity-75"></i>
                  </div>
              </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
              <div class="stats-card balance">
                  <div class="d-flex justify-content-between align-items-center">
                      <div>
                          <h6 class="mb-1">帳戶餘額</h6>
                          <h3 class="mb-0" id="accountBalance">$0</h3>
                      </div>
                      <i class="bi bi-wallet2 fs-1 opacity-75"></i>
                  </div>
              </div>
          </div>
      </div>

      <!-- 交易記錄區域 -->
      <div class="content-card">
          <!-- 篩選區域 -->
          <div class="row mb-4">
              <div class="col-md-2">
                  <select class="form-select" id="transactionTypeFilter" onchange="filterTransactions()">
                      <option value="">全部類型</option>
                      <option value="收入">收入</option>
                      <option value="支出">支出</option>
                  </select>
              </div>
              <div class="col-md-2">
                  <select class="form-select" id="transactionCategoryFilter" onchange="filterTransactions()">
                      <option value="">全部類別</option>
                  </select>
              </div>
              <div class="col-md-2">
                  <select class="form-select" id="accountFilter" onchange="filterTransactions()">
                      <option value="">全部帳戶</option>
                  </select>
              </div>
              <div class="col-md-2">
                  <input type="month" class="form-control" id="monthFilter" onchange="filterTransactions()">
              </div>
              <div class="col-md-3">
                  <input type="text" class="form-control" id="searchTransaction" placeholder="搜尋交易..." onkeyup="filterTransactions()">
              </div>
              <div class="col-md-1">
                  <button class="btn btn-outline-secondary" onclick="clearFilters()" title="清除篩選">
                      <i class="bi bi-x-circle"></i>
                  </button>
              </div>
          </div>

          <!-- 工具列 -->
          <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                  <span class="text-muted">共 <span id="totalTransactions">0</span> 筆記錄</span>
              </div>
              <div class="btn-group">
                  <button class="btn btn-outline-primary btn-sm active" id="tableViewBtn" onclick="setViewMode('table')">
                      <i class="bi bi-table"></i>
                  </button>
                  <button class="btn btn-outline-primary btn-sm" id="listViewBtn" onclick="setViewMode('list')">
                      <i class="bi bi-list"></i>
                  </button>
              </div>
          </div>

          <!-- 表格檢視 -->
          <div id="tableView">
              <div class="table-responsive">
                  <table class="table table-hover">
                      <thead>
                          <tr>
                              <th>日期</th>
                              <th>類型</th>
                              <th>類別</th>
                              <th>金額</th>
                              <th>對象</th>
                              <th>帳戶</th>
                              <th>說明</th>
                              <th>憑證</th>
                              <th>操作</th>
                          </tr>
                      </thead>
                      <tbody id="transactionList">
                          <tr>
                              <td colspan="9" class="text-center">
                                  <div class="error-state">
                                      <i class="bi bi-inbox"></i>
                                      <p>暫無交易記錄</p>
                                      <button class="btn btn-primary btn-custom" onclick="showTransactionForm()">
                                          新增第一筆交易
                                      </button>
                                  </div>
                              </td>
                          </tr>
                      </tbody>
                  </table>
              </div>
          </div>

          <!-- 列表檢視 -->
          <div id="listView" style="display: none;">
              <div id="transactionCards">
                  <div class="error-state">
                      <i class="bi bi-inbox"></i>
                      <p>暫無交易記錄</p>
                      <button class="btn btn-primary btn-custom" onclick="showTransactionForm()">
                          新增第一筆交易
                      </button>
                  </div>
              </div>
          </div>

          <!-- 分頁 -->
          <nav aria-label="交易記錄分頁" class="mt-4">
              <ul class="pagination justify-content-center" id="transactionPagination">
              </ul>
          </nav>
      </div>

      <!-- 交易表單 -->
      <div id="transactionForm" class="content-card" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 id="formTitle">新增交易</h4>
              <button class="btn btn-outline-secondary" onclick="hideTransactionForm()">
                  <i class="bi bi-x-lg"></i>
              </button>
          </div>

          <form id="newTransactionForm">
              <input type="hidden" id="editTransactionId">
              <div class="row">
                  <div class="col-md-6 mb-3">
                      <label class="form-label">交易日期 *</label>
                      <input type="date" class="form-control" id="transactionDate" required>
                  </div>
                  <div class="col-md-6 mb-3">
                      <label class="form-label">交易類型 *</label>
                      <select class="form-select" id="transactionType" required onchange="updateCategoryOptions()">
                          <option value="">請選擇類型</option>
                          <option value="收入">收入</option>
                          <option value="支出">支出</option>
                      </select>
                  </div>
                  <div class="col-md-6 mb-3">
                      <label class="form-label">交易類別 *</label>
                      <select class="form-select" id="transactionCategory" required>
                          <option value="">請先選擇類型</option>
                      </select>
                  </div>
                  <div class="col-md-6 mb-3">
                      <label class="form-label">交易金額 *</label>
                      <input type="number" class="form-control" id="transactionAmount" min="0" step="0.01" required>
                  </div>
                  <div class="col-md-6 mb-3">
                      <label class="form-label">交易對象</label>
                      <input type="text" class="form-control" id="transactionTarget">
                  </div>
                  <div class="col-md-6 mb-3">
                      <label class="form-label">帳戶類型 *</label>
                      <select class="form-select" id="transactionAccount" required>
                          <option value="">請選擇帳戶</option>
                          <option value="現金">現金</option>
                          <option value="銀行帳戶">銀行帳戶</option>
                          <option value="信用卡">信用卡</option>
                          <option value="電子錢包">電子錢包</option>
                      </select>
                  </div>
                  <div class="col-12 mb-3">
                      <label class="form-label">交易說明</label>
                      <textarea class="form-control" id="transactionDescription" rows="3"></textarea>
                  </div>
                  <div class="col-12 mb-3">
                      <label class="form-label">憑證檔案</label>
                      <input type="file" class="form-control" id="transactionReceipt" accept="image/*,.pdf">
                      <div class="form-text">支援圖片和PDF檔案，檔案大小不超過5MB</div>
                  </div>
              </div>

              <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-success btn-custom">
                      <i class="bi bi-check-circle me-1"></i>儲存交易
                  </button>
                  <button type="button" class="btn btn-secondary btn-custom" onclick="hideTransactionForm()">
                      <i class="bi bi-x-circle me-1"></i>取消
                  </button>
              </div>
          </form>
      </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
      // === 全域變數 ===
      const GAS_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
      const userId = 'demo_user'; // 示例用戶ID
      
      let allTransactions = [];
      let filteredTransactions = [];
      let currentPage = 1;
      let itemsPerPage = 10;
      let currentViewMode = 'table';

      // 交易類別定義
      const TRANSACTION_CATEGORIES = {
          '收入': ['薪資', '獎金', '投資收益', '副業收入', '其他收入'],
          '支出': ['餐飲', '交通', '購物', '娛樂', '醫療', '教育', '房租', '水電', '保險', '其他支出']
      };

      // === 初始化 ===
      document.addEventListener('DOMContentLoaded', function() {
          console.log('頁面載入完成，開始初始化...');
          initializePage();
      });

      async function initializePage() {
          try {
              // 設定當前月份
              const now = new Date();
              document.getElementById('monthFilter').value = now.toISOString().slice(0, 7);
              
              // 載入示例資料
              loadSampleData();
              
              // 初始化事件監聽器
              initializeEventListeners();
              
              console.log('初始化完成');
          } catch (error) {
              console.error('初始化失敗:', error);
              showError('系統初始化失敗，請重新整理頁面');
          }
      }

      function loadSampleData() {
          // 載入示例交易資料
          allTransactions = [
              {
                  交易ID: '1',
                  交易日期: '2025-09-15',
                  交易類型: '收入',
                  交易類別: '薪資',
                  交易金額: 50000,
                  交易對象: '公司',
                  帳戶類型: '銀行帳戶',
                  交易說明: '九月份薪資',
                  憑證檔案: null
              },
              {
                  交易ID: '2',
                  交易日期: '2025-09-14',
                  交易類型: '支出',
                  交易類別: '餐飲',
                  交易金額: 150,
                  交易對象: '便利商店',
                  帳戶類型: '現金',
                  交易說明: '午餐',
                  憑證檔案: null
              },
              {
                  交易ID: '3',
                  交易日期: '2025-09-13',
                  交易類型: '支出',
                  交易類別: '交通',
                  交易金額: 200,
                  交易對象: '捷運公司',
                  帳戶類型: '電子錢包',
                  交易說明: '交通費',
                  憑證檔案: null
              }
          ];

          filteredTransactions = [...allTransactions];
          renderTransactionList();
          updateFilterOptions();
          loadFinanceStats();
          
          document.getElementById('totalTransactions').textContent = allTransactions.length;
      }

      function initializeEventListeners() {
          // 表單提交事件
          const form = document.getElementById('newTransactionForm');
          if (form) {
              form.addEventListener('submit', handleFormSubmit);
          }

          // 檔案上傳限制
          const fileInput = document.getElementById('transactionReceipt');
          if (fileInput) {
              fileInput.addEventListener('change', handleFileUpload);
          }
      }

      async function handleFormSubmit(e) {
          e.preventDefault();
          
          const editId = document.getElementById('editTransactionId').value;
          const isEdit = !!editId;
          
          try {
              const formData = {
                  交易ID: isEdit ? editId : Date.now().toString(),
                  交易日期: document.getElementById('transactionDate').value,
                  交易類型: document.getElementById('transactionType').value,
                  交易類別: document.getElementById('transactionCategory').value,
                  交易金額: parseFloat(document.getElementById('transactionAmount').value),
                  交易對象: document.getElementById('transactionTarget').value,
                  帳戶類型: document.getElementById('transactionAccount').value,
                  交易說明: document.getElementById('transactionDescription').value,
                  憑證檔案: null // 簡化處理
              };

              if (isEdit) {
                  // 更新現有交易
                  const index = allTransactions.findIndex(t => t.交易ID === editId);
                  if (index !== -1) {
                      allTransactions[index] = formData;
                  }
              } else {
                  // 新增交易
                  allTransactions.push(formData);
              }

              showSuccess(isEdit ? '交易記錄已更新' : '交易記錄已新增');
              hideTransactionForm();
              
              // 重新載入資料
              filteredTransactions = [...allTransactions];
              renderTransactionList();
              updateFilterOptions();
              loadFinanceStats();
              document.getElementById('totalTransactions').textContent = allTransactions.length;
              
          } catch (error) {
              console.error('提交交易失敗:', error);
              showError(`${isEdit ? '更新' : '新增'}交易失敗：${error.message}`);
          }
      }

      function handleFileUpload(e) {
          const file = e.target.files[0];
          if (file) {
              // 檢查檔案大小（5MB限制）
              if (file.size > 5 * 1024 * 1024) {
                  showError('檔案大小不能超過5MB');
                  e.target.value = '';
                  return;
              }
              
              // 檢查檔案類型
              const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'];
              if (!allowedTypes.includes(file.type)) {
                  showError('只支援圖片檔案（JPG、PNG、GIF）和PDF檔案');
                  e.target.value = '';
                  return;
              }
          }
      }

      // === 載入財務統計 ===
      function loadFinanceStats() {
          const now = new Date();
          const currentMonth = now.toISOString().slice(0, 7);
          
          const monthTransactions = allTransactions.filter(t => 
              t.交易日期.startsWith(currentMonth)
          );
          
          const totalIncome = monthTransactions
              .filter(t => t.交易類型 === '收入')
              .reduce((sum, t) => sum + t.交易金額, 0);
              
          const totalExpense = monthTransactions
              .filter(t => t.交易類型 === '支出')
              .reduce((sum, t) => sum + t.交易金額, 0);
              
          const netIncome = totalIncome - totalExpense;
          
          // 更新顯示
          document.getElementById('totalIncome').textContent = `$${totalIncome.toLocaleString()}`;
          document.getElementById('totalExpense').textContent = `$${totalExpense.toLocaleString()}`;
          document.getElementById('netIncome').textContent = `$${netIncome.toLocaleString()}`;
          document.getElementById('accountBalance').textContent = `$${netIncome.toLocaleString()}`;
      }

        // === 渲染交易列表 ===
        function renderTransactionList() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);
            
            if (currentViewMode === 'table') {
                renderTableView(pageTransactions);
            } else {
                renderListView(pageTransactions);
            }
            
            renderPagination();
        }

        function renderTableView(transactions) {
            const tbody = document.getElementById('transactionList');
            
            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center">
                            <div class="error-state">
                                <i class="bi bi-inbox"></i>
                                <p>暫無交易記錄</p>
                                <button class="btn btn-primary btn-custom" onclick="showTransactionForm()">
                                    新增第一筆交易
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = transactions.map(transaction => `
                <tr>
                    <td>${formatDate(transaction.交易日期)}</td>
                    <td>
                        <span class="badge ${transaction.交易類型 === '收入' ? 'bg-success' : 'bg-danger'}">
                            ${transaction.交易類型}
                        </span>
                    </td>
                    <td>${transaction.交易類別}</td>
                    <td class="fw-bold ${transaction.交易類型 === '收入' ? 'text-success' : 'text-danger'}">
                        $${transaction.交易金額.toLocaleString()}
                    </td>
                    <td>${transaction.交易對象 || '-'}</td>
                    <td>${transaction.帳戶類型}</td>
                    <td>${truncateText(transaction.交易說明 || '', 30)}</td>
                    <td>
                        ${transaction.憑證檔案 ? 
                            `<img src="${transaction.憑證檔案}" class="receipt-thumbnail" onclick="viewReceipt('${transaction.憑證檔案}')">` : 
                            '-'
                        }
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editTransaction('${transaction.交易ID}')" title="編輯">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteTransaction('${transaction.交易ID}')" title="刪除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderListView(transactions) {
            const container = document.getElementById('transactionCards');
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <div class="error-state">
                        <i class="bi bi-inbox"></i>
                        <p>暫無交易記錄</p>
                        <button class="btn btn-primary btn-custom" onclick="showTransactionForm()">
                            新增第一筆交易
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = transactions.map(transaction => `
                <div class="transaction-card ${transaction.交易類型.toLowerCase()}">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <small class="text-muted">${formatDate(transaction.交易日期)}</small>
                        </div>
                        <div class="col-md-2">
                            <span class="badge ${transaction.交易類型 === '收入' ? 'bg-success' : 'bg-danger'}">
                                ${transaction.交易類型}
                            </span>
                        </div>
                        <div class="col-md-2">
                            <strong>${transaction.交易類別}</strong>
                        </div>
                        <div class="col-md-2">
                            <span class="fw-bold ${transaction.交易類型 === '收入' ? 'text-success' : 'text-danger'}">
                                $${transaction.交易金額.toLocaleString()}
                            </span>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">${transaction.交易對象 || '-'}</small>
                        </div>
                        <div class="col-md-2">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editTransaction('${transaction.交易ID}')" title="編輯">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteTransaction('${transaction.交易ID}')" title="刪除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    ${transaction.交易說明 ? `<div class="mt-2"><small class="text-muted">${transaction.交易說明}</small></div>` : ''}
                </div>
            `).join('');
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            const pagination = document.getElementById('transactionPagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // 上一頁
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // 頁碼
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            // 下一頁
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;
            
            pagination.innerHTML = paginationHTML;
        }

        // === 表單操作 ===
        function showTransactionForm() {
            document.getElementById('transactionForm').style.display = 'block';
            document.getElementById('formTitle').textContent = '新增交易';
            document.getElementById('newTransactionForm').reset();
            document.getElementById('editTransactionId').value = '';
            
            // 設定預設日期為今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
            
            // 滾動到表單
            document.getElementById('transactionForm').scrollIntoView({ behavior: 'smooth' });
        }

        function hideTransactionForm() {
            document.getElementById('transactionForm').style.display = 'none';
        }

        function editTransaction(transactionId) {
            const transaction = allTransactions.find(t => t.交易ID === transactionId);
            if (!transaction) {
                showError('找不到指定的交易記錄');
                return;
            }
            
            // 填入表單
            document.getElementById('editTransactionId').value = transaction.交易ID;
            document.getElementById('transactionDate').value = transaction.交易日期;
            document.getElementById('transactionType').value = transaction.交易類型;
            document.getElementById('transactionAmount').value = transaction.交易金額;
            document.getElementById('transactionTarget').value = transaction.交易對象 || '';
            document.getElementById('transactionAccount').value = transaction.帳戶類型;
            document.getElementById('transactionDescription').value = transaction.交易說明 || '';
            
            // 更新類別選項
            updateCategoryOptions();
            document.getElementById('transactionCategory').value = transaction.交易類別;
            
            // 顯示表單
            document.getElementById('formTitle').textContent = '編輯交易';
            document.getElementById('transactionForm').style.display = 'block';
            document.getElementById('transactionForm').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteTransaction(transactionId) {
            if (!confirm('確定要刪除這筆交易記錄嗎？')) {
                return;
            }
            
            const index = allTransactions.findIndex(t => t.交易ID === transactionId);
            if (index !== -1) {
                allTransactions.splice(index, 1);
                filteredTransactions = [...allTransactions];
                renderTransactionList();
                updateFilterOptions();
                loadFinanceStats();
                document.getElementById('totalTransactions').textContent = allTransactions.length;
                showSuccess('交易記錄已刪除');
            }
        }

        function updateCategoryOptions() {
            const typeSelect = document.getElementById('transactionType');
            const categorySelect = document.getElementById('transactionCategory');
            
            const selectedType = typeSelect.value;
            categorySelect.innerHTML = '<option value="">請選擇類別</option>';
            
            if (selectedType && TRANSACTION_CATEGORIES[selectedType]) {
                TRANSACTION_CATEGORIES[selectedType].forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }
        }

        // === 篩選功能 ===
        function filterTransactions() {
            const typeFilter = document.getElementById('transactionTypeFilter').value;
            const categoryFilter = document.getElementById('transactionCategoryFilter').value;
            const accountFilter = document.getElementById('accountFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const searchFilter = document.getElementById('searchTransaction').value.toLowerCase();
            
            filteredTransactions = allTransactions.filter(transaction => {
                const matchType = !typeFilter || transaction.交易類型 === typeFilter;
                const matchCategory = !categoryFilter || transaction.交易類別 === categoryFilter;
                const matchAccount = !accountFilter || transaction.帳戶類型 === accountFilter;
                const matchMonth = !monthFilter || transaction.交易日期.startsWith(monthFilter);
                const matchSearch = !searchFilter || 
                    transaction.交易類別.toLowerCase().includes(searchFilter) ||
                    transaction.交易對象?.toLowerCase().includes(searchFilter) ||
                    transaction.交易說明?.toLowerCase().includes(searchFilter);
                
                return matchType && matchCategory && matchAccount && matchMonth && matchSearch;
            });
            
            currentPage = 1;
            renderTransactionList();
            document.getElementById('totalTransactions').textContent = filteredTransactions.length;
        }

        function clearFilters() {
            document.getElementById('transactionTypeFilter').value = '';
            document.getElementById('transactionCategoryFilter').value = '';
            document.getElementById('accountFilter').value = '';
            document.getElementById('monthFilter').value = '';
            document.getElementById('searchTransaction').value = '';
            
            filteredTransactions = [...allTransactions];
            currentPage = 1;
            renderTransactionList();
            document.getElementById('totalTransactions').textContent = allTransactions.length;
        }

        function updateFilterOptions() {
            // 更新類別篩選選項
            const categoryFilter = document.getElementById('transactionCategoryFilter');
            const categories = [...new Set(allTransactions.map(t => t.交易類別))];
            categoryFilter.innerHTML = '<option value="">全部類別</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
            
            // 更新帳戶篩選選項
            const accountFilter = document.getElementById('accountFilter');
            const accounts = [...new Set(allTransactions.map(t => t.帳戶類型))];
            accountFilter.innerHTML = '<option value="">全部帳戶</option>';
            accounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account;
                option.textContent = account;
                accountFilter.appendChild(option);
            });
        }

        // === 檢視模式切換 ===
        function setViewMode(mode) {
            currentViewMode = mode;
            
            document.getElementById('tableViewBtn').classList.toggle('active', mode === 'table');
            document.getElementById('listViewBtn').classList.toggle('active', mode === 'list');
            
            document.getElementById('tableView').style.display = mode === 'table' ? 'block' : 'none';
            document.getElementById('listView').style.display = mode === 'list' ? 'block' : 'none';
            
            renderTransactionList();
        }

        // === 分頁功能 ===
        function changePage(page) {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderTransactionList();
        }

        // === 匯出功能 ===
        function exportFinancialData() {
            if (allTransactions.length === 0) {
                showError('沒有資料可以匯出');
                return;
            }
            
            const csvData = convertToCSV(allTransactions);
            const filename = `財務記錄_${new Date().toISOString().split('T')[0]}.csv`;
            downloadCSV(csvData, filename);
            showSuccess('資料匯出成功');
        }

        function convertToCSV(data) {
            const headers = ['日期', '類型', '類別', '金額', '對象', '帳戶', '說明'];
            const csvRows = [headers.join(',')];
            
            data.forEach(transaction => {
                const row = [
                    transaction.交易日期,
                    transaction.交易類型,
                    transaction.交易類別,
                    transaction.交易金額,
                    transaction.交易對象 || '',
                    transaction.帳戶類型,
                    `"${(transaction.交易說明 || '').replace(/"/g, '""')}"`
                ];
                csvRows.push(row.join(','));
            });
            
            return '\uFEFF' + csvRows.join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }

        // === 其他功能 ===
        function refreshFinance() {
            loadFinanceStats();
            renderTransactionList();
            updateFilterOptions();
            showSuccess('資料已重新整理');
        }

        function showFinancialReport() {
            showError('財務報表功能開發中');
        }

        function viewReceipt(receiptUrl) {
            window.open(receiptUrl, '_blank');
        }

        // === 輔助函數 ===
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            document.getElementById('errorMessage').textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
            
            alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            document.getElementById('successMessage').textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
            
            alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    </script>
</body>
</html>
