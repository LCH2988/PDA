<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>管理員專區</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
    body {
        font-family: 'Noto Sans TC', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    .admin-nav {
        background: white;
        border-radius: 15px;
        margin: 20px;
        padding: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .nav-pills .nav-link {
        border-radius: 10px;
        margin: 0 5px;
        font-weight: 600;
    }
    .nav-pills .nav-link.active {
        background: linear-gradient(135deg, #2c5aa0, #4a90e2);
    }
    .content-card {
        background: white;
        border-radius: 20px;
        margin: 20px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .stat-card {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
    }
    .stat-card h3 {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
    }
    .table-container {
        max-height: 400px;
        overflow-y: auto;
        border-radius: 10px;
        border: 1px solid #dee2e6;
    }
    .form-floating {
        margin-bottom: 15px;
    }
    .form-floating .form-control, .form-floating .form-select {
        border-radius: 10px;
    }
    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
    }
    .alert {
        border-radius: 15px;
        margin-bottom: 20px;
    }
</style>
</head>
<body>
<!-- 錯誤/成功訊息 -->
<div id="errorAlert" class="alert alert-danger mx-3" style="display: none;">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <span id="errorMessage"></span>
</div>

<div id="successAlert" class="alert alert-success mx-3" style="display: none;">
    <i class="bi bi-check-circle me-2"></i>
    <span id="successMessage"></span>
</div>

<!-- 導航選單 -->
<div class="admin-nav">
    <ul class="nav nav-pills justify-content-center" id="adminTabs">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="pill" href="#dashboard">
                <i class="bi bi-speedometer2 me-1"></i>儀表板
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="pill" href="#finance">
                <i class="bi bi-cash-coin me-1"></i>財務管理
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="pill" href="#members">
                <i class="bi bi-people me-1"></i>會員管理
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="pill" href="#activities">
                <i class="bi bi-calendar-event me-1"></i>活動管理
            </a>
        </li>
    </ul>
</div>

<!-- 內容區域 -->
<div class="tab-content">
    <!-- 儀表板 -->
    <div class="tab-pane fade show active" id="dashboard">
        <div class="content-card">
            <h4 class="mb-4"><i class="bi bi-speedometer2 me-2"></i>系統概覽</h4>
            <div class="row" id="dashboardStats">
                <div class="col-12 text-center">
                    <div class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">載入中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 財務管理 -->
    <div class="tab-pane fade" id="finance">
        <div class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4><i class="bi bi-cash-coin me-2"></i>財務管理</h4>
                <button class="btn btn-success btn-sm" onclick="showTransactionForm()">
                    <i class="bi bi-plus-circle me-1"></i>新增交易
                </button>
            </div>
            
            <!-- 交易表單 -->
            <div id="transactionForm" style="display: none;">
                <div class="card border-primary mb-4">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">新增交易</h6>
                    </div>
                    <div class="card-body">
                        <form id="newTransactionForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="date" class="form-control" id="transactionDate" required>
                                        <label>日期</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select class="form-select" id="transactionType" required>
                                            <option value="">請選擇</option>
                                            <option value="收入">收入</option>
                                            <option value="支出">支出</option>
                                        </select>
                                        <label>類型</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select class="form-select" id="transactionCategory" required>
                                            <option value="">請選擇類別</option>
                                        </select>
                                        <label>類別</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="number" class="form-control" id="transactionAmount" required min="1">
                                        <label>金額</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="transactionTarget">
                                        <label>對象</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select class="form-select" id="transactionAccount" required>
                                            <option value="現金">現金</option>
                                            <option value="銀行">銀行</option>
                                        </select>
                                        <label>帳戶</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                                        <textarea class="form-control" id="transactionDescription" style="height: 80px;"></textarea>
                                        <label>說明</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="bi bi-check-circle me-1"></i>儲存
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="hideTransactionForm()">
                                    <i class="bi bi-x-circle me-1"></i>取消
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 交易列表 -->
            <div class="table-container mt-4">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>日期</th>
                            <th>類型</th>
                            <th>類別</th>
                            <th>金額</th>
                            <th>對象</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="transactionList">
                        <tr><td colspan="6" class="text-center">載入中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 會員管理 -->
    <div class="tab-pane fade" id="members">
        <div class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4><i class="bi bi-people me-2"></i>會員管理</h4>
                <button class="btn btn-primary btn-sm" onclick="exportMembers()">
                    <i class="bi bi-download me-1"></i>匯出會員
                </button>
            </div>
            
            <div class="table-container">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>姓名</th>
                            <th>電話</th>
                            <th>會員狀態</th>
                            <th>加入日期</th>
                            <th>最後捐款</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="memberList">
                        <tr><td colspan="6" class="text-center">載入中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 活動管理 -->
    <div class="tab-pane fade" id="activities">
        <div class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4><i class="bi bi-calendar-event me-2"></i>活動管理</h4>
                <button class="btn btn-success btn-sm" onclick="showActivityForm()">
                    <i class="bi bi-plus-circle me-1"></i>新增活動
                </button>
            </div>
            
            <!-- 活動表單 -->
            <div id="activityForm" style="display: none;">
                <div class="card border-success mb-4">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">新增活動</h6>
                    </div>
                    <div class="card-body">
                        <form id="newActivityForm">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="activityName" required>
                                        <label>活動名稱</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <select class="form-select" id="activityType" required>
                                            <option value="">請選擇</option>
                                            <option value="講座">講座</option>
                                            <option value="聚會">聚會</option>
                                            <option value="旅遊">旅遊</option>
                                            <option value="運動">運動</option>
                                            <option value="志工服務">志工服務</option>
                                            <option value="其他">其他</option>
                                        </select>
                                        <label>活動類型</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="date" class="form-control" id="activityDate" required>
                                        <label>活動日期</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="time" class="form-control" id="activityTime">
                                        <label>活動時間</label>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="activityLocation">
                                        <label>活動地點</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <input type="number" class="form-control" id="activityMaxPeople" min="1" value="50">
                                        <label>人數上限</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                                        <textarea class="form-control" id="activityDescription" style="height: 100px;"></textarea>
                                        <label>活動描述</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="submit" class="btn btn-success me-2">
                                    <i class="bi bi-check-circle me-1"></i>建立活動
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="hideActivityForm()">
                                    <i class="bi bi-x-circle me-1"></i>取消
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 活動列表 -->
            <div class="row" id="activityList">
                <div class="col-12 text-center">載入中...</div>
            </div>
        </div>
    </div>
</div>

<script>
    let userId = null;
    let isAdmin = false;
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxZJIhCIgLvckUFDntuvI9eplWHH3aJNTsqCRLTpUgk6dN8cV3HBuZWB_BrgtG12N-X2A/exec';
    
    // 初始化 LIFF
    liff.init({ liffId: '1656516134-k8rMQwnQ' }).then(() => {
        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }
        
        liff.getProfile().then(profile => {
            userId = profile.userId;
            checkAdminPermission();
        }).catch(err => {
            console.error('取得用戶資料失敗:', err);
            showError('無法取得用戶資料，請重新開啟頁面');
        });
    }).catch(err => {
        console.error('LIFF初始化失敗:', err);
        showError('系統初始化失敗，請重新開啟頁面');
    });
    
    // 檢查管理員權限
    async function checkAdminPermission() {
        try {
            const response = await fetch(`${GAS_URL}?action=getUserInfo&userId=${encodeURIComponent(userId)}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (!result.success || result.data.userInfo.用戶角色 !== 'admin') {
                showError('您沒有管理員權限');
                setTimeout(() => {
                    if (liff.isInClient()) {
                        liff.closeWindow();
                    }
                }, 2000);
                return;
            }
            
            isAdmin = true;
            loadDashboard();
        } catch (error) {
            console.error('權限驗證失敗:', error);
            showError(`權限驗證失敗：${error.message}`);
        }
    }
    
    // 載入儀表板
    async function loadDashboard() {
        try {
            const response = await fetch(`${GAS_URL}?action=getDashboardData`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                const stats = result.data;
                document.getElementById('dashboardStats').innerHTML = `
                    <div class="col-md-3">
                        <div class="stat-card">
                            <h3>${stats.總會員數 || 0}</h3>
                            <p><i class="bi bi-people-fill me-1"></i>總會員數</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                            <h3>$${(stats.本月捐款總額 || 0).toLocaleString()}</h3>
                            <p><i class="bi bi-arrow-up-circle me-1"></i>本月捐款</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                            <h3>${stats.本月捐款次數 || 0}</h3>
                            <p><i class="bi bi-heart-fill me-1"></i>捐款次數</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: linear-gradient(135deg, #ffc107, #e0a800);">
                            <h3>${stats.進行中活動 || 0}</h3>
                            <p><i class="bi bi-calendar-check me-1"></i>進行中活動</p>
                        </div>
                    </div>
                `;
            } else {
                throw new Error(result.message || '載入儀表板資料失敗');
            }
        } catch (error) {
            console.error('載入儀表板失敗:', error);
            document.getElementById('dashboardStats').innerHTML = `
                <div class="col-12 text-center text-danger">
                    <i class="bi bi-exclamation-triangle" style="font-size: 48px;"></i>
                    <p class="mt-2">載入儀表板資料失敗</p>
                </div>
            `;
        }
    }
    
    // 顯示交易表單
    function showTransactionForm() {
        document.getElementById('transactionForm').style.display = 'block';
        document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
    }
    
    // 隱藏交易表單
    function hideTransactionForm() {
        document.getElementById('transactionForm').style.display = 'none';
        document.getElementById('newTransactionForm').reset();
    }
    
    // 更新類別選項
    document.getElementById('transactionType').addEventListener('change', (e) => {
        const categorySelect = document.getElementById('transactionCategory');
        let options = '<option value="">請選擇類別</option>';
        
        if (e.target.value === '收入') {
            options += `
                <option value="會費">會費</option>
                <option value="捐款">捐款</option>
                <option value="活動收入">活動收入</option>
                <option value="政府補助">政府補助</option>
                <option value="其他收入">其他收入</option>
            `;
        } else if (e.target.value === '支出') {
            options += `
                <option value="活動費用">活動費用</option>
                <option value="辦公費用">辦公費用</option>
                <option value="交通費">交通費</option>
                <option value="餐費">餐費</option>
                <option value="場地費">場地費</option>
                <option value="其他支出">其他支出</option>
            `;
        }
        
        categorySelect.innerHTML = options;
    });
    
    // 提交交易表單
    document.getElementById('newTransactionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>儲存中...';
        submitBtn.disabled = true;
        
        const formData = {
            action: 'addTransaction',
            日期: document.getElementById('transactionDate').value,
            類型: document.getElementById('transactionType').value,
            類別: document.getElementById('transactionCategory').value,
            金額: parseInt(document.getElementById('transactionAmount').value),
            對象: document.getElementById('transactionTarget').value,
            帳戶: document.getElementById('transactionAccount').value,
            說明: document.getElementById('transactionDescription').value
        };
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(formData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('交易記錄已新增');
                hideTransactionForm();
                loadTransactionList();
                loadDashboard();
            } else {
                throw new Error(result.message || '新增失敗');
            }
        } catch (error) {
            console.error('新增交易失敗:', error);
            showError(`新增失敗：${error.message}`);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
    
    // 載入交易列表
    async function loadTransactionList() {
        try {
            const response = await fetch(`${GAS_URL}?action=getTransactionList`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                document.getElementById('transactionList').innerHTML = result.data.slice(0, 20).map(t => `
                    <tr>
                        <td>${formatDate(t.日期)}</td>
                        <td><span class="badge ${t.類型 === '收入' ? 'bg-success' : 'bg-danger'}">${t.類型}</span></td>
                        <td>${t.類別}</td>
                        <td class="${t.類型 === '收入' ? 'text-success' : 'text-danger'}">
                            ${t.類型 === '收入' ? '+' : '-'}$${t.金額.toLocaleString()}
                        </td>
                        <td>${t.對象 || '-'}</td>
                        <td>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteTransaction('${t.編號}')" title="刪除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('transactionList').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-muted">暫無交易記錄</td></tr>';
            }
        } catch (error) {
            console.error('載入交易列表失敗:', error);
            document.getElementById('transactionList').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">載入交易列表失敗</td></tr>';
        }
    }
    
    // 載入會員列表
    async function loadMemberList() {
        try {
            const response = await fetch(`${GAS_URL}?action=getMemberList`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                document.getElementById('memberList').innerHTML = result.data.map(m => `
                    <tr>
                        <td>${m.真實姓名 || m.LINE名稱}</td>
                        <td>${m.電話 || '-'}</td>
                        <td>
                            <span class="badge ${m.是否會員 ? 'bg-success' : 'bg-secondary'}">
                                ${m.是否會員 ? '正式會員' : '一般用戶'}
                            </span>
                        </td>
                        <td>${formatDate(m.加入日期)}</td>
                        <td>${m.最後捐款日期 ? formatDate(m.最後捐款日期) : '-'}</td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm" onclick="viewMemberDetail('${m.用戶ID}')" title="查看詳情">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('memberList').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-muted">暫無會員資料</td></tr>';
            }
        } catch (error) {
            console.error('載入會員列表失敗:', error);
            document.getElementById('memberList').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">載入會員列表失敗</td></tr>';
        }
    }
    
    // 顯示活動表單
    function showActivityForm() {
        document.getElementById('activityForm').style.display = 'block';
        document.getElementById('activityDate').value = new Date().toISOString().split('T')[0];
    }
    
    // 隱藏活動表單
    function hideActivityForm() {
        document.getElementById('activityForm').style.display = 'none';
        document.getElementById('newActivityForm').reset();
    }
    
    // 提交活動表單
    document.getElementById('newActivityForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>建立中...';
        submitBtn.disabled = true;
        
        const formData = {
            action: 'createActivity',
            活動名稱: document.getElementById('activityName').value,
            活動類型: document.getElementById('activityType').value,
            活動日期: document.getElementById('activityDate').value,
            活動時間: document.getElementById('activityTime').value,
            活動地點: document.getElementById('activityLocation').value,
            人數上限: parseInt(document.getElementById('activityMaxPeople').value),
            活動描述: document.getElementById('activityDescription').value,
            建立者: userId
        };
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(formData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('活動已建立');
                hideActivityForm();
                loadActivityList();
            } else {
                throw new Error(result.message || '建立失敗');
            }
        } catch (error) {
            console.error('建立活動失敗:', error);
            showError(`建立失敗：${error.message}`);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
    
    // 載入活動列表
    async function loadActivityList() {
        try {
            const response = await fetch(`${GAS_URL}?action=getActivityList`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                document.getElementById('activityList').innerHTML = result.data.map(a => `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${a.活動名稱}</h6>
                                    <span class="badge bg-primary">${a.活動狀態}</span>
                                </div>
                                <p class="card-text small text-muted">
                                    <i class="bi bi-calendar me-1"></i>${formatDate(a.活動日期)} ${a.活動時間 || ''}<br>
                                    <i class="bi bi-geo-alt me-1"></i>${a.活動地點 || '待定'}<br>
                                    <i class="bi bi-people me-1"></i>報名人數：${a.報名人數 || 0}/${a.人數上限}
                                </p>
                                <button class="btn btn-outline-primary btn-sm" onclick="viewActivityDetail('${a.活動ID}')">
                                    <i class="bi bi-eye me-1"></i>詳情
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('activityList').innerHTML = 
                    '<div class="col-12 text-center text-muted">暫無活動資料</div>';
            }
        } catch (error) {
            console.error('載入活動列表失敗:', error);
            document.getElementById('activityList').innerHTML = 
                '<div class="col-12 text-center text-danger">載入活動列表失敗</div>';
        }
    }
    
    // 匯出會員資料
    async function exportMembers() {
        try {
            const response = await fetch(`${GAS_URL}?action=exportMembers`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                window.open(result.data.downloadUrl, '_blank');
                showSuccess('會員資料匯出成功');
            } else {
                throw new Error(result.message || '匯出失敗');
            }
        } catch (error) {
            console.error('匯出會員資料失敗:', error);
            showError(`匯出失敗：${error.message}`);
        }
    }
    
    // 刪除交易
    async function deleteTransaction(transactionId) {
        if (!confirm('確定要刪除這筆交易記錄嗎？')) return;
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'deleteTransaction',
                    transactionId: transactionId
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('交易記錄已刪除');
                loadTransactionList();
                loadDashboard();
            } else {
                throw new Error(result.message || '刪除失敗');
            }
        } catch (error) {
            console.error('刪除交易失敗:', error);
            showError(`刪除失敗：${error.message}`);
        }
    }
    
    // 查看會員詳情
    function viewMemberDetail(memberId) {
        // 可以開啟新視窗或模態框顯示會員詳細資訊
        console.log('查看會員詳情:', memberId);
        showSuccess('會員詳情功能開發中');
    }
    
    // 查看活動詳情
    function viewActivityDetail(activityId) {
        // 可以開啟新視窗或模態框顯示活動詳細資訊
        console.log('查看活動詳情:', activityId);
        showSuccess('活動詳情功能開發中');
    }
    
    // 標籤頁切換事件
    document.querySelectorAll('#adminTabs a[data-bs-toggle="pill"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', (e) => {
            const target = e.target.getAttribute('href');
            
            switch (target) {
                case '#dashboard':
                    loadDashboard();
                    break;
                case '#finance':
                    loadTransactionList();
                    break;
                case '#members':
                    loadMemberList();
                    break;
                case '#activities':
                    loadActivityList();
                    break;
            }
        });
    });
    
    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW');
    }
    
    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorAlert').style.display = 'block';
        document.getElementById('successAlert').style.display = 'none';
        
        setTimeout(() => {
            document.getElementById('errorAlert').style.display = 'none';
        }, 5000);
    }
    
    function showSuccess(message) {
        document.getElementById('successMessage').textContent = message;
        document.getElementById('successAlert').style.display = 'block';
        document.getElementById('errorAlert').style.display = 'none';
        
        setTimeout(() => {
            document.getElementById('successAlert').style.display = 'none';
        }, 3000);
    }
</script>
</body>
</html>
              
