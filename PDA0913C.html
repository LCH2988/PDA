<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>管理員專區</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height: 100vh;
    }
    .admin-nav { background:#fff;border-radius:15px;margin:20px;padding:15px;box-shadow:0 5px 15px rgba(0,0,0,0.1); }
    .nav-pills .nav-link { border-radius:10px;margin:0 5px;font-weight:600; }
    .nav-pills .nav-link.active { background:linear-gradient(135deg,#2c5aa0,#4a90e2); }
    .content-card { background:#fff;border-radius:20px;margin:20px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,0.1); }
    .stat-card { background:linear-gradient(135deg,#28a745,#20c997);color:#fff;border-radius:15px;padding:20px;margin-bottom:20px;text-align:center; }
    .stat-card h3 { font-size:2.2rem;font-weight:700;margin-bottom:10px; }
    .table-container { max-height:400px;overflow-y:auto;border:1px solid #dee2e6;border-radius:10px; }
    .proposal-card,.receipt-card,.expense-receipt { border:1px solid #dee2e6;border-radius:15px;margin-bottom:20px;overflow:hidden; }
    .proposal-card .card-header { background:linear-gradient(135deg,#6c757d,#495057);color:#fff;font-weight:600; }
    .receipt-card .card-header { background:linear-gradient(135deg,#17a2b8,#138496);color:#fff;font-weight:600; }
    .loading { display:flex;justify-content:center;align-items:center;padding:40px; }
    .receipt-status { display:inline-block;padding:4px 8px;border-radius:12px;font-size:.75rem;font-weight:600; }
    .vote-buttons,.receipt-actions { display:flex;gap:8px;flex-wrap:wrap;margin-top:10px; }
    .vote-status { background:#f8f9fa;padding:10px;border-radius:8px;margin-top:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap; }
    .receipt-image { max-width:100%;height:auto;border-radius:8px;margin-top:10px;cursor:pointer; }
    .approval-section { background:#f8f9fa;border-radius:10px;padding:10px;margin-top:12px; }
    .progress { background:#eee; }
    .truncate { white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px;display:inline-block;vertical-align:bottom; }
    .form-floating { margin-bottom:15px; }
    .badge-role { font-size:.65rem;letter-spacing:.5px; }
    .retry-block { padding:25px;text-align:center;color:#c00; }
    .retry-block button { margin-top:10px; }
  </style>
</head>
<body>
  <!-- Alerts -->
  <div id="errorAlert" class="alert alert-danger mx-3" style="display:none;">
    <i class="bi bi-exclamation-triangle me-2"></i><span id="errorMessage"></span>
  </div>
  <div id="successAlert" class="alert alert-success mx-3" style="display:none;">
    <i class="bi bi-check-circle me-2"></i><span id="successMessage"></span>
  </div>

  <!-- 導航 -->
  <div class="admin-nav">
    <ul class="nav nav-pills justify-content-center" id="adminTabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#dashboard"><i class="bi bi-speedometer2 me-1"></i>儀表板</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#finance"><i class="bi bi-cash-coin me-1"></i>財務管理</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#receipts"><i class="bi bi-receipt-cutoff me-1"></i>收據管理</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#members"><i class="bi bi-people me-1"></i>會員管理</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#activities"><i class="bi bi-calendar-event me-1"></i>活動管理</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#proposals"><i class="bi bi-file-text me-1"></i>提案審查</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#expenses"><i class="bi bi-receipt me-1"></i>支出審核</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#motions"><i class="bi bi-lightning me-1"></i>臨時動議</a></li>
    </ul>
  </div>

  <!-- 內容 -->
  <div class="tab-content">
    <!-- 儀表板 -->
    <div class="tab-pane fade show active" id="dashboard">
      <div class="content-card">
        <h4 class="mb-4"><i class="bi bi-speedometer2 me-2"></i>系統概覽</h4>
        <div class="row" id="dashboardStats">
          <div class="col-12 text-center">
            <div class="loading">
              <div class="spinner-border text-primary" role="status"><span class="visually-hidden">載入中...</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 財務管理 -->
    <div class="tab-pane fade" id="finance">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4><i class="bi bi-cash-coin me-2"></i>財務管理</h4>
          <button class="btn btn-success btn-sm" onclick="showTransactionForm()"><i class="bi bi-plus-circle me-1"></i>新增交易</button>
        </div>
        <!-- 交易表單 -->
        <div id="transactionForm" style="display:none;">
          <div class="card border-primary mb-4">
            <div class="card-header bg-primary text-white"><h6 class="mb-0">新增交易</h6></div>
            <div class="card-body">
              <form id="newTransactionForm" autocomplete="off">
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="date" class="form-control" id="transactionDate" required>
                      <label>日期</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <select class="form-select" id="transactionType" required>
                        <option value="">請選擇</option>
                        <option value="收入">收入</option>
                        <option value="支出">支出</option>
                      </select>
                      <label>類型</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <select class="form-select" id="transactionCategory" required>
                        <option value="">請選擇類別</option>
                      </select>
                      <label>類別</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="number" class="form-control" id="transactionAmount" required min="1">
                      <label>金額</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" class="form-control" id="transactionTarget">
                      <label>對象</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <select class="form-select" id="transactionAccount" required>
                        <option value="現金">現金</option>
                        <option value="銀行">銀行</option>
                      </select>
                      <label>帳戶</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea class="form-control" id="transactionDescription" style="height:80px;"></textarea>
                      <label>說明</label>
                    </div>
                  </div>
                  <!-- 收據選項 -->
                  <div class="col-12" id="receiptOptions" style="display:none;">
                    <div class="card bg-light">
                      <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-receipt-cutoff me-2"></i>收據開立</h6>
                        <div class="form-check mb-2">
                          <input class="form-check-input" type="checkbox" id="generateReceipt">
                          <label class="form-check-label" for="generateReceipt">開立收據</label>
                        </div>
                        <div id="receiptDetails" style="display:none;">
                          <div class="row g-3">
                            <div class="col-md-6">
                              <div class="form-floating">
                                <input type="text" class="form-control" id="receiptName">
                                <label>收據抬頭</label>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-floating">
                                <input type="email" class="form-control" id="receiptEmail">
                                <label>Email（選填）</label>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-floating">
                                <input type="text" class="form-control" id="receiptPhone">
                                <label>聯絡電話（選填）</label>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-floating">
                                <input type="text" class="form-control" id="receiptTaxId">
                                <label>統一編號（選填）</label>
                              </div>
                            </div>
                            <div class="col-12">
                              <div class="form-floating">
                                <textarea class="form-control" id="receiptAddress" style="height:80px;"></textarea>
                                <label>地址（選填）</label>
                              </div>
                            </div>
                            <div class="col-12">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sendReceiptNow">
                                <label class="form-check-label" for="sendReceiptNow">立即寄送收據（需 Email）</label>
                              </div>
                            </div>
                          </div><!-- row -->
                        </div><!-- details -->
                      </div>
                    </div>
                  </div>
                </div><!-- row -->
                <div class="mt-3">
                  <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-check-circle me-1"></i>儲存
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="hideTransactionForm()">
                    <i class="bi bi-x-circle me-1"></i>取消
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <!-- 交易列表 -->
        <div class="table-container mt-4">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>日期</th><th>類型</th><th>類別</th><th>金額</th><th>對象</th><th>收據</th><th>操作</th>
              </tr>
            </thead>
            <tbody id="transactionList">
              <tr><td colspan="7" class="text-center">載入中...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 收據管理 -->
    <div class="tab-pane fade" id="receipts">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4><i class="bi bi-receipt-cutoff me-2"></i>收據管理</h4>
          <div>
            <button class="btn btn-info btn-sm me-2" onclick="showReceiptTemplateModal()"><i class="bi bi-file-earmark-text me-1"></i>設定模板</button>
            <button class="btn btn-success btn-sm" onclick="showManualReceiptForm()"><i class="bi bi-plus-circle me-1"></i>手動開立收據</button>
          </div>
        </div>
        <!-- 手動收據表單 -->
        <div id="manualReceiptForm" style="display:none;">
          <div class="card border-success mb-4">
            <div class="card-header bg-success text-white"><h6 class="mb-0">手動開立收據</h6></div>
            <div class="card-body">
              <form id="newManualReceiptForm">
                <div class="row g-3">
                  <div class="col-md-6"><div class="form-floating"><input type="date" id="manualReceiptDate" class="form-control" required><label>收據日期</label></div></div>
                  <div class="col-md-6"><div class="form-floating"><input type="number" id="manualReceiptAmount" class="form-control" required min="1"><label>金額</label></div></div>
                  <div class="col-md-6"><div class="form-floating"><input type="text" id="manualReceiptName" class="form-control" required><label>收據抬頭</label></div></div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <select id="manualReceiptCategory" class="form-select" required>
                        <option value="">請選擇</option><option value="會費">會費</option><option value="捐款">捐款</option><option value="活動收入">活動收入</option><option value="其他收入">其他收入</option>
                      </select>
                      <label>收入類別</label>
                    </div>
                  </div>
                  <div class="col-md-6"><div class="form-floating"><input type="email" id="manualReceiptEmail" class="form-control"><label>Email（選填）</label></div></div>
                  <div class="col-md-6"><div class="form-floating"><input type="text" id="manualReceiptPhone" class="form-control"><label>聯絡電話（選填）</label></div></div>
                  <div class="col-md-6"><div class="form-floating"><input type="text" id="manualReceiptTaxId" class="form-control"><label>統一編號（選填）</label></div></div>
                  <div class="col-md-6"><div class="form-floating"><input type="text" id="manualReceiptPaymentMethod" class="form-control"><label>付款方式（選填）</label></div></div>
                  <div class="col-12"><div class="form-floating"><textarea id="manualReceiptAddress" class="form-control" style="height:80px;"></textarea><label>地址（選填）</label></div></div>
                  <div class="col-12"><div class="form-floating"><textarea id="manualReceiptNote" class="form-control" style="height:60px;"></textarea><label>備註（選填）</label></div></div>
                  <div class="col-12">
                    <div class="form-check">
                      <input type="checkbox" id="sendManualReceiptNow" class="form-check-input">
                      <label class="form-check-label" for="sendManualReceiptNow">立即寄送收據（需 Email）</label>
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <button type="submit" class="btn btn-success me-2"><i class="bi bi-check-circle me-1"></i>開立收據</button>
                  <button type="button" class="btn btn-secondary" onclick="hideManualReceiptForm()"><i class="bi bi-x-circle me-1"></i>取消</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <!-- 收據列表 -->
        <div id="receiptList"><div class="text-center">載入中...</div></div>
      </div>
    </div>

    <!-- 會員管理 -->
    <div class="tab-pane fade" id="members">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4><i class="bi bi-people me-2"></i>會員管理</h4>
          <button class="btn btn-primary btn-sm" onclick="exportMembers()"><i class="bi bi-download me-1"></i>匯出會員</button>
        </div>
        <div class="table-container">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr><th>姓名</th><th>電話</th><th>會員狀態</th><th>加入日期</th><th>最後捐款</th><th>操作</th></tr>
            </thead>
            <tbody id="memberList"><tr><td colspan="6" class="text-center">載入中...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 活動管理 -->
    <div class="tab-pane fade" id="activities">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4><i class="bi bi-calendar-event me-2"></i>活動管理</h4>
          <button class="btn btn-success btn-sm" onclick="showActivityForm()"><i class="bi bi-plus-circle me-1"></i>新增活動</button>
        </div>
        <div id="activityForm" style="display:none;">
          <div class="card border-success mb-4">
            <div class="card-header bg-success text-white"><h6 class="mb-0">新增活動</h6></div>
            <div class="card-body">
              <form id="newActivityForm">
                <div class="row g-3">
                  <div class="col-md-8"><div class="form-floating"><input type="text" id="activityName" class="form-control" required><label>活動名稱</label></div></div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select id="activityType" class="form-select" required>
                        <option value="">請選擇</option><option value="講座">講座</option><option value="聚會">聚會</option><option value="旅遊">旅遊</option><option value="運動">運動</option><option value="志工服務">志工服務</option><option value="其他">其他</option>
                      </select>
                      <label>活動類型</label>
                    </div>
                  </div>
                  <div class="col-md-6"><div class="form-floating"><input type="date" id="activityDate" class="form-control" required><label>活動日期</label></div></div>
                  <div class="col-md-6"><div class="form-floating"><input type="time" id="activityTime" class="form-control"><label>活動時間</label></div></div>
                  <div class="col-md-8"><div class="form-floating"><input type="text" id="activityLocation" class="form-control"><label>活動地點</label></div></div>
                  <div class="col-md-4"><div class="form-floating"><input type="number" id="activityMaxPeople" class="form-control" min="1" value="50"><label>人數上限</label></div></div>
                  <div class="col-12"><div class="form-floating"><textarea id="activityDescription" class="form-control" style="height:100px;"></textarea><label>活動描述</label></div></div>
                </div>
                <div class="mt-3">
                  <button type="submit" class="btn btn-success me-2"><i class="bi bi-check-circle me-1"></i>建立活動</button>
                  <button type="button" class="btn btn-secondary" onclick="hideActivityForm()"><i class="bi bi-x-circle me-1"></i>取消</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="row" id="activityList"><div class="col-12 text-center">載入中...</div></div>
      </div>
    </div>

    <!-- 提案審查 -->
    <div class="tab-pane fade" id="proposals">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4><i class="bi bi-file-text me-2"></i>提案審查</h4>
          <button class="btn btn-success btn-sm" onclick="showProposalForm()"><i class="bi bi-plus-circle me-1"></i>新增提案</button>
        </div>
        <div id="proposalForm" style="display:none;">
          <div class="card border-success mb-4">
            <div class="card-header bg-success text-white"><h6 class="mb-0">新增提案</h6></div>
            <div class="card-body">
              <form id="newProposalForm">
                <div class="row g-3">
                  <div class="col-md-8"><div class="form-floating"><input type="text" id="proposalTitle" class="form-control" required><label>提案標題</label></div></div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <select id="proposalType" class="form-select" required>
                        <option value="">請選擇</option><option value="預算提案">預算提案</option><option value="活動提案">活動提案</option><option value="制度提案">制度提案</option><option value="人事提案">人事提案</option><option value="其他提案">其他提案</option>
                      </select>
                      <label>提案類型</label>
                    </div>
                  </div>
                  <div class="col-12"><div class="form-floating"><textarea id="proposalContent" class="form-control" style="height:120px;" required></textarea><label>提案內容</label></div></div>
                  <div class="col-md-6"><div class="form-floating"><input type="number" id="proposalBudget" class="form-control" min="0"><label>預算金額（如適用）</label></div></div>
                  <div class="col-md-6"><div class="form-floating"><input type="date" id="proposalDeadline" class="form-control"><label>執行期限（如適用）</label></div></div>
                </div>
                <div class="mt-3">
                  <button type="submit" class="btn btn-success me-2"><i class="bi bi-check-circle me-1"></i>提交提案</button>
                  <button type="button" class="btn btn-secondary" onclick="hideProposalForm()"><i class="bi bi-x-circle me-1"></i>取消</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div id="proposalList"><div class="text-center">載入中...</div></div>
      </div>
    </div>

    <!-- 支出審核 -->
    <div class="tab-pane fade" id="expenses">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4><i class="bi bi-receipt me-2"></i>支出憑證審核</h4>
          <button class="btn btn-success btn-sm" onclick="showExpenseForm()"><i class="bi bi-plus-circle me-1"></i>提交憑證</button>
        </div>
        <div id="expenseForm" style="display:none;">
          <div class="card border-warning mb-4">
            <div class="card-header bg-warning text-dark"><h6 class="mb-0">提交支出憑證</h6></div>
            <div class="card-body">
              <form id="newExpenseForm">
                <div class="row g-3">
                  <div class="col-md-6"><div class="form-floating"><input type="date" id="expenseDate" class="form-control" required><label>支出日期</label></div></div>
                  <div class="col-md-6"><div class="form-floating"><input type="number" id="expenseAmount" class="form-control" required min="1"><label>支出金額</label></div></div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <select id="expenseCategory" class="form-select" required>
                        <option value="">請選擇</option><option value="活動費用">活動費用</option><option value="辦公費用">辦公費用</option><option value="交通費">交通費</option><option value="餐費">餐費</option><option value="場地費">場地費</option><option value="其他支出">其他支出</option>
                      </select>
                      <label>支出類別</label>
                    </div>
                  </div>
                  <div class="col-md-6"><div class="form-floating"><input type="text" id="expenseVendor" class="form-control" required><label>廠商/店家</label></div></div>
                  <div class="col-12"><div class="form-floating"><textarea id="expenseDescription" class="form-control" style="height:80px;" required></textarea><label>支出說明</label></div></div>
                  <div class="col-12">
                    <label class="form-label">上傳憑證圖片</label>
                    <input type="file" id="expenseReceipt" class="form-control" accept="image/*" required>
                  </div>
                </div>
                <div class="mt-3">
                  <button type="submit" class="btn btn-warning me-2"><i class="bi bi-check-circle me-1"></i>提交審核</button>
                  <button type="button" class="btn btn-secondary" onclick="hideExpenseForm()"><i class="bi bi-x-circle me-1"></i>取消</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div id="expenseList"><div class="text-center">載入中...</div></div>
      </div>
    </div>

    <!-- 臨時動議 -->
    <div class="tab-pane fade" id="motions">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4><i class="bi bi-lightning me-2"></i>臨時動議</h4>
          <button class="btn btn-danger btn-sm" onclick="showMotionForm()"><i class="bi bi-plus-circle me-1"></i>提出動議</button>
        </div>
        <div id="motionForm" style="display:none;">
          <div class="card border-danger mb-4">
            <div class="card-header bg-danger text-white"><h6 class="mb-0">提出臨時動議</h6></div>
            <div class="card-body">
              <form id="newMotionForm">
                <div class="row g-3">
                  <div class="col-12"><div class="form-floating"><input type="text" id="motionTitle" class="form-control" required><label>動議標題</label></div></div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <select id="motionUrgency" class="form-select" required>
                        <option value="">請選擇</option><option value="緊急">緊急</option><option value="重要">重要</option><option value="一般">一般</option>
                      </select>
                      <label>緊急程度</label>
                    </div>
                  </div>
                  <div class="col-md-6"><div class="form-floating"><input type="date" id="motionDeadline" class="form-control"><label>希望決議期限</label></div></div>
                  <div class="col-12"><div class="form-floating"><textarea id="motionContent" class="form-control" style="height:120px;" required></textarea><label>動議內容</label></div></div>
                  <div class="col-12"><div class="form-floating"><textarea id="motionReason" class="form-control" style="height:80px;" required></textarea><label>提出理由</label></div></div>
                </div>
                <div class="mt-3">
                  <button type="submit" class="btn btn-danger me-2"><i class="bi bi-check-circle me-1"></i>提出動議</button>
                  <button type="button" class="btn btn-secondary" onclick="hideMotionForm()"><i class="bi bi-x-circle me-1"></i>取消</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div id="motionList"><div class="text-center">載入中...</div></div>
      </div>
    </div>
  </div>

  <!-- 收據模板設定 Modal -->
  <div class="modal fade" id="receiptTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>收據模板設定</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="receiptTemplateForm">
            <div class="mb-3">
              <label class="form-label">Google 文件模板 ID</label>
              <input type="text" class="form-control" id="templateDocId" placeholder="請輸入 Google 文件 ID">
            </div>
            <div class="mb-3">
              <label class="form-label">收據編號前綴</label>
              <input type="text" class="form-control" id="receiptPrefix" value="RCP">
            </div>
            <div class="mb-3">
              <label class="form-label">機構名稱</label>
              <input type="text" class="form-control" id="organizationName">
            </div>
            <div class="mb-3">
              <label class="form-label">機構地址</label>
              <textarea class="form-control" id="organizationAddress" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">機構電話</label>
              <input type="text" class="form-control" id="organizationPhone">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveReceiptTemplate()">儲存設定</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ================== 全域變數 ==================
    let userId = null;
    let userRole = null;
    let isAdmin = false;
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxM234kHFBg7SOu0dVN5NsbFNw0rhdJeCfqnqCd0q9Cdp-wPlveeWz6CqjPvR_DirKZsw/exec';

    // ================== 工具函數 ==================
    function showError(msg){
      console.error(msg);
      document.getElementById('errorMessage').textContent = msg;
      document.getElementById('errorAlert').style.display='block';
      document.getElementById('successAlert').style.display='none';
      setTimeout(()=>{ document.getElementById('errorAlert').style.display='none'; },6000);
    }
    function showSuccess(msg){
      document.getElementById('successMessage').textContent = msg;
      document.getElementById('successAlert').style.display='block';
      document.getElementById('errorAlert').style.display='none';
      setTimeout(()=>{ document.getElementById('successAlert').style.display='none'; },3500);
    }
    function formatDate(d){
      if(!d) return '';
      const dt = new Date(d);
      if(isNaN(dt)) return '';
      return dt.toLocaleDateString('zh-TW');
    }
    function formatDateTime(d){
      if(!d) return '';
      const dt = new Date(d);
      if(isNaN(dt)) return '';
      return dt.toLocaleString('zh-TW');
    }

    function retryBlock(message, retryFnName){
      return `
        <div class="retry-block">
          <div>${message}</div>
          <button class="btn btn-sm btn-outline-danger mt-2" onclick="${retryFnName}()">
            <i class="bi bi-arrow-clockwise me-1"></i>重試
          </button>
        </div>
      `;
    }

    // ================== LIFF 初始化 ==================
    liff.init({ liffId:'1656516134-k8rMQwnQ' }).then(()=>{
      if(!liff.isLoggedIn()) { liff.login(); return; }
      liff.getProfile().then(profile=>{
        userId = profile.userId;
        checkAdminPermission();
      }).catch(err=>{
        showError('無法取得用戶資料：'+err.message);
      });
    }).catch(err=>{
      showError('LIFF 初始化失敗：'+err.message);
    });

    async function checkAdminPermission(){
      try{
        const res = await fetch(`${GAS_URL}?action=getUserInfo&userId=${encodeURIComponent(userId)}`);
        const json = await res.json();
        if(!json.success) throw new Error(json.message || '權限驗證失敗');
        userRole = json.data.userInfo.用戶角色;
        if(!['admin','chairman','director','supervisor'].includes(userRole)){
          showError('您沒有管理員權限');
          setTimeout(()=>{ if(liff.isInClient()) liff.closeWindow(); },2000);
          return;
        }
        isAdmin = true;
        loadDashboard();
      }catch(e){
        showError('權限驗證失敗：'+e.message);
      }
    }

    // ================== 儀表板 ==================
    async function loadDashboard(){
      const container = document.getElementById('dashboardStats');
      container.innerHTML = `<div class="col-12 text-center p-4"><div class="spinner-border"></div></div>`;
      try{
        const res = await fetch(`${GAS_URL}?action=getDashboardData`);
          const json = await res.json();
          if(!json.success) throw new Error(json.message||'取得失敗');
          const s = json.data;
          container.innerHTML = `
            <div class="col-md-3"><div class="stat-card"><h3>${s.總會員數||0}</h3><p><i class="bi bi-people-fill me-1"></i>總會員數</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);"><h3>$${(s.本月捐款總額||0).toLocaleString()}</h3><p><i class="bi bi-arrow-up-circle me-1"></i>本月捐款</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#dc3545,#c82333);"><h3>${s.本月捐款次數||0}</h3><p><i class="bi bi-heart-fill me-1"></i>捐款次數</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#ffc107,#e0a800);"><h3>${s.進行中活動||0}</h3><p><i class="bi bi-calendar-check me-1"></i>進行中活動</p></div></div>
            <div class="col-md-4"><div class="stat-card" style="background:linear-gradient(135deg,#6f42c1,#5a32a3);"><h3>${s.待審提案||0}</h3><p><i class="bi bi-file-text me-1"></i>待審提案</p></div></div>
            <div class="col-md-4"><div class="stat-card" style="background:linear-gradient(135deg,#fd7e14,#e8590c);"><h3>${s.待審憑證||0}</h3><p><i class="bi bi-receipt me-1"></i>待審憑證</p></div></div>
            <div class="col-md-4"><div class="stat-card" style="background:linear-gradient(135deg,#e83e8c,#d91a72);"><h3>${s.本月收據數||0}</h3><p><i class="bi bi-receipt-cutoff me-1"></i>本月收據</p></div></div>
          `;
      }catch(e){
        container.innerHTML = `<div class="col-12">${retryBlock('載入儀表板失敗：'+e.message,'loadDashboard')}</div>`;
      }
    }

    // ================== 收據模板 ==================
    function showReceiptTemplateModal(){
      loadReceiptTemplate();
      new bootstrap.Modal(document.getElementById('receiptTemplateModal')).show();
    }
    async function loadReceiptTemplate(){
      try{
        const r = await fetch(`${GAS_URL}?action=getReceiptTemplate`);
        const j = await r.json();
        if(j.success && j.data){
          document.getElementById('templateDocId').value = j.data.templateDocId||'';
          document.getElementById('receiptPrefix').value = j.data.receiptPrefix||'RCP';
          document.getElementById('organizationName').value = j.data.organizationName||'';
          document.getElementById('organizationAddress').value = j.data.organizationAddress||'';
          document.getElementById('organizationPhone').value = j.data.organizationPhone||'';
        }
      }catch(e){ console.warn('載入收據模板失敗',e); }
    }
    async function saveReceiptTemplate(){
      const payload = {
        action:'saveReceiptTemplate',
        templateDocId:document.getElementById('templateDocId').value.trim(),
        receiptPrefix:document.getElementById('receiptPrefix').value.trim(),
        organizationName:document.getElementById('organizationName').value.trim(),
          organizationAddress:document.getElementById('organizationAddress').value.trim(),
          organizationPhone:document.getElementById('organizationPhone').value.trim(),
          updater:userId
        };
        try{
          const res = await fetch(GAS_URL,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(payload)
          });
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'儲存失敗');
          showSuccess('收據模板設定已儲存');
          bootstrap.Modal.getInstance(document.getElementById('receiptTemplateModal')).hide();
        }catch(e){ showError('儲存失敗：'+e.message); }
      }

      // ================== 手動收據 ==================
      function showManualReceiptForm(){
        document.getElementById('manualReceiptForm').style.display='block';
        document.getElementById('manualReceiptDate').value = new Date().toISOString().split('T')[0];
      }
      function hideManualReceiptForm(){
        document.getElementById('manualReceiptForm').style.display='none';
        document.getElementById('newManualReceiptForm').reset();
      }
      document.getElementById('newManualReceiptForm').addEventListener('submit',async(e)=>{
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const old = btn.innerHTML;
        btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>處理中...';
        const payload = {
          action:'createManualReceipt',
          收據日期:document.getElementById('manualReceiptDate').value,
          金額:parseInt(document.getElementById('manualReceiptAmount').value),
          收據抬頭:document.getElementById('manualReceiptName').value.trim(),
          收入類別:document.getElementById('manualReceiptCategory').value,
          Email:document.getElementById('manualReceiptEmail').value.trim(),
          聯絡電話:document.getElementById('manualReceiptPhone').value.trim(),
          統一編號:document.getElementById('manualReceiptTaxId').value.trim(),
          付款方式:document.getElementById('manualReceiptPaymentMethod').value.trim(),
          地址:document.getElementById('manualReceiptAddress').value.trim(),
          備註:document.getElementById('manualReceiptNote').value.trim(),
          立即寄送:document.getElementById('sendManualReceiptNow').checked,
          開立人:userId
        };
        try{
          const res = await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'開立失敗');
          showSuccess(payload.立即寄送?'收據已開立並寄送':'收據已開立');
          hideManualReceiptForm();
          loadReceiptList();
          loadDashboard();
        }catch(err){ showError('開立失敗：'+err.message); }
        finally{ btn.disabled=false; btn.innerHTML=old; }
      });

      // ================== 交易 & 收據整合 ==================
      function showTransactionForm(){
        document.getElementById('transactionForm').style.display='block';
        document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
      }
      function hideTransactionForm(){
        document.getElementById('transactionForm').style.display='none';
        document.getElementById('newTransactionForm').reset();
        document.getElementById('receiptOptions').style.display='none';
        document.getElementById('receiptDetails').style.display='none';
      }

      document.getElementById('transactionType').addEventListener('change',(e)=>{
        const val = e.target.value;
        const sel = document.getElementById('transactionCategory');
        const receiptOpt = document.getElementById('receiptOptions');
        let html = '<option value="">請選擇類別</option>';
        if(val==='收入'){
          html+=`
            <option value="會費">會費</option>
            <option value="捐款">捐款</option>
            <option value="活動收入">活動收入</option>
            <option value="政府補助">政府補助</option>
            <option value="其他收入">其他收入</option>
          `;
          receiptOpt.style.display='block';
        }else if(val==='支出'){
          html+=`
            <option value="活動費用">活動費用</option>
            <option value="辦公費用">辦公費用</option>
            <option value="交通費">交通費</option>
            <option value="餐費">餐費</option>
            <option value="場地費">場地費</option>
            <option value="其他支出">其他支出</option>
          `;
          receiptOpt.style.display='none';
        }else{
          receiptOpt.style.display='none';
        }
        sel.innerHTML = html;
      });

      document.getElementById('generateReceipt').addEventListener('change',(e)=>{
        const details = document.getElementById('receiptDetails');
        if(e.target.checked){
          details.style.display='block';
          const target = document.getElementById('transactionTarget').value.trim();
          if(target) document.getElementById('receiptName').value = target;
        }else{
          details.style.display='none';
        }
      });

      document.getElementById('newTransactionForm').addEventListener('submit',async(e)=>{
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const old = btn.innerHTML;
        btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>儲存中...';

        const 開立收據 = document.getElementById('generateReceipt').checked;
        const payload = {
          action:'addTransactionWithReceipt',
          日期:document.getElementById('transactionDate').value,
          類型:document.getElementById('transactionType').value,
          類別:document.getElementById('transactionCategory').value,
          金額:parseInt(document.getElementById('transactionAmount').value),
          對象:document.getElementById('transactionTarget').value.trim(),
          帳戶:document.getElementById('transactionAccount').value,
          說明:document.getElementById('transactionDescription').value.trim(),
          開立收據,
          建立者:userId
        };
        if(開立收據){
          payload.收據資料 = {
            收據抬頭:document.getElementById('receiptName').value.trim(),
            Email:document.getElementById('receiptEmail').value.trim(),
            聯絡電話:document.getElementById('receiptPhone').value.trim(),
            統一編號:document.getElementById('receiptTaxId').value.trim(),
            地址:document.getElementById('receiptAddress').value.trim(),
            立即寄送:document.getElementById('sendReceiptNow').checked
          };
        }
        try{
          const res = await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'新增失敗');
          let msg='交易記錄已新增';
          if(開立收據){
            msg += payload.收據資料.立即寄送 ? '，收據已開立並寄送' : '，收據已開立';
          }
          showSuccess(msg);
          hideTransactionForm();
          loadTransactionList();
          loadDashboard();
        }catch(err){ showError('新增失敗：'+err.message); }
        finally{ btn.disabled=false; btn.innerHTML=old; }
      });

      async function loadTransactionList(){
        const tbody = document.getElementById('transactionList');
        tbody.innerHTML = `<tr><td colspan="7" class="text-center p-3"><div class="spinner-border"></div></td></tr>`;
        try{
          const res = await fetch(`${GAS_URL}?action=getTransactionList`);
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'取得失敗');
          const data = j.data;
          if(!data.length){
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暫無交易記錄</td></tr>';
            return;
          }
          tbody.innerHTML = data.slice(0,50).map(t=>`
            <tr>
              <td>${formatDate(t.日期)}</td>
              <td><span class="badge ${t.類型==='收入'?'bg-success':'bg-danger'}">${t.類型}</span></td>
              <td>${t.類別}</td>
              <td class="${t.類型==='收入'?'text-success':'text-danger'}">${t.類型==='收入'?'+':'-'}$${(t.金額||0).toLocaleString()}</td>
              <td>${t.對象||'-'}</td>
              <td>
                ${
                  t.收據編號
                    ? `<span class="badge bg-info">${t.收據編號}</span>
                       ${t.收據PDF連結?`<button class="btn btn-outline-primary btn-sm ms-1" onclick="window.open('${t.收據PDF連結}','_blank')" title="下載收據"><i class="bi bi-file-pdf"></i></button>`:''}`
                    : (t.類型==='收入'
                          ? `<button class="btn btn-outline-success btn-sm" onclick="createReceiptForTransaction('${t.編號}')" title="補開收據"><i class="bi bi-plus-circle"></i></button>`
                          : '-')
                }
              </td>
              <td>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteTransaction('${t.編號}')" title="刪除"><i class="bi bi-trash"></i></button>
              </td>
            </tr>
          `).join('');
        }catch(e){
          tbody.innerHTML = `<tr><td colspan="7">${retryBlock('載入交易列表失敗：'+e.message,'loadTransactionList')}</td></tr>`;
        }
      }

      async function createReceiptForTransaction(transactionId){
        const title = prompt('請輸入收據抬頭：');
        if(!title || !title.trim()) return;
        const email = prompt('請輸入 Email（選填，取消略過）：')||'';
        const sendNow = email ? confirm('是否立即寄送收據？') : false;
        const payload = {
          action:'createReceiptForTransaction',
          transactionId,
          收據抬頭:title.trim(),
          Email:email.trim(),
          立即寄送:sendNow,
          建立者:userId
        };
        try{
          const res = await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'開立失敗');
          showSuccess(sendNow?'收據已開立並寄送':'收據已開立');
          loadTransactionList();
          loadReceiptList();
        }catch(e){ showError('補開失敗：'+e.message); }
      }

      async function deleteTransaction(id){
        if(!confirm('確定要刪除這筆交易記錄嗎？此操作無法復原。')) return;
        try{
          const payload = { action:'deleteTransaction', transactionId:id, deletedBy:userId };
          const res = await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'刪除失敗');
          showSuccess('交易記錄已刪除');
          loadTransactionList();
          loadDashboard();
        }catch(e){ showError('刪除失敗：'+e.message); }
      }

      // ================== 收據列表 ==================
      function getReceiptStatusClass(status){
        switch(status){
          case '已開立': return 'bg-success text-white';
          case '已寄送': return 'bg-primary text-white';
          case '處理中': return 'bg-warning text-dark';
          case '錯誤': return 'bg-danger text-white';
          default: return 'bg-secondary text-white';
        }
      }
      async function loadReceiptList(){
        const container = document.getElementById('receiptList');
        container.innerHTML = '<div class="text-center p-4"><div class="spinner-border"></div></div>';
        try{
          const res = await fetch(`${GAS_URL}?action=getReceiptList`);
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'取得失敗');
          const data = j.data;
          if(!data.length){ container.innerHTML='<div class="text-center text-muted">暫無收據資料</div>'; return; }
          container.innerHTML = data.slice(0,50).map(r=>`
            <div class="receipt-card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0">收據編號：${r.收據編號}</h6>
                  <small class="text-light">開立日期：${formatDate(r.收據日期)}</small>
                </div>
                <div>
                  <span class="receipt-status ${getReceiptStatusClass(r.狀態)}">${r.狀態}</span>
                  <span class="badge bg-light text-dark ms-2">$${(r.金額||0).toLocaleString()}</span>
                </div>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-8">
                    <p class="mb-2"><strong>收據抬頭：</strong>${r.收據抬頭}</p>
                    <p class="mb-2"><strong>收入類別：</strong>${r.收入類別}</p>
                    ${r.統一編號?`<p class="mb-2"><strong>統一編號：</strong>${r.統一編號}</p>`:''}
                    ${r.Email?`<p class="mb-2"><strong>Email：</strong>${r.Email}</p>`:''}
                    ${r.備註?`<p class="mb-2"><strong>備註：</strong>${r.備註}</p>`:''}
                    <p class="mb-0 text-muted small">開立時間：${formatDateTime(r.開立時間)}</p>
                  </div>
                  <div class="col-md-4">
                    <div class="receipt-actions">
                      ${r.PDF連結?`<button class="btn btn-primary btn-sm" onclick="window.open('${r.PDF連結}','_blank')"><i class="bi bi-file-pdf me-1"></i>PDF</button>`:''}
                      ${r.Email && r.狀態!=='已寄送'
                        ? `<button class="btn btn-success btn-sm" onclick="sendReceipt('${r.收據ID}')"><i class="bi bi-envelope me-1"></i>寄送</button>`:''
                      }
                      <button class="btn btn-info btn-sm" onclick="regenerateReceiptPDF('${r.收據ID}')"><i class="bi bi-arrow-clockwise me-1"></i>重產</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `).join('');
        }catch(e){
          container.innerHTML = retryBlock('載入收據列表失敗：'+e.message,'loadReceiptList');
        }
      }
      async function sendReceipt(id){
        try{
          const res = await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'sendReceipt',receiptId:id})});
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'寄送失敗');
          showSuccess('收據已寄送');
          loadReceiptList();
        }catch(e){ showError('寄送失敗：'+e.message); }
      }
      async function regenerateReceiptPDF(id){
        try{
          const res = await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'regenerateReceiptPDF',receiptId:id})});
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'重新產生失敗');
          showSuccess('收據PDF已重新產生');
          loadReceiptList();
        }catch(e){ showError('重新產生失敗：'+e.message); }
      }

      // ================== 會員 ==================
      async function loadMemberList(){
        const tbody = document.getElementById('memberList');
        tbody.innerHTML = `<tr><td colspan="6" class="text-center p-3"><div class="spinner-border"></div></td></tr>`;
        try{
          const res = await fetch(`${GAS_URL}?action=getMemberList`);
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'取得失敗');
          const data = j.data;
          if(!data.length){ tbody.innerHTML='<tr><td colspan="6" class="text-center text-muted">暫無會員資料</td></tr>'; return; }
          tbody.innerHTML = data.slice(0,100).map(m=>`
            <tr>
              <td>${m.真實姓名||m.LINE名稱}</td>
              <td>${m.電話||'-'}</td>
              <td><span class="badge ${m.是否會員?'bg-success':'bg-secondary'}">${m.是否會員?'正式會員':'一般用戶'}</span></td>
              <td>${formatDate(m.加入日期)}</td>
              <td>${m.最後捐款日期?formatDate(m.最後捐款日期):'-'}</td>
              <td><button class="btn btn-outline-primary btn-sm" onclick="viewMemberDetail('${m.用戶ID}')"><i class="bi bi-eye"></i></button></td>
            </tr>
          `).join('');
        }catch(e){
          tbody.innerHTML = `<tr><td colspan="6">${retryBlock('載入會員列表失敗：'+e.message,'loadMemberList')}</td></tr>`;
        }
      }

      async function viewMemberDetail(memberId){
        try{
          const res = await fetch(`${GAS_URL}?action=getMemberDetail&memberId=${encodeURIComponent(memberId)}`);
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'取得失敗');
          const m = j.data;
          const donationRows = (m.捐款記錄||[]).slice(0,5).map(d=>`
            <tr>
              <td>${formatDate(d.日期)}</td>
              <td class="text-success">$${(d.金額||0).toLocaleString()}</td>
              <td>${d.類別||''}</td>
              <td>${d.收據編號||'-'}</td>
            </tr>`).join('');
          const actRows = (m.活動參與||[]).slice(0,5).map(a=>`
            <tr>
              <td>${a.活動名稱}</td>
              <td>${formatDate(a.活動日期)}</td>
              <td><span class="badge ${a.參與狀態==='已參加'?'bg-success':'bg-warning'}">${a.參與狀態}</span></td>
            </tr>`).join('');
          const modalHtml = `
            <div class="modal fade" id="memberDetailModal" tabindex="-1">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">會員詳情 - ${m.真實姓名||m.LINE名稱}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <div class="row">
                      <div class="col-md-6">
                        <h6>基本資料</h6>
                        <p><strong>姓名：</strong>${m.真實姓名||'未提供'}</p>
                        <p><strong>LINE名稱：</strong>${m.LINE名稱}</p>
                        <p><strong>電話：</strong>${m.電話||'未提供'}</p>
                        <p><strong>Email：</strong>${m.Email||'未提供'}</p>
                        <p><strong>會員狀態：</strong><span class="badge ${m.是否會員?'bg-success':'bg-secondary'}">${m.是否會員?'正式會員':'一般用戶'}</span></p>
                        <p><strong>加入日期：</strong>${formatDate(m.加入日期)}</p>
                      </div>
                      <div class="col-md-6">
                        <h6>捐款統計</h6>
                        <p><strong>總捐款金額：</strong>$${(m.總捐款金額||0).toLocaleString()}</p>
                        <p><strong>捐款次數：</strong>${m.捐款次數||0} 次</p>
                        <p><strong>最後捐款：</strong>${m.最後捐款日期?formatDate(m.最後捐款日期):'無'}</p>
                        <p><strong>平均捐款：</strong>$${(m.捐款次數>0?Math.round((m.總捐款金額||0)/m.捐款次數):0).toLocaleString()}</p>
                      </div>
                    </div>
                    ${(m.捐款記錄||[]).length?`
                      <hr><h6>最近捐款記錄</h6>
                      <div class="table-responsive">
                        <table class="table table-sm">
                          <thead><tr><th>日期</th><th>金額</th><th>類別</th><th>收據</th></tr></thead>
                          <tbody>${donationRows}</tbody>
                        </table>
                      </div>`:''
                    }
                    ${(m.活動參與||[]).length?`
                      <hr><h6>活動參與記錄</h6>
                      <div class="table-responsive">
                        <table class="table table-sm">
                          <thead><tr><th>活動名稱</th><th>日期</th><th>狀態</th></tr></thead>
                          <tbody>${actRows}</tbody>
                        </table>
                      </div>`:''
                    }
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    ${m.是否會員
                      ? `<button type="button" class="btn btn-warning" onclick="updateMemberStatus('${m.用戶ID}',false)">取消會員資格</button>`
                      : `<button type="button" class="btn btn-success" onclick="updateMemberStatus('${m.用戶ID}',true)">升級為會員</button>`
                    }
                  </div>
                </div>
              </div>
            </div>
          `;
          const old = document.getElementById('memberDetailModal');
          if(old) old.remove();
          document.body.insertAdjacentHTML('beforeend',modalHtml);
          new bootstrap.Modal(document.getElementById('memberDetailModal')).show();
        }catch(e){ showError('查看會員詳情失敗：'+e.message); }
      }

      async function updateMemberStatus(memberId,isMember){
        if(!confirm(`確定要${isMember?'升級為會員':'取消會員資格'}嗎？`)) return;
        try{
          const res = await fetch(GAS_URL,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({action:'updateMemberStatus',memberId,是否會員:isMember,updater:userId})
          });
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'更新失敗');
          showSuccess('會員狀態已更新');
          const md = document.getElementById('memberDetailModal');
          if(md) bootstrap.Modal.getInstance(md).hide();
          loadMemberList(); loadDashboard();
        }catch(e){ showError('更新失敗：'+e.message); }
      }

      // ================== 活動 ==================
      function showActivityForm(){
        document.getElementById('activityForm').style.display='block';
        document.getElementById('activityDate').value = new Date().toISOString().split('T')[0];
      }
      function hideActivityForm(){
        document.getElementById('activityForm').style.display='none';
        document.getElementById('newActivityForm').reset();
      }
      document.getElementById('newActivityForm').addEventListener('submit',async(e)=>{
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const old=btn.innerHTML; btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>建立中...';
        const payload = {
          action:'addActivity',
          活動名稱:document.getElementById('activityName').value.trim(),
          活動類型:document.getElementById('activityType').value,
          活動日期:document.getElementById('activityDate').value,
          活動時間:document.getElementById('activityTime').value,
          活動地點:document.getElementById('activityLocation').value.trim(),
          人數上限:parseInt(document.getElementById('activityMaxPeople').value)||50,
          活動描述:document.getElementById('activityDescription').value.trim(),
          建立者:userId
        };
        try{
          const res = await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'建立失敗');
          showSuccess('活動已建立成功');
          hideActivityForm(); loadActivityList(); loadDashboard();
        }catch(err){ showError('建立失敗：'+err.message); }
        finally{ btn.disabled=false; btn.innerHTML=old; }
      });

      function getActivityStatusBadge(s){
        switch(s){
          case '報名中': return 'bg-success';
          case '進行中': return 'bg-primary';
          case '已結束': return 'bg-secondary';
          case '已取消': return 'bg-danger';
          default: return 'bg-info';
        }
      }
      async function loadActivityList(){
        const container = document.getElementById('activityList');
        container.innerHTML = '<div class="col-12 text-center p-4"><div class="spinner-border"></div></div>';
        try{
          const res = await fetch(`${GAS_URL}?action=getActivityList`);
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'取得失敗');
          const data = j.data;
          if(!data.length){ container.innerHTML = '<div class="col-12 text-center text-muted">暫無活動資料</div>'; return; }
          container.innerHTML = data.slice(0,60).map(a=>`
            <div class="col-md-6 col-lg-4">
              <div class="card h-100">
                <div class="card-header bg-primary text-white">
                  <h6 class="mb-0">${a.活動名稱}</h6>
                  <small>${a.活動類型}</small>
                </div>
                <div class="card-body">
                  <p class="card-text">${a.活動描述||'無描述'}</p>
                  <div class="mb-2"><i class="bi bi-calendar me-1"></i><small>${formatDate(a.活動日期)} ${a.活動時間||''}</small></div>
                  ${a.活動地點?`<div class="mb-2"><i class="bi bi-geo-alt me-1"></i><small>${a.活動地點}</small></div>`:''}
                  <div class="mb-2"><i class="bi bi-people me-1"></i><small>報名：${a.報名人數||0}/${a.人數上限}</small></div>
                  <div class="progress mb-2" style="height:5px;"><div class="progress-bar" style="width:${((a.報名人數||0)/a.人數上限)*100}%;"></div></div>
                </div>
                <div class="card-footer">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="badge ${getActivityStatusBadge(a.活動狀態)}">${a.活動狀態}</span>
                    <div>
                      <button class="btn btn-outline-primary btn-sm" onclick="viewActivityDetail('${a.活動ID}')"><i class="bi bi-eye"></i></button>
                      <button class="btn btn-outline-success btn-sm" onclick="exportActivityMembers('${a.活動ID}')"><i class="bi bi-download"></i></button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `).join('');
        }catch(e){
          container.innerHTML = `<div class="col-12">${retryBlock('載入活動列表失敗：'+e.message,'loadActivityList')}</div>`;
        }
      }
      function viewActivityDetail(id){
        alert('活動詳情功能可再擴充 (活動ID:'+id+')');
      }
      async function exportActivityMembers(activityId){
        try{
          const res = await fetch(`${GAS_URL}?action=exportActivityMembers&activityId=${encodeURIComponent(activityId)}`);
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'匯出失敗');
          const blob = new Blob([j.data],{type:'text/csv;charset=utf-8;'});
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `活動報名名單_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(link); link.click(); document.body.removeChild(link);
          showSuccess('名單已匯出');
        }catch(e){ showError('匯出失敗：'+e.message); }
      }

      // ================== 提案 ==================
      function showProposalForm(){
        document.getElementById('proposalForm').style.display='block';
        const nextWeek = new Date(Date.now()+7*86400000);
        document.getElementById('proposalDeadline').value = nextWeek.toISOString().split('T')[0];
      }
      function hideProposalForm(){
        document.getElementById('proposalForm').style.display='none';
        document.getElementById('newProposalForm').reset();
      }
      document.getElementById('newProposalForm').addEventListener('submit',async(e)=>{
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const old = btn.innerHTML; btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>提交中...';
        const payload = {
          action:'addProposal',
          提案標題:document.getElementById('proposalTitle').value.trim(),
          提案類型:document.getElementById('proposalType').value,
          提案內容:document.getElementById('proposalContent').value.trim(),
          預算金額:parseInt(document.getElementById('proposalBudget').value)||0,
          執行期限:document.getElementById('proposalDeadline').value,
          提案人:userId
        };
        try{
          const res = await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'提交失敗');
          showSuccess('提案已提交，等待審查');
          hideProposalForm(); loadProposalList(); loadDashboard();
        }catch(err){ showError('提交失敗：'+err.message); }
        finally{ btn.disabled=false; btn.innerHTML=old; }
      });

      function getProposalStatusBadge(status){
        switch(status){
          case '待審查': return 'bg-warning text-dark';
          case '審查中': return 'bg-info';
          case '已通過': return 'bg-success';
          case '已否決': return 'bg-danger';
          case '需修正': return 'bg-secondary';
          case '已逾期': return 'bg-dark';
          default: return 'bg-light text-dark';
        }
      }
      async function loadProposalList(){
        const container = document.getElementById('proposalList');
        container.innerHTML = '<div class="text-center p-4"><div class="spinner-border"></div></div>';
        try{
          const res = await fetch(`${GAS_URL}?action=getProposalList`);
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'取得失敗');
          const data = j.data;
          if(!data.length){ container.innerHTML='<div class="text-center text-muted">暫無提案資料</div>'; return; }
          container.innerHTML = data.slice(0,50).map(p=>`
            <div class="proposal-card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0">${p.提案標題}</h6>
                  <small class="text-light">${p.提案類型} | 提案人：${p.提案人姓名||'匿名'}</small>
                </div>
                <span class="badge ${getProposalStatusBadge(p.審查狀態)}">${p.審查狀態}</span>
              </div>
              <div class="card-body">
                <p class="mb-3">${p.提案內容}</p>
                ${p.預算金額>0?`<p class="mb-2"><strong>預算：</strong>$${p.預算金額.toLocaleString()}</p>`:''}
                ${p.執行期限?`<p class="mb-2"><strong>執行期限：</strong>${formatDate(p.執行期限)}</p>`:''}
                <p class="mb-0 text-muted small">提案時間：${formatDateTime(p.提案時間)}</p>
                ${p.審查狀態==='待審查' && ['admin','chairman','director'].includes(userRole)?`
                  <div class="vote-buttons mt-2">
                    <button class="btn btn-success btn-sm" onclick="voteProposal('${p.提案ID}','通過')"><i class="bi bi-check-circle me-1"></i>通過</button>
                    <button class="btn btn-danger btn-sm" onclick="voteProposal('${p.提案ID}','否決')"><i class="bi bi-x-circle me-1"></i>否決</button>
                    <button class="btn btn-warning btn-sm" onclick="voteProposal('${p.提案ID}','修正')"><i class="bi bi-pencil me-1"></i>需修正</button>
                  </div>
                `:''}
                ${p.投票結果?`
                  <div class="vote-status">
                    <div>
                      <span class="text-success">贊成：${p.投票結果.贊成||0}</span>
                      <span class="text-danger ms-2">反對：${p.投票結果.反對||0}</span>
                      <span class="text-warning ms-2">修正：${p.投票結果.修正||0}</span>
                    </div>
                    <small class="text-muted">投票進度：${p.投票結果.總投票數}/${p.投票結果.應投票數}</small>
                  </div>
                `:''}
              </div>
            </div>
          `).join('');
        }catch(e){
          container.innerHTML = retryBlock('載入提案列表失敗：'+e.message,'loadProposalList');
        }
      }

      async function voteProposal(id,vote){
        const comment = vote==='修正'
          ? prompt('請輸入修正建議：') 
          : prompt('可輸入投票理由（可留空）：');
        if(vote==='修正' && (!comment || !comment.trim())){
          showError('修正建議不能為空'); return;
        }
        try{
          const res = await fetch(GAS_URL,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({action:'voteProposal',proposalId:id,vote,comment:comment||'',voterId:userId})
          });
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'投票失敗');
          showSuccess('投票已提交');
          loadProposalList(); loadDashboard();
        }catch(e){ showError('投票失敗：'+e.message); }
      }

      // ================== 支出憑證 ==================
      function showExpenseForm(){
        document.getElementById('expenseForm').style.display='block';
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
      }
      function hideExpenseForm(){
        document.getElementById('expenseForm').style.display='none';
        document.getElementById('newExpenseForm').reset();
      }
      document.getElementById('newExpenseForm').addEventListener('submit',async(e)=>{
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const old=btn.innerHTML; btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>提交中...';
        const file = document.getElementById('expenseReceipt').files[0];
        if(!file){ showError('請選擇憑證圖片'); btn.disabled=false; btn.innerHTML=old; return; }
        const reader = new FileReader();
        reader.onload = async ev=>{
          const payload = {
            action:'addExpense',
            支出日期:document.getElementById('expenseDate').value,
            支出金額:parseInt(document.getElementById('expenseAmount').value),
            支出類別:document.getElementById('expenseCategory').value,
            廠商店家:document.getElementById('expenseVendor').value.trim(),
            支出說明:document.getElementById('expenseDescription').value.trim(),
            憑證圖片:ev.target.result,
            檔案名稱:file.name,
            提交人:userId
          };
          try{
            const res = await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
            const j = await res.json();
            if(!j.success) throw new Error(j.message||'提交失敗');
            showSuccess('支出憑證已提交，等待審核');
            hideExpenseForm(); loadExpenseList(); loadDashboard();
          }catch(err){ showError('提交失敗：'+err.message); }
          finally{ btn.disabled=false; btn.innerHTML=old; }
        };
        reader.readAsDataURL(file);
      });

      function getExpenseStatusBadge(s){
        switch(s){
          case '待審核': return 'bg-warning text-dark';
          case '已通過': return 'bg-success';
          case '已駁回': return 'bg-danger';
          default: return 'bg-secondary';
        }
      }
      async function loadExpenseList(){
        const container = document.getElementById('expenseList');
        container.innerHTML = '<div class="text-center p-4"><div class="spinner-border"></div></div>';
        try{
          const res = await fetch(`${GAS_URL}?action=getExpenseList`);
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'取得失敗');
          const data = j.data;
          if(!data.length){ container.innerHTML='<div class="text-center text-muted">暫無支出憑證</div>'; return; }
          container.innerHTML = data.slice(0,80).map(e=>`
            <div class="expense-receipt">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <h6 class="mb-1">${e.廠商店家} - $${(e.支出金額||0).toLocaleString()}</h6>
                  <small class="text-muted">${formatDate(e.支出日期)} | ${e.支出類別}</small>
                </div>
                <span class="badge ${getExpenseStatusBadge(e.審核狀態)}">${e.審核狀態}</span>
              </div>
              <p class="mb-2">${e.支出說明}</p>
              ${e.憑證圖片連結?`<img src="${e.憑證圖片連結}" class="receipt-image" alt="支出憑證" onclick="window.open('${e.憑證圖片連結}','_blank')">`:''}
              <div class="d-flex justify-content-between align-items-center mt-2 flex-wrap">
                <small class="text-muted">提交人：${e.提交人姓名||'匿名'} | ${formatDateTime(e.提交時間)}</small>
                ${
                  e.審核狀態==='待審核' && ['admin','chairman','supervisor'].includes(userRole)
                    ? `<div class="mt-2 mt-sm-0">
                        <button class="btn btn-success btn-sm me-1" onclick="approveExpense('${e.憑證ID}','通過')"><i class="bi bi-check-circle"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="approveExpense('${e.憑證ID}','駁回')"><i class="bi bi-x-circle"></i></button>
                      </div>`
                    : ''
                }
              </div>
              ${e.審核意見?`
                <div class="approval-section mt-2">
                  <small><strong>審核意見：</strong>${e.審核意見}</small><br>
                  <small class="text-muted">審核人：${e.審核人姓名||''} | ${formatDateTime(e.審核時間)}</small>
                </div>
              `:''}
            </div>
          `).join('');
        }catch(e){
          container.innerHTML = retryBlock('載入支出憑證失敗：'+e.message,'loadExpenseList');
        }
      }

      async function approveExpense(expenseId,decision){
        const comment = decision==='駁回'
          ? prompt('請輸入駁回理由：')
          : prompt('審核意見（可留空）：');
        if(decision==='駁回' && (!comment||!comment.trim())){
          showError('駁回理由不能為空'); return;
        }
        // 轉換審核狀態字樣
        const 審核狀態 = decision==='通過' ? '已通過' : '已駁回';
        const payload = {
          action:'approveExpense',
          expenseId,
          審核狀態,
          審核意見:comment||'',
          審核人:userId
        };
        try{
          const res = await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'審核失敗');
          showSuccess(`憑證已${審核狀態}`);
          loadExpenseList(); loadDashboard();
        }catch(e){ showError('審核失敗：'+e.message); }
      }

      // ================== 臨時動議 ==================
      function showMotionForm(){
        document.getElementById('motionForm').style.display='block';
        const tomorrow = new Date(Date.now()+86400000);
        document.getElementById('motionDeadline').value = tomorrow.toISOString().split('T')[0];
      }
      function hideMotionForm(){
        document.getElementById('motionForm').style.display='none';
        document.getElementById('newMotionForm').reset();
      }
      document.getElementById('newMotionForm').addEventListener('submit',async(e)=>{
        e.preventDefault();
        const btn=e.target.querySelector('button[type="submit"]');
        const old=btn.innerHTML; btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>提出中...';
        const payload = {
          action:'addMotion',
          動議標題:document.getElementById('motionTitle').value.trim(),
          緊急程度:document.getElementById('motionUrgency').value,
          希望決議期限:document.getElementById('motionDeadline').value,
          動議內容:document.getElementById('motionContent').value.trim(),
          提出理由:document.getElementById('motionReason').value.trim(),
          提出人:userId
        };
        try{
          const res = await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'提出失敗');
          showSuccess('臨時動議已提出');
          hideMotionForm(); loadMotionList(); loadDashboard();
        }catch(err){ showError('提出失敗：'+err.message); }
        finally{ btn.disabled=false; btn.innerHTML=old; }
      });

      function getMotionUrgencyColor(u){
        switch(u){
          case '緊急': return 'danger';
          case '重要': return 'warning';
          case '一般': return 'info';
          default: return 'secondary';
        }
      }
      function getMotionStatusBadge(s){
        switch(s){
          case '待處理': return 'bg-warning text-dark';
          case '處理中': return 'bg-info';
          case '已接受': return 'bg-success';
          case '已延後': return 'bg-secondary';
          case '已拒絕': return 'bg-danger';
          default: return 'bg-light text-dark';
        }
      }

      async function loadMotionList(){
        const container = document.getElementById('motionList');
        container.innerHTML = '<div class="text-center p-4"><div class="spinner-border"></div></div>';
        try{
          const res = await fetch(`${GAS_URL}?action=getMotionList`);
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'取得失敗');
          const data = j.data;
          if(!data.length){ container.innerHTML='<div class="text-center text-muted">暫無臨時動議</div>'; return; }
          container.innerHTML = data.slice(0,60).map(m=>`
            <div class="card mb-3 border-${getMotionUrgencyColor(m.緊急程度)}">
              <div class="card-header bg-${getMotionUrgencyColor(m.緊急程度)} text-white d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0">${m.動議標題}</h6>
                  <small>提出人：${m.提出人姓名||'匿名'} | ${m.緊急程度}</small>
                </div>
                <span class="badge ${getMotionStatusBadge(m.處理狀態)}">${m.處理狀態}</span>
              </div>
              <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">動議內容</h6>
                <p class="card-text">${m.動議內容}</p>
                <h6 class="card-subtitle mb-2 text-muted">提出理由</h6>
                <p class="card-text">${m.提出理由}</p>
                ${m.希望決議期限?`<p class="mb-2"><strong>希望決議期限：</strong>${formatDate(m.希望決議期限)}</p>`:''}
                <p class="mb-0 text-muted small">提出時間：${formatDateTime(m.提出時間)}</p>
                ${m.處理狀態==='待處理' && ['admin','chairman'].includes(userRole)?`
                  <div class="mt-3">
                    <button class="btn btn-success btn-sm me-2" onclick="processMotion('${m.動議ID}','接受')"><i class="bi bi-check-circle me-1"></i>接受</button>
                    <button class="btn btn-warning btn-sm me-2" onclick="processMotion('${m.動議ID}','延後')"><i class="bi bi-clock me-1"></i>延後</button>
                    <button class="btn btn-danger btn-sm" onclick="processMotion('${m.動議ID}','拒絕')"><i class="bi bi-x-circle me-1"></i>拒絕</button>
                  </div>
                `:''}
                ${m.處理意見?`
                  <div class="mt-3 p-2 bg-light rounded">
                    <small><strong>處理意見：</strong>${m.處理意見}</small><br>
                    <small class="text-muted">處理人：${m.處理人姓名||''} | ${formatDateTime(m.處理時間)}</small>
                  </div>
                `:''}
              </div>
            </div>
          `).join('');
        }catch(e){
          container.innerHTML = retryBlock('載入臨時動議失敗：'+e.message,'loadMotionList');
        }
      }

      async function processMotion(motionId,actionText){
        const comment = prompt(`請輸入${actionText}理由：`);
        if(!comment || !comment.trim()){ showError(`${actionText}理由不能為空`); return; }
        // 轉狀態
        const map = { '接受':'已接受', '延後':'已延後', '拒絕':'已拒絕' };
        const payload = {
          action:'processMotion',
          motionId,
          處理狀態:map[actionText]||'處理中',
          處理意見:comment.trim(),
          處理人:userId
        };
        try{
          const res = await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'處理失敗');
          showSuccess(`動議已${map[actionText]||actionText}`);
          loadMotionList(); loadDashboard();
        }catch(e){ showError('處理失敗：'+e.message); }
      }

      // ================== 匯出/備份/通知（示例保留） ==================
      function exportMembers(){ exportData('會員資料'); }
      async function exportData(dataType){
        try{
          const res = await fetch(`${GAS_URL}?action=exportData&dataType=${encodeURIComponent(dataType)}`);
          const j = await res.json();
          if(!j.success) throw new Error(j.message||'匯出失敗');
          const blob = new Blob([j.data],{type:'text/csv;charset=utf-8;'});
          const link = document.createElement('a');
          link.href=URL.createObjectURL(blob);
          link.download = `${dataType}_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(link); link.click(); document.body.removeChild(link);
          showSuccess(`${dataType}已匯出`);
        }catch(e){ showError('匯出失敗：'+e.message); }
      }

      // ================== 標籤切換 ==================
      document.querySelectorAll('#adminTabs a[data-bs-toggle="pill"]').forEach(tab=>{
        tab.addEventListener('shown.bs.tab',(ev)=>{
          const target = ev.target.getAttribute('href');
          switch(target){
            case '#dashboard': loadDashboard(); break;
            case '#finance': loadTransactionList(); break;
            case '#receipts': loadReceiptList(); break;
            case '#members': loadMemberList(); break;
            case '#activities': loadActivityList(); break;
            case '#proposals': loadProposalList(); break;
            case '#expenses': loadExpenseList(); break;
            case '#motions': loadMotionList(); break;
          }
        });
      });

      // ================== 快捷鍵與離開提示 ==================
      document.addEventListener('keydown',e=>{
        if(e.ctrlKey && e.key==='s'){
          e.preventDefault();
          const visibleForm = [...document.querySelectorAll('form')].find(f=>f.offsetParent!==null);
          if(visibleForm){
            const btn = visibleForm.querySelector('button[type="submit"]:not(:disabled)');
            if(btn) btn.click();
          }
        }
        if(e.key==='Escape'){
          const modalEl = document.querySelector('.modal.show');
          if(modalEl){
            bootstrap.Modal.getInstance(modalEl)?.hide();
          }else{
            ['transactionForm','manualReceiptForm','activityForm','proposalForm','expenseForm','motionForm']
              .forEach(id=>{ const el=document.getElementById(id); if(el && el.style.display!=='none') el.style.display='none'; });
          }
        }
      });

      window.addEventListener('beforeunload',function(e){
        const edited = [...document.querySelectorAll('form')].some(f=>{
          if(f.offsetParent===null) return false;
          return [...f.querySelectorAll('input,textarea,select')].some(inp=>inp.value.trim()!=='');
        });
        if(edited){
          e.preventDefault();
          e.returnValue = '您有未儲存的變更，確定要離開嗎？';
          return e.returnValue;
        }
      });

      // ================== 初始載入 ==================
      document.addEventListener('DOMContentLoaded',()=>{
        setInterval(()=>{
          const active = document.querySelector('#adminTabs .nav-link.active');
          if(active && active.getAttribute('href')==='#dashboard') loadDashboard();
        },5*60*1000);
      });

      // ================== 全域暴露必要函數 ==================
      window.loadDashboard=loadDashboard;
      window.loadTransactionList=loadTransactionList;
      window.loadReceiptList=loadReceiptList;
      window.loadMemberList=loadMemberList;
      window.loadActivityList=loadActivityList;
      window.loadProposalList=loadProposalList;
      window.loadExpenseList=loadExpenseList;
      window.loadMotionList=loadMotionList;
      window.showTransactionForm=showTransactionForm;
      window.hideTransactionForm=hideTransactionForm;
      window.showManualReceiptForm=showManualReceiptForm;
      window.hideManualReceiptForm=hideManualReceiptForm;
      window.createReceiptForTransaction=createReceiptForTransaction;
      window.deleteTransaction=deleteTransaction;
      window.sendReceipt=sendReceipt;
      window.regenerateReceiptPDF=regenerateReceiptPDF;
      window.viewMemberDetail=viewMemberDetail;
      window.updateMemberStatus=updateMemberStatus;
      window.showActivityForm=showActivityForm;
      window.hideActivityForm=hideActivityForm;
      window.exportActivityMembers=exportActivityMembers;
      window.showProposalForm=showProposalForm;
      window.hideProposalForm=hideProposalForm;
      window.voteProposal=voteProposal;
      window.showExpenseForm=showExpenseForm;
      window.hideExpenseForm=hideExpenseForm;
      window.approveExpense=approveExpense;
      window.showMotionForm=showMotionForm;
      window.hideMotionForm=hideMotionForm;
      window.processMotion=processMotion;
      window.exportMembers=exportMembers;
      window.saveReceiptTemplate=saveReceiptTemplate;
    </script>
</body>
</html>
